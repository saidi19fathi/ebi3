{# ~/ebi3/ads/templates/ads/ad_create.html #}
{% extends 'ads/base_ads.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Créer une annonce" %} - Ebi3{% endblock %}

{% block ads_content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="fas fa-plus-circle"></i> {% trans "Créer une nouvelle annonce" %}
                </h2>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="ad-create-form" novalidate>
                    {% csrf_token %}

                    <!-- Messages d'erreur Django -->
                    {% if form.errors %}
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle"></i> {% trans "Veuillez corriger les erreurs ci-dessous" %}</h5>
                            <ul class="mb-0">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>
                                            <strong>
                                                {% if field == 'main_category' %}
                                                    {% trans "Catégorie principale" %}
                                                {% elif field == 'sub_category' %}
                                                    {% trans "Sous-catégorie" %}
                                                {% elif field == 'category' %}
                                                    {% trans "Catégorie" %}
                                                {% else %}
                                                    {{ field }}
                                                {% endif %}:
                                            </strong> {{ error }}
                                        </li>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- SECTION 1: Informations de base -->
                    <div class="section mb-5">
                        <h4 class="mb-4 border-bottom pb-2">
                            <span class="badge bg-primary me-2">1</span>
                            {% trans "Informations de base" %}
                        </h4>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                {{ form.title|as_crispy_field }}
                                <small class="form-text text-muted">
                                    {% trans "Soyez clair et concis. Ex: 'Canapé en cuir marron 3 places'" %}
                                </small>
                            </div>
                        </div>

                        <!-- SECTION CATÉGORIE HIÉRARCHIQUE -->
                        <div class="category-hierarchy-section mb-4">
                            <h5 class="mb-3">{% trans "Catégorie de l'annonce" %}</h5>

                            <!-- Catégorie principale (obligatoire) -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="id_main_category" class="form-label">
                                            {% trans "Catégorie principale *" %}
                                            {% if form.main_category.errors %}
                                                <span class="text-danger">*</span>
                                            {% endif %}
                                        </label>
                                        <select class="form-control {% if form.main_category.errors %}is-invalid{% endif %}"
                                                id="id_main_category" name="main_category" required>
                                            <option value="">{% trans "Sélectionnez une catégorie principale" %}</option>
                                            {% for category in form.main_category.field.queryset %}
                                                <option value="{{ category.id }}"
                                                    {% if form.main_category.value|stringformat:"s" == category.id|stringformat:"s" %}selected{% endif %}>
                                                    {{ category.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        {% if form.main_category.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.main_category.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            {% trans "Sélectionnez la catégorie principale de votre annonce" %}
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Sous-catégorie (optionnelle) -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="id_sub_category" class="form-label">
                                            {% trans "Sous-catégorie" %}
                                        </label>
                                        <select class="form-control" id="id_sub_category" name="sub_category" disabled>
                                            <option value="">{% trans "Sélectionnez une sous-catégorie (optionnel)" %}</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            {% trans "Optionnel : Sélectionnez une sous-catégorie plus spécifique" %}
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Champ caché pour la catégorie finale -->
                            <input type="hidden" id="id_category" name="category" value="{{ form.category.value|default:'' }}">

                            <!-- Information -->
                            <div class="alert alert-info mt-2">
                                <small>
                                    <i class="fas fa-info-circle"></i>
                                    {% trans "La catégorie principale est obligatoire pour faciliter la recherche de votre annonce." %}
                                </small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.condition|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.weight|as_crispy_field }}
                            </div>
                            <div class="col-md-2 mb-3">
                                {{ form.length|as_crispy_field }}
                            </div>
                            <div class="col-md-2 mb-3">
                                {{ form.width|as_crispy_field }}
                            </div>
                            <div class="col-md-2 mb-3">
                                {{ form.height|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 2: Description et prix -->
                    <div class="section mb-5">
                        <h4 class="mb-4 border-bottom pb-2">
                            <span class="badge bg-primary me-2">2</span>
                            {% trans "Description et prix" %}
                        </h4>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                {{ form.description|as_crispy_field }}
                                <small class="form-text text-muted">
                                    {% trans "Décrivez votre objet en détail. Soyez précis sur son état, ses dimensions, son histoire, etc." %}
                                </small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.price|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.currency|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check mt-4 pt-2">
                                    {{ form.is_negotiable }}
                                    <label class="form-check-label" for="{{ form.is_negotiable.id_for_label }}">
                                        {% trans "Prix négociable" %}
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.available_from|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.available_until|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 3: Logistique -->
                    <div class="section mb-5">
                        <h4 class="mb-4 border-bottom pb-2">
                            <span class="badge bg-primary me-2">3</span>
                            {% trans "Informations logistiques" %}
                        </h4>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                {{ form.logistics_option|as_crispy_field }}
                                <div class="alert alert-info mt-2">
                                    <small>
                                        <strong>{% trans "Vente directe (P2P):" %}</strong> {% trans "Vous rencontrez l'acheteur directement" %}<br>
                                        <strong>{% trans "Avec transporteur:" %}</strong> {% trans "Utilisation d'un service de transport" %}<br>
                                        <strong>{% trans "Avec expatrié-transporteur:" %}</strong> {% trans "Personne voyageant qui peut transporter" %}
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4 border-info">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-map-marker-alt"></i> {% trans "Point de départ" %}
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.country_from|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.city_from|as_crispy_field }}
                                    </div>
                                </div>
                                {{ form.address_from|as_crispy_field }}
                            </div>
                        </div>

                        <div class="card mb-4 border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-flag-checkered"></i> {% trans "Point d'arrivée" %}
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.country_to|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.city_to|as_crispy_field }}
                                    </div>
                                </div>
                                {{ form.address_to|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    {{ form.requires_insurance }}
                                    <label class="form-check-label" for="{{ form.requires_insurance.id_for_label }}">
                                        {% trans "Assurance requise" %}
                                    </label>
                                </div>
                                <div id="insurance-value-field" class="mt-2" style="display: none;">
                                    {{ form.insurance_value|as_crispy_field }}
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    {{ form.fragile_item }}
                                    <label class="form-check-label" for="{{ form.fragile_item.id_for_label }}">
                                        {% trans "Objet fragile" %}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    {{ form.requires_packaging }}
                                    <label class="form-check-label" for="{{ form.requires_packaging.id_for_label }}">
                                        {% trans "Emballage requis" %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 4: Images -->
                    <div class="section mb-5">
                        <h4 class="mb-4 border-bottom pb-2">
                            <span class="badge bg-primary me-2">4</span>
                            {% trans "Images" %}
                        </h4>

                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle"></i>
                            {% blocktrans %}
                                Vous pouvez télécharger jusqu'à <strong>3 images gratuitement</strong>.
                                Les images supplémentaires sont payantes (1€ par image).
                            {% endblocktrans %}
                        </div>

                        <!-- Formset pour les images -->
                        <div id="image-forms">
                            {{ image_formset.management_form }}

                            <div class="row">
                                {% for form in image_formset %}
                                    <div class="col-md-6 mb-4">
                                        <div class="card h-100 image-form" data-index="{{ forloop.counter0 }}">
                                            <div class="card-body">
                                                <h6 class="card-title border-bottom pb-2 mb-3">
                                                    {% if forloop.first %}
                                                        <strong>{% trans "Image principale" %}</strong>
                                                    {% else %}
                                                        {% trans "Image complémentaire" %} #{{ forloop.counter }}
                                                    {% endif %}
                                                </h6>

                                                <div class="form-group mb-3">
                                                    <label for="{{ form.image.id_for_label }}" class="form-label">
                                                        {% trans "Fichier image" %}
                                                    </label>
                                                    {{ form.image }}
                                                    {% if form.image.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {{ form.image.errors }}
                                                        </div>
                                                    {% endif %}
                                                    <div class="image-preview-container mt-2" id="preview-{{ forloop.counter0 }}">
                                                        <!-- Prévisualisation ici -->
                                                    </div>
                                                </div>

                                                {{ form.caption|as_crispy_field }}

                                                <div class="row">
                                                    <div class="col-md-6">
                                                        {% if forloop.first %}
                                                            <div class="form-check">
                                                                <input type="checkbox" class="form-check-input"
                                                                       id="{{ form.is_primary.id_for_label }}"
                                                                       name="{{ form.is_primary.html_name }}"
                                                                       checked disabled>
                                                                <label class="form-check-label" for="{{ form.is_primary.id_for_label }}">
                                                                    {% trans "Image principale" %}
                                                                </label>
                                                            </div>
                                                            <input type="hidden" name="{{ form.is_primary.html_name }}" value="on">
                                                        {% else %}
                                                            <div class="form-check">
                                                                {{ form.is_primary }}
                                                                <label class="form-check-label" for="{{ form.is_primary.id_for_label }}">
                                                                    {% trans "Image principale" %}
                                                                </label>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-6">
                                                        {{ form.display_order|as_crispy_field }}
                                                    </div>
                                                </div>

                                                {% if image_formset.can_delete and not forloop.first %}
                                                    <div class="form-check mt-3">
                                                        {{ form.DELETE }}
                                                        <label class="form-check-label text-danger" for="{{ form.DELETE.id_for_label }}">
                                                            {% trans "Supprimer cette image" %}
                                                        </label>
                                                    </div>
                                                {% endif %}

                                                {% for hidden in form.hidden_fields %}
                                                    {{ hidden }}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="text-center mb-4">
                            <button type="button" id="add-image-btn" class="btn btn-outline-primary">
                                <i class="fas fa-plus"></i> {% trans "Ajouter une image" %}
                            </button>
                            <small class="d-block text-muted mt-2">
                                {% trans "Formats acceptés: JPG, PNG, WebP. Taille max: 10MB par image." %}
                            </small>
                        </div>
                    </div>

                    <!-- Bouton de soumission -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success btn-lg px-5">
                            <i class="fas fa-check"></i> {% trans "Publier l'annonce" %}
                        </button>
                        <a href="{% url 'ads:ad_list' %}" class="btn btn-outline-secondary btn-lg ms-3">
                            <i class="fas fa-times"></i> {% trans "Annuler" %}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .section {
        background-color: #fff;
        border-radius: 0.5rem;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }

    .category-hierarchy-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .image-form {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
    }

    .image-form:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.1);
    }

    .image-preview-container {
        min-height: 100px;
        border: 1px dashed #dee2e6;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .image-preview {
        max-width: 100%;
        max-height: 150px;
        object-fit: contain;
    }

    .form-control.is-invalid {
        border-color: #dc3545;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .required label:after {
        content: " *";
        color: #dc3545;
    }

    .category-loading {
        display: none;
        color: #6c757d;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('Ad Create Form initialized - Catégorie hiérarchique');

    // URL pour récupérer les sous-catégories
    const SUBCATEGORIES_URL = "{% url 'ads:get_categories' %}";

    // CSRF token pour les requêtes AJAX
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // ============================================
    // GESTION DE LA CATÉGORIE HIÉRARCHIQUE
    // ============================================

    // Charger les sous-catégories pour la catégorie principale sélectionnée
    function loadSubCategories(mainCategoryId) {
        if (!mainCategoryId) {
            $('#id_sub_category').prop('disabled', true).empty();
            $('#id_sub_category').append($('<option>', {
                value: '',
                text: '{% trans "Sélectionnez d\'abord une catégorie principale" %}'
            }));
            updateCategoryField();
            return;
        }

        // Activer et réinitialiser le champ sous-catégorie
        const $subCategorySelect = $('#id_sub_category');
        $subCategorySelect.prop('disabled', true).empty();

        // Ajouter une option par défaut
        $subCategorySelect.append($('<option>', {
            value: '',
            text: '{% trans "Chargement des sous-catégories..." %}'
        }));

        // Récupérer les sous-catégories via AJAX
        $.ajax({
            url: SUBCATEGORIES_URL,
            type: 'GET',
            data: {
                'parent_id': mainCategoryId,
                'level': 'sub'
            },
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(data) {
                console.log('Sous-catégories reçues:', data);

                $subCategorySelect.empty();

                // Ajouter une option par défaut
                $subCategorySelect.append($('<option>', {
                    value: '',
                    text: '{% trans "Sélectionnez une sous-catégorie (optionnel)" %}'
                }));

                // Ajouter chaque sous-catégorie au select
                if (data.categories && data.categories.length > 0) {
                    $.each(data.categories, function(index, category) {
                        $subCategorySelect.append($('<option>', {
                            value: category.id,
                            text: category.name
                        }));
                    });

                    // Activer le champ
                    $subCategorySelect.prop('disabled', false);
                } else {
                    $subCategorySelect.append($('<option>', {
                        value: '',
                        text: '{% trans "Aucune sous-catégorie disponible" %}'
                    }));
                    $subCategorySelect.prop('disabled', true);
                }

                // Mettre à jour le champ caché de catégorie
                updateCategoryField();
            },
            error: function(xhr, status, error) {
                console.error('Erreur lors du chargement des sous-catégories:', error);
                $subCategorySelect.empty();
                $subCategorySelect.append($('<option>', {
                    value: '',
                    text: '{% trans "Erreur de chargement" %}'
                }));
            }
        });
    }

    // Quand la catégorie principale change
    $('#id_main_category').change(function() {
        const mainCategoryId = $(this).val();
        console.log('Catégorie principale sélectionnée:', mainCategoryId);

        loadSubCategories(mainCategoryId);
    });

    // Quand la sous-catégorie change
    $('#id_sub_category').change(function() {
        console.log('Sous-catégorie sélectionnée:', $(this).val());
        updateCategoryField();
    });

    // Fonction pour mettre à jour le champ caché de catégorie
    function updateCategoryField() {
        const mainCategoryId = $('#id_main_category').val();
        const subCategoryId = $('#id_sub_category').val();
        const $categoryHidden = $('#id_category');

        // Utiliser la sous-catégorie si sélectionnée, sinon la catégorie principale
        if (subCategoryId && subCategoryId !== '') {
            $categoryHidden.val(subCategoryId);
            console.log('Catégorie finale (sous-catégorie):', subCategoryId);
        } else if (mainCategoryId && mainCategoryId !== '') {
            $categoryHidden.val(mainCategoryId);
            console.log('Catégorie finale (principale):', mainCategoryId);
        } else {
            $categoryHidden.val('');
            console.log('Aucune catégorie sélectionnée');
        }
    }

    // Initialiser le champ caché
    updateCategoryField();

    // Si une catégorie principale est déjà sélectionnée (en cas d'erreur de validation)
    const initialMainCategory = $('#id_main_category').val();
    if (initialMainCategory) {
        loadSubCategories(initialMainCategory);
    }

    // ============================================
    // AUTRES FONCTIONNALITÉS
    // ============================================

    // Gestion de l'assurance
    $('#{{ form.requires_insurance.id_for_label }}').change(function() {
        if ($(this).is(':checked')) {
            $('#insurance-value-field').show();
        } else {
            $('#insurance-value-field').hide();
        }
    }).trigger('change');

    // Gestion des images
    $('#add-image-btn').click(function() {
        addImageForm();
    });

    // Prévisualisation des images
    $(document).on('change', 'input[type="file"]', function() {
        previewImage(this);
    });

    // ============================================
    // VALIDATION DU FORMULAIRE
    // ============================================

    // Validation du formulaire
    $('#ad-create-form').submit(function(e) {
        console.log('Tentative de soumission du formulaire');

        // Valider les champs requis
        if (!validateForm()) {
            e.preventDefault();
            showToast('{% trans "Veuillez corriger les erreurs dans le formulaire avant de soumettre." %}', 'error');
            return false;
        }

        // Vérifier qu'au moins une image est primaire (si des images sont uploadées)
        const hasPrimary = $('[id$="-is_primary"]:checked').length > 0;
        const hasImages = $('input[type="file"]').length > 0;

        if (hasImages && !hasPrimary) {
            e.preventDefault();
            showToast('{% trans "Veuillez sélectionner au moins une image comme image principale." %}', 'error');
            return false;
        }

        console.log('Validation du formulaire réussie, soumission...');
        return true;
    });

    function validateForm() {
        console.log('Validation du formulaire en cours...');
        let isValid = true;

        // Valider la catégorie principale
        const mainCategoryField = $('#id_main_category');
        if (!mainCategoryField.val()) {
            markFieldInvalid(mainCategoryField, '{% trans "La catégorie principale est requise" %}');
            isValid = false;
        } else {
            markFieldValid(mainCategoryField);
        }

        // Valider les autres champs requis
        $('[required]').each(function() {
            const $field = $(this);

            // Ne pas valider à nouveau la catégorie principale
            if ($field.attr('id') === 'id_main_category') {
                return true;
            }

            // Ignorer les champs de formulaire d'image cachés
            if ($field.closest('.image-form').length && !$field.closest('.image-form').is(':visible')) {
                return true;
            }

            const fieldValue = $field.val() ? $field.val().trim() : '';
            const isSelect = $field.is('select');
            const isCheckbox = $field.is(':checkbox');
            const isRadio = $field.is(':radio');
            const isFile = $field.is('input[type="file"]');

            let fieldValid = true;

            if (isSelect && !fieldValue) {
                fieldValid = false;
            } else if (isCheckbox && !$field.is(':checked')) {
                fieldValid = false;
            } else if (isRadio && !$field.closest('fieldset').find('input[type="radio"]:checked').length) {
                fieldValid = false;
            } else if (!isCheckbox && !isRadio && !isFile && !fieldValue) {
                fieldValid = false;
            }

            if (!fieldValid) {
                markFieldInvalid($field, '{% trans "Ce champ est requis" %}');
                isValid = false;
            } else {
                markFieldValid($field);
            }
        });

        // Validation spécifique pour le prix (si renseigné)
        const priceField = $('#{{ form.price.id_for_label }}');
        if (priceField.length && priceField.val()) {
            const price = parseFloat(priceField.val());
            if (isNaN(price) || price <= 0) {
                markFieldInvalid(priceField, '{% trans "Le prix doit être supérieur à 0" %}');
                isValid = false;
            }
        }

        if (!isValid) {
            console.log('Validation du formulaire échouée');
        } else {
            console.log('Validation du formulaire réussie');
        }

        return isValid;
    }

    function markFieldInvalid($field, message) {
        $field.addClass('is-invalid').removeClass('is-valid');

        // Trouver ou créer le message d'erreur
        let $errorDiv = $field.parent().find('.invalid-feedback');
        if ($errorDiv.length === 0) {
            $errorDiv = $('<div class="invalid-feedback"></div>');
            $field.parent().append($errorDiv);
        }
        $errorDiv.text(message).show();
    }

    function markFieldValid($field) {
        $field.removeClass('is-invalid').addClass('is-valid');

        // Masquer le message d'erreur
        $field.parent().find('.invalid-feedback').hide();
    }

    // Fonction pour ajouter un formulaire d'image
    let imageFormIndex = {{ image_formset.total_form_count|default:5 }};
    function addImageForm() {
        const totalForms = $('#id_images-TOTAL_FORMS');
        const currentIndex = parseInt(totalForms.val());
        const maxForms = parseInt(totalForms.attr('data-max'));

        if (currentIndex >= maxForms) {
            showToast('{% trans "Vous avez atteint le nombre maximum d\'images autorisées." %}', 'error');
            return;
        }

        console.log('Ajout d\'un formulaire d\'image, index:', currentIndex);

        // Clone du premier formulaire d'image (sans les données)
        const $firstForm = $('.image-form').first().clone();
        const newIndex = imageFormIndex;

        // Mettre à jour les attributs name et id
        $firstForm.find('[name]').each(function() {
            const name = $(this).attr('name').replace(/-0-/g, `-${newIndex}-`);
            $(this).attr('name', name);
        });

        $firstForm.find('[id]').each(function() {
            const id = $(this).attr('id').replace(/-0-/g, `-${newIndex}-`);
            $(this).attr('id', id);
        });

        // Réinitialiser les valeurs
        $firstForm.find('input[type="text"], input[type="number"], textarea').val('');
        $firstForm.find('input[type="file"]').val('');
        $firstForm.find('input[type="checkbox"]').prop('checked', false);
        $firstForm.find('.image-preview-container').empty();

        // Ajouter au DOM
        $('#image-forms .row').append($firstForm);

        // Mettre à jour le compteur
        totalForms.val(currentIndex + 1);
        imageFormIndex++;

        console.log('Formulaire d\'image ajouté avec succès');
    }

    // Fonction pour prévisualiser une image
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            const container = $(input).closest('.image-form').find('.image-preview-container');

            reader.onload = function(e) {
                container.html(`<img src="${e.target.result}" class="image-preview">`);
            };

            reader.readAsDataURL(input.files[0]);
        }
    }

    // Fonction toast
    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        if ($('#toast-container').length === 0) {
            $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
        }

        $('#toast-container').append(toastHtml);
        $('.toast').toast('show');

        // Remove toast after hiding
        $('.toast').on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }
});
</script>
{% endblock %}