{% load i18n %}

{% comment %}
Usage : {% include "carriers/partials/financial_summary.html" with period="month" %}
Options :
- period="month" (default) or "week" or "year" or "custom"
- show_chart=true/false (default: true)
- show_details=true/false (default: false)
- show_comparison=true/false (default: false)
- start_date=date_object (pour period="custom")
- end_date=date_object (pour period="custom")
{% endcomment %}

<div class="financial-summary card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-chart-line"></i>
                {% if period == "month" %}
                    {% trans "Synthèse mensuelle" %}
                {% elif period == "week" %}
                    {% trans "Synthèse hebdomadaire" %}
                {% elif period == "year" %}
                    {% trans "Synthèse annuelle" %}
                {% else %}
                    {% trans "Synthèse financière" %}
                {% endif %}
            </h5>

            <!-- Sélecteur de période -->
            <div class="btn-group btn-group-sm">
                <button type="button"
                        class="btn btn-outline-secondary {% if period == 'week' %}active{% endif %}"
                        onclick="updateFinancialSummary('week')">
                    {% trans "Semaine" %}
                </button>
                <button type="button"
                        class="btn btn-outline-secondary {% if period == 'month' %}active{% endif %}"
                        onclick="updateFinancialSummary('month')">
                    {% trans "Mois" %}
                </button>
                <button type="button"
                        class="btn btn-outline-secondary {% if period == 'year' %}active{% endif %}"
                        onclick="updateFinancialSummary('year')">
                    {% trans "Année" %}
                </button>
                {% if period == "custom" %}
                <button type="button"
                        class="btn btn-outline-secondary active"
                        onclick="showCustomPeriodModal()">
                    <i class="fas fa-calendar-alt"></i>
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card-body">
        <!-- Statistiques principales -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="text-center">
                    <h6 class="text-muted mb-2">{% trans "Revenus" %}</h6>
                    <h3 class="text-success" id="incomeAmount">
                        {{ income|default:0|floatformat:2 }} €
                    </h3>
                    <small class="text-muted">
                        {% if period == "month" %}
                            {% trans "Ce mois" %}
                        {% elif period == "week" %}
                            {% trans "Cette semaine" %}
                        {% elif period == "year" %}
                            {% trans "Cette année" %}
                        {% endif %}
                    </small>
                </div>
            </div>

            <div class="col-md-3">
                <div class="text-center">
                    <h6 class="text-muted mb-2">{% trans "Dépenses" %}</h6>
                    <h3 class="text-danger" id="expensesAmount">
                        {{ expenses|default:0|floatformat:2 }} €
                    </h3>
                    <small class="text-muted">
                        {% if show_comparison and previous_expenses %}
                            {% widthratio previous_expenses expenses 100 as percentage %}
                            <span class="{% if expenses < previous_expenses %}text-success{% else %}text-danger{% endif %}">
                                {% if expenses < previous_expenses %}▼{% else %}▲{% endif %}
                                {{ percentage }}%
                            </span>
                        {% endif %}
                    </small>
                </div>
            </div>

            <div class="col-md-3">
                <div class="text-center">
                    <h6 class="text-muted mb-2">{% trans "Bénéfice" %}</h6>
                    <h3 class="{% if profit >= 0 %}text-primary{% else %}text-danger{% endif %}" id="profitAmount">
                        {{ profit|default:0|floatformat:2 }} €
                    </h3>
                    <small class="text-muted" id="profitMargin">
                        {% if income > 0 %}
                            {% widthratio profit income 100 as margin %}
                            {{ margin|floatformat:1 }}% {% trans "de marge" %}
                        {% endif %}
                    </small>
                </div>
            </div>

            <div class="col-md-3">
                <div class="text-center">
                    <h6 class="text-muted mb-2">{% trans "Missions" %}</h6>
                    <h3 class="text-info" id="missionsCount">
                        {{ missions_count|default:0 }}
                    </h3>
                    <small class="text-muted">
                        {% if average_revenue %}
                            {{ average_revenue|floatformat:2 }} € {% trans "/mission" %}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>

        <!-- Graphique (optionnel) -->
        {% if show_chart %}
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">{% trans "Évolution des revenus" %}</h6>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary active" onclick="showChart('revenue')">
                        {% trans "Revenus" %}
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="showChart('expenses')">
                        {% trans "Dépenses" %}
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="showChart('profit')">
                        {% trans "Bénéfice" %}
                    </button>
                </div>
            </div>
            <canvas id="financialChart" height="100"></canvas>
        </div>
        {% endif %}

        <!-- Détails par catégorie (optionnel) -->
        {% if show_details %}
        <div class="row">
            <div class="col-md-6">
                <h6>{% trans "Dépenses par catégorie" %}</h6>
                <div id="expensesByCategory">
                    {% for category in expenses_by_category %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="badge" style="background-color: {{ category.color }};">
                                {{ category.name }}
                            </span>
                        </div>
                        <div>
                            <span class="me-2">{{ category.amount|floatformat:2 }} €</span>
                            <small class="text-muted">({{ category.percentage|floatformat:1 }}%)</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="col-md-6">
                <h6>{% trans "Revenus par type" %}</h6>
                <div id="incomeByType">
                    {% for type in income_by_type %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="badge bg-success">
                                {{ type.name }}
                            </span>
                        </div>
                        <div>
                            <span class="me-2">{{ type.amount|floatformat:2 }} €</span>
                            <small class="text-muted">({{ type.percentage|floatformat:1 }}%)</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="downloadFinancialReport()">
                    <i class="fas fa-download"></i> {% trans "Télécharger le rapport" %}
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="printFinancialSummary()">
                    <i class="fas fa-print"></i> {% trans "Imprimer" %}
                </button>
            </div>
            <div>
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    {% trans "Données mises à jour le" %} {{ update_date|date:"d/m/Y H:i" }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Modal période personnalisée -->
<div class="modal fade" id="customPeriodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Période personnalisée" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="customStartDate" class="form-label">
                                {% trans "Date de début" %}
                            </label>
                            <input type="date" class="form-control" id="customStartDate">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="customEndDate" class="form-label">
                                {% trans "Date de fin" %}
                            </label>
                            <input type="date" class="form-control" id="customEndDate">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Annuler" %}
                </button>
                <button type="button" class="btn btn-primary" onclick="applyCustomPeriod()">
                    {% trans "Appliquer" %}
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.financial-summary .card-header .btn-group .btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let financialChart = null;
let currentChartType = 'revenue';

// Mettre à jour le résumé financier
function updateFinancialSummary(period) {
    // Ici, vous feriez un appel AJAX pour récupérer les données
    // Par exemple :
    // fetch(`/api/financial-summary/?period=${period}`)
    //     .then(response => response.json())
    //     .then(data => updateSummaryData(data));

    // Pour l'exemple, nous simulons des données
    const mockData = {
        income: getRandomAmount(1000, 5000),
        expenses: getRandomAmount(300, 1500),
        profit: 0, // Serait calculé
        missions_count: getRandomInt(5, 30),
        average_revenue: getRandomAmount(50, 200)
    };

    mockData.profit = mockData.income - mockData.expenses;

    updateSummaryData(mockData);

    // Mettre à jour le graphique
    if (financialChart) {
        updateChart();
    }
}

// Mettre à jour les données affichées
function updateSummaryData(data) {
    $('#incomeAmount').text(data.income.toFixed(2) + ' €');
    $('#expensesAmount').text(data.expenses.toFixed(2) + ' €');
    $('#profitAmount').text(data.profit.toFixed(2) + ' €');
    $('#missionsCount').text(data.missions_count);

    // Calculer et afficher la marge
    if (data.income > 0) {
        const margin = (data.profit / data.income * 100).toFixed(1);
        $('#profitMargin').text(margin + '% de marge');
    }

    // Mettre à jour la couleur du bénéfice
    const profitElement = $('#profitAmount');
    profitElement.removeClass('text-primary text-danger');
    profitElement.addClass(data.profit >= 0 ? 'text-primary' : 'text-danger');
}

// Afficher le modal de période personnalisée
function showCustomPeriodModal() {
    // Définir les dates par défaut (30 derniers jours)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);

    $('#customStartDate').val(startDate.toISOString().split('T')[0]);
    $('#customEndDate').val(endDate.toISOString().split('T')[0]);

    $('#customPeriodModal').modal('show');
}

// Appliquer une période personnalisée
function applyCustomPeriod() {
    const startDate = $('#customStartDate').val();
    const endDate = $('#customEndDate').val();

    if (!startDate || !endDate) {
        alert('Veuillez sélectionner une période valide.');
        return;
    }

    // Ici, vous feriez un appel AJAX avec les dates personnalisées
    // fetch(`/api/financial-summary/?start_date=${startDate}&end_date=${endDate}`)
    //     .then(response => response.json())
    //     .then(data => updateSummaryData(data));

    $('#customPeriodModal').modal('hide');
}

// Télécharger le rapport
function downloadFinancialReport() {
    const reportData = {
        period: '{{ period }}',
        income: parseFloat($('#incomeAmount').text()),
        expenses: parseFloat($('#expensesAmount').text()),
        profit: parseFloat($('#profitAmount').text()),
        missions_count: parseInt($('#missionsCount').text()),
        date: new Date().toISOString()
    };

    const csv = `Période,Revenus,Dépenses,Bénéfice,Missions\n"{{ period }}",${reportData.income},${reportData.expenses},${reportData.profit},${reportData.missions_count}`;

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `rapport_financier_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Imprimer le résumé
function printFinancialSummary() {
    const printContent = document.querySelector('.financial-summary').innerHTML;
    const printWindow = window.open('', '_blank');

    printWindow.document.write(`
        <html>
            <head>
                <title>{% trans "Résumé financier" %}</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { padding: 20px; }
                    .card { border: 1px solid #dee2e6; }
                </style>
            </head>
            <body>
                ${printContent}
            </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();
}

// Afficher un type de graphique spécifique
function showChart(type) {
    currentChartType = type;
    updateChart();
}

// Mettre à jour le graphique
function updateChart() {
    if (!financialChart) {
        initializeChart();
        return;
    }

    const labels = generateLabels();
    const data = generateChartData(currentChartType);

    financialChart.data.labels = labels;
    financialChart.data.datasets[0].data = data;
    financialChart.data.datasets[0].label = getChartLabel(currentChartType);
    financialChart.data.datasets[0].backgroundColor = getChartColor(currentChartType);
    financialChart.data.datasets[0].borderColor = getChartColor(currentChartType);

    financialChart.update();
}

// Initialiser le graphique
function initializeChart() {
    const ctx = document.getElementById('financialChart').getContext('2d');
    const labels = generateLabels();
    const data = generateChartData(currentChartType);

    financialChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: getChartLabel(currentChartType),
                data: data,
                backgroundColor: getChartColor(currentChartType, 0.1),
                borderColor: getChartColor(currentChartType),
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + ' €';
                        }
                    }
                }
            }
        }
    });
}

// Générer les labels pour le graphique
function generateLabels() {
    if ('{{ period }}' === 'week') {
        return ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
    } else if ('{{ period }}' === 'month') {
        return ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
    } else if ('{{ period }}' === 'year') {
        return ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
    }
    return ['Jour 1', 'Jour 2', 'Jour 3', 'Jour 4', 'Jour 5'];
}

// Générer les données du graphique
function generateChartData(type) {
    const base = type === 'revenue' ? 1000 : type === 'expenses' ? 300 : 700;
    const variance = type === 'revenue' ? 200 : type === 'expenses' ? 50 : 150;

    return Array.from({length: generateLabels().length}, () =>
        getRandomAmount(base - variance, base + variance)
    );
}

// Obtenir le label du graphique
function getChartLabel(type) {
    return {
        'revenue': '{% trans "Revenus" %}',
        'expenses': '{% trans "Dépenses" %}',
        'profit': '{% trans "Bénéfice" %}'
    }[type] || '{% trans "Revenus" %}';
}

// Obtenir la couleur du graphique
function getChartColor(type, opacity = 1) {
    const colors = {
        'revenue': `rgba(40, 167, 69, ${opacity})`, // Vert
        'expenses': `rgba(220, 53, 69, ${opacity})`, // Rouge
        'profit': `rgba(0, 123, 255, ${opacity})`    // Bleu
    };

    return colors[type] || `rgba(0, 123, 255, ${opacity})`;
}

// Fonctions utilitaires
function getRandomAmount(min, max) {
    return Math.random() * (max - min) + min;
}

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

// Initialiser au chargement de la page
$(document).ready(function() {
    {% if show_chart %}
    // Attendre un peu pour que le canvas soit complètement chargé
    setTimeout(initializeChart, 500);
    {% endif %}

    // Définir les boutons actifs
    $(`.btn-group .btn[onclick*="${period}"]`).addClass('active');
});
</script>