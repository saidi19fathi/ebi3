{% extends "carriers/base.html" %}
{% load i18n %}

{% block title %}{% trans "Inscription Transporteur" %}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-truck"></i> {% trans "Devenez transporteur" %}
                    </h4>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h2>{% trans "Inscription Transporteur" %}</h2>
                        <p class="text-muted">
                            {% trans "Rejoignez notre plateforme de transport et commencez à livrer dès aujourd'hui." %}
                        </p>
                    </div>

                    <form method="post" enctype="multipart/form-data" id="registrationForm">
                        {% csrf_token %}

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            {% trans "Les champs marqués d'un * sont obligatoires." %}
                        </div>

                        <div class="progress mb-4" style="height: 10px;">
                            <div class="progress-bar" role="progressbar" style="width: 0%;"
                                 id="registrationProgress"></div>
                        </div>

                        <!-- Étape 1 : Informations personnelles -->
                        <div class="registration-step" id="step1">
                            <h5 class="mb-3 border-bottom pb-2">
                                <span class="badge bg-primary">1</span>
                                {% trans "Informations personnelles" %}
                            </h5>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="id_first_name" class="form-label">
                                            {% trans "Prénom" %} *
                                        </label>
                                        {{ form.first_name }}
                                        {% if form.first_name.errors %}
                                            <div class="text-danger">{{ form.first_name.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="id_last_name" class="form-label">
                                            {% trans "Nom" %} *
                                        </label>
                                        {{ form.last_name }}
                                        {% if form.last_name.errors %}
                                            <div class="text-danger">{{ form.last_name.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="id_email" class="form-label">
                                            {% trans "Email" %} *
                                        </label>
                                        {{ form.email }}
                                        {% if form.email.errors %}
                                            <div class="text-danger">{{ form.email.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="id_phone" class="form-label">
                                            {% trans "Téléphone" %} *
                                        </label>
                                        {{ form.phone }}
                                        {% if form.phone.errors %}
                                            <div class="text-danger">{{ form.phone.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="id_password" class="form-label">
                                            {% trans "Mot de passe" %} *
                                        </label>
                                        {{ form.password }}
                                        {% if form.password.errors %}
                                            <div class="text-danger">{{ form.password.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="id_password_confirm" class="form-label">
                                            {% trans "Confirmer le mot de passe" %} *
                                        </label>
                                        {{ form.password_confirm }}
                                        {% if form.password_confirm.errors %}
                                            <div class="text-danger">{{ form.password_confirm.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="id_profile_photo" class="form-label">
                                            {% trans "Photo de profil" %}
                                        </label>
                                        {{ form.profile_photo }}
                                        <small class="text-muted">{% trans "Format JPG ou PNG, max 2MB" %}</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">{% trans "Pièce d'identité" %} *</label>
                                        <div class="row">
                                            <div class="col-6">
                                                {{ form.id_front }}
                                                <small class="text-muted">{% trans "Recto" %}</small>
                                            </div>
                                            <div class="col-6">
                                                {{ form.id_back }}
                                                <small class="text-muted">{% trans "Verso" %}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" disabled>
                                    {% trans "Précédent" %}
                                </button>
                                <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                                    {% trans "Suivant" %}
                                </button>
                            </div>
                        </div>

                        <!-- Étape 2 : Informations professionnelles -->
                        <div class="registration-step" id="step2" style="display: none;">
                            <h5 class="mb-3 border-bottom pb-2">
                                <span class="badge bg-primary">2</span>
                                {% trans "Informations professionnelles" %}
                            </h5>

                            <div class="form-group mb-3">
                                <label for="id_carrier_type" class="form-label">
                                    {% trans "Type de transporteur" %} *
                                </label>
                                {{ form.carrier_type }}
                            </div>

                            <div id="companyFields" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="id_company_name" class="form-label">
                                                {% trans "Nom de l'entreprise" %} *
                                            </label>
                                            {{ form.company_name }}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="id_company_registration" class="form-label">
                                                {% trans "Numéro d'immatriculation" %}
                                            </label>
                                            {{ form.company_registration }}
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="id_tax_id" class="form-label">
                                                {% trans "Numéro fiscal/TVA" %}
                                            </label>
                                            {{ form.tax_id }}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="id_company_address" class="form-label">
                                                {% trans "Adresse de l'entreprise" %}
                                            </label>
                                            {{ form.company_address }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="id_vehicle_type" class="form-label">
                                            {% trans "Type de véhicule" %} *
                                        </label>
                                        {{ form.vehicle_type }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="id_vehicle_registration" class="form-label">
                                            {% trans "Plaque d'immatriculation" %}
                                        </label>
                                        {{ form.vehicle_registration }}
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label class="form-label">{% trans "Types de marchandises acceptées" %}</label>
                                <div class="row">
                                    {% for value, label in form.accepted_merchandise_types.field.choices %}
                                        {% if value %}
                                            <div class="col-md-4 mb-2">
                                                <div class="form-check">
                                                    <input type="checkbox"
                                                           name="accepted_merchandise_types"
                                                           value="{{ value }}"
                                                           class="form-check-input"
                                                           id="type_{{ value }}">
                                                    <label class="form-check-label" for="type_{{ value }}">
                                                        {{ label }}
                                                    </label>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label for="id_custom_merchandise_types" class="form-label">
                                    {% trans "Autres types de marchandises" %}
                                </label>
                                {{ form.custom_merchandise_types }}
                                <small class="text-muted">{% trans "Séparez par des virgules" %}</small>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" onclick="prevStep(1)">
                                    {% trans "Précédent" %}
                                </button>
                                <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                                    {% trans "Suivant" %}
                                </button>
                            </div>
                        </div>

                        <!-- Étape 3 : Capacités et tarifs -->
                        <div class="registration-step" id="step3" style="display: none;">
                            <h5 class="mb-3 border-bottom pb-2">
                                <span class="badge bg-primary">3</span>
                                {% trans "Capacités et tarifs" %}
                            </h5>

                            <h6 class="mb-3">{% trans "Capacités du véhicule" %}</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group mb-3">
                                        <label for="id_max_weight" class="form-label">
                                            {% trans "Poids max (kg)" %} *
                                        </label>
                                        {{ form.max_weight }}
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group mb-3">
                                        <label for="id_max_volume" class="form-label">
                                            {% trans "Volume max (m³)" %} *
                                        </label>
                                        {{ form.max_volume }}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group mb-3">
                                        <label for="id_max_length" class="form-label">
                                            {% trans "Longueur (m)" %}
                                        </label>
                                        {{ form.max_length }}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group mb-3">
                                        <label for="id_max_width" class="form-label">
                                            {% trans "Largeur (m)" %}
                                        </label>
                                        {{ form.max_width }}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group mb-3">
                                        <label for="id_max_height" class="form-label">
                                            {% trans "Hauteur (m)" %}
                                        </label>
                                        {{ form.max_height }}
                                    </div>
                                </div>
                            </div>

                            <h6 class="mt-4 mb-3">{% trans "Services proposés" %}</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check mb-3">
                                        {{ form.provides_packaging }}
                                        <label class="form-check-label" for="id_provides_packaging">
                                            {% trans "Emballage" %}
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mb-3">
                                        {{ form.provides_insurance }}
                                        <label class="form-check-label" for="id_provides_insurance">
                                            {% trans "Assurance" %}
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mb-3">
                                        {{ form.provides_loading }}
                                        <label class="form-check-label" for="id_provides_loading">
                                            {% trans "Chargement" %}
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mb-3">
                                        {{ form.provides_unloading }}
                                        <label class="form-check-label" for="id_provides_unloading">
                                            {% trans "Déchargement" %}
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <h6 class="mt-4 mb-3">{% trans "Tarification" %}</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="id_base_price_per_km" class="form-label">
                                            {% trans "Prix par km (€)" %} *
                                        </label>
                                        {{ form.base_price_per_km }}
                                        <small class="text-muted">{% trans "Prix de base par kilomètre" %}</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="id_min_price" class="form-label">
                                            {% trans "Prix minimum (€)" %} *
                                        </label>
                                        {{ form.min_price }}
                                        <small class="text-muted">{% trans "Prix minimum pour une mission" %}</small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label for="id_currency" class="form-label">{% trans "Devise" %} *</label>
                                {{ form.currency }}
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" onclick="prevStep(2)">
                                    {% trans "Précédent" %}
                                </button>
                                <button type="button" class="btn btn-primary" onclick="nextStep(4)">
                                    {% trans "Suivant" %}
                                </button>
                            </div>
                        </div>

                        <!-- Étape 4 : Conditions et finalisation -->
                        <div class="registration-step" id="step4" style="display: none;">
                            <h5 class="mb-3 border-bottom pb-2">
                                <span class="badge bg-primary">4</span>
                                {% trans "Conditions et finalisation" %}
                            </h5>

                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>{% trans "Important" %}:</strong>
                                {% trans "Votre compte sera soumis à validation. Vous recevrez une notification une fois approuvé." %}
                            </div>

                            <div class="mb-4">
                                <div class="form-check mb-3">
                                    {{ form.rgpd_consent }}
                                    <label class="form-check-label" for="id_rgpd_consent">
                                        {% trans "J'accepte la politique de confidentialité" %} *
                                    </label>
                                    <a href="#" class="small">{% trans "Lire la politique" %}</a>
                                </div>

                                <div class="form-check mb-3">
                                    {{ form.terms_accepted }}
                                    <label class="form-check-label" for="id_terms_accepted">
                                        {% trans "J'accepte les conditions générales d'utilisation" %} *
                                    </label>
                                    <a href="#" class="small">{% trans "Lire les conditions" %}</a>
                                </div>
                            </div>

                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>{% trans "Récapitulatif" %}</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">{% trans "Type de transporteur" %}</small>
                                            <span id="summaryType"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">{% trans "Véhicule" %}</small>
                                            <span id="summaryVehicle"></span>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">{% trans "Capacité max" %}</small>
                                            <span id="summaryCapacity"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">{% trans "Prix par km" %}</small>
                                            <span id="summaryPrice"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" onclick="prevStep(3)">
                                    {% trans "Précédent" %}
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i> {% trans "Terminer l'inscription" %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="text-center mt-4">
                <p class="text-muted">
                    {% trans "Déjà inscrit ?" %}
                    <a href="{% url 'carriers:login' %}">{% trans "Connectez-vous" %}</a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;

function showStep(step) {
    $('.registration-step').hide();
    $(`#step${step}`).show();

    // Mettre à jour la barre de progression
    const progress = (step / 4) * 100;
    $('#registrationProgress').css('width', `${progress}%`);

    currentStep = step;
}

function nextStep(next) {
    // Validation basique de l'étape courante
    let valid = true;
    $(`#step${currentStep} input[required], #step${currentStep} select[required]`).each(function() {
        if (!$(this).val()) {
            valid = false;
            $(this).addClass('is-invalid');
        } else {
            $(this).removeClass('is-invalid');
        }
    });

    if (valid) {
        // Mettre à jour le récapitulatif
        if (next === 4) {
            updateSummary();
        }
        showStep(next);
    } else {
        alert('Veuillez remplir tous les champs obligatoires.');
    }
}

function prevStep(prev) {
    showStep(prev);
}

function updateSummary() {
    // Type de transporteur
    const carrierType = $('#id_carrier_type option:selected').text();
    $('#summaryType').text(carrierType);

    // Véhicule
    const vehicleType = $('#id_vehicle_type option:selected').text();
    const vehicleMake = $('#id_vehicle_make').val();
    const vehicleModel = $('#id_vehicle_model').val();
    $('#summaryVehicle').text(`${vehicleType} ${vehicleMake ? vehicleMake + ' ' : ''}${vehicleModel || ''}`);

    // Capacité
    const maxWeight = $('#id_max_weight').val();
    const maxVolume = $('#id_max_volume').val();
    $('#summaryCapacity').text(`${maxWeight} kg / ${maxVolume} m³`);

    // Prix
    const basePrice = $('#id_base_price_per_km').val();
    const currency = $('#id_currency option:selected').text();
    $('#summaryPrice').text(`${basePrice} ${currency} / km`);
}

// Gérer l'affichage des champs entreprise
$(document).ready(function() {
    $('#id_carrier_type').change(function() {
        if ($(this).val() === 'PROFESSIONAL') {
            $('#companyFields').show();
            $('#companyFields input').prop('required', true);
        } else {
            $('#companyFields').hide();
            $('#companyFields input').prop('required', false);
        }
    });

    // Gérer l'affichage du champ "Autre" pour les types de marchandises
    $('input[name="accepted_merchandise_types"]').change(function() {
        const otherChecked = $('#type_OTHER').is(':checked');
        if (otherChecked) {
            $('#id_custom_merchandise_types').closest('.form-group').show();
        } else {
            $('#id_custom_merchandise_types').closest('.form-group').hide();
        }
    });

    // Masquer initialement le champ "Autre"
    $('#id_custom_merchandise_types').closest('.form-group').hide();
});
</script>
{% endblock %}