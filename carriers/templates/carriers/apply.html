{# ~/ebi3/carriers/templates/carriers/apply.html #}
{% extends 'carriers/base_carriers.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Devenir transporteur" %} - Ebi3{% endblock %}

{% block carriers_content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="fas fa-truck"></i> {% trans "Devenir transporteur Ebi3" %}
                </h2>
            </div>

            <div class="card-body p-4">
                <!-- Vérification du profil utilisateur -->
                {% if user.is_authenticated %}
                    {% if user.carrier_profile %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            {% trans "Vous avez déjà un profil transporteur." %}
                            <a href="{% url 'carriers:carrier_dashboard' %}" class="alert-link">
                                {% trans "Accéder au tableau de bord" %}
                            </a>
                        </div>
                    {% else %}
                        <!-- CORRECTION: Ajouter le username dans l'URL -->
                        {% if not user.profile.is_complete %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                {% trans "Vous devez compléter votre profil avant de devenir transporteur." %}
                                <!-- CORRIGER ICI -->
                                <a href="{% url 'users:profile_edit' user.username %}" class="alert-link">
                                    {% trans "Compléter mon profil" %}
                                </a>
                            </div>
                        {% endif %}

                        <!-- Étapes du processus -->
                        <div class="steps mb-5">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h5>{% trans "Profil utilisateur" %}</h5>
                                    <p>{% trans "Complétez vos informations personnelles" %}</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h5>{% trans "Formulaire transporteur" %}</h5>
                                    <p>{% trans "Remplissez le formulaire ci-dessous" %}</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h5>{% trans "Documents" %}</h5>
                                    <p>{% trans "Téléchargez vos documents" %}</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h5>{% trans "Vérification" %}</h5>
                                    <p>{% trans "Validation par notre équipe" %}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Formulaire de candidature -->
                        {% if user.profile.is_complete %}
                            <form method="post" enctype="multipart/form-data" id="carrier-application-form">
                                {% csrf_token %}

                                <h4 class="mb-4">
                                    <i class="fas fa-file-alt"></i> {% trans "Formulaire de candidature" %}
                                </h4>

                                {{ form|crispy }}

                                <div class="card mb-4">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-file-upload"></i> {% trans "Documents (optionnel)" %}
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        {{ document_formset.management_form }}
                                        {% for form in document_formset %}
                                            <div class="document-form mb-3 p-3 border rounded">
                                                {{ form|crispy }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="checkbox" id="terms" required>
                                    <label class="form-check-label" for="terms">
                                        {% trans "J'accepte les" %}
                                        <a href="{% url 'legal:terms' %}" target="_blank">{% trans "conditions générales" %}</a>
                                        {% trans "et la" %}
                                        <a href="{% url 'legal:privacy' %}" target="_blank">{% trans "politique de confidentialité" %}</a>.
                                    </label>
                                </div>


                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="{% url 'carriers:carrier_list' %}" class="btn btn-secondary me-md-2">
                                        <i class="fas fa-times"></i> {% trans "Annuler" %}
                                    </a>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-paper-plane"></i> {% trans "Soumettre ma candidature" %}
                                    </button>
                                </div>
                            </form>
                        {% else %}
                            <div class="alert alert-warning text-center">
                                <i class="fas fa-user-circle fa-3x mb-3"></i>
                                <h4>{% trans "Profil incomplet" %}</h4>
                                <p>{% trans "Veuillez d'abord compléter votre profil utilisateur." %}</p>
                                <!-- CORRIGER ICI -->
                                <a href="{% url 'users:profile_edit' user.username %}" class="btn btn-primary mt-3">
                                    <i class="fas fa-user-edit"></i> {% trans "Compléter mon profil" %}
                                </a>
                            </div>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-lock fa-3x mb-3"></i>
                        <h4>{% trans "Accès non autorisé" %}</h4>
                        <p>{% trans "Vous devez être connecté pour devenir transporteur." %}</p>
                        <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-primary mt-3">
                            <i class="fas fa-sign-in-alt"></i> {% trans "Se connecter" %}
                        </a>
                    </div>
                {% endif %}
            </div>

            <div class="card-footer bg-light">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <i class="fas fa-shield-alt fa-2x text-primary mb-2"></i>
                        <h6>{% trans "Sécurisé" %}</h6>
                        <small class="text-muted">{% trans "Données protégées" %}</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <i class="fas fa-clock fa-2x text-primary mb-2"></i>
                        <h6>{% trans "Rapide" %}</h6>
                        <small class="text-muted">{% trans "Validation en 48h" %}</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <i class="fas fa-headset fa-2x text-primary mb-2"></i>
                        <h6>{% trans "Support" %}</h6>
                        <small class="text-muted">{% trans "Assistance 7j/7" %}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin: 40px 0;
}

.steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 10%;
    right: 10%;
    height: 3px;
    background: #e9ecef;
    z-index: 1;
}

.step {
    text-align: center;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    background: #6c757d;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 auto 10px;
}

.step.active .step-number {
    background: #007bff;
}

.step.completed .step-number {
    background: #28a745;
}

.step-content {
    max-width: 150px;
    margin: 0 auto;
}

.step-content h5 {
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.step-content p {
    font-size: 0.8rem;
    color: #6c757d;
}

.document-form {
    background: #f8f9fa;
}

.document-form:hover {
    background: #e9ecef;
}

.alert-link {
    text-decoration: underline;
    font-weight: bold;
}

.card {
    border-radius: 15px;
    overflow: hidden;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}
</style>

<script>
$(document).ready(function() {
    // Animation des étapes
    $('.step').hover(function() {
        $(this).find('.step-number').css('transform', 'scale(1.1)');
    }, function() {
        $(this).find('.step-number').css('transform', 'scale(1)');
    });

    // Validation du formulaire
    $('#carrier-application-form').submit(function(e) {
        if (!$('#terms').is(':checked')) {
            e.preventDefault();
            alert('{% trans "Vous devez accepter les conditions générales." %}');
            $('#terms').focus();
        }
    });
});
</script>
{% endblock %}