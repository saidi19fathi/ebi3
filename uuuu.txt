========== ads/templates/ads/my_ads.html ==========
{# ~/ebi3/ads/templates/ads/my_ads.html #}
{% extends 'ads/base_ads.html' %}
{% load i18n %}

{% block title %}{% trans "Mes annonces" %} - Ebi3{% endblock %}

{% block ads_content %}
<div class="container-fluid">
    <!-- En-tête avec statistiques -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="mb-0">
                    <i class="fas fa-bullhorn"></i> {% trans "Mes annonces" %}
                </h1>
                <a href="{% url 'ads:ad_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> {% trans "Créer une annonce" %}
                </a>
            </div>

            <!-- Cartes de statistiques -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-0">{% trans "Total" %}</h6>
                                    <h2 class="mb-0">{{ total|default:0 }}</h2>
                                </div>
                                <i class="fas fa-layer-group fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-0">{% trans "Actives" %}</h6>
                                    <h2 class="mb-0">{{ active|default:0 }}</h2>
                                </div>
                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-0">{% trans "Vues totales" %}</h6>
                                    <h2 class="mb-0">{{ total_views|default:0 }}</h2>
                                </div>
                                <i class="fas fa-eye fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-0">{% trans "Favoris" %}</h6>
                                    <h2 class="mb-0">{{ total_favorites|default:0 }}</h2>
                                </div>
                                <i class="fas fa-heart fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres et onglets -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <!-- Onglets -->
                    <ul class="nav nav-tabs mb-3" id="myAdsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="all-tab" data-bs-toggle="tab"
                                    data-bs-target="#all" type="button" role="tab">
                                <i class="fas fa-list"></i> {% trans "Toutes" %}
                                <span class="badge bg-secondary ms-1">{{ total|default:0 }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="active-tab" data-bs-toggle="tab"
                                    data-bs-target="#active" type="button" role="tab">
                                <i class="fas fa-check-circle"></i> {% trans "Actives" %}
                                <span class="badge bg-success ms-1">{{ active|default:0 }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="draft-tab" data-bs-toggle="tab"
                                    data-bs-target="#draft" type="button" role="tab">
                                <i class="fas fa-edit"></i> {% trans "Brouillons" %}
                                <span class="badge bg-secondary ms-1">{{ draft|default:0 }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="sold-tab" data-bs-toggle="tab"
                                    data-bs-target="#sold" type="button" role="tab">
                                <i class="fas fa-check"></i> {% trans "Vendues" %}
                                <span class="badge bg-primary ms-1">{{ sold|default:0 }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reserved-tab" data-bs-toggle="tab"
                                    data-bs-target="#reserved" type="button" role="tab">
                                <i class="fas fa-shopping-cart"></i> {% trans "Réservées" %}
                                <span class="badge bg-info ms-1">{{ reserved|default:0 }}</span>
                            </button>
                        </li>
                    </ul>

                    <!-- Barre de recherche et filtres -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchMyAds"
                                       placeholder="{% trans 'Rechercher dans mes annonces...' %}">
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown">
                                    <i class="fas fa-sort"></i> {% trans "Trier par" %}
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="-created_at">
                                        <i class="fas fa-calendar"></i> {% trans "Plus récentes" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="created_at">
                                        <i class="fas fa-calendar"></i> {% trans "Plus anciennes" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="-view_count">
                                        <i class="fas fa-eye"></i> {% trans "Plus vues" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="-favorite_count">
                                        <i class="fas fa-heart"></i> {% trans "Plus favorites" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="-price">
                                        <i class="fas fa-euro-sign"></i> {% trans "Prix décroissant" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="price">
                                        <i class="fas fa-euro-sign"></i> {% trans "Prix croissant" %}
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenu des onglets -->
    <div class="tab-content" id="myAdsTabContent">
        <!-- Toutes les annonces -->
        <div class="tab-pane fade show active" id="all" role="tabpanel">
            {% if ads %}
                <div class="row" id="all-ads-container">
                    {% for ad in ads %}
                        <div class="col-md-6 col-lg-4 mb-4 ad-item"
                             data-status="{{ ad.status }}"
                             data-created="{{ ad.created_at|date:'U' }}"
                             data-views="{{ ad.view_count }}"
                             data-favorites="{{ ad.favorite_count }}"
                             data-price="{{ ad.price }}"
                             data-title="{{ ad.title|lower }}">
                            <div class="card h-100 border {% if ad.is_featured %}border-warning{% endif %}">
                                {% if ad.is_featured %}
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="badge bg-warning">
                                            <i class="fas fa-star"></i> {% trans "Vedette" %}
                                        </span>
                                    </div>
                                {% endif %}

                                <!-- Badge de statut -->
                                <div class="position-absolute top-0 start-0 m-2">
                                    <span class="badge
                                        {% if ad.status == 'ACTIVE' %}bg-success
                                        {% elif ad.status == 'DRAFT' %}bg-secondary
                                        {% elif ad.status == 'SOLD' %}bg-primary
                                        {% elif ad.status == 'RESERVED' %}bg-info
                                        {% elif ad.status == 'EXPIRED' %}bg-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ ad.get_status_display }}
                                    </span>
                                </div>

                                <!-- Image -->
                                <div class="position-relative">
                                    {% with ad.images.first as main_image %}
                                        {% if main_image %}
                                            {# CORRECTION ICI : Vérifier si le thumbnail existe avant de l'utiliser #}
                                            {% if main_image.thumbnail and main_image.thumbnail.url %}
                                                <img src="{{ main_image.thumbnail.url }}"
                                                     class="card-img-top"
                                                     style="height: 180px; object-fit: cover;"
                                                     alt="{{ ad.title }}"
                                                     loading="lazy">
                                            {% else %}
                                                <img src="{{ main_image.image.url }}"
                                                     class="card-img-top"
                                                     style="height: 180px; object-fit: cover;"
                                                     alt="{{ ad.title }}"
                                                     loading="lazy">
                                            {% endif %}
                                        {% else %}
                                            <div class="bg-light d-flex align-items-center justify-content-center"
                                                 style="height: 180px;">
                                                <i class="fas fa-image fa-3x text-muted"></i>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>

                                <!-- Corps de la carte -->
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">
                                        <a href="{{ ad.get_absolute_url }}" class="text-decoration-none">
                                            {{ ad.title|truncatechars:40 }}
                                        </a>
                                    </h5>

                                    <p class="card-text text-muted small mb-2">
                                        <i class="fas fa-map-marker-alt"></i>
                                        {{ ad.city_from }} → {{ ad.city_to }}
                                    </p>

                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <span class="fs-5 fw-bold text-primary">
                                                    {{ ad.get_price_with_currency }}
                                                </span>
                                                {% if ad.is_negotiable %}
                                                    <small class="text-muted">{% trans "(Négociable)" %}</small>
                                                {% endif %}
                                            </div>

                                            <!-- Actions rapides -->
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                                        type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li>
                                                        <a class="dropdown-item" href="{{ ad.get_absolute_url }}">
                                                            <i class="fas fa-eye"></i> {% trans "Voir" %}
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="{% url 'ads:ad_edit' ad.slug %}">
                                                            <i class="fas fa-edit"></i> {% trans "Modifier" %}
                                                        </a>
                                                    </li>
                                                    {% if ad.status == 'ACTIVE' %}
                                                        <li>
                                                            <a class="dropdown-item" href="{% url 'ads:change_status' ad.slug 'RESERVED' %}">
                                                                <i class="fas fa-shopping-cart"></i> {% trans "Marquer comme réservée" %}
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" href="{% url 'ads:change_status' ad.slug 'SOLD' %}">
                                                                <i class="fas fa-check"></i> {% trans "Marquer comme vendue" %}
                                                            </a>
                                                        </li>
                                                    {% endif %}
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <a class="dropdown-item text-danger"
                                                           href="{% url 'ads:ad_delete' ad.slug %}">
                                                            <i class="fas fa-trash"></i> {% trans "Supprimer" %}
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pied de carte avec statistiques -->
                                <div class="card-footer bg-transparent border-top pt-2 pb-2">
                                    <div class="d-flex justify-content-between text-muted small">
                                        <div>
                                            <i class="fas fa-eye"></i> {{ ad.view_count }}
                                        </div>
                                        <div>
                                            <i class="fas fa-heart"></i> {{ ad.favorite_count }}
                                        </div>
                                        <div>
                                            <i class="fas fa-comments"></i> {{ ad.inquiry_count }}
                                        </div>
                                        <div title="{{ ad.created_at }}">
                                            <i class="fas fa-calendar"></i> {{ ad.created_at|timesince }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if is_paginated %}
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}

            {% else %}
                <!-- Aucune annonce -->
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-bullhorn fa-4x text-muted"></i>
                    </div>
                    <h3 class="mb-3">{% trans "Vous n'avez pas encore d'annonces" %}</h3>
                    <p class="text-muted mb-4">
                        {% trans "Commencez par créer votre première annonce !" %}
                    </p>
                    <a href="{% url 'ads:ad_create' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus"></i> {% trans "Créer ma première annonce" %}
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Annonces actives -->
        <div class="tab-pane fade" id="active" role="tabpanel">
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-check-circle fa-4x text-success"></i>
                </div>
                <p class="text-muted">
                    {% trans "Utilisez le filtre de recherche pour voir vos annonces actives." %}
                </p>
            </div>
        </div>

        <!-- Brouillons -->
        <div class="tab-pane fade" id="draft" role="tabpanel">
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-edit fa-4x text-secondary"></i>
                </div>
                <p class="text-muted">
                    {% trans "Utilisez le filtre de recherche pour voir vos brouillons." %}
                </p>
            </div>
        </div>

        <!-- Vendues -->
        <div class="tab-pane fade" id="sold" role="tabpanel">
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-check fa-4x text-primary"></i>
                </div>
                <p class="text-muted">
                    {% trans "Utilisez le filtre de recherche pour voir vos annonces vendues." %}
                </p>
            </div>
        </div>

        <!-- Réservées -->
        <div class="tab-pane fade" id="reserved" role="tabpanel">
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-shopping-cart fa-4x text-info"></i>
                </div>
                <p class="text-muted">
                    {% trans "Utilisez le filtre de recherche pour voir vos annonces réservées." %}
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Filtrage en temps réel
        $('#searchMyAds').on('keyup', function() {
            const searchTerm = $(this).val().toLowerCase();

            $('.ad-item').each(function() {
                const title = $(this).data('title');
                const matches = title.includes(searchTerm);

                if (matches || searchTerm === '') {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Tri des annonces
        $('.sort-option').click(function(e) {
            e.preventDefault();
            const sortBy = $(this).data('sort');

            const container = $('#all-ads-container');
            const items = container.find('.ad-item').get();

            items.sort(function(a, b) {
                const aVal = $(a).data(sortBy.replace('-', ''));
                const bVal = $(b).data(sortBy.replace('-', ''));

                if (sortBy.startsWith('-')) {
                    // Ordre décroissant
                    return bVal - aVal;
                } else {
                    // Ordre croissant
                    return aVal - bVal;
                }
            });

            // Réorganiser les éléments
            $.each(items, function(idx, item) {
                container.append(item);
            });

            // Mettre à jour l'interface
            $('.dropdown-toggle').dropdown('hide');
        });

        // Filtrage par onglet
        $('.nav-tabs button').click(function() {
            const target = $(this).data('bs-target');
            const status = target.replace('#', '');

            if (status === 'all') {
                $('.ad-item').show();
            } else {
                $('.ad-item').each(function() {
                    const itemStatus = $(this).data('status').toLowerCase();
                    if (itemStatus === status) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }

            // Réinitialiser la recherche
            $('#searchMyAds').val('');
        });

        // Confirmation pour le changement de statut
        $('a[href*="change_status"]').click(function(e) {
            if (!confirm('{% trans "Confirmez-vous le changement de statut de cette annonce ?" %}')) {
                e.preventDefault();
            }
        });

        // Animation de chargement pour les actions
        $('.dropdown-item').click(function() {
            if ($(this).attr('href') && !$(this).hasClass('text-danger')) {
                $(this).append(' <i class="fas fa-spinner fa-spin"></i>');
            }
        });
    });
</script>

<style>
    .card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .nav-tabs .nav-link {
        border: none;
        position: relative;
    }

    .nav-tabs .nav-link.active {
        border-bottom: 3px solid #007bff;
        background-color: transparent;
    }

    .nav-tabs .nav-link .badge {
        font-size: 0.6rem;
        padding: 0.2rem 0.4rem;
    }

    .stat-card {
        border-radius: 8px;
        overflow: hidden;
    }

    .stat-card i {
        opacity: 0.8;
    }

    .dropdown-menu {
        min-width: 200px;
    }

    .ad-item {
        transition: opacity 0.3s;
    }

    @media (max-width: 768px) {
        .stat-card h2 {
            font-size: 1.5rem;
        }

        .nav-tabs .nav-link {
            padding: 0.5rem;
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}


========== ads/templates/ads/favorite_list.html ==========
{# ~/ebi3/ads/templates/ads/favorite_list.html #}
{% extends 'ads/base_ads.html' %}
{% load i18n %}

{% block title %}{% trans "Mes favoris" %} - Ebi3{% endblock %}

{% block ads_content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="mb-0">
                    <i class="fas fa-heart text-danger"></i> {% trans "Mes annonces favorites" %}
                </h1>
                <div>
                    <a href="{% url 'ads:ad_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-search"></i> {% trans "Parcourir les annonces" %}
                    </a>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card bg-light border">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title text-muted mb-0">{% trans "Total favoris" %}</h6>
                                    <h2 class="mb-0 text-primary">{{ favorites.count|default:0 }}</h2>
                                </div>
                                <i class="fas fa-heart fa-2x text-danger opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card bg-light border">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title text-muted mb-0">{% trans "Prix moyen" %}</h6>
                                    <h2 class="mb-0 text-success">
                                        {% if avg_price %}
                                            {{ avg_price }} €
                                        {% else %}
                                            --
                                        {% endif %}
                                    </h2>
                                </div>
                                <i class="fas fa-euro-sign fa-2x text-success opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card bg-light border">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title text-muted mb-0">{% trans "Ajouté récemment" %}</h6>
                                    <h6 class="mb-0 text-info">
                                        {% if last_added %}
                                            {{ last_added|timesince }}
                                        {% else %}
                                            --
                                        {% endif %}
                                    </h6>
                                </div>
                                <i class="fas fa-clock fa-2x text-info opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre de contrôle -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchFavorites"
                                       placeholder="{% trans 'Rechercher dans mes favoris...' %}">
                            </div>
                        </div>

                        <div class="col-md-6 text-end">
                            <div class="dropdown d-inline-block me-2">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown">
                                    <i class="fas fa-filter"></i> {% trans "Filtrer" %}
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item filter-option active" href="#" data-filter="all">
                                        <i class="fas fa-layer-group"></i> {% trans "Tous" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="active">
                                        <i class="fas fa-check-circle"></i> {% trans "Annonces actives" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="featured">
                                        <i class="fas fa-star"></i> {% trans "En vedette" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="negotiable">
                                        <i class="fas fa-handshake"></i> {% trans "Prix négociable" %}
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="cheap">
                                        <i class="fas fa-euro-sign"></i> {% trans "Moins de 100€" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="medium">
                                        <i class="fas fa-euro-sign"></i> {% trans "100€ - 500€" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="expensive">
                                        <i class="fas fa-euro-sign"></i> {% trans "Plus de 500€" %}
                                    </a></li>
                                </ul>
                            </div>

                            <div class="dropdown d-inline-block">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown">
                                    <i class="fas fa-sort"></i> {% trans "Trier" %}
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item sort-option active" href="#" data-sort="date-desc">
                                        <i class="fas fa-calendar"></i> {% trans "Date d'ajout (récent)" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="date-asc">
                                        <i class="fas fa-calendar"></i> {% trans "Date d'ajout (ancien)" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="price-asc">
                                        <i class="fas fa-euro-sign"></i> {% trans "Prix croissant" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="price-desc">
                                        <i class="fas fa-euro-sign"></i> {% trans "Prix décroissant" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="views-desc">
                                        <i class="fas fa-eye"></i> {% trans "Plus vues" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="title-asc">
                                        <i class="fas fa-font"></i> {% trans "Titre A-Z" %}
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des favoris -->
    <div class="row" id="favorites-container">
        {% if favorites %}
            {% for favorite in favorites %}
                <div class="col-md-6 col-lg-4 mb-4 favorite-item"
                     data-id="{{ favorite.id }}"
                     data-added="{{ favorite.created_at|date:'U' }}"
                     data-price="{{ favorite.ad.price }}"
                     data-views="{{ favorite.ad.view_count }}"
                     data-title="{{ favorite.ad.title|lower }}"
                     data-status="{{ favorite.ad.status }}"
                     data-featured="{{ favorite.ad.is_featured|yesno:'true,false' }}"
                     data-negotiable="{{ favorite.ad.is_negotiable|yesno:'true,false' }}">

                    <!-- Carte d'annonce -->
                    <div class="card h-100 border favorite-card">
                        <!-- Bouton de suppression favori -->
                        <div class="position-absolute top-0 end-0 m-2">
                            <button class="btn btn-sm btn-danger remove-favorite-btn"
                                    data-url="{% url 'ads:toggle_favorite' favorite.ad.slug %}"
                                    data-ad-slug="{{ favorite.ad.slug }}"
                                    title="{% trans 'Retirer des favoris' %}">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>

                        <!-- Badge de statut -->
                        <div class="position-absolute top-0 start-0 m-2">
                            {% if favorite.ad.status != 'ACTIVE' %}
                                <span class="badge bg-warning">
                                    {{ favorite.ad.get_status_display }}
                                </span>
                            {% endif %}
                            {% if favorite.ad.is_featured %}
                                <span class="badge bg-warning mt-1">
                                    <i class="fas fa-star"></i> {% trans "Vedette" %}
                                </span>
                            {% endif %}
                        </div>

                        <!-- Image -->
                        <div class="position-relative">
                            {% with favorite.ad.images.first as main_image %}
                                {% if main_image %}
                                    <a href="{{ favorite.ad.get_absolute_url }}">
                                        <img src="{{ main_image.thumbnail.url|default:main_image.image.url }}"
                                             class="card-img-top"
                                             style="height: 200px; object-fit: cover;"
                                             alt="{{ favorite.ad.title }}"
                                             loading="lazy">
                                    </a>
                                {% else %}
                                    <a href="{{ favorite.ad.get_absolute_url }}">
                                        <div class="bg-light d-flex align-items-center justify-content-center"
                                             style="height: 200px;">
                                            <i class="fas fa-image fa-3x text-muted"></i>
                                        </div>
                                    </a>
                                {% endif %}
                            {% endwith %}
                        </div>

                        <!-- Corps de la carte -->
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">
                                <a href="{{ favorite.ad.get_absolute_url }}" class="text-decoration-none text-dark">
                                    {{ favorite.ad.title|truncatechars:45 }}
                                </a>
                            </h5>

                            <p class="card-text text-muted small mb-2">
                                <i class="fas fa-map-marker-alt"></i>
                                {{ favorite.ad.city_from }} → {{ favorite.ad.city_to }}
                            </p>

                            <p class="card-text small text-muted mb-3">
                                {{ favorite.ad.description|truncatechars:80 }}
                            </p>

                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="fs-5 fw-bold text-primary">
                                            {{ favorite.ad.get_price_with_currency }}
                                        </span>
                                        {% if favorite.ad.is_negotiable %}
                                            <small class="text-muted">{% trans "(Négociable)" %}</small>
                                        {% endif %}
                                    </div>

                                    <!-- Actions -->
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                                type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="{{ favorite.ad.get_absolute_url }}">
                                                    <i class="fas fa-eye"></i> {% trans "Voir l'annonce" %}
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="{% url 'users:profile' favorite.ad.seller.username %}">
                                                    <i class="fas fa-user"></i> {% trans "Voir le vendeur" %}
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="{% url 'messaging:new_conversation' favorite.ad.seller.username %}">
                                                    <i class="fas fa-envelope"></i> {% trans "Contacter" %}
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger remove-favorite-action"
                                                   href="#" data-url="{% url 'ads:toggle_favorite' favorite.ad.slug %}">
                                                    <i class="fas fa-trash"></i> {% trans "Supprimer des favoris" %}
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pied de carte -->
                        <div class="card-footer bg-transparent border-top pt-2 pb-2">
                            <div class="d-flex justify-content-between text-muted small">
                                <div title="{% trans 'Date d\'ajout aux favoris' %}">
                                    <i class="fas fa-calendar-plus"></i> {{ favorite.created_at|timesince }}
                                </div>
                                <div>
                                    <i class="fas fa-eye"></i> {{ favorite.ad.view_count }}
                                </div>
                                <div>
                                    <i class="fas fa-heart text-danger"></i> {{ favorite.ad.favorite_count }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <!-- Aucun favori -->
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-heart fa-4x text-muted"></i>
                    </div>
                    <h3 class="mb-3">{% trans "Vous n'avez pas encore de favoris" %}</h3>
                    <p class="text-muted mb-4">
                        {% trans "Parcourez les annonces et ajoutez celles qui vous intéressent à vos favoris !" %}
                    </p>
                    <a href="{% url 'ads:ad_list' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-search"></i> {% trans "Parcourir les annonces" %}
                    </a>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Actions groupées -->
    {% if favorites %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-cogs"></i> {% trans "Actions groupées" %}
                        </h5>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-outline-danger" id="clear-all-favorites">
                                <i class="fas fa-trash"></i> {% trans "Tout supprimer" %}
                            </button>
                            <button class="btn btn-outline-secondary" id="export-favorites">
                                <i class="fas fa-download"></i> {% trans "Exporter la liste" %}
                            </button>
                            <button class="btn btn-outline-primary" id="compare-selected">
                                <i class="fas fa-balance-scale"></i> {% trans "Comparer les sélectionnés" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmRemoveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-heart-broken text-danger"></i> {% trans "Retirer des favoris" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "Êtes-vous sûr de vouloir retirer cette annonce de vos favoris ?" %}</p>
                <p class="text-muted small">
                    {% trans "Vous pourrez toujours la retrouver plus tard si elle est toujours disponible." %}
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Annuler" %}
                </button>
                <button type="button" class="btn btn-danger" id="confirmRemoveBtn">
                    <i class="fas fa-heart-broken"></i> {% trans "Retirer" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        let currentRemoveUrl = '';

        // Recherche en temps réel
        $('#searchFavorites').on('keyup', function() {
            const searchTerm = $(this).val().toLowerCase();

            $('.favorite-item').each(function() {
                const title = $(this).data('title');
                const matches = title.includes(searchTerm);

                if (matches || searchTerm === '') {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Filtrage
        $('.filter-option').click(function(e) {
            e.preventDefault();
            const filter = $(this).data('filter');

            // Mettre à jour l'état actif
            $('.filter-option').removeClass('active');
            $(this).addClass('active');

            $('.favorite-item').each(function() {
                let show = false;

                switch(filter) {
                    case 'all':
                        show = true;
                        break;
                    case 'active':
                        show = $(this).data('status') === 'ACTIVE';
                        break;
                    case 'featured':
                        show = $(this).data('featured') === 'true';
                        break;
                    case 'negotiable':
                        show = $(this).data('negotiable') === 'true';
                        break;
                    case 'cheap':
                        show = $(this).data('price') < 100;
                        break;
                    case 'medium':
                        const price = $(this).data('price');
                        show = price >= 100 && price <= 500;
                        break;
                    case 'expensive':
                        show = $(this).data('price') > 500;
                        break;
                }

                if (show) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });

            $('.dropdown-toggle').dropdown('hide');
        });

        // Tri
        $('.sort-option').click(function(e) {
            e.preventDefault();
            const sortBy = $(this).data('sort');

            // Mettre à jour l'état actif
            $('.sort-option').removeClass('active');
            $(this).addClass('active');

            const container = $('#favorites-container');
            const items = container.find('.favorite-item').get();

            items.sort(function(a, b) {
                let aVal, bVal;

                switch(sortBy) {
                    case 'date-desc':
                        aVal = $(a).data('added');
                        bVal = $(b).data('added');
                        return bVal - aVal;
                    case 'date-asc':
                        aVal = $(a).data('added');
                        bVal = $(b).data('added');
                        return aVal - bVal;
                    case 'price-asc':
                        aVal = $(a).data('price');
                        bVal = $(b).data('price');
                        return aVal - bVal;
                    case 'price-desc':
                        aVal = $(a).data('price');
                        bVal = $(b).data('price');
                        return bVal - aVal;
                    case 'views-desc':
                        aVal = $(a).data('views');
                        bVal = $(b).data('views');
                        return bVal - aVal;
                    case 'title-asc':
                        aVal = $(a).data('title');
                        bVal = $(b).data('title');
                        return aVal.localeCompare(bVal);
                    default:
                        return 0;
                }
            });

            // Réorganiser les éléments
            $.each(items, function(idx, item) {
                container.append(item);
            });

            $('.dropdown-toggle').dropdown('hide');
        });

        // Retirer un favori
        $('.remove-favorite-btn, .remove-favorite-action').click(function(e) {
            e.preventDefault();
            currentRemoveUrl = $(this).data('url');
            const adSlug = $(this).data('ad-slug');

            if (currentRemoveUrl) {
                $('#confirmRemoveModal').modal('show');
            }
        });

        // Confirmation de suppression
        $('#confirmRemoveBtn').click(function() {
            if (!currentRemoveUrl) return;

            const $btn = $(this);
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> {% trans "Suppression..." %}');

            $.ajax({
                url: currentRemoveUrl,
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.status === 'success') {
                        // Trouver et supprimer l'élément du DOM
                        $('.favorite-item').each(function() {
                            if ($(this).data('id')) {
                                // Vous devrez stocker l'ID du favori dans data-id
                                // Pour l'instant, on fait une approche simplifiée
                                $(this).fadeOut(300, function() {
                                    $(this).remove();
                                    updateStats();
                                });
                            }
                        });

                        // Afficher un toast
                        showToast('{% trans "Annonce retirée des favoris" %}', 'success');

                        // Masquer la modal
                        $('#confirmRemoveModal').modal('hide');
                    }
                },
                error: function() {
                    showToast('{% trans "Une erreur est survenue" %}', 'error');
                },
                complete: function() {
                    $btn.prop('disabled', false).html('<i class="fas fa-heart-broken"></i> {% trans "Retirer" %}');
                }
            });
        });

        // Supprimer tous les favoris
        $('#clear-all-favorites').click(function() {
            if (!confirm('{% trans "Êtes-vous sûr de vouloir retirer toutes les annonces de vos favoris ? Cette action est irréversible." %}')) {
                return;
            }

            // Ici, vous devriez implémenter une vue pour supprimer tous les favoris
            // Pour l'instant, on simule avec des requêtes individuelles
            $('.remove-favorite-btn').each(function() {
                // Vous devrez implémenter la logique réelle
            });

            showToast('{% trans "Fonctionnalité à implémenter" %}', 'info');
        });

        // Exporter la liste
        $('#export-favorites').click(function() {
            const favoritesData = [];

            $('.favorite-item').each(function() {
                favoritesData.push({
                    title: $(this).find('.card-title a').text().trim(),
                    price: $(this).data('price'),
                    added: $(this).data('added'),
                    url: window.location.origin + $(this).find('.card-title a').attr('href')
                });
            });

            // Créer un fichier JSON téléchargeable
            const dataStr = JSON.stringify(favoritesData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = 'mes-favoris-ebi3.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            showToast('{% trans "Liste exportée avec succès" %}', 'success');
        });

        // Comparer les sélectionnés
        $('#compare-selected').click(function() {
            showToast('{% trans "Fonctionnalité à implémenter" %}', 'info');
        });

        // Mettre à jour les statistiques après suppression
        function updateStats() {
            const remaining = $('.favorite-item').length;

            // Mettre à jour le compteur dans l'interface
            $('.stat-card:first h2').text(remaining);

            // Si plus de favoris, afficher le message vide
            if (remaining === 0) {
                location.reload(); // Recharger pour afficher l'état vide
            }
        }

        // Fonction utilitaire pour afficher des toasts
        function showToast(message, type) {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            const container = $('#toast-container');
            if (container.length === 0) {
                $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
            }

            $('#toast-container').append(toastHtml);
            $('.toast').toast('show');

            // Supprimer après fermeture
            $('.toast').on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }
    });
</script>

<style>
    .favorite-card {
        transition: all 0.3s ease;
        position: relative;
    }

    .favorite-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .remove-favorite-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        z-index: 10;
    }

    .dropdown-menu {
        min-width: 220px;
    }

    .filter-option.active, .sort-option.active {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .stat-card {
        border-radius: 8px;
        transition: transform 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }

    .card-title a {
        color: inherit;
        text-decoration: none;
        transition: color 0.2s;
    }

    .card-title a:hover {
        color: #007bff;
    }

    @media (max-width: 768px) {
        .d-flex.flex-wrap.gap-2 {
            flex-direction: column;
        }

        .d-flex.flex-wrap.gap-2 .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }

    .text-muted.small i {
        width: 16px;
    }
</style>
{% endblock %}


========== ads/templates/ads/ad_update.html ==========
{# ~/ebi3/ads/templates/ads/ad_update.html #}
{% extends 'ads/base_ads.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Modifier l'annonce" %} - Ebi3{% endblock %}

{% block ads_content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="fas fa-edit"></i> {% trans "Modifier l'annonce" %}
                </h2>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            {{ form.title|as_crispy_field }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.category|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.condition|as_crispy_field }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            {{ form.description|as_crispy_field }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.price|as_crispy_field }}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.currency|as_crispy_field }}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.is_negotiable|as_crispy_field }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            {{ form.weight|as_crispy_field }}
                        </div>
                        <div class="col-md-3 mb-3">
                            {{ form.length|as_crispy_field }}
                        </div>
                        <div class="col-md-3 mb-3">
                            {{ form.width|as_crispy_field }}
                        </div>
                        <div class="col-md-3 mb-3">
                            {{ form.height|as_crispy_field }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">{% trans "Départ" %}</h5>
                                </div>
                                <div class="card-body">
                                    {{ form.country_from|as_crispy_field }}
                                    {{ form.city_from|as_crispy_field }}
                                    {{ form.address_from|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">{% trans "Destination" %}</h5>
                                </div>
                                <div class="card-body">
                                    {{ form.country_to|as_crispy_field }}
                                    {{ form.city_to|as_crispy_field }}
                                    {{ form.address_to|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.logistics_option|as_crispy_field }}
                        </div>
                        <div class="col-md-3 mb-3">
                            {{ form.available_from|as_crispy_field }}
                        </div>
                        <div class="col-md-3 mb-3">
                            {{ form.available_until|as_crispy_field }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.requires_insurance|as_crispy_field }}
                        </div>
                        <div class="col-md-4 mb-3" id="insurance-value-field"
                             style="{% if not form.requires_insurance.value %}display: none;{% endif %}">
                            {{ form.insurance_value|as_crispy_field }}
                        </div>
                        <div class="col-md-2 mb-3">
                            {{ form.fragile_item|as_crispy_field }}
                        </div>
                        <div class="col-md-2 mb-3">
                            {{ form.requires_packaging|as_crispy_field }}
                        </div>
                    </div>

                    <!-- Section Images -->
                    <h4 class="mt-4 mb-3">{% trans "Images" %}</h4>
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle"></i>
                        {% blocktrans %}
                            Vous pouvez télécharger jusqu'à <strong>3 images gratuitement</strong>.
                            Les images supplémentaires sont payantes (1€ par image).
                        {% endblocktrans %}
                    </div>

                    {{ image_formset.management_form }}

                    <div class="row">
                        {% for form in image_formset %}
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        {% if form.instance.image %}
                                            <div class="text-center mb-3">
                                                <img src="{{ form.instance.thumbnail.url|default:form.instance.image.url }}"
                                                     class="img-fluid rounded"
                                                     style="max-height: 150px;">
                                            </div>
                                        {% endif %}

                                        {{ form.id }}

                                        <div class="form-group">
                                            {{ form.image.label_tag }}
                                            {{ form.image }}
                                            {% if form.image.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.image.errors }}
                                                </div>
                                            {% endif %}
                                        </div>

                                        {{ form.caption|as_crispy_field }}

                                        <div class="row">
                                            <div class="col-md-6">
                                                {{ form.is_primary|as_crispy_field }}
                                            </div>
                                            <div class="col-md-6">
                                                {{ form.display_order|as_crispy_field }}
                                            </div>
                                        </div>

                                        {% if image_formset.can_delete %}
                                            <div class="form-check">
                                                {{ form.DELETE }}
                                                <label class="form-check-label text-danger" for="{{ form.DELETE.id_for_label }}">
                                                    {% trans "Supprimer cette image" %}
                                                </label>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'ads:ad_detail' slug=object.slug %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> {% trans "Annuler" %}
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {% trans "Enregistrer les modifications" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Afficher/masquer le champ de valeur d'assurance
        $('#id_requires_insurance').change(function() {
            if ($(this).is(':checked')) {
                $('#insurance-value-field').slideDown();
            } else {
                $('#insurance-value-field').slideUp();
            }
        });

        // Initialiser l'état
        if (!$('#id_requires_insurance').is(':checked')) {
            $('#insurance-value-field').hide();
        }
    });
</script>
{% endblock %}


========== ads/templates/ads/base_ads.html ==========
{# ~/ebi3/ads/templates/ads/base_ads.html #}
{% extends 'core/base.html' %}
{% load i18n %}

{% block extra_css %}
<style>
    /* Styles spécifiques aux annonces */
    .ad-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid #e0e0e0;
    }

    .ad-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .ad-image {
        height: 200px;
        object-fit: cover;
        width: 100%;
    }

    .ad-price {
        font-size: 1.5rem;
        font-weight: bold;
        color: #28a745;
    }

    .badge-logistics {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    .featured-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }

    .carousel-item img {
        height: 400px;
        object-fit: cover;
    }

    .condition-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    /* Pagination */
    .pagination .page-link {
        color: #667eea;
        border: 1px solid #dee2e6;
    }

    .pagination .page-item.active .page-link {
        background-color: #667eea;
        border-color: #667eea;
    }

    /* RTL support */
    [dir="rtl"] .featured-badge {
        right: auto;
        left: 10px;
    }

    [dir="rtl"] .carousel-control-prev {
        right: 0;
        left: auto;
    }

    [dir="rtl"] .carousel-control-next {
        left: 0;
        right: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    {% block ads_content %}{% endblock %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Scripts spécifiques aux annonces
    $(document).ready(function() {
        // Tooltips
        $('[data-bs-toggle="tooltip"]').tooltip();

        // Favoris AJAX
        $('.favorite-btn').click(function(e) {
            e.preventDefault();
            const btn = $(this);
            const url = btn.data('url');
            const adSlug = btn.data('ad-slug');

            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.status === 'success') {
                        if (data.action === 'added') {
                            btn.removeClass('btn-outline-danger').addClass('btn-danger');
                            btn.find('i').removeClass('far').addClass('fas');
                            btn.attr('title', '{% trans "Retirer des favoris" %}');
                        } else {
                            btn.removeClass('btn-danger').addClass('btn-outline-danger');
                            btn.find('i').removeClass('fas').addClass('far');
                            btn.attr('title', '{% trans "Ajouter aux favoris" %}');
                        }

                        // Mettre à jour le compteur si présent
                        const countSpan = $('#favorite-count-' + adSlug);
                        if (countSpan.length) {
                            countSpan.text(data.favorite_count);
                        }

                        // Afficher un toast
                        showToast(data.action === 'added' ?
                            '{% trans "Annonce ajoutée aux favoris" %}' :
                            '{% trans "Annonce retirée des favoris" %}',
                            'success'
                        );
                    }
                },
                error: function() {
                    showToast('{% trans "Une erreur est survenue" %}', 'error');
                }
            });
        });

        // Image gallery navigation
        $('.image-thumbnail').click(function() {
            const imgSrc = $(this).data('full');
            $('.main-image').attr('src', imgSrc);
            $('.image-thumbnail').removeClass('active');
            $(this).addClass('active');
        });

        // Helper function for toasts
        function showToast(message, type) {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            $('#toast-container').append(toastHtml);
            $('.toast').toast('show');

            // Remove toast after hiding
            $('.toast').on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }

        // Initialize toast container if not exists
        if ($('#toast-container').length === 0) {
            $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
        }
    });
</script>
{% endblock %}


========== ads/templates/ads/ad_delete.html ==========
{# ~/ebi3/ads/templates/ads/ad_delete.html #}
{% extends 'ads/base_ads.html' %}
{% load i18n %}

{% block title %}{% trans "Supprimer l'annonce" %} - Ebi3{% endblock %}

{% block ads_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm border-danger">
            <div class="card-header bg-danger text-white">
                <h2 class="mb-0">
                    <i class="fas fa-exclamation-triangle"></i> {% trans "Confirmer la suppression" %}
                </h2>
            </div>
            <div class="card-body">
                <p class="lead">{% trans "Êtes-vous sûr de vouloir supprimer cette annonce ?" %}</p>

                <!-- Aperçu de l'annonce -->
                <div class="card mb-4 border-secondary">
                    <div class="row g-0">
                        {% with ad.images.first as main_image %}
                            <div class="col-md-4">
                                {% if main_image %}
                                    <img src="{{ main_image.thumbnail.url|default:main_image.image.url }}"
                                         class="img-fluid rounded-start h-100 object-fit-cover"
                                         alt="{{ ad.title }}">
                                {% else %}
                                    <div class="bg-light d-flex align-items-center justify-content-center h-100">
                                        <i class="fas fa-image fa-3x text-muted"></i>
                                    </div>
                                {% endif %}
                            </div>
                        {% endwith %}
                        <div class="col-md-8">
                            <div class="card-body">
                                <h5 class="card-title">{{ ad.title }}</h5>

                                <div class="mb-2">
                                    <span class="badge {% if ad.condition == 'NEW' %}bg-success{% elif ad.condition == 'LIKE_NEW' %}bg-info{% elif ad.condition == 'GOOD' %}bg-primary{% else %}bg-secondary{% endif %}">
                                        {{ ad.get_condition_display }}
                                    </span>
                                    <span class="badge bg-warning ms-2">
                                        {{ ad.get_logistics_option_display }}
                                    </span>
                                </div>

                                <p class="card-text text-muted mb-2">
                                    <i class="fas fa-map-marker-alt"></i>
                                    {{ ad.city_from }} → {{ ad.city_to }}
                                </p>

                                <p class="card-text">
                                    <strong class="text-primary fs-4">{{ ad.get_price_with_currency }}</strong>
                                    {% if ad.is_negotiable %}
                                        <small class="text-muted">{% trans "(Négociable)" %}</small>
                                    {% endif %}
                                </p>

                                <p class="card-text small text-muted">
                                    <i class="fas fa-calendar"></i>
                                    {% trans "Créée le" %} {{ ad.created_at|date:"d/m/Y" }}
                                </p>

                                <div class="d-flex text-muted small">
                                    <div class="me-3">
                                        <i class="fas fa-eye"></i> {{ ad.view_count }} {% trans "vues" %}
                                    </div>
                                    <div class="me-3">
                                        <i class="fas fa-heart"></i> {{ ad.favorite_count }} {% trans "favoris" %}
                                    </div>
                                    <div>
                                        <i class="fas fa-comments"></i> {{ ad.inquiry_count }} {% trans "demandes" %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conséquences de la suppression -->
                <div class="alert alert-danger">
                    <h5 class="alert-heading">
                        <i class="fas fa-exclamation-circle"></i> {% trans "Attention" %}
                    </h5>
                    <ul class="mb-0">
                        <li>{% trans "Cette action est irréversible" %}</li>
                        <li>{% trans "Toutes les images associées seront supprimées" %}</li>
                        <li>{% trans "Toutes les vidéos associées seront supprimées" %}</li>
                        <li>{% trans "Les favoris de cette annonce seront perdus" %}</li>
                        <li>{% trans "Les statistiques de vues seront effacées" %}</li>
                        <li>{% trans "Les signalements associés seront supprimés" %}</li>
                    </ul>
                </div>

                <!-- Formulaire de confirmation -->
                <form method="post">
                    {% csrf_token %}

                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                        <label class="form-check-label" for="confirmDelete">
                            {% trans "Je comprends les conséquences et je confirme la suppression définitive" %}
                        </label>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'ads:ad_detail' slug=ad.slug %}" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-arrow-left"></i> {% trans "Annuler et retourner" %}
                        </a>

                        <button type="submit" class="btn btn-danger btn-lg" id="deleteBtn" disabled>
                            <i class="fas fa-trash-alt"></i> {% trans "Supprimer définitivement" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Activer/désactiver le bouton de suppression selon la confirmation
        $('#confirmDelete').change(function() {
            $('#deleteBtn').prop('disabled', !$(this).is(':checked'));
        });

        // Confirmation supplémentaire
        $('#deleteBtn').click(function(e) {
            if (!confirm('{% trans "Êtes-vous absolument certain de vouloir supprimer cette annonce ? Cette action ne peut pas être annulée." %}')) {
                e.preventDefault();
            }
        });

        // Message de prévention de fermeture
        let formChanged = false;
        $('form :input').change(function() {
            formChanged = true;
        });

        $(window).on('beforeunload', function() {
            if (formChanged) {
                return '{% trans "Vous avez des modifications non enregistrées. Êtes-vous sûr de vouloir quitter ?" %}';
            }
        });

        $('form').submit(function() {
            $(window).off('beforeunload');
        });
    });
</script>

<style>
    .object-fit-cover {
        object-fit: cover;
    }

    .card.border-danger {
        border-width: 2px;
    }

    #deleteBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .alert-danger ul {
        padding-left: 1.5rem;
    }

    .alert-danger li {
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}


========== ads/templates/ads/category_detail.html ==========
{# ~/ebi3/ads/templates/ads/category_detail.html #}
{% extends 'ads/base_ads.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{{ category.name }} - {% trans "Catégorie" %} - Ebi3{% endblock %}

{% block meta_description %}{{ category.meta_description|default:category.description|truncatechars:160 }}{% endblock %}
{% block meta_keywords %}{{ category.meta_keywords|default:category.name }}{% endblock %}

{% block ads_content %}
<div class="container-fluid">
    <!-- En-tête de la catégorie -->
    <div class="row mb-4">
        <div class="col-12">
            <!-- Fil d'Ariane -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'ads:category_list' %}" class="text-decoration-none">
                            <i class="fas fa-list"></i> {% trans "Catégories" %}
                        </a>
                    </li>
                    {% for ancestor in category.get_ancestors %}
                        <li class="breadcrumb-item">
                            <a href="{{ ancestor.get_absolute_url }}" class="text-decoration-none">
                                {{ ancestor.name }}
                            </a>
                        </li>
                    {% endfor %}
                    <li class="breadcrumb-item active" aria-current="page">
                        <strong>{{ category.name }}</strong>
                    </li>
                </ol>
            </nav>

            <!-- En-tête principal -->
            <div class="card border-primary shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                {% if category.icon %}
                                    <div class="me-3 display-4">
                                        <i class="{{ category.icon }}"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <h1 class="mb-1">{{ category.name }}</h1>
                                    {% if category.description %}
                                        <p class="lead mb-0">{{ category.description }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex flex-column align-items-end">
                                <span class="badge bg-light text-primary fs-5 mb-2">
                                    {{ total_ads }} {% trans "annonces" %}
                                </span>
                                {% if category.parent %}
                                    <a href="{{ category.parent.get_absolute_url }}" class="btn btn-sm btn-outline-light">
                                        <i class="fas fa-arrow-up"></i> {% trans "Catégorie parente" %}
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistiques rapides -->
                <div class="card-body bg-light">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h2 text-primary mb-0">{{ total_ads|default:0 }}</div>
                                <small class="text-muted">{% trans "Annonces totales" %}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h2 text-success mb-0">{{ avg_price|default:"--" }} €</div>
                                <small class="text-muted">{% trans "Prix moyen" %}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h2 text-info mb-0">{{ active_sellers|default:0 }}</div>
                                <small class="text-muted">{% trans "Vendeurs actifs" %}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h2 text-warning mb-0">{{ featured_ads|default:0 }}</div>
                                <small class="text-muted">{% trans "En vedette" %}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenu principal -->
    <div class="row">
        <!-- Colonne gauche - Sous-catégories et filtres -->
        <div class="col-lg-3 mb-4">
            <!-- Sous-catégories -->
            {% if subcategories %}
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-sitemap"></i> {% trans "Sous-catégories" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for subcat in subcategories %}
                                <a href="{{ subcat.get_absolute_url }}"
                                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        {% if subcat.icon %}
                                            <i class="{{ subcat.icon }} me-2 text-muted"></i>
                                        {% endif %}
                                        {{ subcat.name }}
                                    </div>
                                    <span class="badge bg-primary rounded-pill">{{ subcat.ad_count }}</span>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Filtres -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i> {% trans "Filtres" %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" id="category-filters">
                        {{ search_form|crispy }}

                        <!-- Filtres supplémentaires -->
                        <div class="mb-3">
                            <label class="form-label">{% trans "État" %}</label>
                            <select class="form-select" name="condition">
                                <option value="">{% trans "Tous" %}</option>
                                <option value="NEW">{% trans "Neuf" %}</option>
                                <option value="LIKE_NEW">{% trans "Comme neuf" %}</option>
                                <option value="GOOD">{% trans "Bon état" %}</option>
                                <option value="FAIR">{% trans "État correct" %}</option>
                                <option value="POOR">{% trans "Mauvais état" %}</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">{% trans "Option logistique" %}</label>
                            <select class="form-select" name="logistics_option">
                                <option value="">{% trans "Toutes" %}</option>
                                <option value="P2P_DIRECT">{% trans "Vente directe (P2P)" %}</option>
                                <option value="WITH_CARRIER">{% trans "Avec transporteur" %}</option>
                                <option value="WITH_EXPAT_CARRIER">{% trans "Avec expatrié-transporteur" %}</option>
                            </select>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="negotiable_only" name="negotiable_only">
                            <label class="form-check-label" for="negotiable_only">
                                {% trans "Prix négociable seulement" %}
                            </label>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="featured_only" name="featured_only">
                            <label class="form-check-label" for="featured_only">
                                {% trans "Annonces en vedette seulement" %}
                            </label>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter"></i> {% trans "Filtrer" %}
                            </button>
                            <a href="{% url 'ads:category_detail' slug=category.slug %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> {% trans "Effacer" %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Informations sur la catégorie -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">{% trans "À propos de cette catégorie" %}</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <i class="fas fa-calendar text-muted me-2"></i>
                            <strong>{% trans "Créée :" %}</strong>
                            {{ category.created_at|date:"d/m/Y" }}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-sync-alt text-muted me-2"></i>
                            <strong>{% trans "Mise à jour :" %}</strong>
                            {{ category.updated_at|timesince }}
                        </li>
                        {% if category.requires_weight %}
                            <li class="mb-2">
                                <i class="fas fa-weight text-muted me-2"></i>
                                <strong>{% trans "Poids requis :" %}</strong>
                                {% trans "Oui" %}
                            </li>
                        {% endif %}
                        {% if category.requires_dimensions %}
                            <li class="mb-2">
                                <i class="fas fa-ruler-combined text-muted me-2"></i>
                                <strong>{% trans "Dimensions requises :" %}</strong>
                                {% trans "Oui" %}
                            </li>
                        {% endif %}
                        <li class="mb-0">
                            <i class="fas fa-eye text-muted me-2"></i>
                            <strong>{% trans "Statut :" %}</strong>
                            {% if category.is_active %}
                                <span class="badge bg-success">{% trans "Active" %}</span>
                            {% else %}
                                <span class="badge bg-secondary">{% trans "Inactive" %}</span>
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Colonne droite - Annonces -->
        <div class="col-lg-9">
            <!-- Barre de contrôle -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <span class="text-muted">
                                {% blocktranslate count count=ads.paginator.count %}
                                    {{ count }} annonce trouvée
                                {% plural %}
                                    {{ count }} annonces trouvées
                                {% endblocktranslate %}
                            </span>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="dropdown d-inline-block me-2">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown">
                                    <i class="fas fa-sort"></i> {% trans "Trier par" %}
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="?sort=-created_at">{% trans "Plus récent" %}</a></li>
                                    <li><a class="dropdown-item" href="?sort=price">{% trans "Prix croissant" %}</a></li>
                                    <li><a class="dropdown-item" href="?sort=-price">{% trans "Prix décroissant" %}</a></li>
                                    <li><a class="dropdown-item" href="?sort=-view_count">{% trans "Plus vues" %}</a></li>
                                    <li><a class="dropdown-item" href="?sort=-favorite_count">{% trans "Plus favorites" %}</a></li>
                                </ul>
                            </div>

                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary active" id="view-grid">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="view-list">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Annonces -->
            {% if ads %}
                <!-- Vue Grille (défaut) -->
                <div class="row" id="ads-grid-view">
                    {% for ad in ads %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            {% include 'ads/partials/ad_card.html' with ad=ad %}
                        </div>
                    {% endfor %}
                </div>

                <!-- Vue Liste (cachée) -->
                <div class="d-none" id="ads-list-view">
                    {% for ad in ads %}
                        <div class="card mb-3">
                            <div class="row g-0">
                                <div class="col-md-4">
                                    {% with ad.images.first as main_image %}
                                        {% if main_image %}
                                            <img src="{{ main_image.thumbnail.url|default:main_image.image.url }}"
                                                 class="img-fluid rounded-start h-100"
                                                 style="object-fit: cover; min-height: 200px;"
                                                 alt="{{ ad.title }}">
                                        {% else %}
                                            <div class="bg-light d-flex align-items-center justify-content-center h-100">
                                                <i class="fas fa-image fa-3x text-muted"></i>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="col-md-8">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <h5 class="card-title">
                                                <a href="{{ ad.get_absolute_url }}" class="text-decoration-none">
                                                    {{ ad.title }}
                                                </a>
                                            </h5>
                                            <div class="text-end">
                                                <div class="h4 text-primary mb-0">
                                                    {{ ad.get_price_with_currency }}
                                                </div>
                                                {% if ad.is_negotiable %}
                                                    <small class="text-muted">{% trans "(Négociable)" %}</small>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="mb-2">
                                            <span class="badge bg-info me-2">{{ ad.get_condition_display }}</span>
                                            <span class="badge bg-secondary">{{ ad.get_logistics_option_display }}</span>
                                            {% if ad.is_featured %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-star"></i> {% trans "En vedette" %}
                                                </span>
                                            {% endif %}
                                        </div>

                                        <p class="card-text text-muted mb-2">
                                            <i class="fas fa-map-marker-alt"></i>
                                            {{ ad.city_from }} → {{ ad.city_to }}
                                        </p>

                                        <p class="card-text mb-3">
                                            {{ ad.description|truncatechars:150 }}
                                        </p>

                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <small class="text-muted">
                                                    <i class="fas fa-user"></i>
                                                    <a href="{% url 'users:profile' ad.seller.username %}"
                                                       class="text-decoration-none">
                                                        {{ ad.seller.username }}
                                                    </a>
                                                </small>
                                            </div>
                                            <div class="text-muted small">
                                                <i class="fas fa-eye me-1"></i> {{ ad.view_count }}
                                                <i class="fas fa-heart ms-3 me-1"></i> {{ ad.favorite_count }}
                                                <i class="fas fa-clock ms-3 me-1"></i> {{ ad.created_at|timesince }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if ads.has_other_pages %}
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if ads.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ ads.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            {% endif %}

                            {% for num in ads.paginator.page_range %}
                                {% if ads.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > ads.number|add:'-3' and num < ads.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            {{ num }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if ads.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ ads.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}

            {% else %}
                <!-- Aucune annonce -->
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            {% if category.icon %}
                                <i class="{{ category.icon }} fa-4x text-muted"></i>
                            {% else %}
                                <i class="fas fa-folder-open fa-4x text-muted"></i>
                            {% endif %}
                        </div>
                        <h3>{% trans "Aucune annonce dans cette catégorie" %}</h3>
                        <p class="text-muted mb-4">
                            {% trans "Il n'y a actuellement aucune annonce dans cette catégorie." %}
                            {% trans "Soyez le premier à publier une annonce !" %}
                        </p>

                        {% if user.is_authenticated and user.role == 'SELLER' %}
                            <a href="{% url 'ads:ad_create' %}?category={{ category.id }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> {% trans "Créer une annonce" %}
                            </a>
                        {% else %}
                            <a href="{% url 'ads:ad_list' %}" class="btn btn-outline-primary">
                                <i class="fas fa-search"></i> {% trans "Voir toutes les annonces" %}
                            </a>
                        {% endif %}

                        {% if subcategories %}
                            <div class="mt-4">
                                <p class="text-muted">{% trans "Ou essayez une sous-catégorie :" %}</p>
                                <div class="d-flex flex-wrap justify-content-center gap-2">
                                    {% for subcat in subcategories|slice:":5" %}
                                        <a href="{{ subcat.get_absolute_url }}" class="btn btn-sm btn-outline-secondary">
                                            {{ subcat.name }}
                                        </a>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Description étendue (SEO) -->
            {% if category.description and category.description|length > 200 %}
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">{% trans "Description détaillée" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="category-description">
                            {{ category.description|linebreaks }}
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Annonces similaires (catégories connexes) -->
            {% if related_categories %}
                <div class="row mt-5">
                    <div class="col-12">
                        <h4 class="mb-4">
                            <i class="fas fa-random"></i> {% trans "Catégories connexes" %}
                        </h4>
                        <div class="row g-3">
                            {% for rel_cat in related_categories|slice:":6" %}
                                <div class="col-md-4 col-lg-2">
                                    <a href="{{ rel_cat.get_absolute_url }}" class="text-decoration-none">
                                        <div class="card border-0 shadow-sm h-100 text-center hover-lift">
                                            <div class="card-body p-3">
                                                {% if rel_cat.icon %}
                                                    <div class="mb-2">
                                                        <i class="{{ rel_cat.icon }} fa-2x text-primary"></i>
                                                    </div>
                                                {% endif %}
                                                <h6 class="card-title mb-1">{{ rel_cat.name }}</h6>
                                                <span class="badge bg-secondary">{{ rel_cat.ad_count }}</span>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Basculer entre vue grille et liste
        $('#view-grid').click(function() {
            $(this).addClass('active');
            $('#view-list').removeClass('active');
            $('#ads-grid-view').removeClass('d-none');
            $('#ads-list-view').addClass('d-none');

            // Sauvegarder la préférence
            localStorage.setItem('category-view-mode', 'grid');
        });

        $('#view-list').click(function() {
            $(this).addClass('active');
            $('#view-grid').removeClass('active');
            $('#ads-list-view').removeClass('d-none');
            $('#ads-grid-view').addClass('d-none');

            // Sauvegarder la préférence
            localStorage.setItem('category-view-mode', 'list');
        });

        // Restaurer la préférence de vue
        const savedViewMode = localStorage.getItem('category-view-mode');
        if (savedViewMode === 'list') {
            $('#view-list').click();
        }

        // Gestion des filtres
        $('#category-filters').submit(function() {
            // Ajouter un indicateur de chargement
            $('#ads-grid-view, #ads-list-view').html(`
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{% trans "Chargement..." %}</span>
                    </div>
                    <p class="mt-3 text-muted">{% trans "Application des filtres..." %}</p>
                </div>
            `);
        });

        // Mise à jour du nombre de résultats
        function updateResultCount() {
            const visibleCount = $('#ads-grid-view .col-md-6').length;
            $('.result-count').text(visibleCount);
        }

        // Initialiser les tooltips
        $('[data-bs-toggle="tooltip"]').tooltip();

        // Animation au survol
        $('.hover-lift').hover(
            function() {
                $(this).addClass('shadow');
                $(this).css('transform', 'translateY(-3px)');
            },
            function() {
                $(this).removeClass('shadow');
                $(this).css('transform', 'translateY(0)');
            }
        );

        // Pré-remplir les filtres depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.forEach((value, key) => {
            const element = $(`[name="${key}"]`);
            if (element.length) {
                if (element.attr('type') === 'checkbox') {
                    element.prop('checked', true);
                } else {
                    element.val(value);
                }
            }
        });

        // Auto-submit sur changement de certains filtres
        $('select[name="condition"], select[name="logistics_option"]').change(function() {
            $('#category-filters').submit();
        });
    });
</script>

<style>
    .breadcrumb {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 0.75rem 1rem;
    }

    .breadcrumb-item a {
        color: #6c757d;
        transition: color 0.2s;
    }

    .breadcrumb-item a:hover {
        color: #007bff;
        text-decoration: underline;
    }

    .card.border-primary {
        border-width: 2px;
    }

    .card-header.bg-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }

    .card-header.bg-info {
        background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
    }

    .list-group-item {
        border: none;
        padding: 0.75rem 0;
    }

    .list-group-item:hover {
        background-color: #f8f9fa;
    }

    .btn-group .btn.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .hover-lift {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
    }

    .hover-lift:hover {
        border-color: #007bff;
        cursor: pointer;
    }

    .category-description {
        line-height: 1.8;
        font-size: 1.05rem;
    }

    .category-description img {
        max-width: 100%;
        height: auto;
        border-radius: 0.375rem;
    }

    @media (max-width: 768px) {
        .card-header h1 {
            font-size: 1.5rem;
        }

        .lead {
            font-size: 1rem;
        }

        .breadcrumb {
            font-size: 0.875rem;
            padding: 0.5rem;
        }

        .btn-group {
            margin-top: 1rem;
            width: 100%;
        }

        .btn-group .btn {
            flex: 1;
        }
    }

    .display-4 {
        font-size: 3.5rem;
    }

    .badge.bg-light.text-primary {
        font-weight: bold;
        padding: 0.5rem 1rem;
    }

    #ads-list-view .card {
        transition: all 0.3s ease;
    }

    #ads-list-view .card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
</style>
{% endblock %}


========== ads/templates/ads/ad_create.html ==========
{# ~/ebi3/ads/templates/ads/ad_create.html #}
{% extends 'ads/base_ads.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Créer une annonce" %} - Ebi3{% endblock %}

{% block ads_content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="fas fa-plus-circle"></i> {% trans "Créer une nouvelle annonce" %}
                </h2>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="ad-create-form" novalidate>
                    {% csrf_token %}

                    <!-- Messages d'erreur Django -->
                    {% if form.errors %}
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle"></i> {% trans "Veuillez corriger les erreurs ci-dessous" %}</h5>
                            <ul class="mb-0">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>
                                            <strong>
                                                {% if field == 'main_category' %}
                                                    {% trans "Catégorie principale" %}
                                                {% elif field == 'sub_category' %}
                                                    {% trans "Sous-catégorie" %}
                                                {% elif field == 'category' %}
                                                    {% trans "Catégorie" %}
                                                {% else %}
                                                    {{ field }}
                                                {% endif %}:
                                            </strong> {{ error }}
                                        </li>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- SECTION 1: Informations de base -->
                    <div class="section mb-5">
                        <h4 class="mb-4 border-bottom pb-2">
                            <span class="badge bg-primary me-2">1</span>
                            {% trans "Informations de base" %}
                        </h4>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                {{ form.title|as_crispy_field }}
                                <small class="form-text text-muted">
                                    {% trans "Soyez clair et concis. Ex: 'Canapé en cuir marron 3 places'" %}
                                </small>
                            </div>
                        </div>

                        <!-- SECTION CATÉGORIE HIÉRARCHIQUE -->
                        <div class="category-hierarchy-section mb-4">
                            <h5 class="mb-3">{% trans "Catégorie de l'annonce" %}</h5>

                            <!-- Catégorie principale (obligatoire) -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="id_main_category" class="form-label">
                                            {% trans "Catégorie principale *" %}
                                            {% if form.main_category.errors %}
                                                <span class="text-danger">*</span>
                                            {% endif %}
                                        </label>
                                        <select class="form-control {% if form.main_category.errors %}is-invalid{% endif %}"
                                                id="id_main_category" name="main_category" required>
                                            <option value="">{% trans "Sélectionnez une catégorie principale" %}</option>
                                            {% for category in form.main_category.field.queryset %}
                                                <option value="{{ category.id }}"
                                                    {% if form.main_category.value|stringformat:"s" == category.id|stringformat:"s" %}selected{% endif %}>
                                                    {{ category.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        {% if form.main_category.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.main_category.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            {% trans "Sélectionnez la catégorie principale de votre annonce" %}
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Sous-catégorie (optionnelle) -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="id_sub_category" class="form-label">
                                            {% trans "Sous-catégorie" %}
                                        </label>
                                        <select class="form-control" id="id_sub_category" name="sub_category" disabled>
                                            <option value="">{% trans "Sélectionnez une sous-catégorie (optionnel)" %}</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            {% trans "Optionnel : Sélectionnez une sous-catégorie plus spécifique" %}
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Champ caché pour la catégorie finale -->
                            <input type="hidden" id="id_category" name="category" value="{{ form.category.value|default:'' }}">

                            <!-- Information -->
                            <div class="alert alert-info mt-2">
                                <small>
                                    <i class="fas fa-info-circle"></i>
                                    {% trans "La catégorie principale est obligatoire pour faciliter la recherche de votre annonce." %}
                                </small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.condition|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.weight|as_crispy_field }}
                            </div>
                            <div class="col-md-2 mb-3">
                                {{ form.length|as_crispy_field }}
                            </div>
                            <div class="col-md-2 mb-3">
                                {{ form.width|as_crispy_field }}
                            </div>
                            <div class="col-md-2 mb-3">
                                {{ form.height|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 2: Description et prix -->
                    <div class="section mb-5">
                        <h4 class="mb-4 border-bottom pb-2">
                            <span class="badge bg-primary me-2">2</span>
                            {% trans "Description et prix" %}
                        </h4>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                {{ form.description|as_crispy_field }}
                                <small class="form-text text-muted">
                                    {% trans "Décrivez votre objet en détail. Soyez précis sur son état, ses dimensions, son histoire, etc." %}
                                </small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.price|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.currency|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check mt-4 pt-2">
                                    {{ form.is_negotiable }}
                                    <label class="form-check-label" for="{{ form.is_negotiable.id_for_label }}">
                                        {% trans "Prix négociable" %}
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.available_from|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.available_until|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 3: Logistique -->
                    <div class="section mb-5">
                        <h4 class="mb-4 border-bottom pb-2">
                            <span class="badge bg-primary me-2">3</span>
                            {% trans "Informations logistiques" %}
                        </h4>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                {{ form.logistics_option|as_crispy_field }}
                                <div class="alert alert-info mt-2">
                                    <small>
                                        <strong>{% trans "Vente directe (P2P):" %}</strong> {% trans "Vous rencontrez l'acheteur directement" %}<br>
                                        <strong>{% trans "Avec transporteur:" %}</strong> {% trans "Utilisation d'un service de transport" %}<br>
                                        <strong>{% trans "Avec expatrié-transporteur:" %}</strong> {% trans "Personne voyageant qui peut transporter" %}
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4 border-info">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-map-marker-alt"></i> {% trans "Point de départ" %}
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.country_from|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.city_from|as_crispy_field }}
                                    </div>
                                </div>
                                {{ form.address_from|as_crispy_field }}
                            </div>
                        </div>

                        <div class="card mb-4 border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-flag-checkered"></i> {% trans "Point d'arrivée" %}
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.country_to|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.city_to|as_crispy_field }}
                                    </div>
                                </div>
                                {{ form.address_to|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    {{ form.requires_insurance }}
                                    <label class="form-check-label" for="{{ form.requires_insurance.id_for_label }}">
                                        {% trans "Assurance requise" %}
                                    </label>
                                </div>
                                <div id="insurance-value-field" class="mt-2" style="display: none;">
                                    {{ form.insurance_value|as_crispy_field }}
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    {{ form.fragile_item }}
                                    <label class="form-check-label" for="{{ form.fragile_item.id_for_label }}">
                                        {% trans "Objet fragile" %}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="form-check">
                                    {{ form.requires_packaging }}
                                    <label class="form-check-label" for="{{ form.requires_packaging.id_for_label }}">
                                        {% trans "Emballage requis" %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 4: Images -->
                    <div class="section mb-5">
                        <h4 class="mb-4 border-bottom pb-2">
                            <span class="badge bg-primary me-2">4</span>
                            {% trans "Images" %}
                        </h4>

                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle"></i>
                            {% blocktrans %}
                                Vous pouvez télécharger jusqu'à <strong>3 images gratuitement</strong>.
                                Les images supplémentaires sont payantes (1€ par image).
                            {% endblocktrans %}
                        </div>

                        <!-- Formset pour les images -->
                        <div id="image-forms">
                            {{ image_formset.management_form }}

                            <div class="row">
                                {% for form in image_formset %}
                                    <div class="col-md-6 mb-4">
                                        <div class="card h-100 image-form" data-index="{{ forloop.counter0 }}">
                                            <div class="card-body">
                                                <h6 class="card-title border-bottom pb-2 mb-3">
                                                    {% if forloop.first %}
                                                        <strong>{% trans "Image principale" %}</strong>
                                                    {% else %}
                                                        {% trans "Image complémentaire" %} #{{ forloop.counter }}
                                                    {% endif %}
                                                </h6>

                                                <div class="form-group mb-3">
                                                    <label for="{{ form.image.id_for_label }}" class="form-label">
                                                        {% trans "Fichier image" %}
                                                    </label>
                                                    {{ form.image }}
                                                    {% if form.image.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {{ form.image.errors }}
                                                        </div>
                                                    {% endif %}
                                                    <div class="image-preview-container mt-2" id="preview-{{ forloop.counter0 }}">
                                                        <!-- Prévisualisation ici -->
                                                    </div>
                                                </div>

                                                {{ form.caption|as_crispy_field }}

                                                <div class="row">
                                                    <div class="col-md-6">
                                                        {% if forloop.first %}
                                                            <div class="form-check">
                                                                <input type="checkbox" class="form-check-input"
                                                                       id="{{ form.is_primary.id_for_label }}"
                                                                       name="{{ form.is_primary.html_name }}"
                                                                       checked disabled>
                                                                <label class="form-check-label" for="{{ form.is_primary.id_for_label }}">
                                                                    {% trans "Image principale" %}
                                                                </label>
                                                            </div>
                                                            <input type="hidden" name="{{ form.is_primary.html_name }}" value="on">
                                                        {% else %}
                                                            <div class="form-check">
                                                                {{ form.is_primary }}
                                                                <label class="form-check-label" for="{{ form.is_primary.id_for_label }}">
                                                                    {% trans "Image principale" %}
                                                                </label>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-6">
                                                        {{ form.display_order|as_crispy_field }}
                                                    </div>
                                                </div>

                                                {% if image_formset.can_delete and not forloop.first %}
                                                    <div class="form-check mt-3">
                                                        {{ form.DELETE }}
                                                        <label class="form-check-label text-danger" for="{{ form.DELETE.id_for_label }}">
                                                            {% trans "Supprimer cette image" %}
                                                        </label>
                                                    </div>
                                                {% endif %}

                                                {% for hidden in form.hidden_fields %}
                                                    {{ hidden }}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="text-center mb-4">
                            <button type="button" id="add-image-btn" class="btn btn-outline-primary">
                                <i class="fas fa-plus"></i> {% trans "Ajouter une image" %}
                            </button>
                            <small class="d-block text-muted mt-2">
                                {% trans "Formats acceptés: JPG, PNG, WebP. Taille max: 10MB par image." %}
                            </small>
                        </div>
                    </div>

                    <!-- Bouton de soumission -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success btn-lg px-5">
                            <i class="fas fa-check"></i> {% trans "Publier l'annonce" %}
                        </button>
                        <a href="{% url 'ads:ad_list' %}" class="btn btn-outline-secondary btn-lg ms-3">
                            <i class="fas fa-times"></i> {% trans "Annuler" %}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .section {
        background-color: #fff;
        border-radius: 0.5rem;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }

    .category-hierarchy-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .image-form {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
    }

    .image-form:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.1);
    }

    .image-preview-container {
        min-height: 100px;
        border: 1px dashed #dee2e6;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .image-preview {
        max-width: 100%;
        max-height: 150px;
        object-fit: contain;
    }

    .form-control.is-invalid {
        border-color: #dc3545;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .required label:after {
        content: " *";
        color: #dc3545;
    }

    .category-loading {
        display: none;
        color: #6c757d;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('Ad Create Form initialized - Catégorie hiérarchique');

    // URL pour récupérer les sous-catégories
    const SUBCATEGORIES_URL = "{% url 'ads:get_categories' %}";

    // CSRF token pour les requêtes AJAX
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // ============================================
    // GESTION DE LA CATÉGORIE HIÉRARCHIQUE
    // ============================================

    // Charger les sous-catégories pour la catégorie principale sélectionnée
    function loadSubCategories(mainCategoryId) {
        if (!mainCategoryId) {
            $('#id_sub_category').prop('disabled', true).empty();
            $('#id_sub_category').append($('<option>', {
                value: '',
                text: '{% trans "Sélectionnez d\'abord une catégorie principale" %}'
            }));
            updateCategoryField();
            return;
        }

        // Activer et réinitialiser le champ sous-catégorie
        const $subCategorySelect = $('#id_sub_category');
        $subCategorySelect.prop('disabled', true).empty();

        // Ajouter une option par défaut
        $subCategorySelect.append($('<option>', {
            value: '',
            text: '{% trans "Chargement des sous-catégories..." %}'
        }));

        // Récupérer les sous-catégories via AJAX
        $.ajax({
            url: SUBCATEGORIES_URL,
            type: 'GET',
            data: {
                'parent_id': mainCategoryId,
                'level': 'sub'
            },
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(data) {
                console.log('Sous-catégories reçues:', data);

                $subCategorySelect.empty();

                // Ajouter une option par défaut
                $subCategorySelect.append($('<option>', {
                    value: '',
                    text: '{% trans "Sélectionnez une sous-catégorie (optionnel)" %}'
                }));

                // Ajouter chaque sous-catégorie au select
                if (data.categories && data.categories.length > 0) {
                    $.each(data.categories, function(index, category) {
                        $subCategorySelect.append($('<option>', {
                            value: category.id,
                            text: category.name
                        }));
                    });

                    // Activer le champ
                    $subCategorySelect.prop('disabled', false);
                } else {
                    $subCategorySelect.append($('<option>', {
                        value: '',
                        text: '{% trans "Aucune sous-catégorie disponible" %}'
                    }));
                    $subCategorySelect.prop('disabled', true);
                }

                // Mettre à jour le champ caché de catégorie
                updateCategoryField();
            },
            error: function(xhr, status, error) {
                console.error('Erreur lors du chargement des sous-catégories:', error);
                $subCategorySelect.empty();
                $subCategorySelect.append($('<option>', {
                    value: '',
                    text: '{% trans "Erreur de chargement" %}'
                }));
            }
        });
    }

    // Quand la catégorie principale change
    $('#id_main_category').change(function() {
        const mainCategoryId = $(this).val();
        console.log('Catégorie principale sélectionnée:', mainCategoryId);

        loadSubCategories(mainCategoryId);
    });

    // Quand la sous-catégorie change
    $('#id_sub_category').change(function() {
        console.log('Sous-catégorie sélectionnée:', $(this).val());
        updateCategoryField();
    });

    // Fonction pour mettre à jour le champ caché de catégorie
    function updateCategoryField() {
        const mainCategoryId = $('#id_main_category').val();
        const subCategoryId = $('#id_sub_category').val();
        const $categoryHidden = $('#id_category');

        // Utiliser la sous-catégorie si sélectionnée, sinon la catégorie principale
        if (subCategoryId && subCategoryId !== '') {
            $categoryHidden.val(subCategoryId);
            console.log('Catégorie finale (sous-catégorie):', subCategoryId);
        } else if (mainCategoryId && mainCategoryId !== '') {
            $categoryHidden.val(mainCategoryId);
            console.log('Catégorie finale (principale):', mainCategoryId);
        } else {
            $categoryHidden.val('');
            console.log('Aucune catégorie sélectionnée');
        }
    }

    // Initialiser le champ caché
    updateCategoryField();

    // Si une catégorie principale est déjà sélectionnée (en cas d'erreur de validation)
    const initialMainCategory = $('#id_main_category').val();
    if (initialMainCategory) {
        loadSubCategories(initialMainCategory);
    }

    // ============================================
    // AUTRES FONCTIONNALITÉS
    // ============================================

    // Gestion de l'assurance
    $('#{{ form.requires_insurance.id_for_label }}').change(function() {
        if ($(this).is(':checked')) {
            $('#insurance-value-field').show();
        } else {
            $('#insurance-value-field').hide();
        }
    }).trigger('change');

    // Gestion des images
    $('#add-image-btn').click(function() {
        addImageForm();
    });

    // Prévisualisation des images
    $(document).on('change', 'input[type="file"]', function() {
        previewImage(this);
    });

    // ============================================
    // VALIDATION DU FORMULAIRE
    // ============================================

    // Validation du formulaire
    $('#ad-create-form').submit(function(e) {
        console.log('Tentative de soumission du formulaire');

        // Valider les champs requis
        if (!validateForm()) {
            e.preventDefault();
            showToast('{% trans "Veuillez corriger les erreurs dans le formulaire avant de soumettre." %}', 'error');
            return false;
        }

        // Vérifier qu'au moins une image est primaire (si des images sont uploadées)
        const hasPrimary = $('[id$="-is_primary"]:checked').length > 0;
        const hasImages = $('input[type="file"]').length > 0;

        if (hasImages && !hasPrimary) {
            e.preventDefault();
            showToast('{% trans "Veuillez sélectionner au moins une image comme image principale." %}', 'error');
            return false;
        }

        console.log('Validation du formulaire réussie, soumission...');
        return true;
    });

    function validateForm() {
        console.log('Validation du formulaire en cours...');
        let isValid = true;

        // Valider la catégorie principale
        const mainCategoryField = $('#id_main_category');
        if (!mainCategoryField.val()) {
            markFieldInvalid(mainCategoryField, '{% trans "La catégorie principale est requise" %}');
            isValid = false;
        } else {
            markFieldValid(mainCategoryField);
        }

        // Valider les autres champs requis
        $('[required]').each(function() {
            const $field = $(this);

            // Ne pas valider à nouveau la catégorie principale
            if ($field.attr('id') === 'id_main_category') {
                return true;
            }

            // Ignorer les champs de formulaire d'image cachés
            if ($field.closest('.image-form').length && !$field.closest('.image-form').is(':visible')) {
                return true;
            }

            const fieldValue = $field.val() ? $field.val().trim() : '';
            const isSelect = $field.is('select');
            const isCheckbox = $field.is(':checkbox');
            const isRadio = $field.is(':radio');
            const isFile = $field.is('input[type="file"]');

            let fieldValid = true;

            if (isSelect && !fieldValue) {
                fieldValid = false;
            } else if (isCheckbox && !$field.is(':checked')) {
                fieldValid = false;
            } else if (isRadio && !$field.closest('fieldset').find('input[type="radio"]:checked').length) {
                fieldValid = false;
            } else if (!isCheckbox && !isRadio && !isFile && !fieldValue) {
                fieldValid = false;
            }

            if (!fieldValid) {
                markFieldInvalid($field, '{% trans "Ce champ est requis" %}');
                isValid = false;
            } else {
                markFieldValid($field);
            }
        });

        // Validation spécifique pour le prix (si renseigné)
        const priceField = $('#{{ form.price.id_for_label }}');
        if (priceField.length && priceField.val()) {
            const price = parseFloat(priceField.val());
            if (isNaN(price) || price <= 0) {
                markFieldInvalid(priceField, '{% trans "Le prix doit être supérieur à 0" %}');
                isValid = false;
            }
        }

        if (!isValid) {
            console.log('Validation du formulaire échouée');
        } else {
            console.log('Validation du formulaire réussie');
        }

        return isValid;
    }

    function markFieldInvalid($field, message) {
        $field.addClass('is-invalid').removeClass('is-valid');

        // Trouver ou créer le message d'erreur
        let $errorDiv = $field.parent().find('.invalid-feedback');
        if ($errorDiv.length === 0) {
            $errorDiv = $('<div class="invalid-feedback"></div>');
            $field.parent().append($errorDiv);
        }
        $errorDiv.text(message).show();
    }

    function markFieldValid($field) {
        $field.removeClass('is-invalid').addClass('is-valid');

        // Masquer le message d'erreur
        $field.parent().find('.invalid-feedback').hide();
    }

    // Fonction pour ajouter un formulaire d'image
    let imageFormIndex = {{ image_formset.total_form_count|default:5 }};
    function addImageForm() {
        const totalForms = $('#id_images-TOTAL_FORMS');
        const currentIndex = parseInt(totalForms.val());
        const maxForms = parseInt(totalForms.attr('data-max'));

        if (currentIndex >= maxForms) {
            showToast('{% trans "Vous avez atteint le nombre maximum d\'images autorisées." %}', 'error');
            return;
        }

        console.log('Ajout d\'un formulaire d\'image, index:', currentIndex);

        // Clone du premier formulaire d'image (sans les données)
        const $firstForm = $('.image-form').first().clone();
        const newIndex = imageFormIndex;

        // Mettre à jour les attributs name et id
        $firstForm.find('[name]').each(function() {
            const name = $(this).attr('name').replace(/-0-/g, `-${newIndex}-`);
            $(this).attr('name', name);
        });

        $firstForm.find('[id]').each(function() {
            const id = $(this).attr('id').replace(/-0-/g, `-${newIndex}-`);
            $(this).attr('id', id);
        });

        // Réinitialiser les valeurs
        $firstForm.find('input[type="text"], input[type="number"], textarea').val('');
        $firstForm.find('input[type="file"]').val('');
        $firstForm.find('input[type="checkbox"]').prop('checked', false);
        $firstForm.find('.image-preview-container').empty();

        // Ajouter au DOM
        $('#image-forms .row').append($firstForm);

        // Mettre à jour le compteur
        totalForms.val(currentIndex + 1);
        imageFormIndex++;

        console.log('Formulaire d\'image ajouté avec succès');
    }

    // Fonction pour prévisualiser une image
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            const container = $(input).closest('.image-form').find('.image-preview-container');

            reader.onload = function(e) {
                container.html(`<img src="${e.target.result}" class="image-preview">`);
            };

            reader.readAsDataURL(input.files[0]);
        }
    }

    // Fonction toast
    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        if ($('#toast-container').length === 0) {
            $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
        }

        $('#toast-container').append(toastHtml);
        $('.toast').toast('show');

        // Remove toast after hiding
        $('.toast').on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }
});
</script>
{% endblock %}


========== ads/templates/ads/category_list.html ==========
{# ~/ebi3/ads/templates/ads/category_list.html #}
{% extends 'ads/base_ads.html' %}
{% load i18n %}

{% block title %}{% trans "Catégories" %} - Ebi3{% endblock %}

{% block ads_content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="mb-0">
                    <i class="fas fa-list-alt"></i> {% trans "Catégories" %}
                </h1>
                <div>
                    <a href="{% url 'ads:ad_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-search"></i> {% trans "Voir toutes les annonces" %}
                    </a>
                    {% if user.is_staff %}
                        <a href="/admin/ads/category/" class="btn btn-outline-secondary">
                            <i class="fas fa-cog"></i> {% trans "Administration" %}
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Introduction -->
            <div class="card bg-light border-0 mb-4">
                <div class="card-body">
                    <p class="lead mb-0">
                        <i class="fas fa-info-circle text-primary"></i>
                        {% trans "Parcourez nos catégories pour trouver exactement ce que vous cherchez. Vous pouvez également utiliser la barre de recherche pour une recherche rapide." %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recherche de catégories -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="categorySearch"
                                       placeholder="{% trans 'Rechercher une catégorie...' %}">
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown">
                                    <i class="fas fa-sort"></i> {% trans "Trier par" %}
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item sort-option active" href="#" data-sort="name">
                                        <i class="fas fa-font"></i> {% trans "Nom A-Z" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="count">
                                        <i class="fas fa-layer-group"></i> {% trans "Nombre d'annonces" %}
                                    </a></li>
                                    <li><a class="dropdown-item sort-option" href="#" data-sort="level">
                                        <i class="fas fa-sitemap"></i> {% trans "Niveau hiérarchique" %}
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">{% trans "Catégories totales" %}</h6>
                            <h2 class="mb-0">{{ categories|length }}</h2>
                        </div>
                        <i class="fas fa-folder fa-3x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">{% trans "Annonces totales" %}</h6>
                            <h2 class="mb-0">{{ total_ads_count|default:0 }}</h2>
                        </div>
                        <i class="fas fa-bullhorn fa-3x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">{% trans "Catégories populaires" %}</h6>
                            <h2 class="mb-0">{{ top_categories|length|default:0 }}</h2>
                        </div>
                        <i class="fas fa-fire fa-3x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Catégories populaires -->
    {% if top_categories %}
    <div class="row mb-5">
        <div class="col-12">
            <h3 class="mb-4">
                <i class="fas fa-fire text-warning"></i> {% trans "Catégories populaires" %}
            </h3>
            <div class="row g-3" id="popular-categories">
                {% for category in top_categories|slice:":6" %}
                    <div class="col-md-4 col-lg-2">
                        <a href="{{ category.get_absolute_url }}" class="text-decoration-none">
                            <div class="card border-0 shadow-sm h-100 text-center hover-lift">
                                <div class="card-body p-3">
                                    {% if category.icon %}
                                        <div class="mb-3">
                                            <i class="{{ category.icon }} fa-3x text-primary"></i>
                                        </div>
                                    {% else %}
                                        <div class="mb-3">
                                            <i class="fas fa-folder fa-3x text-primary"></i>
                                        </div>
                                    {% endif %}
                                    <h6 class="card-title mb-1">{{ category.name }}</h6>
                                    <span class="badge bg-secondary">{{ category.ad_count }}</span>
                                </div>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Liste hiérarchique des catégories -->
    <div class="row">
        <div class="col-12">
            <h3 class="mb-4">
                <i class="fas fa-sitemap"></i> {% trans "Toutes les catégories" %}
            </h3>

            {% if categories %}
                <div class="row" id="categories-container">
                    {% for category in categories %}
                        {% if not category.parent %}
                            <!-- Catégorie parente -->
                            <div class="col-12 mb-4 category-item"
                                 data-name="{{ category.name|lower }}"
                                 data-count="{{ category.ad_count }}"
                                 data-level="{{ category.level }}">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                        <div>
                                            <h4 class="mb-0">
                                                {% if category.icon %}
                                                    <i class="{{ category.icon }} me-2"></i>
                                                {% endif %}
                                                {{ category.name }}
                                            </h4>
                                            {% if category.description %}
                                                <p class="mb-0 small opacity-75">{{ category.description|truncatechars:100 }}</p>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <span class="badge bg-light text-primary fs-6">
                                                {{ category.ad_count }} {% trans "annonces" %}
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Sous-catégories -->
                                    {% if category.children.all %}
                                        <div class="card-body">
                                            <div class="row g-3">
                                                {% for child in category.children.all %}
                                                    {% if child.is_active %}
                                                        <div class="col-md-4 col-lg-3">
                                                            <a href="{{ child.get_absolute_url }}" class="text-decoration-none category-child-item">
                                                                <div class="card border h-100 hover-lift">
                                                                    <div class="card-body">
                                                                        <div class="d-flex justify-content-between align-items-start">
                                                                            <div>
                                                                                <h6 class="card-title mb-1">
                                                                                    {% if child.icon %}
                                                                                        <i class="{{ child.icon }} me-2 text-muted"></i>
                                                                                    {% endif %}
                                                                                    {{ child.name }}
                                                                                </h6>
                                                                                {% if child.description %}
                                                                                    <p class="small text-muted mb-0">{{ child.description|truncatechars:60 }}</p>
                                                                                {% endif %}
                                                                            </div>
                                                                            <span class="badge bg-secondary">{{ child.ad_count }}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </a>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% else %}
                                        <!-- Aucune sous-catégorie -->
                                        <div class="card-body">
                                            <div class="text-center py-4">
                                                <a href="{{ category.get_absolute_url }}" class="btn btn-primary">
                                                    <i class="fas fa-search"></i> {% trans "Voir les annonces" %}
                                                </a>
                                            </div>
                                        </div>
                                    {% endif %}

                                    <!-- Pied de carte -->
                                    <div class="card-footer bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                {% if category.children.all %}
                                                    {{ category.children.all|length }} {% trans "sous-catégories" %}
                                                {% else %}
                                                    {% trans "Aucune sous-catégorie" %}
                                                {% endif %}
                                            </small>
                                            <a href="{{ category.get_absolute_url }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-arrow-right"></i> {% trans "Explorer" %}
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Catégories sans parent (orphelines) -->
                {% for category in categories %}
                    {% if category.parent %}
                        {% if not category.parent in categories %}
                            <div class="col-12 mb-4 category-item"
                                 data-name="{{ category.name|lower }}"
                                 data-count="{{ category.ad_count }}"
                                 data-level="{{ category.level }}">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            {{ category.name }}
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            {% trans "Cette catégorie n'a pas de catégorie parente visible." %}
                                        </p>
                                        <a href="{{ category.get_absolute_url }}" class="btn btn-outline-warning">
                                            <i class="fas fa-search"></i> {% trans "Voir les annonces" %}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}

            {% else %}
                <!-- Aucune catégorie -->
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-folder-open fa-4x text-muted"></i>
                    </div>
                    <h3 class="mb-3">{% trans "Aucune catégorie disponible" %}</h3>
                    <p class="text-muted mb-4">
                        {% trans "Les catégories seront bientôt disponibles. Revenez plus tard !" %}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Catégories récemment mises à jour -->
    {% if recent_categories %}
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4">
                <i class="fas fa-history"></i> {% trans "Récemment mises à jour" %}
            </h3>
            <div class="row g-3">
                {% for category in recent_categories|slice:":8" %}
                    <div class="col-md-3 col-lg-2">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-folder fa-2x text-info"></i>
                                </div>
                                <h6 class="card-title mb-1">{{ category.name }}</h6>
                                <small class="text-muted">
                                    {% trans "Mise à jour" %} {{ category.updated_at|timesince }}
                                </small>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Recherche en temps réel
        $('#categorySearch').on('keyup', function() {
            const searchTerm = $(this).val().toLowerCase();

            $('.category-item').each(function() {
                const name = $(this).data('name');
                const matches = name.includes(searchTerm);

                if (matches || searchTerm === '') {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });

            // Recherche dans les sous-catégories aussi
            $('.category-child-item').each(function() {
                const text = $(this).text().toLowerCase();
                const matches = text.includes(searchTerm);

                if (matches) {
                    $(this).closest('.col-md-4, .col-lg-3').show();
                    $(this).closest('.category-item').show();
                } else if (searchTerm !== '') {
                    $(this).closest('.col-md-4, .col-lg-3').hide();
                } else {
                    $(this).closest('.col-md-4, .col-lg-3').show();
                }
            });
        });

        // Tri des catégories
        $('.sort-option').click(function(e) {
            e.preventDefault();
            const sortBy = $(this).data('sort');

            // Mettre à jour l'état actif
            $('.sort-option').removeClass('active');
            $(this).addClass('active');

            const container = $('#categories-container');
            const items = container.find('.category-item').get();

            items.sort(function(a, b) {
                const aVal = $(a).data(sortBy);
                const bVal = $(b).data(sortBy);

                if (sortBy === 'name') {
                    return aVal.localeCompare(bVal);
                } else {
                    // Pour count et level, ordre décroissant
                    return bVal - aVal;
                }
            });

            // Réorganiser les éléments
            $.each(items, function(idx, item) {
                container.append(item);
            });

            $('.dropdown-toggle').dropdown('hide');
        });

        // Animation au survol
        $('.hover-lift').hover(
            function() {
                $(this).addClass('shadow-lg');
                $(this).css('transform', 'translateY(-5px)');
            },
            function() {
                $(this).removeClass('shadow-lg');
                $(this).css('transform', 'translateY(0)');
            }
        );

        // Initialiser les tooltips
        $('[data-bs-toggle="tooltip"]').tooltip();

        // Compter les catégories visibles
        function updateVisibleCount() {
            const visible = $('.category-item:visible').length;
            $('#category-count').text(visible);
        }

        // Mettre à jour le compteur initial
        updateVisibleCount();

        // Mettre à jour le compteur lors de la recherche
        $('#categorySearch').on('keyup', updateVisibleCount);
    });
</script>

<style>
    .hover-lift {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
    }

    .hover-lift:hover {
        border-color: #007bff;
        cursor: pointer;
    }

    .category-child-item .card {
        transition: all 0.2s ease;
    }

    .category-child-item .card:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }

    .card.border-primary {
        border-width: 2px;
    }

    .card.border-warning {
        border-width: 2px;
    }

    .card-header.bg-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }

    .card-header.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    }

    .card-header.bg-info {
        background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
    }

    .card-header.bg-warning {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    }

    .badge.bg-light.text-primary {
        font-weight: bold;
        padding: 0.5rem 1rem;
    }

    @media (max-width: 768px) {
        .input-group-lg .form-control,
        .input-group-lg .input-group-text {
            padding: 0.5rem;
            font-size: 1rem;
        }

        .card-header h4 {
            font-size: 1.25rem;
        }

        .card-header h5 {
            font-size: 1rem;
        }
    }

    .opacity-75 {
        opacity: 0.75;
    }

    #popular-categories .card {
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}


========== ads/templates/ads/ad_report.html ==========
{# ~/ebi3/ads/templates/ads/ad_report.html #}
{% extends 'ads/base_ads.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Signaler l'annonce" %} - Ebi3{% endblock %}

{% block ads_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm border-warning">
            <div class="card-header bg-warning text-dark">
                <h2 class="mb-0">
                    <i class="fas fa-flag"></i> {% trans "Signaler cette annonce" %}
                </h2>
            </div>
            <div class="card-body">

                <!-- Aperçu de l'annonce signalée -->
                <div class="card mb-4 border-secondary">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">{% trans "Annonce concernée" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex">
                            {% with ad.images.first as main_image %}
                                <div class="flex-shrink-0 me-3">
                                    {% if main_image %}
                                        <img src="{{ main_image.thumbnail.url|default:main_image.image.url }}"
                                             class="rounded"
                                             style="width: 100px; height: 100px; object-fit: cover;"
                                             alt="{{ ad.title }}">
                                    {% else %}
                                        <div class="bg-light d-flex align-items-center justify-content-center rounded"
                                             style="width: 100px; height: 100px;">
                                            <i class="fas fa-image fa-2x text-muted"></i>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endwith %}
                            <div class="flex-grow-1">
                                <h5 class="mb-1">
                                    <a href="{{ ad.get_absolute_url }}" class="text-decoration-none">
                                        {{ ad.title }}
                                    </a>
                                </h5>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-user"></i>
                                    {% trans "Vendeur:" %}
                                    <a href="{% url 'users:profile' ad.seller.username %}" class="text-decoration-none">
                                        {{ ad.seller.username }}
                                    </a>
                                </p>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-map-marker-alt"></i>
                                    {{ ad.city_from }} → {{ ad.city_to }}
                                </p>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-tag"></i>
                                    {{ ad.get_price_with_currency }}
                                    • {{ ad.get_condition_display }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations sur le signalement -->
                <div class="alert alert-info mb-4">
                    <h5 class="alert-heading">
                        <i class="fas fa-info-circle"></i> {% trans "Comment fonctionne le signalement ?" %}
                    </h5>
                    <ul class="mb-0">
                        <li>{% trans "Votre signalement sera examiné par notre équipe de modération sous 24h" %}</li>
                        <li>{% trans "Le vendeur ne sera pas informé de votre identité" %}</li>
                        <li>{% trans "En cas d'urgence, contactez-nous directement via le support" %}</li>
                        <li>{% trans "Les signalements abusifs peuvent entraîner la suspension de votre compte" %}</li>
                    </ul>
                </div>

                <!-- Formulaire de signalement -->
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="mb-4">
                        <h5 class="mb-3">{% trans "Pourquoi signalez-vous cette annonce ?" %}</h5>
                        {{ form.reason|as_crispy_field }}

                        <div class="mt-3" id="reason-descriptions">
                            <div class="alert alert-light border">
                                <small>
                                    <strong>{% trans "Spam ou publicité :" %}</strong>
                                    {% trans "Contenu promotionnel non autorisé, publicité abusive" %}
                                </small>
                            </div>
                            <div class="alert alert-light border mt-2">
                                <small>
                                    <strong>{% trans "Fraude ou arnaque :" %}</strong>
                                    {% trans "Tentative de fraude, escroquerie, informations trompeuses" %}
                                </small>
                            </div>
                            <div class="alert alert-light border mt-2">
                                <small>
                                    <strong>{% trans "Contenu inapproprié :" %}</strong>
                                    {% trans "Contenu offensant, discriminatoire, ou contraire aux CGU" %}
                                </small>
                            </div>
                            <div class="alert alert-light border mt-2">
                                <small>
                                    <strong>{% trans "Mauvaise catégorie :" %}</strong>
                                    {% trans "L'annonce est placée dans une catégorie incorrecte" %}
                                </small>
                            </div>
                            <div class="alert alert-light border mt-2">
                                <small>
                                    <strong>{% trans "Article prohibé :" %}</strong>
                                    {% trans "Article interdit par la loi ou nos conditions d'utilisation" %}
                                </small>
                            </div>
                            <div class="alert alert-light border mt-2">
                                <small>
                                    <strong>{% trans "Annonce en double :" %}</strong>
                                    {% trans "Même annonce publiée plusieurs fois" %}
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h5 class="mb-3">{% trans "Description détaillée" %}</h5>
                        {{ form.description|as_crispy_field }}
                        <small class="form-text text-muted">
                            {% trans "Décrivez précisément le problème. Soyez aussi factuel que possible." %}
                        </small>
                    </div>

                    <div class="mb-4">
                        <h5 class="mb-3">{% trans "Preuves (optionnel)" %}</h5>
                        {{ form.evidence|as_crispy_field }}
                        <small class="form-text text-muted">
                            {% trans "Vous pouvez joindre des captures d'écran, documents, etc. Formats acceptés : JPG, PNG, PDF, DOC. Taille max : 10MB." %}
                        </small>
                    </div>

                    <!-- Engagement d'exactitude -->
                    <div class="card border-primary mb-4">
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmAccuracy" required>
                                <label class="form-check-label" for="confirmAccuracy">
                                    <strong>{% trans "Je certifie sur l'honneur que les informations fournies sont exactes et véridiques." %}</strong>
                                </label>
                            </div>
                            <small class="text-muted">
                                {% trans "Les fausses déclarations peuvent entraîner des sanctions conformément à nos conditions d'utilisation." %}
                            </small>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'ads:ad_detail' slug=ad.slug %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> {% trans "Annuler" %}
                        </a>

                        <button type="submit" class="btn btn-warning" id="submitBtn" disabled>
                            <i class="fas fa-paper-plane"></i> {% trans "Envoyer le signalement" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Activer/désactiver le bouton d'envoi selon la confirmation
        $('#confirmAccuracy').change(function() {
            $('#submitBtn').prop('disabled', !$(this).is(':checked'));
        });

        // Masquer les descriptions par défaut, les afficher selon le choix
        $('#reason-descriptions').hide();

        $('#id_reason').change(function() {
            const selectedReason = $(this).val();
            if (selectedReason) {
                $('#reason-descriptions').show();
                // Vous pourriez ici afficher seulement la description pertinente
            } else {
                $('#reason-descriptions').hide();
            }
        });

        // Initialiser si une raison est déjà sélectionnée
        if ($('#id_reason').val()) {
            $('#reason-descriptions').show();
        }

        // Validation du formulaire
        $('form').submit(function(e) {
            const reason = $('#id_reason').val();
            const description = $('#id_description').val().trim();

            if (!reason) {
                e.preventDefault();
                alert('{% trans "Veuillez sélectionner une raison pour votre signalement." %}');
                $('#id_reason').focus();
                return false;
            }

            if (description.length < 10) {
                e.preventDefault();
                alert('{% trans "Veuillez fournir une description détaillée (au moins 10 caractères)." %}');
                $('#id_description').focus();
                return false;
            }

            if (!confirm('{% trans "Confirmez-vous l\'envoi de ce signalement ? Il sera examiné par notre équipe sous 24h." %}')) {
                e.preventDefault();
                return false;
            }

            return true;
        });

        // Prévisualisation du fichier
        $('#id_evidence').change(function() {
            const file = this.files[0];
            if (file) {
                const fileSize = file.size / 1024 / 1024; // en MB
                if (fileSize > 10) {
                    alert('{% trans "Le fichier est trop volumineux (max 10MB). Veuillez choisir un fichier plus petit." %}');
                    $(this).val('');
                }
            }
        });
    });
</script>

<style>
    .card.border-warning {
        border-width: 2px;
    }

    #submitBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .alert-info ul {
        padding-left: 1.5rem;
    }

    .alert-info li {
        margin-bottom: 0.25rem;
    }

    #reason-descriptions .alert {
        display: none;
    }

    /* Pourrait être utilisé pour afficher la description spécifique */
    .reason-desc {
        padding: 10px;
        background-color: #f8f9fa;
        border-left: 4px solid #007bff;
        margin-top: 10px;
        border-radius: 4px;
    }
</style>
{% endblock %}


========== ads/templates/ads/partials/ad_card.html ==========
{# ~/ebi3/ads/templates/ads/partials/ad_card.html #}
{% load i18n %}
<div class="card ad-card h-100">
    {% if ad.is_featured %}
        <span class="featured-badge badge bg-warning">
            <i class="fas fa-star"></i> {% trans "En vedette" %}
        </span>
    {% endif %}

    <!-- Image principale -->
    <div class="position-relative">
        {% with ad.images.first as main_image %}
            {% if main_image %}
                <img src="{{ main_image.image.url }}"
                     class="card-img-top ad-image"
                     alt="{{ ad.title }}"
                     loading="lazy">
            {% else %}
                <div class="card-img-top ad-image bg-light d-flex align-items-center justify-content-center">
                    <i class="fas fa-image fa-3x text-muted"></i>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Badge condition -->
        <span class="position-absolute top-0 start-0 m-2 condition-badge badge
                     {% if ad.condition == 'NEW' %}bg-success
                     {% elif ad.condition == 'LIKE_NEW' %}bg-info
                     {% elif ad.condition == 'GOOD' %}bg-primary
                     {% else %}bg-secondary{% endif %}">
            {{ ad.get_condition_display }}
        </span>

        <!-- Badge logistique -->
        <span class="position-absolute top-0 end-0 m-2 badge-logistics badge
                     {% if ad.logistics_option == 'P2P_DIRECT' %}bg-success
                     {% elif ad.logistics_option == 'WITH_CARRIER' %}bg-warning
                     {% else %}bg-info{% endif %}">
            {{ ad.get_logistics_option_display|slice:":10" }}
        </span>
    </div>

    <!-- Corps de la carte -->
    <div class="card-body d-flex flex-column">
        <h5 class="card-title">
            <a href="{{ ad.get_absolute_url }}" class="text-decoration-none text-dark">
                {{ ad.title|truncatechars:50 }}
            </a>
        </h5>

        <p class="card-text text-muted small mb-2">
            <i class="fas fa-map-marker-alt"></i>
            {{ ad.city_from }} → {{ ad.city_to }}
        </p>

        <p class="card-text small mb-3">
            {{ ad.description|truncatechars:100 }}
        </p>

        <div class="mt-auto">
            <div class="d-flex justify-content-between align-items-center">
                <div class="ad-price">
                    {{ ad.get_price_with_currency }}
                    {% if ad.is_negotiable %}
                        <small class="text-muted">{% trans "(Négociable)" %}</small>
                    {% endif %}
                </div>

                <!-- Bouton favori -->
                {% if user.is_authenticated %}
                    <button class="btn btn-sm favorite-btn
                                {% if ad in user.favorites.all %}btn-danger{% else %}btn-outline-danger{% endif %}"
                            data-url="{% url 'ads:toggle_favorite' ad.slug %}"
                            data-ad-slug="{{ ad.slug }}"
                            data-bs-toggle="tooltip"
                            title="{% if ad in user.favorites.all %}{% trans 'Retirer des favoris' %}{% else %}{% trans 'Ajouter aux favoris' %}{% endif %}">
                        <i class="{% if ad in user.favorites.all %}fas{% else %}far{% endif %} fa-heart"></i>
                    </button>
                {% else %}
                    <a href="{% url 'users:login' %}?next={{ request.path }}"
                       class="btn btn-sm btn-outline-danger"
                       data-bs-toggle="tooltip"
                       title="{% trans 'Connectez-vous pour ajouter aux favoris' %}">
                        <i class="far fa-heart"></i>
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Pied de carte -->
    <div class="card-footer bg-transparent border-top">
        <div class="d-flex justify-content-between align-items-center">
            <div class="small">
                <i class="fas fa-user"></i>
                <a href="{% url 'users:profile' ad.seller.username %}" class="text-decoration-none">
                    {{ ad.seller.username }}
                </a>
            </div>
            <div class="small text-muted">
                <i class="fas fa-eye"></i> {{ ad.view_count }}
                <i class="fas fa-heart ms-2"></i>
                <span id="favorite-count-{{ ad.slug }}">{{ ad.favorite_count }}</span>
            </div>
        </div>
    </div>
</div>


========== ads/templates/ads/ad_detail.html ==========
{# ~/ebi3/ads/templates/ads/ad_detail.html #}
{% extends 'ads/base_ads.html' %}
{% load i18n %}

{% block title %}{{ ad.title }} - Ebi3{% endblock %}

{% block ads_content %}
<div class="row">
    <!-- Images et galerie -->
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <!-- Galerie principale -->
                <div id="adCarousel" class="carousel slide" data-bs-ride="carousel">
                    {% if ad.images.count > 1 %}
                        <div class="carousel-indicators">
                            {% for image in ad.images.all %}
                                <button type="button" data-bs-target="#adCarousel"
                                        data-bs-slide-to="{{ forloop.counter0 }}"
                                        {% if forloop.first %}class="active"{% endif %}></button>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="carousel-inner">
                        {% for image in ad.images.all %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <img src="{{ image.image.url }}" class="d-block w-100"
                                     alt="{{ image.caption|default:ad.title }}">
                            </div>
                        {% empty %}
                            <div class="carousel-item active">
                                <div class="d-flex align-items-center justify-content-center bg-light"
                                     style="height: 400px;">
                                    <i class="fas fa-image fa-5x text-muted"></i>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    {% if ad.images.count > 1 %}
                        <button class="carousel-control-prev" type="button"
                                data-bs-target="#adCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button"
                                data-bs-target="#adCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    {% endif %}
                </div>

                <!-- Miniatures -->
                {% if ad.images.count > 1 %}
                    <div class="row mt-3">
                        {% for image in ad.images.all %}
                            <div class="col-3 col-md-2">
                                <img src="{{ image.image.url }}"
                                     class="img-thumbnail image-thumbnail {% if forloop.first %}active{% endif %}"
                                     data-full="{{ image.image.url }}"
                                     alt="{{ image.caption|default:'' }}"
                                     style="cursor: pointer; height: 80px; object-fit: cover;">
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Vidéos -->
                {% if ad.videos.exists %}
                    <div class="mt-4">
                        <h5><i class="fas fa-video"></i> {% trans "Vidéos" %}</h5>
                        <div class="row">
                            {% for video in ad.videos.all %}
                                <div class="col-md-6">
                                    <div class="card">
                                        <video controls class="card-img-top" style="max-height: 200px;">
                                            <source src="{{ video.video.url }}" type="video/mp4">
                                            {% trans "Votre navigateur ne supporte pas la vidéo." %}
                                        </video>
                                        {% if video.caption %}
                                            <div class="card-body">
                                                <p class="card-text small">{{ video.caption }}</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Description -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> {% trans "Description" %}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>{% trans "Catégorie:" %}</strong>
                            <a href="{{ ad.category.get_absolute_url }}">{{ ad.category.name }}</a>
                        </p>
                        <p><strong>{% trans "État:" %}</strong>
                            <span class="badge bg-info">{{ ad.get_condition_display }}</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{% trans "Poids:" %}</strong>
                            {% if ad.weight %}
                                {{ ad.weight }} kg
                            {% else %}
                                <span class="text-muted">{% trans "Non spécifié" %}</span>
                            {% endif %}
                        </p>
                        <p><strong>{% trans "Dimensions:" %}</strong>
                            {% if ad.length and ad.width and ad.height %}
                                {{ ad.length }} × {{ ad.width }} × {{ ad.height }} cm
                            {% else %}
                                <span class="text-muted">{% trans "Non spécifiées" %}</span>
                            {% endif %}
                        </p>
                    </div>
                </div>

                <h6>{% trans "Description détaillée" %}</h6>
                <div class="description-content">
                    {{ ad.description|linebreaks }}
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar avec informations et actions -->
    <div class="col-lg-4">
        <!-- Prix et actions -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h2 class="ad-price mb-3">
                    {{ ad.get_price_with_currency }}
                    {% if ad.is_negotiable %}
                        <small class="text-muted d-block">{% trans "(Prix négociable)" %}</small>
                    {% endif %}
                </h2>

                <!-- Boutons d'action -->
                <div class="d-grid gap-2 mb-3">
                    {% if user.is_authenticated %}
                        {% if user == ad.seller %}
                            <a href="{% url 'ads:ad_edit' ad.slug %}" class="btn btn-primary">
                                <i class="fas fa-edit"></i> {% trans "Modifier l'annonce" %}
                            </a>
                            <a href="{% url 'ads:ad_delete' ad.slug %}" class="btn btn-outline-danger">
                                <i class="fas fa-trash"></i> {% trans "Supprimer" %}
                            </a>
                        {% else %}
                            {% if ad.can_be_reserved %}
                                <button class="btn btn-success" data-bs-toggle="modal"
                                        data-bs-target="#reservationModal">
                                    <i class="fas fa-shopping-cart"></i> {% trans "Réserver" %}
                                </button>

                                {% if ad.is_available_for_carrier %}
                                    <button class="btn btn-warning" data-bs-toggle="modal"
                                            data-bs-target="#carrierProposalModal">
                                        <i class="fas fa-truck"></i> {% trans "Proposer un transport" %}
                                    </button>
                                {% endif %}
                            {% endif %}

                            <!-- Bouton favori -->
                            <button class="btn favorite-btn
                                        {% if is_favorite %}btn-danger{% else %}btn-outline-danger{% endif %}"
                                    data-url="{% url 'ads:toggle_favorite' ad.slug %}"
                                    data-ad-slug="{{ ad.slug }}">
                                <i class="{% if is_favorite %}fas{% else %}far{% endif %} fa-heart"></i>
                                {% if is_favorite %}
                                    {% trans "Retirer des favoris" %}
                                {% else %}
                                    {% trans "Ajouter aux favoris" %}
                                {% endif %}
                            </button>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'users:login' %}?next={{ request.path }}"
                           class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> {% trans "Se connecter pour réserver" %}
                        </a>
                    {% endif %}

                    <!-- Bouton de partage -->
                    <button class="btn btn-outline-secondary" onclick="shareAd()">
                        <i class="fas fa-share-alt"></i> {% trans "Partager" %}
                    </button>

                    <!-- Bouton de signalement -->
                    {% if can_report %}
                        <a href="{% url 'ads:ad_report' ad.slug %}" class="btn btn-outline-warning">
                            <i class="fas fa-flag"></i> {% trans "Signaler" %}
                        </a>
                    {% endif %}
                </div>

                <!-- Statistiques -->
                <div class="d-flex justify-content-around text-center border-top pt-3">
                    <div>
                        <div class="h5">{{ ad.view_count }}</div>
                        <small class="text-muted">{% trans "Vues" %}</small>
                    </div>
                    <div>
                        <div class="h5">{{ ad.favorite_count }}</div>
                        <small class="text-muted">{% trans "Favoris" %}</small>
                    </div>
                    <div>
                        <div class="h5">{{ ad.inquiry_count }}</div>
                        <small class="text-muted">{% trans "Demandes" %}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informations logistiques -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-shipping-fast"></i> {% trans "Informations logistiques" %}</h5>
            </div>
            <div class="card-body">
                <p><strong>{% trans "Option:" %}</strong>
                    <span class="badge bg-primary">{{ ad.get_logistics_option_display }}</span>
                </p>

                <div class="mb-3">
                    <p class="mb-1"><strong>{% trans "Départ:" %}</strong></p>
                    <p class="mb-0">
                        <i class="fas fa-map-marker-alt text-danger"></i>
                        {{ ad.city_from }}, {{ ad.country_from.name }}
                    </p>
                    {% if ad.address_from %}
                        <small class="text-muted">{{ ad.address_from|truncatechars:50 }}</small>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <p class="mb-1"><strong>{% trans "Destination:" %}</strong></p>
                    <p class="mb-0">
                        <i class="fas fa-map-marker-alt text-success"></i>
                        {{ ad.city_to }}, {{ ad.country_to.name }}
                    </p>
                    {% if ad.address_to %}
                        <small class="text-muted">{{ ad.address_to|truncatechars:50 }}</small>
                    {% endif %}
                </div>

                {% if ad.requires_insurance %}
                    <p><strong>{% trans "Assurance:" %}</strong>
                        <span class="badge bg-success">{% trans "Requis" %}</span>
                        {% if ad.insurance_value %}
                            ({{ ad.insurance_value }} {{ ad.get_currency_display }})
                        {% endif %}
                    </p>
                {% endif %}

                {% if ad.fragile_item %}
                    <p><strong>{% trans "Fragile:" %}</strong>
                        <span class="badge bg-warning">{% trans "Oui" %}</span>
                    </p>
                {% endif %}

                {% if ad.requires_packaging %}
                    <p><strong>{% trans "Emballage:" %}</strong>
                        <span class="badge bg-info">{% trans "Requis" %}</span>
                    </p>
                {% endif %}
            </div>
        </div>

        <!-- Informations du vendeur -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-user"></i> {% trans "Vendeur" %}</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="avatar-circle bg-primary me-3"
                         style="width: 60px; height: 60px;">
                        <span class="avatar-text" style="font-size: 1.5rem;">
                            {{ ad.seller.username|first|upper }}
                        </span>
                    </div>
                    <div>
                        <h5 class="mb-0">
                            <a href="{% url 'users:profile' ad.seller.username %}"
                               class="text-decoration-none">
                                {{ ad.seller.username }}
                            </a>
                        </h5>
                        <p class="text-muted mb-0">
                            <i class="fas fa-user-tag"></i> {{ ad.seller.get_role_display }}
                        </p>
                    </div>
                </div>

                <div class="row text-center">
                    <div class="col-4">
                        <div class="h5">{{ ad.seller.profile.successful_transactions|default:0 }}</div>
                        <small class="text-muted">{% trans "Transactions" %}</small>
                    </div>
                    <div class="col-4">
                        <div class="h5">{{ ad.seller.profile.total_ads|default:0 }}</div>
                        <small class="text-muted">{% trans "Annonces" %}</small>
                    </div>
                    <div class="col-4">
                        <div class="h5">{{ ad.seller.rating|default:"0.0" }}</div>
                        <small class="text-muted">{% trans "Note" %}</small>
                    </div>
                </div>

                <div class="mt-3">
                    <a href="{% url 'messaging:new_conversation_with_user' ad.seller.username %}"
                       class="btn btn-outline-primary w-100">
                        <i class="fas fa-envelope"></i> {% trans "Contacter" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Annonces similaires -->
{% if similar_ads %}
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4">{% trans "Annonces similaires" %}</h3>
            <div class="row">
                {% for similar_ad in similar_ads %}
                    <div class="col-md-6 col-lg-3 mb-4">
                        {% include 'ads/partials/ad_card.html' with ad=similar_ad %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endif %}

<!-- Modals -->
<div class="modal fade" id="reservationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Réserver cette annonce" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "Vous êtes sur le point de réserver cette annonce." %}</p>
                <p><strong>{% trans "Prix:" %}</strong> {{ ad.get_price_with_currency }}</p>
                <p><strong>{% trans "Vendeur:" %}</strong> {{ ad.seller.username }}</p>
                <p class="text-muted">{% trans "Vous serez redirigé vers le processus de paiement." %}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Annuler" %}
                </button>
                <a href="#" class="btn btn-success">{% trans "Confirmer la réservation" %}</a>
            </div>
        </div>
    </div>
</div>

<!-- Script de partage -->
<script>
    function shareAd() {
        const url = window.location.href;
        const title = '{{ ad.title }}';

        if (navigator.share) {
            navigator.share({
                title: title,
                text: '{% trans "Regardez cette annonce sur Ebi3" %}',
                url: url,
            });
        } else {
            // Fallback pour les navigateurs qui ne supportent pas Web Share API
            navigator.clipboard.writeText(url).then(() => {
                alert('{% trans "Lien copié dans le presse-papier !" %}');
            });
        }
    }
</script>

<style>
    .avatar-circle {
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .avatar-text {
        line-height: 1;
    }

    .description-content {
        line-height: 1.8;
        font-size: 1.05rem;
    }

    .description-content img {
        max-width: 100%;
        height: auto;
    }
</style>
{% endblock %}


========== ads/templates/ads/ad_list.html ==========
{# ~/ebi3/ads/templates/ads/ad_list.html #}
{% extends 'ads/base_ads.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Annonces" %} - Ebi3{% endblock %}

{% block ads_content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>{% trans "Annonces disponibles" %}</h1>
            <div>
                <a href="{% url 'ads:search' %}" class="btn btn-outline-primary">
                    <i class="fas fa-search"></i> {% trans "Recherche avancée" %}
                </a>
                {% if user.is_authenticated and user.role == 'SELLER' %}
                    <a href="{% url 'ads:ad_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> {% trans "Créer une annonce" %}
                    </a>
                {% endif %}
            </div>
        </div>
        <p class="text-muted">
            {% blocktranslate count total_ads=total_ads %}
                {{ total_ads }} annonce disponible
            {% plural %}
                {{ total_ads }} annonces disponibles
            {% endblocktranslate %}
        </p>
    </div>
</div>

<div class="row">
    <!-- Sidebar de filtres -->
    <div class="col-md-3 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-filter"></i> {% trans "Filtres" %}</h5>
            </div>
            <div class="card-body">
                <form method="get" id="filter-form">
                    {{ search_form|crispy }}

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i> {% trans "Filtrer" %}
                        </button>
                        <a href="{% url 'ads:ad_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> {% trans "Effacer" %}
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Catégories -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-list"></i> {% trans "Catégories" %}</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    {% for cat in categories|slice:":10" %}
                        <li class="mb-2">
                            <a href="{% url 'ads:category_detail' cat.slug %}" class="text-decoration-none">
                                <i class="fas fa-folder me-2"></i> {{ cat.name }}
                                <span class="badge bg-secondary float-end">{{ cat.ad_count }}</span>
                            </a>
                        </li>
                    {% empty %}
                        <li>{% trans "Aucune catégorie disponible" %}</li>
                    {% endfor %}
                </ul>
                <a href="{% url 'ads:category_list' %}" class="btn btn-sm btn-outline-info w-100">
                    {% trans "Voir toutes les catégories" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Liste des annonces -->
    <div class="col-md-9">
        <!-- Tri -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <span class="text-muted">
                            {% blocktranslate with count=page_obj.paginator.count %}
                                {{ count }} résultats
                            {% endblocktranslate %}
                        </span>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown">
                                <i class="fas fa-sort"></i> {% trans "Trier par" %}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="?sort=-created_at">{% trans "Plus récent" %}</a></li>
                                <li><a class="dropdown-item" href="?sort=price">{% trans "Prix croissant" %}</a></li>
                                <li><a class="dropdown-item" href="?sort=-price">{% trans "Prix décroissant" %}</a></li>
                                <li><a class="dropdown-item" href="?sort=-view_count">{% trans "Plus vues" %}</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
</div>

        <!-- Annonces -->
        {% if ads %}
            <div class="row">
                {% for ad in ads %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        {% include 'ads/partials/ad_card.html' with ad=ad %}
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        {{ num }}
                                    </a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-search fa-4x text-muted mb-3"></i>
                    <h3>{% trans "Aucune annonce trouvée" %}</h3>
                    <p class="text-muted">
                        {% trans "Essayez de modifier vos critères de recherche ou" %}
                        <a href="{% url 'ads:ad_list' %}">{% trans "consultez toutes les annonces" %}</a>.
                    </p>
                    {% if user.is_authenticated and user.role == 'SELLER' %}
                        <a href="{% url 'ads:ad_create' %}" class="btn btn-primary mt-3">
                            <i class="fas fa-plus"></i> {% trans "Créer la première annonce" %}
                        </a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}


========== ads/utils.py ==========
from django.db.models import Q
from .models import Category

def get_main_categories():
    """
    Retourne les catégories principales basées sur la structure de données fournie.
    Cette fonction identifie les catégories de haut niveau.
    """
    # Liste des catégories principales basées sur vos données
    main_category_names = [
        'Véhicules',
        'Immobilier',
        'Mode & Accessoires',
        'Maison & Jardin',
        'Électronique & Multimédia',
        'Loisirs & Divertissements',
        'Matériel Professionnel',
        'Services professionnels',
        'Services & Prestations',
        'Animaux',
        'Événements & Animation',
        'Bien-être & Santé',
        'Collection',
        'Luxe & Créateurs',
        'Emploi',
        'Photo & Vidéo',
        'Instruments de musique',
        'Caravanes & Mobil-homes',
        'Vêtements enfants',
        'Transport & Manutention',
        'Chaussures',
        'Vêtements hommes',
        'Voitures',
        'Jeux vidéo & Consoles',
        'Services à la personne',
        'Électroménager',
        'Transport & Déménagement',
        'Informatique & Web',
        'BTP & Chantier',
        'Utilitaires & Poids lourds',
        'Industrie & Production',
        'Travaux & Rénovation',
        'Locations',
        'Accessoires & Bijoux',
        'Motos & Scooters',
        'Téléphonie',
        'Ameublement',
        'Image & Son',
        'Agriculture & Espaces verts',
        'Cuisine & Arts de la table',
        'Commerce & Magasin',
        'Jardin & Extérieur',
        'Offres d emploi',
        'Informatique',
        'Bricolage',
        'Immobilier neuf',
        'Vêtements femmes',
        'Pièces & Accessoires auto',
        'Décoration',
        'Jeux & Jouets',
        'Livres & Magazines',
        'Nautisme',
        '2 Roues'
    ]

    # Récupérer ces catégories depuis la base de données
    main_categories = Category.objects.filter(
        name__in=main_category_names,
        is_active=True
    ).order_by('name')

    # Si on ne trouve pas toutes les catégories, ajouter les catégories sans parent
    if main_categories.count() < 20:  # Si moins de 20 catégories trouvées
        root_categories = Category.objects.filter(
            parent__isnull=True,
            is_active=True
        ).order_by('name')
        main_categories = (main_categories | root_categories).distinct().order_by('name')

    return main_categories


========== ads/migrations/0002_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import django.db.models.deletion
import mptt.fields
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("ads", "0001_initial"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name="ad",
            name="seller",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="ads",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Vendeur",
            ),
        ),
        migrations.AddField(
            model_name="adimage",
            name="ad",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="images",
                to="ads.ad",
                verbose_name="Annonce",
            ),
        ),
        migrations.AddField(
            model_name="adreport",
            name="ad",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="reports",
                to="ads.ad",
                verbose_name="Annonce",
            ),
        ),
        migrations.AddField(
            model_name="adreport",
            name="reporter",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="ad_reports",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Signaleur",
            ),
        ),
        migrations.AddField(
            model_name="adreport",
            name="resolved_by",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="resolved_ad_reports",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Résolu par",
            ),
        ),
        migrations.AddField(
            model_name="advideo",
            name="ad",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="videos",
                to="ads.ad",
                verbose_name="Annonce",
            ),
        ),
        migrations.AddField(
            model_name="adview",
            name="ad",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="views_tracking",
                to="ads.ad",
                verbose_name="Annonce",
            ),
        ),
        migrations.AddField(
            model_name="adview",
            name="user",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="ad_views",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="category",
            name="parent",
            field=mptt.fields.TreeForeignKey(
                blank=True,
                help_text="Sélectionnez une catégorie parente si applicable",
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="children",
                to="ads.category",
                verbose_name="Catégorie parente",
            ),
        ),
        migrations.AddField(
            model_name="ad",
            name="category",
            field=mptt.fields.TreeForeignKey(
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="ads",
                to="ads.category",
                verbose_name="Catégorie",
            ),
        ),
        migrations.AddField(
            model_name="favorite",
            name="ad",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="favorited_by",
                to="ads.ad",
                verbose_name="Annonce",
            ),
        ),
        migrations.AddField(
            model_name="favorite",
            name="user",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="favorites",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddConstraint(
            model_name="adimage",
            constraint=models.UniqueConstraint(
                condition=models.Q(("is_primary", True)),
                fields=("ad",),
                name="unique_primary_image_per_ad",
            ),
        ),
        migrations.AddIndex(
            model_name="adview",
            index=models.Index(
                fields=["ad", "viewed_at"], name="ads_adview_ad_id_519a73_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="adview",
            index=models.Index(
                fields=["session_key", "ad"], name="ads_adview_session_09c76a_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="adview",
            index=models.Index(
                fields=["user", "viewed_at"], name="ads_adview_user_id_7d23e6_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="category",
            index=models.Index(
                fields=["slug", "is_active"], name="ads_categor_slug_9fdcd8_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="category",
            index=models.Index(
                fields=["parent", "is_active"], name="ads_categor_parent__1c7a6d_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="category",
            index=models.Index(
                fields=["tree_id", "lft"], name="ads_category_tree_id_lft_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="ad",
            index=models.Index(
                fields=["status", "created_at"], name="ads_ad_status_f0db0f_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="ad",
            index=models.Index(
                fields=["seller", "status"], name="ads_ad_seller__10008f_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="ad",
            index=models.Index(
                fields=["country_from", "country_to"], name="ads_ad_country_eb4a3c_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="ad",
            index=models.Index(
                fields=["price", "status"], name="ads_ad_price_c094b3_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="ad",
            index=models.Index(
                fields=["category", "status"], name="ads_ad_categor_cf5a94_idx"
            ),
        ),
        migrations.AlterUniqueTogether(
            name="favorite",
            unique_together={("user", "ad")},
        ),
    ]



========== ads/migrations/0001_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import ads.models
import django.core.validators
import django.utils.timezone
import django_countries.fields
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name="Ad",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "title",
                    models.CharField(
                        db_index=True, max_length=200, verbose_name="Titre de l'annonce"
                    ),
                ),
                (
                    "slug",
                    models.SlugField(max_length=200, unique=True, verbose_name="Slug"),
                ),
                (
                    "description",
                    models.TextField(
                        help_text="Décrivez votre objet en détail",
                        verbose_name="Description détaillée",
                    ),
                ),
                (
                    "condition",
                    models.CharField(
                        choices=[
                            ("NEW", "Neuf"),
                            ("LIKE_NEW", "Comme neuf"),
                            ("GOOD", "Bon état"),
                            ("FAIR", "État correct"),
                            ("POOR", "Mauvais état"),
                            ("FOR_PARTS", "Pour pièces"),
                        ],
                        default="GOOD",
                        max_length=20,
                        verbose_name="État de l'objet",
                    ),
                ),
                (
                    "price",
                    models.DecimalField(
                        decimal_places=2,
                        help_text="Prix en devise de départ",
                        max_digits=10,
                        verbose_name="Prix",
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                        ],
                        default="EUR",
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "is_negotiable",
                    models.BooleanField(default=False, verbose_name="Prix négociable"),
                ),
                (
                    "weight",
                    models.DecimalField(
                        blank=True,
                        decimal_places=3,
                        help_text="Poids en kilogrammes",
                        max_digits=8,
                        null=True,
                        verbose_name="Poids (kg)",
                    ),
                ),
                (
                    "length",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=8,
                        null=True,
                        verbose_name="Longueur (cm)",
                    ),
                ),
                (
                    "width",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=8,
                        null=True,
                        verbose_name="Largeur (cm)",
                    ),
                ),
                (
                    "height",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=8,
                        null=True,
                        verbose_name="Hauteur (cm)",
                    ),
                ),
                (
                    "volume",
                    models.DecimalField(
                        blank=True,
                        decimal_places=3,
                        editable=False,
                        max_digits=10,
                        null=True,
                        verbose_name="Volume (L)",
                    ),
                ),
                (
                    "country_from",
                    django_countries.fields.CountryField(
                        help_text="Pays où se trouve l'objet",
                        max_length=2,
                        verbose_name="Pays de départ",
                    ),
                ),
                (
                    "city_from",
                    models.CharField(max_length=100, verbose_name="Ville de départ"),
                ),
                (
                    "address_from",
                    models.TextField(blank=True, verbose_name="Adresse de départ"),
                ),
                (
                    "latitude_from",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Latitude départ",
                    ),
                ),
                (
                    "longitude_from",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Longitude départ",
                    ),
                ),
                (
                    "country_to",
                    django_countries.fields.CountryField(
                        help_text="Pays où l'objet doit être livré",
                        max_length=2,
                        verbose_name="Pays de destination",
                    ),
                ),
                (
                    "city_to",
                    models.CharField(
                        max_length=100, verbose_name="Ville de destination"
                    ),
                ),
                (
                    "address_to",
                    models.TextField(blank=True, verbose_name="Adresse de destination"),
                ),
                (
                    "latitude_to",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Latitude destination",
                    ),
                ),
                (
                    "longitude_to",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Longitude destination",
                    ),
                ),
                (
                    "logistics_option",
                    models.CharField(
                        choices=[
                            ("P2P_DIRECT", "Vente directe (P2P)"),
                            ("WITH_CARRIER", "Avec transporteur"),
                            ("WITH_EXPAT_CARRIER", "Avec expatrié-transporteur"),
                        ],
                        default="P2P_DIRECT",
                        max_length=20,
                        verbose_name="Option logistique",
                    ),
                ),
                (
                    "requires_insurance",
                    models.BooleanField(
                        default=False, verbose_name="Requiert assurance"
                    ),
                ),
                (
                    "insurance_value",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        verbose_name="Valeur assurée",
                    ),
                ),
                (
                    "fragile_item",
                    models.BooleanField(default=False, verbose_name="Objet fragile"),
                ),
                (
                    "requires_packaging",
                    models.BooleanField(
                        default=False, verbose_name="Requiert emballage"
                    ),
                ),
                (
                    "available_from",
                    models.DateField(
                        default=django.utils.timezone.now,
                        help_text="Date à partir de laquelle l'objet est disponible",
                        verbose_name="Disponible à partir du",
                    ),
                ),
                (
                    "available_until",
                    models.DateField(
                        blank=True,
                        help_text="Date limite de disponibilité",
                        null=True,
                        verbose_name="Disponible jusqu'au",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("DRAFT", "Brouillon"),
                            ("PENDING", "En attente de validation"),
                            ("ACTIVE", "Active"),
                            ("RESERVED", "Réservée"),
                            ("SOLD", "Vendue"),
                            ("EXPIRED", "Expirée"),
                            ("REJECTED", "Rejetée"),
                            ("ARCHIVED", "Archivée"),
                        ],
                        db_index=True,
                        default="DRAFT",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "is_featured",
                    models.BooleanField(
                        default=False, verbose_name="Annonce en vedette"
                    ),
                ),
                (
                    "featured_until",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="En vedette jusqu'au"
                    ),
                ),
                (
                    "rejection_reason",
                    models.TextField(blank=True, verbose_name="Raison du rejet"),
                ),
                (
                    "meta_keywords",
                    models.CharField(
                        blank=True, max_length=500, verbose_name="Mots-clés SEO"
                    ),
                ),
                (
                    "meta_description",
                    models.TextField(blank=True, verbose_name="Description SEO"),
                ),
                (
                    "view_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre de vues"
                    ),
                ),
                (
                    "favorite_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre de favoris"
                    ),
                ),
                (
                    "inquiry_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre de demandes"
                    ),
                ),
                (
                    "free_images_allowed",
                    models.PositiveIntegerField(
                        default=3, verbose_name="Nombre de photos gratuites"
                    ),
                ),
                (
                    "paid_images_used",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Photos payantes utilisées"
                    ),
                ),
                (
                    "videos_allowed",
                    models.BooleanField(
                        default=False, verbose_name="Vidéos autorisées"
                    ),
                ),
                (
                    "videos_used",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Vidéos utilisées"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True, db_index=True)),
                ("published_at", models.DateTimeField(blank=True, null=True)),
                ("expired_at", models.DateTimeField(blank=True, null=True)),
            ],
            options={
                "verbose_name": "Annonce",
                "verbose_name_plural": "Annonces",
                "ordering": ["-created_at"],
                "permissions": [
                    ("can_feature_ad", "Peut mettre en vedette une annonce"),
                    ("can_moderate_ad", "Peut modérer les annonces"),
                    ("can_view_statistics", "Peut voir les statistiques"),
                ],
            },
        ),
        migrations.CreateModel(
            name="AdImage",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "image",
                    models.ImageField(
                        upload_to=ads.models.ad_image_upload_path,
                        validators=[
                            django.core.validators.FileExtensionValidator(
                                ["jpg", "jpeg", "png", "webp"]
                            ),
                            ads.models.validate_file_size,
                        ],
                        verbose_name="Image",
                    ),
                ),
                (
                    "thumbnail",
                    models.ImageField(
                        blank=True,
                        editable=False,
                        null=True,
                        upload_to="ads/thumbnails/",
                        verbose_name="Miniature",
                    ),
                ),
                (
                    "caption",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Légende"
                    ),
                ),
                (
                    "is_primary",
                    models.BooleanField(default=False, verbose_name="Image principale"),
                ),
                (
                    "is_paid",
                    models.BooleanField(default=False, verbose_name="Image payante"),
                ),
                (
                    "payment_status",
                    models.CharField(
                        choices=[
                            ("FREE", "Gratuite"),
                            ("PAID", "Payée"),
                            ("PENDING", "En attente"),
                            ("FAILED", "Échouée"),
                        ],
                        default="FREE",
                        max_length=20,
                        verbose_name="Statut du paiement",
                    ),
                ),
                (
                    "payment_reference",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Référence de paiement"
                    ),
                ),
                (
                    "display_order",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Ordre d'affichage"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Image d'annonce",
                "verbose_name_plural": "Images d'annonces",
                "ordering": ["is_primary", "display_order", "created_at"],
            },
        ),
        migrations.CreateModel(
            name="AdReport",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "reason",
                    models.CharField(
                        choices=[
                            ("SPAM", "Spam ou publicité"),
                            ("FRAUD", "Fraude ou arnaque"),
                            ("INAPPROPRIATE", "Contenu inapproprié"),
                            ("WRONG_CATEGORY", "Mauvaise catégorie"),
                            ("PROHIBITED", "Article prohibé"),
                            ("DUPLICATE", "Annonce en double"),
                            ("OTHER", "Autre"),
                        ],
                        max_length=20,
                        verbose_name="Raison du signalement",
                    ),
                ),
                (
                    "description",
                    models.TextField(blank=True, verbose_name="Description détaillée"),
                ),
                (
                    "evidence",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="reports/",
                        verbose_name="Preuve",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("IN_REVIEW", "En revue"),
                            ("RESOLVED", "Résolu"),
                            ("DISMISSED", "Rejeté"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "admin_notes",
                    models.TextField(
                        blank=True, verbose_name="Notes de l'administrateur"
                    ),
                ),
                (
                    "resolved_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Résolu le"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Signalement d'annonce",
                "verbose_name_plural": "Signalements d'annonces",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="AdVideo",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "video",
                    models.FileField(
                        upload_to=ads.models.ad_video_upload_path,
                        validators=[
                            django.core.validators.FileExtensionValidator(
                                ["mp4", "avi", "mov", "wmv", "webm"]
                            ),
                            ads.models.validate_video_size,
                        ],
                        verbose_name="Vidéo",
                    ),
                ),
                (
                    "thumbnail",
                    models.ImageField(
                        blank=True,
                        editable=False,
                        null=True,
                        upload_to="ads/video_thumbnails/",
                        verbose_name="Miniature vidéo",
                    ),
                ),
                (
                    "caption",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Légende"
                    ),
                ),
                (
                    "duration",
                    models.DurationField(blank=True, null=True, verbose_name="Durée"),
                ),
                (
                    "is_paid",
                    models.BooleanField(default=True, verbose_name="Vidéo payante"),
                ),
                (
                    "payment_status",
                    models.CharField(
                        choices=[
                            ("PAID", "Payée"),
                            ("PENDING", "En attente"),
                            ("FAILED", "Échouée"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut du paiement",
                    ),
                ),
                (
                    "payment_reference",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Référence de paiement"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Vidéo d'annonce",
                "verbose_name_plural": "Vidéos d'annonces",
            },
        ),
        migrations.CreateModel(
            name="AdView",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "session_key",
                    models.CharField(
                        db_index=True, max_length=40, verbose_name="Clé de session"
                    ),
                ),
                (
                    "ip_address",
                    models.GenericIPAddressField(
                        blank=True, null=True, verbose_name="Adresse IP"
                    ),
                ),
                ("user_agent", models.TextField(blank=True, verbose_name="User Agent")),
                ("referer", models.URLField(blank=True, verbose_name="Referer")),
                ("viewed_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Vue d'annonce",
                "verbose_name_plural": "Vues d'annonces",
            },
        ),
        migrations.CreateModel(
            name="Category",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "name",
                    models.CharField(
                        db_index=True,
                        max_length=200,
                        verbose_name="Nom de la catégorie",
                    ),
                ),
                (
                    "slug",
                    models.SlugField(
                        help_text="URL-friendly version du nom",
                        max_length=200,
                        unique=True,
                        verbose_name="Slug",
                    ),
                ),
                (
                    "description",
                    models.TextField(
                        blank=True,
                        help_text="Description détaillée de la catégorie",
                        verbose_name="Description",
                    ),
                ),
                (
                    "icon",
                    models.CharField(
                        blank=True,
                        help_text="Exemple: fa-mobile, fa-car, fa-home",
                        max_length=100,
                        verbose_name="Icône FontAwesome",
                    ),
                ),
                (
                    "image",
                    models.ImageField(
                        blank=True,
                        null=True,
                        upload_to="categories/",
                        verbose_name="Image de la catégorie",
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(
                        default=True,
                        help_text="Désactiver pour cacher la catégorie",
                        verbose_name="Active",
                    ),
                ),
                (
                    "show_in_menu",
                    models.BooleanField(
                        default=True, verbose_name="Afficher dans le menu"
                    ),
                ),
                (
                    "display_order",
                    models.PositiveIntegerField(
                        default=0,
                        help_text="Plus le nombre est bas, plus c'est prioritaire",
                        verbose_name="Ordre d'affichage",
                    ),
                ),
                (
                    "requires_dimensions",
                    models.BooleanField(
                        default=False,
                        help_text="Les annonces de cette catégorie doivent avoir des dimensions",
                        verbose_name="Requiert dimensions",
                    ),
                ),
                (
                    "requires_weight",
                    models.BooleanField(
                        default=True,
                        help_text="Les annonces de cette catégorie doivent avoir un poids",
                        verbose_name="Requiert poids",
                    ),
                ),
                (
                    "meta_title",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Titre SEO"
                    ),
                ),
                (
                    "meta_description",
                    models.TextField(blank=True, verbose_name="Description SEO"),
                ),
                (
                    "ad_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre d'annonces"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("lft", models.PositiveIntegerField(editable=False)),
                ("rght", models.PositiveIntegerField(editable=False)),
                ("tree_id", models.PositiveIntegerField(db_index=True, editable=False)),
                ("level", models.PositiveIntegerField(editable=False)),
            ],
            options={
                "verbose_name": "Catégorie",
                "verbose_name_plural": "Catégories",
                "ordering": ["display_order", "name"],
            },
        ),
        migrations.CreateModel(
            name="Favorite",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Favori",
                "verbose_name_plural": "Favoris",
                "ordering": ["-created_at"],
            },
        ),
    ]



========== ads/migrations/__init__.py ==========



========== ads/tests.py ==========
# ~/ebi3/ads/tests.py
from django.test import TestCase, TransactionTestCase
from django.urls import reverse
from django.contrib.auth import get_user_model
from django.utils import timezone
from datetime import timedelta
from django.conf import settings
from .models import Category, Ad

User = get_user_model()


class AdsTests(TestCase):
    """Tests pour l'application ads"""

    def setUp(self):
        # Créer un utilisateur
        self.user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='testpass123',
            role='SELLER'
        )

        # Créer une catégorie
        self.category = Category.objects.create(
            name='Électronique',
            slug='electronique',
            is_active=True
        )

        # Créer une annonce
        self.ad = Ad.objects.create(
            title='Test Annonce',
            slug='test-annonce',
            seller=self.user,
            category=self.category,
            description='Description de test',
            price=100.00,
            currency='EUR',
            country_from='FR',
            city_from='Paris',
            country_to='MA',
            city_to='Casablanca',
            logistics_option=Ad.LogisticsOption.P2P_DIRECT,
            status=Ad.Status.ACTIVE,
            available_from=timezone.now().date(),
            available_until=(timezone.now() + timedelta(days=30)).date()
        )

    def test_ad_creation(self):
        """Test la création d'une annonce"""
        self.assertEqual(self.ad.title, 'Test Annonce')
        self.assertEqual(self.ad.seller.username, 'testuser')
        self.assertEqual(self.ad.status, Ad.Status.ACTIVE)
        self.assertIsNotNone(self.ad.available_from)

    def test_ad_list_view(self):
        """Test la vue de liste des annonces"""
        response = self.client.get(reverse('ads:ad_list'))
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'ads/ad_list.html')
        self.assertContains(response, 'Annonces')

    def test_ad_detail_view(self):
        """Test la vue de détail d'annonce"""
        response = self.client.get(reverse('ads:ad_detail', kwargs={'slug': self.ad.slug}))
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'ads/ad_detail.html')
        self.assertContains(response, 'Test Annonce')

    def test_ad_str_method(self):
        """Test la méthode __str__ de l'annonce"""
        self.assertEqual(str(self.ad), 'Test Annonce - testuser')

    def test_category_str_method(self):
        """Test la méthode __str__ de la catégorie"""
        self.assertEqual(str(self.category), 'Électronique')

    def test_ad_get_absolute_url(self):
        """Test la méthode get_absolute_url de l'annonce"""
        url = self.ad.get_absolute_url()
        # Prendre en compte le préfixe de langue
        expected = f'/ads/{self.ad.slug}/'
        # Si I18N est activé, l'URL aura un préfixe
        if settings.USE_I18N:
            self.assertTrue(url.startswith('/') and url.endswith(f'/ads/{self.ad.slug}/'))
        else:
            self.assertEqual(url, expected)

    def test_category_get_absolute_url(self):
        """Test la méthode get_absolute_url de la catégorie"""
        url = self.category.get_absolute_url()
        expected = f'/ads/categories/{self.category.slug}/'
        # Si I18N est activé, l'URL aura un préfixe
        if settings.USE_I18N:
            self.assertTrue(url.startswith('/') and url.endswith(f'/ads/categories/{self.category.slug}/'))
        else:
            self.assertEqual(url, expected)

    def test_ad_price_with_currency(self):
        """Test la méthode get_price_with_currency"""
        price_str = self.ad.get_price_with_currency()
        # Format attendu : "100.00 €"
        self.assertEqual(price_str, '100.00 €')

    def test_ad_can_be_reserved(self):
        """Test la méthode can_be_reserved"""
        # L'annonce peut être réservée par un autre utilisateur
        other_user = User.objects.create_user(
            username='otheruser',
            password='testpass123',
            role='BUYER'
        )
        self.assertTrue(self.ad.can_be_reserved(other_user))

        # Le vendeur ne peut pas réserver sa propre annonce
        self.assertFalse(self.ad.can_be_reserved(self.user))

        # Une annonce non active ne peut pas être réservée
        self.ad.status = Ad.Status.DRAFT
        self.ad.save()
        self.assertFalse(self.ad.can_be_reserved(other_user))


class CategoryTests(TestCase):
    """Tests spécifiques pour les catégories"""

    def setUp(self):
        self.parent_category = Category.objects.create(
            name='Parent',
            slug='parent',
            is_active=True
        )

        self.child_category = Category.objects.create(
            name='Child',
            slug='child',
            parent=self.parent_category,
            is_active=True
        )

    def test_category_hierarchy(self):
        """Test la hiérarchie des catégories"""
        self.assertEqual(self.child_category.parent, self.parent_category)
        self.assertIn(self.child_category, self.parent_category.children.all())

    def test_category_get_full_path(self):
        """Test la méthode get_full_path"""
        path = self.child_category.get_full_path()
        self.assertEqual(path, 'Parent > Child')


class AdModelTests(TestCase):
    """Tests supplémentaires pour le modèle Ad"""

    def setUp(self):
        self.user = User.objects.create_user(
            username='modeluser',
            password='testpass123',
            role='SELLER'
        )

        self.category = Category.objects.create(
            name='Test Category',
            slug='test-category',
            is_active=True
        )

    def test_ad_slug_generation(self):
        """Test la génération automatique du slug"""
        ad = Ad.objects.create(
            title='Un titre avec des espaces',
            seller=self.user,
            category=self.category,
            description='Description',
            price=50.00,
            currency='EUR',
            country_from='FR',
            city_from='Paris',
            country_to='MA',
            city_to='Casablanca',
            available_from=timezone.now().date()
        )

        # Le slug devrait être généré automatiquement
        self.assertTrue(hasattr(ad, 'slug'))
        self.assertTrue(ad.slug.startswith('un-titre-avec-des-espaces'))

    def test_ad_volume_calculation(self):
        """Test le calcul automatique du volume"""
        ad = Ad.objects.create(
            title='Test Volume',
            seller=self.user,
            category=self.category,
            description='Description',
            price=50.00,
            currency='EUR',
            country_from='FR',
            city_from='Paris',
            country_to='MA',
            city_to='Casablanca',
            length=10,
            width=20,
            height=30,
            available_from=timezone.now().date()
        )

        # Volume = (10 * 20 * 30) / 1000 = 6 litres
        # Mais le calcul se fait dans save(), donc vérifions après rechargement
        ad.refresh_from_db()
        if ad.volume:  # Peut être None si pas calculé
            self.assertEqual(float(ad.volume), 6.0)

    def test_ad_status_transitions(self):
        """Test les transitions de statut"""
        ad = Ad.objects.create(
            title='Test Status',
            seller=self.user,
            category=self.category,
            description='Description',
            price=50.00,
            currency='EUR',
            country_from='FR',
            city_from='Paris',
            country_to='MA',
            city_to='Casablanca',
            available_from=timezone.now().date(),
            status=Ad.Status.DRAFT
        )

        # Vérifier qu'il n'y a pas de date de publication
        self.assertIsNone(ad.published_at)

        # Changer le statut à ACTIVE
        ad.status = Ad.Status.ACTIVE
        ad.save()
        ad.refresh_from_db()

        # Vérifier que published_at a été défini
        self.assertIsNotNone(ad.published_at)

    def test_ad_expiration(self):
        """Test l'expiration automatique"""
        ad = Ad.objects.create(
            title='Test Expiration',
            seller=self.user,
            category=self.category,
            description='Description',
            price=50.00,
            currency='EUR',
            country_from='FR',
            city_from='Paris',
            country_to='MA',
            city_to='Casablanca',
            available_from=timezone.now().date() - timedelta(days=10),
            available_until=timezone.now().date() - timedelta(days=1),  # Hier
            status=Ad.Status.ACTIVE
        )

        # Sauvegarder pour déclencher la logique d'expiration
        ad.save()
        ad.refresh_from_db()

        # L'annonce devrait être marquée comme expirée
        self.assertEqual(ad.status, Ad.Status.EXPIRED)
        self.assertIsNotNone(ad.expired_at)


# Tests de vues avec TransactionTestCase pour éviter les problèmes de DB
class AdsViewTests(TransactionTestCase):
    """Tests des vues avec gestion transactionnelle"""

    def test_empty_ad_list(self):
        """Test la liste d'annonces vide"""
        response = self.client.get(reverse('ads:ad_list'))
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'Aucune annonce')

    def test_search_view(self):
        """Test la vue de recherche"""
        response = self.client.get(reverse('ads:search'), {'q': 'test'})
        self.assertEqual(response.status_code, 200)


========== ads/signals.py ==========
# ~/ebi3/ads/signals.py
from django.db.models.signals import post_save, pre_save, post_delete
from django.dispatch import receiver
from django.utils import timezone
from .models import Ad, AdImage, Favorite

@receiver(pre_save, sender=Ad)
def update_ad_status(sender, instance, **kwargs):
    """Met à jour les dates lors des changements de statut"""
    if instance.pk:
        old_instance = Ad.objects.get(pk=instance.pk)

        # Si l'annonce devient active et n'était pas active avant
        if instance.status == Ad.Status.ACTIVE and old_instance.status != Ad.Status.ACTIVE:
            instance.published_at = timezone.now()

        # Si l'annonce devient expirée
        if instance.status == Ad.Status.EXPIRED and old_instance.status != Ad.Status.EXPIRED:
            instance.expired_at = timezone.now()

@receiver(post_save, sender=AdImage)
def update_paid_images_count(sender, instance, created, **kwargs):
    """Met à jour le compteur d'images payantes"""
    if instance.is_paid and instance.payment_status == 'PAID':
        ad = instance.ad
        ad.paid_images_used = ad.images.filter(is_paid=True, payment_status='PAID').count()
        ad.save(update_fields=['paid_images_used'])

@receiver(post_delete, sender=AdImage)
def cleanup_image_files(sender, instance, **kwargs):
    """Nettoie les fichiers d'image supprimés"""
    # django-cleanup s'en charge automatiquement
    pass


========== ads/templatetags/ads_filters.py ==========
from django import template

register = template.Library()

@register.filter
def get_image_url(image):
    """Retourne l'URL de l'image, priorisant le thumbnail s'il existe"""
    if image and image.image:
        if image.thumbnail and hasattr(image.thumbnail, 'url'):
            try:
                return image.thumbnail.url
            except ValueError:
                return image.image.url
        return image.image.url
    return ''


========== ads/admin.py ==========
# ~/ebi3/ads/admin.py
from django.contrib import admin
from django.utils import timezone
from django.utils.html import format_html
from django.utils.translation import gettext_lazy as _
from django.contrib import messages
from django.urls import reverse
from django.db.models import Count, Avg, Sum, Q
from django.http import HttpResponseRedirect
import csv
from django.http import HttpResponse

from .models import (
    Ad, Category, AdImage, AdVideo, Favorite,
    AdView, AdReport
)

@admin.register(Category)
class CategoryAdmin(admin.ModelAdmin):
    """Administration des catégories"""

    list_display = ('name', 'parent', 'is_active', 'show_in_menu', 'ad_count', 'display_order')
    list_filter = ('is_active', 'show_in_menu', 'created_at')
    search_fields = ('name', 'description', 'slug')
    prepopulated_fields = {'slug': ('name',)}
    readonly_fields = ('created_at', 'updated_at', 'ad_count')

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('name', 'slug', 'parent', 'description')
        }),
        (_('Apparence'), {
            'fields': ('icon', 'image', 'display_order')
        }),
        (_('Visibilité'), {
            'fields': ('is_active', 'show_in_menu')
        }),
        (_('Configuration des annonces'), {
            'fields': ('requires_dimensions', 'requires_weight')
        }),
        (_('SEO'), {
            'fields': ('meta_title', 'meta_description')
        }),
        (_('Statistiques'), {
            'fields': ('ad_count', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION : actions doit être une LISTE de noms de méthodes
    actions = ['activate_categories', 'deactivate_categories', 'show_in_menu_action', 'hide_from_menu_action']

    # ✅ Les méthodes d'action doivent être séparées
    def activate_categories(self, request, queryset):
        """Action pour activer les catégories"""
        updated = queryset.update(is_active=True)
        self.message_user(request, _(f'{updated} catégories ont été activées.'))
    activate_categories.short_description = _('Activer les catégories sélectionnées')

    def deactivate_categories(self, request, queryset):
        """Action pour désactiver les catégories"""
        updated = queryset.update(is_active=False)
        self.message_user(request, _(f'{updated} catégories ont été désactivées.'))
    deactivate_categories.short_description = _('Désactiver les catégories sélectionnées')

    def show_in_menu_action(self, request, queryset):
        """Action pour afficher dans le menu"""
        updated = queryset.update(show_in_menu=True)
        self.message_user(request, _(f'{updated} catégories sont maintenant visibles dans le menu.'))
    show_in_menu_action.short_description = _('Afficher dans le menu')

    def hide_from_menu_action(self, request, queryset):
        """Action pour cacher du menu"""
        updated = queryset.update(show_in_menu=False)
        self.message_user(request, _(f'{updated} catégories sont maintenant cachées du menu.'))
    hide_from_menu_action.short_description = _('Cacher du menu')


class AdImageInline(admin.TabularInline):
    """Inline pour les images d'annonce"""
    model = AdImage
    extra = 1
    fields = ('image', 'thumbnail_preview', 'caption', 'is_primary', 'display_order', 'is_paid', 'payment_status')
    readonly_fields = ('thumbnail_preview',)

    def thumbnail_preview(self, obj):
        if obj.thumbnail:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.thumbnail.url)
        elif obj.image:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.image.url)
        return _("Pas d'image")
    thumbnail_preview.short_description = _('Aperçu')


class AdVideoInline(admin.TabularInline):
    """Inline pour les vidéos d'annonce"""
    model = AdVideo
    extra = 0
    fields = ('video', 'thumbnail_preview', 'caption', 'is_paid', 'payment_status')
    readonly_fields = ('thumbnail_preview',)

    def thumbnail_preview(self, obj):
        if obj.thumbnail:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.thumbnail.url)
        return _("Pas de miniature")
    thumbnail_preview.short_description = _('Aperçu')


@admin.register(Ad)
class AdAdmin(admin.ModelAdmin):
    """Administration des annonces"""

    inlines = [AdImageInline, AdVideoInline]

    list_display = (
        'title', 'seller', 'category', 'price_with_currency',
        'status_badge', 'is_featured', 'view_count',
        'favorite_count', 'created_at'
    )

    list_filter = (
        'status', 'condition', 'logistics_option',
        'is_featured', 'created_at', 'category'
    )

    search_fields = (
        'title', 'description', 'seller__username',
        'seller__email', 'city_from', 'city_to'
    )

    readonly_fields = (
        'slug', 'view_count', 'favorite_count', 'inquiry_count',
        'created_at', 'updated_at', 'published_at', 'expired_at',
        'volume', 'paid_images_used', 'videos_used'
    )

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('title', 'slug', 'seller', 'category', 'description')
        }),
        (_('État et prix'), {
            'fields': ('condition', 'price', 'currency', 'is_negotiable')
        }),
        (_('Dimensions'), {
            'fields': ('weight', 'length', 'width', 'height', 'volume')
        }),
        (_('Origine'), {
            'fields': ('country_from', 'city_from', 'address_from')
        }),
        (_('Destination'), {
            'fields': ('country_to', 'city_to', 'address_to')
        }),
        (_('Logistique'), {
            'fields': ('logistics_option', 'requires_insurance',
                      'insurance_value', 'fragile_item', 'requires_packaging')
        }),
        (_('Disponibilité'), {
            'fields': ('available_from', 'available_until')
        }),
        (_('Statut et promotion'), {
            'fields': ('status', 'is_featured', 'featured_until',
                      'rejection_reason')
        }),
        (_('Multimédia'), {
            'fields': ('free_images_allowed', 'paid_images_used',
                      'videos_allowed', 'videos_used'),
            'classes': ('collapse',)
        }),
        (_('SEO'), {
            'fields': ('meta_keywords', 'meta_description'),
            'classes': ('collapse',)
        }),
        (_('Statistiques'), {
            'fields': ('view_count', 'favorite_count', 'inquiry_count',
                      'created_at', 'updated_at', 'published_at', 'expired_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION IMPORTANTE: actions doit être une LISTE de noms de méthodes
    actions = [
        'approve_ads', 'reject_ads', 'feature_ads', 'unfeature_ads',
        'mark_as_sold', 'mark_as_expired', 'export_to_csv'
    ]

    def price_with_currency(self, obj):
        return f"{obj.price} {obj.get_currency_display()}"
    price_with_currency.short_description = _('Prix')
    price_with_currency.admin_order_field = 'price'

    def status_badge(self, obj):
        status_colors = {
            'DRAFT': 'secondary',
            'PENDING': 'warning',
            'ACTIVE': 'success',
            'RESERVED': 'info',
            'SOLD': 'primary',
            'EXPIRED': 'dark',
            'REJECTED': 'danger',
            'ARCHIVED': 'light'
        }
        color = status_colors.get(obj.status, 'secondary')
        return format_html(
            '<span class="badge bg-{}">{}</span>',
            color, obj.get_status_display()
        )
    status_badge.short_description = _('Statut')

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('seller', 'category')

    # Les méthodes d'action doivent être séparées de la liste 'actions'
    def approve_ads(self, request, queryset):
        """Action pour approuver les annonces"""
        updated = queryset.update(status=Ad.Status.ACTIVE, published_at=timezone.now())
        self.message_user(request, _(f'{updated} annonces ont été approuvées.'))
    approve_ads.short_description = _('Approuver les annonces sélectionnées')

    def reject_ads(self, request, queryset):
        """Action pour rejeter les annonces"""
        for ad in queryset:
            ad.status = Ad.Status.REJECTED
            ad.save()
        self.message_user(request, _(f'{queryset.count()} annonces ont été rejetées.'))
    reject_ads.short_description = _('Rejeter les annonces sélectionnées')

    def feature_ads(self, request, queryset):
        """Action pour mettre en vedette"""
        updated = queryset.update(
            is_featured=True,
            featured_until=timezone.now() + timezone.timedelta(days=7)
        )
        self.message_user(request, _(f'{updated} annonces ont été mises en vedette.'))
    feature_ads.short_description = _('Mettre en vedette')

    def unfeature_ads(self, request, queryset):
        """Action pour retirer de la vedette"""
        updated = queryset.update(is_featured=False, featured_until=None)
        self.message_user(request, _(f'{updated} annonces ne sont plus en vedette.'))
    unfeature_ads.short_description = _('Retirer de la vedette')

    def mark_as_sold(self, request, queryset):
        """Action pour marquer comme vendu"""
        updated = queryset.update(status=Ad.Status.SOLD)
        self.message_user(request, _(f'{updated} annonces ont été marquées comme vendues.'))
    mark_as_sold.short_description = _('Marquer comme vendu')

    def mark_as_expired(self, request, queryset):
        """Action pour marquer comme expiré"""
        updated = queryset.update(status=Ad.Status.EXPIRED, expired_at=timezone.now())
        self.message_user(request, _(f'{updated} annonces ont été marquées comme expirées.'))
    mark_as_expired.short_description = _('Marquer comme expiré')

    def export_to_csv(self, request, queryset):
        """Action pour exporter en CSV"""
        response = HttpResponse(content_type='text/csv')
        response['Content-Disposition'] = 'attachment; filename="annonces.csv"'

        writer = csv.writer(response)
        writer.writerow([
            'ID', 'Titre', 'Vendeur', 'Catégorie', 'Prix', 'Devise',
            'Statut', 'Ville départ', 'Ville destination', 'Vues',
            'Favoris', 'Date création'
        ])

        for ad in queryset:
            writer.writerow([
                ad.id, ad.title, ad.seller.username,
                ad.category.name if ad.category else '',
                ad.price, ad.currency, ad.get_status_display(),
                ad.city_from, ad.city_to, ad.view_count,
                ad.favorite_count, ad.created_at.strftime('%Y-%m-%d %H:%M')
            ])

        return response
    export_to_csv.short_description = _('Exporter en CSV')

    def save_model(self, request, obj, form, change):
        if not obj.pk:
            obj.seller = request.user

        # Si le statut passe à ACTIF et qu'il n'y a pas de date de publication
        if obj.status == Ad.Status.ACTIVE and not obj.published_at:
            obj.published_at = timezone.now()

        super().save_model(request, obj, form, change)


@admin.register(AdImage)
class AdImageAdmin(admin.ModelAdmin):
    """Administration des images d'annonces"""

    list_display = ('ad', 'thumbnail_preview', 'caption', 'is_primary', 'is_paid', 'payment_status', 'created_at')
    list_filter = ('is_primary', 'is_paid', 'payment_status', 'created_at')
    search_fields = ('ad__title', 'caption')
    readonly_fields = ('created_at', 'updated_at')

    # ✅ CORRECTION: actions doit être une liste vide si pas d'actions
    actions = []

    def thumbnail_preview(self, obj):
        if obj.thumbnail:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.thumbnail.url)
        elif obj.image:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.image.url)
        return _("Pas d'image")
    thumbnail_preview.short_description = _('Aperçu')


@admin.register(AdVideo)
class AdVideoAdmin(admin.ModelAdmin):
    """Administration des vidéos d'annonces"""

    list_display = ('ad', 'caption', 'is_paid', 'payment_status', 'created_at')
    list_filter = ('is_paid', 'payment_status', 'created_at')
    search_fields = ('ad__title', 'caption')
    readonly_fields = ('created_at',)

    # ✅ CORRECTION: actions doit être une liste vide si pas d'actions
    actions = []


@admin.register(Favorite)
class FavoriteAdmin(admin.ModelAdmin):
    """Administration des favoris"""

    list_display = ('user', 'ad', 'created_at')
    list_filter = ('created_at',)
    search_fields = ('user__username', 'ad__title')
    readonly_fields = ('created_at',)

    # ✅ CORRECTION: actions doit être une liste vide si pas d'actions
    actions = []

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('user', 'ad')


@admin.register(AdView)
class AdViewAdmin(admin.ModelAdmin):
    """Administration des vues d'annonces"""

    list_display = ('ad', 'user', 'ip_address', 'viewed_at')
    list_filter = ('viewed_at',)
    search_fields = ('ad__title', 'user__username', 'ip_address')
    readonly_fields = ('viewed_at',)

    # ✅ CORRECTION: actions doit être une liste vide si pas d'actions
    actions = []

    def has_add_permission(self, request):
        return False

    def has_change_permission(self, request, obj=None):
        return False


@admin.register(AdReport)
class AdReportAdmin(admin.ModelAdmin):
    """Administration des signalements d'annonces"""

    list_display = ('ad', 'reporter', 'reason', 'status', 'created_at')
    list_filter = ('reason', 'status', 'created_at')
    search_fields = ('ad__title', 'reporter__username', 'description')
    list_editable = ('status',)
    readonly_fields = ('created_at',)

    fieldsets = (
        (_('Signalement'), {
            'fields': ('ad', 'reporter', 'reason', 'description', 'evidence')
        }),
        (_('Traitement'), {
            'fields': ('status', 'admin_notes', 'resolved_by', 'resolved_at')
        }),
        (_('Métadonnées'), {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION: actions doit être une liste de noms de méthodes
    actions = ['mark_as_resolved', 'mark_as_dismissed']

    def mark_as_resolved(self, request, queryset):
        """Action pour marquer comme résolu"""
        updated = queryset.update(
            status='RESOLVED',  # Note: Utiliser la valeur littérale
            resolved_by=request.user,
            resolved_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} signalements ont été résolus.'))
    mark_as_resolved.short_description = _('Marquer comme résolu')

    def mark_as_dismissed(self, request, queryset):
        """Action pour rejeter les signalements"""
        updated = queryset.update(
            status='DISMISSED',  # Note: Utiliser la valeur littérale
            resolved_by=request.user,
            resolved_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} signalements ont été rejetés.'))
    mark_as_dismissed.short_description = _('Rejeter les signalements')

    def save_model(self, request, obj, form, change):
        if obj.status in ['RESOLVED', 'DISMISSED'] and not obj.resolved_by:
            obj.resolved_by = request.user
            obj.resolved_at = timezone.now()
        super().save_model(request, obj, form, change)


========== ads/forms.py ==========
from django import forms
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import ValidationError
from django.forms import inlineformset_factory
from django.utils import timezone
from django_countries.fields import CountryField

from .models import Ad, AdImage, Category, AdReport
from users.models import User

class AdBaseForm(forms.ModelForm):
    """Formulaire de base pour les annonces"""

    # Nouveaux champs pour la sélection hiérarchique
    main_category = forms.ModelChoiceField(
        required=True,
        queryset=Category.objects.filter(
            is_active=True
        ).exclude(
            name__in=[
                # Liste des catégories qui sont clairement des sous-catégories
                'Voitures', 'Motos & Scooters', 'Utilitaires & Poids lourds',
                'Ventes immobilières', 'Locations', 'Immobilier neuf',
                'Offres emploi', 'Services à la personne',
                'Vêtements femmes', 'Vêtements hommes', 'Chaussures',
                'Informatique', 'Téléphonie', 'Image & Son',
                'Ameublement', 'Électroménager', 'Décoration',
                'Sports & Plein air', 'Jeux & Jouets', 'Livres & Magazines',
                'BTP & Chantier', 'Agriculture & Espaces verts',
                'Services professionnels', 'Événements & Animation',
                'Accessoires animaux', 'Cuisine & Arts de la table',
                'Jardin & Extérieur', 'Caravanes & Mobil-homes',
                'Nautisme', 'Pièces & Accessoires auto',
                'Bien-être & Santé', 'Collection', 'Luxe & Créateurs',
                'Commerce & Magasin', 'Travaux & Rénovation',
                'Transport & Manutention', 'Transport & Déménagement',
                'Informatique & Web', 'Industrie & Production',
                'Matériel Professionnel', 'Photo & Vidéo',
                'Instruments de musique', 'Vêtements enfants'
            ]
        ).order_by('name'),
        label=_("Catégorie principale *"),
        widget=forms.Select(attrs={
            'class': 'form-control',
            'id': 'id_main_category'
        }),
        help_text=_("Sélectionnez une catégorie principale")
    )

    sub_category = forms.ModelChoiceField(
        required=False,
        queryset=Category.objects.none(),
        label=_("Sous-catégorie"),
        widget=forms.Select(attrs={
            'class': 'form-control',
            'id': 'id_sub_category',
            'disabled': True
        }),
        help_text=_("Sélectionnez une sous-catégorie (optionnel)")
    )

    class Meta:
        model = Ad
        fields = [
            'title', 'category', 'description', 'condition',
            'price', 'currency', 'is_negotiable',
            'weight', 'length', 'width', 'height',
            'country_from', 'city_from', 'address_from',
            'country_to', 'city_to', 'address_to',
            'logistics_option', 'requires_insurance',
            'insurance_value', 'fragile_item', 'requires_packaging',
            'available_from', 'available_until',
        ]
        widgets = {
            'title': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Titre de votre annonce")
            }),
            'category': forms.HiddenInput(attrs={'id': 'id_category'}),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 6,
                'placeholder': _("Décrivez votre objet en détail...")
            }),
            'condition': forms.Select(attrs={'class': 'form-control'}),
            'price': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
            'currency': forms.Select(attrs={'class': 'form-control'}),
            'weight': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.001',
                'placeholder': _("kg")
            }),
            'length': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.1',
                'placeholder': _("cm")
            }),
            'width': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.1',
                'placeholder': _("cm")
            }),
            'height': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.1',
                'placeholder': _("cm")
            }),
            'country_from': forms.Select(attrs={'class': 'form-control'}),
            'city_from': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Ville de départ")
            }),
            'address_from': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _("Adresse complète (optionnel)")
            }),
            'country_to': forms.Select(attrs={'class': 'form-control'}),
            'city_to': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Ville de destination")
            }),
            'address_to': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _("Adresse complète (optionnel)")
            }),
            'logistics_option': forms.Select(attrs={'class': 'form-control'}),
            'insurance_value': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
            'available_from': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
            'available_until': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
        }
        labels = {
            'is_negotiable': _("Prix négociable"),
            'requires_insurance': _("Assurance requise"),
            'fragile_item': _("Objet fragile"),
            'requires_packaging': _("Emballage requis"),
        }

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        # Rendre le champ category optionnel pour le formulaire HTML
        # La validation se fera dans la méthode clean
        self.fields['category'].required = False

        # Réorganiser l'ordre des champs pour mettre la catégorie en premier
        field_order = ['title', 'main_category', 'sub_category'] + [f for f in self.fields if f not in ['title', 'main_category', 'sub_category']]
        self.fields = {f: self.fields[f] for f in field_order}

        # Si c'est une modification, pré-remplir les champs
        if self.instance.pk and self.instance.category:
            category = self.instance.category

            # Trouver la catégorie principale
            main_cat = None
            if category.parent:
                # Si la catégorie a un parent
                if category.parent.parent:
                    # Si le parent a aussi un parent, prendre le grand-parent
                    main_cat = category.parent.parent
                else:
                    # Sinon, prendre le parent comme catégorie principale
                    main_cat = category.parent
            else:
                # Si pas de parent, c'est déjà une catégorie principale
                main_cat = category

            if main_cat:
                self.fields['main_category'].initial = main_cat

                # Charger les sous-catégories de la catégorie principale
                subcategories = Category.objects.filter(
                    parent=main_cat,
                    is_active=True
                ).order_by('display_order', 'name')

                self.fields['sub_category'].queryset = subcategories

                # Pré-sélectionner la sous-catégorie si elle existe
                if category.parent == main_cat:
                    self.fields['sub_category'].initial = category
                elif category == main_cat:
                    # Si c'est déjà la catégorie principale, pas de sous-catégorie
                    pass
                elif category in subcategories:
                    # Si c'est une sous-catégorie directe
                    self.fields['sub_category'].initial = category

                # Activer le champ sub_category s'il y a des sous-catégories
                if subcategories.exists():
                    self.fields['sub_category'].disabled = False

        # Définir les dates par défaut
        if not self.instance.pk:
            self.fields['available_from'].initial = timezone.now().date()
            self.fields['available_until'].initial = (timezone.now() + timezone.timedelta(days=30)).date()

    def clean(self):
        cleaned_data = super().clean()

        # Récupérer la catégorie depuis le champ caché
        category_id = cleaned_data.get('category')
        main_category = cleaned_data.get('main_category')
        sub_category = cleaned_data.get('sub_category')

        debug_info = {
            'category_id': category_id,
            'main_category': main_category.id if main_category else None,
            'sub_category': sub_category.id if sub_category else None,
        }
        print("DEBUG - Données de catégorie:", debug_info)

        # Déterminer la catégorie finale
        final_category = None

        # Si une sous-catégorie est sélectionnée, l'utiliser
        if sub_category:
            final_category = sub_category
            print("DEBUG - Utilisation de la sous-catégorie:", sub_category.id, sub_category.name)
        # Sinon, utiliser la catégorie principale
        elif main_category:
            final_category = main_category
            print("DEBUG - Utilisation de la catégorie principale:", main_category.id, main_category.name)
        # Sinon, utiliser le champ caché (pour compatibilité)
        elif category_id:
            try:
                final_category = Category.objects.get(id=category_id)
                print("DEBUG - Utilisation du champ caché:", final_category.id, final_category.name)
            except Category.DoesNotExist:
                pass

        # Valider que nous avons une catégorie
        if not final_category:
            print("DEBUG - ERREUR: Aucune catégorie trouvée")
            raise ValidationError({
                'main_category': _("Veuillez sélectionner une catégorie principale.")
            })

        # S'assurer que la catégorie est active
        if not final_category.is_active:
            print("DEBUG - ERREUR: Catégorie inactive")
            raise ValidationError({
                'main_category': _("Cette catégorie n'est pas disponible.")
            })

        # Mettre à jour les données nettoyées
        cleaned_data['category'] = final_category
        print("DEBUG - Catégorie finale définie:", final_category.id, final_category.name)

        return cleaned_data

    def clean_available_until(self):
        available_from = self.cleaned_data.get('available_from')
        available_until = self.cleaned_data.get('available_until')

        if available_from and available_until:
            if available_until < available_from:
                raise ValidationError(
                    _("La date de fin doit être postérieure à la date de début.")
                )
            if available_until < timezone.now().date():
                raise ValidationError(
                    _("La date de fin ne peut pas être dans le passé.")
                )

        return available_until

    def clean_price(self):
        price = self.cleaned_data.get('price')
        if price and price <= 0:
            raise ValidationError(_("Le prix doit être supérieur à 0."))
        return price


class AdCreateForm(AdBaseForm):
    """Formulaire pour créer une annonce"""

    def save(self, commit=True):
        ad = super().save(commit=False)
        if self.user:
            ad.seller = self.user

        if commit:
            ad.save()
        return ad


class AdUpdateForm(AdBaseForm):
    """Formulaire pour mettre à jour une annonce"""
    pass


class AdImageForm(forms.ModelForm):
    """Formulaire pour les images d'annonces"""

    class Meta:
        model = AdImage
        fields = ['image', 'caption', 'is_primary', 'is_paid', 'display_order']
        widgets = {
            'image': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*'
            }),
            'caption': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Description de l'image")
            }),
            'display_order': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': 0
            }),
        }


# Formset pour les images
AdImageFormSet = inlineformset_factory(
    Ad,
    AdImage,
    form=AdImageForm,
    extra=5,  # 5 formulaires d'image vides par défaut
    max_num=20,  # Maximum d'images
    can_delete=True,
    validate_max=True,
)


class AdSearchForm(forms.Form):
    """Formulaire de recherche d'annonces"""

    q = forms.CharField(
        required=False,
        label=_("Rechercher"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Que cherchez-vous ?")
        })
    )

    category = forms.ModelChoiceField(
        required=False,
        queryset=Category.objects.filter(is_active=True),
        label=_("Catégorie"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    min_price = forms.DecimalField(
        required=False,
        min_value=0,
        decimal_places=2,
        label=_("Prix minimum"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Min")
        })
    )

    max_price = forms.DecimalField(
        required=False,
        min_value=0,
        decimal_places=2,
        label=_("Prix maximum"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Max")
        })
    )

    condition = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous"))] + list(Ad.Condition.choices),
        label=_("État"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    logistics_option = forms.ChoiceField(
        required=False,
        choices=[('', _("Toutes"))] + list(Ad.LogisticsOption.choices),
        label=_("Option logistique"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    # CORRECTION : Utiliser CountryField directement pour le formfield
    country_from = CountryField().formfield(
        required=False,
        label=_("Pays de départ"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    country_to = CountryField().formfield(
        required=False,
        label=_("Pays de destination"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    def clean(self):
        cleaned_data = super().clean()
        min_price = cleaned_data.get('min_price')
        max_price = cleaned_data.get('max_price')

        if min_price and max_price and min_price > max_price:
            raise ValidationError(
                _("Le prix minimum ne peut pas être supérieur au prix maximum.")
            )

        return cleaned_data


class AdReportForm(forms.ModelForm):
    """Formulaire pour signaler une annonce"""

    class Meta:
        model = AdReport
        fields = ['reason', 'description', 'evidence']
        widgets = {
            'reason': forms.Select(attrs={'class': 'form-control'}),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _("Décrivez le problème en détail...")
            }),
            'evidence': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*,.pdf,.doc,.docx'
            }),
        }


========== ads/management/commands/generate_thumbnails.py ==========
from django.core.management.base import BaseCommand
from ads.models import AdImage
from PIL import Image
import os
from io import BytesIO
from django.core.files.base import ContentFile

class Command(BaseCommand):
    help = 'Génère les thumbnails manquantes pour toutes les AdImage'

    def handle(self, *args, **options):
        # Récupérer toutes les images sans thumbnail
        images = AdImage.objects.filter(thumbnail__isnull=True).exclude(image__isnull=True)

        total = images.count()
        self.stdout.write(f"Génération des thumbnails pour {total} images...")

        success = 0
        errors = 0

        for i, ad_image in enumerate(images, 1):
            try:
                if ad_image.image:
                    # Ouvrir l'image originale
                    img = Image.open(ad_image.image.path)

                    # Calculer les dimensions de la miniature (200x200)
                    img.thumbnail((200, 200))

                    # Préparer le nom du fichier thumbnail
                    thumb_name, thumb_extension = os.path.splitext(ad_image.image.name)
                    thumb_extension = thumb_extension.lower()
                    thumb_filename = thumb_name + '_thumb' + thumb_extension

                    # Déterminer le format
                    if thumb_extension in ['.jpg', '.jpeg']:
                        FTYPE = 'JPEG'
                    elif thumb_extension == '.gif':
                        FTYPE = 'GIF'
                    elif thumb_extension == '.png':
                        FTYPE = 'PNG'
                    elif thumb_extension == '.webp':
                        FTYPE = 'WEBP'
                    else:
                        FTYPE = 'JPEG'

                    # Convertir en RGB si nécessaire
                    if img.mode in ('RGBA', 'LA') or (img.mode == 'P' and 'transparency' in img.info):
                        background = Image.new('RGB', img.size, (255, 255, 255))
                        background.paste(img, mask=img.split()[-1] if img.mode == 'RGBA' else None)
                        img = background

                    # Sauvegarder dans un buffer
                    temp_thumb = BytesIO()
                    img.save(temp_thumb, FTYPE, quality=85)
                    temp_thumb.seek(0)

                    # Sauvegarder la miniature
                    ad_image.thumbnail.save(
                        thumb_filename,
                        ContentFile(temp_thumb.read()),
                        save=False
                    )
                    temp_thumb.close()

                    # Sauvegarder l'objet
                    ad_image.save()

                    success += 1
                    self.stdout.write(f"[{i}/{total}] ✓ Miniature générée pour l'image {ad_image.id}")

            except FileNotFoundError:
                self.stdout.write(f"[{i}/{total}] ✗ Fichier image non trouvé pour l'image {ad_image.id}")
                errors += 1
            except Exception as e:
                self.stdout.write(f"[{i}/{total}] ✗ Erreur pour l'image {ad_image.id}: {str(e)}")
                errors += 1

        self.stdout.write(self.style.SUCCESS(
            f"Terminé ! {success} succès, {errors} erreurs"
        ))


========== ads/management/commands/update_ad_counts.py ==========
# ads/management/commands/update_ad_counts.py
from django.core.management.base import BaseCommand
from ads.models import Category, Ad

class Command(BaseCommand):
    help = 'Met à jour les compteurs d\'annonces pour toutes les catégories'

    def handle(self, *args, **kwargs):
        categories = Category.objects.all()

        for category in categories:
            old_count = category.ad_count
            category.update_ad_count()
            category.refresh_from_db()

            if old_count != category.ad_count:
                self.stdout.write(
                    self.style.SUCCESS(f'Catégorie {category.name}: {old_count} → {category.ad_count}')
                )

        self.stdout.write(self.style.SUCCESS('Compteurs mis à jour avec succès!'))


========== ads/__init__.py ==========



========== ads/apps.py ==========
# ~/ebi3/ads/apps.py
from django.apps import AppConfig

class AdsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'ads'
    verbose_name = "Annonces"

    def ready(self):
        import ads.signals  # Import des signaux


========== ads/urls.py ==========
# ~/ebi3/ads/urls.py - MODIFIER

from django.urls import path
from . import views

app_name = 'ads'

urlpatterns = [
    # Annonces
    path('', views.AdListView.as_view(), name='ad_list'),
    path('create/', views.AdCreateView.as_view(), name='ad_create'),
    path('search/', views.search_ads, name='search'),
    path('my-ads/', views.MyAdsListView.as_view(), name='my_ads'),

    # API pour les catégories
    path('api/categories/', views.get_categories, name='get_categories'),

    # Annonce spécifique
    path('<slug:slug>/', views.AdDetailView.as_view(), name='ad_detail'),
    path('<slug:slug>/edit/', views.AdUpdateView.as_view(), name='ad_edit'),
    path('<slug:slug>/delete/', views.AdDeleteView.as_view(), name='ad_delete'),
    path('<slug:slug>/report/', views.AdReportView.as_view(), name='ad_report'),
    path('<slug:slug>/favorite/', views.toggle_favorite, name='toggle_favorite'),
    path('<slug:slug>/status/<str:status>/', views.change_ad_status, name='change_status'),

    # Nouvelle intégration avec logistics
    path('<slug:slug>/reserve/', views.AdDetailView.as_view(), name='ad_reserve'),
    path('<slug:slug>/propose-transport/', views.AdDetailView.as_view(), name='ad_propose_transport'),
    path('<slug:slug>/transport-proposals/', views.AdTransportProposalsView.as_view(), name='ad_transport_proposals'),

    # Catégories
    path('categories/', views.CategoryListView.as_view(), name='category_list'),
    path('categories/<slug:slug>/', views.CategoryDetailView.as_view(), name='category_detail'),

    # Favoris
    path('favorites/', views.FavoriteListView.as_view(), name='favorite_list'),
]


========== ads/models.py ==========
# ~/ebi3/ads/models.py
from django.db import models
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import ValidationError
from django.utils.text import slugify
from django.urls import reverse
from django.utils import timezone
from django.core.validators import FileExtensionValidator
import os
import uuid
from mptt.models import MPTTModel, TreeForeignKey
from django_countries.fields import CountryField

# Validateurs personnalisés
def validate_file_size(value):
    """Validateur pour la taille maximale des fichiers (10MB)"""
    filesize = value.size
    max_size = 10 * 1024 * 1024  # 10MB
    if filesize > max_size:
        raise ValidationError(
            _(f'La taille du fichier ne doit pas dépasser {max_size / (1024 * 1024):.0f}MB')
        )

def validate_video_size(value):
    """Validateur pour la taille maximale des vidéos (100MB)"""
    filesize = value.size
    max_size = 100 * 1024 * 1024  # 100MB
    if filesize > max_size:
        raise ValidationError(
            _(f'La taille de la vidéo ne doit pas dépasser {max_size / (1024 * 1024):.0f}MB')
        )


class Category(MPTTModel):
    name = models.CharField(
        max_length=200,
        verbose_name=_("Nom de la catégorie"),
        db_index=True
    )
    slug = models.SlugField(
        max_length=200,
        unique=True,
        verbose_name=_("Slug"),
        help_text=_("URL-friendly version du nom")
    )
    description = models.TextField(
        blank=True,
        verbose_name=_("Description"),
        help_text=_("Description détaillée de la catégorie")
    )
    parent = TreeForeignKey(
        'self',
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='children',
        verbose_name=_("Catégorie parente"),
        help_text=_("Sélectionnez une catégorie parente si applicable")
    )
    icon = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Icône FontAwesome"),
        help_text=_("Exemple: fa-mobile, fa-car, fa-home")
    )
    image = models.ImageField(
        upload_to='categories/',
        null=True,
        blank=True,
        verbose_name=_("Image de la catégorie")
    )
    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Active"),
        help_text=_("Désactiver pour cacher la catégorie")
    )
    show_in_menu = models.BooleanField(
        default=True,
        verbose_name=_("Afficher dans le menu")
    )
    display_order = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Ordre d'affichage"),
        help_text=_("Plus le nombre est bas, plus c'est prioritaire")
    )
    requires_dimensions = models.BooleanField(
        default=False,
        verbose_name=_("Requiert dimensions"),
        help_text=_("Les annonces de cette catégorie doivent avoir des dimensions")
    )
    requires_weight = models.BooleanField(
        default=True,
        verbose_name=_("Requiert poids"),
        help_text=_("Les annonces de cette catégorie doivent avoir un poids")
    )
    meta_title = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Titre SEO")
    )
    meta_description = models.TextField(
        blank=True,
        verbose_name=_("Description SEO")
    )
    ad_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre d'annonces")
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class MPTTMeta:
        order_insertion_by = ['display_order', 'name']

    class Meta:
        verbose_name = _("Catégorie")
        verbose_name_plural = _("Catégories")
        ordering = ['display_order', 'name']
        indexes = [
            models.Index(fields=['slug', 'is_active']),
            models.Index(fields=['parent', 'is_active']),
        ]

    def __str__(self):
        return self.name

    def get_absolute_url(self):
        return reverse('ads:category_detail', kwargs={'slug': self.slug})

    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(self.name)
        super().save(*args, **kwargs)

    def get_full_path(self):
        ancestors = self.get_ancestors(include_self=True)
        return " > ".join([cat.name for cat in ancestors])

    def update_ad_count(self):
        """Met à jour le compteur d'annonces sans import circulaire"""
        from .models import Ad  # Import local pour éviter les problèmes
        count = self.ads.filter(status=Ad.Status.ACTIVE).count()
        # Mise à jour directe en base pour éviter la récursion
        Category.objects.filter(pk=self.pk).update(ad_count=count)

# Dans ~/ebi3/ads/models.py, classe AdImage

def save(self, *args, **kwargs):
    super().save(*args, **kwargs)

    # Générer la miniature si elle n'existe pas
    if self.image and not self.thumbnail:
        from PIL import Image
        import os
        from django.core.files.base import ContentFile

        # Ouvrir l'image originale
        img = Image.open(self.image.path)

        # Calculer les dimensions de la miniature (200x200)
        img.thumbnail((200, 200))

        # Préparer le nom du fichier thumbnail
        thumb_name, thumb_extension = os.path.splitext(self.image.name)
        thumb_extension = thumb_extension.lower()
        thumb_filename = thumb_name + '_thumb' + thumb_extension

        # Sauvegarder la miniature
        if thumb_extension in ['.jpg', '.jpeg']:
            FTYPE = 'JPEG'
        elif thumb_extension == '.gif':
            FTYPE = 'GIF'
        elif thumb_extension == '.png':
            FTYPE = 'PNG'
        else:
            FTYPE = 'JPEG'  # Par défaut

        temp_thumb = BytesIO()
        img.save(temp_thumb, FTYPE)
        temp_thumb.seek(0)

        # Sauvegarder dans le champ thumbnail
        self.thumbnail.save(
            thumb_filename,
            ContentFile(temp_thumb.read()),
            save=False
        )
        temp_thumb.close()

        super().save(*args, **kwargs)


class Ad(models.Model):
    class Status(models.TextChoices):
        DRAFT = 'DRAFT', _('Brouillon')
        PENDING = 'PENDING', _('En attente de validation')
        ACTIVE = 'ACTIVE', _('Active')
        RESERVED = 'RESERVED', _('Réservée')
        SOLD = 'SOLD', _('Vendue')
        EXPIRED = 'EXPIRED', _('Expirée')
        REJECTED = 'REJECTED', _('Rejetée')
        ARCHIVED = 'ARCHIVED', _('Archivée')

    class Condition(models.TextChoices):
        NEW = 'NEW', _('Neuf')
        LIKE_NEW = 'LIKE_NEW', _('Comme neuf')
        GOOD = 'GOOD', _('Bon état')
        FAIR = 'FAIR', _('État correct')
        POOR = 'POOR', _('Mauvais état')
        FOR_PARTS = 'FOR_PARTS', _('Pour pièces')

    class LogisticsOption(models.TextChoices):
        P2P_DIRECT = 'P2P_DIRECT', _('Vente directe (P2P)')
        WITH_CARRIER = 'WITH_CARRIER', _('Avec transporteur')
        WITH_EXPAT_CARRIER = 'WITH_EXPAT_CARRIER', _('Avec expatrié-transporteur')

    seller = models.ForeignKey(
        'users.User',
        on_delete=models.CASCADE,
        related_name='ads',
        verbose_name=_("Vendeur")
    )
    category = TreeForeignKey(
        Category,
        on_delete=models.SET_NULL,
        null=True,
        related_name='ads',
        verbose_name=_("Catégorie")
    )
    title = models.CharField(
        max_length=200,
        verbose_name=_("Titre de l'annonce"),
        db_index=True
    )
    slug = models.SlugField(
        max_length=200,
        unique=True,
        db_index=True,
        verbose_name=_("Slug")
    )
    description = models.TextField(
        verbose_name=_("Description détaillée"),
        help_text=_("Décrivez votre objet en détail")
    )
    condition = models.CharField(
        max_length=20,
        choices=Condition.choices,
        default=Condition.GOOD,
        verbose_name=_("État de l'objet")
    )
    price = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_("Prix"),
        help_text=_("Prix en devise de départ")
    )
    currency = models.CharField(
        max_length=3,
        default='EUR',
        choices=[
            ('EUR', '€'),
            ('USD', '$'),
            ('GBP', '£'),
            ('MAD', 'DH'),
            ('XOF', 'CFA'),
        ],
        verbose_name=_("Devise")
    )
    is_negotiable = models.BooleanField(
        default=False,
        verbose_name=_("Prix négociable")
    )
    weight = models.DecimalField(
        max_digits=8,
        decimal_places=3,
        null=True,
        blank=True,
        verbose_name=_("Poids (kg)"),
        help_text=_("Poids en kilogrammes")
    )
    length = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        null=True,
        blank=True,
        verbose_name=_("Longueur (cm)")
    )
    width = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        null=True,
        blank=True,
        verbose_name=_("Largeur (cm)")
    )
    height = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        null=True,
        blank=True,
        verbose_name=_("Hauteur (cm)")
    )
    volume = models.DecimalField(
        max_digits=10,
        decimal_places=3,
        null=True,
        blank=True,
        editable=False,
        verbose_name=_("Volume (L)")
    )
    country_from = CountryField(
        verbose_name=_("Pays de départ"),
        help_text=_("Pays où se trouve l'objet")
    )
    city_from = models.CharField(
        max_length=100,
        verbose_name=_("Ville de départ")
    )
    address_from = models.TextField(
        blank=True,
        verbose_name=_("Adresse de départ")
    )
    latitude_from = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Latitude départ")
    )
    longitude_from = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Longitude départ")
    )
    country_to = CountryField(
        verbose_name=_("Pays de destination"),
        help_text=_("Pays où l'objet doit être livré")
    )
    city_to = models.CharField(
        max_length=100,
        verbose_name=_("Ville de destination")
    )
    address_to = models.TextField(
        blank=True,
        verbose_name=_("Adresse de destination")
    )
    latitude_to = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Latitude destination")
    )
    longitude_to = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Longitude destination")
    )
    logistics_option = models.CharField(
        max_length=20,
        choices=LogisticsOption.choices,
        default=LogisticsOption.P2P_DIRECT,
        verbose_name=_("Option logistique")
    )
    requires_insurance = models.BooleanField(
        default=False,
        verbose_name=_("Requiert assurance")
    )
    insurance_value = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        null=True,
        blank=True,
        verbose_name=_("Valeur assurée")
    )
    fragile_item = models.BooleanField(
        default=False,
        verbose_name=_("Objet fragile")
    )
    requires_packaging = models.BooleanField(
        default=False,
        verbose_name=_("Requiert emballage")
    )
    available_from = models.DateField(
        verbose_name=_("Disponible à partir du"),
        help_text=_("Date à partir de laquelle l'objet est disponible"),
        default=timezone.now,  # ✅ Référence, pas appel
    )
    available_until = models.DateField(  # ⚠️ CORRIGÉ : virgule manquante ajoutée
        verbose_name=_("Disponible jusqu'au"),
        help_text=_("Date limite de disponibilité"),
        null=True,
        blank=True,
    )
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.DRAFT,
        verbose_name=_("Statut"),
        db_index=True
    )
    is_featured = models.BooleanField(
        default=False,
        verbose_name=_("Annonce en vedette")
    )
    featured_until = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("En vedette jusqu'au")
    )
    rejection_reason = models.TextField(
        blank=True,
        verbose_name=_("Raison du rejet")
    )
    meta_keywords = models.CharField(
        max_length=500,
        blank=True,
        verbose_name=_("Mots-clés SEO")
    )
    meta_description = models.TextField(
        blank=True,
        verbose_name=_("Description SEO")
    )
    view_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre de vues")
    )
    favorite_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre de favoris")
    )
    inquiry_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre de demandes")
    )
    free_images_allowed = models.PositiveIntegerField(
        default=3,
        verbose_name=_("Nombre de photos gratuites")
    )
    paid_images_used = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Photos payantes utilisées")
    )
    videos_allowed = models.BooleanField(
        default=False,
        verbose_name=_("Vidéos autorisées")
    )
    videos_used = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Vidéos utilisées")
    )
    created_at = models.DateTimeField(auto_now_add=True, db_index=True)
    updated_at = models.DateTimeField(auto_now=True, db_index=True)
    published_at = models.DateTimeField(null=True, blank=True)
    expired_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        verbose_name = _("Annonce")
        verbose_name_plural = _("Annonces")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status', 'created_at']),
            models.Index(fields=['seller', 'status']),
            models.Index(fields=['country_from', 'country_to']),
            models.Index(fields=['price', 'status']),
            models.Index(fields=['category', 'status']),
        ]
        permissions = [
            ('can_feature_ad', 'Peut mettre en vedette une annonce'),
            ('can_moderate_ad', 'Peut modérer les annonces'),
            ('can_view_statistics', 'Peut voir les statistiques'),
        ]

    def __str__(self):
        return f"{self.title} - {self.seller.username}"

    def save(self, *args, **kwargs):
        if not self.slug:
            base_slug = slugify(self.title)
            self.slug = base_slug
            counter = 1
            while Ad.objects.filter(slug=self.slug).exists():
                self.slug = f"{base_slug}-{counter}"
                counter += 1

        if self.length and self.width and self.height:
            self.volume = (self.length * self.width * self.height) / 1000

        if self.status == self.Status.ACTIVE and not self.published_at:
            self.published_at = timezone.now()

        if self.available_until and self.available_until < timezone.now().date():
            if self.status == self.Status.ACTIVE:
                self.status = self.Status.EXPIRED
                self.expired_at = timezone.now()

        super().save(*args, **kwargs)

        if self.category:
            self.category.update_ad_count()

    def get_absolute_url(self):
        return reverse('ads:ad_detail', kwargs={'slug': self.slug})

    def get_price_with_currency(self):
        return f"{self.price} {self.get_currency_display()}"

    def calculate_total_images(self):
        return self.images.count()

    def calculate_free_images_remaining(self):
        return max(0, self.free_images_allowed - self.images.filter(is_paid=False).count())

    def is_available_for_carrier(self):
        return self.status == self.Status.ACTIVE and self.logistics_option in [
            self.LogisticsOption.WITH_CARRIER,
            self.LogisticsOption.WITH_EXPAT_CARRIER
        ]

    def can_be_reserved(self, user):
        if user == self.seller:
            return False
        if self.status != self.Status.ACTIVE:
            return False
        return True


def ad_image_upload_path(instance, filename):
    ext = filename.split('.')[-1]
    filename = f"{uuid.uuid4()}.{ext}"
    return f"ads/{instance.ad.seller.username}/{instance.ad.slug}/images/{filename}"


class AdImage(models.Model):
    ad = models.ForeignKey(
        Ad,
        on_delete=models.CASCADE,
        related_name='images',
        verbose_name=_("Annonce")
    )
    image = models.ImageField(
        upload_to=ad_image_upload_path,
        verbose_name=_("Image"),
        validators=[
            FileExtensionValidator(['jpg', 'jpeg', 'png', 'webp']),
            validate_file_size,
        ]
    )
    thumbnail = models.ImageField(
        upload_to='ads/thumbnails/',
        null=True,
        blank=True,
        editable=False,
        verbose_name=_("Miniature")
    )
    caption = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Légende")
    )
    is_primary = models.BooleanField(
        default=False,
        verbose_name=_("Image principale")
    )
    is_paid = models.BooleanField(
        default=False,
        verbose_name=_("Image payante")
    )
    payment_status = models.CharField(
        max_length=20,
        choices=[
            ('FREE', _('Gratuite')),
            ('PAID', _('Payée')),
            ('PENDING', _('En attente')),
            ('FAILED', _('Échouée')),
        ],
        default='FREE',
        verbose_name=_("Statut du paiement")
    )
    payment_reference = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Référence de paiement")
    )
    display_order = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Ordre d'affichage")
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Image d'annonce")
        verbose_name_plural = _("Images d'annonces")
        ordering = ['is_primary', 'display_order', 'created_at']
        constraints = [
            models.UniqueConstraint(
                fields=['ad'],
                condition=models.Q(is_primary=True),
                name='unique_primary_image_per_ad'
            )
        ]

    def __str__(self):
        return f"Image pour {self.ad.title}"

    def save(self, *args, **kwargs):
        if not self.ad.images.exists() and not self.is_primary:
            self.is_primary = True
        if self.is_primary:
            AdImage.objects.filter(ad=self.ad, is_primary=True).exclude(pk=self.pk).update(is_primary=False)
        super().save(*args, **kwargs)


def ad_video_upload_path(instance, filename):
    ext = filename.split('.')[-1]
    filename = f"{uuid.uuid4()}.{ext}"
    return f"ads/{instance.ad.seller.username}/{instance.ad.slug}/videos/{filename}"


class AdVideo(models.Model):
    ad = models.ForeignKey(
        Ad,
        on_delete=models.CASCADE,
        related_name='videos',
        verbose_name=_("Annonce")
    )
    video = models.FileField(
        upload_to=ad_video_upload_path,
        verbose_name=_("Vidéo"),
        validators=[
            FileExtensionValidator(['mp4', 'avi', 'mov', 'wmv', 'webm']),
            validate_video_size,
        ]
    )
    thumbnail = models.ImageField(
        upload_to='ads/video_thumbnails/',
        null=True,
        blank=True,
        editable=False,
        verbose_name=_("Miniature vidéo")
    )
    caption = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Légende")
    )
    duration = models.DurationField(
        null=True,
        blank=True,
        verbose_name=_("Durée")
    )
    is_paid = models.BooleanField(
        default=True,
        verbose_name=_("Vidéo payante")
    )
    payment_status = models.CharField(
        max_length=20,
        choices=[
            ('PAID', _('Payée')),
            ('PENDING', _('En attente')),
            ('FAILED', _('Échouée')),
        ],
        default='PENDING',
        verbose_name=_("Statut du paiement")
    )
    payment_reference = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Référence de paiement")
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Vidéo d'annonce")
        verbose_name_plural = _("Vidéos d'annonces")

    def __str__(self):
        return f"Vidéo pour {self.ad.title}"


class Favorite(models.Model):
    user = models.ForeignKey(
        'users.User',
        on_delete=models.CASCADE,
        related_name='favorites',
        verbose_name=_("Utilisateur")
    )
    ad = models.ForeignKey(
        Ad,
        on_delete=models.CASCADE,
        related_name='favorited_by',
        verbose_name=_("Annonce")
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Favori")
        verbose_name_plural = _("Favoris")
        unique_together = ['user', 'ad']
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.user.username} aime {self.ad.title}"

    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)
        self.ad.favorite_count = self.ad.favorited_by.count()
        self.ad.save(update_fields=['favorite_count'])

    def delete(self, *args, **kwargs):
        ad = self.ad
        super().delete(*args, **kwargs)
        ad.favorite_count = ad.favorited_by.count()
        ad.save(update_fields=['favorite_count'])


class AdView(models.Model):
    ad = models.ForeignKey(
        Ad,
        on_delete=models.CASCADE,
        related_name='views_tracking',
        verbose_name=_("Annonce")
    )
    user = models.ForeignKey(
        'users.User',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='ad_views',
        verbose_name=_("Utilisateur")
    )
    session_key = models.CharField(
        max_length=40,
        db_index=True,
        verbose_name=_("Clé de session")
    )
    ip_address = models.GenericIPAddressField(
        null=True,
        blank=True,
        verbose_name=_("Adresse IP")
    )
    user_agent = models.TextField(
        blank=True,
        verbose_name=_("User Agent")
    )
    referer = models.URLField(
        blank=True,
        verbose_name=_("Referer")
    )
    viewed_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Vue d'annonce")
        verbose_name_plural = _("Vues d'annonces")
        indexes = [
            models.Index(fields=['ad', 'viewed_at']),
            models.Index(fields=['session_key', 'ad']),
            models.Index(fields=['user', 'viewed_at']),
        ]

    def __str__(self):
        return f"Vue de {self.ad.title} à {self.viewed_at}"


class AdReport(models.Model):
    class ReportReason(models.TextChoices):
        SPAM = 'SPAM', _('Spam ou publicité')
        FRAUD = 'FRAUD', _('Fraude ou arnaque')
        INAPPROPRIATE = 'INAPPROPRIATE', _('Contenu inapproprié')
        WRONG_CATEGORY = 'WRONG_CATEGORY', _('Mauvaise catégorie')
        PROHIBITED = 'PROHIBITED', _('Article prohibé')
        DUPLICATE = 'DUPLICATE', _('Annonce en double')
        OTHER = 'OTHER', _('Autre')

    ad = models.ForeignKey(
        Ad,
        on_delete=models.CASCADE,
        related_name='reports',
        verbose_name=_("Annonce")
    )
    reporter = models.ForeignKey(
        'users.User',
        on_delete=models.SET_NULL,
        null=True,
        related_name='ad_reports',
        verbose_name=_("Signaleur")
    )
    reason = models.CharField(
        max_length=20,
        choices=ReportReason.choices,
        verbose_name=_("Raison du signalement")
    )
    description = models.TextField(
        blank=True,
        verbose_name=_("Description détaillée")
    )
    evidence = models.FileField(
        upload_to='reports/',
        null=True,
        blank=True,
        verbose_name=_("Preuve")
    )
    status = models.CharField(
        max_length=20,
        choices=[
            ('PENDING', _('En attente')),
            ('IN_REVIEW', _('En revue')),
            ('RESOLVED', _('Résolu')),
            ('DISMISSED', _('Rejeté')),
        ],
        default='PENDING',
        verbose_name=_("Statut")
    )
    admin_notes = models.TextField(
        blank=True,
        verbose_name=_("Notes de l'administrateur")
    )
    resolved_by = models.ForeignKey(
        'users.User',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='resolved_ad_reports',
        verbose_name=_("Résolu par")
    )
    resolved_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Résolu le")
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Signalement d'annonce")
        verbose_name_plural = _("Signalements d'annonces")
        ordering = ['-created_at']

    def __str__(self):
        return f"Signalement de {self.ad.title}"


========== ads/views.py ==========
# ~/ebi3/ads/views.py
from django.shortcuts import render, get_object_or_404, redirect
from django.db.models import Sum
from django.contrib.auth.decorators import login_required
from django.contrib.auth.mixins import LoginRequiredMixin
from django.views.generic import (
    ListView, DetailView, CreateView,
    UpdateView, DeleteView, TemplateView
)
from django.db.models import Sum, Count, Q, Avg, F
from django.utils import timezone
from django.urls import reverse_lazy
from django.contrib import messages
from django.utils.translation import gettext_lazy as _
from django.core.paginator import Paginator
from django.http import JsonResponse, HttpResponseForbidden
from django.views.decorators.http import require_POST
from django.views.decorators.csrf import csrf_protect
from django.db import transaction
from django.db import models

from .models import Category, Ad, AdImage, Favorite, AdView, AdReport
from .forms import (
    AdCreateForm, AdUpdateForm,
    AdImageFormSet, AdSearchForm,
    AdReportForm
)
from users.models import User
from django.views.decorators.http import require_GET


class CategoryListView(ListView):
    """Liste des catégories"""
    model = Category
    template_name = 'ads/category_list.html'
    context_object_name = 'categories'

    def get_queryset(self):
        return Category.objects.filter(
            is_active=True,
            show_in_menu=True
        ).annotate(
            active_ads_count=Count('ads', filter=Q(ads__status=Ad.Status.ACTIVE))
        ).filter(
            active_ads_count__gt=0
        )


class CategoryDetailView(DetailView):
    """Détail d'une catégorie avec ses annonces"""
    model = Category
    template_name = 'ads/category_detail.html'
    context_object_name = 'category'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        category = self.object

        # Récupérer toutes les sous-catégories
        subcategories = category.get_descendants(include_self=False).filter(
            is_active=True
        )

        # Récupérer les annonces actives de cette catégorie et ses sous-catégories
        ads = Ad.objects.filter(
            category__in=subcategories.union(Category.objects.filter(pk=category.pk)),
            status=Ad.Status.ACTIVE
        ).select_related('seller', 'category').prefetch_related('images')

        # Appliquer les filtres
        form = AdSearchForm(self.request.GET)
        if form.is_valid():
            if form.cleaned_data.get('min_price'):
                ads = ads.filter(price__gte=form.cleaned_data['min_price'])
            if form.cleaned_data.get('max_price'):
                ads = ads.filter(price__lte=form.cleaned_data['max_price'])
            if form.cleaned_data.get('condition'):
                ads = ads.filter(condition=form.cleaned_data['condition'])
            if form.cleaned_data.get('logistics_option'):
                ads = ads.filter(logistics_option=form.cleaned_data['logistics_option'])
            if form.cleaned_data.get('country_from'):
                ads = ads.filter(country_from=form.cleaned_data['country_from'])
            if form.cleaned_data.get('country_to'):
                ads = ads.filter(country_to=form.cleaned_data['country_to'])

        # Pagination
        paginator = Paginator(ads, 20)  # 20 annonces par page
        page = self.request.GET.get('page')
        ads_page = paginator.get_page(page)

        context.update({
            'subcategories': subcategories,
            'ads': ads_page,
            'search_form': form,
            'total_ads': ads.count(),
        })
        return context


from django.db.models import Count, Q
from ads.models import Ad, Category
from ads.forms import AdSearchForm

class AdListView(ListView):
    """Liste de toutes les annonces"""
    model = Ad
    template_name = 'ads/ad_list.html'
    context_object_name = 'ads'
    paginate_by = 20

    def get_queryset(self):
        queryset = Ad.objects.filter(
            status=Ad.Status.ACTIVE
        ).select_related('seller', 'category').prefetch_related('images')

        # Appliquer les filtres
        form = AdSearchForm(self.request.GET)
        if form.is_valid():
            if form.cleaned_data.get('category'):
                category = form.cleaned_data['category']
                # Inclure les sous-catégories
                subcategories = category.get_descendants(include_self=True)
                queryset = queryset.filter(category__in=subcategories)

            if form.cleaned_data.get('q'):
                search_term = form.cleaned_data['q']
                queryset = queryset.filter(
                    Q(title__icontains=search_term) |
                    Q(description__icontains=search_term)
                )

            if form.cleaned_data.get('min_price'):
                queryset = queryset.filter(price__gte=form.cleaned_data['min_price'])
            if form.cleaned_data.get('max_price'):
                queryset = queryset.filter(price__lte=form.cleaned_data['max_price'])
            if form.cleaned_data.get('condition'):
                queryset = queryset.filter(condition=form.cleaned_data['condition'])
            if form.cleaned_data.get('logistics_option'):
                queryset = queryset.filter(logistics_option=form.cleaned_data['logistics_option'])
            if form.cleaned_data.get('country_from'):
                queryset = queryset.filter(country_from=form.cleaned_data['country_from'])
            if form.cleaned_data.get('country_to'):
                queryset = queryset.filter(country_to=form.cleaned_data['country_to'])

        # Tri
        sort_by = self.request.GET.get('sort', '-created_at')
        if sort_by in ['price', '-price', 'created_at', '-created_at', 'view_count', '-view_count']:
            queryset = queryset.order_by(sort_by)

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['search_form'] = AdSearchForm(self.request.GET)
        context['total_ads'] = self.get_queryset().count()

        # ✅ CORRECTION: Ajouter les catégories au contexte avec comptage des annonces actives
        context['categories'] = Category.objects.filter(
            is_active=True,
            ad_count__gt=0  # Filtre les catégories qui ont des annonces
        ).order_by('-ad_count', 'name')[:10]

        # Stats pour les filtres
        from django.db.models import Min, Max
        context['min_price_range'] = Ad.objects.filter(status=Ad.Status.ACTIVE).aggregate(Min('price'))['price__min'] or 0
        context['max_price_range'] = Ad.objects.filter(status=Ad.Status.ACTIVE).aggregate(Max('price'))['price__max'] or 10000

        return context


class AdDetailView(DetailView):
    """Détail d'une annonce"""
    model = Ad
    template_name = 'ads/ad_detail.html'
    context_object_name = 'ad'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        ad = self.object

        # Enregistrer la vue
        if self.request.user.is_authenticated:
            AdView.objects.create(
                ad=ad,
                user=self.request.user,
                session_key=self.request.session.session_key,
                ip_address=self.request.META.get('REMOTE_ADDR'),
                user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
                referer=self.request.META.get('HTTP_REFERER', '')
            )
        else:
            AdView.objects.create(
                ad=ad,
                session_key=self.request.session.session_key,
                ip_address=self.request.META.get('REMOTE_ADDR'),
                user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
                referer=self.request.META.get('HTTP_REFERER', '')
            )

        # Annonces similaires
        similar_ads = Ad.objects.filter(
            category=ad.category,
            status=Ad.Status.ACTIVE
        ).exclude(pk=ad.pk).select_related('seller').prefetch_related('images')[:4]

        # Vérifier si l'annonce est dans les favoris de l'utilisateur
        is_favorite = False
        if self.request.user.is_authenticated:
            is_favorite = Favorite.objects.filter(
                user=self.request.user,
                ad=ad
            ).exists()

        context.update({
            'similar_ads': similar_ads,
            'is_favorite': is_favorite,
            'can_edit': self.request.user == ad.seller or self.request.user.is_staff,
            'can_report': self.request.user.is_authenticated and self.request.user != ad.seller,
        })
        return context


class AdCreateView(LoginRequiredMixin, CreateView):
    """Création d'une annonce"""
    model = Ad
    form_class = AdCreateForm
    template_name = 'ads/ad_create.html'

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['user'] = self.request.user
        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # ✅ AJOUTER LES CATÉGORIES AU CONTEXTE
        # Catégories principales (sans parent)
        context['main_categories'] = Category.objects.filter(
            parent__isnull=True,
            is_active=True
        ).order_by('display_order', 'name')

        # ✅ TOUTES les catégories pour la sélection directe
        context['all_categories'] = Category.objects.filter(
            is_active=True
        ).order_by('lft')  # Utilisez 'lft' pour l'ordre hiérarchique

        if self.request.POST:
            context['image_formset'] = AdImageFormSet(self.request.POST, self.request.FILES)
        else:
            context['image_formset'] = AdImageFormSet()

        return context

    def form_valid(self, form):
        context = self.get_context_data()
        image_formset = context['image_formset']

        with transaction.atomic():
            form.instance.seller = self.request.user
            self.object = form.save()

            if image_formset.is_valid():
                images = image_formset.save(commit=False)
                for image in images:
                    image.ad = self.object
                    image.save()

                # Vérifier le nombre d'images gratuites vs payantes
                free_images_count = sum(1 for img in images if not img.is_paid)
                if free_images_count > self.object.free_images_allowed:
                    messages.warning(
                        self.request,
                        _(f"Vous avez téléchargé {free_images_count} images gratuites, "
                          f"mais seulement {self.object.free_images_allowed} sont autorisées gratuitement. "
                          f"Les images supplémentaires seront marquées comme payantes.")
                    )

            else:
                return self.form_invalid(form)

        messages.success(self.request, _("Votre annonce a été créée avec succès !"))
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('ads:ad_detail', kwargs={'slug': self.object.slug})


class AdUpdateView(LoginRequiredMixin, UpdateView):
    """Modification d'une annonce"""
    model = Ad
    form_class = AdUpdateForm
    template_name = 'ads/ad_update.html'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'

    def dispatch(self, request, *args, **kwargs):
        ad = self.get_object()
        if ad.seller != request.user and not request.user.is_staff:
            messages.error(request, _("Vous n'êtes pas autorisé à modifier cette annonce."))
            return redirect('ads:ad_detail', slug=ad.slug)
        return super().dispatch(request, *args, **kwargs)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        if self.request.POST:
            context['image_formset'] = AdImageFormSet(
                self.request.POST, self.request.FILES,
                instance=self.object
            )
        else:
            context['image_formset'] = AdImageFormSet(instance=self.object)
        return context

    def form_valid(self, form):
        context = self.get_context_data()
        image_formset = context['image_formset']

        with transaction.atomic():
            self.object = form.save()

            if image_formset.is_valid():
                images = image_formset.save(commit=False)
                for image in images:
                    image.ad = self.object
                    image.save()

                # Supprimer les images marquées pour suppression
                for obj in image_formset.deleted_objects:
                    obj.delete()
            else:
                return self.form_invalid(form)

        messages.success(self.request, _("Votre annonce a été mise à jour avec succès !"))
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('ads:ad_detail', kwargs={'slug': self.object.slug})


class AdDeleteView(LoginRequiredMixin, DeleteView):
    """Suppression d'une annonce"""
    model = Ad
    template_name = 'ads/ad_delete.html'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'
    success_url = reverse_lazy('ads:ad_list')

    def dispatch(self, request, *args, **kwargs):
        ad = self.get_object()
        if ad.seller != request.user and not request.user.is_staff:
            messages.error(request, _("Vous n'êtes pas autorisé à supprimer cette annonce."))
            return redirect('ads:ad_detail', slug=ad.slug)
        return super().dispatch(request, *args, **kwargs)

    def delete(self, request, *args, **kwargs):
        messages.success(request, _("L'annonce a été supprimée avec succès."))
        return super().delete(request, *args, **kwargs)


@require_GET
def get_categories(request):
    """API pour récupérer les catégories dynamiquement"""
    parent_id = request.GET.get('parent_id')
    level = request.GET.get('level', 'sub')  # main, sub

    if level == 'main':
        # Utiliser l'utilitaire pour les catégories principales
        from .utils import get_main_categories
        categories = get_main_categories()

    elif level == 'sub' and parent_id:
        # Sous-catégorie directes
        categories = Category.objects.filter(
            parent_id=parent_id,
            is_active=True
        ).order_by('display_order', 'name')

        # Si aucune sous-catégorie directe, chercher les "petits-enfants"
        if not categories.exists():
            # Chercher les catégories dont le parent a comme parent parent_id
            sub_categories = Category.objects.filter(
                parent__isnull=False,
                parent__parent_id=parent_id,
                is_active=True
            ).order_by('display_order', 'name')

            categories = sub_categories

    else:
        categories = Category.objects.none()

    # Formater la réponse
    data = [{
        'id': cat.id,
        'name': cat.name,
        'has_children': cat.children.filter(is_active=True).exists(),
        'icon': cat.icon or '',
        'description': cat.description or '',
        'ad_count': cat.ad_count
    } for cat in categories]

    return JsonResponse({'categories': data})



@login_required
@require_POST
def toggle_favorite(request, slug):
    """Ajouter/retirer une annonce des favoris"""
    ad = get_object_or_404(Ad, slug=slug)

    favorite, created = Favorite.objects.get_or_create(
        user=request.user,
        ad=ad
    )

    if not created:
        favorite.delete()
        action = 'removed'
    else:
        action = 'added'

    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        return JsonResponse({
            'status': 'success',
            'action': action,
            'favorite_count': ad.favorite_count
        })

    messages.success(request, _(f"Annonce {action} aux favoris."))
    return redirect('ads:ad_detail', slug=slug)


class FavoriteListView(LoginRequiredMixin, ListView):
    """Liste des annonces favorites"""
    model = Favorite
    template_name = 'ads/favorite_list.html'
    context_object_name = 'favorites'

    def get_queryset(self):
        return Favorite.objects.filter(
            user=self.request.user
        ).select_related('ad', 'ad__seller', 'ad__category').prefetch_related('ad__images')


class AdReportView(LoginRequiredMixin, CreateView):
    """Signaler une annonce"""
    model = AdReport
    form_class = AdReportForm
    template_name = 'ads/ad_report.html'

    def dispatch(self, request, *args, **kwargs):
        self.ad = get_object_or_404(Ad, slug=kwargs['slug'])

        # Empêcher l'utilisateur de signaler sa propre annonce
        if request.user == self.ad.seller:
            messages.error(request, _("Vous ne pouvez pas signaler votre propre annonce."))
            return redirect('ads:ad_detail', slug=self.ad.slug)

        # Vérifier si l'utilisateur a déjà signalé cette annonce
        if AdReport.objects.filter(ad=self.ad, reporter=request.user).exists():
            messages.warning(request, _("Vous avez déjà signalé cette annonce."))
            return redirect('ads:ad_detail', slug=self.ad.slug)

        return super().dispatch(request, *args, **kwargs)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['ad'] = self.ad
        return context

    def form_valid(self, form):
        form.instance.ad = self.ad
        form.instance.reporter = self.request.user

        messages.success(
            self.request,
            _("Votre signalement a été soumis. Nous l'examinerons sous 24 heures.")
        )
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('ads:ad_detail', kwargs={'slug': self.ad.slug})


class MyAdsListView(LoginRequiredMixin, ListView):
    """Liste des annonces de l'utilisateur"""
    model = Ad
    template_name = 'ads/my_ads.html'
    context_object_name = 'ads'
    paginate_by = 10

    def get_queryset(self):
        return Ad.objects.filter(
            seller=self.request.user
        ).select_related('category').prefetch_related('images').order_by('-created_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Statistiques
        stats = Ad.objects.filter(seller=self.request.user).aggregate(
            total=Count('id'),
            active=Count('id', filter=Q(status=Ad.Status.ACTIVE)),
            draft=Count('id', filter=Q(status=Ad.Status.DRAFT)),
            sold=Count('id', filter=Q(status=Ad.Status.SOLD)),
            reserved=Count('id', filter=Q(status=Ad.Status.RESERVED)),
            total_views=Sum('view_count'),
            total_favorites=Sum('favorite_count'),
        )

        context.update(stats)
        return context


@login_required
@require_POST
def change_ad_status(request, slug, status):
    """Changer le statut d'une annonce"""
    ad = get_object_or_404(Ad, slug=slug, seller=request.user)

    if status not in dict(Ad.Status.choices):
        messages.error(request, _("Statut invalide."))
        return redirect('ads:my_ads')

    previous_status = ad.status
    ad.status = status

    if status == Ad.Status.ACTIVE and not ad.published_at:
        ad.published_at = timezone.now()

    ad.save()

    # FORCER la mise à jour du compteur de la catégorie
    if ad.category:
        ad.category.update_ad_count()

    messages.success(
        request,
        _(f"Statut de l'annonce changé de {previous_status} à {status}.")
    )

    return redirect('ads:ad_detail', slug=slug)


def search_ads(request):
    """Recherche avancée d'annonces"""
    form = AdSearchForm(request.GET)
    ads = Ad.objects.filter(status=Ad.Status.ACTIVE)

    if form.is_valid():
        if form.cleaned_data.get('q'):
            search_term = form.cleaned_data['q']
            ads = ads.filter(
                Q(title__icontains=search_term) |
                Q(description__icontains=search_term)
            )

        if form.cleaned_data.get('category'):
            category = form.cleaned_data['category']
            subcategories = category.get_descendants(include_self=True)
            ads = ads.filter(category__in=subcategories)

        if form.cleaned_data.get('min_price'):
            ads = ads.filter(price__gte=form.cleaned_data['min_price'])
        if form.cleaned_data.get('max_price'):
            ads = ads.filter(price__lte=form.cleaned_data['max_price'])
        if form.cleaned_data.get('condition'):
            ads = ads.filter(condition=form.cleaned_data['condition'])
        if form.cleaned_data.get('logistics_option'):
            ads = ads.filter(logistics_option=form.cleaned_data['logistics_option'])
        if form.cleaned_data.get('country_from'):
            ads = ads.filter(country_from=form.cleaned_data['country_from'])
        if form.cleaned_data.get('country_to'):
            ads = ads.filter(country_to=form.cleaned_data['country_to'])

    # Pagination
    paginator = Paginator(ads, 20)
    page = request.GET.get('page')
    ads_page = paginator.get_page(page)

    context = {
        'ads': ads_page,
        'search_form': form,
        'total_ads': ads.count(),
    }

    return render(request, 'ads/search_results.html', context)

# ads/views.py - AJOUTER à la fin du fichier

class AdTransportProposalsView(LoginRequiredMixin, DetailView):
    """Vue pour voir les propositions de transport pour une annonce"""
    model = Ad
    template_name = 'ads/ad_transport_proposals.html'
    context_object_name = 'ad'

    def dispatch(self, request, *args, **kwargs):
        # Vérifier que l'utilisateur est le vendeur
        ad = self.get_object()
        if ad.seller != request.user:
            messages.error(request, _("Vous n'êtes pas autorisé à voir les propositions de transport."))
            return redirect('ads:ad_detail', slug=ad.slug)
        return super().dispatch(request, *args, **kwargs)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        ad = self.object

        # Ici vous récupéreriez les propositions de transport depuis l'app logistics
        # Pour l'instant, retourner un contexte vide
        context['transport_proposals'] = []
        return context


@login_required
def ad_reserve(request, slug):
    """Réservation d'une annonce"""
    ad = get_object_or_404(Ad, slug=slug)

    if not ad.can_be_reserved(request.user):
        messages.error(request, _("Cette annonce ne peut pas être réservée."))
        return redirect('ads:ad_detail', slug=slug)

    # Logique de réservation temporaire
    messages.success(request, _("Réservation effectuée avec succès !"))
    return redirect('ads:ad_detail', slug=slug)


@login_required
def ad_propose_transport(request, slug):
    """Proposer un transport pour une annonce"""
    ad = get_object_or_404(Ad, slug=slug)

    if request.user == ad.seller:
        messages.error(request, _("Vous ne pouvez pas proposer un transport pour votre propre annonce."))
        return redirect('ads:ad_detail', slug=slug)

    # Logique de proposition de transport temporaire
    messages.info(request, _("Fonctionnalité de proposition de transport à implémenter."))
    return redirect('ads:ad_detail', slug=slug)


========== carriers/templates/carriers/apply.html ==========
{# ~/ebi3/carriers/templates/carriers/apply.html #}
{% extends 'carriers/base_carriers.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Devenir transporteur" %} - Ebi3{% endblock %}

{% block carriers_content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="fas fa-truck"></i> {% trans "Devenir transporteur Ebi3" %}
                </h2>
            </div>

            <div class="card-body p-4">
                <!-- Vérification du profil utilisateur -->
                {% if user.is_authenticated %}
                    {% if user.carrier_profile %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            {% trans "Vous avez déjà un profil transporteur." %}
                            <a href="{% url 'carriers:carrier_dashboard' %}" class="alert-link">
                                {% trans "Accéder au tableau de bord" %}
                            </a>
                        </div>
                    {% else %}
                        <!-- CORRECTION: Ajouter le username dans l'URL -->
                        {% if not user.profile.is_complete %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                {% trans "Vous devez compléter votre profil avant de devenir transporteur." %}
                                <!-- CORRIGER ICI -->
                                <a href="{% url 'users:profile_edit' user.username %}" class="alert-link">
                                    {% trans "Compléter mon profil" %}
                                </a>
                            </div>
                        {% endif %}

                        <!-- Étapes du processus -->
                        <div class="steps mb-5">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h5>{% trans "Profil utilisateur" %}</h5>
                                    <p>{% trans "Complétez vos informations personnelles" %}</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h5>{% trans "Formulaire transporteur" %}</h5>
                                    <p>{% trans "Remplissez le formulaire ci-dessous" %}</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h5>{% trans "Documents" %}</h5>
                                    <p>{% trans "Téléchargez vos documents" %}</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h5>{% trans "Vérification" %}</h5>
                                    <p>{% trans "Validation par notre équipe" %}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Formulaire de candidature -->
                        {% if user.profile.is_complete %}
                            <form method="post" enctype="multipart/form-data" id="carrier-application-form">
                                {% csrf_token %}

                                <h4 class="mb-4">
                                    <i class="fas fa-file-alt"></i> {% trans "Formulaire de candidature" %}
                                </h4>

                                {{ form|crispy }}

                                <div class="card mb-4">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-file-upload"></i> {% trans "Documents (optionnel)" %}
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        {{ document_formset.management_form }}
                                        {% for form in document_formset %}
                                            <div class="document-form mb-3 p-3 border rounded">
                                                {{ form|crispy }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="checkbox" id="terms" required>
                                    <label class="form-check-label" for="terms">
                                        {% trans "J'accepte les" %}
                                        <a href="{% url 'legal:terms' %}" target="_blank">{% trans "conditions générales" %}</a>
                                        {% trans "et la" %}
                                        <a href="{% url 'legal:privacy' %}" target="_blank">{% trans "politique de confidentialité" %}</a>.
                                    </label>
                                </div>


                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="{% url 'carriers:carrier_list' %}" class="btn btn-secondary me-md-2">
                                        <i class="fas fa-times"></i> {% trans "Annuler" %}
                                    </a>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-paper-plane"></i> {% trans "Soumettre ma candidature" %}
                                    </button>
                                </div>
                            </form>
                        {% else %}
                            <div class="alert alert-warning text-center">
                                <i class="fas fa-user-circle fa-3x mb-3"></i>
                                <h4>{% trans "Profil incomplet" %}</h4>
                                <p>{% trans "Veuillez d'abord compléter votre profil utilisateur." %}</p>
                                <!-- CORRIGER ICI -->
                                <a href="{% url 'users:profile_edit' user.username %}" class="btn btn-primary mt-3">
                                    <i class="fas fa-user-edit"></i> {% trans "Compléter mon profil" %}
                                </a>
                            </div>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-lock fa-3x mb-3"></i>
                        <h4>{% trans "Accès non autorisé" %}</h4>
                        <p>{% trans "Vous devez être connecté pour devenir transporteur." %}</p>
                        <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-primary mt-3">
                            <i class="fas fa-sign-in-alt"></i> {% trans "Se connecter" %}
                        </a>
                    </div>
                {% endif %}
            </div>

            <div class="card-footer bg-light">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <i class="fas fa-shield-alt fa-2x text-primary mb-2"></i>
                        <h6>{% trans "Sécurisé" %}</h6>
                        <small class="text-muted">{% trans "Données protégées" %}</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <i class="fas fa-clock fa-2x text-primary mb-2"></i>
                        <h6>{% trans "Rapide" %}</h6>
                        <small class="text-muted">{% trans "Validation en 48h" %}</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <i class="fas fa-headset fa-2x text-primary mb-2"></i>
                        <h6>{% trans "Support" %}</h6>
                        <small class="text-muted">{% trans "Assistance 7j/7" %}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin: 40px 0;
}

.steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 10%;
    right: 10%;
    height: 3px;
    background: #e9ecef;
    z-index: 1;
}

.step {
    text-align: center;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    background: #6c757d;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 auto 10px;
}

.step.active .step-number {
    background: #007bff;
}

.step.completed .step-number {
    background: #28a745;
}

.step-content {
    max-width: 150px;
    margin: 0 auto;
}

.step-content h5 {
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.step-content p {
    font-size: 0.8rem;
    color: #6c757d;
}

.document-form {
    background: #f8f9fa;
}

.document-form:hover {
    background: #e9ecef;
}

.alert-link {
    text-decoration: underline;
    font-weight: bold;
}

.card {
    border-radius: 15px;
    overflow: hidden;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}
</style>

<script>
$(document).ready(function() {
    // Animation des étapes
    $('.step').hover(function() {
        $(this).find('.step-number').css('transform', 'scale(1.1)');
    }, function() {
        $(this).find('.step-number').css('transform', 'scale(1)');
    });

    // Validation du formulaire
    $('#carrier-application-form').submit(function(e) {
        if (!$('#terms').is(':checked')) {
            e.preventDefault();
            alert('{% trans "Vous devez accepter les conditions générales." %}');
            $('#terms').focus();
        }
    });
});
</script>
{% endblock %}


========== carriers/templates/carriers/carrier_list.html ==========
{# ~/ebi3/carriers/templates/carriers/carrier_list.html #}
{% extends 'carriers/base_carriers.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Transporteurs" %} - Ebi3{% endblock %}

{% block carriers_content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>{% trans "Transporteurs disponibles" %}</h1>
            <div>
                <a href="{% url 'carriers:search' %}" class="btn btn-outline-primary">
                    <i class="fas fa-search"></i> {% trans "Recherche avancée" %}
                </a>
                {% if user.is_authenticated and not user.carrier_profile %}
                    <a href="{% url 'carriers:apply' %}" class="btn btn-primary">
                        <i class="fas fa-truck"></i> {% trans "Devenir transporteur" %}
                    </a>
                {% elif user.is_authenticated and user.carrier_profile %}
                    <a href="{% url 'carriers:carrier_dashboard' %}" class="btn btn-success">
                        <i class="fas fa-tachometer-alt"></i> {% trans "Tableau de bord" %}
                    </a>
                {% endif %}
            </div>
        </div>
        <p class="text-muted">
            {% blocktranslate count total_carriers=total_carriers %}
                {{ total_carriers }} transporteur disponible
            {% plural %}
                {{ total_carriers }} transporteurs disponibles
            {% endblocktranslate %}
            ({{ professional_count }} {% trans "professionnels" %}, {{ personal_count }} {% trans "particuliers" %})
        </p>
    </div>
</div>

<div class="row">
    <!-- Sidebar de filtres -->
    <div class="col-md-3 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-filter"></i> {% trans "Filtres" %}</h5>
            </div>
            <div class="card-body">
                <form method="get" id="filter-form">
                    {{ search_form|crispy }}

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i> {% trans "Filtrer" %}
                        </button>
                        <a href="{% url 'carriers:carrier_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> {% trans "Effacer" %}
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> {% trans "Statistiques" %}</h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div class="stats-number">{{ professional_count }}</div>
                    <p class="text-muted">{% trans "Transporteurs professionnels" %}</p>

                    <div class="stats-number">{{ personal_count }}</div>
                    <p class="text-muted">{% trans "Transporteurs particuliers" %}</p>

                    <div class="stats-number">{{ carriers|length|default:"0" }}</div>
                    <p class="text-muted">{% trans "Résultats trouvés" %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des transporteurs -->
    <div class="col-md-9">
        <!-- Tri -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <span class="text-muted">
                            {% blocktranslate with count=page_obj.paginator.count %}
                                {{ count }} résultats
                            {% endblocktranslate %}
                        </span>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown">
                                <i class="fas fa-sort"></i> {% trans "Trier par" %}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="?sort_by=rating">{% trans "Meilleure note" %}</a></li>
                                <li><a class="dropdown-item" href="?sort_by=price">{% trans "Prix le plus bas" %}</a></li>
                                <li><a class="dropdown-item" href="?sort_by=experience">{% trans "Plus d'expérience" %}</a></li>
                                <li><a class="dropdown-item" href="?sort_by=newest">{% trans "Plus récent" %}</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transporteurs -->
        {% if carriers %}
            <div class="row">
                {% for carrier in carriers %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        {% include 'carriers/partials/carrier_card.html' with carrier=carrier %}
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        {{ num }}
                                    </a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-truck fa-4x text-muted mb-3"></i>
                    <h3>{% trans "Aucun transporteur trouvé" %}</h3>
                    <p class="text-muted">
                        {% trans "Essayez de modifier vos critères de recherche ou" %}
                        <a href="{% url 'carriers:carrier_list' %}">{% trans "consultez tous les transporteurs" %}</a>.
                    </p>
                    {% if user.is_authenticated and not user.carrier_profile %}
                        <a href="{% url 'carriers:apply' %}" class="btn btn-primary mt-3">
                            <i class="fas fa-truck"></i> {% trans "Devenir le premier transporteur" %}
                        </a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}


========== carriers/templates/carriers/partials/carrier_card.html ==========
{# ~/ebi3/carriers/templates/carriers/partials/carrier_card.html #}
{% load i18n %}
<div class="card carrier-card h-100">
    <div class="card-body">
        <!-- En-tête avec avatar et informations -->
        <div class="d-flex align-items-start mb-3">
            <div class="flex-shrink-0">
                <div class="carrier-avatar bg-primary text-white d-flex align-items-center justify-content-center">
                    <span style="font-size: 1.5rem; font-weight: bold;">
                        {{ carrier.user.username|first|upper }}
                    </span>
                </div>
            </div>
            <div class="flex-grow-1 ms-3">
                <h5 class="card-title mb-1">
                    <a href="{% url 'carriers:carrier_detail' carrier.user.username %}"
                       class="text-decoration-none text-dark">
                        {% if carrier.carrier_type == 'PROFESSIONAL' and carrier.company_name %}
                            {{ carrier.company_name }}
                        {% else %}
                            {{ carrier.user.username }}
                        {% endif %}
                    </a>
                </h5>

                <div class="d-flex flex-wrap gap-1 mb-2">
                    <span class="carrier-type-badge badge
                                {% if carrier.carrier_type == 'PROFESSIONAL' %}bg-primary
                                {% else %}bg-info{% endif %}">
                        {{ carrier.get_carrier_type_display }}
                    </span>

                    <span class="badge bg-secondary">
                        <i class="fas fa-car"></i> {{ carrier.get_vehicle_type_display }}
                    </span>

                    {% if carrier.verification_level >= 3 %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle"></i> {% trans "Vérifié" %}
                        </span>
                    {% endif %}
                </div>

                <!-- Note -->
                <div class="rating-stars mb-2">
                    {% for i in "12345" %}
                        {% if forloop.counter <= carrier.average_rating %}
                            <i class="fas fa-star"></i>
                        {% else %}
                            <i class="far fa-star"></i>
                        {% endif %}
                    {% endfor %}
                    <small class="text-muted ms-1">
                        ({{ carrier.average_rating|floatformat:1 }})
                    </small>
                </div>
            </div>
        </div>

        <!-- Capacités -->
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-6">
                    <div class="capacity-badge p-2 rounded text-center">
                        <small class="d-block text-muted">{% trans "Poids max" %}</small>
                        <strong>{{ carrier.max_weight }} kg</strong>
                    </div>
                </div>
                <div class="col-6">
                    <div class="capacity-badge p-2 rounded text-center">
                        <small class="d-block text-muted">{% trans "Volume max" %}</small>
                        <strong>{{ carrier.max_volume }} m³</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Services -->
        <div class="mb-3">
            <small class="text-muted d-block mb-1">{% trans "Services inclus :" %}</small>
            <div class="d-flex flex-wrap gap-1">
                {% if carrier.provides_insurance %}
                    <span class="badge bg-success">
                        <i class="fas fa-shield-alt"></i> {% trans "Assurance" %}
                    </span>
                {% endif %}
                {% if carrier.provides_packaging %}
                    <span class="badge bg-info">
                        <i class="fas fa-box"></i> {% trans "Emballage" %}
                    </span>
                {% endif %}
                {% if carrier.provides_loading %}
                    <span class="badge bg-warning">
                        <i class="fas fa-arrow-up"></i> {% trans "Chargement" %}
                    </span>
                {% endif %}
                {% if carrier.provides_unloading %}
                    <span class="badge bg-warning">
                        <i class="fas fa-arrow-down"></i> {% trans "Déchargement" %}
                    </span>
                {% endif %}
            </div>
        </div>

        <!-- Routes disponibles -->
        {% with carrier.routes.all|slice:":2" as recent_routes %}
            {% if recent_routes %}
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">{% trans "Prochains départs :" %}</small>
                    <div class="route-item">
                        {% for route in recent_routes %}
                            <div class="mb-1">
                                <small>
                                    <i class="fas fa-map-marker-alt text-danger"></i>
                                    {{ route.start_city }} →
                                    <i class="fas fa-map-marker-alt text-success"></i>
                                    {{ route.end_city }}
                                    <br>
                                    <i class="fas fa-calendar text-primary"></i>
                                    {{ route.departure_date|date:"d/m/Y" }}
                                </small>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Pied de carte -->
        <div class="mt-auto">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted">
                        <i class="fas fa-euro-sign"></i>
                        {{ carrier.base_price_per_km }} {% trans "/km" %}
                    </small>
                </div>

                <div>
                    <small class="text-muted">
                        <i class="fas fa-tasks"></i>
                        {{ carrier.completed_missions }} {% trans "missions" %}
                    </small>
                </div>
            </div>

            <div class="d-grid mt-3">
                <a href="{% url 'carriers:carrier_detail' carrier.user.username %}"
                   class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-eye"></i> {% trans "Voir profil" %}
                </a>
            </div>
        </div>
    </div>
</div>


========== carriers/templates/carriers/carrier_detail.html ==========
{# ~/ebi3/carriers/templates/carriers/carrier_detail.html #}
{% extends 'carriers/base_carriers.html' %}
{% load i18n %}

{% block title %}{{ carrier.user.username }} - {% trans "Transporteur" %} - Ebi3{% endblock %}

{% block carriers_content %}
<div class="row">
    <!-- Profil principal -->
    <div class="col-lg-8">
        <!-- En-tête du profil -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <div class="carrier-avatar mx-auto bg-primary text-white d-flex align-items-center justify-content-center mb-3"
                             style="width: 120px; height: 120px;">
                            <span style="font-size: 2.5rem; font-weight: bold;">
                                {{ carrier.user.username|first|upper }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <h1 class="mb-2">
                            {% if carrier.carrier_type == 'PROFESSIONAL' and carrier.company_name %}
                                {{ carrier.company_name }}
                            {% else %}
                                {{ carrier.user.username }}
                            {% endif %}
                        </h1>

                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <span class="badge
                                        {% if carrier.carrier_type == 'PROFESSIONAL' %}bg-primary
                                        {% else %}bg-info{% endif %}">
                                {{ carrier.get_carrier_type_display }}
                            </span>

                            <span class="badge bg-secondary">
                                <i class="fas fa-car"></i> {{ carrier.get_vehicle_type_display }}
                            </span>

                            {% if carrier.verification_level >= 3 %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle"></i> {% trans "Vérifié" %}
                                </span>
                            {% endif %}

                            {% if carrier.is_available %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check"></i> {% trans "Disponible" %}
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-times"></i> {% trans "Indisponible" %}
                                </span>
                            {% endif %}
                        </div>

                        <!-- Note et statistiques -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="rating-stars mb-2">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= carrier.average_rating %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="ms-2">
                                        <strong>{{ carrier.average_rating|floatformat:1 }}</strong>
                                        <small class="text-muted">({{ carrier.total_reviews }} {% trans "avis" %})</small>
                                    </span>
                                </div>

                                <div class="mb-2">
                                    <i class="fas fa-tasks text-primary"></i>
                                    <strong>{{ carrier.completed_missions }}</strong>
                                    <small class="text-muted">{% trans "missions complétées" %}</small>
                                </div>

                                <div class="mb-2">
                                    <i class="fas fa-chart-line text-success"></i>
                                    <strong>{{ carrier.success_rate }}%</strong>
                                    <small class="text-muted">{% trans "taux de réussite" %}</small>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="fas fa-euro-sign text-warning"></i>
                                    <strong>{{ carrier.base_price_per_km|floatformat:2 }}</strong>
                                    <small class="text-muted">{% trans "/km (prix de base)" %}</small>
                                </div>

                                <div class="mb-2">
                                    <i class="fas fa-weight text-info"></i>
                                    <strong>{{ carrier.max_weight }} kg</strong>
                                    <small class="text-muted">{% trans "poids max" %}</small>
                                </div>

                                <div class="mb-2">
                                    <i class="fas fa-arrows-alt text-info"></i>
                                    <strong>{{ carrier.max_volume }} m³</strong>
                                    <small class="text-muted">{% trans "volume max" %}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boutons d'action -->
                {% if user.is_authenticated %}
                    <div class="mt-4">
                        {% if user != carrier.user %}
                            <div class="d-flex gap-2">
                                <a href="{% url 'messaging:new_conversation' carrier.user.username %}"
                                   class="btn btn-primary">
                                    <i class="fas fa-envelope"></i> {% trans "Contacter" %}
                                </a>

                                {% if can_review and not has_reviewed %}
                                    <a href="{% url 'carriers:create_review' carrier.user.username %}"
                                       class="btn btn-outline-success">
                                        <i class="fas fa-star"></i> {% trans "Laisser un avis" %}
                                    </a>
                                {% endif %}

                                <!-- Bouton pour proposer un transport (à lier avec une annonce) -->
                                <button class="btn btn-outline-warning" data-bs-toggle="modal"
                                        data-bs-target="#proposeTransportModal">
                                    <i class="fas fa-truck"></i> {% trans "Proposer un transport" %}
                                </button>
                            </div>
                        {% else %}
                            <div class="d-flex gap-2">
                                <a href="{% url 'carriers:carrier_dashboard' %}"
                                   class="btn btn-success">
                                    <i class="fas fa-tachometer-alt"></i> {% trans "Tableau de bord" %}
                                </a>

                                <a href="{% url 'carriers:carrier_update' carrier.user.username %}"
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-edit"></i> {% trans "Modifier mon profil" %}
                                </a>

                                <form method="post" action="{% url 'carriers:toggle_availability' carrier.user.username %}"
                                      class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn
                                                {% if carrier.is_available %}btn-outline-warning
                                                {% else %}btn-outline-success{% endif %}">
                                        <i class="fas fa-toggle-{% if carrier.is_available %}on{% else %}off{% endif %}"></i>
                                        {% if carrier.is_available %}
                                            {% trans "Se rendre indisponible" %}
                                        {% else %}
                                            {% trans "Se rendre disponible" %}
                                        {% endif %}
                                    </button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="mt-4">
                        <a href="{% url 'users:login' %}?next={{ request.path }}"
                           class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> {% trans "Se connecter pour contacter" %}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Informations détaillées -->
        <div class="row">
            <!-- Capacités -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-truck-loading"></i> {% trans "Capacités" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <small class="text-muted d-block">{% trans "Poids maximum" %}</small>
                                <strong>{{ carrier.max_weight }} kg</strong>
                            </div>
                            <div class="col-6 mb-3">
                                <small class="text-muted d-block">{% trans "Volume maximum" %}</small>
                                <strong>{{ carrier.max_volume }} m³</strong>
                            </div>
                            <div class="col-6 mb-3">
                                <small class="text-muted d-block">{% trans "Longueur max" %}</small>
                                <strong>{{ carrier.max_length }} m</strong>
                            </div>
                            <div class="col-6 mb-3">
                                <small class="text-muted d-block">{% trans "Largeur max" %}</small>
                                <strong>{{ carrier.max_width }} m</strong>
                            </div>
                            <div class="col-6 mb-3">
                                <small class="text-muted d-block">{% trans "Hauteur max" %}</small>
                                <strong>{{ carrier.max_height }} m</strong>
                            </div>
                            <div class="col-6 mb-3">
                                <small class="text-muted d-block">{% trans "Véhicule" %}</small>
                                <strong>{{ carrier.get_vehicle_type_display }}</strong>
                                {% if carrier.vehicle_make %}
                                    <br>
                                    <small class="text-muted">{{ carrier.vehicle_make }} {{ carrier.vehicle_model }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Services inclus -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-concierge-bell"></i> {% trans "Services inclus" %}</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            {% if carrier.provides_insurance %}
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <strong>{% trans "Assurance incluse" %}</strong>
                                    <br>
                                    <small class="text-muted">{% trans "Votre envoi est assuré pendant le transport" %}</small>
                                </li>
                            {% endif %}

                            {% if carrier.provides_packaging %}
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <strong>{% trans "Emballage professionnel" %}</strong>
                                    <br>
                                    <small class="text-muted">{% trans "Emballage adapté à votre objet" %}</small>
                                </li>
                            {% endif %}

                            {% if carrier.provides_loading %}
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <strong>{% trans "Chargement inclus" %}</strong>
                                    <br>
                                    <small class="text-muted">{% trans "Aide au chargement de l'objet" %}</small>
                                </li>
                            {% endif %}

                            {% if carrier.provides_unloading %}
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <strong>{% trans "Déchargement inclus" %}</strong>
                                    <br>
                                    <small class="text-muted">{% trans "Aide au déchargement à destination" %}</small>
                                </li>
                            {% endif %}

                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>{% trans "Suivi en temps réel" %}</strong>
                                <br>
                                <small class="text-muted">{% trans "Suivez votre colis en direct" %}</small>
                            </li>

                            <li>
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>{% trans "Paiement sécurisé" %}</strong>
                                <br>
                                <small class="text-muted">{% trans "Paiement versé après livraison" %}</small>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Routes disponibles -->
        {% if active_routes %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-route"></i> {% trans "Routes disponibles" %}</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "Départ" %}</th>
                                    <th>{% trans "Destination" %}</th>
                                    <th>{% trans "Date départ" %}</th>
                                    <th>{% trans "Date arrivée" %}</th>
                                    <th>{% trans "Disponibilité" %}</th>
                                    <th>{% trans "Prix estimé" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for route in active_routes %}
                                    <tr>
                                        <td>
                                            <i class="fas fa-map-marker-alt text-danger"></i>
                                            {{ route.start_city }}, {{ route.start_country.name }}
                                        </td>
                                        <td>
                                            <i class="fas fa-map-marker-alt text-success"></i>
                                            {{ route.end_city }}, {{ route.end_country.name }}
                                        </td>
                                        <td>{{ route.departure_date|date:"d/m/Y" }}</td>
                                        <td>{{ route.arrival_date|date:"d/m/Y" }}</td>
                                        <td>
                                            {% if route.is_full %}
                                                <span class="badge bg-danger">{% trans "Complet" %}</span>
                                            {% else %}
                                                <span class="badge bg-success">
                                                    {{ route.available_weight }}kg / {{ route.available_volume }}m³
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if route.fixed_price %}
                                                {{ route.fixed_price }} €
                                            {% else %}
                                                {{ route.carrier.base_price_per_km|floatformat:2 }} €/km
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user.is_authenticated and not route.is_full %}
                                                <button class="btn btn-sm btn-outline-primary"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#bookRouteModal{{ route.id }}">
                                                    <i class="fas fa-calendar-check"></i> {% trans "Réserver" %}
                                                </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Avis -->
        {% if reviews %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-star"></i> {% trans "Avis des clients" %}</h5>
                        <span class="badge bg-light text-dark">
                            {{ review_stats.total_reviews }} {% trans "avis" %}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Statistiques des avis -->
                    {% if review_stats.total_reviews > 0 %}
                        <div class="row mb-4">
                            <div class="col-md-3 text-center">
                                <div class="display-4 fw-bold text-primary">
                                    {{ carrier.average_rating|floatformat:1 }}
                                </div>
                                <div class="rating-stars">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= carrier.average_rating %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <small class="text-muted">{% trans "Note moyenne" %}</small>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-6 mb-2">
                                        <small class="text-muted d-block">{% trans "Communication" %}</small>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-info"
                                                 style="width: {{ review_stats.avg_communication|default:0|floatformat:0 }}0%">
                                            </div>
                                        </div>
                                        <small>{{ review_stats.avg_communication|floatformat:1 }}/5</small>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <small class="text-muted d-block">{% trans "Ponctualité" %}</small>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-success"
                                                 style="width: {{ review_stats.avg_punctuality|default:0|floatformat:0 }}0%">
                                            </div>
                                        </div>
                                        <small>{{ review_stats.avg_punctuality|floatformat:1 }}/5</small>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <small class="text-muted d-block">{% trans "Manutention" %}</small>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-warning"
                                                 style="width: {{ review_stats.avg_handling|default:0|floatformat:0 }}0%">
                                            </div>
                                        </div>
                                        <small>{{ review_stats.avg_handling|floatformat:1 }}/5</small>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <small class="text-muted d-block">{% trans "Professionalisme" %}</small>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-primary"
                                                 style="width: {{ review_stats.avg_professionalism|default:0|floatformat:0 }}0%">
                                            </div>
                                        </div>
                                        <small>{{ review_stats.avg_professionalism|floatformat:1 }}/5</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Liste des avis -->
                    <div class="reviews-list">
                        {% for review in reviews %}
                            <div class="review-item border-bottom pb-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong>{{ review.reviewer.username }}</strong>
                                        <div class="rating-stars">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= review.rating %}
                                                    <i class="fas fa-star"></i>
                                                {% else %}
                                                    <i class="far fa-star"></i>
                                                {% endif %}
                                            {% endfor %}
                                            <span class="ms-2">{{ review.created_at|date:"d/m/Y" }}</span>
                                        </div>
                                    </div>
                                    {% if review.mission %}
                                        <small class="text-muted">
                                            {% trans "Mission :" %} {{ review.mission.reference }}
                                        </small>
                                    {% endif %}
                                </div>

                                <h6 class="mb-2">{{ review.title }}</h6>
                                <p class="mb-2">{{ review.comment }}</p>

                                <!-- Détails de l'évaluation -->
                                <div class="row">
                                    <div class="col-3">
                                        <small class="text-muted">{% trans "Communication" %}</small>
                                        <br>
                                        <small class="fw-bold">{{ review.communication }}/5</small>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">{% trans "Ponctualité" %}</small>
                                        <br>
                                        <small class="fw-bold">{{ review.punctuality }}/5</small>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">{% trans "Manutention" %}</small>
                                        <br>
                                        <small class="fw-bold">{{ review.handling }}/5</small>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">{% trans "Professionalisme" %}</small>
                                        <br>
                                        <small class="fw-bold">{{ review.professionalism }}/5</small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    {% if review_stats.total_reviews > reviews|length %}
                        <div class="text-center mt-3">
                            <a href="#" class="btn btn-outline-primary">
                                <i class="fas fa-comments"></i> {% trans "Voir tous les avis" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Informations de contact -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-address-card"></i> {% trans "Informations" %}</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted d-block">{% trans "Membre depuis" %}</small>
                    <strong>{{ carrier.user.date_joined|date:"d/m/Y" }}</strong>
                </div>

                <div class="mb-3">
                    <small class="text-muted d-block">{% trans "Transporteur depuis" %}</small>
                    <strong>{{ carrier.created_at|date:"d/m/Y" }}</strong>
                </div>

                {% if carrier.company_address %}
                    <div class="mb-3">
                        <small class="text-muted d-block">{% trans "Adresse" %}</small>
                        <strong>{{ carrier.company_address|truncatechars:50 }}</strong>
                    </div>
                {% endif %}

                <div class="mb-3">
                    <small class="text-muted d-block">{% trans "Langues parlées" %}</small>
                    <div class="d-flex flex-wrap gap-1 mt-1">
                        <span class="badge bg-light text-dark">{{ carrier.user.get_preferred_language_display }}</span>
                        <!-- Ajouter d'autres langues si disponibles -->
                    </div>
                </div>

                <div class="mb-3">
                    <small class="text-muted d-block">{% trans "Disponibilité" %}</small>
                    {% if carrier.available_from and carrier.available_until %}
                        <strong>
                            {{ carrier.available_from|date:"d/m/Y" }} - {{ carrier.available_until|date:"d/m/Y" }}
                        </strong>
                    {% else %}
                        <strong>{% trans "Flexible" %}</strong>
                    {% endif %}
                </div>

                <!-- Documents vérifiés -->
                {% if verified_documents %}
                    <div class="mt-4">
                        <small class="text-muted d-block mb-2">{% trans "Documents vérifiés" %}</small>
                        <div class="d-flex flex-wrap gap-1">
                            {% for doc in verified_documents %}
                                <span class="verified-badge">
                                    <i class="fas fa-check"></i> {{ doc.get_document_type_display }}
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Bouton rapide de contact -->
        <div class="card shadow-sm mb-4">
            <div class="card-body text-center">
                <h6 class="mb-3">{% trans "Besoin d'un transport ?" %}</h6>
                {% if user.is_authenticated and user != carrier.user %}
                    <a href="{% url 'messaging:new_conversation' carrier.user.username %}"
                       class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-envelope"></i> {% trans "Contacter" %}
                    </a>

                    <button class="btn btn-success w-100" data-bs-toggle="modal"
                            data-bs-target="#quickQuoteModal">
                        <i class="fas fa-calculator"></i> {% trans "Demander un devis" %}
                    </button>
                {% elif not user.is_authenticated %}
                    <a href="{% url 'users:login' %}?next={{ request.path }}"
                       class="btn btn-primary w-100">
                        <i class="fas fa-sign-in-alt"></i> {% trans "Se connecter pour contacter" %}
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Transporteurs similaires -->
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-users"></i> {% trans "Transporteurs similaires" %}</h5>
            </div>
            <div class="card-body">
                <!-- À implémenter : logique pour trouver des transporteurs similaires -->
                <p class="text-muted text-center">
                    <i class="fas fa-info-circle"></i>
                    {% trans "Fonctionnalité à venir" %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="proposeTransportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Proposer un transport" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "Cette fonctionnalité vous permettra de proposer un transport pour une annonce spécifique." %}</p>
                <p class="text-muted">{% trans "À implémenter avec l'application logistics." %}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Fermer" %}
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="quickQuoteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Demande de devis rapide" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickQuoteForm">
                    <div class="mb-3">
                        <label class="form-label">{% trans "Description de l'objet" %}</label>
                        <textarea class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Poids (kg)" %}</label>
                            <input type="number" class="form-control" step="0.001" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Volume (m³)" %}</label>
                            <input type="number" class="form-control" step="0.001" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Lieu de départ" %}</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Lieu d'arrivée" %}</label>
                            <input type="text" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Date souhaitée" %}</label>
                        <input type="date" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Annuler" %}
                </button>
                <button type="submit" form="quickQuoteForm" class="btn btn-success">
                    {% trans "Envoyer la demande" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modals pour la réservation de routes -->
{% for route in active_routes %}
    <div class="modal fade" id="bookRouteModal{{ route.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Réserver cette route" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>
                        {% trans "Route :" %}
                        <strong>{{ route.start_city }} → {{ route.end_city }}</strong>
                    </p>
                    <p>
                        {% trans "Date :" %}
                        <strong>{{ route.departure_date|date:"d/m/Y" }}</strong>
                    </p>
                    <p class="text-muted">
                        {% trans "Vous serez redirigé vers le formulaire de réservation." %}
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "Annuler" %}
                    </button>
                    <a href="#" class="btn btn-success">{% trans "Continuer" %}</a>
                </div>
            </div>
        </div>
    </div>
{% endfor %}
{% endblock %}


========== carriers/templates/carriers/apply_success.html ==========
{# ~/ebi3/carriers/templates/carriers/apply_success.html #}
{% extends 'carriers/base_carriers.html' %}
{% load i18n %}

{% block title %}{% trans "Candidature envoyée" %} - Ebi3{% endblock %}

{% block carriers_content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card shadow-lg">
            <div class="card-header bg-success text-white">
                <h2 class="mb-0"><i class="fas fa-check-circle"></i> {% trans "Candidature envoyée" %}</h2>
            </div>
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-paper-plane fa-5x text-success mb-4"></i>
                    <h3>{% trans "Félicitations !" %}</h3>
                    <p class="lead">
                        {% trans "Votre candidature pour devenir transporteur a été envoyée avec succès." %}
                    </p>
                </div>

                <div class="alert alert-info text-start">
                    <h5><i class="fas fa-info-circle"></i> {% trans "Prochaines étapes :" %}</h5>
                    <ol class="mb-0">
                        <li>{% trans "Notre équipe va examiner votre candidature sous 24-48h." %}</li>
                        <li>{% trans "Vous recevrez un email de confirmation." %}</li>
                        <li>{% trans "Si approuvé, vous pourrez télécharger vos documents." %}</li>
                        <li>{% trans "Vous pourrez alors commencer à accepter des missions." %}</li>
                    </ol>
                </div>

                <div class="mt-5">
                    <p class="text-muted mb-4">
                        {% trans "Pendant l'examen de votre candidature, vous pouvez :" %}
                    </p>
                    <div class="d-grid gap-3 col-md-8 mx-auto">
                        <a href="{% url 'users:profile_edit' %}" class="btn btn-outline-primary">
                            <i class="fas fa-user-edit"></i> {% trans "Compléter mon profil" %}
                        </a>
                        <a href="{% url 'carriers:carrier_list' %}" class="btn btn-outline-info">
                            <i class="fas fa-truck"></i> {% trans "Voir les autres transporteurs" %}
                        </a>
                        <a href="{% url 'core:home' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-home"></i> {% trans "Retour à l'accueil" %}
                        </a>
                    </div>
                </div>
            </div>

            <!-- Informations importantes -->
            <div class="card-footer bg-light">
                <div class="text-center">
                    <h6><i class="fas fa-question-circle"></i> {% trans "Des questions ?" %}</h6>
                    <p class="text-muted small mb-0">
                        {% trans "Contactez notre support :" %}
                        <a href="mailto:support@ebi3.com">support@ebi3.com</a>
                        {% trans "ou" %}
                        <a href="{% url 'core:contact' %}">{% trans "notre formulaire de contact" %}</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


========== carriers/templates/carriers/base_carriers.html ==========
{# ~/ebi3/carriers/templates/carriers/base_carriers.html #}
{% extends 'core/base.html' %}
{% load i18n %}

{% block extra_css %}
<style>
    .carrier-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid #e0e0e0;
    }

    .carrier-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .carrier-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .carrier-type-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .rating-stars {
        color: #ffc107;
    }

    .capacity-badge {
        background-color: #e3f2fd;
        color: #1976d2;
        font-size: 0.8rem;
    }

    .route-item {
        border-left: 3px solid #667eea;
        padding-left: 1rem;
        margin-bottom: 1rem;
    }

    .document-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .verified-badge {
        background-color: #28a745;
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
    }

    .dashboard-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .dashboard-card:hover {
        transform: translateY(-3px);
    }

    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
    }

    .notification-item {
        border-left: 3px solid;
        padding-left: 1rem;
        margin-bottom: 1rem;
    }

    .notification-unread {
        border-left-color: #667eea;
        background-color: #f8f9fa;
    }

    .notification-read {
        border-left-color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    {% block carriers_content %}{% endblock %}
</div>
{% endblock %}


========== carriers/migrations/0002_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("carriers", "0001_initial"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name="carrier",
            name="user",
            field=models.OneToOneField(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="carrier_profile",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="carrieravailability",
            name="carrier",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="availabilities",
                to="carriers.carrier",
                verbose_name="Transporteur",
            ),
        ),
        migrations.AddField(
            model_name="carrierdocument",
            name="carrier",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="documents",
                to="carriers.carrier",
                verbose_name="Transporteur",
            ),
        ),
        migrations.AddField(
            model_name="carrierdocument",
            name="verified_by",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="verified_documents",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Vérifié par",
            ),
        ),
        migrations.AddField(
            model_name="carriernotification",
            name="carrier",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="notifications",
                to="carriers.carrier",
                verbose_name="Transporteur",
            ),
        ),
        migrations.AddField(
            model_name="carrierreview",
            name="carrier",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="reviews",
                to="carriers.carrier",
                verbose_name="Transporteur",
            ),
        ),
        migrations.AddField(
            model_name="carrierreview",
            name="reviewer",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="carrier_reviews",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Auteur",
            ),
        ),
        migrations.AddField(
            model_name="carrierroute",
            name="carrier",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="carrier_routes",
                to="carriers.carrier",
                verbose_name="Transporteur",
            ),
        ),
        migrations.AddIndex(
            model_name="carrier",
            index=models.Index(
                fields=["status", "carrier_type"], name="carriers_ca_status_7f3ecc_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="carrier",
            index=models.Index(
                fields=["is_available", "status"], name="carriers_ca_is_avai_37936d_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="carrier",
            index=models.Index(
                fields=["user", "status"], name="carriers_ca_user_id_484ac0_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="carrieravailability",
            index=models.Index(
                fields=["carrier", "start_datetime", "is_booked"],
                name="carriers_ca_carrier_9528db_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="carriernotification",
            index=models.Index(
                fields=["carrier", "is_read", "created_at"],
                name="carriers_ca_carrier_83a765_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="carrierreview",
            index=models.Index(
                fields=["carrier", "is_approved", "is_visible"],
                name="carriers_ca_carrier_ece7b8_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="carrierreview",
            index=models.Index(
                fields=["reviewer", "created_at"], name="carriers_ca_reviewe_0792c4_idx"
            ),
        ),
        migrations.AlterUniqueTogether(
            name="carrierreview",
            unique_together={("carrier", "reviewer")},
        ),
        migrations.AddIndex(
            model_name="carrierroute",
            index=models.Index(
                fields=["start_country", "end_country"],
                name="carriers_ca_start_c_24d42f_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="carrierroute",
            index=models.Index(
                fields=["departure_date", "is_active"],
                name="carriers_ca_departu_d158ff_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="carrierroute",
            index=models.Index(
                fields=["carrier", "is_active"], name="carriers_ca_carrier_c67da6_idx"
            ),
        ),
    ]



========== carriers/migrations/0001_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import django.contrib.gis.db.models.fields
import django.core.validators
import django_countries.fields
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name="Carrier",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "carrier_type",
                    models.CharField(
                        choices=[
                            ("PROFESSIONAL", "Professionnel"),
                            ("PERSONAL", "Particulier (Expatrié)"),
                        ],
                        max_length=20,
                        verbose_name="Type de transporteur",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("APPROVED", "Approuvé"),
                            ("REJECTED", "Rejeté"),
                            ("SUSPENDED", "Suspendu"),
                            ("INACTIVE", "Inactif"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "verification_level",
                    models.IntegerField(
                        default=0,
                        help_text="De 0 (non vérifié) à 5 (entièrement vérifié)",
                        validators=[
                            django.core.validators.MinValueValidator(0),
                            django.core.validators.MaxValueValidator(5),
                        ],
                        verbose_name="Niveau de vérification",
                    ),
                ),
                (
                    "verified_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Vérifié le"
                    ),
                ),
                (
                    "rejection_reason",
                    models.TextField(blank=True, verbose_name="Raison du rejet"),
                ),
                (
                    "company_name",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Nom de l'entreprise"
                    ),
                ),
                (
                    "company_registration",
                    models.CharField(
                        blank=True,
                        max_length=100,
                        verbose_name="Numéro d'immatriculation",
                    ),
                ),
                (
                    "tax_id",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Numéro fiscal/TVA"
                    ),
                ),
                (
                    "company_address",
                    models.TextField(
                        blank=True, verbose_name="Adresse de l'entreprise"
                    ),
                ),
                (
                    "registration_certificate",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="carriers/documents/registration/",
                        verbose_name="Certificat d'immatriculation",
                    ),
                ),
                (
                    "insurance_certificate",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="carriers/documents/insurance/",
                        verbose_name="Certificat d'assurance",
                    ),
                ),
                (
                    "operator_license",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="carriers/documents/license/",
                        verbose_name="Licence d'exploitation",
                    ),
                ),
                (
                    "vehicle_type",
                    models.CharField(
                        choices=[
                            ("CAR", "Voiture"),
                            ("VAN", "Camionnette"),
                            ("TRUCK_SMALL", "Camion (3.5T)"),
                            ("TRUCK_MEDIUM", "Camion (7.5T)"),
                            ("TRUCK_LARGE", "Camion (19T+)"),
                            ("MOTORCYCLE", "Moto"),
                            ("OTHER", "Autre"),
                        ],
                        max_length=20,
                        verbose_name="Type de véhicule",
                    ),
                ),
                (
                    "vehicle_make",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Marque du véhicule"
                    ),
                ),
                (
                    "vehicle_model",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Modèle du véhicule"
                    ),
                ),
                (
                    "vehicle_year",
                    models.PositiveIntegerField(
                        blank=True,
                        null=True,
                        validators=[
                            django.core.validators.MinValueValidator(1990),
                            django.core.validators.MaxValueValidator(2100),
                        ],
                        verbose_name="Année du véhicule",
                    ),
                ),
                (
                    "vehicle_registration",
                    models.CharField(
                        blank=True,
                        max_length=50,
                        verbose_name="Plaque d'immatriculation",
                    ),
                ),
                (
                    "max_weight",
                    models.DecimalField(
                        decimal_places=3,
                        default=100,
                        help_text="Charge utile maximale",
                        max_digits=8,
                        verbose_name="Poids maximum (kg)",
                    ),
                ),
                (
                    "max_volume",
                    models.DecimalField(
                        decimal_places=3,
                        default=1,
                        help_text="Volume utile maximum",
                        max_digits=10,
                        verbose_name="Volume maximum (m³)",
                    ),
                ),
                (
                    "max_length",
                    models.DecimalField(
                        decimal_places=2,
                        default=1.5,
                        max_digits=6,
                        verbose_name="Longueur maximum (m)",
                    ),
                ),
                (
                    "max_width",
                    models.DecimalField(
                        decimal_places=2,
                        default=1,
                        max_digits=6,
                        verbose_name="Largeur maximum (m)",
                    ),
                ),
                (
                    "max_height",
                    models.DecimalField(
                        decimal_places=2,
                        default=1,
                        max_digits=6,
                        verbose_name="Hauteur maximum (m)",
                    ),
                ),
                (
                    "provides_packaging",
                    models.BooleanField(
                        default=False, verbose_name="Fournit l'emballage"
                    ),
                ),
                (
                    "provides_insurance",
                    models.BooleanField(
                        default=False, verbose_name="Fournit l'assurance"
                    ),
                ),
                (
                    "provides_loading",
                    models.BooleanField(
                        default=False, verbose_name="Fournit le chargement"
                    ),
                ),
                (
                    "provides_unloading",
                    models.BooleanField(
                        default=False, verbose_name="Fournit le déchargement"
                    ),
                ),
                (
                    "base_price_per_km",
                    models.DecimalField(
                        decimal_places=4,
                        default=1.0,
                        max_digits=8,
                        verbose_name="Prix de base par km (€)",
                    ),
                ),
                (
                    "min_price",
                    models.DecimalField(
                        decimal_places=2,
                        default=10.0,
                        max_digits=8,
                        verbose_name="Prix minimum (€)",
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                        ],
                        default="EUR",
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "is_available",
                    models.BooleanField(
                        default=True, verbose_name="Disponible pour des missions"
                    ),
                ),
                (
                    "available_from",
                    models.DateField(
                        blank=True, null=True, verbose_name="Disponible à partir du"
                    ),
                ),
                (
                    "available_until",
                    models.DateField(
                        blank=True, null=True, verbose_name="Disponible jusqu'au"
                    ),
                ),
                (
                    "total_missions",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Total des missions"
                    ),
                ),
                (
                    "completed_missions",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Missions complétées"
                    ),
                ),
                (
                    "success_rate",
                    models.DecimalField(
                        decimal_places=2,
                        default=100.0,
                        max_digits=5,
                        validators=[
                            django.core.validators.MinValueValidator(0),
                            django.core.validators.MaxValueValidator(100),
                        ],
                        verbose_name="Taux de réussite (%)",
                    ),
                ),
                (
                    "average_rating",
                    models.DecimalField(
                        decimal_places=2,
                        default=0.0,
                        max_digits=3,
                        validators=[
                            django.core.validators.MinValueValidator(0),
                            django.core.validators.MaxValueValidator(5),
                        ],
                        verbose_name="Note moyenne",
                    ),
                ),
                (
                    "total_reviews",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Nombre total d'avis"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("approved_at", models.DateTimeField(blank=True, null=True)),
            ],
            options={
                "verbose_name": "Transporteur",
                "verbose_name_plural": "Transporteurs",
                "ordering": ["-created_at"],
                "permissions": [
                    ("can_verify_carrier", "Peut vérifier les transporteurs"),
                    ("can_approve_carrier", "Peut approuver les transporteurs"),
                    (
                        "can_view_carrier_stats",
                        "Peut voir les statistiques des transporteurs",
                    ),
                ],
            },
        ),
        migrations.CreateModel(
            name="CarrierAvailability",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "start_datetime",
                    models.DateTimeField(verbose_name="Début de disponibilité"),
                ),
                (
                    "end_datetime",
                    models.DateTimeField(verbose_name="Fin de disponibilité"),
                ),
                (
                    "location",
                    django.contrib.gis.db.models.fields.PointField(
                        blank=True, null=True, srid=4326, verbose_name="Localisation"
                    ),
                ),
                (
                    "available_weight",
                    models.DecimalField(
                        decimal_places=3,
                        default=0,
                        max_digits=8,
                        verbose_name="Poids disponible (kg)",
                    ),
                ),
                (
                    "available_volume",
                    models.DecimalField(
                        decimal_places=3,
                        default=0,
                        max_digits=10,
                        verbose_name="Volume disponible (m³)",
                    ),
                ),
                ("notes", models.TextField(blank=True, verbose_name="Notes")),
                (
                    "is_booked",
                    models.BooleanField(default=False, verbose_name="Réservé"),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Disponibilité de transporteur",
                "verbose_name_plural": "Disponibilités de transporteurs",
                "ordering": ["start_datetime"],
            },
        ),
        migrations.CreateModel(
            name="CarrierDocument",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "document_type",
                    models.CharField(
                        choices=[
                            ("ID_CARD", "Carte d'identité"),
                            ("PASSPORT", "Passeport"),
                            ("DRIVER_LICENSE", "Permis de conduire"),
                            ("VEHICLE_REGISTRATION", "Carte grise"),
                            ("INSURANCE", "Assurance"),
                            ("COMPANY_REGISTRATION", "Immatriculation société"),
                            ("TAX_CERTIFICATE", "Certificat fiscal"),
                            ("OTHER", "Autre"),
                        ],
                        max_length=30,
                        verbose_name="Type de document",
                    ),
                ),
                (
                    "file",
                    models.FileField(
                        upload_to="carriers/documents/%Y/%m/%d/", verbose_name="Fichier"
                    ),
                ),
                (
                    "thumbnail",
                    models.ImageField(
                        blank=True,
                        null=True,
                        upload_to="carriers/documents/thumbnails/%Y/%m/%d/",
                        verbose_name="Miniature",
                    ),
                ),
                (
                    "description",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Description"
                    ),
                ),
                (
                    "is_verified",
                    models.BooleanField(default=False, verbose_name="Vérifié"),
                ),
                (
                    "verified_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Vérifié le"
                    ),
                ),
                (
                    "verification_notes",
                    models.TextField(blank=True, verbose_name="Notes de vérification"),
                ),
                (
                    "expiry_date",
                    models.DateField(
                        blank=True, null=True, verbose_name="Date d'expiration"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Document de transporteur",
                "verbose_name_plural": "Documents de transporteurs",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="CarrierNotification",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "notification_type",
                    models.CharField(
                        choices=[
                            ("NEW_MISSION", "Nouvelle mission"),
                            ("MISSION_UPDATE", "Mise à jour de mission"),
                            ("PAYMENT_RECEIVED", "Paiement reçu"),
                            ("REVIEW_RECEIVED", "Avis reçu"),
                            ("DOCUMENT_VERIFIED", "Document vérifié"),
                            ("STATUS_CHANGED", "Statut changé"),
                            ("SYSTEM", "Système"),
                        ],
                        max_length=30,
                        verbose_name="Type de notification",
                    ),
                ),
                ("title", models.CharField(max_length=200, verbose_name="Titre")),
                ("message", models.TextField(verbose_name="Message")),
                (
                    "related_object_id",
                    models.PositiveIntegerField(
                        blank=True, null=True, verbose_name="ID objet lié"
                    ),
                ),
                (
                    "related_object_type",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Type d'objet lié"
                    ),
                ),
                ("is_read", models.BooleanField(default=False, verbose_name="Lu")),
                (
                    "is_important",
                    models.BooleanField(default=False, verbose_name="Important"),
                ),
                (
                    "action_url",
                    models.URLField(blank=True, verbose_name="URL d'action"),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Notification de transporteur",
                "verbose_name_plural": "Notifications de transporteurs",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="CarrierReview",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "rating",
                    models.IntegerField(
                        validators=[
                            django.core.validators.MinValueValidator(1),
                            django.core.validators.MaxValueValidator(5),
                        ],
                        verbose_name="Note (1-5)",
                    ),
                ),
                ("title", models.CharField(max_length=200, verbose_name="Titre")),
                ("comment", models.TextField(verbose_name="Commentaire")),
                (
                    "communication",
                    models.IntegerField(
                        default=5,
                        validators=[
                            django.core.validators.MinValueValidator(1),
                            django.core.validators.MaxValueValidator(5),
                        ],
                        verbose_name="Communication",
                    ),
                ),
                (
                    "punctuality",
                    models.IntegerField(
                        default=5,
                        validators=[
                            django.core.validators.MinValueValidator(1),
                            django.core.validators.MaxValueValidator(5),
                        ],
                        verbose_name="Ponctualité",
                    ),
                ),
                (
                    "handling",
                    models.IntegerField(
                        default=5,
                        validators=[
                            django.core.validators.MinValueValidator(1),
                            django.core.validators.MaxValueValidator(5),
                        ],
                        verbose_name="Manutention",
                    ),
                ),
                (
                    "professionalism",
                    models.IntegerField(
                        default=5,
                        validators=[
                            django.core.validators.MinValueValidator(1),
                            django.core.validators.MaxValueValidator(5),
                        ],
                        verbose_name="Professionalisme",
                    ),
                ),
                (
                    "is_approved",
                    models.BooleanField(default=False, verbose_name="Approuvé"),
                ),
                (
                    "is_visible",
                    models.BooleanField(default=True, verbose_name="Visible"),
                ),
                (
                    "admin_notes",
                    models.TextField(
                        blank=True, verbose_name="Notes de l'administrateur"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Avis sur transporteur",
                "verbose_name_plural": "Avis sur transporteurs",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="CarrierRoute",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "start_country",
                    django_countries.fields.CountryField(
                        max_length=2, verbose_name="Pays de départ"
                    ),
                ),
                (
                    "start_city",
                    models.CharField(max_length=100, verbose_name="Ville de départ"),
                ),
                (
                    "start_location",
                    django.contrib.gis.db.models.fields.PointField(
                        blank=True,
                        help_text="Coordonnées GPS du point de départ",
                        null=True,
                        srid=4326,
                        verbose_name="Localisation de départ",
                    ),
                ),
                (
                    "end_country",
                    django_countries.fields.CountryField(
                        max_length=2, verbose_name="Pays d'arrivée"
                    ),
                ),
                (
                    "end_city",
                    models.CharField(max_length=100, verbose_name="Ville d'arrivée"),
                ),
                (
                    "end_location",
                    django.contrib.gis.db.models.fields.PointField(
                        blank=True,
                        help_text="Coordonnées GPS du point d'arrivée",
                        null=True,
                        srid=4326,
                        verbose_name="Localisation d'arrivée",
                    ),
                ),
                (
                    "frequency",
                    models.CharField(
                        choices=[
                            ("ONE_TIME", "Ponctuel"),
                            ("WEEKLY", "Hebdomadaire"),
                            ("BIWEEKLY", "Bimensuel"),
                            ("MONTHLY", "Mensuel"),
                            ("REGULAR", "Régulier"),
                        ],
                        default="ONE_TIME",
                        max_length=20,
                        verbose_name="Fréquence",
                    ),
                ),
                ("departure_date", models.DateField(verbose_name="Date de départ")),
                ("arrival_date", models.DateField(verbose_name="Date d'arrivée")),
                (
                    "available_weight",
                    models.DecimalField(
                        decimal_places=3,
                        default=0,
                        max_digits=8,
                        verbose_name="Poids disponible (kg)",
                    ),
                ),
                (
                    "available_volume",
                    models.DecimalField(
                        decimal_places=3,
                        default=0,
                        max_digits=10,
                        verbose_name="Volume disponible (m³)",
                    ),
                ),
                ("is_active", models.BooleanField(default=True, verbose_name="Actif")),
                ("is_full", models.BooleanField(default=False, verbose_name="Complet")),
                (
                    "price_per_kg",
                    models.DecimalField(
                        blank=True,
                        decimal_places=4,
                        max_digits=8,
                        null=True,
                        verbose_name="Prix par kg (€)",
                    ),
                ),
                (
                    "price_per_m3",
                    models.DecimalField(
                        blank=True,
                        decimal_places=4,
                        max_digits=8,
                        null=True,
                        verbose_name="Prix par m³ (€)",
                    ),
                ),
                (
                    "fixed_price",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=8,
                        null=True,
                        verbose_name="Prix fixe (€)",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Route de transporteur",
                "verbose_name_plural": "Routes de transporteurs",
                "ordering": ["departure_date"],
            },
        ),
    ]



========== carriers/migrations/__init__.py ==========



========== carriers/tests.py ==========
from django.test import TestCase

# Create your tests here.



========== carriers/signals.py ==========
# carriers/signals.py
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver
from django.db.models import Avg
from .models import CarrierReview, Carrier

@receiver(post_save, sender=CarrierReview)
@receiver(post_delete, sender=CarrierReview)
def update_carrier_rating(sender, instance, **kwargs):
    """Met à jour la note moyenne d'un transporteur"""
    carrier = instance.carrier

    reviews = carrier.reviews.filter(is_approved=True, is_visible=True)

    if reviews.exists():
        avg_rating = reviews.aggregate(avg=Avg('rating'))['avg']
        total_reviews = reviews.count()

        carrier.average_rating = avg_rating or 0.00
        carrier.total_reviews = total_reviews
    else:
        carrier.average_rating = 0.00
        carrier.total_reviews = 0

    carrier.save(update_fields=['average_rating', 'total_reviews'])


========== carriers/admin.py ==========
# ~/ebi3/carriers/admin.py
from django.contrib import admin
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from django.utils.html import format_html
from .models import (
    Carrier, CarrierRoute, CarrierDocument,
    CarrierReview, CarrierAvailability, CarrierNotification
)

@admin.register(Carrier)
class CarrierAdmin(admin.ModelAdmin):
    """Administration des transporteurs"""

    # ✅ CORRECTION : 'actions' doit être une LISTE de noms de méthodes
    actions = ['approve_carriers', 'reject_carriers', 'suspend_carriers']

    list_display = (
        'user', 'company_name', 'carrier_type', 'status',
        'verification_level', 'vehicle_type', 'is_available',
        'average_rating', 'created_at'
    )

    list_filter = (
        'status', 'carrier_type', 'vehicle_type',
        'is_available', 'verification_level', 'created_at'
    )

    search_fields = (
        'user__username', 'user__email', 'company_name',
        'company_registration', 'vehicle_make', 'vehicle_model'
    )

    readonly_fields = (
        'created_at', 'updated_at', 'approved_at',
        'verified_at', 'average_rating', 'total_reviews',
        'total_missions', 'completed_missions', 'success_rate'
    )

    fieldsets = (
        (_('Informations utilisateur'), {
            'fields': ('user', 'carrier_type', 'status')
        }),
        (_('Informations professionnelles'), {
            'fields': (
                'company_name', 'company_registration', 'tax_id',
                'company_address'
            ),
            'classes': ('collapse',)
        }),
        (_('Véhicule'), {
            'fields': (
                'vehicle_type', 'vehicle_make', 'vehicle_model',
                'vehicle_year', 'vehicle_registration'
            )
        }),
        (_('Capacités'), {
            'fields': (
                'max_weight', 'max_volume',
                'max_length', 'max_width', 'max_height'
            )
        }),
        (_('Services'), {
            'fields': (
                'provides_packaging', 'provides_insurance',
                'provides_loading', 'provides_unloading'
            )
        }),
        (_('Tarification'), {
            'fields': ('base_price_per_km', 'min_price', 'currency')
        }),
        (_('Disponibilité'), {
            'fields': ('is_available', 'available_from', 'available_until')
        }),
        (_('Vérification'), {
            'fields': (
                'verification_level', 'verified_at',
                'rejection_reason'
            )
        }),
        (_('Statistiques'), {
            'fields': (
                'total_missions', 'completed_missions',
                'success_rate', 'average_rating', 'total_reviews'
            ),
            'classes': ('collapse',)
        }),
        (_('Documents'), {
            'fields': (
                'registration_certificate', 'insurance_certificate',
                'operator_license'
            ),
            'classes': ('collapse',)
        }),
        (_('Métadonnées'), {
            'fields': ('created_at', 'updated_at', 'approved_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ Les méthodes d'action doivent être définies séparément
    def approve_carriers(self, request, queryset):
        updated = queryset.update(
            status='APPROVED',
            approved_at=timezone.now(),
            verified_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} transporteurs ont été approuvés.'))
    approve_carriers.short_description = _('Approuver les transporteurs sélectionnés')

    def reject_carriers(self, request, queryset):
        updated = queryset.update(status='REJECTED')
        self.message_user(request, _(f'{updated} transporteurs ont été rejetés.'))
    reject_carriers.short_description = _('Rejeter les transporteurs sélectionnés')

    def suspend_carriers(self, request, queryset):
        updated = queryset.update(status='SUSPENDED')
        self.message_user(request, _(f'{updated} transporteurs ont été suspendus.'))
    suspend_carriers.short_description = _('Suspendre les transporteurs sélectionnés')

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('user')


@admin.register(CarrierRoute)
class CarrierRouteAdmin(admin.ModelAdmin):
    """Administration des routes de transporteurs"""

    list_display = (
        'carrier', 'start_city', 'end_city',
        'departure_date', 'arrival_date', 'is_active',
        'available_weight', 'available_volume', 'is_full'
    )

    list_filter = ('is_active', 'is_full', 'frequency', 'departure_date')
    search_fields = ('carrier__user__username', 'start_city', 'end_city')
    date_hierarchy = 'departure_date'

    # ✅ AJOUT: actions doit être défini (liste vide si pas d'actions)
    actions = []

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('carrier', 'carrier__user')


@admin.register(CarrierDocument)
class CarrierDocumentAdmin(admin.ModelAdmin):
    """Administration des documents de transporteurs"""

    list_display = (
        'carrier', 'document_type', 'is_verified',
        'verified_at', 'expiry_date', 'created_at'
    )

    list_filter = ('document_type', 'is_verified', 'created_at')
    search_fields = ('carrier__user__username', 'description')
    readonly_fields = ('created_at', 'updated_at', 'verified_at')

    # ✅ AJOUT: actions doit être défini (liste vide si pas d'actions)
    actions = []

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('carrier', 'carrier__user', 'verified_by')


@admin.register(CarrierReview)
class CarrierReviewAdmin(admin.ModelAdmin):
    """Administration des avis sur transporteurs"""

    list_display = (
        'carrier', 'reviewer', 'rating', 'title',
        'is_approved', 'is_visible', 'created_at'
    )

    list_filter = ('is_approved', 'is_visible', 'rating', 'created_at')
    search_fields = ('carrier__user__username', 'reviewer__username', 'title', 'comment')
    list_editable = ('is_approved', 'is_visible')
    readonly_fields = ('created_at', 'updated_at')

    # ✅ AJOUT: actions doit être défini comme une liste
    actions = ['approve_reviews', 'reject_reviews']

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('carrier', 'carrier__user', 'reviewer')

    def approve_reviews(self, request, queryset):
        updated = queryset.update(is_approved=True)
        self.message_user(request, _(f'{updated} avis ont été approuvés.'))
    approve_reviews.short_description = _('Approuver les avis sélectionnés')

    def reject_reviews(self, request, queryset):
        updated = queryset.update(is_approved=False, is_visible=False)
        self.message_user(request, _(f'{updated} avis ont été rejetés.'))
    reject_reviews.short_description = _('Rejeter les avis sélectionnés')


# Enregistrement simplifié pour les autres modèles
@admin.register(CarrierAvailability)
class CarrierAvailabilityAdmin(admin.ModelAdmin):
    list_display = ('carrier', 'start_datetime', 'end_datetime', 'is_booked')
    list_filter = ('is_booked', 'start_datetime')
    search_fields = ('carrier__user__username', 'notes')

    # ✅ AJOUT: actions doit être défini (liste vide si pas d'actions)
    actions = []


@admin.register(CarrierNotification)
class CarrierNotificationAdmin(admin.ModelAdmin):
    list_display = ('carrier', 'notification_type', 'title', 'is_read', 'created_at')
    list_filter = ('notification_type', 'is_read', 'is_important', 'created_at')
    search_fields = ('carrier__user__username', 'title', 'message')
    readonly_fields = ('created_at',)

    # ✅ AJOUT: actions doit être défini (liste vide si pas d'actions)
    actions = []

    def has_add_permission(self, request):
        return False


========== carriers/forms.py ==========
# ~/ebi3/carriers/forms.py
from django import forms
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import ValidationError
from django.forms import inlineformset_factory
from django.utils import timezone
from django_countries import countries  # AJOUT: Pour avoir la liste des pays
from django_countries.widgets import CountrySelectWidget  # AJOUT: Widget pour les pays

from .models import Carrier, CarrierRoute, CarrierDocument, CarrierReview
from users.models import User

class CarrierApplicationForm(forms.ModelForm):
    """Formulaire de candidature pour devenir transporteur"""

    class Meta:
        model = Carrier
        fields = [
            'carrier_type', 'company_name', 'company_registration', 'tax_id',
            'company_address', 'vehicle_type', 'vehicle_make', 'vehicle_model',
            'vehicle_year', 'vehicle_registration', 'max_weight', 'max_volume',
            'max_length', 'max_width', 'max_height', 'provides_packaging',
            'provides_insurance', 'provides_loading', 'provides_unloading',
            'base_price_per_km', 'min_price', 'currency'
        ]

        widgets = {
            'carrier_type': forms.Select(attrs={'class': 'form-control'}),
            'company_name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Nom de votre entreprise")
            }),
            'vehicle_type': forms.Select(attrs={'class': 'form-control'}),
            'vehicle_make': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Ex: Renault, Mercedes, etc.")
            }),
            'vehicle_year': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '1990',
                'max': '2100'
            }),
            'max_weight': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.001'
            }),
            'max_volume': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.001'
            }),
            'base_price_per_km': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.0001'
            }),
            'min_price': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
            'currency': forms.Select(attrs={'class': 'form-control'}),
        }

        labels = {
            'carrier_type': _("Type de transporteur"),
            'max_weight': _("Poids maximum transportable (kg)"),
            'max_volume': _("Volume maximum transportable (m³)"),
            'provides_packaging': _("Je fournis l'emballage"),
            'provides_insurance': _("Je fournis l'assurance"),
            'provides_loading': _("Je fournis le chargement"),
            'provides_unloading': _("Je fournis le déchargement"),
        }

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        # Masquer les champs non pertinents pour les particuliers
        if self.instance.carrier_type == Carrier.CarrierType.PERSONAL or \
           (self.initial.get('carrier_type') == Carrier.CarrierType.PERSONAL):
            self.fields['company_name'].required = False
            self.fields['company_registration'].required = False
            self.fields['tax_id'].required = False
            self.fields['company_address'].required = False

    def clean(self):
        cleaned_data = super().clean()
        carrier_type = cleaned_data.get('carrier_type')
        company_name = cleaned_data.get('company_name')

        # Validation pour les transporteurs professionnels
        if carrier_type == Carrier.CarrierType.PROFESSIONAL:
            if not company_name:
                self.add_error('company_name',
                             _("Le nom de l'entreprise est obligatoire pour les transporteurs professionnels."))

        # Validation des capacités
        max_weight = cleaned_data.get('max_weight')
        max_volume = cleaned_data.get('max_volume')

        if max_weight and max_weight <= 0:
            self.add_error('max_weight', _("Le poids maximum doit être supérieur à 0."))

        if max_volume and max_volume <= 0:
            self.add_error('max_volume', _("Le volume maximum doit être supérieur à 0."))

        return cleaned_data

    def save(self, commit=True):
        carrier = super().save(commit=False)

        if self.user:
            carrier.user = self.user

        if commit:
            carrier.save()

        return carrier


class CarrierUpdateForm(forms.ModelForm):
    """Formulaire de mise à jour pour les transporteurs"""

    class Meta:
        model = Carrier
        fields = [
            'company_name', 'company_address', 'vehicle_make', 'vehicle_model',
            'vehicle_year', 'vehicle_registration', 'max_weight', 'max_volume',
            'max_length', 'max_width', 'max_height', 'provides_packaging',
            'provides_insurance', 'provides_loading', 'provides_unloading',
            'base_price_per_km', 'min_price', 'currency', 'is_available',
            'available_from', 'available_until'
        ]

        widgets = {
            'available_from': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
            'available_until': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
        }


class CarrierRouteForm(forms.ModelForm):
    """Formulaire pour créer/modifier une route"""

    # AJOUT: Définir les champs de pays manuellement pour le formulaire
    start_country = forms.ChoiceField(
        choices=[('', _("Sélectionnez un pays"))] + list(countries),
        label=_("Pays de départ"),
        widget=CountrySelectWidget(attrs={'class': 'form-control'})
    )

    end_country = forms.ChoiceField(
        choices=[('', _("Sélectionnez un pays"))] + list(countries),
        label=_("Pays d'arrivée"),
        widget=CountrySelectWidget(attrs={'class': 'form-control'})
    )

    class Meta:
        model = CarrierRoute
        fields = [
            'start_country', 'start_city', 'end_country', 'end_city',
            'frequency', 'departure_date', 'arrival_date',
            'available_weight', 'available_volume', 'fixed_price'
        ]

        widgets = {
            'frequency': forms.Select(attrs={'class': 'form-control'}),
            'departure_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
            'arrival_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
            'start_city': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Ville de départ")
            }),
            'end_city': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Ville d'arrivée")
            }),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        # Pré-remplir les champs si l'instance existe
        if self.instance.pk:
            self.fields['start_country'].initial = self.instance.start_country
            self.fields['end_country'].initial = self.instance.end_country

    def clean(self):
        cleaned_data = super().clean()
        departure_date = cleaned_data.get('departure_date')
        arrival_date = cleaned_data.get('arrival_date')

        if departure_date and arrival_date:
            if arrival_date < departure_date:
                self.add_error('arrival_date',
                             _("La date d'arrivée doit être postérieure à la date de départ."))

            if departure_date < timezone.now().date():
                self.add_error('departure_date',
                             _("La date de départ ne peut pas être dans le passé."))

        return cleaned_data

    def save(self, commit=True):
        # S'assurer que les pays sont sauvegardés correctement
        instance = super().save(commit=False)
        instance.start_country = self.cleaned_data.get('start_country')
        instance.end_country = self.cleaned_data.get('end_country')

        if commit:
            instance.save()

        return instance


class CarrierDocumentForm(forms.ModelForm):
    """Formulaire pour télécharger un document"""

    class Meta:
        model = CarrierDocument
        fields = ['document_type', 'file', 'description', 'expiry_date']

        widgets = {
            'document_type': forms.Select(attrs={'class': 'form-control'}),
            'file': forms.FileInput(attrs={'class': 'form-control'}),
            'description': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Description du document")
            }),
            'expiry_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
        }


class CarrierReviewForm(forms.ModelForm):
    """Formulaire pour laisser un avis sur un transporteur"""

    class Meta:
        model = CarrierReview
        fields = [
            'rating', 'title', 'comment',
            'communication', 'punctuality', 'handling', 'professionalism'
        ]

        widgets = {
            'rating': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '1',
                'max': '5'
            }),
            'title': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Titre de votre avis")
            }),
            'comment': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _("Partagez votre expérience...")
            }),
            'communication': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '1',
                'max': '5'
            }),
            'punctuality': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '1',
                'max': '5'
            }),
            'handling': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '1',
                'max': '5'
            }),
            'professionalism': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '1',
                'max': '5'
            }),
        }

        labels = {
            'communication': _("Communication (1-5)"),
            'punctuality': _("Ponctualité (1-5)"),
            'handling': _("Manutention (1-5)"),
            'professionalism': _("Professionalisme (1-5)"),
        }


class CarrierSearchForm(forms.Form):
    """Formulaire de recherche de transporteurs"""

    carrier_type = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous"))] + list(Carrier.CarrierType.choices),
        label=_("Type de transporteur"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    vehicle_type = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous"))] + list(Carrier.VehicleType.choices),
        label=_("Type de véhicule"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    # CORRECTION: Utiliser forms.ChoiceField avec la liste des pays
    start_country = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous les pays"))] + list(countries),
        label=_("Pays de départ"),
        widget=CountrySelectWidget(attrs={'class': 'form-control'})
    )

    end_country = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous les pays"))] + list(countries),
        label=_("Pays de destination"),
        widget=CountrySelectWidget(attrs={'class': 'form-control'})
    )

    start_city = forms.CharField(
        required=False,
        label=_("Ville de départ"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Ex: Paris, Casablanca...")
        })
    )

    end_city = forms.CharField(
        required=False,
        label=_("Ville d'arrivée"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Ex: Lyon, Rabat...")
        })
    )

    departure_date = forms.DateField(
        required=False,
        label=_("Date de départ"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    max_weight = forms.DecimalField(
        required=False,
        min_value=0,
        decimal_places=3,
        label=_("Poids maximum (kg)"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Poids de votre objet")
        })
    )

    min_rating = forms.DecimalField(
        required=False,
        min_value=0,
        max_value=5,
        decimal_places=2,
        label=_("Note minimum"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Ex: 4.0")
        })
    )

    provides_insurance = forms.BooleanField(
        required=False,
        label=_("Fournit l'assurance"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    provides_packaging = forms.BooleanField(
        required=False,
        label=_("Fournit l'emballage"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    sort_by = forms.ChoiceField(
        required=False,
        choices=[
            ('rating', _("Meilleure note")),
            ('price', _("Prix le plus bas")),
            ('experience', _("Plus d'expérience")),
            ('newest', _("Plus récent")),
        ],
        initial='rating',
        label=_("Trier par"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )


# Formsets
CarrierDocumentFormSet = inlineformset_factory(
    Carrier,
    CarrierDocument,
    form=CarrierDocumentForm,
    extra=3,
    max_num=10,
    can_delete=True,
)

CarrierRouteFormSet = inlineformset_factory(
    Carrier,
    CarrierRoute,
    form=CarrierRouteForm,
    extra=1,
    max_num=20,
    can_delete=True,
)


========== carriers/__init__.py ==========



========== carriers/apps.py ==========
# carriers/apps.py
from django.apps import AppConfig

class CarriersConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "carriers"
    verbose_name = "Transporteurs"

    def ready(self):
        import carriers.signals  # Ajoutez cette ligne


========== carriers/urls.py ==========
# ~/ebi3/carriers/urls.py

from django.urls import path, include
from django.views.generic import TemplateView
from . import views

app_name = 'carriers'

urlpatterns = [
    # ============================================================================
    # PAGES PUBLIQUES
    # ============================================================================

    # Liste des transporteurs
    path('', views.CarrierListView.as_view(), name='carrier_list'),

    # Recherche avancée
    path('search/', views.CarrierSearchView.as_view(), name='search'),

    # ============================================================================
    # INSCRIPTION ET PROFIL TRANSPORTEUR (PLACÉS AVANT LES URLS GÉNÉRIQUES)
    # ============================================================================

    # Devenir transporteur
    path('apply/', views.CarrierApplyView.as_view(), name='apply'),
    path('apply/success/', TemplateView.as_view(template_name='carriers/apply_success.html'), name='apply_success'),

    # Documents et vérifications
    path('documents/upload/', views.DocumentUploadView.as_view(), name='document_upload'),
    path('documents/<int:pk>/delete/', views.DocumentDeleteView.as_view(), name='document_delete'),
    path('verification/', views.VerificationStatusView.as_view(), name='verification_status'),

    # ============================================================================
    # PROFIL PUBLIC DES TRANSPORTEURS
    # ============================================================================

    # Détail d'un transporteur (doit être APRÈS les URLs spécifiques)
    path('<str:username>/', views.CarrierDetailView.as_view(), name='carrier_detail'),

    # Avis sur un transporteur
    path('<str:username>/reviews/', views.CarrierReviewsView.as_view(), name='carrier_reviews'),
    path('<str:username>/review/create/', views.ReviewCreateView.as_view(), name='create_review'),
    path('review/<int:pk>/update/', views.ReviewUpdateView.as_view(), name='update_review'),
    path('review/<int:pk>/delete/', views.ReviewDeleteView.as_view(), name='delete_review'),

    # ============================================================================
    # DASHBOARD TRANSPORTEUR (authentifié)
    # ============================================================================

    # Dashboard principal
    path('dashboard/', views.CarrierDashboardView.as_view(), name='carrier_dashboard'),

    # Gestion du profil
    path('dashboard/profile/', views.CarrierProfileUpdateView.as_view(), name='profile_update'),
    path('dashboard/profile/complete/', views.ProfileCompletionView.as_view(), name='profile_completion'),

    # Disponibilité
    path('dashboard/availability/', views.AvailabilityUpdateView.as_view(), name='availability_update'),
    path('dashboard/availability/toggle/', views.toggle_availability, name='toggle_availability'),

    # ============================================================================
    # NOUVELLE INTÉGRATION AVEC LOGISTICS
    # ============================================================================

    # Missions logistiques du transporteur
    path('<str:username>/missions/', views.CarrierMissionsView.as_view(), name='carrier_missions'),
    path('dashboard/missions/', views.CarrierMissionsDashboardView.as_view(), name='missions_dashboard'),
    path('dashboard/missions/active/', views.ActiveMissionsView.as_view(), name='active_missions'),
    path('dashboard/missions/completed/', views.CompletedMissionsView.as_view(), name='completed_missions'),
    path('dashboard/missions/<int:pk>/', views.MissionDetailView.as_view(), name='mission_detail'),

    # Routes du transporteur
    path('<str:username>/routes/', views.CarrierRoutesView.as_view(), name='carrier_routes'),
    path('dashboard/routes/', views.CarrierRoutesDashboardView.as_view(), name='routes_dashboard'),
    path('dashboard/routes/create/', views.RouteCreateView.as_view(), name='route_create'),
    path('dashboard/routes/<int:pk>/edit/', views.RouteUpdateView.as_view(), name='route_update'),
    path('dashboard/routes/<int:pk>/delete/', views.RouteDeleteView.as_view(), name='route_delete'),
    path('dashboard/routes/<int:pk>/toggle/', views.toggle_route_status, name='toggle_route_status'),

    # Propositions de transport
    path('<str:username>/proposals/', views.CarrierProposalsView.as_view(), name='carrier_proposals'),
    path('dashboard/proposals/', views.CarrierProposalsDashboardView.as_view(), name='proposals_dashboard'),
    path('dashboard/proposals/active/', views.ActiveProposalsView.as_view(), name='active_proposals'),
    path('dashboard/proposals/accepted/', views.AcceptedProposalsView.as_view(), name='accepted_proposals'),
    path('dashboard/proposals/expired/', views.ExpiredProposalsView.as_view(), name='expired_proposals'),

    # Dashboard logistique complet
    path('dashboard/logistics/', views.CarrierLogisticsDashboardView.as_view(), name='carrier_logistics_dashboard'),

    # Statistiques et rapports
    path('dashboard/statistics/', views.CarrierStatisticsView.as_view(), name='carrier_statistics'),
    path('dashboard/reports/', views.CarrierReportsView.as_view(), name='carrier_reports'),
    path('dashboard/earnings/', views.EarningsView.as_view(), name='earnings'),

    # ============================================================================
    # GESTION DES CAPACITÉS ET SERVICES
    # ============================================================================

    # Capacités
    path('dashboard/capacities/', views.CapacitiesUpdateView.as_view(), name='capacities_update'),

    # Services
    path('dashboard/services/', views.ServicesUpdateView.as_view(), name='services_update'),

    # Véhicules
    path('dashboard/vehicles/', views.VehiclesListView.as_view(), name='vehicles_list'),
    path('dashboard/vehicles/add/', views.VehicleCreateView.as_view(), name='vehicle_create'),
    path('dashboard/vehicles/<int:pk>/edit/', views.VehicleUpdateView.as_view(), name='vehicle_update'),
    path('dashboard/vehicles/<int:pk>/delete/', views.VehicleDeleteView.as_view(), name='vehicle_delete'),

    # ============================================================================
    # GESTION DES DOCUMENTS ET ASSURANCES
    # ============================================================================

    # Documents
    path('dashboard/documents/', views.DocumentsListView.as_view(), name='documents_list'),
    path('dashboard/documents/add/', views.DocumentCreateView.as_view(), name='document_create'),

    # Assurances
    path('dashboard/insurance/', views.InsuranceInfoView.as_view(), name='insurance_info'),
    path('dashboard/insurance/update/', views.InsuranceUpdateView.as_view(), name='insurance_update'),

    # ============================================================================
    # COMMUNICATION ET NOTIFICATIONS
    # ============================================================================

    # Messagerie
    path('dashboard/messages/', views.CarrierMessagesView.as_view(), name='carrier_messages'),
    path('dashboard/messages/unread/', views.UnreadMessagesView.as_view(), name='unread_messages'),

    # Notifications
    path('dashboard/notifications/', views.CarrierNotificationsView.as_view(), name='carrier_notifications'),
    path('dashboard/notifications/mark-all-read/', views.mark_all_notifications_read, name='mark_all_notifications_read'),

    # ============================================================================
    # PARAMÈTRES ET CONFIGURATION
    # ============================================================================

    # Paramètres
    path('dashboard/settings/', views.CarrierSettingsView.as_view(), name='carrier_settings'),
    path('dashboard/settings/notifications/', views.NotificationSettingsView.as_view(), name='notification_settings'),
    path('dashboard/settings/privacy/', views.PrivacySettingsView.as_view(), name='privacy_settings'),

    # Sécurité
    path('dashboard/security/', views.SecuritySettingsView.as_view(), name='security_settings'),

    # ============================================================================
    # PAGES D'AIDE ET SUPPORT
    # ============================================================================

    # Aide et support
    path('help/', views.CarrierHelpView.as_view(), name='carrier_help'),
    path('faq/', views.CarrierFAQView.as_view(), name='carrier_faq'),
    path('guide/', views.CarrierGuideView.as_view(), name='carrier_guide'),
    path('contact-support/', views.ContactSupportView.as_view(), name='contact_support'),

    # Termes et conditions
    path('terms/', views.CarrierTermsView.as_view(), name='carrier_terms'),
    path('privacy/', views.CarrierPrivacyView.as_view(), name='carrier_privacy'),

    # ============================================================================
    # REDIRECTIONS ET PAGES SPÉCIALES
    # ============================================================================

    # Redirections
    path('profile/redirect/', views.profile_redirect, name='profile_redirect'),
    path('dashboard/redirect/', views.dashboard_redirect, name='dashboard_redirect'),

    # Pages spéciales
    path('become-carrier/', TemplateView.as_view(template_name='carriers/become_carrier.html'), name='become_carrier'),
    path('success-stories/', views.SuccessStoriesView.as_view(), name='success_stories'),
    path('testimonials/', views.TestimonialsView.as_view(), name='testimonials'),

    # ============================================================================
    # API ET WEBHOOKS (PLACÉS APRÈS LES URLs GÉNÉRIQUES)
    # ============================================================================

    # API pour applications mobiles
    path('api/v1/', include([
        path('profile/', views.CarrierProfileAPIView.as_view(), name='api_profile'),
        path('missions/', views.MissionsAPIView.as_view(), name='api_missions'),
        path('missions/<int:pk>/', views.MissionDetailAPIView.as_view(), name='api_mission_detail'),
        path('routes/', views.RoutesAPIView.as_view(), name='api_routes'),
        path('earnings/', views.EarningsAPIView.as_view(), name='api_earnings'),
        path('location/update/', views.UpdateLocationAPIView.as_view(), name='api_update_location'),
    ])),

    # Webhooks pour paiements et notifications externes
    path('webhooks/stripe/', views.StripeWebhookView.as_view(), name='stripe_webhook'),
    path('webhooks/tracking/', views.TrackingWebhookView.as_view(), name='tracking_webhook'),
]

# URLs conditionnelles pour le développement
import sys
if 'runserver' in sys.argv or 'test' in sys.argv:
    urlpatterns += [
        # URLs de test et développement
        path('test/dashboard/', views.TestDashboardView.as_view(), name='test_dashboard'),
        path('test/missions/', views.TestMissionsView.as_view(), name='test_missions'),
        path('test/routes/', views.TestRoutesView.as_view(), name='test_routes'),
        path('debug/statistics/', views.DebugStatisticsView.as_view(), name='debug_statistics'),
    ]

# Handler d'erreurs spécifiques aux transporteurs
handler404 = 'carriers.views.handler404'
handler500 = 'carriers.views.handler500'


========== carriers/models.py ==========
# ~/ebi3/carriers/models.py
from django.db import models
from django.utils.translation import gettext_lazy as _
from django.utils import timezone
from django.core.validators import MinValueValidator, MaxValueValidator
from django_countries.fields import CountryField
from django.contrib.gis.db import models as gis_models
from django.contrib.gis.geos import Point
from phonenumber_field.modelfields import PhoneNumberField
from django.urls import reverse  # AJOUT IMPORT MANQUANT
import uuid
from users.models import User

class Carrier(models.Model):
    """Transporteur (professionnel ou particulier)"""

    class CarrierType(models.TextChoices):
        PROFESSIONAL = 'PROFESSIONAL', _('Professionnel')
        PERSONAL = 'PERSONAL', _('Particulier (Expatrié)')

    class Status(models.TextChoices):
        PENDING = 'PENDING', _('En attente')
        APPROVED = 'APPROVED', _('Approuvé')
        REJECTED = 'REJECTED', _('Rejeté')
        SUSPENDED = 'SUSPENDED', _('Suspendu')
        INACTIVE = 'INACTIVE', _('Inactif')

    class VehicleType(models.TextChoices):
        CAR = 'CAR', _('Voiture')
        VAN = 'VAN', _('Camionnette')
        TRUCK_SMALL = 'TRUCK_SMALL', _('Camion (3.5T)')
        TRUCK_MEDIUM = 'TRUCK_MEDIUM', _('Camion (7.5T)')
        TRUCK_LARGE = 'TRUCK_LARGE', _('Camion (19T+)')
        MOTORCYCLE = 'MOTORCYCLE', _('Moto')
        OTHER = 'OTHER', _('Autre')

    # Relation avec l'utilisateur
    user = models.OneToOneField(
        User,
        on_delete=models.CASCADE,
        related_name='carrier_profile',
        verbose_name=_("Utilisateur")
    )

    # Type de transporteur
    carrier_type = models.CharField(
        max_length=20,
        choices=CarrierType.choices,
        verbose_name=_("Type de transporteur")
    )

    # Statut et vérification
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.PENDING,
        verbose_name=_("Statut")
    )

    verification_level = models.IntegerField(
        default=0,
        validators=[MinValueValidator(0), MaxValueValidator(5)],
        verbose_name=_("Niveau de vérification"),
        help_text=_("De 0 (non vérifié) à 5 (entièrement vérifié)")
    )

    verified_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Vérifié le")
    )

    rejection_reason = models.TextField(
        blank=True,
        verbose_name=_("Raison du rejet")
    )

    # Informations professionnelles (pour les pros)
    company_name = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Nom de l'entreprise")
    )

    company_registration = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Numéro d'immatriculation")
    )

    tax_id = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Numéro fiscal/TVA")
    )

    company_address = models.TextField(
        blank=True,
        verbose_name=_("Adresse de l'entreprise")
    )

    # Documents
    registration_certificate = models.FileField(
        upload_to='carriers/documents/registration/',
        null=True,
        blank=True,
        verbose_name=_("Certificat d'immatriculation")
    )

    insurance_certificate = models.FileField(
        upload_to='carriers/documents/insurance/',
        null=True,
        blank=True,
        verbose_name=_("Certificat d'assurance")
    )

    operator_license = models.FileField(
        upload_to='carriers/documents/license/',
        null=True,
        blank=True,
        verbose_name=_("Licence d'exploitation")
    )

    # Véhicule
    vehicle_type = models.CharField(
        max_length=20,
        choices=VehicleType.choices,
        verbose_name=_("Type de véhicule")
    )

    vehicle_make = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Marque du véhicule")
    )

    vehicle_model = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Modèle du véhicule")
    )

    vehicle_year = models.PositiveIntegerField(
        null=True,
        blank=True,
        verbose_name=_("Année du véhicule"),
        validators=[MinValueValidator(1990), MaxValueValidator(2100)]
    )

    vehicle_registration = models.CharField(
        max_length=50,
        blank=True,
        verbose_name=_("Plaque d'immatriculation")
    )

    # Capacités
    max_weight = models.DecimalField(
        max_digits=8,
        decimal_places=3,
        default=100,
        verbose_name=_("Poids maximum (kg)"),
        help_text=_("Charge utile maximale")
    )

    max_volume = models.DecimalField(
        max_digits=10,
        decimal_places=3,
        default=1,
        verbose_name=_("Volume maximum (m³)"),
        help_text=_("Volume utile maximum")
    )

    max_length = models.DecimalField(
        max_digits=6,
        decimal_places=2,
        default=1.5,
        verbose_name=_("Longueur maximum (m)")
    )

    max_width = models.DecimalField(
        max_digits=6,
        decimal_places=2,
        default=1,
        verbose_name=_("Largeur maximum (m)")
    )

    max_height = models.DecimalField(
        max_digits=6,
        decimal_places=2,
        default=1,
        verbose_name=_("Hauteur maximum (m)")
    )

    # Services proposés
    provides_packaging = models.BooleanField(
        default=False,
        verbose_name=_("Fournit l'emballage")
    )

    provides_insurance = models.BooleanField(
        default=False,
        verbose_name=_("Fournit l'assurance")
    )

    provides_loading = models.BooleanField(
        default=False,
        verbose_name=_("Fournit le chargement")
    )

    provides_unloading = models.BooleanField(
        default=False,
        verbose_name=_("Fournit le déchargement")
    )

    # Tarification
    base_price_per_km = models.DecimalField(
        max_digits=8,
        decimal_places=4,
        default=1.0,
        verbose_name=_("Prix de base par km (€)")
    )

    min_price = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        default=10.0,
        verbose_name=_("Prix minimum (€)")
    )

    currency = models.CharField(
        max_length=3,
        default='EUR',
        choices=[
            ('EUR', '€'),
            ('USD', '$'),
            ('GBP', '£'),
            ('MAD', 'DH'),
            ('XOF', 'CFA'),
        ],
        verbose_name=_("Devise")
    )

    # Disponibilité
    is_available = models.BooleanField(
        default=True,
        verbose_name=_("Disponible pour des missions")
    )

    available_from = models.DateField(
        null=True,
        blank=True,
        verbose_name=_("Disponible à partir du")
    )

    available_until = models.DateField(
        null=True,
        blank=True,
        verbose_name=_("Disponible jusqu'au")
    )

    # Statistiques
    total_missions = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Total des missions")
    )

    completed_missions = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Missions complétées")
    )

    success_rate = models.DecimalField(
        max_digits=5,
        decimal_places=2,
        default=100.00,
        validators=[MinValueValidator(0), MaxValueValidator(100)],
        verbose_name=_("Taux de réussite (%)")
    )

    average_rating = models.DecimalField(
        max_digits=3,
        decimal_places=2,
        default=0.00,
        validators=[MinValueValidator(0), MaxValueValidator(5)],
        verbose_name=_("Note moyenne")
    )

    total_reviews = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Nombre total d'avis")
    )

    # Métadonnées
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    approved_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        verbose_name = _("Transporteur")
        verbose_name_plural = _("Transporteurs")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status', 'carrier_type']),
            models.Index(fields=['is_available', 'status']),
            models.Index(fields=['user', 'status']),
        ]
        permissions = [
            ('can_verify_carrier', 'Peut vérifier les transporteurs'),
            ('can_approve_carrier', 'Peut approuver les transporteurs'),
            ('can_view_carrier_stats', 'Peut voir les statistiques des transporteurs'),
        ]

    def __str__(self):
        if self.carrier_type == self.CarrierType.PROFESSIONAL and self.company_name:
            return f"{self.company_name} ({self.user.username})"
        return f"{self.user.username} ({self.get_carrier_type_display()})"

    def save(self, *args, **kwargs):
        # Mettre à jour la date d'approbation
        if self.status == self.Status.APPROVED and not self.approved_at:
            self.approved_at = timezone.now()
            self.verified_at = timezone.now()

        # Mettre à jour le niveau de vérification
        if self.status == self.Status.APPROVED and self.verification_level < 3:
            self.verification_level = 3

        super().save(*args, **kwargs)

        # CORRECTION : Mettre à jour le rôle de l'utilisateur de manière sécurisée
        try:
            from django.db import transaction
            with transaction.atomic():
                user = User.objects.select_for_update().get(pk=self.user.pk)
                if self.carrier_type == self.CarrierType.PROFESSIONAL and user.role != User.Role.CARRIER:
                    user.role = User.Role.CARRIER
                    user.save(update_fields=['role'])
                elif self.carrier_type == self.CarrierType.PERSONAL and user.role != User.Role.CARRIER_PERSONAL:
                    user.role = User.Role.CARRIER_PERSONAL
                    user.save(update_fields=['role'])
        except Exception as e:
            # Log l'erreur mais ne casse pas la sauvegarde
            import logging
            logger = logging.getLogger(__name__)
            logger.warning(f"Erreur lors de la mise à jour du rôle utilisateur : {e}")

    def get_absolute_url(self):
        # CORRECTION : Utilisation correcte de reverse avec kwargs
        return reverse('carriers:carrier_detail', kwargs={'username': self.user.username})

    def calculate_success_rate(self):
        """Calcule le taux de réussite"""
        if self.total_missions > 0:
            return (self.completed_missions / self.total_missions) * 100
        return 100.00

    def can_carry_item(self, weight, length, width, height):
        """Vérifie si le transporteur peut transporter un objet"""
        if weight > self.max_weight:
            return False

        volume = length * width * height
        if volume > self.max_volume:
            return False

        if length > self.max_length or width > self.max_width or height > self.max_height:
            return False

        return True

    def get_available_routes(self):
        """Retourne les routes disponibles"""
        return self.routes.filter(is_active=True)

    def is_fully_verified(self):
        """Vérifie si le transporteur est entièrement vérifié"""
        return self.verification_level >= 3 and self.status == self.Status.APPROVED

    def update_average_rating(self):
        """Met à jour la note moyenne du transporteur"""
        # CORRECTION : Méthode pour mettre à jour la note moyenne
        from django.db.models import Avg
        reviews = self.reviews.filter(is_approved=True, is_visible=True)
        if reviews.exists():
            avg = reviews.aggregate(avg_rating=Avg('rating'))['avg_rating']
            self.average_rating = avg or 0.00
            self.total_reviews = reviews.count()
        else:
            self.average_rating = 0.00
            self.total_reviews = 0

        # Sauvegarder sans déclencher la méthode save complète pour éviter la récursion
        Carrier.objects.filter(pk=self.pk).update(
            average_rating=self.average_rating,
            total_reviews=self.total_reviews
        )


class CarrierRoute(gis_models.Model):
    """Route régulière d'un transporteur"""

    carrier = models.ForeignKey(
        Carrier,
        on_delete=models.CASCADE,
        related_name='carrier_routes',  # CORRECTION : Changé de 'carrier_routes' à 'routes' pour cohérence
        verbose_name=_("Transporteur")
    )

    # Points de départ et d'arrivée
    start_country = CountryField(
        verbose_name=_("Pays de départ")
    )

    start_city = models.CharField(
        max_length=100,
        verbose_name=_("Ville de départ")
    )

    start_location = gis_models.PointField(
        null=True,
        blank=True,
        verbose_name=_("Localisation de départ"),
        help_text=_("Coordonnées GPS du point de départ")
    )

    end_country = CountryField(
        verbose_name=_("Pays d'arrivée")
    )

    end_city = models.CharField(
        max_length=100,
        verbose_name=_("Ville d'arrivée")
    )

    end_location = gis_models.PointField(
        null=True,
        blank=True,
        verbose_name=_("Localisation d'arrivée"),
        help_text=_("Coordonnées GPS du point d'arrivée")
    )

    # Fréquence
    class Frequency(models.TextChoices):
        ONE_TIME = 'ONE_TIME', _('Ponctuel')
        WEEKLY = 'WEEKLY', _('Hebdomadaire')
        BIWEEKLY = 'BIWEEKLY', _('Bimensuel')
        MONTHLY = 'MONTHLY', _('Mensuel')
        REGULAR = 'REGULAR', _('Régulier')

    frequency = models.CharField(
        max_length=20,
        choices=Frequency.choices,
        default=Frequency.ONE_TIME,
        verbose_name=_("Fréquence")
    )

    # Dates
    departure_date = models.DateField(
        verbose_name=_("Date de départ")
    )

    arrival_date = models.DateField(
        verbose_name=_("Date d'arrivée")
    )

    # Capacités disponibles sur cette route
    available_weight = models.DecimalField(
        max_digits=8,
        decimal_places=3,
        default=0,
        verbose_name=_("Poids disponible (kg)")
    )

    available_volume = models.DecimalField(
        max_digits=10,
        decimal_places=3,
        default=0,
        verbose_name=_("Volume disponible (m³)")
    )

    # Statut
    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Actif")
    )

    is_full = models.BooleanField(
        default=False,
        verbose_name=_("Complet")
    )

    # Prix spécifique à cette route
    price_per_kg = models.DecimalField(
        max_digits=8,
        decimal_places=4,
        null=True,
        blank=True,
        verbose_name=_("Prix par kg (€)")
    )

    price_per_m3 = models.DecimalField(
        max_digits=8,
        decimal_places=4,
        null=True,
        blank=True,
        verbose_name=_("Prix par m³ (€)")
    )

    fixed_price = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        null=True,
        blank=True,
        verbose_name=_("Prix fixe (€)")
    )

    # Métadonnées
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Route de transporteur")
        verbose_name_plural = _("Routes de transporteurs")
        ordering = ['departure_date']
        indexes = [
            models.Index(fields=['start_country', 'end_country']),
            models.Index(fields=['departure_date', 'is_active']),
            models.Index(fields=['carrier', 'is_active']),
        ]

    def __str__(self):
        return f"{self.start_city} → {self.end_city} ({self.departure_date})"

    def save(self, *args, **kwargs):
        # Définir les prix par défaut si non spécifiés
        if not self.price_per_kg:
            self.price_per_kg = self.carrier.base_price_per_km * 0.1  # Exemple

        if not self.price_per_m3:
            self.price_per_m3 = self.carrier.base_price_per_km * 0.5  # Exemple

        # CORRECTION : Initialiser les capacités disponibles si non définies
        if self.available_weight == 0:
            self.available_weight = self.carrier.max_weight

        if self.available_volume == 0:
            self.available_volume = self.carrier.max_volume

        super().save(*args, **kwargs)

    def calculate_price(self, weight=None, volume=None):
        """Calcule le prix pour un envoi"""
        if self.fixed_price:
            return self.fixed_price

        price = self.carrier.min_price

        if weight and self.price_per_kg:
            price += weight * self.price_per_kg

        if volume and self.price_per_m3:
            price += volume * self.price_per_m3

        return max(price, self.carrier.min_price)

    def update_availability(self, used_weight, used_volume):
        """Met à jour la disponibilité après une réservation"""
        self.available_weight -= used_weight
        self.available_volume -= used_volume

        if self.available_weight <= 0 and self.available_volume <= 0:
            self.is_full = True

        self.save()

    def is_available_for_item(self, weight, volume):
        """Vérifie si la route peut accepter un nouvel objet"""
        if not self.is_active or self.is_full:
            return False

        if weight > self.available_weight or volume > self.available_volume:
            return False

        return True


class CarrierDocument(models.Model):
    """Document d'un transporteur"""

    class DocumentType(models.TextChoices):
        ID_CARD = 'ID_CARD', _("Carte d'identité")
        PASSPORT = 'PASSPORT', _("Passeport")
        DRIVER_LICENSE = 'DRIVER_LICENSE', _("Permis de conduire")
        VEHICLE_REGISTRATION = 'VEHICLE_REGISTRATION', _("Carte grise")
        INSURANCE = 'INSURANCE', _("Assurance")
        COMPANY_REGISTRATION = 'COMPANY_REGISTRATION', _("Immatriculation société")
        TAX_CERTIFICATE = 'TAX_CERTIFICATE', _("Certificat fiscal")
        OTHER = 'OTHER', _("Autre")

    carrier = models.ForeignKey(
        Carrier,
        on_delete=models.CASCADE,
        related_name='documents',
        verbose_name=_("Transporteur")
    )

    document_type = models.CharField(
        max_length=30,
        choices=DocumentType.choices,
        verbose_name=_("Type de document")
    )

    file = models.FileField(
        upload_to='carriers/documents/%Y/%m/%d/',
        verbose_name=_("Fichier")
    )

    thumbnail = models.ImageField(
        upload_to='carriers/documents/thumbnails/%Y/%m/%d/',
        null=True,
        blank=True,
        verbose_name=_("Miniature")
    )

    description = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Description")
    )

    is_verified = models.BooleanField(
        default=False,
        verbose_name=_("Vérifié")
    )

    verified_by = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='verified_documents',
        verbose_name=_("Vérifié par")
    )

    verified_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Vérifié le")
    )

    verification_notes = models.TextField(
        blank=True,
        verbose_name=_("Notes de vérification")
    )

    expiry_date = models.DateField(
        null=True,
        blank=True,
        verbose_name=_("Date d'expiration")
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Document de transporteur")
        verbose_name_plural = _("Documents de transporteurs")
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.get_document_type_display()} - {self.carrier}"

    def is_expired(self):
        """Vérifie si le document est expiré"""
        if self.expiry_date:
            return self.expiry_date < timezone.now().date()
        return False


class CarrierReview(models.Model):
    """Avis sur un transporteur"""

    carrier = models.ForeignKey(
        Carrier,
        on_delete=models.CASCADE,
        related_name='reviews',
        verbose_name=_("Transporteur")
    )

    reviewer = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='carrier_reviews',
        verbose_name=_("Auteur")
    )

    rating = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        verbose_name=_("Note (1-5)")
    )

    title = models.CharField(
        max_length=200,
        verbose_name=_("Titre")
    )

    comment = models.TextField(
        verbose_name=_("Commentaire")
    )

    # Caractéristiques évaluées
    communication = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        default=5,
        verbose_name=_("Communication")
    )

    punctuality = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        default=5,
        verbose_name=_("Ponctualité")
    )

    handling = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        default=5,
        verbose_name=_("Manutention")
    )

    professionalism = models.IntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        default=5,
        verbose_name=_("Professionalisme")
    )

    # Statut
    is_approved = models.BooleanField(
        default=False,
        verbose_name=_("Approuvé")
    )

    is_visible = models.BooleanField(
        default=True,
        verbose_name=_("Visible")
    )

    admin_notes = models.TextField(
        blank=True,
        verbose_name=_("Notes de l'administrateur")
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Avis sur transporteur")
        verbose_name_plural = _("Avis sur transporteurs")
        ordering = ['-created_at']
        unique_together = ['carrier', 'reviewer']
        indexes = [
            models.Index(fields=['carrier', 'is_approved', 'is_visible']),
            models.Index(fields=['reviewer', 'created_at']),
        ]

    def __str__(self):
        return f"Avis de {self.reviewer.username} sur {self.carrier} ({self.rating}/5)"

    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)
        # Mettre à jour la note moyenne du transporteur
        self.carrier.update_average_rating()

    def delete(self, *args, **kwargs):
        carrier = self.carrier
        super().delete(*args, **kwargs)
        # Mettre à jour la note moyenne du transporteur
        carrier.update_average_rating()


class CarrierAvailability(models.Model):
    """Disponibilité d'un transporteur"""

    carrier = models.ForeignKey(
        Carrier,
        on_delete=models.CASCADE,
        related_name='availabilities',
        verbose_name=_("Transporteur")
    )

    start_datetime = models.DateTimeField(
        verbose_name=_("Début de disponibilité")
    )

    end_datetime = models.DateTimeField(
        verbose_name=_("Fin de disponibilité")
    )

    location = gis_models.PointField(
        null=True,
        blank=True,
        verbose_name=_("Localisation")
    )

    available_weight = models.DecimalField(
        max_digits=8,
        decimal_places=3,
        default=0,
        verbose_name=_("Poids disponible (kg)")
    )

    available_volume = models.DecimalField(
        max_digits=10,
        decimal_places=3,
        default=0,
        verbose_name=_("Volume disponible (m³)")
    )

    notes = models.TextField(
        blank=True,
        verbose_name=_("Notes")
    )

    is_booked = models.BooleanField(
        default=False,
        verbose_name=_("Réservé")
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Disponibilité de transporteur")
        verbose_name_plural = _("Disponibilités de transporteurs")
        ordering = ['start_datetime']
        indexes = [
            models.Index(fields=['carrier', 'start_datetime', 'is_booked']),
        ]

    def __str__(self):
        return f"{self.carrier} - {self.start_datetime.strftime('%d/%m/%Y %H:%M')}"

    def is_currently_available(self):
        """Vérifie si la disponibilité est actuelle"""
        now = timezone.now()
        return self.start_datetime <= now <= self.end_datetime and not self.is_booked

    def duration_hours(self):
        """Calcule la durée en heures"""
        duration = self.end_datetime - self.start_datetime
        return duration.total_seconds() / 3600

    def save(self, *args, **kwargs):
        # CORRECTION : Initialiser les capacités disponibles si non définies
        if self.available_weight == 0:
            self.available_weight = self.carrier.max_weight

        if self.available_volume == 0:
            self.available_volume = self.carrier.max_volume

        super().save(*args, **kwargs)


class CarrierNotification(models.Model):
    """Notification pour un transporteur"""

    class NotificationType(models.TextChoices):
        NEW_MISSION = 'NEW_MISSION', _('Nouvelle mission')
        MISSION_UPDATE = 'MISSION_UPDATE', _('Mise à jour de mission')
        PAYMENT_RECEIVED = 'PAYMENT_RECEIVED', _('Paiement reçu')
        REVIEW_RECEIVED = 'REVIEW_RECEIVED', _('Avis reçu')
        DOCUMENT_VERIFIED = 'DOCUMENT_VERIFIED', _('Document vérifié')
        STATUS_CHANGED = 'STATUS_CHANGED', _('Statut changé')
        SYSTEM = 'SYSTEM', _('Système')

    carrier = models.ForeignKey(
        Carrier,
        on_delete=models.CASCADE,
        related_name='notifications',
        verbose_name=_("Transporteur")
    )

    notification_type = models.CharField(
        max_length=30,
        choices=NotificationType.choices,
        verbose_name=_("Type de notification")
    )

    title = models.CharField(
        max_length=200,
        verbose_name=_("Titre")
    )

    message = models.TextField(
        verbose_name=_("Message")
    )

    related_object_id = models.PositiveIntegerField(
        null=True,
        blank=True,
        verbose_name=_("ID objet lié")
    )

    related_object_type = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Type d'objet lié")
    )

    is_read = models.BooleanField(
        default=False,
        verbose_name=_("Lu")
    )

    is_important = models.BooleanField(
        default=False,
        verbose_name=_("Important")
    )

    action_url = models.URLField(
        blank=True,
        verbose_name=_("URL d'action")
    )

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Notification de transporteur")
        verbose_name_plural = _("Notifications de transporteurs")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['carrier', 'is_read', 'created_at']),
        ]

    def __str__(self):
        return f"{self.title} - {self.carrier}"

    def mark_as_read(self):
        """Marque la notification comme lue"""
        self.is_read = True
        self.save(update_fields=['is_read'])


========== carriers/views.py ==========
# ~/ebi3/carriers/views.py
from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.views.generic import (
    ListView, DetailView, CreateView, UpdateView,
    TemplateView, DeleteView, FormView
)
from django.db.models import Q, Count, Avg, F, ExpressionWrapper, DecimalField
from django.utils import timezone
from django.urls import reverse_lazy
from django.contrib import messages
from django.utils.translation import gettext_lazy as _
from django.core.paginator import Paginator
from django.http import JsonResponse, HttpResponseForbidden
from django.views.decorators.http import require_POST
from django.views.decorators.csrf import csrf_protect
from django.db import transaction
from django.db.models import Min, Max, Sum

from .models import (
    Carrier, CarrierRoute, CarrierDocument, CarrierReview,
    CarrierAvailability, CarrierNotification
)
from .forms import (
    CarrierApplicationForm, CarrierUpdateForm,
    CarrierRouteForm, CarrierDocumentForm,
    CarrierReviewForm, CarrierSearchForm,
    CarrierDocumentFormSet, CarrierRouteFormSet
)
from users.models import User
from ads.models import Ad


class CarrierListView(ListView):
    """Liste des transporteurs"""
    model = Carrier
    template_name = 'carriers/carrier_list.html'
    context_object_name = 'carriers'
    paginate_by = 12

    def get_queryset(self):
        queryset = Carrier.objects.filter(
            status=Carrier.Status.APPROVED,
            is_available=True
        ).select_related('user').prefetch_related('routes')

        # Appliquer les filtres
        form = CarrierSearchForm(self.request.GET)
        if form.is_valid():
            if form.cleaned_data.get('carrier_type'):
                queryset = queryset.filter(carrier_type=form.cleaned_data['carrier_type'])

            if form.cleaned_data.get('vehicle_type'):
                queryset = queryset.filter(vehicle_type=form.cleaned_data['vehicle_type'])

            if form.cleaned_data.get('start_country') and form.cleaned_data.get('end_country'):
                queryset = queryset.filter(
                    routes__start_country=form.cleaned_data['start_country'],
                    routes__end_country=form.cleaned_data['end_country'],
                    routes__is_active=True,
                    routes__is_full=False
                ).distinct()

            if form.cleaned_data.get('start_city'):
                queryset = queryset.filter(
                    routes__start_city__icontains=form.cleaned_data['start_city']
                )

            if form.cleaned_data.get('end_city'):
                queryset = queryset.filter(
                    routes__end_city__icontains=form.cleaned_data['end_city']
                )

            if form.cleaned_data.get('departure_date'):
                queryset = queryset.filter(
                    routes__departure_date=form.cleaned_data['departure_date'],
                    routes__is_active=True
                )

            if form.cleaned_data.get('max_weight'):
                queryset = queryset.filter(max_weight__gte=form.cleaned_data['max_weight'])

            if form.cleaned_data.get('min_rating'):
                queryset = queryset.filter(average_rating__gte=form.cleaned_data['min_rating'])

            if form.cleaned_data.get('provides_insurance'):
                queryset = queryset.filter(provides_insurance=True)

            if form.cleaned_data.get('provides_packaging'):
                queryset = queryset.filter(provides_packaging=True)

        # Tri
        sort_by = form.cleaned_data.get('sort_by', 'rating') if form.is_valid() else 'rating'

        if sort_by == 'rating':
            queryset = queryset.order_by('-average_rating')
        elif sort_by == 'price':
            queryset = queryset.order_by('base_price_per_km')
        elif sort_by == 'experience':
            queryset = queryset.order_by('-completed_missions')
        elif sort_by == 'newest':
            queryset = queryset.order_by('-created_at')

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Initialiser le formulaire de recherche
        search_form = CarrierSearchForm(self.request.GET)
        context['search_form'] = search_form

        # Statistiques
        all_carriers = Carrier.objects.filter(status=Carrier.Status.APPROVED)
        context['total_carriers'] = all_carriers.count()
        context['professional_count'] = all_carriers.filter(carrier_type='PROFESSIONAL').count()
        context['personal_count'] = all_carriers.filter(carrier_type='PERSONAL').count()

        # Pagination
        if context['page_obj']:
            context['page_range'] = list(context['page_obj'].paginator.page_range)[:5]

        return context


class CarrierSearchView(FormView):
    """Vue de recherche avancée des transporteurs"""
    template_name = 'carriers/search_results.html'
    form_class = CarrierSearchForm

    def get(self, request, *args, **kwargs):
        form = self.get_form()
        carriers = Carrier.objects.filter(status=Carrier.Status.APPROVED)

        if form.is_valid():
            # Appliquer les filtres (même logique que CarrierListView)
            if form.cleaned_data.get('carrier_type'):
                carriers = carriers.filter(carrier_type=form.cleaned_data['carrier_type'])

            if form.cleaned_data.get('vehicle_type'):
                carriers = carriers.filter(vehicle_type=form.cleaned_data['vehicle_type'])

            if form.cleaned_data.get('start_country'):
                carriers = carriers.filter(routes__start_country=form.cleaned_data['start_country'])

            if form.cleaned_data.get('end_country'):
                carriers = carriers.filter(routes__end_country=form.cleaned_data['end_country'])

            if form.cleaned_data.get('min_rating'):
                carriers = carriers.filter(average_rating__gte=form.cleaned_data['min_rating'])

            if form.cleaned_data.get('provides_insurance'):
                carriers = carriers.filter(provides_insurance=True)

            if form.cleaned_data.get('provides_packaging'):
                carriers = carriers.filter(provides_packaging=True)

        # Pagination
        paginator = Paginator(carriers, 12)
        page = request.GET.get('page')
        carriers_page = paginator.get_page(page)

        context = self.get_context_data(
            form=form,
            carriers=carriers_page,
            total_carriers=carriers.count()
        )

        return render(request, self.template_name, context)


class CarrierDetailView(DetailView):
    """Détail d'un transporteur"""
    model = Carrier
    template_name = 'carriers/carrier_detail.html'
    context_object_name = 'carrier'
    slug_field = 'user__username'
    slug_url_kwarg = 'username'

    def get_object(self):
        return get_object_or_404(
            Carrier.objects.select_related('user').prefetch_related('routes', 'reviews'),
            user__username=self.kwargs['username']
        )

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        carrier = self.object

        # Routes actives
        context['active_routes'] = carrier.routes.filter(
            is_active=True,
            departure_date__gte=timezone.now().date()
        ).order_by('departure_date')

        # Avis approuvés
        context['reviews'] = carrier.reviews.filter(
            is_approved=True,
            is_visible=True
        ).select_related('reviewer').order_by('-created_at')[:5]

        # Statistiques des avis
        if context['reviews']:
            review_stats = carrier.reviews.filter(is_approved=True, is_visible=True).aggregate(
                total_reviews=Count('id'),
                avg_communication=Avg('communication'),
                avg_punctuality=Avg('punctuality'),
                avg_handling=Avg('handling'),
                avg_professionalism=Avg('professionalism')
            )
            context['review_stats'] = review_stats

        # Documents vérifiés
        context['verified_documents'] = carrier.documents.filter(is_verified=True)

        # Vérifier si l'utilisateur peut laisser un avis
        if self.request.user.is_authenticated:
            context['can_review'] = self.request.user != carrier.user
            context['has_reviewed'] = carrier.reviews.filter(reviewer=self.request.user).exists()

        return context


class CarrierApplyView(LoginRequiredMixin, CreateView):
    """Devenir transporteur"""
    model = Carrier
    form_class = CarrierApplicationForm
    template_name = 'carriers/apply.html'

    def dispatch(self, request, *args, **kwargs):
        # Vérifier si l'utilisateur a déjà un profil transporteur
        if hasattr(request.user, 'carrier_profile'):
            messages.warning(request, _("Vous avez déjà un profil transporteur."))
            return redirect('carriers:carrier_detail', username=request.user.username)

        return super().dispatch(request, *args, **kwargs)

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['user'] = self.request.user
        return kwargs

    def form_valid(self, form):
        form.instance.user = self.request.user
        form.instance.status = Carrier.Status.PENDING

        response = super().form_valid(form)
        messages.success(
            self.request,
            _("Votre candidature a été soumise avec succès. "
              "Nous la traiterons dans les plus brefs délais.")
        )

        return response

    def get_success_url(self):
        return reverse_lazy('carriers:apply_success')


class CarrierDashboardView(LoginRequiredMixin, UserPassesTestMixin, TemplateView):
    """Tableau de bord du transporteur"""
    template_name = 'carriers/dashboard.html'

    def test_func(self):
        return hasattr(self.request.user, 'carrier_profile')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        carrier = self.request.user.carrier_profile

        # Statistiques
        context['carrier'] = carrier
        context['active_routes'] = carrier.routes.filter(is_active=True).count()
        context['pending_reviews'] = carrier.reviews.filter(is_approved=False).count()
        context['unread_notifications'] = carrier.notifications.filter(is_read=False).count()

        # Missions récentes (à implémenter avec l'app logistics)
        context['recent_missions'] = []  # Placeholder

        # Revenus (à implémenter)
        context['total_earnings'] = 0  # Placeholder
        context['pending_payments'] = 0  # Placeholder

        return context


class CarrierProfileUpdateView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
    """Mettre à jour le profil transporteur"""
    model = Carrier
    form_class = CarrierUpdateForm
    template_name = 'carriers/profile_update.html'

    def test_func(self):
        carrier = self.get_object()
        return self.request.user == carrier.user

    def get_object(self):
        return self.request.user.carrier_profile

    def get_success_url(self):
        return reverse_lazy('carriers:carrier_dashboard')


class DocumentUploadView(LoginRequiredMixin, UserPassesTestMixin, CreateView):
    """Télécharger un document"""
    model = CarrierDocument
    form_class = CarrierDocumentForm
    template_name = 'carriers/document_upload.html'

    def test_func(self):
        return hasattr(self.request.user, 'carrier_profile')

    def form_valid(self, form):
        form.instance.carrier = self.request.user.carrier_profile
        messages.success(self.request, _("Document téléchargé avec succès."))
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('carriers:verification_status')


class ReviewCreateView(LoginRequiredMixin, CreateView):
    """Laisser un avis sur un transporteur"""
    model = CarrierReview
    form_class = CarrierReviewForm
    template_name = 'carriers/review_create.html'

    def dispatch(self, request, *args, **kwargs):
        self.carrier = get_object_or_404(Carrier, user__username=kwargs['username'])

        # Vérifications
        if request.user == self.carrier.user:
            messages.error(request, _("Vous ne pouvez pas laisser un avis sur votre propre profil."))
            return redirect('carriers:carrier_detail', username=self.carrier.user.username)

        if CarrierReview.objects.filter(carrier=self.carrier, reviewer=request.user).exists():
            messages.warning(request, _("Vous avez déjà laissé un avis pour ce transporteur."))
            return redirect('carriers:carrier_detail', username=self.carrier.user.username)

        return super().dispatch(request, *args, **kwargs)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['carrier'] = self.carrier
        return context

    def form_valid(self, form):
        form.instance.carrier = self.carrier
        form.instance.reviewer = self.request.user
        form.instance.is_approved = False  # Nécessite approbation admin

        messages.success(
            self.request,
            _("Votre avis a été soumis. Il sera visible après modération.")
        )
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('carriers:carrier_detail', username=self.carrier.user.username)


# Vues simples pour les URLs manquantes

class CarrierReviewsView(DetailView):
    """Tous les avis d'un transporteur"""
    model = Carrier
    template_name = 'carriers/carrier_reviews.html'
    slug_field = 'user__username'
    slug_url_kwarg = 'username'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['all_reviews'] = self.object.reviews.filter(
            is_approved=True,
            is_visible=True
        ).select_related('reviewer').order_by('-created_at')
        return context


class ReviewUpdateView(LoginRequiredMixin, UpdateView):
    """Modifier un avis"""
    model = CarrierReview
    form_class = CarrierReviewForm
    template_name = 'carriers/review_update.html'

    def dispatch(self, request, *args, **kwargs):
        review = self.get_object()
        if review.reviewer != request.user:
            return HttpResponseForbidden()
        return super().dispatch(request, *args, **kwargs)

    def get_success_url(self):
        return reverse_lazy('carriers:carrier_detail', username=self.object.carrier.user.username)


class ReviewDeleteView(LoginRequiredMixin, DeleteView):
    """Supprimer un avis"""
    model = CarrierReview
    template_name = 'carriers/review_delete.html'

    def dispatch(self, request, *args, **kwargs):
        review = self.get_object()
        if review.reviewer != request.user:
            return HttpResponseForbidden()
        return super().dispatch(request, *args, **kwargs)

    def get_success_url(self):
        return reverse_lazy('carriers:carrier_detail', username=self.object.carrier.user.username)


class VerificationStatusView(LoginRequiredMixin, UserPassesTestMixin, TemplateView):
    """Statut de vérification"""
    template_name = 'carriers/verification_status.html'

    def test_func(self):
        return hasattr(self.request.user, 'carrier_profile')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        carrier = self.request.user.carrier_profile
        context['carrier'] = carrier
        context['documents'] = carrier.documents.all().order_by('-created_at')
        return context


class DocumentDeleteView(LoginRequiredMixin, UserPassesTestMixin, DeleteView):
    """Supprimer un document"""
    model = CarrierDocument
    template_name = 'carriers/document_delete.html'

    def test_func(self):
        document = self.get_object()
        return self.request.user == document.carrier.user

    def get_success_url(self):
        return reverse_lazy('carriers:verification_status')


# Vues pour la nouvelle intégration avec logistics (simplifiées)

class CarrierMissionsView(ListView):
    """Missions d'un transporteur (vue publique)"""
    template_name = 'carriers/carrier_missions.html'
    context_object_name = 'missions'

    def get_queryset(self):
        self.carrier = get_object_or_404(Carrier, user__username=self.kwargs['username'])
        # À implémenter avec l'app logistics
        return []

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['carrier'] = self.carrier
        return context


class CarrierRoutesView(ListView):
    """Routes d'un transporteur (vue publique)"""
    template_name = 'carriers/carrier_routes.html'
    context_object_name = 'routes'

    def get_queryset(self):
        self.carrier = get_object_or_404(Carrier, user__username=self.kwargs['username'])
        return self.carrier.routes.filter(is_active=True).order_by('departure_date')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['carrier'] = self.carrier
        return context


class CarrierProposalsView(ListView):
    """Propositions d'un transporteur (vue publique)"""
    template_name = 'carriers/carrier_proposals.html'
    context_object_name = 'proposals'

    def get_queryset(self):
        self.carrier = get_object_or_404(Carrier, user__username=self.kwargs['username'])
        # À implémenter avec l'app logistics
        return []

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['carrier'] = self.carrier
        return context


# Vues de dashboard (authentifiées)

class CarrierMissionsDashboardView(LoginRequiredMixin, UserPassesTestMixin, TemplateView):
    template_name = 'carriers/dashboard/missions.html'

    def test_func(self):
        return hasattr(self.request.user, 'carrier_profile')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['carrier'] = self.request.user.carrier_profile
        # À implémenter avec l'app logistics
        return context


class CarrierRoutesDashboardView(LoginRequiredMixin, UserPassesTestMixin, ListView):
    template_name = 'carriers/dashboard/routes.html'
    context_object_name = 'routes'

    def test_func(self):
        return hasattr(self.request.user, 'carrier_profile')

    def get_queryset(self):
        return self.request.user.carrier_profile.routes.all().order_by('-departure_date')


class CarrierProposalsDashboardView(LoginRequiredMixin, UserPassesTestMixin, TemplateView):
    template_name = 'carriers/dashboard/proposals.html'

    def test_func(self):
        return hasattr(self.request.user, 'carrier_profile')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['carrier'] = self.request.user.carrier_profile
        # À implémenter avec l'app logistics
        return context


# Vues utilitaires

@login_required
@require_POST
def toggle_availability(request, username):
    """Basculer la disponibilité"""
    carrier = get_object_or_404(Carrier, user__username=username)

    if request.user != carrier.user:
        return HttpResponseForbidden()

    carrier.is_available = not carrier.is_available
    carrier.save()

    message = _("Vous êtes maintenant disponible.") if carrier.is_available else _("Vous êtes maintenant indisponible.")
    messages.success(request, message)

    return redirect('carriers:carrier_detail', username=username)


@login_required
def mark_all_notifications_read(request):
    """Marquer toutes les notifications comme lues"""
    if hasattr(request.user, 'carrier_profile'):
        request.user.carrier_profile.notifications.filter(is_read=False).update(is_read=True)
        messages.success(request, _("Toutes les notifications ont été marquées comme lues."))

    return redirect('carriers:carrier_dashboard')


# Gestionnaires d'erreurs
def handler404(request, exception):
    return render(request, 'carriers/404.html', status=404)

def handler500(request):
    return render(request, 'carriers/500.html', status=500)


# Placeholders pour les autres URLs
class AvailabilityUpdateView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/availability.html'

class ProfileCompletionView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/profile_completion.html'

class ActiveMissionsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/active_missions.html'

class CompletedMissionsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/completed_missions.html'

class MissionDetailView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/mission_detail.html'

class RouteCreateView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/route_create.html'

class RouteUpdateView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/route_update.html'

class RouteDeleteView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/route_delete.html'

@require_POST
def toggle_route_status(request, pk):
    return redirect('carriers:routes_dashboard')

class ActiveProposalsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/active_proposals.html'

class AcceptedProposalsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/accepted_proposals.html'

class ExpiredProposalsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/expired_proposals.html'

class CarrierLogisticsDashboardView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/logistics_dashboard.html'

class CarrierStatisticsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/statistics.html'

class CarrierReportsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/reports.html'

class EarningsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/earnings.html'

class CapacitiesUpdateView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/capacities.html'

class ServicesUpdateView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/services.html'

class VehiclesListView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/vehicles.html'

class VehicleCreateView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/vehicle_create.html'

class VehicleUpdateView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/vehicle_update.html'

class VehicleDeleteView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/vehicle_delete.html'

class DocumentsListView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/documents.html'

class DocumentCreateView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/document_create.html'

class InsuranceInfoView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/insurance.html'

class InsuranceUpdateView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/insurance_update.html'

class CarrierMessagesView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/messages.html'

class UnreadMessagesView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/unread_messages.html'

class CarrierNotificationsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/notifications.html'

class CarrierSettingsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/settings.html'

class NotificationSettingsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/notification_settings.html'

class PrivacySettingsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/privacy_settings.html'

class SecuritySettingsView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/dashboard/security_settings.html'

class CarrierProfileAPIView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/api/profile.html'

class MissionsAPIView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/api/missions.html'

class MissionDetailAPIView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/api/mission_detail.html'

class RoutesAPIView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/api/routes.html'

class EarningsAPIView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/api/earnings.html'

class UpdateLocationAPIView(LoginRequiredMixin, TemplateView):
    template_name = 'carriers/api/update_location.html'

class StripeWebhookView(TemplateView):
    template_name = 'carriers/webhooks/stripe.html'

class TrackingWebhookView(TemplateView):
    template_name = 'carriers/webhooks/tracking.html'

class CarrierHelpView(TemplateView):
    template_name = 'carriers/help.html'

class CarrierFAQView(TemplateView):
    template_name = 'carriers/faq.html'

class CarrierGuideView(TemplateView):
    template_name = 'carriers/guide.html'

class ContactSupportView(TemplateView):
    template_name = 'carriers/contact_support.html'

class CarrierTermsView(TemplateView):
    template_name = 'carriers/terms.html'

class CarrierPrivacyView(TemplateView):
    template_name = 'carriers/privacy.html'

def profile_redirect(request):
    if hasattr(request.user, 'carrier_profile'):
        return redirect('carriers:carrier_detail', username=request.user.username)
    return redirect('carriers:carrier_list')

def dashboard_redirect(request):
    if hasattr(request.user, 'carrier_profile'):
        return redirect('carriers:carrier_dashboard')
    return redirect('carriers:carrier_list')

class SuccessStoriesView(TemplateView):
    template_name = 'carriers/success_stories.html'

class TestimonialsView(TemplateView):
    template_name = 'carriers/testimonials.html'

# Vues de test et développement
class TestDashboardView(TemplateView):
    template_name = 'carriers/test/dashboard.html'

class TestMissionsView(TemplateView):
    template_name = 'carriers/test/missions.html'

class TestRoutesView(TemplateView):
    template_name = 'carriers/test/routes.html'

class DebugStatisticsView(TemplateView):
    template_name = 'carriers/debug/statistics.html'


========== colis/utils/signal_helpers.py ==========
# ~/ebi3/colis/utils/signal_helpers.py
import logging
from django.db import transaction

logger = logging.getLogger(__name__)

def create_conversation_for_offer(offer):
    """Crée une conversation pour une offre (gère les imports circulaires)"""
    try:
        from messaging.models import Conversation, Message

        # Votre logique de création de conversation
        conversation, created = Conversation.objects.get_or_create(
            package=offer.package,
            carrier=offer.carrier,
            defaults={
                'subject': f"Offre pour le colis #{offer.package.id}",
                'last_message_at': timezone.now()
            }
        )

        if created:
            # Créer le premier message
            Message.objects.create(
                conversation=conversation,
                sender=offer.carrier.user,
                content=f"Bonjour, je vous propose de transporter votre colis pour {offer.price} {offer.currency}.",
                is_read=False
            )

        return conversation

    except ImportError as e:
        logger.error(f"Could not import messaging models: {e}")
        return None
    except Exception as e:
        logger.error(f"Error creating conversation: {e}")
        return None


========== colis/templates/colis/includes/help_widget.html ==========
{# ~/ebi3/colis/templates/colis/includes/help_widget.html #}
{% load i18n %}

{% if user.is_authenticated %}
<div class="help-widget position-fixed bottom-0 end-0 m-3" style="z-index: 1000;">
    <div class="dropdown">
        <button class="btn btn-primary btn-lg rounded-circle shadow-lg"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                style="width: 60px; height: 60px;">
            <i class="fas fa-question"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end p-3" style="min-width: 300px;">
            <li class="dropdown-header mb-2">
                <strong>{% trans "Aide rapide" %}</strong>
            </li>
            <li>
                <a class="dropdown-item" href="{% url 'colis:how_it_works' %}">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    {% trans "Comment ça marche" %}
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="{% url 'colis:price_guide' %}">
                    <i class="fas fa-euro-sign text-success me-2"></i>
                    {% trans "Guide des prix" %}
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="{% url 'core:faq' %}">
                    <i class="fas fa-question-circle text-info me-2"></i>
                    {% trans "FAQ" %}
                </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item" href="{% url 'core:contact' %}">
                    <i class="fas fa-envelope text-warning me-2"></i>
                    {% trans "Contactez-nous" %}
                </a>
            </li>
            <li class="mt-2">
                <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    {% trans "Support disponible 7j/7" %}
                </small>
            </li>
        </ul>
    </div>
</div>
{% endif %}


========== colis/templates/colis/my_packages.html ==========
{# ~/ebi3/colis/templates/colis/my_packages.html #}
{% extends 'colis/base_colis.html' %}
{% load i18n %}

{% block title %}{% trans "Mes colis" %} - Ebi3{% endblock %}

{% block colis_title %}{% trans "Mes colis" %}{% endblock %}

{% block colis_content %}
<div class="container">
    <!-- En-tête avec statistiques -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-light">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-0">{% trans "Mes colis" %}</h2>
                            <p class="text-muted mb-0">{% trans "Gérez tous vos colis publiés" %}</p>
                        </div>
                        <div>
                            <a href="{% url 'colis:package_create' %}" class="btn btn-success">
                                <i class="fas fa-plus"></i> {% trans "Publier un nouveau colis" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">{% trans "Statut" %}</label>
                            <select name="status" class="form-select" onchange="this.form.submit()">
                                <option value="">{% trans "Tous les statuts" %}</option>
                                <option value="DRAFT" {% if request.GET.status == 'DRAFT' %}selected{% endif %}>
                                    {% trans "Brouillon" %}
                                </option>
                                <option value="AVAILABLE" {% if request.GET.status == 'AVAILABLE' %}selected{% endif %}>
                                    {% trans "Disponible" %}
                                </option>
                                <option value="RESERVED" {% if request.GET.status == 'RESERVED' %}selected{% endif %}>
                                    {% trans "Réservé" %}
                                </option>
                                <option value="IN_TRANSIT" {% if request.GET.status == 'IN_TRANSIT' %}selected{% endif %}>
                                    {% trans "En transit" %}
                                </option>
                                <option value="DELIVERED" {% if request.GET.status == 'DELIVERED' %}selected{% endif %}>
                                    {% trans "Livré" %}
                                </option>
                                <option value="CANCELLED" {% if request.GET.status == 'CANCELLED' %}selected{% endif %}>
                                    {% trans "Annulé" %}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">{% trans "Tri" %}</label>
                            <select name="sort_by" class="form-select" onchange="this.form.submit()">
                                <option value="-created_at" {% if request.GET.sort_by == '-created_at' %}selected{% endif %}>
                                    {% trans "Plus récent" %}
                                </option>
                                <option value="created_at" {% if request.GET.sort_by == 'created_at' %}selected{% endif %}>
                                    {% trans "Plus ancien" %}
                                </option>
                                <option value="title" {% if request.GET.sort_by == 'title' %}selected{% endif %}>
                                    {% trans "Titre (A-Z)" %}
                                </option>
                                <option value="-title" {% if request.GET.sort_by == '-title' %}selected{% endif %}>
                                    {% trans "Titre (Z-A)" %}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="input-group">
                                <input type="text" name="q" class="form-control"
                                       placeholder="{% trans 'Rechercher dans mes colis...' %}"
                                       value="{{ request.GET.q|default:'' }}">
                                <button class="btn btn-outline-primary" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                                {% if request.GET %}
                                <a href="{% url 'colis:my_packages' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="h3 text-primary">{{ total_packages }}</div>
                            <small class="text-muted">{% trans "Total" %}</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h3 text-success">{{ available_packages }}</div>
                            <small class="text-muted">{% trans "Disponibles" %}</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h3 text-info">{{ reserved_packages }}</div>
                            <small class="text-muted">{% trans "Réservés" %}</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h3 text-success">{{ delivered_packages }}</div>
                            <small class="text-muted">{% trans "Livrés" %}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des colis -->
    {% if packages %}
    <div class="row">
        {% for package in packages %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 border">
                <!-- Badge statut -->
                <div class="card-header bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge
                            {% if package.status == 'AVAILABLE' %}bg-success
                            {% elif package.status == 'RESERVED' %}bg-info
                            {% elif package.status == 'IN_TRANSIT' %}bg-warning
                            {% elif package.status == 'DELIVERED' %}bg-primary
                            {% elif package.status == 'CANCELLED' %}bg-danger
                            {% else %}bg-secondary{% endif %}">
                            {{ package.get_status_display }}
                        </span>
                        {% if package.is_featured %}
                        <span class="badge bg-warning">
                            <i class="fas fa-star"></i> {% trans "En vedette" %}
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Image -->
                <div class="position-relative">
                    {% with package.images.first as main_image %}
                        {% if main_image %}
                            <img src="{{ main_image.image.url }}"
                                 class="card-img-top"
                                 alt="{{ package.title }}"
                                 style="height: 180px; object-fit: cover;">
                        {% else %}
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center"
                                 style="height: 180px;">
                                <i class="fas fa-box fa-3x text-muted"></i>
                            </div>
                        {% endif %}
                    {% endwith %}
                </div>

                <!-- Contenu -->
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="{{ package.get_absolute_url }}" class="text-decoration-none text-dark">
                            {{ package.title|truncatechars:50 }}
                        </a>
                    </h5>

                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-map-marker-alt text-danger me-2"></i>
                            <small>{{ package.pickup_city|truncatechars:20 }}</small>
                            <i class="fas fa-arrow-right mx-2 text-muted"></i>
                            <i class="fas fa-map-marker-alt text-success me-2"></i>
                            <small>{{ package.delivery_city|truncatechars:20 }}</small>
                        </div>

                        <div class="d-flex justify-content-between small text-muted mb-2">
                            <span>
                                <i class="fas fa-weight-hanging"></i> {{ package.weight }} kg
                            </span>
                            <span>
                                <i class="fas fa-calendar-alt"></i> {{ package.pickup_date|date:"d/m/y" }}
                            </span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 text-primary mb-0">
                                {{ package.get_price_with_currency }}
                            </span>
                            <div class="small text-muted">
                                <i class="fas fa-eye"></i> {{ package.view_count }}
                                <i class="fas fa-gavel ms-2"></i> {{ package.offer_count }}
                                <i class="fas fa-heart ms-2"></i> {{ package.favorite_count }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card-footer bg-transparent">
                    <div class="d-flex justify-content-between">
                        <a href="{{ package.get_absolute_url }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </a>

                        {% if package.status == 'DRAFT' %}
                        <a href="{% url 'colis:package_edit' package.slug %}" class="btn btn-sm btn-outline-warning">
                            <i class="fas fa-edit"></i>
                        </a>
                        {% endif %}

                        {% if package.status == 'AVAILABLE' and package.offer_count > 0 %}
                        <a href="{% url 'colis:package_management' package.slug %}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-handshake"></i> {{ package.offer_count }}
                        </a>
                        {% endif %}

                        <button class="btn btn-sm btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal{{ package.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal de suppression -->
            <div class="modal fade" id="deleteModal{{ package.id }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">{% trans "Confirmer la suppression" %}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>{% trans "Êtes-vous sûr de vouloir supprimer le colis" %} <strong>"{{ package.title }}"</strong> ?</p>
                            {% if package.status == 'AVAILABLE' and package.offer_count > 0 %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                {% trans "Ce colis a des offres en cours. La suppression annulera toutes les offres." %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                {% trans "Annuler" %}
                            </button>
                            <form method="post" action="{% url 'colis:package_delete' package.slug %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> {% trans "Supprimer" %}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            {{ num }}
                        </a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- Aucun colis -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                    <h3>{% trans "Vous n'avez pas encore publié de colis" %}</h3>
                    <p class="text-muted mb-4">
                        {% trans "Commencez par publier votre premier colis pour trouver un transporteur." %}
                    </p>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{% url 'colis:package_create' %}" class="btn btn-success btn-lg">
                            <i class="fas fa-plus"></i> {% trans "Publier un colis" %}
                        </a>
                        <a href="{% url 'colis:package_list' %}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-search"></i> {% trans "Voir les colis disponibles" %}
                        </a>
                    </div>

                    <!-- Conseils -->
                    <div class="row mt-5">
                        <div class="col-md-4 mb-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <div class="bg-success bg-opacity-10 rounded-circle p-3 mb-3 d-inline-block">
                                        <i class="fas fa-info-circle fa-2x text-success"></i>
                                    </div>
                                    <h5>{% trans "Comment ça marche" %}</h5>
                                    <p class="small text-muted">
                                        {% trans "Découvrez comment publier et gérer vos colis efficacement." %}
                                    </p>
                                    <a href="{% url 'colis:how_it_works' %}" class="btn btn-sm btn-outline-success">
                                        {% trans "En savoir plus" %}
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <div class="bg-warning bg-opacity-10 rounded-circle p-3 mb-3 d-inline-block">
                                        <i class="fas fa-euro-sign fa-2x text-warning"></i>
                                    </div>
                                    <h5>{% trans "Guide des prix" %}</h5>
                                    <p class="small text-muted">
                                        {% trans "Fixez un prix attractif pour attirer plus de transporteurs." %}
                                    </p>
                                    <a href="{% url 'colis:price_guide' %}" class="btn btn-sm btn-outline-warning">
                                        {% trans "Voir les prix" %}
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <div class="bg-info bg-opacity-10 rounded-circle p-3 mb-3 d-inline-block">
                                        <i class="fas fa-box fa-2x text-info"></i>
                                    </div>
                                    <h5>{% trans "Conseils d'emballage" %}</h5>
                                    <p class="small text-muted">
                                        {% trans "Apprenez à emballer vos colis pour un transport sécurisé." %}
                                    </p>
                                    <a href="{% url 'colis:packaging_tips' %}" class="btn btn-sm btn-outline-info">
                                        {% trans "Voir les conseils" %}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions groupées -->
    {% if packages %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{% trans "Actions groupées" %}</h5>
                    <div class="d-flex flex-wrap gap-2">
                        {% if draft_packages %}
                        <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#publishAllModal">
                            <i class="fas fa-paper-plane"></i> {% trans "Publier tous les brouillons" %}
                        </button>
                        {% endif %}

                        {% if available_packages %}
                        <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#expireAllModal">
                            <i class="fas fa-clock"></i> {% trans "Expirer tous les disponibles" %}
                        </button>
                        {% endif %}

                        <a href="{% url 'colis:package_statistics' %}" class="btn btn-outline-info">
                            <i class="fas fa-chart-bar"></i> {% trans "Voir les statistiques" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour publier tous les brouillons -->
    <div class="modal fade" id="publishAllModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Publier tous les brouillons" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>{% trans "Êtes-vous sûr de vouloir publier tous vos colis en brouillon ?" %}</p>
                    <p class="text-muted small">
                        <i class="fas fa-info-circle"></i>
                        {% trans "Cette action rendra tous vos brouillons visibles par les transporteurs." %}
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "Annuler" %}
                    </button>
                    <form method="post" action="{% url 'colis:bulk_publish' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-paper-plane"></i> {% trans "Publier tous" %}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour expirer tous les disponibles -->
    <div class="modal fade" id="expireAllModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Expirer tous les colis disponibles" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>{% trans "Êtes-vous sûr de vouloir marquer tous vos colis disponibles comme expirés ?" %}</p>
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        {% trans "Cette action est irréversible et les colis ne seront plus visibles par les transporteurs." %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "Annuler" %}
                    </button>
                    <form method="post" action="{% url 'colis:bulk_expire' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-clock"></i> {% trans "Expirer tous" %}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 10px;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.125);
}

.card-footer {
    border-top: 1px solid rgba(0,0,0,0.125);
}

.badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
}

.h3 {
    font-weight: bold;
}

.pagination .page-link {
    color: #667eea;
}

.pagination .page-item.active .page-link {
    background-color: #667eea;
    border-color: #667eea;
}
</style>

<script>
$(document).ready(function() {
    // Tooltips pour les boutons d'action
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Confirmation avant suppression
    $('.delete-btn').click(function(e) {
        if (!confirm('{% trans "Êtes-vous sûr de vouloir supprimer ce colis ?" %}')) {
            e.preventDefault();
        }
    });

    // Filtrage en temps réel
    $('#search-input').on('keyup', function() {
        const value = $(this).val().toLowerCase();
        $('.package-card').filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });
});
</script>
{% endblock %}


========== colis/templates/colis/package/package_detail.html ==========
{# ~/ebi3/colis/templates/colis/package/package_detail.html #}
{% extends 'colis/base_colis.html' %}
{% load i18n %}

{% block title %}{{ package.title }} - Ebi3{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .package-detail-image {
        height: 400px;
        object-fit: cover;
        border-radius: 10px;
    }
    .map-container {
        height: 300px;
        border-radius: 10px;
        overflow: hidden;
    }
    .route-display {
        border-left: 3px solid #667eea;
        padding-left: 1rem;
        margin: 1rem 0;
    }
    .specs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    .spec-item {
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .spec-label {
        display: block;
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    .spec-value {
        display: block;
        font-size: 1.25rem;
        font-weight: bold;
        color: #212529;
    }
</style>
{% endblock %}

{% block colis_title %}{{ package.title }}{% endblock %}

{% block colis_content %}
<div class="row">
    <!-- Colonne principale -->
    <div class="col-lg-8">
        <!-- Galerie d'images -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                {% include 'colis/partials/image_gallery.html' with images=package.images.all %}
            </div>
        </div>

        <!-- Description détaillée -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> {% trans "Description" %}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <p><strong>{% trans "Catégorie:" %}</strong>
                            <a href="{{ package.category.get_absolute_url }}" class="badge bg-info">
                                {{ package.category.name }}
                            </a>
                        </p>
                        <p><strong>{% trans "Type:" %}</strong>
                            <span class="badge bg-secondary">{{ package.get_package_type_display }}</span>
                        </p>
                        <p><strong>{% trans "Prix:" %}</strong>
                            <span class="h5 text-primary">{{ package.get_price_with_currency }}</span>
                            {% if package.price_type == 'NEGOTIABLE' %}
                                <span class="badge bg-warning">{% trans "Négociable" %}</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{% trans "Statut:" %}</strong>
                            {% include 'colis/partials/status_badge.html' with status=package.status %}
                        </p>
                        <p><strong>{% trans "Publié le:" %}</strong>
                            {{ package.created_at|date:"d/m/Y à H:i" }}
                        </p>
                        <p><strong>{% trans "Vues:" %}</strong>
                            {{ package.view_count }}
                        </p>
                    </div>
                </div>

                <!-- Spécifications -->
                <div class="specs-grid">
                    <div class="spec-item">
                        <span class="spec-label">{% trans "Poids" %}</span>
                        <span class="spec-value">{{ package.weight }} kg</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">{% trans "Dimensions" %}</span>
                        <span class="spec-value">{{ package.length }}×{{ package.width }}×{{ package.height }} cm</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">{% trans "Volume" %}</span>
                        <span class="spec-value">{{ package.volume|floatformat:1 }} L</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">{% trans "Distance estimée" %}</span>
                        <span class="spec-value">{{ package.get_distance_display }}</span>
                    </div>
                </div>

                <!-- Description complète -->
                <h6 class="mt-4">{% trans "Description complète" %}</h6>
                <div class="description-content">
                    {{ package.description|linebreaks }}
                </div>

                <!-- Options -->
                {% if package.is_fragile or package.requires_insurance or package.requires_packaging %}
                    <div class="mt-4">
                        <h6>{% trans "Options spéciales" %}</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% if package.is_fragile %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-exclamation-triangle"></i> {% trans "Fragile" %}
                                </span>
                            {% endif %}
                            {% if package.requires_insurance %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-shield-alt"></i> {% trans "Assurance requise" %}
                                </span>
                            {% endif %}
                            {% if package.requires_packaging %}
                                <span class="badge bg-info">
                                    <i class="fas fa-box"></i> {% trans "Emballage requis" %}
                                </span>
                            {% endif %}
                            {% if package.requires_loading_help %}
                                <span class="badge bg-success">
                                    <i class="fas fa-arrow-up"></i> {% trans "Aide chargement" %}
                                </span>
                            {% endif %}
                            {% if package.requires_unloading_help %}
                                <span class="badge bg-success">
                                    <i class="fas fa-arrow-down"></i> {% trans "Aide déchargement" %}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Trajet et carte -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-route"></i> {% trans "Trajet" %}</h5>
            </div>
            <div class="card-body">
                <div class="route-display">
                    <div class="mb-3">
                        <h6><i class="fas fa-map-marker-alt text-danger"></i> {% trans "Départ" %}</h6>
                        <p class="mb-1">
                            <strong>{{ package.pickup_city }}</strong>, {{ package.pickup_country.name }}
                        </p>
                        {% if package.pickup_address %}
                            <p class="text-muted small mb-0">{{ package.pickup_address }}</p>
                        {% endif %}
                        <p class="text-muted small">
                            <i class="fas fa-calendar"></i> {% trans "Disponible à partir du" %} {{ package.pickup_date|date:"d/m/Y" }}
                        </p>
                    </div>

                    <div class="mb-3">
                        <h6><i class="fas fa-map-marker-alt text-success"></i> {% trans "Destination" %}</h6>
                        <p class="mb-1">
                            <strong>{{ package.delivery_city }}</strong>, {{ package.delivery_country.name }}
                        </p>
                        {% if package.delivery_address %}
                            <p class="text-muted small mb-0">{{ package.delivery_address }}</p>
                        {% endif %}
                        <p class="text-muted small">
                            <i class="fas fa-calendar-check"></i> {% trans "Livraison avant le" %} {{ package.delivery_date|date:"d/m/Y" }}
                        </p>
                    </div>

                    {% if package.flexible_dates %}
                        <div class="alert alert-warning">
                            <i class="fas fa-clock"></i>
                            {% trans "Dates flexibles - L'expéditeur accepte des dates différentes" %}
                        </div>
                    {% endif %}
                </div>

                <!-- Carte -->
                <div class="map-container mt-3" id="routeMap"></div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Actions -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">{% trans "Actions" %}</h5>

                <div class="d-grid gap-2 mb-3">
                    {% if user.is_authenticated %}
                        {% if user == package.sender %}
                            <!-- Propriétaire du colis -->
                            <a href="{% url 'colis:package_edit' package.slug %}" class="btn btn-primary">
                                <i class="fas fa-edit"></i> {% trans "Modifier" %}
                            </a>
                            <a href="{% url 'colis:package_management' package.slug %}" class="btn btn-outline-primary">
                                <i class="fas fa-cog"></i> {% trans "Gérer" %}
                            </a>

                            {% if package.status == 'AVAILABLE' and transport_offers %}
                                <div class="mt-3">
                                    <h6>{% trans "Offres reçues" %}</h6>
                                    <div class="list-group">
                                        {% for offer in transport_offers|slice:":3" %}
                                            <div class="list-group-item">
                                                <div class="d-flex justify-content-between">
                                                    <strong>{{ offer.price }} {{ offer.currency }}</strong>
                                                    <span class="badge bg-{% if offer.status == 'PENDING' %}warning{% else %}secondary{% endif %}">
                                                        {{ offer.get_status_display }}
                                                    </span>
                                                </div>
                                                <small class="text-muted">
                                                    {{ offer.carrier.user.username }}
                                                </small>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    {% if has_pending_offers %}
                                        <a href="{% url 'colis:my_offers' %}" class="btn btn-warning mt-2 w-100">
                                            <i class="fas fa-gavel"></i> {% trans "Voir toutes les offres" %}
                                        </a>
                                    {% endif %}
                                </div>
                            {% endif %}

                        {% elif can_make_offer %}
                            <!-- Transporteur pouvant faire une offre -->
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#makeOfferModal">
                                <i class="fas fa-handshake"></i> {% trans "Faire une offre" %}
                            </button>
                            <a href="{% url 'messaging:new_conversation' package.sender.username %}" class="btn btn-outline-primary">
                                <i class="fas fa-envelope"></i> {% trans "Contacter" %}
                            </a>

                        {% elif user_offer %}
                            <!-- Transporteur ayant déjà fait une offre -->
                            <div class="alert alert-info">
                                <h6>{% trans "Votre offre" %}</h6>
                                <p class="mb-1">
                                    <strong>{{ user_offer.price }} {{ user_offer.currency }}</strong>
                                </p>
                                <p class="mb-0">
                                    <span class="badge bg-{% if user_offer.status == 'PENDING' %}warning{% elif user_offer.status == 'ACCEPTED' %}success{% else %}secondary{% endif %}">
                                        {{ user_offer.get_status_display }}
                                    </span>
                                </p>
                            </div>
                        {% else %}
                            <!-- Autre utilisateur -->
                            <button class="btn btn-outline-primary requires-login" data-bs-toggle="tooltip"
                                    title="{% trans 'Devenez transporteur pour faire des offres' %}">
                                <i class="fas fa-truck"></i> {% trans "Devenir transporteur" %}
                            </button>
                        {% endif %}

                        <!-- Favori -->
                        <button class="btn favorite-btn
                                    {% if is_favorite %}btn-danger{% else %}btn-outline-danger{% endif %}"
                                data-url="{% url 'colis:toggle_favorite' package.slug %}"
                                data-package-slug="{{ package.slug }}">
                            <i class="{% if is_favorite %}fas{% else %}far{% endif %} fa-heart"></i>
                            {% if is_favorite %}
                                {% trans "Retirer des favoris" %}
                            {% else %}
                                {% trans "Ajouter aux favoris" %}
                            {% endif %}
                        </button>

                        <!-- Partage -->
                        <button class="btn btn-outline-secondary" onclick="sharePackage()">
                            <i class="fas fa-share-alt"></i> {% trans "Partager" %}
                        </button>

                        <!-- Signalement -->
                        {% if can_report %}
                            <a href="{% url 'colis:package_report' package.slug %}" class="btn btn-outline-warning">
                                <i class="fas fa-flag"></i> {% trans "Signaler" %}
                            </a>
                        {% endif %}
                    {% else %}
                        <!-- Non connecté -->
                        <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> {% trans "Se connecter" %}
                        </a>
                        <a href="{% url 'users:register' %}" class="btn btn-outline-primary">
                            <i class="fas fa-user-plus"></i> {% trans "S'inscrire" %}
                        </a>
                        <p class="text-muted small text-center mt-2">
                            {% trans "Connectez-vous pour contacter l'expéditeur" %}
                        </p>
                    {% endif %}
                </div>

                <!-- Statistiques -->
                <div class="d-flex justify-content-around text-center border-top pt-3">
                    <div>
                        <div class="h5">{{ package.view_count }}</div>
                        <small class="text-muted">{% trans "Vues" %}</small>
                    </div>
                    <div>
                        <div class="h5">{{ package.offer_count }}</div>
                        <small class="text-muted">{% trans "Offres" %}</small>
                    </div>
                    <div>
                        <div class="h5">{{ package.favorite_count }}</div>
                        <small class="text-muted">{% trans "Favoris" %}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informations expéditeur -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-user"></i> {% trans "Expéditeur" %}</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="avatar-circle bg-primary text-white d-flex align-items-center justify-content-center me-3">
                        <span style="font-size: 1.5rem; font-weight: bold;">
                            {{ package.sender.username|first|upper }}
                        </span>
                    </div>
                    <div>
                        <h5 class="mb-0">
                            <a href="{% url 'users:profile' package.sender.username %}" class="text-decoration-none">
                                {{ package.sender.username }}
                            </a>
                        </h5>
                        <p class="text-muted small mb-0">
                            <i class="fas fa-user-tag"></i> {{ package.sender.get_role_display }}
                        </p>
                        <p class="text-muted small mb-0">
                            <i class="fas fa-calendar-alt"></i> {% trans "Membre depuis" %} {{ package.sender.date_joined|date:"Y" }}
                        </p>
                    </div>
                </div>

                <div class="row text-center">
                    <div class="col-4">
                        <div class="h5">{{ package.sender.sent_packages.count }}</div>
                        <small class="text-muted">{% trans "Colis" %}</small>
                    </div>
                    <div class="col-4">
                        <div class="h5">{{ package.sender.rating|default:"0.0" }}</div>
                        <small class="text-muted">{% trans "Note" %}</small>
                    </div>
                    <div class="col-4">
                        <div class="h5">98%</div>
                        <small class="text-muted">{% trans "Satisfaction" %}</small>
                    </div>
                </div>

                <div class="mt-3">
                    {% if user.is_authenticated and user != package.sender %}
                        <a href="{% url 'messaging:new_conversation' package.sender.username %}"
                           class="btn btn-outline-primary w-100">
                            <i class="fas fa-envelope"></i> {% trans "Contacter" %}
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Colis similaires -->
        {% if similar_packages %}
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-boxes"></i> {% trans "Colis similaires" %}</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for similar in similar_packages %}
                            <a href="{{ similar.get_absolute_url }}" class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between">
                                    <strong>{{ similar.title|truncatechars:30 }}</strong>
                                    <span class="text-primary">{{ similar.asking_price }} €</span>
                                </div>
                                <small class="text-muted">
                                    {{ similar.pickup_city }} → {{ similar.delivery_city }}
                                </small>
                            </a>
                        {% endfor %}
                    </div>
                    <a href="{% url 'colis:search' %}?category={{ package.category.slug }}"
                       class="btn btn-sm btn-outline-secondary w-100 mt-2">
                        {% trans "Voir plus" %}
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal pour faire une offre -->
{% if can_make_offer %}
<div class="modal fade" id="makeOfferModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Faire une offre" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'colis:offer_create' package.slug %}">
                {% csrf_token %}
                <div class="modal-body">
                    {{ transport_offer_form.as_p }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "Annuler" %}
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i> {% trans "Envoyer l'offre" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// Initialisation de la carte
function initMap() {
    const map = L.map('routeMap').setView([46.603354, 1.888334], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Marqueur de départ (simulé)
    const startMarker = L.marker([48.8566, 2.3522]).addTo(map)
        .bindPopup('{% trans "Départ" %}: {{ package.pickup_city }}');

    // Marqueur d'arrivée (simulé)
    const endMarker = L.marker([45.7640, 4.8357]).addTo(map)
        .bindPopup('{% trans "Arrivée" %}: {{ package.delivery_city }}');

    // Ligne entre les deux points
    const polyline = L.polyline([
        [48.8566, 2.3522],
        [45.7640, 4.8357]
    ], {color: 'blue'}).addTo(map);

    // Ajuster la vue pour voir les deux marqueurs
    map.fitBounds([startMarker.getLatLng(), endMarker.getLatLng()]);
}

// Fonction de partage
function sharePackage() {
    const url = window.location.href;
    const title = '{{ package.title }}';

    if (navigator.share) {
        navigator.share({
            title: title,
            text: '{% trans "Regardez ce colis sur Ebi3" %}',
            url: url,
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            alert('{% trans "Lien copié dans le presse-papier !" %}');
        });
    }
}

$(document).ready(function() {
    // Initialiser la carte
    if ($('#routeMap').length) {
        initMap();
    }

    // Gestion des favoris
    $('.favorite-btn').click(function(e) {
        e.preventDefault();
        const btn = $(this);
        const url = btn.data('url');

        if (!{{ user.is_authenticated|yesno:"true,false" }}) {
            $('#loginModal').modal('show');
            return;
        }

        $.ajax({
            url: url,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(data) {
                if (data.status === 'success') {
                    if (data.action === 'added') {
                        btn.removeClass('btn-outline-danger').addClass('btn-danger');
                        btn.find('i').removeClass('far').addClass('fas');
                        btn.html('<i class="fas fa-heart"></i> {% trans "Retirer des favoris" %}');
                    } else {
                        btn.removeClass('btn-danger').addClass('btn-outline-danger');
                        btn.find('i').removeClass('fas').addClass('far');
                        btn.html('<i class="far fa-heart"></i> {% trans "Ajouter aux favoris" %}');
                    }

                    // Afficher notification
                    const toast = new bootstrap.Toast(document.getElementById('actionToast'));
                    document.getElementById('toastMessage').textContent =
                        data.action === 'added' ?
                        '{% trans "Colis ajouté aux favoris" %}' :
                        '{% trans "Colis retiré des favoris" %}';
                    toast.show();
                }
            }
        });
    });
});
</script>

<!-- Toast pour notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="actionToast" class="toast" role="alert">
        <div class="toast-header">
            <strong class="me-auto">Ebi3</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            <span id="toastMessage"></span>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.description-content {
    line-height: 1.8;
    font-size: 1.05rem;
}

.description-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1rem 0;
}
</style>
{% endblock %}


========== colis/templates/colis/package/package_list.html ==========
{# ~/ebi3/colis/templates/colis/package/package_list.html #}
{% extends 'colis/base_colis.html' %}
{% load i18n %}

{% block title %}{% trans "Colis disponibles" %} - Ebi3{% endblock %}

{% block colis_title %}{% trans "Colis disponibles pour transport" %}{% endblock %}

{% block colis_content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                {% blocktranslate count total_packages=total_packages %}
                    {{ total_packages }} colis disponible
                {% plural %}
                    {{ total_packages }} colis disponibles
                {% endblocktranslate %}
            </h2>
            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-sort"></i> {% trans "Trier par" %}
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="?sort_by=-created_at">{% trans "Plus récent" %}</a></li>
                        <li><a class="dropdown-item" href="?sort_by=pickup_date">{% trans "Départ proche" %}</a></li>
                        <li><a class="dropdown-item" href="?sort_by=asking_price">{% trans "Prix croissant" %}</a></li>
                        <li><a class="dropdown-item" href="?sort_by=-asking_price">{% trans "Prix décroissant" %}</a></li>
                        <li><a class="dropdown-item" href="?sort_by=-view_count">{% trans "Plus populaire" %}</a></li>
                    </ul>
                </div>
                <a href="{% url 'colis:package_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> {% trans "Publier un colis" %}
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filtres rapides -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <select class="form-select" id="quickCategoryFilter">
                            <option value="">{% trans "Toutes catégories" %}</option>
                            {% for category in categories %}
                                <option value="{{ category.slug }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="quickTypeFilter">
                            <option value="">{% trans "Tous types" %}</option>
                            <option value="SMALL_PACKAGE">{% trans "Petit colis" %}</option>
                            <option value="MEDIUM_PACKAGE">{% trans "Colis moyen" %}</option>
                            <option value="LARGE_PACKAGE">{% trans "Gros colis" %}</option>
                            <option value="FURNITURE">{% trans "Meuble" %}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" id="quickMaxWeight"
                               placeholder="{% trans 'Poids max (kg)' %}">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100" id="applyQuickFilters">
                            <i class="fas fa-filter"></i> {% trans "Appliquer" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Liste des colis -->
{% if packages %}
    <div class="row" id="packages-container">
        {% for package in packages %}
            <div class="col-md-6 col-lg-4 mb-4">
                {% include 'colis/partials/package_card.html' with package=package %}
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-5">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {{ num }}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}
{% else %}
    <!-- Aucun résultat -->
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
            <h3>{% trans "Aucun colis trouvé" %}</h3>
            <p class="text-muted">
                {% trans "Essayez de modifier vos critères de recherche ou" %}
                <a href="{% url 'colis:package_list' %}">{% trans "consultez tous les colis" %}</a>.
            </p>
            {% if user.is_authenticated %}
                <a href="{% url 'colis:package_create' %}" class="btn btn-primary mt-3">
                    <i class="fas fa-plus"></i> {% trans "Publier le premier colis" %}
                </a>
            {% else %}
                <a href="{% url 'users:register' %}" class="btn btn-primary mt-3">
                    <i class="fas fa-user-plus"></i> {% trans "Inscrivez-vous pour publier" %}
                </a>
            {% endif %}
        </div>
    </div>
{% endif %}

<!-- Statistiques -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> {% trans "Statistiques" %}</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="stats-number">{{ total_packages }}</div>
                        <small class="text-muted">{% trans "Colis disponibles" %}</small>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-number">{{ avg_price|floatformat:0 }} €</div>
                        <small class="text-muted">{% trans "Prix moyen" %}</small>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-number">{{ total_senders }}</div>
                        <small class="text-muted">{% trans "Expéditeurs actifs" %}</small>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-number">98%</div>
                        <small class="text-muted">{% trans "Taux de satisfaction" %}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Filtres rapides
    $('#applyQuickFilters').click(function() {
        const category = $('#quickCategoryFilter').val();
        const type = $('#quickTypeFilter').val();
        const maxWeight = $('#quickMaxWeight').val();

        let url = '?';
        if (category) url += 'category=' + category + '&';
        if (type) url += 'package_type=' + type + '&';
        if (maxWeight) url += 'max_weight=' + maxWeight + '&';

        window.location.href = url.slice(0, -1); // Remove trailing & or ?
    });

    // Favoris AJAX
    $('.favorite-btn').click(function(e) {
        e.preventDefault();
        const btn = $(this);
        const url = btn.data('url');
        const packageSlug = btn.data('package-slug');

        if (!{{ user.is_authenticated|yesno:"true,false" }}) {
            $('#loginModal').modal('show');
            return;
        }

        $.ajax({
            url: url,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(data) {
                if (data.status === 'success') {
                    if (data.action === 'added') {
                        btn.removeClass('btn-outline-danger').addClass('btn-danger');
                        btn.find('i').removeClass('far').addClass('fas');
                        btn.attr('title', '{% trans "Retirer des favoris" %}');
                    } else {
                        btn.removeClass('btn-danger').addClass('btn-outline-danger');
                        btn.find('i').removeClass('fas').addClass('far');
                        btn.attr('title', '{% trans "Ajouter aux favoris" %}');
                    }

                    // Mettre à jour le compteur
                    const countSpan = $('#favorite-count-' + packageSlug);
                    if (countSpan.length) {
                        countSpan.text(data.favorite_count);
                    }

                    // Afficher un toast
                    showToast(data.action === 'added' ?
                        '{% trans "Colis ajouté aux favoris" %}' :
                        '{% trans "Colis retiré des favoris" %}',
                        'success'
                    );
                }
            },
            error: function() {
                showToast('{% trans "Une erreur est survenue" %}', 'error');
            }
        });
    });

    // Fonction toast
    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        if ($('#toast-container').length === 0) {
            $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
        }

        $('#toast-container').append(toastHtml);
        $('.toast').toast('show');

        $('.toast').on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }
});
</script>

<style>
.stats-number {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
}

.package-card {
    border-radius: 10px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.package-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.pagination .page-link {
    color: #667eea;
    border: 1px solid #dee2e6;
}

.pagination .page-item.active .page-link {
    background-color: #667eea;
    border-color: #667eea;
    color: white;
}
</style>
{% endblock %}


========== colis/templates/colis/package/package_create.html ==========
{# ~/ebi3/colis/templates/colis/package/package_create.html #}
{% extends 'colis/base_colis.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Publier un colis" %} - Ebi3{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .form-section {
        background: #fff;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #e9ecef;
    }

    .form-section-title {
        color: #667eea;
        border-bottom: 2px solid #667eea;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .image-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
    }

    .image-upload-area:hover {
        border-color: #667eea;
        background: #f0f7ff;
    }

    .image-preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 1rem;
    }

    .image-preview {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #dee2e6;
    }

    .required-field::after {
        content: " *";
        color: #dc3545;
    }

    .form-check-input:checked {
        background-color: #667eea;
        border-color: #667eea;
    }

    .calculator-badge {
        background: #e7f1ff;
        color: #667eea;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
        margin-left: 0.5rem;
    }

    .location-help {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .price-estimate {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    /* Styles pour la sélection hiérarchique des catégories */
    .category-hierarchy-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e9ecef;
    }

    .category-select-container {
        position: relative;
    }

    .category-select-container .form-select {
        padding-right: 2.5rem;
        transition: all 0.3s ease;
    }

    .category-select-container .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
    }

    #sub-category-placeholder,
    #final-category-placeholder {
        background-color: #f8f9fa;
        min-height: 58px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border: 1px dashed #dee2e6;
        border-radius: 0.375rem;
    }

    #sub-category-placeholder i,
    #final-category-placeholder i {
        color: #adb5bd;
    }

    #category-selection-info {
        background-color: #d1e7dd;
        border: 1px solid #badbcc;
        border-left: 4px solid #198754;
    }

    #selected-category-path {
        color: #0f5132;
        background-color: #fff;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.95rem;
    }

    #change-category-btn:hover {
        background-color: #6c757d;
        color: white;
    }

    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block colis_title %}{% trans "Publier un nouveau colis" %}{% endblock %}

{% block colis_content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Informations d'orientation -->
            <div class="alert alert-info mb-4">
                <h5 class="alert-heading"><i class="fas fa-info-circle"></i> {% trans "Comment publier un colis ?" %}</h5>
                <ul class="mb-0">
                    <li>{% trans "Remplissez tous les champs obligatoires (*)" %}</li>
                    <li>{% trans "Sélectionnez votre catégorie en 3 étapes simples" %}</li>
                    <li>{% trans "Ajoutez des photos de qualité pour attirer plus de transporteurs" %}</li>
                    <li>{% trans "Soyez précis sur les dimensions et le poids" %}</li>
                    <li>{% trans "Fixez un prix réaliste pour augmenter vos chances" %}</li>
                </ul>
            </div>

            <form method="post" enctype="multipart/form-data" id="package-form" novalidate>
                {% csrf_token %}

                <!-- Section 1: Informations de base -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-info-circle"></i> {% trans "1. Informations de base" %}
                    </h3>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label required-field">
                                    {% trans "Titre de votre annonce" %}
                                </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.title.errors }}
                                    </div>
                                {% endif %}
                                <small class="text-muted">
                                    {% trans "Ex: Déménagement Paris → Lyon - Meubles et cartons" %}
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION CATÉGORIE HIÉRARCHIQUE -->
                    <div class="category-hierarchy-section mb-4">
                        <h5 class="mb-3">{% trans "Sélection de la catégorie" %}</h5>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="category-select-container">
                                    {{ form.main_category|as_crispy_field }}
                                    {% if form.main_category.help_text %}
                                        <small class="form-text text-muted">{{ form.main_category.help_text }}</small>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <div id="sub-category-container" style="display: none;">
                                    <div class="category-select-container">
                                        {{ form.sub_category|as_crispy_field }}
                                    </div>
                                </div>
                                <div id="sub-category-placeholder" class="text-muted text-center p-3">
                                    <i class="fas fa-arrow-left fa-lg mb-2"></i><br>
                                    <small>{% trans "Choisissez d'abord une catégorie principale" %}</small>
                                </div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <div id="final-category-container" style="display: none;">
                                    <div class="category-select-container">
                                        <label class="form-label required-field">
                                            {% trans "Catégorie finale" %}<span class="asteriskField">*</span>
                                        </label>
                                        <select class="form-control" id="id_final_category_select" name="final_category" required>
                                            <option value="">{% trans "Sélectionnez une catégorie" %}</option>
                                        </select>
                                        <div class="invalid-feedback">
                                            {% trans "Veuillez sélectionner une catégorie finale." %}
                                        </div>
                                        <small class="form-text text-muted">{% trans "Catégorie spécifique pour votre colis" %}</small>
                                    </div>
                                </div>
                                <div id="final-category-placeholder" class="text-muted text-center p-3">
                                    <i class="fas fa-arrow-left fa-lg mb-2"></i><br>
                                    <small>{% trans "Sélectionnez une sous-catégorie d'abord" %}</small>
                                </div>
                            </div>
                        </div>

                        <!-- Champ caché pour la catégorie finale -->
                        {{ form.category }}

                        <!-- Indicateur de catégorie sélectionnée -->
                        <div id="category-selection-info" class="alert alert-success mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong><i class="fas fa-check-circle"></i> {% trans "Catégorie sélectionnée :" %}</strong>
                                    <span id="selected-category-path" class="ms-2 fw-bold"></span>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="change-category-btn">
                                    <i class="fas fa-edit"></i> {% trans "Modifier" %}
                                </button>
                            </div>
                        </div>

                        <!-- Aide pour la catégorie -->
                        <div class="alert alert-info mt-2">
                            <small>
                                <i class="fas fa-info-circle"></i>
                                {% trans "Sélectionnez votre catégorie en 3 étapes simples : catégorie principale → sous-catégorie → catégorie finale" %}
                            </small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.package_type.id_for_label }}" class="form-label required-field">
                                    {% trans "Type de colis" %}
                                </label>
                                {{ form.package_type }}
                                {% if form.package_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.package_type.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label required-field">
                            {% trans "Description détaillée" %}
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.description.errors }}
                            </div>
                        {% endif %}
                        <small class="text-muted">
                            {% trans "Décrivez précisément votre colis : contenu, état, instructions spéciales..." %}
                        </small>
                    </div>
                </div>

                <!-- Section 2: Dimensions et poids -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-ruler-combined"></i> {% trans "2. Dimensions et poids" %}
                    </h3>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        {% trans "Ces informations sont essentielles pour que les transporteurs puissent vous faire une offre précise." %}
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.weight.id_for_label }}" class="form-label required-field">
                                    {% trans "Poids (kg)" %}
                                </label>
                                <div class="input-group">
                                    {{ form.weight }}
                                    <span class="input-group-text">kg</span>
                                </div>
                                {% if form.weight.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.weight.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label required-field">{% trans "Dimensions (cm)" %}</label>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <div class="input-group">
                                            <span class="input-group-text">L</span>
                                            {{ form.length }}
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="input-group">
                                            <span class="input-group-text">l</span>
                                            {{ form.width }}
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="input-group">
                                            <span class="input-group-text">H</span>
                                            {{ form.height }}
                                        </div>
                                    </div>
                                </div>
                                {% if form.length.errors or form.width.errors or form.height.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.length.errors }}
                                        {{ form.width.errors }}
                                        {{ form.height.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Calcul de volume -->
                    <div class="price-estimate">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{% trans "Volume estimé :" %}</strong>
                                <span id="volume-display" class="ms-2">{% trans "À calculer..." %}</span>
                            </div>
                            <span class="calculator-badge">
                                <i class="fas fa-calculator"></i> {% trans "Calcul automatique" %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Trajet -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-route"></i> {% trans "3. Trajet" %}
                    </h3>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.pickup_country.id_for_label }}" class="form-label required-field">
                                    <i class="fas fa-map-marker-alt text-danger"></i> {% trans "Départ - Pays" %}
                                </label>
                                {{ form.pickup_country }}
                                {% if form.pickup_country.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.pickup_country.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.pickup_city.id_for_label }}" class="form-label required-field">
                                    {% trans "Départ - Ville" %}
                                </label>
                                {{ form.pickup_city }}
                                {% if form.pickup_city.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.pickup_city.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.pickup_address.id_for_label }}" class="form-label">
                            {% trans "Adresse de départ (optionnel)" %}
                        </label>
                        {{ form.pickup_address }}
                        <div class="location-help">
                            {% trans "L'adresse complète ne sera visible que par le transporteur sélectionné" %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.use_current_location }}
                            <label class="form-check-label" for="{{ form.use_current_location.id_for_label }}">
                                {% trans "Utiliser ma position actuelle pour le départ" %}
                            </label>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.delivery_country.id_for_label }}" class="form-label required-field">
                                    <i class="fas fa-map-marker-alt text-success"></i> {% trans "Destination - Pays" %}
                                </label>
                                {{ form.delivery_country }}
                                {% if form.delivery_country.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.delivery_country.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.delivery_city.id_for_label }}" class="form-label required-field">
                                    {% trans "Destination - Ville" %}
                                </label>
                                {{ form.delivery_city }}
                                {% if form.delivery_city.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.delivery_city.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.delivery_address.id_for_label }}" class="form-label">
                            {% trans "Adresse de destination (optionnel)" %}
                        </label>
                        {{ form.delivery_address }}
                    </div>

                    <!-- Calcul de distance -->
                    <div id="distance-estimate" class="price-estimate" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{% trans "Distance estimée :" %}</strong>
                                <span id="distance-display" class="ms-2"></span>
                            </div>
                            <span class="calculator-badge">
                                <i class="fas fa-road"></i> {% trans "Estimation" %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Dates -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-calendar-alt"></i> {% trans "4. Dates" %}
                    </h3>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.pickup_date.id_for_label }}" class="form-label required-field">
                                    {% trans "Date de départ souhaitée" %}
                                </label>
                                {{ form.pickup_date }}
                                {% if form.pickup_date.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.pickup_date.errors }}
                                    </div>
                                {% endif %}
                                <small class="text-muted">
                                    {% trans "Date à laquelle le colis sera disponible" %}
                                </small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.delivery_date.id_for_label }}" class="form-label required-field">
                                    {% trans "Date de livraison souhaitée" %}
                                </label>
                                {{ form.delivery_date }}
                                {% if form.delivery_date.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.delivery_date.errors }}
                                    </div>
                                {% endif %}
                                <small class="text-muted">
                                    {% trans "Date limite pour la livraison" %}
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.flexible_dates }}
                            <label class="form-check-label" for="{{ form.flexible_dates.id_for_label }}">
                                {% trans "Dates flexibles" %}
                            </label>
                            <small class="text-muted d-block">
                                {% trans "Accepte des dates différentes de celles demandées" %}
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Prix -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-euro-sign"></i> {% trans "5. Prix" %}
                    </h3>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.price_type.id_for_label }}" class="form-label required-field">
                                    {% trans "Type de prix" %}
                                </label>
                                {{ form.price_type }}
                                {% if form.price_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.price_type.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.asking_price.id_for_label }}" class="form-label required-field">
                                    {% trans "Prix demandé" %}
                                </label>
                                <div class="input-group">
                                    {{ form.asking_price }}
                                    {{ form.currency }}
                                </div>
                                {% if form.asking_price.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.asking_price.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.currency.id_for_label }}" class="form-label">
                                    {% trans "Devise" %}
                                </label>
                                {{ form.currency }}
                            </div>
                        </div>
                    </div>

                    <!-- Estimation de prix basée sur la distance -->
                    <div id="price-estimate" class="price-estimate" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>{% trans "Prix estimé basé sur la distance :" %}</strong>
                                <div class="mt-2">
                                    <span id="estimated-price-min" class="h5 text-primary"></span>
                                    <span class="text-muted"> - </span>
                                    <span id="estimated-price-max" class="h5 text-primary"></span>
                                    <span id="estimated-price-currency"></span>
                                </div>
                                <small class="text-muted">{% trans "Fourchette indicative pour les transporteurs" %}</small>
                            </div>
                            <div class="col-md-6 text-end">
                                <span class="calculator-badge">
                                    <i class="fas fa-chart-line"></i> {% trans "Recommandation" %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 6: Options -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-cog"></i> {% trans "6. Options" %}
                    </h3>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.is_fragile }}
                                    <label class="form-check-label" for="{{ form.is_fragile.id_for_label }}">
                                        <i class="fas fa-exclamation-triangle text-danger"></i>
                                        {% trans "Colis fragile" %}
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.requires_insurance }}
                                    <label class="form-check-label" for="{{ form.requires_insurance.id_for_label }}">
                                        <i class="fas fa-shield-alt text-warning"></i>
                                        {% trans "Assurance requise" %}
                                    </label>
                                </div>

                                <div id="insurance-value-field" class="mt-2" style="display: none;">
                                    <label for="{{ form.insurance_value.id_for_label }}" class="form-label">
                                        {% trans "Valeur à assurer" %}
                                    </label>
                                    <div class="input-group">
                                        {{ form.insurance_value }}
                                        <span class="input-group-text">€</span>
                                    </div>
                                    {% if form.insurance_value.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.insurance_value.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.requires_packaging }}
                                    <label class="form-check-label" for="{{ form.requires_packaging.id_for_label }}">
                                        <i class="fas fa-box text-info"></i>
                                        {% trans "Emballage requis" %}
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.requires_loading_help }}
                                    <label class="form-check-label" for="{{ form.requires_loading_help.id_for_label }}">
                                        <i class="fas fa-arrow-up text-success"></i>
                                        {% trans "Aide au chargement" %}
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.requires_unloading_help }}
                                    <label class="form-check-label" for="{{ form.requires_unloading_help.id_for_label }}">
                                        <i class="fas fa-arrow-down text-success"></i>
                                        {% trans "Aide au déchargement" %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 7: Images -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-images"></i> {% trans "7. Photos" %}
                    </h3>

                    <div class="alert alert-warning">
                        <i class="fas fa-lightbulb"></i>
                        {% trans "Les colis avec photos reçoivent 5 fois plus d'offres !" %}
                    </div>

                    <!-- Zone de dépôt -->
                    <div class="image-upload-area" id="image-drop-zone">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>{% trans "Glissez-déposez vos photos ici" %}</h5>
                        <p class="text-muted mb-3">{% trans "ou cliquez pour sélectionner" %}</p>
                        <input type="file" name="images" id="image-upload" multiple
                               accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('image-upload').click()">
                            <i class="fas fa-folder-open"></i> {% trans "Parcourir" %}
                        </button>
                        <p class="small text-muted mt-3">
                            <i class="fas fa-info-circle"></i>
                            {% trans "Formats acceptés : JPG, PNG, GIF, WebP. Max 10MB par image." %}
                        </p>
                    </div>

                    <!-- Prévisualisation -->
                    <div class="image-preview-container" id="image-preview-container">
                        <!-- Les images prévisualisées apparaîtront ici -->
                    </div>

                    <!-- Informations sur le formset -->
                    <div class="mt-3">
                        <p class="mb-1">
                            <strong>{% trans "Photos gratuites incluses :" %}</strong>
                            <span class="badge bg-success">{{ form.instance.free_images_allowed }}</span>
                        </p>
                        <p class="text-muted small">
                            {% trans "Vous pouvez ajouter jusqu'à 5 photos gratuitement. Des photos supplémentaires peuvent être ajoutées après publication." %}
                        </p>
                    </div>
                </div>

                <!-- Section 8: Conditions générales -->
                <div class="form-section">
                    <div class="form-check mb-4">
                        {{ form.accept_terms }}
                        <label class="form-check-label" for="{{ form.accept_terms.id_for_label }}">
                            {% trans "J'accepte les " %}
                            <a href="{% url 'colis:terms' %}" target="_blank">{% trans "conditions générales" %}</a>
                            {% trans " et la " %}
                            <a href="{% url 'colis:privacy' %}" target="_blank">{% trans "politique de confidentialité" %}</a>
                        </label>
                        {% if form.accept_terms.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.accept_terms.errors }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Boutons d'action -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'colis:package_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> {% trans "Annuler" %}
                        </a>

                        <div>
                            <button type="submit" name="save_draft" value="true" class="btn btn-outline-primary me-2">
                                <i class="fas fa-save"></i> {% trans "Enregistrer comme brouillon" %}
                            </button>
                            <button type="submit" name="publish" value="true" class="btn btn-success">
                                <i class="fas fa-paper-plane"></i> {% trans "Publier le colis" %}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    // ============================================
    // GESTION DE LA SÉLECTION HIÉRARCHIQUE DES CATÉGORIES
    // ============================================
    let selectedMainCategory = null;
    let selectedSubCategory = null;
    let selectedFinalCategory = null;

    // Écouter le changement de catégorie principale
    $('#id_main_category').change(function() {
        const mainCategoryId = $(this).val();

        if (mainCategoryId) {
            selectedMainCategory = mainCategoryId;

            // Cacher l'info de sélection
            $('#category-selection-info').hide();

            // Afficher le chargement
            $('#sub-category-placeholder').html(
                '<div class="loading-spinner"></div><small>{% trans "Chargement des sous-catégories..." %}</small>'
            );
            $('#sub-category-placeholder').show();
            $('#sub-category-container').hide();

            // Charger les sous-catégories
            loadSubCategories(mainCategoryId);

            // Réinitialiser les niveaux suivants
            $('#id_sub_category').val('').prop('disabled', false);
            $('#id_final_category_select').html('<option value="">{% trans "Sélectionnez une catégorie" %}</option>');
            $('#final-category-container').hide();
            $('#final-category-placeholder').show();

        } else {
            // Réinitialiser tout
            resetCategorySelection();
        }
    });

    // Écouter le changement de sous-catégorie
    $('#id_sub_category').change(function() {
        const subCategoryId = $(this).val();

        if (subCategoryId) {
            selectedSubCategory = subCategoryId;

            // Afficher le chargement
            $('#final-category-placeholder').html(
                '<div class="loading-spinner"></div><small>{% trans "Chargement des catégories finales..." %}</small>'
            );
            $('#final-category-placeholder').show();
            $('#final-category-container').hide();

            // Charger les catégories finales
            loadFinalCategories(subCategoryId);

        } else {
            // Cacher le conteneur des catégories finales
            $('#final-category-container').hide();
            $('#final-category-placeholder').show();
            $('#id_final_category').val('');
        }
    });

    // Écouter le changement de catégorie finale
    $('#id_final_category_select').change(function() {
        const finalCategoryId = $(this).val();

        if (finalCategoryId) {
            selectedFinalCategory = finalCategoryId;

            // Mettre à jour le champ caché
            $('#id_final_category').val(finalCategoryId);

            // Afficher l'info de sélection
            showCategorySelectionInfo();
        } else {
            $('#id_final_category').val('');
            $('#category-selection-info').hide();
        }
    });

    // Bouton pour modifier la catégorie
    $('#change-category-btn').click(function() {
        resetCategorySelection();
        $('#category-selection-info').hide();
    });

    // ============================================
    // FONCTIONS DE GESTION DES CATÉGORIES
    // ============================================

    // Fonction pour charger les sous-catégories
    function loadSubCategories(parentId) {
        $.ajax({
            url: '{% url "ads:get_categories" %}',
            type: 'GET',
            data: {
                'parent_id': parentId,
                'level': 'sub'
            },
            success: function(response) {
                const $subSelect = $('#id_sub_category');
                $subSelect.html('<option value="">{% trans "Sélectionnez une sous-catégorie" %}</option>');

                if (response.categories && response.categories.length > 0) {
                    response.categories.forEach(function(category) {
                        $subSelect.append(
                            $('<option>', {
                                value: category.id,
                                text: category.name,
                                'data-has-children': category.has_children
                            })
                        );
                    });

                    // Afficher le select
                    $('#sub-category-container').show();
                    $('#sub-category-placeholder').hide();
                    $subSelect.prop('disabled', false);

                } else {
                    // Pas de sous-catégories, passer directement aux catégories finales
                    $('#sub-category-placeholder').html(
                        '<i class="fas fa-check-circle text-success fa-lg mb-2"></i><br>' +
                        '<small>{% trans "Cette catégorie n\'a pas de sous-catégories" %}</small>'
                    );

                    // Charger directement les catégories finales
                    loadFinalCategories(parentId);
                    $('#final-category-container').show();
                    $('#final-category-placeholder').hide();
                }
            },
            error: function() {
                showToast('{% trans "Erreur lors du chargement des sous-catégories" %}', 'error');
                $('#sub-category-placeholder').html(
                    '<i class="fas fa-exclamation-triangle text-danger fa-lg mb-2"></i><br>' +
                    '<small>{% trans "Erreur de chargement" %}</small>'
                );
            }
        });
    }

    // Fonction pour charger les catégories finales
    function loadFinalCategories(parentId) {
        $.ajax({
            url: '{% url "ads:get_categories" %}',
            type: 'GET',
            data: {
                'parent_id': parentId,
                'level': 'final'
            },
            success: function(response) {
                const $finalSelect = $('#id_final_category_select');
                $finalSelect.html('<option value="">{% trans "Sélectionnez une catégorie" %}</option>');

                if (response.categories && response.categories.length > 0) {
                    response.categories.forEach(function(category) {
                        $finalSelect.append(
                            $('<option>', {
                                value: category.id,
                                text: category.name
                            })
                        );
                    });

                    // Afficher le select
                    $('#final-category-container').show();
                    $('#final-category-placeholder').hide();

                } else {
                    // Pas de catégories finales, utiliser la sous-catégorie comme finale
                    $('#final-category-placeholder').html(
                        '<i class="fas fa-info-circle text-info fa-lg mb-2"></i><br>' +
                        '<small>{% trans "Cette sous-catégorie n\'a pas de catégories enfants" %}</small>'
                    );

                    // Sélectionner automatiquement la sous-catégorie comme finale
                    $('#id_final_category').val(selectedSubCategory);
                    showCategorySelectionInfo();
                }
            },
            error: function() {
                showToast('{% trans "Erreur lors du chargement des catégories finales" %}', 'error');
                $('#final-category-placeholder').html(
                    '<i class="fas fa-exclamation-triangle text-danger fa-lg mb-2"></i><br>' +
                    '<small>{% trans "Erreur de chargement" %}</small>'
                );
            }
        });
    }

    // Fonction pour réinitialiser la sélection
    function resetCategorySelection() {
        selectedMainCategory = null;
        selectedSubCategory = null;
        selectedFinalCategory = null;

        $('#id_main_category').val('');
        $('#id_sub_category').val('').html('<option value="">{% trans "Sélectionnez une sous-catégorie" %}</option>').prop('disabled', true);
        $('#id_final_category_select').val('').html('<option value="">{% trans "Sélectionnez une catégorie" %}</option>');
        $('#id_final_category').val('');

        $('#sub-category-container').hide();
        $('#sub-category-placeholder').show();
        $('#sub-category-placeholder').html(
            '<i class="fas fa-arrow-left fa-lg mb-2"></i><br>' +
            '<small>{% trans "Choisissez d\'abord une catégorie principale" %}</small>'
        );

        $('#final-category-container').hide();
        $('#final-category-placeholder').show();
        $('#final-category-placeholder').html(
            '<i class="fas fa-arrow-left fa-lg mb-2"></i><br>' +
            '<small>{% trans "Sélectionnez une sous-catégorie d\'abord" %}</small>'
        );
    }

    // Fonction pour afficher l'info de sélection
    function showCategorySelectionInfo() {
        const mainCategoryText = $('#id_main_category option:selected').text();
        const subCategoryText = $('#id_sub_category option:selected').text();
        const finalCategoryText = $('#id_final_category_select option:selected').text() || subCategoryText;

        let path = finalCategoryText;
        if (subCategoryText && subCategoryText !== finalCategoryText) {
            path = `${subCategoryText} › ${path}`;
        }
        if (mainCategoryText) {
            path = `${mainCategoryText} › ${path}`;
        }

        $('#selected-category-path').text(path);
        $('#category-selection-info').show();

        // Cacher les selects
        $('#id_main_category').closest('.mb-3').hide();
        $('#sub-category-container').hide();
        $('#final-category-container').hide();
        $('#sub-category-placeholder').hide();
        $('#final-category-placeholder').hide();
    }

    // ============================================
    // AUTRES FONCTIONNALITÉS EXISTANTES
    // ============================================

    // Calcul automatique du volume
    function calculateVolume() {
        const length = parseFloat($('#{{ form.length.id_for_label }}').val()) || 0;
        const width = parseFloat($('#{{ form.width.id_for_label }}').val()) || 0;
        const height = parseFloat($('#{{ form.height.id_for_label }}').val()) || 0;

        if (length > 0 && width > 0 && height > 0) {
            const volume = (length * width * height) / 1000;
            $('#volume-display').html(volume.toFixed(2) + ' L');

            // Mettre à jour l'estimation de prix
            updatePriceEstimate(volume);
        }
    }

    // Mettre à jour l'estimation de prix
    function updatePriceEstimate(volume) {
        const distance = parseFloat($('#distance-display').text().replace(' km', '')) || 0;
        if (distance > 0 && volume > 0) {
            const basePricePerKm = 0.5;
            const basePricePerVolume = 10;

            const estimatedPrice = (distance * basePricePerKm) + (volume / 1000 * basePricePerVolume);
            const minPrice = estimatedPrice * 0.8;
            const maxPrice = estimatedPrice * 1.2;

            $('#estimated-price-min').text(minPrice.toFixed(2));
            $('#estimated-price-max').text(maxPrice.toFixed(2));
            $('#estimated-price-currency').text(' {{ form.currency.value }}');
            $('#price-estimate').show();
        }
    }

    // Écouter les changements de dimensions
    $('#{{ form.length.id_for_label }}, #{{ form.width.id_for_label }}, #{{ form.height.id_for_label }}').on('input', calculateVolume);

    // Gestion de l'assurance
    $('#{{ form.requires_insurance.id_for_label }}').change(function() {
        if ($(this).is(':checked')) {
            $('#insurance-value-field').show();
        } else {
            $('#insurance-value-field').hide();
        }
    });

    // Initialiser l'état de l'assurance
    if ($('#{{ form.requires_insurance.id_for_label }}').is(':checked')) {
        $('#insurance-value-field').show();
    }

    // Gestion du téléchargement d'images
    const imageUpload = document.getElementById('image-upload');
    const previewContainer = document.getElementById('image-preview-container');
    const dropZone = document.getElementById('image-drop-zone');

    imageUpload.addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });

    // Glisser-déposer
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#667eea';
        dropZone.style.background = '#f0f7ff';
    });

    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#dee2e6';
        dropZone.style.background = '#f8f9fa';
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#dee2e6';
        dropZone.style.background = '#f8f9fa';

        if (e.dataTransfer.files.length) {
            handleFiles(e.dataTransfer.files);
        }
    });

    function handleFiles(files) {
        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            // Vérifier le type de fichier
            if (!file.type.startsWith('image/')) {
                continue;
            }

            // Vérifier la taille (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('Le fichier ' + file.name + ' est trop grand (max 10MB)');
                continue;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'image-preview';
                img.title = file.name;

                const container = document.createElement('div');
                container.className = 'position-relative';
                container.appendChild(img);

                // Bouton supprimer
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger btn-sm position-absolute top-0 end-0';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = function() {
                    container.remove();
                };
                container.appendChild(removeBtn);

                previewContainer.appendChild(container);
            };

            reader.readAsDataURL(file);
        }
    }

    // Estimation de distance (simulée - à remplacer par API réelle)
    function estimateDistance() {
        const fromCity = $('#{{ form.pickup_city.id_for_label }}').val();
        const toCity = $('#{{ form.delivery_city.id_for_label }}').val();

        if (fromCity && toCity && fromCity !== toCity) {
            // Simulation - dans la réalité, utiliser une API comme Google Maps
            const simulatedDistance = Math.floor(Math.random() * 500) + 50;
            $('#distance-display').text(simulatedDistance + ' km');
            $('#distance-estimate').show();

            // Recalculer l'estimation de prix
            calculateVolume();
        } else {
            $('#distance-estimate').hide();
            $('#price-estimate').hide();
        }
    }

    $('#{{ form.pickup_city.id_for_label }}, #{{ form.delivery_city.id_for_label }}').on('input', estimateDistance);

    // Utiliser la position actuelle
    $('#{{ form.use_current_location.id_for_label }}').change(function() {
        if ($(this).is(':checked') && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                // Remplir automatiquement la ville basée sur la géolocalisation
                // Note: Dans la réalité, utiliser une API de géocodage inversé
                $('#{{ form.pickup_city.id_for_label }}').val('Position actuelle détectée');
                alert('Position détectée ! Veuillez entrer manuellement votre ville.');
            });
        }
    });

    // Validation du formulaire
    $('#package-form').submit(function(e) {
        // Vérifier qu'une catégorie finale a été sélectionnée
        const finalCategoryId = $('#id_final_category').val();
        if (!finalCategoryId) {
            alert('{% trans "Veuillez sélectionner une catégorie pour votre colis." %}');
            e.preventDefault();
            return false;
        }

        const priceType = $('#{{ form.price_type.id_for_label }}').val();
        const askingPrice = parseFloat($('#{{ form.asking_price.id_for_label }}').val()) || 0;

        if (priceType === 'FIXED' && askingPrice < 5) {
            alert('Le prix fixe minimum est de 5€.');
            e.preventDefault();
            return false;
        }

        if (!document.getElementById('{{ form.accept_terms.id_for_label }}').checked) {
            alert('Vous devez accepter les conditions générales.');
            e.preventDefault();
            return false;
        }

        return true;
    });

    // Fonction toast
    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        if ($('#toast-container').length === 0) {
            $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
        }

        $('#toast-container').append(toastHtml);
        $('.toast').toast('show');

        $('.toast').on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }

    // Initialiser les calculs
    calculateVolume();
    estimateDistance();
});
</script>
{% endblock %}


========== colis/templates/colis/css/colis.css ==========
/* ~/ebi3/colis/static/colis/css/colis.css */
/* Styles spécifiques à l'application colis */

/* Banner principal */
.colis-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 0 0 20px 20px;
    margin-bottom: 2rem;
}

/* Cartes de colis */
.package-card {
    transition: all 0.3s ease;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
}

.package-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
}

.package-image {
    height: 200px;
    object-fit: cover;
    width: 100%;
}

/* Badges */
.featured-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10;
}

.package-type-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

/* Route display */
.route-display {
    border-left: 4px solid #667eea;
    padding-left: 1.5rem;
    margin: 1.5rem 0;
}

/* Statistiques */
.stats-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: #667eea;
    line-height: 1;
}

/* Pagination */
.pagination .page-link {
    color: #667eea;
    border: 1px solid #dee2e6;
}

.pagination .page-item.active .page-link {
    background-color: #667eea;
    border-color: #667eea;
    color: white;
}

/* Responsive */
@media (max-width: 768px) {
    .colis-banner {
        padding: 2rem 0;
    }

    .colis-banner h1 {
        font-size: 2rem;
    }

    .package-card {
        margin-bottom: 1.5rem;
    }
}


========== colis/templates/colis/partials/image_gallery.html ==========
{# ~/ebi3/colis/templates/colis/partials/image_gallery.html #}
{% load i18n %}

<div class="image-gallery">
    {% if images %}
        <div class="row">
            <!-- Image principale -->
            <div class="col-12 mb-3">
                <div id="mainImageContainer" class="position-relative">
                    {% with images|first as main_image %}
                        <img id="mainImage"
                             src="{{ main_image.image.url }}"
                             alt="{{ main_image.caption|default:'' }}"
                             class="img-fluid rounded w-100 package-detail-image"
                             data-image-id="{{ main_image.id }}">
                    {% endwith %}

                    <!-- Badge image principale -->
                    <span class="position-absolute top-0 start-0 m-2 badge bg-primary">
                        <i class="fas fa-star"></i> {% trans "Image principale" %}
                    </span>

                    <!-- Contrôles -->
                    <button class="position-absolute top-50 start-0 translate-middle-y btn btn-light btn-sm rounded-circle"
                            onclick="prevImage()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="position-absolute top-50 end-0 translate-middle-y btn btn-light btn-sm rounded-circle"
                            onclick="nextImage()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Miniatures -->
            <div class="col-12">
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    {% for image in images %}
                        <div class="thumbnail-container position-relative" style="width: 80px; height: 80px;">
                            <img src="{% if image.thumbnail and image.thumbnail.url %}{{ image.thumbnail.url }}{% else %}{{ image.image.url }}{% endif %}"
                                 alt="{{ image.caption|default:'' }}"
                                 class="img-thumbnail thumbnail-image cursor-pointer {% if forloop.first %}active{% endif %}"
                                 style="width: 100%; height: 100%; object-fit: cover;"
                                 onclick="changeMainImage('{{ image.image.url }}', '{{ image.id }}', this)"
                                 data-image-id="{{ image.id }}"
                                 data-full-image="{{ image.image.url }}"
                                 data-caption="{{ image.caption|default:'' }}">

                            {% if image.is_primary %}
                                <div class="position-absolute top-0 start-0">
                                    <i class="fas fa-star text-warning"></i>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Légende -->
            <div class="col-12 mt-3 text-center">
                <p id="imageCaption" class="text-muted mb-0">
                    {{ images.first.caption|default:"" }}
                </p>
            </div>
        </div>
    {% else %}
        <!-- Aucune image -->
        <div class="text-center py-5">
            <div class="no-image-placeholder bg-light rounded d-inline-flex align-items-center justify-content-center mb-3"
                 style="width: 200px; height: 200px;">
                <i class="fas fa-camera fa-3x text-muted"></i>
            </div>
            <h5 class="text-muted">{% trans "Aucune image disponible" %}</h5>
            <p class="text-muted small">
                {% trans "Cet expéditeur n'a pas ajouté de photos pour ce colis" %}
            </p>
        </div>
    {% endif %}
</div>

<style>
.thumbnail-image {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.thumbnail-image:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.thumbnail-image.active {
    border-color: #667eea;
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
}

.no-image-placeholder {
    border: 2px dashed #dee2e6;
}

.cursor-pointer {
    cursor: pointer;
}
</style>

<script>
let currentImageIndex = 0;
const thumbnails = document.querySelectorAll('.thumbnail-image');

function changeMainImage(imageUrl, imageId, thumbnailElement) {
    // Mettre à jour l'image principale
    const mainImage = document.getElementById('mainImage');
    mainImage.src = imageUrl;
    mainImage.setAttribute('data-image-id', imageId);

    // Mettre à jour la légende
    const caption = thumbnailElement.getAttribute('data-caption');
    document.getElementById('imageCaption').textContent = caption || '';

    // Mettre à jour les miniatures actives
    thumbnails.forEach(thumb => thumb.classList.remove('active'));
    thumbnailElement.classList.add('active');

    // Mettre à jour l'index courant
    currentImageIndex = Array.from(thumbnails).findIndex(thumb =>
        thumb.getAttribute('data-image-id') === imageId
    );
}

function nextImage() {
    if (thumbnails.length === 0) return;

    currentImageIndex = (currentImageIndex + 1) % thumbnails.length;
    const nextThumbnail = thumbnails[currentImageIndex];

    changeMainImage(
        nextThumbnail.getAttribute('data-full-image'),
        nextThumbnail.getAttribute('data-image-id'),
        nextThumbnail
    );
}

function prevImage() {
    if (thumbnails.length === 0) return;

    currentImageIndex = (currentImageIndex - 1 + thumbnails.length) % thumbnails.length;
    const prevThumbnail = thumbnails[currentImageIndex];

    changeMainImage(
        prevThumbnail.getAttribute('data-full-image'),
        prevThumbnail.getAttribute('data-image-id'),
        prevThumbnail
    );
}

// Navigation au clavier
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowRight') nextImage();
    if (e.key === 'ArrowLeft') prevImage();
});

// Zoom sur l'image au clic
document.getElementById('mainImage').addEventListener('click', function() {
    const modalHtml = `
        <div class="modal fade" id="imageModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content border-0 bg-transparent">
                    <div class="modal-header border-0">
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${this.src}"
                             alt="${this.alt}"
                             class="img-fluid rounded"
                             style="max-height: 70vh;">
                    </div>
                </div>
            </div>
        </div>
    `;

    // Créer et afficher le modal
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);

    const modal = new bootstrap.Modal(modalContainer.querySelector('#imageModal'));
    modal.show();

    // Supprimer le modal après fermeture
    modalContainer.querySelector('#imageModal').addEventListener('hidden.bs.modal', function() {
        modalContainer.remove();
    });
});
</script>


========== colis/templates/colis/partials/package_card.html ==========
{# ~/ebi3/colis/templates/colis/partials/package_card.html #}
{% load i18n %}
{% load static %}
<div class="card package-card h-100">
    <!-- Badge vedette -->
    {% if package.is_featured %}
        <div class="featured-badge">
            <span class="badge bg-warning">
                <i class="fas fa-star"></i> {% trans "En vedette" %}
            </span>
        </div>
    {% endif %}

    <!-- Image principale -->
    <div class="position-relative">
        {% with package.images.first as main_image %}
            {% if main_image and main_image.image %}
                {# CORRECTION ICI : Vérifier manuellement le thumbnail #}
                {% if main_image.thumbnail and main_image.thumbnail.name %}
                    <img src="{{ main_image.thumbnail.url }}"
                         class="card-img-top package-image"
                         alt="{{ package.title }}"
                         loading="lazy"
                         onerror="this.onerror=null; this.src='{{ main_image.image.url }}';">
                {% else %}
                    <img src="{{ main_image.image.url }}"
                         class="card-img-top package-image"
                         alt="{{ package.title }}"
                         loading="lazy">
                {% endif %}
            {% else %}
                <div class="card-img-top package-image bg-light d-flex align-items-center justify-content-center">
                    <i class="fas fa-box fa-3x text-muted"></i>
                    <span class="small text-muted mt-2">{% trans "Pas d'image" %}</span>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Badge type de colis -->
        <span class="position-absolute top-0 start-0 m-2 package-type-badge badge
                     {% if package.package_type == 'SMALL_PACKAGE' %}bg-success
                     {% elif package.package_type == 'MEDIUM_PACKAGE' %}bg-info
                     {% elif package.package_type == 'LARGE_PACKAGE' %}bg-warning
                     {% elif package.package_type == 'FURNITURE' %}bg-primary
                     {% else %}bg-secondary{% endif %}">
            {{ package.get_package_type_display }}
        </span>

        <!-- Badge fragile -->
        {% if package.is_fragile %}
            <span class="position-absolute top-0 end-0 m-2 fragile-badge badge bg-danger">
                <i class="fas fa-exclamation-triangle"></i> {% trans "Fragile" %}
            </span>
        {% endif %}
    </div>

    <!-- Corps de la carte -->
    <div class="card-body d-flex flex-column">
        <h5 class="card-title">
            <a href="{{ package.get_absolute_url }}" class="text-decoration-none text-dark">
                {{ package.title|truncatechars:60 }}
            </a>
        </h5>

        <!-- Trajet -->
        <div class="package-route mb-2">
            <div class="d-flex align-items-center">
                <div class="route-point start-point">
                    <i class="fas fa-map-marker-alt text-danger"></i>
                    <small>{{ package.pickup_city|truncatechars:20 }}</small>
                </div>
                <div class="route-line flex-grow-1 mx-2">
                    <hr class="my-1">
                </div>
                <div class="route-point end-point">
                    <i class="fas fa-map-marker-alt text-success"></i>
                    <small>{{ package.delivery_city|truncatechars:20 }}</small>
                </div>
            </div>
        </div>

        <!-- Informations -->
        <div class="package-info mb-3">
            <div class="row g-2">
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Poids" %}</small>
                    <strong>{{ package.weight }} kg</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Dimensions" %}</small>
                    <strong>{{ package.length }}×{{ package.width }}×{{ package.height }} cm</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Départ" %}</small>
                    <strong>{{ package.pickup_date|date:"d/m" }}</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Livraison" %}</small>
                    <strong>{{ package.delivery_date|date:"d/m" }}</strong>
                </div>
            </div>
        </div>

        <!-- Description -->
        <p class="card-text small text-muted mb-3">
            {{ package.description|truncatechars:120 }}
        </p>

        <!-- Prix et actions -->
        <div class="mt-auto">
            <div class="d-flex justify-content-between align-items-center">
                <div class="package-price">
                    <span class="h5 text-primary">{{ package.asking_price }} {{ package.get_currency_display }}</span>
                    {% if package.price_type == 'NEGOTIABLE' %}
                        <small class="text-muted d-block">{% trans "(Prix négociable)" %}</small>
                    {% endif %}
                </div>

                <!-- Bouton favori -->
                {% if user.is_authenticated %}
                    <button class="btn btn-sm favorite-btn
                                {% if package in user.package_favorites.all %}btn-danger{% else %}btn-outline-danger{% endif %}"
                            data-url="{% url 'colis:toggle_favorite' package.slug %}"
                            data-package-slug="{{ package.slug }}"
                            data-bs-toggle="tooltip"
                            title="{% if package in user.package_favorites.all %}{% trans 'Retirer des favoris' %}{% else %}{% trans 'Ajouter aux favoris' %}{% endif %}">
                        <i class="{% if package in user.package_favorites.all %}fas{% else %}far{% endif %} fa-heart"></i>
                    </button>
                {% else %}
                    <a href="{% url 'users:login' %}?next={{ request.path }}"
                       class="btn btn-sm btn-outline-danger requires-login"
                       data-bs-toggle="tooltip"
                       title="{% trans 'Connectez-vous pour ajouter aux favoris' %}">
                        <i class="far fa-heart"></i>
                    </a>
                {% endif %}
            </div>

            <!-- Bouton voir détails -->
            <div class="d-grid mt-3">
                <a href="{{ package.get_absolute_url }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-eye"></i> {% trans "Voir détails" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Pied de carte -->
    <div class="card-footer bg-transparent border-top">
        <div class="d-flex justify-content-between align-items-center">
            <div class="small">
                <i class="fas fa-user"></i>
                <a href="{% url 'users:profile' package.sender.username %}" class="text-decoration-none">
                    {{ package.sender.username }}
                </a>
            </div>
            <div class="small text-muted">
                <i class="fas fa-eye"></i> {{ package.view_count }}
                <i class="fas fa-gavel ms-2"></i> {{ package.offer_count }}
                <i class="fas fa-heart ms-2"></i> {{ package.favorite_count }}
            </div>
        </div>
    </div>
</div>

<style>
.package-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
}

.package-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.package-image {
    height: 180px;
    object-fit: cover;
    width: 100%;
}

.featured-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10;
}

.package-type-badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}

.fragile-badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}

.package-route .route-line hr {
    border-top: 2px dashed #dee2e6;
}

.package-price .h5 {
    font-weight: bold;
}

.route-point {
    text-align: center;
    min-width: 60px;
}

.route-point small {
    display: block;
    font-size: 0.75rem;
}
</style>


========== colis/templates/colis/partials/status_badge.html ==========
{# ~/ebi3/colis/templates/colis/partials/status_badge.html #}
{% load i18n %}

{% if status == 'DRAFT' %}
    <span class="badge bg-secondary">
        <i class="fas fa-edit"></i> {% trans "Brouillon" %}
    </span>
{% elif status == 'AVAILABLE' %}
    <span class="badge bg-success">
        <i class="fas fa-check-circle"></i> {% trans "Disponible" %}
    </span>
{% elif status == 'RESERVED' %}
    <span class="badge bg-info">
        <i class="fas fa-handshake"></i> {% trans "Réservé" %}
    </span>
{% elif status == 'IN_TRANSIT' %}
    <span class="badge bg-warning">
        <i class="fas fa-truck-moving"></i> {% trans "En transit" %}
    </span>
{% elif status == 'DELIVERED' %}
    <span class="badge bg-primary">
        <i class="fas fa-box-check"></i> {% trans "Livré" %}
    </span>
{% elif status == 'CANCELLED' %}
    <span class="badge bg-danger">
        <i class="fas fa-times-circle"></i> {% trans "Annulé" %}
    </span>
{% elif status == 'EXPIRED' %}
    <span class="badge bg-dark">
        <i class="fas fa-clock"></i> {% trans "Expiré" %}
    </span>
{% else %}
    <span class="badge bg-secondary">
        <i class="fas fa-question-circle"></i> {{ status }}
    </span>
{% endif %}


========== colis/templates/colis/partials/search_filters.html ==========
{# ~/ebi3/colis/templates/colis/partials/search_filters.html #}
{% load i18n crispy_forms_tags %}
<div class="card shadow-sm">
    <div class="card-body">
        <form method="get" action="{% url 'colis:search' %}" id="search-form">
            <div class="row g-3">
                <!-- Recherche texte -->
                <div class="col-md-12">
                    <div class="input-group">
                        <input type="text"
                               name="q"
                               class="form-control"
                               placeholder="{% trans 'Que cherchez-vous à transporter ?' %}"
                               value="{{ request.GET.q|default:'' }}">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i> {% trans "Rechercher" %}
                        </button>
                    </div>
                </div>

                <!-- Filtres avancés (toggle) -->
                <div class="col-12">
                    <button class="btn btn-outline-secondary btn-sm w-100" type="button"
                            data-bs-toggle="collapse" data-bs-target="#advancedFilters"
                            aria-expanded="false" aria-controls="advancedFilters">
                        <i class="fas fa-filter"></i> {% trans "Filtres avancés" %}
                    </button>
                </div>

                <!-- Filtres avancés (contenu) -->
                <div class="collapse mt-3" id="advancedFilters">
                    <div class="row g-3">
                        <!-- Origine -->
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Départ" %}</label>
                            <input type="text"
                                   name="pickup_city"
                                   class="form-control"
                                   placeholder="{% trans 'Ville de départ' %}"
                                   value="{{ request.GET.pickup_city|default:'' }}">
                        </div>

                        <!-- Destination -->
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Destination" %}</label>
                            <input type="text"
                                   name="delivery_city"
                                   class="form-control"
                                   placeholder="{% trans 'Ville d\'arrivée' %}"
                                   value="{{ request.GET.delivery_city|default:'' }}">
                        </div>

                        <!-- Catégorie -->
                        <div class="col-md-4">
                            <label class="form-label">{% trans "Catégorie" %}</label>
                            <select name="category" class="form-select">
                                <option value="">{% trans "Toutes catégories" %}</option>
                                {% for category in categories %}
                                    <option value="{{ category.slug }}"
                                            {% if request.GET.category == category.slug %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Type de colis -->
                        <div class="col-md-4">
                            <label class="form-label">{% trans "Type" %}</label>
                            <select name="package_type" class="form-select">
                                <option value="">{% trans "Tous types" %}</option>
                                <option value="SMALL_PACKAGE" {% if request.GET.package_type == 'SMALL_PACKAGE' %}selected{% endif %}>
                                    {% trans "Petit colis (< 30kg)" %}
                                </option>
                                <option value="MEDIUM_PACKAGE" {% if request.GET.package_type == 'MEDIUM_PACKAGE' %}selected{% endif %}>
                                    {% trans "Colis moyen (30-100kg)" %}
                                </option>
                                <option value="LARGE_PACKAGE" {% if request.GET.package_type == 'LARGE_PACKAGE' %}selected{% endif %}>
                                    {% trans "Gros colis (100-500kg)" %}
                                </option>
                                <option value="FURNITURE" {% if request.GET.package_type == 'FURNITURE' %}selected{% endif %}>
                                    {% trans "Meuble" %}
                                </option>
                            </select>
                        </div>

                        <!-- Poids max -->
                        <div class="col-md-4">
                            <label class="form-label">{% trans "Poids max (kg)" %}</label>
                            <input type="number"
                                   name="max_weight"
                                   class="form-control"
                                   min="0"
                                   step="0.001"
                                   placeholder="{% trans 'Ex: 50' %}"
                                   value="{{ request.GET.max_weight|default:'' }}">
                        </div>

                        <!-- Dates -->
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Départ à partir du" %}</label>
                            <input type="date"
                                   name="pickup_date_from"
                                   class="form-control"
                                   value="{{ request.GET.pickup_date_from|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">{% trans "Départ jusqu'au" %}</label>
                            <input type="date"
                                   name="pickup_date_to"
                                   class="form-control"
                                   value="{{ request.GET.pickup_date_to|default:'' }}">
                        </div>

                        <!-- Prix -->
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Prix min" %}</label>
                            <div class="input-group">
                                <input type="number"
                                       name="min_price"
                                       class="form-control"
                                       min="0"
                                       step="0.01"
                                       placeholder="{% trans 'Min' %}"
                                       value="{{ request.GET.min_price|default:'' }}">
                                <span class="input-group-text">€</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">{% trans "Prix max" %}</label>
                            <div class="input-group">
                                <input type="number"
                                       name="max_price"
                                       class="form-control"
                                       min="0"
                                       step="0.01"
                                       placeholder="{% trans 'Max' %}"
                                       value="{{ request.GET.max_price|default:'' }}">
                                <span class="input-group-text">€</span>
                            </div>
                        </div>

                        <!-- Options -->
                        <div class="col-md-12">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input"
                                       type="checkbox"
                                       name="flexible_dates"
                                       id="flexibleDates"
                                       {% if request.GET.flexible_dates %}checked{% endif %}>
                                <label class="form-check-label" for="flexibleDates">
                                    {% trans "Dates flexibles" %}
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input"
                                       type="checkbox"
                                       name="is_fragile"
                                       id="fragileOnly"
                                       {% if request.GET.is_fragile %}checked{% endif %}>
                                <label class="form-check-label" for="fragileOnly">
                                    {% trans "Fragile seulement" %}
                                </label>
                            </div>
                        </div>

                        <!-- Boutons -->
                        <div class="col-md-12">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-grow-1">
                                    <i class="fas fa-filter"></i> {% trans "Appliquer les filtres" %}
                                </button>
                                <a href="{% url 'colis:package_list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> {% trans "Effacer" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
$(document).ready(function() {
    // Auto-submit sur changement de certains filtres
    $('select[name="category"], select[name="package_type"]').change(function() {
        $('#search-form').submit();
    });

    // Pré-remplir la date de départ à partir d'aujourd'hui
    if (!$('input[name="pickup_date_from"]').val()) {
        const today = new Date().toISOString().split('T')[0];
        $('input[name="pickup_date_from"]').val(today);
    }
});
</script>


========== colis/templates/colis/js/colis.js ==========
// ~/ebi3/colis/static/colis/js/colis.js
// JavaScript spécifique à l'application colis

$(document).ready(function() {
    // Initialisation des tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Gestion des favoris
    $('.favorite-btn').click(function(e) {
        e.preventDefault();
        const btn = $(this);
        const url = btn.data('url');

        $.ajax({
            url: url,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            success: function(data) {
                if (data.status === 'success') {
                    btn.toggleClass('btn-danger btn-outline-danger');
                    btn.find('i').toggleClass('fas far');

                    // Afficher notification
                    showToast(
                        data.action === 'added' ?
                        'Colis ajouté aux favoris' :
                        'Colis retiré des favoris',
                        'success'
                    );
                }
            }
        });
    });

    // Calcul de volume automatique
    $('.dimension-input').on('input', function() {
        const length = parseFloat($('#id_length').val()) || 0;
        const width = parseFloat($('#id_width').val()) || 0;
        const height = parseFloat($('#id_height').val()) || 0;

        if (length > 0 && width > 0 && height > 0) {
            const volume = (length * width * height) / 1000;
            $('#volume-preview').text(volume.toFixed(2) + ' L').removeClass('d-none');
        }
    });

    // Fonction pour afficher des toasts
    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        if ($('#toast-container').length === 0) {
            $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
        }

        $('#toast-container').append(toastHtml);
        $('.toast').toast('show');

        $('.toast').on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }

    // Initialiser le sélecteur de date avec des limites
    const today = new Date().toISOString().split('T')[0];
    $('input[type="date"][min]').attr('min', today);

    // Gestion des modales de connexion
    $('.requires-login').click(function(e) {
        if (!window.userAuthenticated) {
            e.preventDefault();
            $('#loginModal').modal('show');
        }
    });
});


========== colis/templates/colis/layout/breadcrumb.html ==========
{# ~/ebi3/colis/templates/colis/layout/breadcrumb.html #}
{% load i18n %}

<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'core:home' %}">
                <i class="fas fa-home"></i> {% trans "Accueil" %}
            </a>
        </li>

        {% if request.resolver_match.namespace == 'colis' %}
            <li class="breadcrumb-item">
                <a href="{% url 'colis:package_list' %}">
                    <i class="fas fa-box"></i> {% trans "Colis" %}
                </a>
            </li>

            {% if request.resolver_match.url_name == 'package_create' %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-plus-circle"></i> {% trans "Publier un colis" %}
                </li>

            {% elif request.resolver_match.url_name == 'package_detail' and package %}
                <li class="breadcrumb-item active" aria-current="page">
                    {{ package.title|truncatechars:30 }}
                </li>

            {% elif request.resolver_match.url_name == 'category_detail' and category %}
                <li class="breadcrumb-item active" aria-current="page">
                    {{ category.name }}
                </li>

            {% elif request.resolver_match.url_name == 'my_packages' %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-boxes"></i> {% trans "Mes colis" %}
                </li>

            {% elif request.resolver_match.url_name == 'favorite_list' %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-heart"></i> {% trans "Mes favoris" %}
                </li>

            {% elif request.resolver_match.url_name == 'my_offers' %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-handshake"></i> {% trans "Mes offres" %}
                </li>

            {% elif request.resolver_match.url_name == 'available_packages' %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-search"></i> {% trans "Colis disponibles" %}
                </li>

            {% elif request.resolver_match.url_name == 'carrier_dashboard' %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-tachometer-alt"></i> {% trans "Dashboard transporteur" %}
                </li>

            {% elif request.resolver_match.url_name == 'how_it_works' %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-info-circle"></i> {% trans "Comment ça marche" %}
                </li>

            {% elif request.resolver_match.url_name == 'price_guide' %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-euro-sign"></i> {% trans "Guide des prix" %}
                </li>

            {% elif request.resolver_match.url_name == 'search' %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-search"></i> {% trans "Recherche" %}
                </li>

            {% else %}
                <li class="breadcrumb-item active" aria-current="page">
                    {% trans "Navigation" %}
                </li>
            {% endif %}

        {% else %}
            <li class="breadcrumb-item active" aria-current="page">
                {% trans "Page" %}
            </li>
        {% endif %}
    </ol>
</nav>

<style>
.breadcrumb {
    background-color: transparent;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.breadcrumb-item a {
    color: #667eea;
    text-decoration: none;
    transition: color 0.3s;
}

.breadcrumb-item a:hover {
    color: #764ba2;
    text-decoration: underline;
}

.breadcrumb-item.active {
    color: #6c757d;
    font-weight: 500;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: "›";
    color: #6c757d;
    padding: 0 0.5rem;
}
</style>


========== colis/templates/colis/base_colis.html ==========
{# ~/ebi3/colis/templates/colis/base_colis.html #}
{% extends 'core/base.html' %}
{% load i18n static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'colis/css/colis.css' %}">
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'colis/js/colis.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Bannière principale -->
    <div class="colis-banner bg-primary text-white py-5 mb-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold">
                        {% block colis_title %}{% trans "Transportez vos colis en toute confiance" %}{% endblock %}
                    </h1>
                    <p class="lead">
                        {% trans "Des milliers de transporteurs disponibles pour vos envois" %}
                    </p>
                </div>
                <div class="col-lg-4 text-lg-end">
                    {% if user.is_authenticated %}
                        <a href="{% url 'colis:package_create' %}" class="btn btn-light btn-lg">
                            <i class="fas fa-plus-circle"></i> {% trans "Publier un colis" %}
                        </a>
                    {% else %}
                        <a href="{% url 'users:login' %}?next={% url 'colis:package_create' %}" class="btn btn-light btn-lg">
                            <i class="fas fa-user-plus"></i> {% trans "Commencez gratuitement" %}
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Barre de recherche -->
    <div class="container mb-4">
        {% include 'colis/partials/search_filters.html' %}
    </div>

    <!-- Contenu principal -->
    <div class="container">
        <div class="row">
            <!-- Sidebar gauche -->
            <div class="col-lg-3 d-none d-lg-block">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-box text-primary"></i> {% trans "Navigation" %}
                        </h5>
                        <div class="list-group list-group-flush">
                            <a href="{% url 'colis:package_list' %}"
                               class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'package_list' %}active{% endif %}">
                                <i class="fas fa-list me-2"></i> {% trans "Tous les colis" %}
                            </a>
                            {% if user.is_authenticated %}
                            <a href="{% url 'colis:package_create' %}"
                               class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'package_create' %}active{% endif %}">
                                <i class="fas fa-plus-circle me-2 text-success"></i> {% trans "Publier un colis" %}
                            </a>
                            <a href="{% url 'colis:my_packages' %}"
                               class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'my_packages' %}active{% endif %}">
                                <i class="fas fa-boxes me-2"></i> {% trans "Mes colis" %}
                            </a>
                            <a href="{% url 'colis:favorite_list' %}"
                               class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'favorite_list' %}active{% endif %}">
                                <i class="fas fa-heart me-2 text-danger"></i> {% trans "Mes favoris" %}
                            </a>
                            <a href="{% url 'colis:my_offers' %}"
                               class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'my_offers' %}active{% endif %}">
                                <i class="fas fa-handshake me-2 text-warning"></i> {% trans "Mes offres" %}
                            </a>
                            {% endif %}
                            <a href="{% url 'colis:how_it_works' %}"
                               class="list-group-item list-group-item-action">
                                <i class="fas fa-info-circle me-2 text-info"></i> {% trans "Comment ça marche" %}
                            </a>
                            <a href="{% url 'colis:price_guide' %}"
                               class="list-group-item list-group-item-action">
                                <i class="fas fa-euro-sign me-2 text-success"></i> {% trans "Guide des prix" %}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Catégories -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-tags text-primary"></i> {% trans "Catégories" %}
                        </h5>
                        <div class="list-group list-group-flush">
                            {% for category in categories|slice:":10" %}
                            <a href="{% url 'colis:category_detail' category.slug %}"
                               class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                {{ category.name }}
                                <span class="badge bg-primary rounded-pill">{{ category.package_count }}</span>
                            </a>
                            {% endfor %}
                            <a href="{% url 'colis:category_list' %}" class="list-group-item list-group-item-action text-center text-primary">
                                <i class="fas fa-chevron-down me-1"></i> {% trans "Voir toutes" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenu central -->
            <div class="col-lg-9">
                <!-- Messages -->
                {% if messages %}
                    <div class="messages mb-4">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Fil d'Ariane -->
                {% include 'colis/layout/breadcrumb.html' %}

                <!-- Contenu spécifique -->
                {% block colis_content %}{% endblock %}
            </div>
        </div>
    </div>
</div>

<!-- Widget d'aide -->
{% include 'colis/includes/help_widget.html' %}

<!-- Modal de connexion -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Connexion requise" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p>{% trans "Vous devez être connecté pour effectuer cette action." %}</p>
                <div class="d-grid gap-2">
                    <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> {% trans "Se connecter" %}
                    </a>
                    <a href="{% url 'users:register' %}" class="btn btn-outline-primary">
                        <i class="fas fa-user-plus"></i> {% trans "Créer un compte" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_body_js %}
<script>
$(document).ready(function() {
    // Initialisation des tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Gestion des modales de connexion
    $('.requires-login').click(function(e) {
        if (!{{ user.is_authenticated|yesno:"true,false" }}) {
            e.preventDefault();
            $('#loginModal').modal('show');
        }
    });

    // Calcul automatique du volume
    $('.volume-calculator').on('input', function() {
        const length = parseFloat($('#id_length').val()) || 0;
        const width = parseFloat($('#id_width').val()) || 0;
        const height = parseFloat($('#id_height').val()) || 0;

        if (length > 0 && width > 0 && height > 0) {
            const volume = (length * width * height) / 1000;
            $('#volume-preview').text(volume.toFixed(2) + ' L').removeClass('d-none');
        }
    });
});
</script>
{% endblock %}


========== colis/sitemaps.py ==========
# ~/ebi3/colis/sitemaps.py
"""
Sitemaps XML pour l'application colis
Améliore le SEO en fournissant aux moteurs de recherche
une carte complète du contenu du site
"""

from datetime import datetime, timezone
from django.contrib import sitemaps
from django.urls import reverse
from django.contrib.sites.models import Site
from django.utils.translation import gettext_lazy as _
from django.db.models import F
from .models import Package, PackageCategory


# ============================================================================
# SITEMAPS STATIQUES
# ============================================================================

class StaticSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les pages statiques de l'application colis
    """
    priority = 1.0
    changefreq = 'monthly'
    protocol = 'https'

    def items(self):
        return [
            'colis:package_list',
            'colis:search',
            'colis:how_it_works',
            'colis:pricing',
            'colis:faq',
            'colis:contact',
            'colis:terms',
            'colis:privacy',
            'colis:safety',
            'colis:become_carrier',
            'colis:success_stories',
            'colis:testimonials',
        ]

    def location(self, item):
        return reverse(item)

    def lastmod(self, item):
        """
        Retourne la date de dernière modification des pages statiques
        """
        # Pour les pages statiques, on utilise une date fixe
        # ou la date de déploiement
        return datetime(2024, 1, 1, tzinfo=timezone.utc)


class CategorySitemap(sitemaps.Sitemap):
    """
    Sitemap pour les catégories de colis
    """
    changefreq = 'weekly'
    priority = 0.8
    protocol = 'https'

    def items(self):
        """
        Retourne toutes les catégories actives avec au moins un colis disponible
        """
        return PackageCategory.objects.filter(
            is_active=True,
            packages__status='AVAILABLE'
        ).distinct().order_by('lft')

    def location(self, obj):
        return reverse('colis:category_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        """
        Dernière modification = date du dernier colis ajouté dans cette catégorie
        """
        last_package = obj.packages.filter(status='AVAILABLE').order_by('-created_at').first()
        if last_package:
            return last_package.created_at
        return obj.updated_at

    def priority(self, obj):
        """
        Priorité SEO basée sur le nombre de colis dans la catégorie
        """
        package_count = obj.packages.filter(status='AVAILABLE').count()
        if package_count > 100:
            return 0.9
        elif package_count > 50:
            return 0.8
        elif package_count > 20:
            return 0.7
        else:
            return 0.6


# ============================================================================
# SITEMAPS DYNAMIQUES - PACKAGES
# ============================================================================

class PackageSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les colis individuels
    Optimisé pour les colis disponibles et récents
    """
    changefreq = 'daily'
    protocol = 'https'
    limit = 5000  # Limite Google sitemap

    def items(self):
        """
        Retourne les colis disponibles pour le sitemap
        """
        # Filtrer les colis disponibles et actifs
        return Package.objects.filter(
            status__in=['AVAILABLE', 'RESERVED', 'IN_TRANSIT'],
            is_archived=False
        ).select_related(
            'sender', 'category'
        ).prefetch_related(
            'images'
        ).order_by('-created_at')

    def location(self, obj):
        return reverse('colis:package_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        """
        Dernière modification = max(created_at, updated_at)
        """
        return max(obj.created_at, obj.updated_at) if obj.updated_at else obj.created_at

    def priority(self, obj):
        """
        Priorité SEO basée sur l'âge et le statut du colis
        """
        # Calculer l'âge en jours
        age_days = (datetime.now(timezone.utc) - obj.created_at).days

        # Priorité basée sur l'âge
        if age_days < 7:  # Moins d'une semaine
            return 0.9
        elif age_days < 30:  # Moins d'un mois
            return 0.8
        elif age_days < 90:  # Moins de 3 mois
            return 0.7
        else:
            return 0.6

    def changefreq(self, obj):
        """
        Fréquence de changement basée sur le statut
        """
        if obj.status == 'AVAILABLE':
            return 'daily'  # Les colis disponibles changent souvent
        elif obj.status == 'RESERVED':
            return 'weekly'
        elif obj.status == 'IN_TRANSIT':
            return 'daily'  # Suivi en temps réel
        else:
            return 'monthly'


class PackageIndexSitemap(sitemaps.Sitemap):
    """
    Sitemap d'index pour les pages de liste de colis avec filtres
    """
    changefreq = 'daily'
    priority = 0.7
    protocol = 'https'

    def items(self):
        """
        Génère des URLs de filtrage pour les moteurs de recherche
        """
        items = []

        # 1. Pages principales de filtrage
        items.append(('colis:package_list', {}))

        # 2. Filtres par catégorie
        categories = PackageCategory.objects.filter(
            is_active=True,
            packages__status='AVAILABLE'
        ).distinct()[:50]  # Limiter à 50 catégories

        for category in categories:
            items.append(('colis:category_detail', {'slug': category.slug}))

        # 3. Filtres par pays
        from django_countries import countries
        popular_countries = ['FR', 'MA', 'TN', 'DZ', 'BE', 'CH', 'CA']

        for country_code in popular_countries:
            items.append(('colis:package_list', {'country_to': country_code}))

        # 4. Filtres par prix (plages)
        price_ranges = [
            (0, 100),
            (100, 500),
            (500, 1000),
            (1000, 5000),
        ]

        for min_price, max_price in price_ranges:
            items.append(('colis:search', {
                'min_price': min_price,
                'max_price': max_price
            }))

        return items

    def location(self, item):
        url_name, params = item
        return reverse(url_name, kwargs=params) if params else reverse(url_name)


# ============================================================================
# SITEMAPS DYNAMIQUES - TRANSPORTEURS (OPTIONNEL)
# ============================================================================

class CarrierSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les profils de transporteurs
    """
    changefreq = 'weekly'
    priority = 0.7
    protocol = 'https'
    limit = 2000

    def items(self):
        """
        Transporteurs actifs et vérifiés
        Note: Cette classe est optionnelle, dépend de l'existence du modèle Carrier
        """
        try:
            from carriers.models import Carrier
            return Carrier.objects.filter(
                status='APPROVED',
                is_available=True,
                verification_level__gte=2  # Au moins partiellement vérifié
            ).select_related('user').order_by('-average_rating', '-total_missions')
        except ImportError:
            # Retourner une liste vide si l'application carriers n'est pas disponible
            return []

    def location(self, obj):
        from django.urls import reverse
        return reverse('carriers:carrier_detail', kwargs={'username': obj.user.username})

    def lastmod(self, obj):
        """
        Dernière modification = date de dernière mise à jour du profil
        """
        return max(obj.user.date_joined, obj.updated_at)

    def priority(self, obj):
        """
        Priorité basée sur la réputation du transporteur
        """
        if obj.average_rating >= 4.5 and obj.total_missions > 50:
            return 0.9
        elif obj.average_rating >= 4.0 and obj.total_missions > 20:
            return 0.8
        elif obj.average_rating >= 3.5:
            return 0.7
        else:
            return 0.6


# ============================================================================
# SITEMAPS SPÉCIALISÉS
# ============================================================================

class RecentPackagesSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les colis récemment ajoutés (dernières 24h)
    """
    changefreq = 'hourly'
    priority = 1.0
    protocol = 'https'
    limit = 100

    def items(self):
        from django.utils import timezone
        yesterday = timezone.now() - timezone.timedelta(days=1)

        return Package.objects.filter(
            status='AVAILABLE',
            created_at__gte=yesterday,
            is_archived=False
        ).order_by('-created_at')[:self.limit]

    def location(self, obj):
        return reverse('colis:package_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        return obj.created_at


class PopularPackagesSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les colis populaires (plus de vues/favoris)
    """
    changefreq = 'daily'
    priority = 0.9
    protocol = 'https'
    limit = 100

    def items(self):
        """
        Colis les plus populaires basés sur les vues et favoris
        """
        return Package.objects.filter(
            status='AVAILABLE',
            is_archived=False
        ).annotate(
            popularity_score=(F('view_count') * 1) + (F('favorite_count') * 3)
        ).order_by('-popularity_score', '-created_at')[:self.limit]

    def location(self, obj):
        return reverse('colis:package_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        return max(obj.created_at, obj.updated_at) if obj.updated_at else obj.created_at


class GeoPackageSitemap(sitemaps.Sitemap):
    """
    Sitemap géographique pour les colis par ville/région
    """
    changefreq = 'weekly'
    priority = 0.8
    protocol = 'https'

    def items(self):
        """
        Retourne les combinaisons uniques pays/ville avec au moins 5 colis
        """
        from django.db.models import Count
        from django.db.models.functions import Lower

        return Package.objects.filter(
            status='AVAILABLE'
        ).values(
            'country_to', 'city_to'
        ).annotate(
            package_count=Count('id')
        ).filter(
            package_count__gte=5
        ).order_by('country_to', Lower('city_to'))

    def location(self, obj):
        """
        URL de recherche filtrée par ville
        """
        return reverse('colis:search') + f'?country_to={obj["country_to"]}&city_to={obj["city_to"]}'

    def lastmod(self, obj):
        """
        Dernière modification = date du dernier colis pour cette destination
        """
        last_package = Package.objects.filter(
            country_to=obj['country_to'],
            city_to=obj['city_to'],
            status='AVAILABLE'
        ).order_by('-created_at').first()

        return last_package.created_at if last_package else datetime.now(timezone.utc)


# ============================================================================
# SITEMAPS AVANCÉS POUR SEO TECHNIQUE
# ============================================================================

class XMLIndexSitemap(sitemaps.Sitemap):
    """
    Sitemap d'index qui liste tous les autres sitemaps
    """
    def items(self):
        """
        Liste de tous les sitemaps à inclure dans l'index
        """
        current_site = Site.objects.get_current()
        base_url = f"https://{current_site.domain}/colis/sitemap_"

        sitemaps_list = [
            f"{base_url}static.xml",
            f"{base_url}categories.xml",
            f"{base_url}packages.xml",
        ]

        # Ajouter conditionnellement le sitemap des transporteurs
        try:
            from carriers.models import Carrier
            if Carrier.objects.exists():
                sitemaps_list.append(f"{base_url}carriers.xml")
        except ImportError:
            pass

        # Ajouter d'autres sitemaps conditionnels
        if Package.objects.filter(status='AVAILABLE').count() > 100:
            sitemaps_list.extend([
                f"{base_url}recent.xml",
                f"{base_url}popular.xml",
            ])

        if Package.objects.filter(status='AVAILABLE').count() > 500:
            sitemaps_list.append(f"{base_url}geo.xml")

        return sitemaps_list

    def location(self, item):
        return item

    def lastmod(self, item):
        """
        Tous les sitemaps sont mis à jour quotidiennement
        """
        return datetime.now(timezone.utc).replace(hour=0, minute=0, second=0, microsecond=0)


class MobileSitemap(sitemaps.Sitemap):
    """
    Sitemap spécifique pour les versions mobiles
    """
    changefreq = 'daily'
    priority = 0.9
    protocol = 'https'
    limit = 1000

    def items(self):
        """
        Colis optimisés pour mobile (avec images et descriptions courtes)
        """
        return Package.objects.filter(
            status='AVAILABLE',
            images__isnull=False,  # Au moins une image
            is_archived=False
        ).exclude(
            description__isnull=True
        ).exclude(
            description=''
        ).distinct().order_by('-created_at')[:self.limit]

    def location(self, obj):
        return reverse('colis:package_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        return max(obj.created_at, obj.updated_at) if obj.updated_at else obj.created_at


class ImageSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les images des colis (Google Images SEO)
    """
    changefreq = 'weekly'
    priority = 0.6
    protocol = 'https'
    limit = 1000

    def items(self):
        """
        Retourne les colis avec des images
        """
        return Package.objects.filter(
            images__isnull=False,
            status__in=['AVAILABLE', 'RESERVED', 'IN_TRANSIT'],
            is_archived=False
        ).prefetch_related('images').distinct().order_by('-created_at')[:self.limit]

    def location(self, obj):
        return reverse('colis:package_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        return max(obj.created_at, obj.updated_at) if obj.updated_at else obj.created_at

    def _get_images(self, obj):
        """
        Retourne les informations des images pour le sitemap
        """
        images = []
        for img in obj.images.all()[:10]:  # Limiter à 10 images par colis
            if img.image:
                images.append({
                    'location': img.image.url,
                    'title': img.caption or f"Image de {obj.title}",
                    'caption': img.caption or f"Photo du colis {obj.title}",
                    'license': 'https://creativecommons.org/licenses/by-nc-sa/4.0/',
                })
        return images


# ============================================================================
# SITEMAP FACTORY ET REGISTRE
# ============================================================================

def get_colis_sitemaps():
    """
    Retourne un dictionnaire de tous les sitemaps pour l'application colis
    """
    sitemaps_dict = {
        'static': StaticSitemap,
        'categories': CategorySitemap,
        'packages': PackageSitemap,
        'index': XMLIndexSitemap,
    }

    # Ajouter conditionnellement le sitemap des transporteurs
    try:
        from carriers.models import Carrier
        if Carrier.objects.exists():
            sitemaps_dict['carriers'] = CarrierSitemap
    except ImportError:
        pass

    # Ajouter des sitemaps supplémentaires
    if Package.objects.filter(status='AVAILABLE').count() > 0:
        sitemaps_dict['recent'] = RecentPackagesSitemap
        sitemaps_dict['popular'] = PopularPackagesSitemap
        sitemaps_dict['mobile'] = MobileSitemap
        sitemaps_dict['images'] = ImageSitemap

    if Package.objects.filter(status='AVAILABLE').count() > 500:
        sitemaps_dict['geo'] = GeoPackageSitemap

    return sitemaps_dict


def get_active_sitemaps():
    """
    Retourne les sitemaps actifs selon le contexte
    """
    sitemaps = {
        'static': StaticSitemap(),
        'categories': CategorySitemap(),
        'packages': PackageSitemap(),
    }

    # Ajouter conditionnellement le sitemap des transporteurs
    try:
        from carriers.models import Carrier
        if Carrier.objects.filter(status='APPROVED').exists():
            sitemaps['carriers'] = CarrierSitemap()
    except (ImportError, ModuleNotFoundError):
        # L'application carriers n'est pas disponible ou pas installée
        pass

    # Ajouter des sitemaps supplémentaires si beaucoup de contenu
    package_count = Package.objects.filter(status='AVAILABLE').count()

    if package_count > 0:
        sitemaps['recent'] = RecentPackagesSitemap()
        sitemaps['popular'] = PopularPackagesSitemap()
        sitemaps['mobile'] = MobileSitemap()
        sitemaps['images'] = ImageSitemap()

    if package_count > 500:
        sitemaps['geo'] = GeoPackageSitemap()

    return sitemaps


# ============================================================================
# UTILITAIRES POUR GÉNÉRATION DE SITEMAP
# ============================================================================

class SitemapGenerator:
    """
    Classe utilitaire pour générer et gérer les sitemaps
    """

    @staticmethod
    def generate_sitemap_index():
        """
        Génère le contenu XML de l'index des sitemaps
        """
        current_site = Site.objects.get_current()
        sitemaps = get_active_sitemaps()

        xml_content = '<?xml version="1.0" encoding="UTF-8"?>\n'
        xml_content += '<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n'

        for name, sitemap in sitemaps.items():
            if name != 'index':  # Exclure l'index lui-même
                url = f"https://{current_site.domain}/colis/sitemap_{name}.xml"
                lastmod = datetime.now(timezone.utc).strftime('%Y-%m-%d')

                xml_content += f'  <sitemap>\n'
                xml_content += f'    <loc>{url}</loc>\n'
                xml_content += f'    <lastmod>{lastmod}</lastmod>\n'
                xml_content += f'  </sitemap>\n'

        xml_content += '</sitemapindex>'
        return xml_content

    @staticmethod
    def get_sitemap_stats():
        """
        Retourne des statistiques sur les sitemaps
        """
        stats = {
            'total_urls': 0,
            'by_type': {},
            'last_generated': datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S'),
        }

        sitemaps = get_active_sitemaps()

        for name, sitemap in sitemaps.items():
            try:
                if hasattr(sitemap, 'items'):
                    items = sitemap.items()
                    if hasattr(items, 'count'):
                        count = items.count()
                    else:
                        count = len(items)
                    stats['by_type'][name] = count
                    stats['total_urls'] += count
                else:
                    stats['by_type'][name] = 0
            except Exception as e:
                stats['by_type'][name] = f"Error: {str(e)[:50]}"

        return stats

    @staticmethod
    def validate_sitemap_urls():
        """
        Valide que toutes les URLs du sitemap sont valides
        """
        from django.urls import resolve, Resolver404

        sitemaps = get_active_sitemaps()
        validation_results = []

        for name, sitemap in sitemaps.items():
            if hasattr(sitemap, 'items'):
                items = sitemap.items()[:5]  # Tester seulement les 5 premiers

                for item in items:
                    try:
                        url = sitemap.location(item)

                        # Tester la résolution de l'URL
                        try:
                            resolve(url)
                            url_valid = True
                        except Resolver404:
                            url_valid = False

                        validation_results.append({
                            'sitemap': name,
                            'url': url,
                            'item': str(item)[:100],
                            'url_valid': url_valid,
                        })
                    except Exception as e:
                        validation_results.append({
                            'sitemap': name,
                            'url': 'ERROR',
                            'item': str(item)[:100],
                            'error': str(e)[:100],
                        })

        return validation_results


========== colis/migrations/0002_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import django.db.models.deletion
import mptt.fields
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("carriers", "0002_initial"),
        ("colis", "0001_initial"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name="package",
            name="sender",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="sent_packages",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Expéditeur",
            ),
        ),
        migrations.AddField(
            model_name="packagecategory",
            name="parent",
            field=mptt.fields.TreeForeignKey(
                blank=True,
                help_text="Sélectionnez une catégorie parente si applicable",
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="children",
                to="colis.packagecategory",
                verbose_name="Catégorie parente",
            ),
        ),
        migrations.AddField(
            model_name="package",
            name="category",
            field=mptt.fields.TreeForeignKey(
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="packages",
                to="colis.packagecategory",
                verbose_name="Catégorie",
            ),
        ),
        migrations.AddField(
            model_name="packagefavorite",
            name="package",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="favorited_by",
                to="colis.package",
                verbose_name="Colis",
            ),
        ),
        migrations.AddField(
            model_name="packagefavorite",
            name="user",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="package_favorites",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="packageimage",
            name="package",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="images",
                to="colis.package",
                verbose_name="Colis",
            ),
        ),
        migrations.AddField(
            model_name="packagereport",
            name="package",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="reports",
                to="colis.package",
                verbose_name="Colis",
            ),
        ),
        migrations.AddField(
            model_name="packagereport",
            name="reporter",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="package_reports",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Signaleur",
            ),
        ),
        migrations.AddField(
            model_name="packagereport",
            name="resolved_by",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="resolved_package_reports",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Résolu par",
            ),
        ),
        migrations.AddField(
            model_name="packageview",
            name="package",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="views_tracking",
                to="colis.package",
                verbose_name="Colis",
            ),
        ),
        migrations.AddField(
            model_name="packageview",
            name="user",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="package_views",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="transportoffer",
            name="carrier",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="transport_offers",
                to="carriers.carrier",
                verbose_name="Transporteur",
            ),
        ),
        migrations.AddField(
            model_name="transportoffer",
            name="package",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="transport_offers",
                to="colis.package",
                verbose_name="Colis",
            ),
        ),
        migrations.AddIndex(
            model_name="packagecategory",
            index=models.Index(
                fields=["slug", "is_active"], name="colis_packa_slug_606730_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="packagecategory",
            index=models.Index(
                fields=["parent", "is_active"], name="colis_packa_parent__f4d408_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="packagecategory",
            index=models.Index(
                fields=["tree_id", "lft"], name="colis_packagecategory_treef25a"
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["status", "created_at"], name="colis_packa_status_6b831c_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["sender", "status"], name="colis_packa_sender__0df8ca_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["pickup_country", "delivery_country"],
                name="colis_packa_pickup__0f1de9_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["pickup_date", "delivery_date"],
                name="colis_packa_pickup__5ccd61_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["package_type", "status"], name="colis_packa_package_18febe_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["asking_price", "status"], name="colis_packa_asking__314189_idx"
            ),
        ),
        migrations.AlterUniqueTogether(
            name="packagefavorite",
            unique_together={("user", "package")},
        ),
        migrations.AddConstraint(
            model_name="packageimage",
            constraint=models.UniqueConstraint(
                condition=models.Q(("is_primary", True)),
                fields=("package",),
                name="unique_primary_image_per_package",
            ),
        ),
        migrations.AddIndex(
            model_name="packageview",
            index=models.Index(
                fields=["package", "viewed_at"], name="colis_packa_package_17fa2f_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="packageview",
            index=models.Index(
                fields=["session_key", "package"], name="colis_packa_session_2431f0_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="packageview",
            index=models.Index(
                fields=["user", "viewed_at"], name="colis_packa_user_id_60ad9e_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="transportoffer",
            index=models.Index(
                fields=["package", "status"], name="colis_trans_package_727735_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="transportoffer",
            index=models.Index(
                fields=["carrier", "status"], name="colis_trans_carrier_487e10_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="transportoffer",
            index=models.Index(
                fields=["status", "expires_at"], name="colis_trans_status_3a1514_idx"
            ),
        ),
        migrations.AlterUniqueTogether(
            name="transportoffer",
            unique_together={("package", "carrier")},
        ),
    ]



========== colis/migrations/0001_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import colis.models
import django.core.validators
import django_countries.fields
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name="PackageStatistics",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
            ],
            options={
                "verbose_name": "Statistiques",
                "verbose_name_plural": "Statistiques",
                "managed": False,
            },
        ),
        migrations.CreateModel(
            name="Package",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "title",
                    models.CharField(
                        db_index=True, max_length=200, verbose_name="Titre du colis"
                    ),
                ),
                (
                    "slug",
                    models.SlugField(max_length=200, unique=True, verbose_name="Slug"),
                ),
                (
                    "description",
                    models.TextField(
                        help_text="Décrivez votre colis en détail",
                        verbose_name="Description détaillée",
                    ),
                ),
                (
                    "package_type",
                    models.CharField(
                        choices=[
                            ("SMALL_PACKAGE", "Petit colis (< 30kg)"),
                            ("MEDIUM_PACKAGE", "Colis moyen (30-100kg)"),
                            ("LARGE_PACKAGE", "Gros colis (100-500kg)"),
                            ("FURNITURE", "Meuble"),
                            ("PALLET", "Palette"),
                            ("VEHICLE_PART", "Pièce auto"),
                            ("OTHER", "Autre"),
                        ],
                        max_length=20,
                        verbose_name="Type de colis",
                    ),
                ),
                (
                    "weight",
                    models.DecimalField(
                        decimal_places=3,
                        help_text="Poids en kilogrammes",
                        max_digits=8,
                        verbose_name="Poids (kg)",
                    ),
                ),
                (
                    "length",
                    models.DecimalField(
                        decimal_places=2, max_digits=8, verbose_name="Longueur (cm)"
                    ),
                ),
                (
                    "width",
                    models.DecimalField(
                        decimal_places=2, max_digits=8, verbose_name="Largeur (cm)"
                    ),
                ),
                (
                    "height",
                    models.DecimalField(
                        decimal_places=2, max_digits=8, verbose_name="Hauteur (cm)"
                    ),
                ),
                (
                    "volume",
                    models.DecimalField(
                        blank=True,
                        decimal_places=3,
                        editable=False,
                        max_digits=10,
                        null=True,
                        verbose_name="Volume (L)",
                    ),
                ),
                (
                    "pickup_country",
                    django_countries.fields.CountryField(
                        help_text="Pays où se trouve le colis",
                        max_length=2,
                        verbose_name="Pays de départ",
                    ),
                ),
                (
                    "pickup_city",
                    models.CharField(max_length=100, verbose_name="Ville de départ"),
                ),
                (
                    "pickup_address",
                    models.TextField(blank=True, verbose_name="Adresse de départ"),
                ),
                (
                    "pickup_postal_code",
                    models.CharField(
                        blank=True, max_length=20, verbose_name="Code postal départ"
                    ),
                ),
                (
                    "pickup_latitude",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Latitude départ",
                    ),
                ),
                (
                    "pickup_longitude",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Longitude départ",
                    ),
                ),
                (
                    "delivery_country",
                    django_countries.fields.CountryField(
                        help_text="Pays où le colis doit être livré",
                        max_length=2,
                        verbose_name="Pays de destination",
                    ),
                ),
                (
                    "delivery_city",
                    models.CharField(
                        max_length=100, verbose_name="Ville de destination"
                    ),
                ),
                (
                    "delivery_address",
                    models.TextField(blank=True, verbose_name="Adresse de destination"),
                ),
                (
                    "delivery_postal_code",
                    models.CharField(
                        blank=True,
                        max_length=20,
                        verbose_name="Code postal destination",
                    ),
                ),
                (
                    "delivery_latitude",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Latitude destination",
                    ),
                ),
                (
                    "delivery_longitude",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Longitude destination",
                    ),
                ),
                (
                    "pickup_date",
                    models.DateField(
                        help_text="Date à laquelle le colis est disponible",
                        verbose_name="Date de départ souhaitée",
                    ),
                ),
                (
                    "delivery_date",
                    models.DateField(
                        help_text="Date limite de livraison",
                        verbose_name="Date de livraison souhaitée",
                    ),
                ),
                (
                    "flexible_dates",
                    models.BooleanField(
                        default=False,
                        help_text="Accepte des dates différentes de celles demandées",
                        verbose_name="Dates flexibles",
                    ),
                ),
                (
                    "price_type",
                    models.CharField(
                        choices=[
                            ("FIXED", "Prix fixe"),
                            ("NEGOTIABLE", "Prix négociable"),
                            ("AUCTION", "Mise aux enchères"),
                        ],
                        default="NEGOTIABLE",
                        max_length=20,
                        verbose_name="Type de prix",
                    ),
                ),
                (
                    "asking_price",
                    models.DecimalField(
                        decimal_places=2,
                        help_text="Prix en devise de départ",
                        max_digits=10,
                        verbose_name="Prix demandé",
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                        ],
                        default="EUR",
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "estimated_distance",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        verbose_name="Distance estimée (km)",
                    ),
                ),
                (
                    "is_fragile",
                    models.BooleanField(default=False, verbose_name="Fragile"),
                ),
                (
                    "requires_insurance",
                    models.BooleanField(
                        default=False, verbose_name="Requiert assurance"
                    ),
                ),
                (
                    "insurance_value",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        verbose_name="Valeur à assurer",
                    ),
                ),
                (
                    "requires_packaging",
                    models.BooleanField(
                        default=False, verbose_name="Requiert emballage"
                    ),
                ),
                (
                    "requires_loading_help",
                    models.BooleanField(
                        default=False, verbose_name="Requiert aide au chargement"
                    ),
                ),
                (
                    "requires_unloading_help",
                    models.BooleanField(
                        default=False, verbose_name="Requiert aide au déchargement"
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("DRAFT", "Brouillon"),
                            ("AVAILABLE", "Disponible"),
                            ("RESERVED", "Réservé"),
                            ("IN_TRANSIT", "En transit"),
                            ("DELIVERED", "Livré"),
                            ("CANCELLED", "Annulé"),
                            ("EXPIRED", "Expiré"),
                        ],
                        db_index=True,
                        default="DRAFT",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "is_featured",
                    models.BooleanField(default=False, verbose_name="Colis en vedette"),
                ),
                (
                    "featured_until",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="En vedette jusqu'au"
                    ),
                ),
                (
                    "meta_keywords",
                    models.CharField(
                        blank=True, max_length=500, verbose_name="Mots-clés SEO"
                    ),
                ),
                (
                    "meta_description",
                    models.TextField(blank=True, verbose_name="Description SEO"),
                ),
                (
                    "view_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre de vues"
                    ),
                ),
                (
                    "offer_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre d'offres"
                    ),
                ),
                (
                    "favorite_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre de favoris"
                    ),
                ),
                (
                    "free_images_allowed",
                    models.PositiveIntegerField(
                        default=5, verbose_name="Nombre de photos gratuites"
                    ),
                ),
                (
                    "paid_images_used",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Photos payantes utilisées"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True, db_index=True)),
                ("published_at", models.DateTimeField(blank=True, null=True)),
                ("expired_at", models.DateTimeField(blank=True, null=True)),
                ("reserved_at", models.DateTimeField(blank=True, null=True)),
                ("delivered_at", models.DateTimeField(blank=True, null=True)),
            ],
            options={
                "verbose_name": "Colis",
                "verbose_name_plural": "Colis",
                "ordering": ["-created_at"],
                "permissions": [
                    ("can_feature_package", "Peut mettre en vedette un colis"),
                    ("can_moderate_package", "Peut modérer les colis"),
                ],
            },
        ),
        migrations.CreateModel(
            name="PackageCategory",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "name",
                    models.CharField(
                        db_index=True,
                        max_length=200,
                        verbose_name="Nom de la catégorie",
                    ),
                ),
                (
                    "slug",
                    models.SlugField(
                        help_text="Version URL-friendly du nom",
                        max_length=200,
                        unique=True,
                        verbose_name="Slug",
                    ),
                ),
                (
                    "description",
                    models.TextField(
                        blank=True,
                        help_text="Description détaillée de la catégorie",
                        verbose_name="Description",
                    ),
                ),
                (
                    "icon",
                    models.CharField(
                        blank=True,
                        help_text="Exemple: fa-box, fa-couch, fa-tshirt",
                        max_length=100,
                        verbose_name="Icône FontAwesome",
                    ),
                ),
                (
                    "image",
                    models.ImageField(
                        blank=True,
                        null=True,
                        upload_to="colis/categories/",
                        verbose_name="Image de la catégorie",
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(
                        default=True,
                        help_text="Désactiver pour cacher la catégorie",
                        verbose_name="Active",
                    ),
                ),
                (
                    "show_in_menu",
                    models.BooleanField(
                        default=True, verbose_name="Afficher dans le menu"
                    ),
                ),
                (
                    "display_order",
                    models.PositiveIntegerField(
                        default=0,
                        help_text="Plus le nombre est bas, plus c'est prioritaire",
                        verbose_name="Ordre d'affichage",
                    ),
                ),
                (
                    "requires_dimensions",
                    models.BooleanField(
                        default=True,
                        help_text="Les colis de cette catégorie doivent avoir des dimensions",
                        verbose_name="Requiert dimensions",
                    ),
                ),
                (
                    "requires_weight",
                    models.BooleanField(
                        default=True,
                        help_text="Les colis de cette catégorie doivent avoir un poids",
                        verbose_name="Requiert poids",
                    ),
                ),
                (
                    "meta_title",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Titre SEO"
                    ),
                ),
                (
                    "meta_description",
                    models.TextField(blank=True, verbose_name="Description SEO"),
                ),
                (
                    "package_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre de colis"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("lft", models.PositiveIntegerField(editable=False)),
                ("rght", models.PositiveIntegerField(editable=False)),
                ("tree_id", models.PositiveIntegerField(db_index=True, editable=False)),
                ("level", models.PositiveIntegerField(editable=False)),
            ],
            options={
                "verbose_name": "Catégorie de colis",
                "verbose_name_plural": "Catégories de colis",
                "ordering": ["display_order", "name"],
            },
        ),
        migrations.CreateModel(
            name="PackageFavorite",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Colis favori",
                "verbose_name_plural": "Colis favoris",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="PackageImage",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "image",
                    models.ImageField(
                        upload_to=colis.models.package_image_upload_path,
                        validators=[
                            django.core.validators.FileExtensionValidator(
                                ["jpg", "jpeg", "png", "webp"]
                            ),
                            colis.models.validate_file_size,
                        ],
                        verbose_name="Image",
                    ),
                ),
                (
                    "thumbnail",
                    models.ImageField(
                        blank=True,
                        editable=False,
                        null=True,
                        upload_to="colis/thumbnails/",
                        verbose_name="Miniature",
                    ),
                ),
                (
                    "caption",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Légende"
                    ),
                ),
                (
                    "is_primary",
                    models.BooleanField(default=False, verbose_name="Image principale"),
                ),
                (
                    "display_order",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Ordre d'affichage"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Image de colis",
                "verbose_name_plural": "Images de colis",
                "ordering": ["is_primary", "display_order", "created_at"],
            },
        ),
        migrations.CreateModel(
            name="PackageReport",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "reason",
                    models.CharField(
                        choices=[
                            ("SPAM", "Spam ou publicité"),
                            ("FRAUD", "Fraude ou arnaque"),
                            ("INAPPROPRIATE", "Contenu inapproprié"),
                            ("WRONG_CATEGORY", "Mauvaise catégorie"),
                            ("PROHIBITED", "Article prohibé"),
                            ("DUPLICATE", "Colis en double"),
                            ("OTHER", "Autre"),
                        ],
                        max_length=20,
                        verbose_name="Raison du signalement",
                    ),
                ),
                (
                    "description",
                    models.TextField(blank=True, verbose_name="Description détaillée"),
                ),
                (
                    "evidence",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="colis/reports/",
                        verbose_name="Preuve",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("IN_REVIEW", "En revue"),
                            ("RESOLVED", "Résolu"),
                            ("DISMISSED", "Rejeté"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "admin_notes",
                    models.TextField(
                        blank=True, verbose_name="Notes de l'administrateur"
                    ),
                ),
                (
                    "resolved_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Résolu le"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Signalement de colis",
                "verbose_name_plural": "Signalements de colis",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="PackageView",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "session_key",
                    models.CharField(
                        db_index=True, max_length=40, verbose_name="Clé de session"
                    ),
                ),
                (
                    "ip_address",
                    models.GenericIPAddressField(
                        blank=True, null=True, verbose_name="Adresse IP"
                    ),
                ),
                ("user_agent", models.TextField(blank=True, verbose_name="User Agent")),
                ("referer", models.URLField(blank=True, verbose_name="Referer")),
                ("viewed_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Vue de colis",
                "verbose_name_plural": "Vues de colis",
            },
        ),
        migrations.CreateModel(
            name="TransportOffer",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "price",
                    models.DecimalField(
                        decimal_places=2, max_digits=10, verbose_name="Prix proposé"
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                        ],
                        default="EUR",
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "proposed_pickup_date",
                    models.DateField(verbose_name="Date de départ proposée"),
                ),
                (
                    "proposed_delivery_date",
                    models.DateField(verbose_name="Date de livraison proposée"),
                ),
                (
                    "message",
                    models.TextField(
                        blank=True,
                        help_text="Expliquez pourquoi vous êtes le bon transporteur",
                        verbose_name="Message au vendeur",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("ACCEPTED", "Acceptée"),
                            ("REJECTED", "Rejetée"),
                            ("CANCELLED", "Annulée"),
                            ("EXPIRED", "Expirée"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "provides_insurance",
                    models.BooleanField(
                        default=False, verbose_name="Fournit assurance"
                    ),
                ),
                (
                    "insurance_coverage",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        verbose_name="Couverture d'assurance",
                    ),
                ),
                (
                    "provides_packaging",
                    models.BooleanField(
                        default=False, verbose_name="Fournit emballage"
                    ),
                ),
                (
                    "provides_loading",
                    models.BooleanField(
                        default=False, verbose_name="Fournit chargement"
                    ),
                ),
                (
                    "provides_unloading",
                    models.BooleanField(
                        default=False, verbose_name="Fournit déchargement"
                    ),
                ),
                (
                    "rejection_reason",
                    models.TextField(blank=True, verbose_name="Raison du refus"),
                ),
                (
                    "accepted_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Accepté le"
                    ),
                ),
                (
                    "expires_at",
                    models.DateTimeField(
                        help_text="Date d'expiration de l'offre",
                        verbose_name="Expire le",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Offre de transport",
                "verbose_name_plural": "Offres de transport",
                "ordering": ["-created_at"],
            },
        ),
    ]



========== colis/migrations/__init__.py ==========



========== colis/tests.py ==========
from django.test import TestCase

# Create your tests here.



========== colis/signals.py ==========
# ~/ebi3/colis/signals.py
from django.db.models.signals import post_save, pre_save, post_delete, pre_delete, m2m_changed
from django.dispatch import receiver
from django.utils import timezone
from django.core.mail import send_mail
from django.template.loader import render_to_string
from django.conf import settings
from django.db import transaction
from django.utils.translation import gettext_lazy as _
import logging

from .models import (
    Package, PackageCategory, PackageImage,
    TransportOffer, PackageView, PackageFavorite,
    PackageReport
)
from users.models import User
from carriers.models import Carrier, CarrierNotification
from .utils.signal_helpers import create_conversation_for_offer
from messaging.models import Conversation, Message

logger = logging.getLogger(__name__)


@receiver(post_save, sender=Offer)
def handle_offer_save(sender, instance, created, **kwargs):
    """Gère la sauvegarde d'une offre"""
    if created:
        logger.info(f"Nouvelle offre créée: {instance.id}")

        # Créer une conversation en utilisant la fonction utilitaire
        conversation = create_conversation_for_offer(instance)
        if conversation:
            logger.info(f"Conversation créée: {conversation.id}")

# ============================================================================
# SIGNALS PACKAGE (COLIS)
# ============================================================================

@receiver(pre_save, sender=Package)
def update_package_status_dates(sender, instance, **kwargs):
    """
    Met à jour les dates automatiquement lors des changements de statut
    et calcule le volume automatiquement.
    """
    if instance.pk:
        try:
            old_instance = Package.objects.get(pk=instance.pk)

            # Calcul automatique du volume
            if instance.length and instance.width and instance.height:
                instance.volume = (instance.length * instance.width * instance.height) / 1000

            # Mise à jour des dates de statut
            if instance.status != old_instance.status:
                if instance.status == Package.Status.AVAILABLE and not instance.published_at:
                    instance.published_at = timezone.now()
                    logger.info(f"Package {instance.id} marked as AVAILABLE")

                elif instance.status == Package.Status.RESERVED and not instance.reserved_at:
                    instance.reserved_at = timezone.now()
                    logger.info(f"Package {instance.id} marked as RESERVED")

                elif instance.status == Package.Status.IN_TRANSIT and not instance.in_transit_at:
                    instance.in_transit_at = timezone.now()
                    logger.info(f"Package {instance.id} marked as IN_TRANSIT")

                elif instance.status == Package.Status.DELIVERED and not instance.delivered_at:
                    instance.delivered_at = timezone.now()
                    logger.info(f"Package {instance.id} marked as DELIVERED")

                elif instance.status == Package.Status.EXPIRED and not instance.expired_at:
                    instance.expired_at = timezone.now()
                    logger.info(f"Package {instance.id} marked as EXPIRED")

            # Vérification d'expiration automatique
            if (instance.status == Package.Status.AVAILABLE and
                instance.delivery_date and
                instance.delivery_date < timezone.now().date()):
                instance.status = Package.Status.EXPIRED
                instance.expired_at = timezone.now()
                logger.info(f"Package {instance.id} auto-expired")

        except Package.DoesNotExist:
            pass  # Nouvelle instance, pas d'ancienne version


@receiver(post_save, sender=Package)
def update_category_count(sender, instance, created, **kwargs):
    """
    Met à jour le compteur de colis dans la catégorie
    """
    if instance.category:
        try:
            instance.category.update_package_count()
            logger.debug(f"Updated package count for category {instance.category.id}")
        except Exception as e:
            logger.error(f"Error updating category count: {e}")


@receiver(post_save, sender=Package)
def notify_package_status_change(sender, instance, created, **kwargs):
    """
    Envoie des notifications lors des changements de statut d'un colis
    """
    if not created:  # Seulement pour les mises à jour
        try:
            from .tasks import send_package_status_notification
            send_package_status_notification.delay(instance.id)
            logger.info(f"Queued status notification for package {instance.id}")
        except Exception as e:
            logger.error(f"Error queuing status notification: {e}")


@receiver(pre_delete, sender=Package)
def cleanup_package_files(sender, instance, **kwargs):
    """
    Nettoie les fichiers associés à un colis avant suppression
    """
    try:
        # Supprimer les images (géré par django-cleanup)
        for image in instance.images.all():
            image.delete()

        logger.info(f"Cleaned up files for package {instance.id}")
    except Exception as e:
        logger.error(f"Error cleaning package files: {e}")


# ============================================================================
# SIGNALS PACKAGE IMAGE
# ============================================================================

@receiver(pre_save, sender=PackageImage)
def set_primary_image(sender, instance, **kwargs):
    """
    S'assure qu'il y a toujours une image principale
    et qu'il n'y en a qu'une seule
    """
    if not instance.pk:  # Nouvelle image
        # Si c'est la première image du colis, la marquer comme principale
        if not instance.package.images.exists() and not instance.is_primary:
            instance.is_primary = True

    if instance.is_primary:
        # Désactiver les autres images principales du même colis
        PackageImage.objects.filter(
            package=instance.package,
            is_primary=True
        ).exclude(pk=instance.pk).update(is_primary=False)
        logger.debug(f"Set image {instance.id} as primary for package {instance.package.id}")


@receiver(post_save, sender=PackageImage)
def update_package_image_count(sender, instance, created, **kwargs):
    """
    Met à jour le compteur d'images payantes utilisées
    """
    if created and instance.is_paid and instance.payment_status == 'PAID':
        try:
            package = instance.package
            package.paid_images_used = package.images.filter(
                is_paid=True,
                payment_status='PAID'
            ).count()
            package.save(update_fields=['paid_images_used'])
            logger.debug(f"Updated paid images count for package {package.id}")
        except Exception as e:
            logger.error(f"Error updating paid images count: {e}")


# ============================================================================
# SIGNALS TRANSPORT OFFER (OFFRES DE TRANSPORT)
# ============================================================================

@receiver(pre_save, sender=TransportOffer)
def set_offer_expiry(sender, instance, **kwargs):
    """
    Définit la date d'expiration d'une offre si elle n'est pas déjà définie
    """
    if not instance.expires_at:
        # Par défaut, une offre expire dans 72h
        instance.expires_at = timezone.now() + timezone.timedelta(hours=72)
        logger.debug(f"Set expiry date for offer {instance.id}")


@receiver(pre_save, sender=TransportOffer)
def validate_offer_status(sender, instance, **kwargs):
    """
    Valide les transitions de statut d'une offre
    """
    if instance.pk:
        try:
            old_instance = TransportOffer.objects.get(pk=instance.pk)

            # Vérifier que l'offre n'est pas déjà expirée
            if old_instance.is_expired() and instance.status == TransportOffer.Status.PENDING:
                instance.status = TransportOffer.Status.EXPIRED
                logger.warning(f"Offer {instance.id} auto-expired")

            # Marquer la date d'acceptation
            if (instance.status == TransportOffer.Status.ACCEPTED and
                old_instance.status != TransportOffer.Status.ACCEPTED):
                instance.accepted_at = timezone.now()
                logger.info(f"Offer {instance.id} accepted at {instance.accepted_at}")

        except TransportOffer.DoesNotExist:
            pass


@receiver(post_save, sender=TransportOffer)
def handle_accepted_offer(sender, instance, created, **kwargs):
    """
    Gère les actions lorsqu'une offre est acceptée
    """
    if instance.status == TransportOffer.Status.ACCEPTED:
        with transaction.atomic():
            try:
                # Mettre à jour le statut du colis
                package = instance.package
                package.status = Package.Status.RESERVED
                package.reserved_at = timezone.now()
                package.save(update_fields=['status', 'reserved_at'])

                # Rejeter automatiquement les autres offres en attente
                TransportOffer.objects.filter(
                    package=package,
                    status=TransportOffer.Status.PENDING
                ).exclude(pk=instance.pk).update(
                    status=TransportOffer.Status.REJECTED,
                    rejection_reason=_("Une autre offre a été acceptée")
                )

                # Créer une conversation entre les parties
                create_conversation_for_accepted_offer(instance)

                # Envoyer des notifications
                send_offer_accepted_notifications(instance)

                logger.info(f"Offer {instance.id} accepted, package {package.id} reserved")

            except Exception as e:
                logger.error(f"Error handling accepted offer {instance.id}: {e}")


def create_conversation_for_accepted_offer(offer):
    """
    Crée une conversation entre l'expéditeur et le transporteur
    lorsqu'une offre est acceptée
    """
    try:
        conversation, created = Conversation.objects.get_or_create(
            participant_a=offer.package.sender,
            participant_b=offer.carrier.user,
            defaults={
                'subject': f"Colis accepté: {offer.package.title}",
                'last_message_at': timezone.now()
            }
        )

        if created or not conversation.messages.exists():
            Message.objects.create(
                conversation=conversation,
                sender=offer.package.sender,
                content=_(
                    "Bonjour, j'ai accepté votre offre de {price}€ pour le transport de mon colis. "
                    "Nous pouvons maintenant organiser les détails du transport."
                ).format(price=offer.price)
            )

        logger.debug(f"Created conversation for accepted offer {offer.id}")

    except Exception as e:
        logger.error(f"Error creating conversation for offer {offer.id}: {e}")


def send_offer_accepted_notifications(offer):
    """
    Envoie des notifications par email lorsque une offre est acceptée
    """
    try:
        # Notification au transporteur
        subject_to_carrier = _("Votre offre a été acceptée !")
        message_to_carrier = render_to_string('colis/email/offer_accepted_carrier.html', {
            'offer': offer,
            'package': offer.package,
        })

        send_mail(
            subject_to_carrier,
            message_to_carrier,
            settings.DEFAULT_FROM_EMAIL,
            [offer.carrier.user.email],
            html_message=message_to_carrier,
            fail_silently=True
        )

        # Notification à l'expéditeur
        subject_to_sender = _("Vous avez accepté une offre")
        message_to_sender = render_to_string('colis/email/offer_accepted_sender.html', {
            'offer': offer,
            'package': offer.package,
        })

        send_mail(
            subject_to_sender,
            message_to_sender,
            settings.DEFAULT_FROM_EMAIL,
            [offer.package.sender.email],
            html_message=message_to_sender,
            fail_silently=True
        )

        logger.info(f"Sent acceptance notifications for offer {offer.id}")

    except Exception as e:
        logger.error(f"Error sending acceptance notifications: {e}")


@receiver(post_save, sender=TransportOffer)
def notify_new_offer(sender, instance, created, **kwargs):
    """
    Envoie une notification lorsqu'une nouvelle offre est créée
    """
    if created:
        try:
            from .tasks import send_new_offer_notification
            send_new_offer_notification.delay(instance.id)
            logger.info(f"Queued new offer notification for package {instance.package.id}")
        except Exception as e:
            logger.error(f"Error queuing new offer notification: {e}")


@receiver(post_save, sender=TransportOffer)
def update_package_offer_count(sender, instance, created, **kwargs):
    """
    Met à jour le compteur d'offres du colis
    """
    try:
        package = instance.package
        package.offer_count = TransportOffer.objects.filter(package=package).count()
        package.save(update_fields=['offer_count'])
        logger.debug(f"Updated offer count for package {package.id}")
    except Exception as e:
        logger.error(f"Error updating offer count: {e}")


# ============================================================================
# SIGNALS PACKAGE VIEW (VUES)
# ============================================================================

@receiver(post_save, sender=PackageView)
def update_package_view_count(sender, instance, created, **kwargs):
    """
    Met à jour le compteur de vues d'un colis
    """
    if created:
        try:
            package = instance.package
            package.view_count = PackageView.objects.filter(package=package).count()
            package.save(update_fields=['view_count'])
            logger.debug(f"Updated view count for package {package.id}")
        except Exception as e:
            logger.error(f"Error updating view count: {e}")


# ============================================================================
# SIGNALS PACKAGE FAVORITE (FAVORIS)
# ============================================================================

@receiver(post_save, sender=PackageFavorite)
def update_package_favorite_count_on_save(sender, instance, created, **kwargs):
    """
    Met à jour le compteur de favoris d'un colis lors de l'ajout
    """
    if created:
        try:
            package = instance.package
            package.favorite_count = PackageFavorite.objects.filter(package=package).count()
            package.save(update_fields=['favorite_count'])
            logger.debug(f"Updated favorite count for package {package.id} on save")
        except Exception as e:
            logger.error(f"Error updating favorite count on save: {e}")


@receiver(post_delete, sender=PackageFavorite)
def update_package_favorite_count_on_delete(sender, instance, **kwargs):
    """
    Met à jour le compteur de favoris d'un colis lors de la suppression
    """
    try:
        package = instance.package
        package.favorite_count = PackageFavorite.objects.filter(package=package).count()
        package.save(update_fields=['favorite_count'])
        logger.debug(f"Updated favorite count for package {package.id} on delete")
    except Exception as e:
        logger.error(f"Error updating favorite count on delete: {e}")


# ============================================================================
# SIGNALS PACKAGE REPORT (SIGNALEMENTS)
# ============================================================================

@receiver(post_save, sender=PackageReport)
def handle_new_report(sender, instance, created, **kwargs):
    """
    Gère les nouveaux signalements
    """
    if created:
        try:
            # Envoyer une notification à l'admin
            subject = _("Nouveau signalement de colis")
            message = render_to_string('colis/email/new_report.html', {
                'report': instance,
                'package': instance.package,
            })

            send_mail(
                subject,
                message,
                settings.DEFAULT_FROM_EMAIL,
                [settings.ADMIN_EMAIL],
                html_message=message,
                fail_silently=True
            )

            logger.info(f"New report {instance.id} created, notification sent to admin")

            # Créer une notification pour l'équipe de modération
            if hasattr(settings, 'MODERATION_TEAM_EMAILS'):
                for email in settings.MODERATION_TEAM_EMAILS:
                    send_mail(
                        subject,
                        message,
                        settings.DEFAULT_FROM_EMAIL,
                        [email],
                        html_message=message,
                        fail_silently=True
                    )

        except Exception as e:
            logger.error(f"Error handling new report {instance.id}: {e}")


@receiver(pre_save, sender=PackageReport)
def update_report_resolution(sender, instance, **kwargs):
    """
    Met à jour les dates de résolution des signalements
    """
    if instance.pk:
        try:
            old_instance = PackageReport.objects.get(pk=instance.pk)

            # Si le statut passe à résolu ou rejeté
            if (instance.status in ['RESOLVED', 'DISMISSED'] and
                old_instance.status not in ['RESOLVED', 'DISMISSED']):
                instance.resolved_at = timezone.now()
                logger.info(f"Report {instance.id} resolved at {instance.resolved_at}")

        except PackageReport.DoesNotExist:
            pass


# ============================================================================
# SIGNALS PACKAGE CATEGORY (CATÉGORIES)
# ============================================================================

@receiver(pre_save, sender=PackageCategory)
def generate_category_slug(sender, instance, **kwargs):
    """
    Génère automatiquement le slug d'une catégorie si vide
    """
    if not instance.slug and instance.name:
        from django.utils.text import slugify
        instance.slug = slugify(instance.name)
        logger.debug(f"Generated slug for category: {instance.slug}")


@receiver(post_save, sender=PackageCategory)
def invalidate_category_cache(sender, instance, **kwargs):
    """
    Invalide le cache des catégories après modification
    """
    try:
        from django.core.cache import cache
        cache_keys = [
            'package_categories_menu',
            'package_categories_all',
            f'package_category_{instance.slug}'
        ]
        for key in cache_keys:
            cache.delete(key)
        logger.debug(f"Invalidated cache for category {instance.id}")
    except Exception as e:
        logger.error(f"Error invalidating category cache: {e}")


# ============================================================================
# SIGNALS LIÉS AUX UTILISATEURS
# ============================================================================

@receiver(post_save, sender=User)
def create_welcome_package_for_new_user(sender, instance, created, **kwargs):
    """
    Crée un colis d'exemple pour les nouveaux utilisateurs
    (optionnel, pour aider à la découverte)
    """
    if created and settings.CREATE_SAMPLE_PACKAGE_FOR_NEW_USERS:
        try:
            # Attendre un peu pour éviter les problèmes de timing
            import threading
            timer = threading.Timer(
                5.0,  # 5 secondes après la création
                create_sample_package,
                args=[instance]
            )
            timer.start()
            logger.info(f"Scheduled sample package creation for user {instance.id}")

        except Exception as e:
            logger.error(f"Error scheduling sample package: {e}")


def create_sample_package(user):
    """
    Crée un colis d'exemple pour un nouvel utilisateur
    """
    try:
        # Trouver une catégorie par défaut
        from .models import PackageCategory
        default_category = PackageCategory.objects.filter(is_active=True).first()

        if default_category:
            sample_package = Package.objects.create(
                sender=user,
                category=default_category,
                title=_("Exemple de colis - Modèle"),
                description=_(
                    "Ceci est un exemple de colis pour vous montrer comment remplir votre annonce. "
                    "Vous pouvez le modifier ou le supprimer à tout moment.\n\n"
                    "Conseils :\n"
                    "• Donnez un titre clair et descriptif\n"
                    "• Indiquez toutes les dimensions et le poids\n"
                    "• Prenez des photos de bonne qualité\n"
                    "• Soyez précis sur les dates de disponibilité"
                ),
                package_type=Package.PackageType.SMALL_PACKAGE,
                weight=10.5,
                length=40,
                width=30,
                height=20,
                pickup_country='FR',
                pickup_city=_("Paris"),
                delivery_country='FR',
                delivery_city=_("Lyon"),
                pickup_date=timezone.now().date() + timezone.timedelta(days=7),
                delivery_date=timezone.now().date() + timezone.timedelta(days=14),
                price_type=Package.PriceType.NEGOTIABLE,
                asking_price=50.00,
                currency='EUR',
                status=Package.Status.DRAFT,
                is_featured=False
            )

            logger.info(f"Created sample package {sample_package.id} for user {user.id}")

    except Exception as e:
        logger.error(f"Error creating sample package: {e}")


# ============================================================================
# SIGNALS DE NETTOYAGE AUTOMATIQUE
# ============================================================================

@receiver(pre_save, sender=TransportOffer)
def cleanup_expired_offers(sender, instance, **kwargs):
    """
    Nettoie automatiquement les offres expirées
    """
    if instance.is_expired() and instance.status == TransportOffer.Status.PENDING:
        instance.status = TransportOffer.Status.EXPIRED
        logger.info(f"Auto-expired offer {instance.id}")


# ============================================================================
# SIGNALS DE SYNCHRONISATION AVEC L'APP CARRIERS
# ============================================================================

@receiver(post_save, sender=Carrier)
def update_carrier_availability(sender, instance, **kwargs):
    """
    Met à jour la disponibilité des offres lorsqu'un transporteur change de statut
    """
    if instance.status != Carrier.Status.APPROVED or not instance.is_available:
        try:
            # Marquer toutes les offres en attente comme expirées
            expired_count = TransportOffer.objects.filter(
                carrier=instance,
                status=TransportOffer.Status.PENDING
            ).update(status=TransportOffer.Status.EXPIRED)

            if expired_count > 0:
                logger.info(f"Expired {expired_count} offers for carrier {instance.id}")

        except Exception as e:
            logger.error(f"Error updating carrier offers: {e}")


# ============================================================================
# SIGNALS POUR LES STATISTIQUES
# ============================================================================

@receiver(post_save, sender=Package)
@receiver(post_save, sender=TransportOffer)
@receiver(post_save, sender=PackageView)
@receiver(post_save, sender=PackageFavorite)
def invalidate_statistics_cache(sender, instance, **kwargs):
    """
    Invalide le cache des statistiques après modification des données
    """
    try:
        from django.core.cache import cache
        cache.delete_pattern('stats_*')
        cache.delete('dashboard_stats')
        logger.debug("Invalidated statistics cache")
    except Exception as e:
        logger.error(f"Error invalidating statistics cache: {e}")


# ============================================================================
# CONNEXION DES SIGNALS
# ============================================================================

def connect_signals():
    """
    Connecte tous les signaux (appelé dans apps.py)
    """
    # Les signaux sont automatiquement connectés via les décorateurs @receiver
    # Cette fonction est utile pour une connexion explicite si nécessaire
    pass


def disconnect_signals():
    """
    Déconnecte tous les signaux (pour les tests)
    """
    from django.db.models.signals import post_save, pre_save, post_delete, pre_delete

    # Déconnecter tous les signaux liés aux modèles de colis
    models = [Package, PackageImage, TransportOffer, PackageView,
              PackageFavorite, PackageReport, PackageCategory]

    for model in models:
        post_save.disconnect(receiver=None, sender=model)
        pre_save.disconnect(receiver=None, sender=model)
        post_delete.disconnect(receiver=None, sender=model)
        pre_delete.disconnect(receiver=None, sender=model)

    logger.info("Disconnected all colis signals")


========== colis/templatetags/colis_extras.py ==========
# ~/ebi3/colis/templatetags/colis_extras.py
from django import template
from colis.models import Package

register = template.Library()

@register.simple_tag
def get_recent_packages(limit=4):
    """Retourne les derniers colis disponibles"""
    try:
        return Package.objects.filter(
            status=Package.Status.AVAILABLE
        ).select_related('sender', 'category').prefetch_related('images')[:limit]
    except Exception:
        return Package.objects.none()

# ~/ebi3/colis/templatetags/__init__.py
# Ce fichier peut être vide, il sert juste à indiquer que c'est un package Python


========== colis/templatetags/__init__.py ==========



========== colis/admin.py ==========
# ~/ebi3/colis/admin.py
from django.contrib import admin
from django.utils import timezone
from django.utils.html import format_html
from django.utils.translation import gettext_lazy as _
from django.contrib import messages
from django.urls import reverse, path
from django.http import HttpResponseRedirect
from django.db.models import Count, Avg, Sum, Q
from django.db import models
import csv
from django.http import HttpResponse

from .models import (
    Package, PackageCategory, PackageImage,
    TransportOffer, PackageView, PackageFavorite, PackageReport
)


@admin.register(PackageCategory)
class PackageCategoryAdmin(admin.ModelAdmin):
    """Administration des catégories de colis"""

    # ✅ CORRECTION : actions doit être une LISTE de noms de méthodes
    actions = ['activate_categories', 'deactivate_categories', 'show_in_menu_action', 'hide_from_menu_action']

    list_display = ('name', 'parent', 'is_active', 'show_in_menu', 'package_count', 'display_order')
    list_filter = ('is_active', 'show_in_menu', 'created_at')
    search_fields = ('name', 'description', 'slug')
    prepopulated_fields = {'slug': ('name',)}
    readonly_fields = ('created_at', 'updated_at', 'package_count')

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('name', 'slug', 'parent', 'description')
        }),
        (_('Apparence'), {
            'fields': ('icon', 'image', 'display_order')
        }),
        (_('Visibilité'), {
            'fields': ('is_active', 'show_in_menu')
        }),
        (_('Configuration des colis'), {
            'fields': ('requires_dimensions', 'requires_weight')
        }),
        (_('SEO'), {
            'fields': ('meta_title', 'meta_description')
        }),
        (_('Statistiques'), {
            'fields': ('package_count', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ Les méthodes d'action doivent être séparées de la liste 'actions'
    def activate_categories(self, request, queryset):
        """Action pour activer les catégories"""
        updated = queryset.update(is_active=True)
        self.message_user(request, _(f'{updated} catégories ont été activées.'))
    activate_categories.short_description = _('Activer les catégories sélectionnées')

    def deactivate_categories(self, request, queryset):
        """Action pour désactiver les catégories"""
        updated = queryset.update(is_active=False)
        self.message_user(request, _(f'{updated} catégories ont été désactivées.'))
    deactivate_categories.short_description = _('Désactiver les catégories sélectionnées')

    def show_in_menu_action(self, request, queryset):
        """Action pour afficher dans le menu"""
        updated = queryset.update(show_in_menu=True)
        self.message_user(request, _(f'{updated} catégories sont maintenant visibles dans le menu.'))
    show_in_menu_action.short_description = _('Afficher dans le menu')

    def hide_from_menu_action(self, request, queryset):
        """Action pour cacher du menu"""
        updated = queryset.update(show_in_menu=False)
        self.message_user(request, _(f'{updated} catégories sont maintenant cachées du menu.'))
    hide_from_menu_action.short_description = _('Cacher du menu')

    def get_queryset(self, request):
        return super().get_queryset(request).prefetch_related('parent')


class PackageImageInline(admin.TabularInline):
    """Inline pour les images de colis"""
    model = PackageImage
    extra = 1
    fields = ('image', 'thumbnail_preview', 'caption', 'is_primary', 'display_order')
    readonly_fields = ('thumbnail_preview',)

    def thumbnail_preview(self, obj):
        if obj.thumbnail:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.thumbnail.url)
        elif obj.image:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.image.url)
        return _("Pas d'image")
    thumbnail_preview.short_description = _('Aperçu')


@admin.register(Package)
class PackageAdmin(admin.ModelAdmin):
    """Administration des colis"""

    inlines = [PackageImageInline]

    list_display = (
        'title', 'sender', 'category', 'package_type_badge',
        'pickup_to_destination', 'weight_volume_display',
        'asking_price_display', 'status_badge', 'is_featured',
        'view_count', 'offer_count', 'created_at'
    )

    list_filter = (
        'status', 'package_type', 'price_type',
        'is_featured', 'created_at', 'category',
        'pickup_country', 'delivery_country'
    )

    search_fields = (
        'title', 'description', 'sender__username',
        'sender__email', 'pickup_city', 'delivery_city'
    )

    readonly_fields = (
        'slug', 'view_count', 'offer_count', 'favorite_count',
        'created_at', 'updated_at', 'published_at', 'expired_at',
        'reserved_at', 'delivered_at', 'volume',
        'paid_images_used', 'estimated_distance'
    )

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('title', 'slug', 'sender', 'category', 'description', 'package_type')
        }),
        (_('Dimensions et poids'), {
            'fields': ('weight', 'length', 'width', 'height', 'volume')
        }),
        (_('Origine'), {
            'fields': ('pickup_country', 'pickup_city', 'pickup_address', 'pickup_postal_code',
                      'pickup_latitude', 'pickup_longitude')
        }),
        (_('Destination'), {
            'fields': ('delivery_country', 'delivery_city', 'delivery_address', 'delivery_postal_code',
                      'delivery_latitude', 'delivery_longitude')
        }),
        (_('Dates'), {
            'fields': ('pickup_date', 'delivery_date', 'flexible_dates')
        }),
        (_('Prix'), {
            'fields': ('price_type', 'asking_price', 'currency', 'estimated_distance')
        }),
        (_('Options'), {
            'fields': ('is_fragile', 'requires_insurance', 'insurance_value',
                      'requires_packaging', 'requires_loading_help', 'requires_unloading_help')
        }),
        (_('Statut et promotion'), {
            'fields': ('status', 'is_featured', 'featured_until')
        }),
        (_('Multimédia'), {
            'fields': ('free_images_allowed', 'paid_images_used'),
            'classes': ('collapse',)
        }),
        (_('SEO'), {
            'fields': ('meta_keywords', 'meta_description'),
            'classes': ('collapse',)
        }),
        (_('Statistiques'), {
            'fields': ('view_count', 'offer_count', 'favorite_count',
                      'created_at', 'updated_at', 'published_at', 'expired_at',
                      'reserved_at', 'delivered_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION IMPORTANTE: actions doit être une LISTE de noms de méthodes
    actions = [
        'mark_as_available', 'mark_as_reserved', 'mark_as_in_transit',
        'mark_as_delivered', 'mark_as_cancelled', 'feature_packages',
        'unfeature_packages', 'export_to_csv', 'calculate_distances'
    ]

    def package_type_badge(self, obj):
        colors = {
            'SMALL_PACKAGE': 'success',
            'MEDIUM_PACKAGE': 'info',
            'LARGE_PACKAGE': 'warning',
            'FURNITURE': 'primary',
            'PALLET': 'secondary',
            'VEHICLE_PART': 'dark',
            'OTHER': 'light'
        }
        color = colors.get(obj.package_type, 'secondary')
        return format_html(
            '<span class="badge bg-{}">{}</span>',
            color, obj.get_package_type_display()
        )
    package_type_badge.short_description = _('Type')
    package_type_badge.admin_order_field = 'package_type'

    def pickup_to_destination(self, obj):
        return format_html(
            '{} → {}',
            obj.pickup_city,
            obj.delivery_city
        )
    pickup_to_destination.short_description = _('Trajet')
    pickup_to_destination.admin_order_field = 'pickup_city'

    def weight_volume_display(self, obj):
        if obj.volume:
            return f"{obj.weight} kg / {obj.volume:.1f} L"
        return f"{obj.weight} kg"
    weight_volume_display.short_description = _('Poids/Volume')

    def asking_price_display(self, obj):
        return f"{obj.asking_price} {obj.get_currency_display()}"
    asking_price_display.short_description = _('Prix')
    asking_price_display.admin_order_field = 'asking_price'

    def status_badge(self, obj):
        status_colors = {
            'DRAFT': 'secondary',
            'AVAILABLE': 'success',
            'RESERVED': 'info',
            'IN_TRANSIT': 'warning',
            'DELIVERED': 'primary',
            'CANCELLED': 'danger',
            'EXPIRED': 'dark'
        }
        color = status_colors.get(obj.status, 'secondary')
        return format_html(
            '<span class="badge bg-{}">{}</span>',
            color, obj.get_status_display()
        )
    status_badge.short_description = _('Statut')

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('sender', 'category')

    # ✅ Les méthodes d'action doivent être définies séparément
    def mark_as_available(self, request, queryset):
        """Action pour marquer comme disponible"""
        updated = queryset.update(status=Package.Status.AVAILABLE)
        self.message_user(request, _(f'{updated} colis ont été marqués comme disponibles.'))
    mark_as_available.short_description = _('Marquer comme disponible')

    def mark_as_reserved(self, request, queryset):
        """Action pour marquer comme réservé"""
        updated = queryset.update(status=Package.Status.RESERVED, reserved_at=timezone.now())
        self.message_user(request, _(f'{updated} colis ont été marqués comme réservés.'))
    mark_as_reserved.short_description = _('Marquer comme réservé')

    def mark_as_in_transit(self, request, queryset):
        """Action pour marquer comme en transit"""
        updated = queryset.update(status=Package.Status.IN_TRANSIT)
        self.message_user(request, _(f'{updated} colis ont été marqués comme en transit.'))
    mark_as_in_transit.short_description = _('Marquer comme en transit')

    def mark_as_delivered(self, request, queryset):
        """Action pour marquer comme livré"""
        updated = queryset.update(
            status=Package.Status.DELIVERED,
            delivered_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} colis ont été marqués comme livrés.'))
    mark_as_delivered.short_description = _('Marquer comme livré')

    def mark_as_cancelled(self, request, queryset):
        """Action pour marquer comme annulé"""
        updated = queryset.update(status=Package.Status.CANCELLED)
        self.message_user(request, _(f'{updated} colis ont été marqués comme annulés.'))
    mark_as_cancelled.short_description = _('Marquer comme annulé')

    def feature_packages(self, request, queryset):
        """Action pour mettre en vedette"""
        updated = queryset.update(
            is_featured=True,
            featured_until=timezone.now() + timezone.timedelta(days=7)
        )
        self.message_user(request, _(f'{updated} colis ont été mis en vedette.'))
    feature_packages.short_description = _('Mettre en vedette')

    def unfeature_packages(self, request, queryset):
        """Action pour retirer de la vedette"""
        updated = queryset.update(is_featured=False, featured_until=None)
        self.message_user(request, _(f'{updated} colis ne sont plus en vedette.'))
    unfeature_packages.short_description = _('Retirer de la vedette')

    def calculate_distances(self, request, queryset):
        """Action pour calculer les distances (à implémenter avec une API)"""
        count = 0
        for package in queryset:
            if not package.estimated_distance:
                # À implémenter avec Google Maps API ou autre
                # package.estimated_distance = calculate_distance(...)
                # package.save()
                count += 1

        if count > 0:
            self.message_user(request, _(f'Distances calculées pour {count} colis.'))
        else:
            self.message_user(request, _('Tous les colis ont déjà une distance calculée.'))
    calculate_distances.short_description = _('Calculer les distances')

    def export_to_csv(self, request, queryset):
        """Action pour exporter en CSV"""
        response = HttpResponse(content_type='text/csv')
        response['Content-Disposition'] = 'attachment; filename="colis.csv"'

        writer = csv.writer(response)
        writer.writerow([
            'ID', 'Titre', 'Expéditeur', 'Catégorie', 'Type',
            'Prix', 'Devise', 'Statut', 'Départ', 'Destination',
            'Poids', 'Volume', 'Vues', 'Offres', 'Date création'
        ])

        for package in queryset:
            writer.writerow([
                package.id, package.title, package.sender.username,
                package.category.name if package.category else '',
                package.get_package_type_display(),
                package.asking_price, package.currency,
                package.get_status_display(),
                f"{package.pickup_city}, {package.pickup_country.name}",
                f"{package.delivery_city}, {package.delivery_country.name}",
                package.weight, package.volume, package.view_count,
                package.offer_count, package.created_at.strftime('%Y-%m-%d %H:%M')
            ])

        return response
    export_to_csv.short_description = _('Exporter en CSV')

    def save_model(self, request, obj, form, change):
        if not obj.pk:
            obj.sender = request.user

        # Si le statut passe à DISPONIBLE et qu'il n'y a pas de date de publication
        if obj.status == Package.Status.AVAILABLE and not obj.published_at:
            obj.published_at = timezone.now()

        # Si le statut passe à RÉSERVÉ
        if obj.status == Package.Status.RESERVED and not obj.reserved_at:
            obj.reserved_at = timezone.now()

        # Si le statut passe à LIVRÉ
        if obj.status == Package.Status.DELIVERED and not obj.delivered_at:
            obj.delivered_at = timezone.now()

        super().save_model(request, obj, form, change)

    # Vue personnalisée pour les statistiques
    def get_urls(self):
        urls = super().get_urls()
        custom_urls = [
            path('statistics/', self.admin_site.admin_view(self.package_statistics_view),
                 name='colis_package_statistics'),
        ]
        return custom_urls + urls

    def package_statistics_view(self, request):
        """Vue personnalisée pour les statistiques des colis"""
        context = self.admin_site.each_context(request)

        # Statistiques générales
        total_packages = Package.objects.count()
        available_packages = Package.objects.filter(status=Package.Status.AVAILABLE).count()
        reserved_packages = Package.objects.filter(status=Package.Status.RESERVED).count()
        delivered_packages = Package.objects.filter(status=Package.Status.DELIVERED).count()

        # Revenus estimés
        revenue_stats = Package.objects.filter(
            status__in=[Package.Status.RESERVED, Package.Status.IN_TRANSIT, Package.Status.DELIVERED]
        ).aggregate(
            total_revenue=Sum('asking_price'),
            avg_price=Avg('asking_price')
        )

        # Statistiques par type
        type_stats = Package.objects.values('package_type').annotate(
            count=Count('id'),
            avg_price=Avg('asking_price')
        ).order_by('-count')

        # Évolution mensuelle
        monthly_stats = Package.objects.extra(
            select={'month': "strftime('%%Y-%%m', created_at)"}
        ).values('month').annotate(
            count=Count('id'),
            total_views=Sum('view_count'),
            total_offers=Sum('offer_count'),
        ).order_by('month')[:12]

        context.update({
            'title': _('Statistiques des colis'),
            'total_packages': total_packages,
            'available_packages': available_packages,
            'reserved_packages': reserved_packages,
            'delivered_packages': delivered_packages,
            'revenue_stats': revenue_stats,
            'type_stats': type_stats,
            'monthly_stats': monthly_stats,
        })

        return render(request, 'admin/colis/package_statistics.html', context)


@admin.register(PackageImage)
class PackageImageAdmin(admin.ModelAdmin):
    """Administration des images de colis"""

    list_display = ('package', 'thumbnail_preview', 'caption', 'is_primary', 'created_at')
    list_filter = ('is_primary', 'created_at')
    search_fields = ('package__title', 'caption')
    readonly_fields = ('created_at',)

    # ✅ CORRECTION: actions doit être une liste vide si pas d'actions
    actions = []

    def thumbnail_preview(self, obj):
        if obj.thumbnail:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.thumbnail.url)
        elif obj.image:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.image.url)
        return _("Pas d'image")
    thumbnail_preview.short_description = _('Aperçu')

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('package')


@admin.register(TransportOffer)
class TransportOfferAdmin(admin.ModelAdmin):
    """Administration des offres de transport"""

    list_display = (
        'id', 'package_link', 'carrier_link',
        'price_display', 'status_badge',
        'dates_display', 'created_at'
    )

    list_filter = ('status', 'created_at', 'provides_insurance')
    search_fields = (
        'package__title', 'carrier__user__username',
        'carrier__company_name', 'message'
    )

    readonly_fields = (
        'created_at', 'updated_at', 'accepted_at', 'expires_at'
    )

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('package', 'carrier', 'status')
        }),
        (_('Détails de l\'offre'), {
            'fields': ('price', 'currency', 'message',
                      'proposed_pickup_date', 'proposed_delivery_date')
        }),
        (_('Services inclus'), {
            'fields': ('provides_insurance', 'insurance_coverage',
                      'provides_packaging', 'provides_loading', 'provides_unloading')
        }),
        (_('Suivi'), {
            'fields': ('rejection_reason', 'accepted_at', 'expires_at')
        }),
        (_('Métadonnées'), {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION: actions doit être une LISTE de noms de méthodes
    actions = ['accept_offers', 'reject_offers', 'mark_as_expired']

    def package_link(self, obj):
        url = reverse('admin:colis_package_change', args=[obj.package.id])
        return format_html('<a href="{}">{}</a>', url, obj.package.title)
    package_link.short_description = _('Colis')
    package_link.admin_order_field = 'package__title'

    def carrier_link(self, obj):
        url = reverse('admin:carriers_carrier_change', args=[obj.carrier.id])
        carrier_name = obj.carrier.company_name or obj.carrier.user.username
        return format_html('<a href="{}">{}</a>', url, carrier_name)
    carrier_link.short_description = _('Transporteur')
    carrier_link.admin_order_field = 'carrier__user__username'

    def price_display(self, obj):
        return f"{obj.price} {obj.get_currency_display()}"
    price_display.short_description = _('Prix')
    price_display.admin_order_field = 'price'

    def status_badge(self, obj):
        status_colors = {
            'PENDING': 'warning',
            'ACCEPTED': 'success',
            'REJECTED': 'danger',
            'CANCELLED': 'secondary',
            'EXPIRED': 'dark'
        }
        color = status_colors.get(obj.status, 'secondary')
        return format_html(
            '<span class="badge bg-{}">{}</span>',
            color, obj.get_status_display()
        )
    status_badge.short_description = _('Statut')

    def dates_display(self, obj):
        return format_html(
            '{} → {}',
            obj.proposed_pickup_date.strftime('%d/%m/%Y'),
            obj.proposed_delivery_date.strftime('%d/%m/%Y')
        )
    dates_display.short_description = _('Dates proposées')

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('package', 'carrier', 'carrier__user')

    # ✅ Les méthodes d'action doivent être définies séparément
    def accept_offers(self, request, queryset):
        """Action pour accepter les offres"""
        count = 0
        for offer in queryset.filter(status=TransportOffer.Status.PENDING):
            if offer.can_be_accepted():
                offer.status = TransportOffer.Status.ACCEPTED
                offer.accepted_at = timezone.now()
                offer.save()
                count += 1

        self.message_user(request, _(f'{count} offres ont été acceptées.'))
    accept_offers.short_description = _('Accepter les offres sélectionnées')

    def reject_offers(self, request, queryset):
        """Action pour rejeter les offres"""
        updated = queryset.update(status=TransportOffer.Status.REJECTED)
        self.message_user(request, _(f'{updated} offres ont été rejetées.'))
    reject_offers.short_description = _('Rejeter les offres sélectionnées')

    def mark_as_expired(self, request, queryset):
        """Action pour marquer comme expiré"""
        updated = queryset.update(status=TransportOffer.Status.EXPIRED)
        self.message_user(request, _(f'{updated} offres ont été marquées comme expirées.'))
    mark_as_expired.short_description = _('Marquer comme expiré')

    def save_model(self, request, obj, form, change):
        # Si l'offre est acceptée, mettre à jour le colis
        if obj.status == TransportOffer.Status.ACCEPTED and not obj.accepted_at:
            obj.accepted_at = timezone.now()
            obj.package.status = Package.Status.RESERVED
            obj.package.reserved_at = timezone.now()
            obj.package.save()

        super().save_model(request, obj, form, change)


@admin.register(PackageView)
class PackageViewAdmin(admin.ModelAdmin):
    """Administration des vues de colis"""

    list_display = ('package', 'user', 'ip_address', 'viewed_at')
    list_filter = ('viewed_at',)
    search_fields = ('package__title', 'user__username', 'ip_address')
    readonly_fields = ('viewed_at',)

    # ✅ CORRECTION: actions doit être une liste vide si pas d'actions
    actions = []

    def has_add_permission(self, request):
        return False

    def has_change_permission(self, request, obj=None):
        return False

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('package', 'user')


@admin.register(PackageFavorite)
class PackageFavoriteAdmin(admin.ModelAdmin):
    """Administration des favoris de colis"""

    list_display = ('user', 'package', 'created_at')
    list_filter = ('created_at',)
    search_fields = ('user__username', 'package__title')
    readonly_fields = ('created_at',)

    # ✅ CORRECTION: actions doit être une liste vide si pas d'actions
    actions = []

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('user', 'package')


@admin.register(PackageReport)
class PackageReportAdmin(admin.ModelAdmin):
    """Administration des signalements de colis"""

    # ✅ CORRECTION: Ajouter 'status' à list_display
    list_display = ('package', 'reporter', 'reason', 'status', 'status_badge', 'created_at')
    list_filter = ('reason', 'status', 'created_at')
    search_fields = ('package__title', 'reporter__username', 'description')
    list_editable = ('status',)
    readonly_fields = ('created_at',)

    fieldsets = (
        (_('Signalement'), {
            'fields': ('package', 'reporter', 'reason', 'description', 'evidence')
        }),
        (_('Traitement'), {
            'fields': ('status', 'admin_notes', 'resolved_by', 'resolved_at')
        }),
        (_('Métadonnées'), {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION: actions doit être une liste de noms de méthodes
    actions = ['mark_as_resolved', 'mark_as_dismissed']

    def status_badge(self, obj):
        status_colors = {
            'PENDING': 'warning',
            'IN_REVIEW': 'info',
            'RESOLVED': 'success',
            'DISMISSED': 'secondary'
        }
        color = status_colors.get(obj.status, 'secondary')
        return format_html(
            '<span class="badge bg-{}">{}</span>',
            color, obj.get_status_display()
        )
    status_badge.short_description = _('Badge Statut')

    def status(self, obj):
        """Affiche le statut textuel pour list_display"""
        return obj.get_status_display()
    status.short_description = _('Statut')

    def mark_as_resolved(self, request, queryset):
        """Action pour marquer comme résolu"""
        updated = queryset.update(
            status='RESOLVED',
            resolved_by=request.user,
            resolved_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} signalements ont été résolus.'))
    mark_as_resolved.short_description = _('Marquer comme résolu')

    def mark_as_dismissed(self, request, queryset):
        """Action pour rejeter les signalements"""
        updated = queryset.update(
            status='DISMISSED',
            resolved_by=request.user,
            resolved_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} signalements ont été rejetés.'))
    mark_as_dismissed.short_description = _('Rejeter les signalements')

    def save_model(self, request, obj, form, change):
        if obj.status in ['RESOLVED', 'DISMISSED'] and not obj.resolved_by:
            obj.resolved_by = request.user
            obj.resolved_at = timezone.now()
        super().save_model(request, obj, form, change)

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('package', 'reporter', 'resolved_by')

# ============================================================================
# PANNEAUX D'ADMINISTRATION PERSONNALISÉS
# ============================================================================

class ColisAdminSite(admin.AdminSite):
    """Site d'administration personnalisé pour l'application colis"""

    site_header = _("Administration des colis Ebi3")
    site_title = _("Administration des colis")
    index_title = _("Tableau de bord")

    def get_app_list(self, request):
        """
        Retourne une liste triée des applications.
        """
        app_list = super().get_app_list(request)

        # Réorganiser les applications pour mettre 'colis' en premier
        for app in app_list:
            if app['app_label'] == 'colis':
                app_list.remove(app)
                app_list.insert(0, app)
                break

        return app_list


# ============================================================================
# MODÈLES POUR LE PANNEAU D'ADMINISTRATION
# ============================================================================

class PackageStatistics(models.Model):
    """Modèle virtuel pour les statistiques (admin seulement)"""

    class Meta:
        verbose_name = _("Statistiques")
        verbose_name_plural = _("Statistiques")
        managed = False  # Ne crée pas de table dans la base de données


class PackageStatisticsAdmin(admin.ModelAdmin):
    """Administration des statistiques des colis"""

    # Cette vue n'a pas de modèle réel, donc on désactive les actions normales
    def has_add_permission(self, request):
        return False

    def has_change_permission(self, request, obj=None):
        return False

    def has_delete_permission(self, request, obj=None):
        return False

    def changelist_view(self, request, extra_context=None):
        # Rediriger vers notre vue personnalisée
        from django.urls import reverse
        return HttpResponseRedirect(reverse('admin:colis_package_statistics'))

    def get_urls(self):
        return []


# Enregistrement du modèle virtuel pour les statistiques
admin.site.register(PackageStatistics, PackageStatisticsAdmin)


========== colis/forms.py ==========
# ~/ebi3/colis/forms.py
from django import forms
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import ValidationError
from django.forms import inlineformset_factory
from django.utils import timezone
from django_countries import countries
from django_countries.widgets import CountrySelectWidget

from .models import Package, PackageCategory, PackageImage, TransportOffer, PackageReport
from users.models import User
from carriers.models import Carrier


class PackageBaseForm(forms.ModelForm):
    """Formulaire de base pour les colis"""

    # AJOUT: Champs pour la sélection hiérarchique des catégories
    main_category = forms.ModelChoiceField(
        queryset=PackageCategory.objects.filter(parent__isnull=True, is_active=True),
        required=False,
        label=_("Catégorie principale"),
        widget=forms.Select(attrs={
            'class': 'form-control',
            'id': 'id_main_category'
        })
    )

    sub_category = forms.ModelChoiceField(
        queryset=PackageCategory.objects.none(),  # Vide initialement
        required=False,
        label=_("Sous-catégorie"),
        widget=forms.Select(attrs={
            'class': 'form-control',
            'id': 'id_sub_category',
            'disabled': 'disabled'
        })
    )

    # MODIFICATION: Champ category rendu caché
    category = forms.ModelChoiceField(
        queryset=PackageCategory.objects.filter(is_active=True),
        required=True,
        label=_("Catégorie finale"),
        widget=forms.HiddenInput(attrs={'id': 'id_final_category'})
    )

    # Champs supplémentaires pour l'UI
    use_current_location = forms.BooleanField(
        required=False,
        initial=False,
        label=_("Utiliser ma position actuelle"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    class Meta:
        model = Package
        fields = [
            'title', 'category', 'package_type', 'description',
            'weight', 'length', 'width', 'height',
            'pickup_country', 'pickup_city', 'pickup_address', 'pickup_postal_code',
            'delivery_country', 'delivery_city', 'delivery_address', 'delivery_postal_code',
            'pickup_date', 'delivery_date', 'flexible_dates',
            'price_type', 'asking_price', 'currency',
            'is_fragile', 'requires_insurance', 'insurance_value',
            'requires_packaging', 'requires_loading_help', 'requires_unloading_help',
            # AJOUT: Champs pour la hiérarchie des catégories
            'main_category', 'sub_category'
        ]

        widgets = {
            'title': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Ex: Déménagement Paris → Lyon")
            }),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 6,
                'placeholder': _("Décrivez votre colis en détail...\n• Contenu\n• État\n• Instructions spéciales")
            }),
            'category': forms.HiddenInput(attrs={'id': 'id_final_category'}),  # Changé en HiddenInput
            'package_type': forms.Select(attrs={'class': 'form-control'}),
            'weight': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.001',
                'placeholder': _("kg")
            }),
            'length': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.1',
                'placeholder': _("cm")
            }),
            'width': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.1',
                'placeholder': _("cm")
            }),
            'height': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.1',
                'placeholder': _("cm")
            }),
            'pickup_country': CountrySelectWidget(attrs={'class': 'form-control'}),
            'pickup_city': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Ville de départ")
            }),
            'pickup_address': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _("Adresse complète (optionnel)")
            }),
            'pickup_postal_code': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Code postal")
            }),
            'delivery_country': CountrySelectWidget(attrs={'class': 'form-control'}),
            'delivery_city': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Ville de destination")
            }),
            'delivery_address': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _("Adresse complète (optionnel)")
            }),
            'delivery_postal_code': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Code postal")
            }),
            'pickup_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control',
                'min': timezone.now().date().isoformat()
            }),
            'delivery_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
            'price_type': forms.Select(attrs={'class': 'form-control'}),
            'asking_price': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'placeholder': _("0.00")
            }),
            'currency': forms.Select(attrs={'class': 'form-control'}),
            'insurance_value': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
        }

        labels = {
            'flexible_dates': _("Dates flexibles"),
            'is_fragile': _("Colis fragile"),
            'requires_insurance': _("Assurance requise"),
            'requires_packaging': _("Emballage requis"),
            'requires_loading_help': _("Aide au chargement nécessaire"),
            'requires_unloading_help': _("Aide au déchargement nécessaire"),
        }

        help_texts = {
            'asking_price': _("Prix que vous souhaitez payer pour le transport"),
            'pickup_date': _("Date à partir de laquelle le colis est disponible"),
            'delivery_date': _("Date limite pour la livraison"),
        }

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        # Initialiser la hiérarchie des catégories si le colis existe déjà
        if self.instance and self.instance.pk and self.instance.category:
            category = self.instance.category
            # Trouver la catégorie racine
            ancestors = category.get_ancestors(include_self=True)
            if ancestors.exists():
                main_cat = ancestors.first()
                self.fields['main_category'].initial = main_cat.id

                # Configurer les sous-catégories
                if ancestors.count() > 1:
                    sub_cat = ancestors[1] if len(ancestors) > 1 else None
                    self.fields['sub_category'].queryset = PackageCategory.objects.filter(
                        parent=main_cat, is_active=True
                    )
                    if sub_cat:
                        self.fields['sub_category'].initial = sub_cat.id
                        # Configurer la catégorie finale
                        self.fields['category'].queryset = PackageCategory.objects.filter(
                            parent=sub_cat, is_active=True
                        )

        # Définir les dates par défaut
        if not self.instance.pk:
            self.fields['pickup_date'].initial = timezone.now().date() + timezone.timedelta(days=1)
            self.fields['delivery_date'].initial = timezone.now().date() + timezone.timedelta(days=7)

        # Ajuster les champs selon le type de colis
        if self.instance.package_type:
            self.adjust_fields_for_package_type()

        # Masquer les champs d'assurance si non requis
        self.fields['insurance_value'].widget.attrs['class'] = 'form-control insurance-field'
        if not self.data.get('requires_insurance', False) and not self.instance.requires_insurance:
            self.fields['insurance_value'].widget.attrs['style'] = 'display: none;'

    def adjust_fields_for_package_type(self):
        """Ajuste les champs requis selon le type de colis"""
        package_type = self.instance.package_type or self.data.get('package_type')

        if package_type == Package.PackageType.SMALL_PACKAGE:
            self.fields['requires_loading_help'].required = False
            self.fields['requires_unloading_help'].required = False
        elif package_type == Package.PackageType.FURNITURE:
            self.fields['requires_loading_help'].initial = True
            self.fields['requires_unloading_help'].initial = True

    def clean(self):
        cleaned_data = super().clean()

        # Validation de la catégorie hiérarchique
        main_category = cleaned_data.get('main_category')
        sub_category = cleaned_data.get('sub_category')
        final_category = cleaned_data.get('category')

        # Si une catégorie finale est sélectionnée, vérifier la hiérarchie
        if final_category:
            try:
                final_cat = PackageCategory.objects.get(id=final_category)
                ancestors = final_cat.get_ancestors(include_self=True)

                # Valider que main_category correspond au bon ancêtre
                if main_category and ancestors.exists():
                    expected_main = ancestors.first()
                    if main_category != expected_main:
                        raise ValidationError({
                            'main_category': _("La catégorie principale ne correspond pas à la hiérarchie sélectionnée.")
                        })

                # Valider que sub_category correspond si spécifié
                if sub_category and ancestors.count() > 1:
                    expected_sub = ancestors[1] if len(ancestors) > 1 else None
                    if sub_category != expected_sub:
                        raise ValidationError({
                            'sub_category': _("La sous-catégorie ne correspond pas à la hiérarchie sélectionnée.")
                        })
            except PackageCategory.DoesNotExist:
                raise ValidationError({
                    'category': _("La catégorie sélectionnée n'existe pas.")
                })

        # Calcul automatique du type de colis basé sur le poids
        weight = cleaned_data.get('weight')
        if weight and not cleaned_data.get('package_type'):
            if weight <= 30:
                cleaned_data['package_type'] = Package.PackageType.SMALL_PACKAGE
            elif weight <= 100:
                cleaned_data['package_type'] = Package.PackageType.MEDIUM_PACKAGE
            elif weight <= 500:
                cleaned_data['package_type'] = Package.PackageType.LARGE_PACKAGE
            else:
                cleaned_data['package_type'] = Package.PackageType.PALLET

        return cleaned_data

    def clean_delivery_date(self):
        pickup_date = self.cleaned_data.get('pickup_date')
        delivery_date = self.cleaned_data.get('delivery_date')

        if pickup_date and delivery_date:
            if delivery_date < pickup_date:
                raise ValidationError(
                    _("La date de livraison doit être postérieure à la date de départ.")
                )

            # Maximum 90 jours entre départ et livraison
            if (delivery_date - pickup_date).days > 90:
                raise ValidationError(
                    _("L'écart maximum entre départ et livraison est de 90 jours.")
                )

            if delivery_date < timezone.now().date():
                raise ValidationError(
                    _("La date de livraison ne peut pas être dans le passé.")
                )

        return delivery_date

    def clean_pickup_date(self):
        pickup_date = self.cleaned_data.get('pickup_date')

        if pickup_date and pickup_date < timezone.now().date():
            raise ValidationError(
                _("La date de départ ne peut pas être dans le passé.")
            )

        return pickup_date

    def clean_asking_price(self):
        price = self.cleaned_data.get('asking_price')
        price_type = self.cleaned_data.get('price_type')

        if price:
            if price <= 0:
                raise ValidationError(_("Le prix doit être supérieur à 0."))

            if price_type == Package.PriceType.FIXED and price < 5:
                raise ValidationError(_("Le prix fixe minimum est de 5€."))

        return price

    def clean_weight(self):
        weight = self.cleaned_data.get('weight')

        if weight:
            if weight <= 0:
                raise ValidationError(_("Le poids doit être supérieur à 0."))
            if weight > 2000:  # 2 tonnes maximum
                raise ValidationError(_("Le poids maximum autorisé est de 2000 kg."))

        return weight

    def clean_insurance_value(self):
        requires_insurance = self.cleaned_data.get('requires_insurance', False)
        insurance_value = self.cleaned_data.get('insurance_value')

        if requires_insurance and not insurance_value:
            raise ValidationError(
                _("Veuillez spécifier la valeur à assurer.")
            )

        if insurance_value and insurance_value <= 0:
            raise ValidationError(_("La valeur assurée doit être positive."))

        return insurance_value


class PackageCreateForm(PackageBaseForm):
    """Formulaire pour créer un colis"""

    accept_terms = forms.BooleanField(
        required=True,
        label=_("J'accepte les conditions générales"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        error_messages={'required': _("Vous devez accepter les conditions générales.")}
    )

    def save(self, commit=True):
        package = super().save(commit=False)

        if self.user:
            package.sender = self.user

        if commit:
            package.save()

        return package


class PackageUpdateForm(PackageBaseForm):
    """Formulaire pour mettre à jour un colis"""

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        # Empêcher la modification de certains champs si le colis est réservé
        if self.instance.status in [Package.Status.RESERVED, Package.Status.IN_TRANSIT]:
            disabled_fields = ['pickup_date', 'delivery_date', 'pickup_address',
                              'delivery_address', 'asking_price', 'price_type']
            for field in disabled_fields:
                if field in self.fields:
                    self.fields[field].disabled = True
                    self.fields[field].help_text = _("Non modifiable car le colis est réservé.")


class PackageImageForm(forms.ModelForm):
    """Formulaire pour les images de colis"""

    class Meta:
        model = PackageImage
        fields = ['image', 'caption', 'is_primary', 'display_order']

        widgets = {
            'image': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*'
            }),
            'caption': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Description de l'image")
            }),
            'display_order': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': 0
            }),
        }

    def clean_image(self):
        image = self.cleaned_data.get('image')

        if image:
            # Vérifier la taille (déjà fait par le validateur)
            # Vérifier le type MIME
            import imghdr
            image.seek(0)
            file_type = imghdr.what(image)
            if file_type not in ['jpeg', 'png', 'gif', 'webp']:
                raise ValidationError(
                    _("Format d'image non supporté. Utilisez JPEG, PNG, GIF ou WebP.")
                )
            image.seek(0)

        return image


class TransportOfferForm(forms.ModelForm):
    """Formulaire pour proposer une offre de transport"""

    class Meta:
        model = TransportOffer
        fields = [
            'price', 'currency', 'proposed_pickup_date', 'proposed_delivery_date',
            'message', 'provides_insurance', 'insurance_coverage',
            'provides_packaging', 'provides_loading', 'provides_unloading'
        ]

        widgets = {
            'price': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'placeholder': _("0.00")
            }),
            'currency': forms.Select(attrs={'class': 'form-control'}),
            'proposed_pickup_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control',
                'min': timezone.now().date().isoformat()
            }),
            'proposed_delivery_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
            'message': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _("Présentez-vous et expliquez pourquoi vous êtes le bon transporteur...")
            }),
            'insurance_coverage': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
        }

        labels = {
            'provides_insurance': _("Je fournis une assurance"),
            'provides_packaging': _("Je fournis l'emballage"),
            'provides_loading': _("Je fournis le chargement"),
            'provides_unloading': _("Je fournis le déchargement"),
        }

    def __init__(self, *args, **kwargs):
        self.package = kwargs.pop('package', None)
        self.carrier = kwargs.pop('carrier', None)
        super().__init__(*args, **kwargs)

        # Pré-remplir les dates basées sur le colis
        if self.package and not self.instance.pk:
            self.fields['proposed_pickup_date'].initial = self.package.pickup_date
            self.fields['proposed_delivery_date'].initial = self.package.delivery_date
            self.fields['currency'].initial = self.package.currency

            # Suggérer un prix basé sur le prix demandé
            if self.package.asking_price:
                suggested_price = float(self.package.asking_price) * 0.9  # 10% de moins
                self.fields['price'].initial = round(suggested_price, 2)

        # Masquer le champ de couverture d'assurance si non fournie
        self.fields['insurance_coverage'].widget.attrs['class'] = 'form-control insurance-coverage-field'
        if not self.data.get('provides_insurance', False) and not self.instance.provides_insurance:
            self.fields['insurance_coverage'].widget.attrs['style'] = 'display: none;'

    def clean_proposed_delivery_date(self):
        pickup_date = self.cleaned_data.get('proposed_pickup_date')
        delivery_date = self.cleaned_data.get('proposed_delivery_date')

        if pickup_date and delivery_date and delivery_date < pickup_date:
            raise ValidationError(
                _("La date de livraison proposée doit être postérieure à la date de départ.")
            )

        # Vérifier que la livraison est avant la date limite du colis
        if self.package and delivery_date:
            if delivery_date > self.package.delivery_date and not self.package.flexible_dates:
                raise ValidationError(
                    _("La date de livraison proposée dépasse la date limite du colis.")
                )

        return delivery_date

    def clean_proposed_pickup_date(self):
        pickup_date = self.cleaned_data.get('proposed_pickup_date')

        # Vérifier que le départ est après la date demandée
        if self.package and pickup_date:
            if pickup_date < self.package.pickup_date and not self.package.flexible_dates:
                raise ValidationError(
                    _("La date de départ proposée est antérieure à la date demandée.")
                )

        return pickup_date

    def clean_price(self):
        price = self.cleaned_data.get('price')

        if price:
            if price <= 0:
                raise ValidationError(_("Le prix doit être supérieur à 0."))

            # Vérifier que le prix n'est pas trop bas par rapport au prix demandé
            if self.package and self.package.asking_price:
                min_price = float(self.package.asking_price) * 0.5  # Minimum 50% du prix demandé
                if price < min_price:
                    raise ValidationError(
                        _("Le prix proposé est trop bas. Le minimum suggéré est {:.2f}€.").format(min_price)
                    )

        return price

    def clean_insurance_coverage(self):
        provides_insurance = self.cleaned_data.get('provides_insurance', False)
        insurance_coverage = self.cleaned_data.get('insurance_coverage')

        if provides_insurance and not insurance_coverage:
            raise ValidationError(
                _("Veuillez spécifier le montant de la couverture d'assurance.")
            )

        if insurance_coverage and insurance_coverage <= 0:
            raise ValidationError(_("La couverture d'assurance doit être positive."))

        return insurance_coverage

    def save(self, commit=True):
        offer = super().save(commit=False)

        if self.package:
            offer.package = self.package

        if self.carrier:
            offer.carrier = self.carrier

        if commit:
            offer.save()

        return offer


class PackageSearchForm(forms.Form):
    """Formulaire de recherche de colis"""

    q = forms.CharField(
        required=False,
        label=_("Rechercher"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Que souhaitez-vous transporter ?")
        })
    )

    category = forms.ModelChoiceField(
        required=False,
        queryset=PackageCategory.objects.filter(is_active=True),
        label=_("Catégorie"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    package_type = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous"))] + list(Package.PackageType.choices),
        label=_("Type de colis"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    # Origine
    pickup_country = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous les pays"))] + list(countries),
        label=_("Pays de départ"),
        widget=CountrySelectWidget(attrs={'class': 'form-control'})
    )

    pickup_city = forms.CharField(
        required=False,
        label=_("Ville de départ"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Ex: Paris, Lyon...")
        })
    )

    # Destination
    delivery_country = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous les pays"))] + list(countries),
        label=_("Pays de destination"),
        widget=CountrySelectWidget(attrs={'class': 'form-control'})
    )

    delivery_city = forms.CharField(
        required=False,
        label=_("Ville de destination"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Ex: Marseille, Casablanca...")
        })
    )

    # Dates
    pickup_date_from = forms.DateField(
        required=False,
        label=_("Départ à partir du"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    pickup_date_to = forms.DateField(
        required=False,
        label=_("Départ jusqu'au"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    # Dimensions et poids
    max_weight = forms.DecimalField(
        required=False,
        min_value=0,
        decimal_places=3,
        label=_("Poids maximum (kg)"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Ex: 50")
        })
    )

    max_volume = forms.DecimalField(
        required=False,
        min_value=0,
        decimal_places=3,
        label=_("Volume maximum (L)"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Ex: 100")
        })
    )

    # Prix
    min_price = forms.DecimalField(
        required=False,
        min_value=0,
        decimal_places=2,
        label=_("Prix minimum"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Min")
        })
    )

    max_price = forms.DecimalField(
        required=False,
        min_value=0,
        decimal_places=2,
        label=_("Prix maximum"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Max")
        })
    )

    # Options
    flexible_dates = forms.BooleanField(
        required=False,
        label=_("Dates flexibles seulement"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    provides_insurance = forms.BooleanField(
        required=False,
        label=_("Transport avec assurance"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    # Tri
    sort_by = forms.ChoiceField(
        required=False,
        choices=[
            ('-created_at', _("Plus récent")),
            ('pickup_date', _("Départ proche")),
            ('asking_price', _("Prix croissant")),
            ('-asking_price', _("Prix décroissant")),
            ('-view_count', _("Plus populaire")),
        ],
        initial='-created_at',
        label=_("Trier par"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    def clean(self):
        cleaned_data = super().clean()
        pickup_date_from = cleaned_data.get('pickup_date_from')
        pickup_date_to = cleaned_data.get('pickup_date_to')
        min_price = cleaned_data.get('min_price')
        max_price = cleaned_data.get('max_price')

        if pickup_date_from and pickup_date_to:
            if pickup_date_to < pickup_date_from:
                raise ValidationError(
                    _("La date 'jusqu'au' doit être postérieure à la date 'à partir du'.")
                )

        if min_price and max_price:
            if min_price > max_price:
                raise ValidationError(
                    _("Le prix minimum ne peut pas être supérieur au prix maximum.")
                )

        return cleaned_data


class PackageReportForm(forms.ModelForm):
    """Formulaire pour signaler un colis"""

    class Meta:
        model = PackageReport
        fields = ['reason', 'description', 'evidence']

        widgets = {
            'reason': forms.Select(attrs={'class': 'form-control'}),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _("Décrivez le problème en détail...")
            }),
            'evidence': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*,.pdf,.doc,.docx'
            }),
        }

        labels = {
            'evidence': _("Preuve (capture d'écran, document...)"),
        }


class QuickQuoteForm(forms.Form):
    """Formulaire de devis rapide (pour transporteurs)"""

    pickup_address = forms.CharField(
        label=_("Adresse de départ"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Adresse complète")
        })
    )

    delivery_address = forms.CharField(
        label=_("Adresse de destination"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Adresse complète")
        })
    )

    weight = forms.DecimalField(
        label=_("Poids (kg)"),
        min_value=0.001,
        decimal_places=3,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.001'
        })
    )

    length = forms.DecimalField(
        required=False,
        label=_("Longueur (cm)"),
        min_value=0,
        decimal_places=1,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.1'
        })
    )

    width = forms.DecimalField(
        required=False,
        label=_("Largeur (cm)"),
        min_value=0,
        decimal_places=1,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.1'
        })
    )

    height = forms.DecimalField(
        required=False,
        label=_("Hauteur (cm)"),
        min_value=0,
        decimal_places=1,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.1'
        })
    )

    pickup_date = forms.DateField(
        label=_("Date de départ souhaitée"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    delivery_date = forms.DateField(
        label=_("Date de livraison souhaitée"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    is_fragile = forms.BooleanField(
        required=False,
        label=_("Colis fragile"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    requires_insurance = forms.BooleanField(
        required=False,
        label=_("Assurance requise"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    insurance_value = forms.DecimalField(
        required=False,
        label=_("Valeur à assurer"),
        min_value=0,
        decimal_places=2,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01'
        })
    )

    def clean_delivery_date(self):
        pickup_date = self.cleaned_data.get('pickup_date')
        delivery_date = self.cleaned_data.get('delivery_date')

        if pickup_date and delivery_date and delivery_date < pickup_date:
            raise ValidationError(
                _("La date de livraison doit être postérieure à la date de départ.")
            )

        return delivery_date


# Formsets
PackageImageFormSet = inlineformset_factory(
    Package,
    PackageImage,
    form=PackageImageForm,
    extra=5,  # 5 formulaires d'image vides par défaut
    max_num=15,  # Maximum d'images
    can_delete=True,
    validate_max=True,
)


class PackageFilterForm(forms.Form):
    """Formulaire de filtrage pour le dashboard"""

    STATUS_CHOICES = [
        ('', _("Tous les statuts")),
        ('AVAILABLE', _("Disponible")),
        ('RESERVED', _("Réservé")),
        ('IN_TRANSIT', _("En transit")),
        ('DELIVERED', _("Livré")),
        ('CANCELLED', _("Annulé")),
    ]

    status = forms.ChoiceField(
        required=False,
        choices=STATUS_CHOICES,
        label=_("Statut"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    date_from = forms.DateField(
        required=False,
        label=_("À partir du"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    date_to = forms.DateField(
        required=False,
        label=_("Jusqu'au"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    def clean(self):
        cleaned_data = super().clean()
        date_from = cleaned_data.get('date_from')
        date_to = cleaned_data.get('date_to')

        if date_from and date_to and date_to < date_from:
            raise ValidationError(
                _("La date 'jusqu'au' doit être postérieure à la date 'à partir du'.")
            )

        return cleaned_data


========== colis/management/commands/generate_sitemaps.py ==========
# ~/ebi3/colis/management/commands/generate_sitemaps.py
from django.core.management.base import BaseCommand
from django.contrib.sites.models import Site
from colis.sitemaps import SitemapGenerator
import os
from django.conf import settings

class Command(BaseCommand):
    help = 'Génère les fichiers sitemap XML pour l\'application colis'

    def add_arguments(self, parser):
        parser.add_argument(
            '--output-dir',
            type=str,
            default=os.path.join(settings.BASE_DIR, 'static', 'sitemaps'),
            help='Répertoire de sortie pour les fichiers sitemap'
        )

    def handle(self, *args, **options):
        output_dir = options['output_dir']

        # Créer le répertoire s'il n'existe pas
        os.makedirs(output_dir, exist_ok=True)

        # Générer l'index des sitemaps
        index_content = SitemapGenerator.generate_sitemap_index()
        index_path = os.path.join(output_dir, 'sitemap_index.xml')

        with open(index_path, 'w', encoding='utf-8') as f:
            f.write(index_content)

        self.stdout.write(
            self.style.SUCCESS(f'Index sitemap généré: {index_path}')
        )

        # Afficher les statistiques
        stats = SitemapGenerator.get_sitemap_stats()
        self.stdout.write(f"\nStatistiques des sitemaps:")
        self.stdout.write(f"Total URLs: {stats['total_urls']}")

        for sitemap_name, count in stats['by_type'].items():
            self.stdout.write(f"  {sitemap_name}: {count} URLs")


========== colis/__init__.py ==========



========== colis/apps.py ==========
# ~/ebi3/colis/apps.py
from django.apps import AppConfig

class ColisConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'colis'
    verbose_name = "Colis"

    def ready(self):
        """Connecte les signaux lors du chargement de l'application"""
        # TODO: Décommenter lorsque les signaux seront implémentés
        # import colis.signals
        # colis.signals.connect_signals()

        # Import des tâches Celery (si utilisé)
        try:
            import colis.tasks  # noqa
        except ImportError:
            pass


========== colis/tasks.py ==========
# ~/ebi3/colis/tasks.py
"""
Tâches asynchrones pour l'application colis
Utilise Celery pour les opérations longues, périodiques ou groupées
"""

import logging
from datetime import timedelta
from decimal import Decimal
from typing import List, Dict, Any
from django.utils import timezone
from django.conf import settings
from django.core.cache import cache
from django.core.mail import send_mail, EmailMultiAlternatives
from django.template.loader import render_to_string
from django.db.models import Count, Q, F, Avg, Sum, Case, When, IntegerField
from django.contrib.gis.geos import Point
from django.contrib.gis.db.models.functions import Distance
from django.contrib.sites.models import Site
from celery import shared_task, group, chain, chord
from celery.utils.log import get_task_logger

from .models import (
    Package, TransportOffer, PackageCategory, PackageImage,
    PackageView, PackageFavorite, PackageReport
)
from users.models import User
from messaging.models import Conversation, Message
from carriers.models import Carrier, CarrierReview

logger = get_task_logger(__name__)


# ============================================================================
# TÂCHES POUR LES PACKAGES
# ============================================================================

@shared_task(name='colis.tasks.update_package_statuses')
def update_package_statuses():
    """
    Tâche périodique pour mettre à jour les statuts des colis
    - Expiration des colis disponibles
    - Passage en transit après date de départ
    - Passage en livré après date d'arrivée
    """
    now = timezone.now()
    updated_count = 0

    # Colis disponibles qui ont expiré
    expired_packages = Package.objects.filter(
        status=Package.Status.AVAILABLE,
        available_until__lt=now.date()
    )

    for package in expired_packages:
        package.status = Package.Status.EXPIRED
        package.expired_at = now
        package.save(update_fields=['status', 'expired_at', 'updated_at'])
        updated_count += 1

        # Notifier l'expéditeur
        send_package_status_notification.delay(
            package_id=package.id,
            old_status='AVAILABLE',
            new_status='EXPIRED'
        )

    # Colis réservés dont la date de départ est passée
    reserved_to_transit = Package.objects.filter(
        status=Package.Status.RESERVED,
        departure_date__lt=now.date()
    )

    for package in reserved_to_transit:
        package.status = Package.Status.IN_TRANSIT
        package.save(update_fields=['status', 'updated_at'])
        updated_count += 1

        send_package_status_notification.delay(
            package_id=package.id,
            old_status='RESERVED',
            new_status='IN_TRANSIT'
        )

    # Colis en transit dont la date d'arrivée est passée
    transit_to_delivered = Package.objects.filter(
        status=Package.Status.IN_TRANSIT,
        arrival_date__lt=now.date()
    )

    for package in transit_to_delivered:
        package.status = Package.Status.DELIVERED
        package.delivered_at = now
        package.save(update_fields=['status', 'delivered_at', 'updated_at'])
        updated_count += 1

        send_package_status_notification.delay(
            package_id=package.id,
            old_status='IN_TRANSIT',
            new_status='DELIVERED'
        )

    logger.info(f"Mise à jour de {updated_count} statuts de colis")
    return updated_count


@shared_task(name='colis.tasks.cleanup_old_packages')
def cleanup_old_packages(days_old: int = 365):
    """
    Nettoie les anciens colis (archivage ou suppression)
    Args:
        days_old: Nombre de jours après lesquels un colis est considéré comme ancien
    """
    cutoff_date = timezone.now() - timedelta(days=days_old)
    old_packages = Package.objects.filter(
        Q(created_at__lt=cutoff_date) &
        Q(status__in=['DELIVERED', 'CANCELLED', 'EXPIRED'])
    )

    # Archive les anciens colis
    archived_count = old_packages.update(
        is_archived=True,
        archived_at=timezone.now()
    )

    # Supprime les colis très anciens (plus de 2 ans)
    very_old_cutoff = timezone.now() - timedelta(days=730)
    very_old_packages = Package.objects.filter(
        created_at__lt=very_old_cutoff,
        is_archived=True
    )

    deleted_count = very_old_packages.count()
    # Note: La suppression est commentée par sécurité
    # very_old_packages.delete()

    logger.info(f"Archivé {archived_count} colis, {deleted_count} supprimables")
    return {'archived': archived_count, 'deletable': deleted_count}


@shared_task(name='colis.tasks.calculate_package_statistics')
def calculate_package_statistics():
    """
    Calcule les statistiques globales des colis et met en cache
    """
    stats = Package.objects.aggregate(
        total_packages=Count('id'),
        available_packages=Count('id', filter=Q(status='AVAILABLE')),
        reserved_packages=Count('id', filter=Q(status='RESERVED')),
        in_transit_packages=Count('id', filter=Q(status='IN_TRANSIT')),
        delivered_packages=Count('id', filter=Q(status='DELIVERED')),
        total_weight=Sum('weight'),
        average_price=Avg('price'),
        total_offers=Sum('offers_count'),
    )

    # Statistiques par catégorie
    category_stats = PackageCategory.objects.annotate(
        package_count=Count('packages', filter=Q(packages__status='AVAILABLE'))
    ).values('id', 'name', 'package_count').order_by('-package_count')[:10]

    # Top destinations
    top_destinations = Package.objects.filter(status='AVAILABLE').values(
        'country_to', 'city_to'
    ).annotate(
        count=Count('id')
    ).order_by('-count')[:10]

    cache_data = {
        'global_stats': stats,
        'category_stats': list(category_stats),
        'top_destinations': list(top_destinations),
        'calculated_at': timezone.now().isoformat(),
    }

    # Mettre en cache pour 1 heure
    cache.set('colis_statistics', cache_data, timeout=3600)
    logger.info("Statistiques des colis calculées et mises en cache")

    return cache_data


# ============================================================================
# TÂCHES POUR LES OFFRES DE TRANSPORT
# ============================================================================

@shared_task(name='colis.tasks.process_expired_offers')
def process_expired_offers():
    """
    Traite les offres de transport expirées
    - Marque les offres comme expirées
    - Notifie les transporteurs
    """
    expired_offers = TransportOffer.objects.filter(
        status=TransportOffer.Status.PENDING,
        expires_at__lt=timezone.now()
    )

    expired_count = expired_offers.count()

    for offer in expired_offers:
        offer.status = TransportOffer.Status.EXPIRED
        offer.save(update_fields=['status', 'updated_at'])

        # Notifier le transporteur
        send_transport_offer_notification.delay(
            offer_id=offer.id,
            notification_type='OFFER_EXPIRED'
        )

        # Notifier l'expéditeur si c'était la seule offre
        package_offers = TransportOffer.objects.filter(
            package=offer.package,
            status=TransportOffer.Status.PENDING
        ).count()

        if package_offers == 0:
            send_package_notification.delay(
                package_id=offer.package.id,
                notification_type='NO_ACTIVE_OFFERS'
            )

    logger.info(f"Traiter {expired_count} offres expirées")
    return expired_count


@shared_task(name='colis.tasks.find_matching_carriers')
def find_matching_carriers(package_id: int):
    """
    Trouve les transporteurs correspondant à un colis
    Args:
        package_id: ID du colis
    """
    try:
        package = Package.objects.get(id=package_id)
    except Package.DoesNotExist:
        logger.error(f"Colis {package_id} non trouvé")
        return 0

    # Critères de correspondance
    matching_carriers = Carrier.objects.filter(
        # Disponibilité
        is_available=True,
        status='APPROVED',
        # Capacités
        max_weight__gte=package.weight or 0,
        max_volume__gte=package.volume or 0,
        # Destination
        routes__end_country=package.country_to,
        routes__end_city__icontains=package.city_to,
        routes__is_active=True,
        routes__departure_date__gte=package.departure_date,
    ).distinct()

    matching_count = matching_carriers.count()
    logger.info(f"Trouvé {matching_count} transporteurs pour le colis {package_id}")

    # Notifier les transporteurs correspondants
    for carrier in matching_carriers:
        send_carrier_match_notification.delay(
            carrier_id=carrier.id,
            package_id=package.id
        )

    return matching_count


@shared_task(name='colis.tasks.create_auto_offer')
def create_auto_offer(package_id: int, carrier_id: int):
    """
    Crée une offre automatique pour un transporteur correspondant
    """
    try:
        package = Package.objects.get(id=package_id)
        carrier = Carrier.objects.get(id=carrier_id)
    except (Package.DoesNotExist, Carrier.DoesNotExist) as e:
        logger.error(f"Erreur création offre auto: {e}")
        return None

    # Calcul du prix automatique (prix du colis + marge transporteur)
    base_price = package.price or Decimal('0.00')
    carrier_margin = carrier.base_price_per_km or Decimal('1.00')

    # Estimation de distance (simplifiée)
    estimated_distance = Decimal('500.00')  # En km
    transport_price = estimated_distance * carrier_margin

    total_price = base_price + transport_price

    # Création de l'offre
    offer = TransportOffer.objects.create(
        package=package,
        carrier=carrier.user,
        price=total_price,
        currency=package.currency,
        notes=f"Offre automatique générée le {timezone.now().strftime('%d/%m/%Y')}",
        expires_at=timezone.now() + timedelta(days=7)
    )

    logger.info(f"Offre automatique {offer.id} créée pour transporteur {carrier_id}")

    # Notifier l'expéditeur
    send_transport_offer_notification.delay(
        offer_id=offer.id,
        notification_type='NEW_AUTO_OFFER'
    )

    return offer.id


# ============================================================================
# TÂCHES DE NOTIFICATION
# ============================================================================

@shared_task(name='colis.tasks.send_package_status_notification')
def send_package_status_notification(package_id: int, old_status: str, new_status: str):
    """
    Envoie une notification de changement de statut
    """
    try:
        package = Package.objects.get(id=package_id)
        sender = package.sender
    except Package.DoesNotExist:
        logger.error(f"Colis {package_id} non trouvé")
        return False

    # Préparer l'email
    subject = f"Colis '{package.title}' - Statut mis à jour"

    context = {
        'package': package,
        'old_status': old_status,
        'new_status': new_status,
        'new_status_display': package.get_status_display(),
        'site': Site.objects.get_current(),
        'user': sender,
    }

    html_content = render_to_string('colis/emails/package_status_change.html', context)
    text_content = render_to_string('colis/emails/package_status_change.txt', context)

    try:
        email = EmailMultiAlternatives(
            subject=subject,
            body=text_content,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[sender.email],
            reply_to=[settings.REPLY_TO_EMAIL]
        )
        email.attach_alternative(html_content, "text/html")
        email.send()

        logger.info(f"Notification de statut envoyée pour le colis {package_id}")
        return True
    except Exception as e:
        logger.error(f"Erreur envoi notification: {e}")
        return False


@shared_task(name='colis.tasks.send_transport_offer_notification')
def send_transport_offer_notification(offer_id: int, notification_type: str):
    """
    Envoie des notifications relatives aux offres de transport
    Types: NEW_OFFER, OFFER_ACCEPTED, OFFER_REJECTED, OFFER_EXPIRED
    """
    try:
        offer = TransportOffer.objects.get(id=offer_id)
        carrier = offer.carrier
        package = offer.package
    except TransportOffer.DoesNotExist:
        logger.error(f"Offre {offer_id} non trouvé")
        return False

    # Déterminer le sujet et le destinataire
    if notification_type in ['NEW_OFFER', 'OFFER_ACCEPTED', 'OFFER_REJECTED']:
        recipient = package.sender
        recipient_type = 'sender'
    elif notification_type in ['OFFER_EXPIRED', 'NEW_AUTO_OFFER']:
        recipient = carrier
        recipient_type = 'carrier'
    else:
        logger.error(f"Type de notification invalide: {notification_type}")
        return False

    # Mapper les types aux sujets
    subject_map = {
        'NEW_OFFER': f"Nouvelle offre pour votre colis '{package.title}'",
        'OFFER_ACCEPTED': f"Votre offre pour le colis '{package.title}' a été acceptée",
        'OFFER_REJECTED': f"Votre offre pour le colis '{package.title}' a été refusée",
        'OFFER_EXPIRED': f"Votre offre pour le colis '{package.title}' a expiré",
        'NEW_AUTO_OFFER': f"Nouvelle opportunité de transport : {package.title}",
    }

    subject = subject_map.get(notification_type, "Mise à jour de votre offre")

    context = {
        'offer': offer,
        'package': package,
        'notification_type': notification_type,
        'recipient_type': recipient_type,
        'site': Site.objects.get_current(),
        'user': recipient,
    }

    template_name = f'colis/emails/transport_offer_{notification_type.lower()}.html'
    txt_template_name = f'colis/emails/transport_offer_{notification_type.lower()}.txt'

    try:
        html_content = render_to_string(template_name, context)
        text_content = render_to_string(txt_template_name, context)

        email = EmailMultiAlternatives(
            subject=subject,
            body=text_content,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[recipient.email],
            reply_to=[settings.REPLY_TO_EMAIL]
        )
        email.attach_alternative(html_content, "text/html")
        email.send()

        logger.info(f"Notification {notification_type} envoyée pour l'offre {offer_id}")
        return True
    except Exception as e:
        logger.error(f"Erreur envoi notification offre: {e}")
        return False


@shared_task(name='colis.tasks.send_carrier_match_notification')
def send_carrier_match_notification(carrier_id: int, package_id: int):
    """
    Notifie un transporteur d'un colis correspondant à ses critères
    """
    try:
        carrier = Carrier.objects.get(id=carrier_id)
        package = Package.objects.get(id=package_id)
    except (Carrier.DoesNotExist, Package.DoesNotExist) as e:
        logger.error(f"Erreur notification match: {e}")
        return False

    subject = f"💼 Nouveau colis correspondant à votre profil"

    context = {
        'carrier': carrier,
        'package': package,
        'site': Site.objects.get_current(),
        'user': carrier.user,
    }

    try:
        html_content = render_to_string('colis/emails/carrier_match_notification.html', context)
        text_content = render_to_string('colis/emails/carrier_match_notification.txt', context)

        email = EmailMultiAlternatives(
            subject=subject,
            body=text_content,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[carrier.user.email],
            reply_to=[settings.REPLY_TO_EMAIL]
        )
        email.attach_alternative(html_content, "text/html")
        email.send()

        logger.info(f"Notification de match envoyée au transporteur {carrier_id}")
        return True
    except Exception as e:
        logger.error(f"Erreur envoi notification match: {e}")
        return False


@shared_task(name='colis.tasks.send_package_notification')
def send_package_notification(package_id: int, notification_type: str):
    """
    Notifications générales sur les colis
    Types: NO_ACTIVE_OFFERS, DELIVERY_REMINDER, REVIEW_REMINDER
    """
    try:
        package = Package.objects.get(id=package_id)
    except Package.DoesNotExist:
        logger.error(f"Colis {package_id} non trouvé")
        return False

    # Déterminer le destinataire
    if notification_type == 'NO_ACTIVE_OFFERS':
        recipient = package.sender
        subject = f"⏰ Aucune offre active pour votre colis '{package.title}'"
    elif notification_type == 'DELIVERY_REMINDER':
        recipient = package.carrier if package.carrier else package.sender
        subject = f"📦 Rappel : Livraison prévue pour '{package.title}'"
    elif notification_type == 'REVIEW_REMINDER':
        recipient = package.sender
        subject = f"⭐ N'oubliez pas d'évaluer le transport de '{package.title}'"
    else:
        logger.error(f"Type de notification invalide: {notification_type}")
        return False

    context = {
        'package': package,
        'notification_type': notification_type,
        'site': Site.objects.get_current(),
        'user': recipient,
    }

    try:
        html_content = render_to_string(f'colis/emails/package_{notification_type.lower()}.html', context)
        text_content = render_to_string(f'colis/emails/package_{notification_type.lower()}.txt', context)

        email = EmailMultiAlternatives(
            subject=subject,
            body=text_content,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[recipient.email],
            reply_to=[settings.REPLY_TO_EMAIL]
        )
        email.attach_alternative(html_content, "text/html")
        email.send()

        logger.info(f"Notification {notification_type} envoyée pour colis {package_id}")
        return True
    except Exception as e:
        logger.error(f"Erreur envoi notification colis: {e}")
        return False


# ============================================================================
# TÂCHES DE RAPPORT ET ANALYSE
# ============================================================================

@shared_task(name='colis.tasks.generate_package_report')
def generate_package_report(user_id: int, report_type: str, start_date=None, end_date=None):
    """
    Génère un rapport personnalisé pour un utilisateur
    Types: MONTHLY, QUARTERLY, YEARLY, CUSTOM
    """
    try:
        user = User.objects.get(id=user_id)
    except User.DoesNotExist:
        logger.error(f"Utilisateur {user_id} non trouvé")
        return None

    # Déterminer la période
    if not end_date:
        end_date = timezone.now()
    if not start_date:
        if report_type == 'MONTHLY':
            start_date = end_date - timedelta(days=30)
        elif report_type == 'QUARTERLY':
            start_date = end_date - timedelta(days=90)
        elif report_type == 'YEARLY':
            start_date = end_date - timedelta(days=365)
        else:
            start_date = end_date - timedelta(days=30)  # Par défaut

    # Récupérer les données
    packages = Package.objects.filter(
        sender=user,
        created_at__range=[start_date, end_date]
    )

    offers = TransportOffer.objects.filter(
        carrier=user,
        created_at__range=[start_date, end_date]
    )

    # Calculer les statistiques
    report_data = {
        'user': user.username,
        'report_type': report_type,
        'period': {'start': start_date, 'end': end_date},
        'package_stats': {
            'total': packages.count(),
            'available': packages.filter(status='AVAILABLE').count(),
            'reserved': packages.filter(status='RESERVED').count(),
            'delivered': packages.filter(status='DELIVERED').count(),
            'total_price': packages.aggregate(Sum('price'))['price__sum'] or 0,
            'average_price': packages.aggregate(Avg('price'))['price__avg'] or 0,
        },
        'offer_stats': {
            'total': offers.count(),
            'accepted': offers.filter(status='ACCEPTED').count(),
            'pending': offers.filter(status='PENDING').count(),
            'rejected': offers.filter(status='REJECTED').count(),
            'total_value': offers.aggregate(Sum('price'))['price__sum'] or 0,
            'acceptance_rate': (offers.filter(status='ACCEPTED').count() / max(offers.count(), 1)) * 100,
        },
        'popular_categories': packages.values('category__name').annotate(
            count=Count('id')
        ).order_by('-count')[:5],
        'top_destinations': packages.values('country_to', 'city_to').annotate(
            count=Count('id')
        ).order_by('-count')[:5],
    }

    logger.info(f"Rapport généré pour l'utilisateur {user_id}")

    # Option: Envoyer le rapport par email
    # send_report_email.delay(user_id, report_data, report_type)

    return report_data


@shared_task(name='colis.tasks.calculate_carrier_performance')
def calculate_carrier_performance(carrier_id: int = None):
    """
    Calcule les performances d'un transporteur ou de tous les transporteurs
    """
    if carrier_id:
        carriers = Carrier.objects.filter(id=carrier_id)
    else:
        carriers = Carrier.objects.filter(status='APPROVED')

    performance_data = []

    for carrier in carriers:
        # Offres du transporteur
        offers = TransportOffer.objects.filter(carrier=carrier.user)

        # Colis transportés
        packages = Package.objects.filter(carrier=carrier.user)

        # Calcul des métriques
        metrics = {
            'carrier_id': carrier.id,
            'carrier_name': carrier.company_name or carrier.user.username,
            'total_offers': offers.count(),
            'accepted_offers': offers.filter(status='ACCEPTED').count(),
            'offer_acceptance_rate': (offers.filter(status='ACCEPTED').count() / max(offers.count(), 1)) * 100,
            'total_packages': packages.count(),
            'delivered_packages': packages.filter(status='DELIVERED').count(),
            'delivery_success_rate': (packages.filter(status='DELIVERED').count() / max(packages.count(), 1)) * 100,
            'average_rating': carrier.average_rating,
            'total_revenue': offers.filter(status='ACCEPTED').aggregate(
                Sum('price')
            )['price__sum'] or Decimal('0.00'),
            'response_time_avg': None,  # À calculer avec les timestamps
            'last_active': carrier.updated_at,
        }

        performance_data.append(metrics)

        # Mettre à jour les statistiques du transporteur
        carrier.total_missions = metrics['total_packages']
        carrier.completed_missions = metrics['delivered_packages']
        carrier.success_rate = metrics['delivery_success_rate']
        carrier.save(update_fields=['total_missions', 'completed_missions', 'success_rate', 'updated_at'])

    logger.info(f"Performances calculées pour {len(performance_data)} transporteurs")
    return performance_data


# ============================================================================
# TÂCHES DE MAINTENANCE
# ============================================================================

@shared_task(name='colis.tasks.cleanup_old_data')
def cleanup_old_data():
    """
    Nettoie les anciennes données pour optimiser la base
    """
    now = timezone.now()
    cleanup_tasks = []

    # 1. Vues de plus de 30 jours
    old_views = PackageView.objects.filter(
        viewed_at__lt=now - timedelta(days=30)
    )
    views_deleted = old_views.count()
    old_views.delete()

    # 2. Images orphelines (sans package)
    orphan_images = PackageImage.objects.filter(package__isnull=True)
    images_deleted = orphan_images.count()
    orphan_images.delete()

    # 3. Signalements résolus de plus de 90 jours
    old_reports = PackageReport.objects.filter(
        status='RESOLVED',
        resolved_at__lt=now - timedelta(days=90)
    )
    reports_deleted = old_reports.count()
    old_reports.delete()

    # 4. Favoris de colis supprimés
    invalid_favorites = PackageFavorite.objects.filter(
        Q(package__isnull=True) | Q(user__isnull=True)
    )
    favorites_deleted = invalid_favorites.count()
    invalid_favorites.delete()

    results = {
        'views_deleted': views_deleted,
        'images_deleted': images_deleted,
        'reports_deleted': reports_deleted,
        'favorites_deleted': favorites_deleted,
        'total_deleted': views_deleted + images_deleted + reports_deleted + favorites_deleted,
    }

    logger.info(f"Données nettoyées: {results}")
    return results


@shared_task(name='colis.tasks.recalculate_all_volumes')
def recalculate_all_volumes():
    """
    Recalcule les volumes de tous les colis (en cas de bug de calcul)
    """
    packages = Package.objects.filter(
        length__isnull=False,
        width__isnull=False,
        height__isnull=False
    )

    updated_count = 0

    for package in packages:
        # Recalculer le volume
        old_volume = package.volume
        new_volume = (package.length * package.width * package.height) / 1000

        if old_volume != new_volume:
            package.volume = new_volume
            package.save(update_fields=['volume', 'updated_at'])
            updated_count += 1

    logger.info(f"Volumes recalculés: {updated_count}/{packages.count()} mis à jour")
    return {'total': packages.count(), 'updated': updated_count}


@shared_task(name='colis.tasks.update_category_counts')
def update_category_counts():
    """
    Met à jour les compteurs de colis par catégorie
    """
    categories = PackageCategory.objects.all()

    for category in categories:
        # Compter les colis actifs
        active_count = category.packages.filter(status='AVAILABLE').count()

        if category.package_count != active_count:
            category.package_count = active_count
            category.save(update_fields=['package_count', 'updated_at'])

    logger.info(f"Compteurs de catégories mis à jour: {categories.count()} catégories")
    return categories.count()


# ============================================================================
# TÂCHES GROUPÉES ET WORKFLOWS COMPLEXES
# ============================================================================

@shared_task(name='colis.tasks.daily_maintenance_workflow')
def daily_maintenance_workflow():
    """
    Workflow de maintenance quotidienne
    S'exécute une fois par jour
    """
    # Créer un groupe de tâches parallèles
    parallel_tasks = group(
        update_package_statuses.s(),
        process_expired_offers.s(),
        cleanup_old_data.s(),
    )

    # Chaîne de tâches séquentielles après les parallèles
    workflow = chain(
        parallel_tasks,
        calculate_package_statistics.s(),
        update_category_counts.s(),
    )

    result = workflow.apply_async()
    logger.info("Workflow de maintenance quotidienne démarré")
    return result.id


@shared_task(name='colis.tasks.weekly_report_workflow')
def weekly_report_workflow():
    """
    Workflow de rapports hebdomadaires
    """
    # 1. Générer les rapports pour les utilisateurs actifs
    active_users = User.objects.filter(
        is_active=True,
        last_login__gte=timezone.now() - timedelta(days=30)
    ).values_list('id', flat=True)

    # 2. Créer des tâches pour chaque utilisateur (limité aux 100 premiers)
    user_tasks = [generate_package_report.s(user_id, 'WEEKLY') for user_id in active_users[:100]]

    # 3. Exécuter en parallèle
    if user_tasks:
        group(user_tasks).apply_async()

    # 4. Générer les rapports admin
    admin_tasks = chain(
        calculate_carrier_performance.s(),
        calculate_package_statistics.s(),
    )

    admin_tasks.apply_async()

    logger.info(f"Workflow de rapports hebdomadaires démarré pour {len(user_tasks)} utilisateurs")
    return len(user_tasks)


# ============================================================================
# TÂCHES D'INTÉGRATION AVEC AUTRES APPLICATIONS
# ============================================================================

@shared_task(name='colis.tasks.sync_with_carriers_app')
def sync_with_carriers_app():
    """
    Synchronise les données avec l'application carriers
    """
    # Mettre à jour les statistiques des transporteurs basées sur les colis
    carrier_stats = Package.objects.filter(
        carrier__isnull=False,
        status='DELIVERED'
    ).values('carrier').annotate(
        delivered_count=Count('id'),
        total_revenue=Sum('price'),
        avg_rating=Avg('carrier_reviews__rating')
    )

    for stat in carrier_stats:
        carrier_id = stat['carrier']
        try:
            carrier = Carrier.objects.get(user_id=carrier_id)
            carrier.completed_missions = stat['delivered_count']
            # Mettre à jour d'autres champs si nécessaire
            carrier.save(update_fields=['completed_missions', 'updated_at'])
        except Carrier.DoesNotExist:
            continue

    logger.info(f"Données synchronisées avec carriers: {len(carrier_stats)} transporteurs")
    return len(carrier_stats)


@shared_task(name='colis.tasks.create_demo_packages')
def create_demo_packages(count: int = 10, user_id: int = None):
    """
    Crée des colis de démonstration pour le développement
    """
    from faker import Faker
    import random

    fake = Faker('fr_FR')

    # Récupérer l'utilisateur ou le premier admin
    if user_id:
        try:
            user = User.objects.get(id=user_id)
        except User.DoesNotExist:
            user = User.objects.filter(is_staff=True).first()
    else:
        user = User.objects.filter(is_staff=True).first()

    if not user:
        logger.error("Aucun utilisateur trouvé pour créer des colis de démonstration")
        return 0

    # Récupérer des catégories existantes
    categories = PackageCategory.objects.all()[:5]
    if not categories:
        logger.error("Aucune catégorie trouvée")
        return 0

    created_count = 0

    for i in range(count):
        category = random.choice(categories)
        weight = random.uniform(1.0, 100.0)
        price = random.uniform(10.0, 500.0)

        package = Package.objects.create(
            title=fake.sentence(nb_words=6),
            description=fake.paragraph(nb_sentences=3),
            sender=user,
            category=category,
            weight=round(weight, 3),
            length=random.uniform(10.0, 200.0),
            width=random.uniform(10.0, 150.0),
            height=random.uniform(5.0, 100.0),
            price=round(price, 2),
            currency='EUR',
            country_from='FR',
            city_from=fake.city(),
            country_to=random.choice(['MA', 'TN', 'DZ']),
            city_to=fake.city(),
            status=Package.Status.AVAILABLE,
            available_from=timezone.now().date(),
            available_until=timezone.now().date() + timedelta(days=30),
        )

        # Créer quelques images de démonstration
        for j in range(random.randint(1, 3)):
            PackageImage.objects.create(
                package=package,
                image=f"demo/package_{i}_image_{j}.jpg",
                caption=fake.sentence(nb_words=4),
                is_primary=(j == 0),
            )

        created_count += 1

    logger.info(f"Créé {created_count} colis de démonstration")
    return created_count


========== colis/urls.py ==========
# ~/ebi3/colis/urls.py
from django.urls import path, include
from django.views.generic import TemplateView
from django.contrib.auth.decorators import login_required
from django.contrib.sitemaps.views import sitemap
from django.contrib.sitemaps import Sitemap
from . import views

app_name = 'colis'

# Classes de sitemap
class StaticSitemap(Sitemap):
    changefreq = "monthly"
    priority = 0.8

    def items(self):
        return [
            'colis:how_it_works',
            'colis:price_guide',
            'colis:packaging_tips',
            'colis:faq',
            'colis:terms',
        ]

    def location(self, item):
        from django.urls import reverse
        return reverse(item)

class PackageSitemap(Sitemap):
    changefreq = "daily"
    priority = 0.9

    def items(self):
        try:
            from .models import Package
            return Package.objects.filter(status=Package.Status.AVAILABLE).order_by('-created_at')
        except:
            return []

    def lastmod(self, obj):
        return obj.updated_at

class CategorySitemap(Sitemap):
    changefreq = "weekly"
    priority = 0.7

    def items(self):
        try:
            from .models import PackageCategory
            return PackageCategory.objects.filter(is_active=True)
        except:
            return []

class CarrierSitemap(Sitemap):
    changefreq = "weekly"
    priority = 0.6

    def items(self):
        try:
            from carriers.models import Carrier
            return Carrier.objects.filter(status='APPROVED', is_available=True)
        except:
            return []

class XMLIndexSitemap(Sitemap):
    changefreq = "weekly"
    priority = 0.8

    def items(self):
        return []

    def lastmod(self, obj):
        return None

def get_active_sitemaps():
    return {
        'index': XMLIndexSitemap,
        'static': StaticSitemap,
        'packages': PackageSitemap,
        'categories': CategorySitemap,
        'carriers': CarrierSitemap,
    }

# Vue pour sitemap de nouvelles
class NewsSitemapView(TemplateView):
    template_name = 'colis/sitemaps/news_sitemap.xml'
    content_type = 'application/xml'

urlpatterns = [
    # ============================================================================
    # PAGES PUBLIQUES
    # ============================================================================

    # Accueil des colis
    path('', views.PackageListView.as_view(), name='package_list'),

    # Recherche avancée
    path('recherche/', views.search_packages, name='search'),
    path('resultats/', views.PackageListView.as_view(), name='search_results'),

    # Catégories
    path('categories/', views.CategoryListView.as_view(), name='category_list'),
    path('categories/<slug:slug>/', views.CategoryDetailView.as_view(), name='category_detail'),

    # ============================================================================
    # COLIS SPÉCIFIQUES
    # ============================================================================

    # Détail d'un colis
    path('colis/<slug:slug>/', views.PackageDetailView.as_view(), name='package_detail'),

    # Actions sur un colis (authentification requise)
    path('colis/<slug:slug>/modifier/', views.PackageUpdateView.as_view(), name='package_edit'),
    path('colis/<slug:slug>/supprimer/', views.PackageDeleteView.as_view(), name='package_delete'),
    path('colis/<slug:slug>/signaler/', views.PackageReportView.as_view(), name='package_report'),

    # Favoris
    path('colis/<slug:slug>/favori/', views.toggle_package_favorite, name='toggle_favorite'),

    # ============================================================================
    # GESTION DES COLIS (UTILISATEUR)
    # ============================================================================

    # Création
    path('publier/', views.PackageCreateView.as_view(), name='package_create'),

    # Mes colis
    path('mes-colis/', views.MyPackagesListView.as_view(), name='my_packages'),

    # Actions en masse - CORRIGÉ
    path('mes-colis/publication-multiple/', views.bulk_publish_packages, name='bulk_publish'),
    path('mes-colis/expiration-multiple/', views.bulk_expire_packages, name='bulk_expire'),
    path('mes-colis/suppression-multiple/', views.bulk_delete_packages, name='bulk_delete'),
    path('mes-colis/archivage-multiple/', views.bulk_archive_packages, name='bulk_archive'),

    path('mes-favoris/', views.PackageFavoritesListView.as_view(), name='favorite_list'),

    # Gestion avancée
    path('colis/<slug:slug>/gestion/', views.package_management, name='package_management'),
    path('statistiques/', views.PackageStatisticsView.as_view(), name='package_statistics'),

    # ============================================================================
    # OFFRES DE TRANSPORT
    # ============================================================================

    # Faire une offre
    path('colis/<slug:slug>/offre/creer/', views.TransportOfferCreateView.as_view(), name='offer_create'),

    # Mes offres
    path('mes-offres/', views.MyTransportOffersListView.as_view(), name='my_offers'),

    # Actions sur les offres
    path('offres/<int:pk>/accepter/', views.accept_transport_offer, name='accept_offer'),
    path('offres/<int:pk>/rejeter/', views.reject_transport_offer, name='reject_offer'),
    path('offres/<int:pk>/annuler/', views.cancel_transport_offer, name='cancel_offer'),

    # ============================================================================
    # ESPACE TRANSPORTEUR
    # ============================================================================

    # Colis disponibles
    path('transporteur/colis-disponibles/', views.AvailablePackagesView.as_view(), name='available_packages'),

    # Tableau de bord transporteur
    path('transporteur/dashboard/', views.CarrierDashboardView.as_view(), name='carrier_dashboard'),

    # Devis rapide
    path('transporteur/devis-rapide/', views.quick_quote, name='quick_quote'),

    # ============================================================================
    # API ET FONCTIONNALITÉS AJAX
    # ============================================================================

    # Mise à jour de statut
    path('api/colis/<slug:slug>/statut/<str:status>/', views.update_package_status, name='update_status'),

    # Statistiques
    path('api/colis/<slug:slug>/statistiques/', views.package_stats, name='package_stats'),

    # ============================================================================
    # PAGES D'AIDE ET INFORMATION
    # ============================================================================

    # Comment ça marche
    path('comment-ca-marche/', TemplateView.as_view(template_name='colis/how_it_works.html'), name='how_it_works'),

    # Guide des prix
    path('guide-des-prix/', TemplateView.as_view(template_name='colis/price_guide.html'), name='price_guide'),

    # Conseils d'emballage
    path('conseils-emballage/', TemplateView.as_view(template_name='colis/packaging_tips.html'), name='packaging_tips'),

    # FAQ
    path('faq/', TemplateView.as_view(template_name='colis/faq.html'), name='faq'),

    # Conditions générales
    path('conditions-generales/', TemplateView.as_view(template_name='colis/terms.html'), name='terms'),

    path('politique-de-confidentialite/', TemplateView.as_view(template_name='colis/privacy.html'), name='privacy'),

    # ============================================================================
    # REDIRECTIONS ET URLS ALIAS
    # ============================================================================

    # Alias pour compatibilité
    path('annonces/', views.PackageListView.as_view(), name='ads'),  # Compatibilité avec anciens liens
    path('demandes/', views.PackageListView.as_view(), name='requests'),

    # Redirection transporteur
    path('devenir-transporteur/', TemplateView.as_view(template_name='colis/become_carrier.html'), name='become_carrier'),

    # ============================================================================
    # PAGES SPÉCIALES
    # ============================================================================

    # Succès stories
    path('success-stories/', TemplateView.as_view(template_name='colis/success_stories.html'), name='success_stories'),

    # Témoignages
    path('temoignages/', TemplateView.as_view(template_name='colis/testimonials.html'), name='testimonials'),

    # Blog
    path('blog/', TemplateView.as_view(template_name='colis/blog.html'), name='blog'),
    path('blog/category/<slug:slug>/', TemplateView.as_view(template_name='colis/blog_category.html'), name='blog_category'),
    path('blog/article/<slug:slug>/', TemplateView.as_view(template_name='colis/blog_post.html'), name='blog_post'),

    # ============================================================================
    # SITEMAPS
    # ============================================================================

    path('sitemap.xml', sitemap, {'sitemaps': get_active_sitemaps()},
         name='django.contrib.sitemaps.views.sitemap'),

    # Sitemaps individuels
    path('sitemap_index.xml', sitemap,
         {'sitemaps': {'index': XMLIndexSitemap()}},
         name='colis_sitemap_index'),

    path('sitemap_static.xml', sitemap,
         {'sitemaps': {'static': StaticSitemap()}},
         name='colis_sitemap_static'),

    path('sitemap_packages.xml', sitemap,
         {'sitemaps': {'packages': PackageSitemap()}},
         name='colis_sitemap_packages'),

    path('sitemap_categories.xml', sitemap,
         {'sitemaps': {'categories': CategorySitemap()}},
         name='colis_sitemap_categories'),

    path('sitemap_carriers.xml', sitemap,
         {'sitemaps': {'carriers': CarrierSitemap()}},
         name='colis_sitemap_carriers'),

    # Sitemap pour Google News (si applicable)
    path('news-sitemap.xml', NewsSitemapView.as_view(),
         name='colis_news_sitemap'),
]

# ============================================================================
# URLS API (versionnée)
# ============================================================================

api_urlpatterns = [
    # Version 1 de l'API
    path('v1/', include([
        # Colis
        path('packages/', views.PackageListView.as_view(), name='api_package_list'),
        path('packages/<slug:slug>/', views.PackageDetailView.as_view(), name='api_package_detail'),

        # Offres
        path('offers/', views.MyTransportOffersListView.as_view(), name='api_offer_list'),
        path('offers/create/', views.TransportOfferCreateView.as_view(), name='api_offer_create'),

        # Utilisateur
        path('user/packages/', views.MyPackagesListView.as_view(), name='api_user_packages'),
        path('user/favorites/', views.PackageFavoritesListView.as_view(), name='api_user_favorites'),

        # Transporteur
        path('carrier/available-packages/', views.AvailablePackagesView.as_view(), name='api_available_packages'),
        path('carrier/dashboard/', views.CarrierDashboardView.as_view(), name='api_carrier_dashboard'),

        # Recherche
        path('search/', views.search_packages, name='api_search'),

        # Catégories
        path('categories/', views.CategoryListView.as_view(), name='api_category_list'),
        path('categories/<slug:slug>/', views.CategoryDetailView.as_view(), name='api_category_detail'),
    ])),
]

# Ajouter les URLs API au pattern principal
urlpatterns += [
    path('api/', include(api_urlpatterns)),
]

# ============================================================================
# URLS D'ADMINISTRATION (si besoin de personnalisation)
# ============================================================================

admin_urlpatterns = [
    # Statistiques admin
    path('admin-stats/', login_required(TemplateView.as_view(template_name='colis/admin_stats.html')),
         name='admin_stats'),

    # Export de données
    path('export/csv/', login_required(TemplateView.as_view(template_name='colis/export_csv.html')),
         name='export_csv'),

    # Modération
    path('moderation/reports/', login_required(TemplateView.as_view(template_name='colis/moderation_reports.html')),
         name='moderation_reports'),
]

# Ajouter les URLs admin (protégées par login_required)
urlpatterns += [
    path('admin-tools/', include((admin_urlpatterns, 'admin_tools'))),
]

# ============================================================================
# URLS MOBILES (pour applications natives)
# ============================================================================

mobile_urlpatterns = [
    # Authentification mobile
    path('auth/login/', TemplateView.as_view(template_name='colis/mobile/login.html'), name='mobile_login'),
    path('auth/register/', TemplateView.as_view(template_name='colis/mobile/register.html'), name='mobile_register'),

    # Dashboard mobile
    path('dashboard/', TemplateView.as_view(template_name='colis/mobile/dashboard.html'), name='mobile_dashboard'),

    # Scanner QR code
    path('scanner/', TemplateView.as_view(template_name='colis/mobile/scanner.html'), name='mobile_scanner'),

    # Notifications
    path('notifications/', TemplateView.as_view(template_name='colis/mobile/notifications.html'), name='mobile_notifications'),
]

# Ajouter les URLs mobiles
urlpatterns += [
    path('mobile/', include((mobile_urlpatterns, 'mobile'))),
]

# ============================================================================
# URLS DE TEST ET DÉVELOPPEMENT
# ============================================================================

# Ces URLs ne sont actives qu'en mode DEBUG
from django.conf import settings

if settings.DEBUG:
    debug_urlpatterns = [
        # Pages de test
        path('test/package-card/', TemplateView.as_view(template_name='colis/test/package_card.html'),
             name='test_package_card'),
        path('test/offer-card/', TemplateView.as_view(template_name='colis/test/offer_card.html'),
             name='test_offer_card'),
        path('test/search-filters/', TemplateView.as_view(template_name='colis/test/search_filters.html'),
             name='test_search_filters'),

        # Données de test
        path('test-data/generate/', TemplateView.as_view(template_name='colis/test/generate_data.html'),
             name='test_generate_data'),

        # Composants UI
        path('ui/components/', TemplateView.as_view(template_name='colis/test/ui_components.html'),
             name='ui_components'),
    ]

    urlpatterns += [
        path('test/', include((debug_urlpatterns, 'test'))),
    ]

# ============================================================================
# URLS DE WEBHOOKS ET INTÉGRATIONS EXTERNES
# ============================================================================

webhook_urlpatterns = [
    # Webhook Stripe (paiements)
    path('stripe/', TemplateView.as_view(template_name='colis/webhooks/stripe.html'), name='webhook_stripe'),

    # Webhook Google Maps (géocodage)
    path('google-maps/', TemplateView.as_view(template_name='colis/webhooks/google_maps.html'), name='webhook_google_maps'),

    # Webhook SendGrid (emails)
    path('sendgrid/', TemplateView.as_view(template_name='colis/webhooks/sendgrid.html'), name='webhook_sendgrid'),

    # Webhook Twilio (SMS)
    path('twilio/', TemplateView.as_view(template_name='colis/webhooks/twilio.html'), name='webhook_twilio'),
]

urlpatterns += [
    path('webhooks/', include((webhook_urlpatterns, 'webhooks'))),
]

# ============================================================================
# URLS DE GÉOLOCALISATION
# ============================================================================

geolocation_urlpatterns = [
    # Recherche par localisation
    path('near-me/', TemplateView.as_view(template_name='colis/geolocation/near_me.html'), name='near_me'),

    # Calcul d'itinéraire
    path('route/', TemplateView.as_view(template_name='colis/geolocation/route.html'), name='route_calculation'),

    # Carte interactive
    path('map/', TemplateView.as_view(template_name='colis/geolocation/map.html'), name='interactive_map'),
]

urlpatterns += [
    path('location/', include((geolocation_urlpatterns, 'geolocation'))),
]

# ============================================================================
# URLS DE SUIVI ET TRACKING
# ============================================================================

tracking_urlpatterns = [
    # Suivi de colis
    path('<str:tracking_number>/', TemplateView.as_view(template_name='colis/tracking/tracking.html'),
         name='track_package'),

    # Historique de suivi
    path('<str:tracking_number>/history/',
         TemplateView.as_view(template_name='colis/tracking/history.html'), name='tracking_history'),

    # Notifications de suivi
    path('<str:tracking_number>/notifications/',
         TemplateView.as_view(template_name='colis/tracking/notifications.html'), name='tracking_notifications'),
]

urlpatterns += [
    path('track/', include((tracking_urlpatterns, 'tracking'))),
]

# ============================================================================
# URLS DE COMPATIBILITÉ ET REDIRECTIONS
# ============================================================================

# Redirections pour l'ancienne structure d'URLs
from django.views.generic.base import RedirectView

legacy_redirects = [
    # Anciennes URLs vers nouvelles
    path('ads/', RedirectView.as_view(pattern_name='colis:package_list', permanent=True)),
    path('ads/<slug:slug>/', RedirectView.as_view(pattern_name='colis:package_detail', permanent=True)),
    path('demandes/', RedirectView.as_view(pattern_name='colis:package_list', permanent=True)),
    path('demandes/<slug:slug>/', RedirectView.as_view(pattern_name='colis:package_detail', permanent=True)),

    # URLs raccourcies
    path('p/<slug:slug>/', RedirectView.as_view(pattern_name='colis:package_detail', permanent=True)),
    path('c/<slug:slug>/', RedirectView.as_view(pattern_name='colis:package_detail', permanent=True)),
]

urlpatterns += legacy_redirects

# ============================================================================
# FEEDS RSS
# ============================================================================

from django.contrib.syndication.views import Feed
from .models import Package

class LatestPackagesFeed(Feed):
    title = "Derniers colis disponibles sur Ebi3"
    link = "/colis/"
    description = "Nouveaux colis disponibles pour transport"

    def items(self):
        try:
            return Package.objects.filter(status=Package.Status.AVAILABLE).order_by('-created_at')[:20]
        except:
            return []

    def item_title(self, item):
        return item.title

    def item_description(self, item):
        return f"{item.description[:200]}... - {item.pickup_city} → {item.delivery_city}"

    def item_link(self, item):
        return item.get_absolute_url()

urlpatterns += [
    path('feed/rss/', LatestPackagesFeed(), name='package_feed'),
]

# ============================================================================
# ERROR HANDLERS (si besoin de personnalisation)
# ============================================================================

handler404 = 'colis.views.custom_404'
handler500 = 'colis.views.custom_500'

# ============================================================================
# URLS DE MAINTENANCE
# ============================================================================

maintenance_urlpatterns = [
    # Page de maintenance
    path('maintenance/', TemplateView.as_view(template_name='colis/maintenance.html'), name='maintenance'),

    # Status de l'API
    path('status/', TemplateView.as_view(template_name='colis/status.html'), name='api_status'),

    # Health check
    path('health/', TemplateView.as_view(template_name='colis/health.html'), name='health_check'),
]

urlpatterns += [
    path('system/', include((maintenance_urlpatterns, 'system'))),
]

# ============================================================================
# URLS DE DÉMONSTRATION (pour présentation)
# ============================================================================

demo_urlpatterns = [
    # Démo complète
    path('demo/', TemplateView.as_view(template_name='colis/demo/full_demo.html'), name='full_demo'),

    # Démo expéditeur
    path('demo/sender/', TemplateView.as_view(template_name='colis/demo/sender_demo.html'), name='sender_demo'),

    # Démo transporteur
    path('demo/carrier/', TemplateView.as_view(template_name='colis/demo/carrier_demo.html'), name='carrier_demo'),

    # Démo admin
    path('demo/admin/', TemplateView.as_view(template_name='colis/demo/admin_demo.html'), name='admin_demo'),
]

urlpatterns += [
    path('demo/', include((demo_urlpatterns, 'demo'))),
]

# ============================================================================
# URLS DE DOCUMENTATION
# ============================================================================

docs_urlpatterns = [
    # Documentation API
    path('api/', TemplateView.as_view(template_name='colis/docs/api_docs.html'), name='api_docs'),
    path('api/v1/', TemplateView.as_view(template_name='colis/docs/api_v1.html'), name='api_v1_docs'),

    # Documentation développeur
    path('developer/', TemplateView.as_view(template_name='colis/docs/developer.html'), name='developer_docs'),
    path('developer/integration/', TemplateView.as_view(template_name='colis/docs/integration.html'),
         name='integration_docs'),

    # Documentation transporteur
    path('carrier/', TemplateView.as_view(template_name='colis/docs/carrier.html'), name='carrier_docs'),

    # Documentation expéditeur
    path('sender/', TemplateView.as_view(template_name='colis/docs/sender.html'), name='sender_docs'),
]

urlpatterns += [
    path('docs/', include((docs_urlpatterns, 'docs'))),
]


========== colis/models.py ==========
# ~/ebi3/colis/models.py
from django.db import models
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import ValidationError
from django.utils.text import slugify
from django.urls import reverse
from django.utils import timezone
from django.core.validators import FileExtensionValidator
import os
import uuid
from mptt.models import MPTTModel, TreeForeignKey
from django_countries.fields import CountryField

# Validateurs personnalisés
def validate_file_size(value):
    """Validateur pour la taille maximale des fichiers (10MB)"""
    filesize = value.size
    max_size = 10 * 1024 * 1024  # 10MB
    if filesize > max_size:
        raise ValidationError(
            _(f'La taille du fichier ne doit pas dépasser {max_size / (1024 * 1024):.0f}MB')
        )

class PackageCategory(MPTTModel):
    """Catégories de colis (hiérarchique)"""
    name = models.CharField(
        max_length=200,
        verbose_name=_("Nom de la catégorie"),
        db_index=True
    )
    slug = models.SlugField(
        max_length=200,
        unique=True,
        verbose_name=_("Slug"),
        help_text=_("Version URL-friendly du nom")
    )
    description = models.TextField(
        blank=True,
        verbose_name=_("Description"),
        help_text=_("Description détaillée de la catégorie")
    )
    parent = TreeForeignKey(
        'self',
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='children',
        verbose_name=_("Catégorie parente"),
        help_text=_("Sélectionnez une catégorie parente si applicable")
    )
    icon = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Icône FontAwesome"),
        help_text=_("Exemple: fa-box, fa-couch, fa-tshirt")
    )
    image = models.ImageField(
        upload_to='colis/categories/',
        null=True,
        blank=True,
        verbose_name=_("Image de la catégorie")
    )
    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Active"),
        help_text=_("Désactiver pour cacher la catégorie")
    )
    show_in_menu = models.BooleanField(
        default=True,
        verbose_name=_("Afficher dans le menu")
    )
    display_order = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Ordre d'affichage"),
        help_text=_("Plus le nombre est bas, plus c'est prioritaire")
    )
    requires_dimensions = models.BooleanField(
        default=True,
        verbose_name=_("Requiert dimensions"),
        help_text=_("Les colis de cette catégorie doivent avoir des dimensions")
    )
    requires_weight = models.BooleanField(
        default=True,
        verbose_name=_("Requiert poids"),
        help_text=_("Les colis de cette catégorie doivent avoir un poids")
    )
    meta_title = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Titre SEO")
    )
    meta_description = models.TextField(
        blank=True,
        verbose_name=_("Description SEO")
    )
    package_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre de colis")
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class MPTTMeta:
        order_insertion_by = ['display_order', 'name']

    class Meta:
        verbose_name = _("Catégorie de colis")
        verbose_name_plural = _("Catégories de colis")
        ordering = ['display_order', 'name']
        indexes = [
            models.Index(fields=['slug', 'is_active']),
            models.Index(fields=['parent', 'is_active']),
        ]

    def __str__(self):
        return self.name

    def get_absolute_url(self):
        return reverse('colis:category_detail', kwargs={'slug': self.slug})

    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(self.name)
        super().save(*args, **kwargs)

    def get_full_path(self):
        ancestors = self.get_ancestors(include_self=True)
        return " > ".join([cat.name for cat in ancestors])

    def update_package_count(self):
        """Met à jour le compteur de colis"""
        count = self.packages.filter(status=Package.Status.AVAILABLE).count()
        PackageCategory.objects.filter(pk=self.pk).update(package_count=count)


class Package(models.Model):
    """Modèle principal pour un colis (équivalent Cocolis)"""

    class Status(models.TextChoices):
        DRAFT = 'DRAFT', _('Brouillon')
        AVAILABLE = 'AVAILABLE', _('Disponible')
        RESERVED = 'RESERVED', _('Réservé')
        IN_TRANSIT = 'IN_TRANSIT', _('En transit')
        DELIVERED = 'DELIVERED', _('Livré')
        CANCELLED = 'CANCELLED', _('Annulé')
        EXPIRED = 'EXPIRED', _('Expiré')

    class PackageType(models.TextChoices):
        SMALL_PACKAGE = 'SMALL_PACKAGE', _('Petit colis (< 30kg)')
        MEDIUM_PACKAGE = 'MEDIUM_PACKAGE', _('Colis moyen (30-100kg)')
        LARGE_PACKAGE = 'LARGE_PACKAGE', _('Gros colis (100-500kg)')
        FURNITURE = 'FURNITURE', _('Meuble')
        PALLET = 'PALLET', _('Palette')
        VEHICLE_PART = 'VEHICLE_PART', _('Pièce auto')
        OTHER = 'OTHER', _('Autre')

    class PriceType(models.TextChoices):
        FIXED = 'FIXED', _('Prix fixe')
        NEGOTIABLE = 'NEGOTIABLE', _('Prix négociable')
        AUCTION = 'AUCTION', _('Mise aux enchères')

    # Informations de base
    sender = models.ForeignKey(
        'users.User',
        on_delete=models.CASCADE,
        related_name='sent_packages',
        verbose_name=_("Expéditeur")
    )
    category = TreeForeignKey(
        PackageCategory,
        on_delete=models.SET_NULL,
        null=True,
        related_name='packages',
        verbose_name=_("Catégorie")
    )
    title = models.CharField(
        max_length=200,
        verbose_name=_("Titre du colis"),
        db_index=True
    )
    slug = models.SlugField(
        max_length=200,
        unique=True,
        db_index=True,
        verbose_name=_("Slug")
    )
    description = models.TextField(
        verbose_name=_("Description détaillée"),
        help_text=_("Décrivez votre colis en détail")
    )
    package_type = models.CharField(
        max_length=20,
        choices=PackageType.choices,
        verbose_name=_("Type de colis")
    )

    # Dimensions et poids
    weight = models.DecimalField(
        max_digits=8,
        decimal_places=3,
        verbose_name=_("Poids (kg)"),
        help_text=_("Poids en kilogrammes")
    )
    length = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        verbose_name=_("Longueur (cm)")
    )
    width = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        verbose_name=_("Largeur (cm)")
    )
    height = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        verbose_name=_("Hauteur (cm)")
    )
    volume = models.DecimalField(
        max_digits=10,
        decimal_places=3,
        null=True,
        blank=True,
        editable=False,
        verbose_name=_("Volume (L)")
    )

    # Origine et destination
    pickup_country = CountryField(
        verbose_name=_("Pays de départ"),
        help_text=_("Pays où se trouve le colis")
    )
    pickup_city = models.CharField(
        max_length=100,
        verbose_name=_("Ville de départ")
    )
    pickup_address = models.TextField(
        blank=True,
        verbose_name=_("Adresse de départ")
    )
    pickup_postal_code = models.CharField(
        max_length=20,
        blank=True,
        verbose_name=_("Code postal départ")
    )
    pickup_latitude = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Latitude départ")
    )
    pickup_longitude = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Longitude départ")
    )

    delivery_country = CountryField(
        verbose_name=_("Pays de destination"),
        help_text=_("Pays où le colis doit être livré")
    )
    delivery_city = models.CharField(
        max_length=100,
        verbose_name=_("Ville de destination")
    )
    delivery_address = models.TextField(
        blank=True,
        verbose_name=_("Adresse de destination")
    )
    delivery_postal_code = models.CharField(
        max_length=20,
        blank=True,
        verbose_name=_("Code postal destination")
    )
    delivery_latitude = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Latitude destination")
    )
    delivery_longitude = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Longitude destination")
    )

    # Dates
    pickup_date = models.DateField(
        verbose_name=_("Date de départ souhaitée"),
        help_text=_("Date à laquelle le colis est disponible")
    )
    delivery_date = models.DateField(
        verbose_name=_("Date de livraison souhaitée"),
        help_text=_("Date limite de livraison")
    )
    flexible_dates = models.BooleanField(
        default=False,
        verbose_name=_("Dates flexibles"),
        help_text=_("Accepte des dates différentes de celles demandées")
    )

    # Prix
    price_type = models.CharField(
        max_length=20,
        choices=PriceType.choices,
        default=PriceType.NEGOTIABLE,
        verbose_name=_("Type de prix")
    )
    asking_price = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_("Prix demandé"),
        help_text=_("Prix en devise de départ")
    )
    currency = models.CharField(
        max_length=3,
        default='EUR',
        choices=[
            ('EUR', '€'),
            ('USD', '$'),
            ('GBP', '£'),
            ('MAD', 'DH'),
            ('XOF', 'CFA'),
        ],
        verbose_name=_("Devise")
    )
    estimated_distance = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        null=True,
        blank=True,
        verbose_name=_("Distance estimée (km)")
    )

    # Options et caractéristiques
    is_fragile = models.BooleanField(
        default=False,
        verbose_name=_("Fragile")
    )
    requires_insurance = models.BooleanField(
        default=False,
        verbose_name=_("Requiert assurance")
    )
    insurance_value = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        null=True,
        blank=True,
        verbose_name=_("Valeur à assurer")
    )
    requires_packaging = models.BooleanField(
        default=False,
        verbose_name=_("Requiert emballage")
    )
    requires_loading_help = models.BooleanField(
        default=False,
        verbose_name=_("Requiert aide au chargement")
    )
    requires_unloading_help = models.BooleanField(
        default=False,
        verbose_name=_("Requiert aide au déchargement")
    )

    # Statut et métadonnées
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.DRAFT,
        verbose_name=_("Statut"),
        db_index=True
    )
    is_featured = models.BooleanField(
        default=False,
        verbose_name=_("Colis en vedette")
    )
    featured_until = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("En vedette jusqu'au")
    )

    # SEO
    meta_keywords = models.CharField(
        max_length=500,
        blank=True,
        verbose_name=_("Mots-clés SEO")
    )
    meta_description = models.TextField(
        blank=True,
        verbose_name=_("Description SEO")
    )

    # Statistiques
    view_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre de vues")
    )
    offer_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre d'offres")
    )
    favorite_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre de favoris")
    )

    # Limites de publication
    free_images_allowed = models.PositiveIntegerField(
        default=5,
        verbose_name=_("Nombre de photos gratuites")
    )
    paid_images_used = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Photos payantes utilisées")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True, db_index=True)
    updated_at = models.DateTimeField(auto_now=True, db_index=True)
    published_at = models.DateTimeField(null=True, blank=True)
    expired_at = models.DateTimeField(null=True, blank=True)
    reserved_at = models.DateTimeField(null=True, blank=True)
    delivered_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        verbose_name = _("Colis")
        verbose_name_plural = _("Colis")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status', 'created_at']),
            models.Index(fields=['sender', 'status']),
            models.Index(fields=['pickup_country', 'delivery_country']),
            models.Index(fields=['pickup_date', 'delivery_date']),
            models.Index(fields=['package_type', 'status']),
            models.Index(fields=['asking_price', 'status']),
        ]
        permissions = [
            ('can_feature_package', 'Peut mettre en vedette un colis'),
            ('can_moderate_package', 'Peut modérer les colis'),
        ]

    def __str__(self):
        return f"{self.title} - {self.sender.username}"

    def save(self, *args, **kwargs):
        # Génération automatique du slug
        if not self.slug:
            base_slug = slugify(self.title)
            self.slug = base_slug
            counter = 1
            while Package.objects.filter(slug=self.slug).exists():
                self.slug = f"{base_slug}-{counter}"
                counter += 1

        # Calcul automatique du volume
        if self.length and self.width and self.height:
            self.volume = (self.length * self.width * self.height) / 1000

        # Mise à jour des dates de statut
        if self.status == self.Status.AVAILABLE and not self.published_at:
            self.published_at = timezone.now()

        if self.status == self.Status.RESERVED and not self.reserved_at:
            self.reserved_at = timezone.now()

        if self.status == self.Status.DELIVERED and not self.delivered_at:
            self.delivered_at = timezone.now()

        # Vérification d'expiration
        if self.delivery_date and self.delivery_date < timezone.now().date():
            if self.status == self.Status.AVAILABLE:
                self.status = self.Status.EXPIRED
                self.expired_at = timezone.now()

        super().save(*args, **kwargs)

        # Mise à jour du compteur de catégorie
        if self.category:
            self.category.update_package_count()

    def get_absolute_url(self):
        return reverse('colis:package_detail', kwargs={'slug': self.slug})

    def get_price_with_currency(self):
        return f"{self.asking_price} {self.get_currency_display()}"

    def calculate_free_images_remaining(self):
        return max(0, self.free_images_allowed - self.images.filter(is_paid=False).count())

    def is_available_for_offers(self):
        return self.status == self.Status.AVAILABLE

    def can_be_reserved(self, user):
        """Vérifie si un utilisateur peut réserver ce colis"""
        if user == self.sender:
            return False
        if self.status != self.Status.AVAILABLE:
            return False
        return True

    def get_estimated_price_range(self):
        """Retourne une fourchette de prix estimée basée sur la distance et le volume"""
        # Logique simplifiée - à améliorer avec des algorithmes réels
        if self.estimated_distance and self.volume:
            base_price_per_km = 0.5  # € par km
            base_price_per_volume = 10  # € par m³

            estimated_price = (
                self.estimated_distance * base_price_per_km +
                float(self.volume) / 1000 * base_price_per_volume
            )

            return {
                'min': round(estimated_price * 0.8, 2),
                'max': round(estimated_price * 1.2, 2),
                'average': round(estimated_price, 2)
            }
        return None

    def get_distance_display(self):
        """Affiche la distance de manière lisible"""
        if self.estimated_distance:
            if self.estimated_distance < 1:
                return f"{self.estimated_distance * 1000:.0f} m"
            return f"{self.estimated_distance:.1f} km"
        return _("Distance non calculée")


def package_image_upload_path(instance, filename):
    """Chemin de sauvegarde pour les images de colis"""
    ext = filename.split('.')[-1]
    filename = f"{uuid.uuid4()}.{ext}"
    return f"colis/{instance.package.sender.username}/{instance.package.slug}/images/{filename}"


class PackageImage(models.Model):
    """Images associées à un colis"""
    package = models.ForeignKey(
        Package,
        on_delete=models.CASCADE,
        related_name='images',
        verbose_name=_("Colis")
    )
    image = models.ImageField(
        upload_to=package_image_upload_path,
        verbose_name=_("Image"),
        validators=[
            FileExtensionValidator(['jpg', 'jpeg', 'png', 'webp']),
            validate_file_size,
        ]
    )
    thumbnail = models.ImageField(
        upload_to='colis/thumbnails/',
        null=True,
        blank=True,
        editable=False,
        verbose_name=_("Miniature")
    )
    caption = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Légende")
    )
    is_primary = models.BooleanField(
        default=False,
        verbose_name=_("Image principale")
    )
    display_order = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Ordre d'affichage")
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Image de colis")
        verbose_name_plural = _("Images de colis")
        ordering = ['is_primary', 'display_order', 'created_at']
        constraints = [
            models.UniqueConstraint(
                fields=['package'],
                condition=models.Q(is_primary=True),
                name='unique_primary_image_per_package'
            )
        ]

    def __str__(self):
        return f"Image pour {self.package.title}"

    def save(self, *args, **kwargs):
        if not self.package.images.exists() and not self.is_primary:
            self.is_primary = True
        if self.is_primary:
            PackageImage.objects.filter(package=self.package, is_primary=True).exclude(pk=self.pk).update(is_primary=False)
        super().save(*args, **kwargs)


class TransportOffer(models.Model):
    """Offre de transport pour un colis (comme Cocolis)"""

    class Status(models.TextChoices):
        PENDING = 'PENDING', _('En attente')
        ACCEPTED = 'ACCEPTED', _('Acceptée')
        REJECTED = 'REJECTED', _('Rejetée')
        CANCELLED = 'CANCELLED', _('Annulée')
        EXPIRED = 'EXPIRED', _('Expirée')

    package = models.ForeignKey(
        Package,
        on_delete=models.CASCADE,
        related_name='transport_offers',
        verbose_name=_("Colis")
    )
    carrier = models.ForeignKey(
        'carriers.Carrier',
        on_delete=models.CASCADE,
        related_name='transport_offers',
        verbose_name=_("Transporteur")
    )
    price = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_("Prix proposé")
    )
    currency = models.CharField(
        max_length=3,
        default='EUR',
        choices=[
            ('EUR', '€'),
            ('USD', '$'),
            ('GBP', '£'),
            ('MAD', 'DH'),
            ('XOF', 'CFA'),
        ],
        verbose_name=_("Devise")
    )
    proposed_pickup_date = models.DateField(
        verbose_name=_("Date de départ proposée")
    )
    proposed_delivery_date = models.DateField(
        verbose_name=_("Date de livraison proposée")
    )
    message = models.TextField(
        blank=True,
        verbose_name=_("Message au vendeur"),
        help_text=_("Expliquez pourquoi vous êtes le bon transporteur")
    )
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.PENDING,
        verbose_name=_("Statut")
    )

    # Informations supplémentaires
    provides_insurance = models.BooleanField(
        default=False,
        verbose_name=_("Fournit assurance")
    )
    insurance_coverage = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        null=True,
        blank=True,
        verbose_name=_("Couverture d'assurance")
    )
    provides_packaging = models.BooleanField(
        default=False,
        verbose_name=_("Fournit emballage")
    )
    provides_loading = models.BooleanField(
        default=False,
        verbose_name=_("Fournit chargement")
    )
    provides_unloading = models.BooleanField(
        default=False,
        verbose_name=_("Fournit déchargement")
    )

    # Suivi
    rejection_reason = models.TextField(
        blank=True,
        verbose_name=_("Raison du refus")
    )
    accepted_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Accepté le")
    )
    expires_at = models.DateTimeField(
        verbose_name=_("Expire le"),
        help_text=_("Date d'expiration de l'offre")
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Offre de transport")
        verbose_name_plural = _("Offres de transport")
        ordering = ['-created_at']
        unique_together = ['package', 'carrier']
        indexes = [
            models.Index(fields=['package', 'status']),
            models.Index(fields=['carrier', 'status']),
            models.Index(fields=['status', 'expires_at']),
        ]

    def __str__(self):
        return f"Offre #{self.id} pour {self.package.title}"

    def save(self, *args, **kwargs):
        # Définir la date d'expiration par défaut (72h)
        if not self.expires_at:
            self.expires_at = timezone.now() + timezone.timedelta(hours=72)

        # Mettre à jour le compteur d'offres du colis
        if not self.pk:  # Nouvelle offre
            super().save(*args, **kwargs)
            self.package.offer_count = self.package.transport_offers.count()
            self.package.save(update_fields=['offer_count'])
        else:
            super().save(*args, **kwargs)

        # Si l'offre est acceptée, marquer le colis comme réservé
        if self.status == self.Status.ACCEPTED and not self.accepted_at:
            self.accepted_at = timezone.now()
            self.package.status = Package.Status.RESERVED
            self.package.reserved_at = timezone.now()
            self.package.save(update_fields=['status', 'reserved_at'])

            # Rejeter automatiquement les autres offres en attente
            TransportOffer.objects.filter(
                package=self.package,
                status=self.Status.PENDING
            ).exclude(pk=self.pk).update(
                status=self.Status.REJECTED,
                rejection_reason=_("Une autre offre a été acceptée")
            )

    def is_expired(self):
        """Vérifie si l'offre a expiré"""
        return timezone.now() > self.expires_at

    def can_be_accepted(self):
        """Vérifie si l'offre peut être acceptée"""
        return (
            self.status == self.Status.PENDING and
            not self.is_expired() and
            self.package.status == Package.Status.AVAILABLE
        )


class PackageView(models.Model):
    """Suivi des vues de colis pour les statistiques"""
    package = models.ForeignKey(
        Package,
        on_delete=models.CASCADE,
        related_name='views_tracking',
        verbose_name=_("Colis")
    )
    user = models.ForeignKey(
        'users.User',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='package_views',
        verbose_name=_("Utilisateur")
    )
    session_key = models.CharField(
        max_length=40,
        db_index=True,
        verbose_name=_("Clé de session")
    )
    ip_address = models.GenericIPAddressField(
        null=True,
        blank=True,
        verbose_name=_("Adresse IP")
    )
    user_agent = models.TextField(
        blank=True,
        verbose_name=_("User Agent")
    )
    referer = models.URLField(
        blank=True,
        verbose_name=_("Referer")
    )
    viewed_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Vue de colis")
        verbose_name_plural = _("Vues de colis")
        indexes = [
            models.Index(fields=['package', 'viewed_at']),
            models.Index(fields=['session_key', 'package']),
            models.Index(fields=['user', 'viewed_at']),
        ]

    def __str__(self):
        return f"Vue de {self.package.title} à {self.viewed_at}"


class PackageFavorite(models.Model):
    """Favoris des colis"""
    user = models.ForeignKey(
        'users.User',
        on_delete=models.CASCADE,
        related_name='package_favorites',
        verbose_name=_("Utilisateur")
    )
    package = models.ForeignKey(
        Package,
        on_delete=models.CASCADE,
        related_name='favorited_by',
        verbose_name=_("Colis")
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Colis favori")
        verbose_name_plural = _("Colis favoris")
        unique_together = ['user', 'package']
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.user.username} aime {self.package.title}"

    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)
        self.package.favorite_count = self.package.favorited_by.count()
        self.package.save(update_fields=['favorite_count'])

    def delete(self, *args, **kwargs):
        package = self.package
        super().delete(*args, **kwargs)
        package.favorite_count = package.favorited_by.count()
        package.save(update_fields=['favorite_count'])


class PackageReport(models.Model):
    """Signalement de colis inappropriés"""

    class ReportReason(models.TextChoices):
        SPAM = 'SPAM', _('Spam ou publicité')
        FRAUD = 'FRAUD', _('Fraude ou arnaque')
        INAPPROPRIATE = 'INAPPROPRIATE', _('Contenu inapproprié')
        WRONG_CATEGORY = 'WRONG_CATEGORY', _('Mauvaise catégorie')
        PROHIBITED = 'PROHIBITED', _('Article prohibé')
        DUPLICATE = 'DUPLICATE', _('Colis en double')
        OTHER = 'OTHER', _('Autre')

    package = models.ForeignKey(
        Package,
        on_delete=models.CASCADE,
        related_name='reports',
        verbose_name=_("Colis")
    )
    reporter = models.ForeignKey(
        'users.User',
        on_delete=models.SET_NULL,
        null=True,
        related_name='package_reports',
        verbose_name=_("Signaleur")
    )
    reason = models.CharField(
        max_length=20,
        choices=ReportReason.choices,
        verbose_name=_("Raison du signalement")
    )
    description = models.TextField(
        blank=True,
        verbose_name=_("Description détaillée")
    )
    evidence = models.FileField(
        upload_to='colis/reports/',
        null=True,
        blank=True,
        verbose_name=_("Preuve")
    )
    status = models.CharField(
        max_length=20,
        choices=[
            ('PENDING', _('En attente')),
            ('IN_REVIEW', _('En revue')),
            ('RESOLVED', _('Résolu')),
            ('DISMISSED', _('Rejeté')),
        ],
        default='PENDING',
        verbose_name=_("Statut")
    )
    admin_notes = models.TextField(
        blank=True,
        verbose_name=_("Notes de l'administrateur")
    )
    resolved_by = models.ForeignKey(
        'users.User',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='resolved_package_reports',
        verbose_name=_("Résolu par")
    )
    resolved_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Résolu le")
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Signalement de colis")
        verbose_name_plural = _("Signalements de colis")
        ordering = ['-created_at']

    def __str__(self):
        return f"Signalement de {self.package.title}"


========== colis/views.py ==========
# ~/ebi3/colis/views.py
from django.shortcuts import render, get_object_or_404, redirect
from django.db.models import Q, Count, Avg, Sum, F, ExpressionWrapper, DecimalField
from django.contrib.auth.decorators import login_required
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.views.generic import (
    ListView, DetailView, CreateView,
    UpdateView, DeleteView, TemplateView, FormView
)



from django.utils.translation import gettext as _

from django.utils import timezone
from django.urls import reverse_lazy, reverse
from django.contrib import messages
from django.utils.translation import gettext_lazy as _
from django.core.paginator import Paginator
from django.http import JsonResponse, HttpResponseForbidden, HttpResponseRedirect
from django.views.decorators.http import require_POST, require_GET
from django.views.decorators.csrf import csrf_protect
from django.db import transaction
from django.db.models.functions import Coalesce
from django.core.exceptions import PermissionDenied
from django.contrib.auth import get_user_model

from .models import (
    Package, PackageCategory, PackageImage,
    TransportOffer, PackageView, PackageFavorite, PackageReport
)
from .forms import (
    PackageCreateForm, PackageUpdateForm, PackageImageFormSet,
    TransportOfferForm, PackageSearchForm, PackageReportForm,
    QuickQuoteForm, PackageFilterForm
)
from users.models import User
from carriers.models import Carrier, CarrierReview
from messaging.models import Conversation, Message
from datetime import datetime, timedelta
from django.views.generic import TemplateView
from django.utils import timezone
from .models import Package
from django.http import HttpResponse

User = get_user_model()


# ============================================================================
# VUES PUBLIQUES
# ============================================================================

class CategoryListView(ListView):
    """Liste des catégories de colis"""
    model = PackageCategory
    template_name = 'colis/category_list.html'
    context_object_name = 'categories'

    def get_queryset(self):
        return PackageCategory.objects.filter(
            is_active=True,
            show_in_menu=True
        ).annotate(
            available_packages_count=Count('packages', filter=Q(packages__status=Package.Status.AVAILABLE))
        ).filter(
            available_packages_count__gt=0
        )


class CategoryDetailView(DetailView):
    """Détail d'une catégorie avec ses colis"""
    model = PackageCategory
    template_name = 'colis/category_detail.html'
    context_object_name = 'category'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        category = self.object

        # Récupérer toutes les sous-catégories
        subcategories = category.get_descendants(include_self=False).filter(
            is_active=True
        )

        # Récupérer les colis actifs de cette catégorie et ses sous-catégories
        packages = Package.objects.filter(
            category__in=subcategories.union(PackageCategory.objects.filter(pk=category.pk)),
            status=Package.Status.AVAILABLE
        ).select_related('sender').prefetch_related('images')

        # Appliquer les filtres
        form = PackageSearchForm(self.request.GET)
        if form.is_valid():
            packages = self.apply_search_filters(packages, form.cleaned_data)

        # Pagination
        paginator = Paginator(packages, 20)
        page = self.request.GET.get('page')
        packages_page = paginator.get_page(page)

        context.update({
            'subcategories': subcategories,
            'packages': packages_page,
            'search_form': form,
            'total_packages': packages.count(),
        })
        return context

    def apply_search_filters(self, queryset, cleaned_data):
        """Applique les filtres de recherche"""
        if cleaned_data.get('q'):
            search_term = cleaned_data['q']
            queryset = queryset.filter(
                Q(title__icontains=search_term) |
                Q(description__icontains=search_term)
            )

        if cleaned_data.get('package_type'):
            queryset = queryset.filter(package_type=cleaned_data['package_type'])

        if cleaned_data.get('pickup_country'):
            queryset = queryset.filter(pickup_country=cleaned_data['pickup_country'])

        if cleaned_data.get('delivery_country'):
            queryset = queryset.filter(delivery_country=cleaned_data['delivery_country'])

        if cleaned_data.get('pickup_city'):
            queryset = queryset.filter(pickup_city__icontains=cleaned_data['pickup_city'])

        if cleaned_data.get('delivery_city'):
            queryset = queryset.filter(delivery_city__icontains=cleaned_data['delivery_city'])

        if cleaned_data.get('pickup_date_from'):
            queryset = queryset.filter(pickup_date__gte=cleaned_data['pickup_date_from'])

        if cleaned_data.get('pickup_date_to'):
            queryset = queryset.filter(pickup_date__lte=cleaned_data['pickup_date_to'])

        if cleaned_data.get('max_weight'):
            queryset = queryset.filter(weight__lte=cleaned_data['max_weight'])

        if cleaned_data.get('max_volume'):
            queryset = queryset.filter(volume__lte=cleaned_data['max_volume'])

        if cleaned_data.get('min_price'):
            queryset = queryset.filter(asking_price__gte=cleaned_data['min_price'])

        if cleaned_data.get('max_price'):
            queryset = queryset.filter(asking_price__lte=cleaned_data['max_price'])

        if cleaned_data.get('flexible_dates'):
            queryset = queryset.filter(flexible_dates=True)

        # Tri
        sort_by = cleaned_data.get('sort_by', '-created_at')
        if sort_by in ['pickup_date', '-pickup_date', 'asking_price', '-asking_price', '-created_at', '-view_count']:
            queryset = queryset.order_by(sort_by)

        return queryset


class PackageListView(ListView):
    """Liste de tous les colis disponibles"""
    model = Package
    template_name = 'colis/package/package_list.html'
    context_object_name = 'packages'
    paginate_by = 20

    def get_queryset(self):
        queryset = Package.objects.filter(
            status=Package.Status.AVAILABLE
        ).select_related('sender', 'category').prefetch_related('images')

        # Appliquer les filtres
        form = PackageSearchForm(self.request.GET)
        if form.is_valid():
            queryset = self.apply_search_filters(queryset, form.cleaned_data)

        return queryset

    def apply_search_filters(self, queryset, cleaned_data):
        """Applique les filtres de recherche"""
        if cleaned_data.get('q'):
            search_term = cleaned_data['q']
            queryset = queryset.filter(
                Q(title__icontains=search_term) |
                Q(description__icontains=search_term)
            )

        if cleaned_data.get('category'):
            category = cleaned_data['category']
            # Inclure les sous-catégories
            subcategories = category.get_descendants(include_self=True)
            queryset = queryset.filter(category__in=subcategories)

        if cleaned_data.get('package_type'):
            queryset = queryset.filter(package_type=cleaned_data['package_type'])

        if cleaned_data.get('pickup_country'):
            queryset = queryset.filter(pickup_country=cleaned_data['pickup_country'])

        if cleaned_data.get('delivery_country'):
            queryset = queryset.filter(delivery_country=cleaned_data['delivery_country'])

        if cleaned_data.get('pickup_city'):
            queryset = queryset.filter(pickup_city__icontains=cleaned_data['pickup_city'])

        if cleaned_data.get('delivery_city'):
            queryset = queryset.filter(delivery_city__icontains=cleaned_data['delivery_city'])

        if cleaned_data.get('pickup_date_from'):
            queryset = queryset.filter(pickup_date__gte=cleaned_data['pickup_date_from'])

        if cleaned_data.get('pickup_date_to'):
            queryset = queryset.filter(pickup_date__lte=cleaned_data['pickup_date_to'])

        if cleaned_data.get('max_weight'):
            queryset = queryset.filter(weight__lte=cleaned_data['max_weight'])

        if cleaned_data.get('max_volume'):
            queryset = queryset.filter(volume__lte=cleaned_data['max_volume'])

        if cleaned_data.get('min_price'):
            queryset = queryset.filter(asking_price__gte=cleaned_data['min_price'])

        if cleaned_data.get('max_price'):
            queryset = queryset.filter(asking_price__lte=cleaned_data['max_price'])

        if cleaned_data.get('flexible_dates'):
            queryset = queryset.filter(flexible_dates=True)

        # Tri
        sort_by = cleaned_data.get('sort_by', '-created_at')
        if sort_by in ['pickup_date', '-pickup_date', 'asking_price', '-asking_price', '-created_at', '-view_count']:
            queryset = queryset.order_by(sort_by)

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['search_form'] = PackageSearchForm(self.request.GET)
        context['total_packages'] = self.get_queryset().count()

        # CORRECTION ICI : Utiliser un nom différent pour l'annotation
        # Puisque 'package_count' existe déjà comme champ dans le modèle
        from django.db.models import Count, Q

        # Solution 1 : Utiliser un nom d'annotation différent
        context['categories'] = PackageCategory.objects.filter(
            is_active=True
        ).annotate(
            active_package_count=Count('packages', filter=Q(packages__status=Package.Status.AVAILABLE))
        ).order_by('-package_count', 'name')[:10]  # Ici, on peut utiliser le champ réel 'package_count' pour le tri

        # Solution alternative : Utiliser directement le champ existant
        # context['categories'] = PackageCategory.objects.filter(
        #     is_active=True,
        #     package_count__gt=0  # Filtrer les catégories qui ont des colis
        # ).order_by('-package_count', 'name')[:10]

        # Stats pour les filtres
        from django.db.models import Min, Max
        context['min_price_range'] = Package.objects.filter(status=Package.Status.AVAILABLE).aggregate(
            Min('asking_price'))['asking_price__min'] or 0
        context['max_price_range'] = Package.objects.filter(status=Package.Status.AVAILABLE).aggregate(
            Max('asking_price'))['asking_price__max'] or 10000

        return context

class PackageDetailView(DetailView):
    """Détail d'un colis"""
    model = Package
    template_name = 'colis/package/package_detail.html'
    context_object_name = 'package'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        package = self.object

        # Enregistrer la vue
        self.record_package_view(package)

        # Offres de transport (si l'utilisateur est le propriétaire ou un transporteur)
        if self.request.user.is_authenticated:
            if self.request.user == package.sender:
                # Propriétaire : voir toutes les offres
                offers = package.transport_offers.all().select_related('carrier', 'carrier__user')
                context['transport_offers'] = offers
                context['has_pending_offers'] = offers.filter(status=TransportOffer.Status.PENDING).exists()
            elif hasattr(self.request.user, 'carrier_profile'):
                # Transporteur : voir si il a déjà fait une offre
                user_offer = package.transport_offers.filter(
                    carrier=self.request.user.carrier_profile
                ).first()
                context['user_offer'] = user_offer

        # Colis similaires
        similar_packages = Package.objects.filter(
            category=package.category,
            status=Package.Status.AVAILABLE
        ).exclude(pk=package.pk).select_related('sender').prefetch_related('images')[:4]

        # Vérifier si le colis est dans les favoris de l'utilisateur
        is_favorite = False
        if self.request.user.is_authenticated:
            is_favorite = PackageFavorite.objects.filter(
                user=self.request.user,
                package=package
            ).exists()

        # Vérifier les permissions
        context.update({
            'similar_packages': similar_packages,
            'is_favorite': is_favorite,
            'can_edit': self.request.user == package.sender or self.request.user.is_staff,
            'can_report': self.request.user.is_authenticated and self.request.user != package.sender,
            'can_make_offer': self.can_make_offer(package),
            'transport_offer_form': TransportOfferForm() if self.can_make_offer(package) else None,
        })

        return context

    def record_package_view(self, package):
        """Enregistre une vue pour le colis"""
        if self.request.user.is_authenticated:
            PackageView.objects.create(
                package=package,
                user=self.request.user,
                session_key=self.request.session.session_key,
                ip_address=self.request.META.get('REMOTE_ADDR'),
                user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
                referer=self.request.META.get('HTTP_REFERER', '')
            )
        else:
            PackageView.objects.create(
                package=package,
                session_key=self.request.session.session_key,
                ip_address=self.request.META.get('REMOTE_ADDR'),
                user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
                referer=self.request.META.get('HTTP_REFERER', '')
            )

        # Mettre à jour le compteur de vues
        package.view_count = PackageView.objects.filter(package=package).count()
        package.save(update_fields=['view_count'])

    def can_make_offer(self, package):
        """Vérifie si l'utilisateur peut faire une offre"""
        if not self.request.user.is_authenticated:
            return False

        # L'expéditeur ne peut pas faire d'offre sur son propre colis
        if self.request.user == package.sender:
            return False

        # Vérifier si l'utilisateur est un transporteur approuvé
        try:
            carrier_profile = self.request.user.carrier_profile
            if carrier_profile.status != Carrier.Status.APPROVED:
                return False
            if not carrier_profile.is_available:
                return False
        except Carrier.DoesNotExist:
            return False

        # Vérifier si le colis est disponible
        if package.status != Package.Status.AVAILABLE:
            return False

        # Vérifier si une offre existe déjà
        if package.transport_offers.filter(carrier=carrier_profile).exists():
            return False

        return True


# ============================================================================
# VUES UTILISATEUR AUTHENTIFIÉ
# ============================================================================

class PackageCreateView(LoginRequiredMixin, CreateView):
    """Création d'un colis"""
    model = Package
    form_class = PackageCreateForm
    template_name = 'colis/package/package_create.html'

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['user'] = self.request.user
        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        if self.request.POST:
            context['image_formset'] = PackageImageFormSet(self.request.POST, self.request.FILES)
        else:
            context['image_formset'] = PackageImageFormSet()
        return context

    def form_valid(self, form):
        context = self.get_context_data()
        image_formset = context['image_formset']

        with transaction.atomic():
            form.instance.sender = self.request.user
            form.instance.status = Package.Status.AVAILABLE
            self.object = form.save()

            if image_formset.is_valid():
                images = image_formset.save(commit=False)
                for image in images:
                    image.package = self.object
                    image.save()

                # Vérifier le nombre d'images
                free_images_count = len([img for img in images if not img.is_paid])
                if free_images_count > self.object.free_images_allowed:
                    messages.warning(
                        self.request,
                        _(f"Vous avez téléchargé {free_images_count} images gratuites, "
                          f"mais seulement {self.object.free_images_allowed} sont autorisées gratuitement.")
                    )
            else:
                return self.form_invalid(form)

        messages.success(self.request, _("Votre colis a été publié avec succès !"))
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('colis:package_detail', kwargs={'slug': self.object.slug})


class PackageUpdateView(LoginRequiredMixin, UpdateView):
    """Modification d'un colis"""
    model = Package
    form_class = PackageUpdateForm
    template_name = 'colis/package/package_create.html'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'

    def dispatch(self, request, *args, **kwargs):
        package = self.get_object()

        # Vérifier les permissions
        if package.sender != request.user and not request.user.is_staff:
            messages.error(request, _("Vous n'êtes pas autorisé à modifier ce colis."))
            return redirect('colis:package_detail', slug=package.slug)

        # Empêcher la modification si le colis est réservé ou en transit
        if package.status in [Package.Status.RESERVED, Package.Status.IN_TRANSIT]:
            messages.error(request, _("Ce colis ne peut pas être modifié car il est réservé ou en transit."))
            return redirect('colis:package_detail', slug=package.slug)

        return super().dispatch(request, *args, **kwargs)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        if self.request.POST:
            context['image_formset'] = PackageImageFormSet(
                self.request.POST, self.request.FILES,
                instance=self.object
            )
        else:
            context['image_formset'] = PackageImageFormSet(instance=self.object)
        return context

    def form_valid(self, form):
        context = self.get_context_data()
        image_formset = context['image_formset']

        with transaction.atomic():
            self.object = form.save()

            if image_formset.is_valid():
                images = image_formset.save(commit=False)
                for image in images:
                    image.package = self.object
                    image.save()

                # Supprimer les images marquées pour suppression
                for obj in image_formset.deleted_objects:
                    obj.delete()
            else:
                return self.form_invalid(form)

        messages.success(self.request, _("Votre colis a été mis à jour avec succès !"))
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('colis:package_detail', kwargs={'slug': self.object.slug})


class PackageDeleteView(LoginRequiredMixin, DeleteView):
    """Suppression d'un colis"""
    model = Package
    template_name = 'colis/package_delete.html'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'
    success_url = reverse_lazy('colis:package_list')

    def dispatch(self, request, *args, **kwargs):
        package = self.get_object()
        if package.sender != request.user and not request.user.is_staff:
            messages.error(request, _("Vous n'êtes pas autorisé à supprimer ce colis."))
            return redirect('colis:package_detail', slug=package.slug)

        # Empêcher la suppression si le colis est réservé ou en transit
        if package.status in [Package.Status.RESERVED, Package.Status.IN_TRANSIT]:
            messages.error(request, _("Ce colis ne peut pas être supprimé car il est réservé ou en transit."))
            return redirect('colis:package_detail', slug=package.slug)

        return super().dispatch(request, *args, **kwargs)

    def delete(self, request, *args, **kwargs):
        messages.success(request, _("Le colis a été supprimé avec succès."))
        return super().delete(request, *args, **kwargs)


class MyPackagesListView(LoginRequiredMixin, ListView):
    """Liste des colis de l'utilisateur"""
    model = Package
    template_name = 'colis/my_packages.html'
    context_object_name = 'packages'
    paginate_by = 10

    def get_queryset(self):
        queryset = Package.objects.filter(
            sender=self.request.user
        ).select_related('category').prefetch_related('images').order_by('-created_at')

        # Appliquer les filtres
        form = PackageFilterForm(self.request.GET)
        if form.is_valid():
            status = form.cleaned_data.get('status')
            date_from = form.cleaned_data.get('date_from')
            date_to = form.cleaned_data.get('date_to')

            if status:
                queryset = queryset.filter(status=status)
            if date_from:
                queryset = queryset.filter(created_at__date__gte=date_from)
            if date_to:
                queryset = queryset.filter(created_at__date__lte=date_to)

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['filter_form'] = PackageFilterForm(self.request.GET)

        # Statistiques
        stats = Package.objects.filter(sender=self.request.user).aggregate(
            total=Count('id'),
            available=Count('id', filter=Q(status=Package.Status.AVAILABLE)),
            reserved=Count('id', filter=Q(status=Package.Status.RESERVED)),
            in_transit=Count('id', filter=Q(status=Package.Status.IN_TRANSIT)),
            delivered=Count('id', filter=Q(status=Package.Status.DELIVERED)),
            cancelled=Count('id', filter=Q(status=Package.Status.CANCELLED)),
            total_views=Sum('view_count'),
            total_offers=Sum('offer_count'),
            total_favorites=Sum('favorite_count'),
        )

        context.update(stats)
        return context


@login_required
@require_POST
def toggle_package_favorite(request, slug):
    """Ajouter/retirer un colis des favoris"""
    package = get_object_or_404(Package, slug=slug)

    favorite, created = PackageFavorite.objects.get_or_create(
        user=request.user,
        package=package
    )

    if not created:
        favorite.delete()
        action = 'retiré'
    else:
        action = 'ajouté'

    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        return JsonResponse({
            'status': 'success',
            'action': 'added' if created else 'removed',
            'favorite_count': package.favorite_count
        })

    messages.success(request, _(f"Colis {action} aux favoris."))
    return redirect('colis:package_detail', slug=slug)


class PackageFavoritesListView(LoginRequiredMixin, ListView):
    """Liste des colis favoris de l'utilisateur"""
    model = PackageFavorite
    template_name = 'colis/favorite_list.html'
    context_object_name = 'favorites'

    def get_queryset(self):
        return PackageFavorite.objects.filter(
            user=self.request.user
        ).select_related('package', 'package__sender', 'package__category').prefetch_related('package__images')


# ============================================================================
# OFFRES DE TRANSPORT
# ============================================================================

class TransportOfferCreateView(LoginRequiredMixin, CreateView):
    """Créer une offre de transport pour un colis"""
    model = TransportOffer
    form_class = TransportOfferForm
    template_name = 'colis/transport_offer_create.html'

    def dispatch(self, request, *args, **kwargs):
        self.package = get_object_or_404(Package, slug=kwargs['slug'])

        # Vérifications
        if not self.can_make_offer(request.user):
            messages.error(request, _("Vous ne pouvez pas faire d'offre pour ce colis."))
            return redirect('colis:package_detail', slug=self.package.slug)

        return super().dispatch(request, *args, **kwargs)

    def can_make_offer(self, user):
        """Vérifie si l'utilisateur peut faire une offre"""
        # L'expéditeur ne peut pas faire d'offre sur son propre colis
        if user == self.package.sender:
            return False

        # Vérifier si l'utilisateur est un transporteur approuvé
        try:
            carrier_profile = user.carrier_profile
            if carrier_profile.status != Carrier.Status.APPROVED:
                return False
            if not carrier_profile.is_available:
                return False
        except Carrier.DoesNotExist:
            return False

        # Vérifier si le colis est disponible
        if self.package.status != Package.Status.AVAILABLE:
            return False

        # Vérifier si une offre existe déjà
        if self.package.transport_offers.filter(carrier=carrier_profile).exists():
            return False

        return True

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['package'] = self.package
        kwargs['carrier'] = self.request.user.carrier_profile
        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['package'] = self.package

        # Calculer une estimation de prix
        estimated_price = self.calculate_estimated_price()
        context['estimated_price'] = estimated_price

        return context

    def calculate_estimated_price(self):
        """Calcule une estimation de prix basée sur la distance et le volume"""
        # Logique simplifiée - à améliorer avec un service de calcul réel
        if self.package.estimated_distance and self.package.volume:
            base_price_per_km = 0.5  # € par km
            base_price_per_volume = 10  # € par m³

            estimated_price = (
                self.package.estimated_distance * base_price_per_km +
                float(self.package.volume) / 1000 * base_price_per_volume
            )

            # Ajustements
            if self.package.is_fragile:
                estimated_price *= 1.2
            if self.package.requires_insurance:
                estimated_price *= 1.1
            if self.package.requires_packaging:
                estimated_price *= 1.15

            return round(estimated_price, 2)
        return None

    def form_valid(self, form):
        with transaction.atomic():
            self.object = form.save()

            # Créer une conversation entre l'expéditeur et le transporteur
            try:
                conversation = Conversation.objects.get_or_create_conversation(
                    self.package.sender,
                    self.request.user,
                    f"Offre pour colis: {self.package.title}"
                )

                # Ajouter un message initial
                Message.objects.create(
                    conversation=conversation,
                    sender=self.request.user,
                    content=_("Bonjour, je vous propose de transporter votre colis pour {price}€. {message}").format(
                        price=self.object.price,
                        message=self.object.message or ""
                    )
                )
            except Exception as e:
                # Ne pas bloquer l'offre si la conversation échoue
                pass

            # Notifier l'expéditeur (à implémenter avec Celery)
            # send_new_offer_notification.delay(self.object.id)

        messages.success(
            self.request,
            _("Votre offre a été envoyée avec succès ! L'expéditeur a été notifié.")
        )
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('colis:package_detail', kwargs={'slug': self.package.slug})


class MyTransportOffersListView(LoginRequiredMixin, ListView):
    """Liste des offres de transport de l'utilisateur"""
    model = TransportOffer
    template_name = 'colis/my_transport_offers.html'
    context_object_name = 'offers'
    paginate_by = 10

    def get_queryset(self):
        # Si l'utilisateur est un transporteur, voir ses offres
        if hasattr(self.request.user, 'carrier_profile'):
            return TransportOffer.objects.filter(
                carrier=self.request.user.carrier_profile
            ).select_related('package', 'package__sender').order_by('-created_at')

        # Si l'utilisateur est un expéditeur, voir les offres reçues
        return TransportOffer.objects.filter(
            package__sender=self.request.user
        ).select_related('package', 'carrier', 'carrier__user').order_by('-created_at')


@login_required
@require_POST
def accept_transport_offer(request, pk):
    """Accepter une offre de transport"""
    offer = get_object_or_404(TransportOffer, pk=pk)

    # Vérifier les permissions
    if offer.package.sender != request.user:
        raise PermissionDenied(_("Vous n'êtes pas autorisé à accepter cette offre."))

    # Vérifier que l'offre peut être acceptée
    if not offer.can_be_accepted():
        messages.error(request, _("Cette offre ne peut pas être acceptée."))
        return redirect('colis:my_transport_offers')

    with transaction.atomic():
        # Accepter l'offre
        offer.status = TransportOffer.Status.ACCEPTED
        offer.accepted_at = timezone.now()
        offer.save()

        # Mettre à jour le statut du colis
        offer.package.status = Package.Status.RESERVED
        offer.package.reserved_at = timezone.now()
        offer.package.save()

        # Rejeter automatiquement les autres offres en attente
        TransportOffer.objects.filter(
            package=offer.package,
            status=TransportOffer.Status.PENDING
        ).exclude(pk=offer.pk).update(
            status=TransportOffer.Status.REJECTED,
            rejection_reason=_("Une autre offre a été acceptée")
        )

        # Notifier le transporteur (à implémenter avec Celery)
        # send_offer_accepted_notification.delay(offer.id)

        # Mettre à jour la conversation
        try:
            conversation = Conversation.objects.get_or_create_conversation(
                offer.package.sender,
                offer.carrier.user,
                f"Colis accepté: {offer.package.title}"
            )

            Message.objects.create(
                conversation=conversation,
                sender=request.user,
                content=_("Bonjour, j'ai accepté votre offre de {price}€. Merci ! Nous pouvons maintenant organiser les détails du transport.").format(
                    price=offer.price
                )
            )
        except Exception as e:
            pass

    messages.success(request, _("L'offre a été acceptée avec succès !"))
    return redirect('colis:my_transport_offers')


@login_required
@require_POST
def reject_transport_offer(request, pk):
    """Rejeter une offre de transport"""
    offer = get_object_or_404(TransportOffer, pk=pk)

    # Vérifier les permissions
    if offer.package.sender != request.user:
        raise PermissionDenied(_("Vous n'êtes pas autorisé à rejeter cette offre."))

    if offer.status != TransportOffer.Status.PENDING:
        messages.error(request, _("Cette offre ne peut pas être rejetée."))
        return redirect('colis:my_transport_offers')

    reason = request.POST.get('reason', '')

    with transaction.atomic():
        offer.status = TransportOffer.Status.REJECTED
        offer.rejection_reason = reason
        offer.save()

        # Notifier le transporteur
        # send_offer_rejected_notification.delay(offer.id, reason)

        # Mettre à jour la conversation
        try:
            conversation = Conversation.objects.get_or_create_conversation(
                offer.package.sender,
                offer.carrier.user,
                f"Colis: {offer.package.title}"
            )

            Message.objects.create(
                conversation=conversation,
                sender=request.user,
                content=_("Bonjour, je regrette mais je ne peux pas accepter votre offre. {reason}").format(
                    reason=f"Raison: {reason}" if reason else ""
                )
            )
        except Exception as e:
            pass

    messages.success(request, _("L'offre a été rejetée."))
    return redirect('colis:my_transport_offers')


@login_required
@require_POST
def cancel_transport_offer(request, pk):
    """Annuler une offre de transport (transporteur)"""
    offer = get_object_or_404(TransportOffer, pk=pk)

    # Vérifier les permissions
    if offer.carrier.user != request.user:
        raise PermissionDenied(_("Vous n'êtes pas autorisé à annuler cette offre."))

    if offer.status != TransportOffer.Status.PENDING:
        messages.error(request, _("Cette offre ne peut pas être annulée."))
        return redirect('colis:my_transport_offers')

    with transaction.atomic():
        offer.status = TransportOffer.Status.CANCELLED
        offer.save()

        # Notifier l'expéditeur
        # send_offer_cancelled_notification.delay(offer.id)

        # Mettre à jour la conversation
        try:
            conversation = Conversation.objects.get_or_create_conversation(
                offer.package.sender,
                offer.carrier.user,
                f"Colis: {offer.package.title}"
            )

            Message.objects.create(
                conversation=conversation,
                sender=request.user,
                content=_("Je regrette mais je dois annuler mon offre pour votre colis.")
            )
        except Exception as e:
            pass

    messages.success(request, _("Votre offre a été annulée."))
    return redirect('colis:my_transport_offers')


# ============================================================================
# VUES POUR TRANSPORTEURS
# ============================================================================

class AvailablePackagesView(LoginRequiredMixin, ListView):
    """Colis disponibles pour les transporteurs"""
    model = Package
    template_name = 'colis/available_packages.html'
    context_object_name = 'packages'
    paginate_by = 20

    def dispatch(self, request, *args, **kwargs):
        # Vérifier que l'utilisateur est un transporteur approuvé
        if not hasattr(request.user, 'carrier_profile'):
            messages.error(request, _("Vous devez être transporteur pour voir les colis disponibles."))
            return redirect('carriers:apply')

        carrier = request.user.carrier_profile
        if carrier.status != Carrier.Status.APPROVED:
            messages.error(request, _("Votre compte transporteur n'est pas encore approuvé."))
            return redirect('carriers:carrier_detail', username=request.user.username)

        if not carrier.is_available:
            messages.warning(request, _("Vous êtes marqué comme indisponible. Activez votre disponibilité pour voir les colis."))

        return super().dispatch(request, *args, **kwargs)

    def get_queryset(self):
        # Filtrer les colis disponibles
        queryset = Package.objects.filter(
            status=Package.Status.AVAILABLE
        ).select_related('sender', 'category').prefetch_related('images')

        # Filtrer par capacités du transporteur
        carrier = self.request.user.carrier_profile
        queryset = queryset.filter(
            weight__lte=carrier.max_weight,
            volume__lte=carrier.max_volume * 1000  # Convertir m³ en L
        )

        # Exclure les colis pour lesquels le transporteur a déjà fait une offre
        offered_packages = TransportOffer.objects.filter(
            carrier=carrier,
            package__in=queryset
        ).values_list('package_id', flat=True)

        queryset = queryset.exclude(id__in=offered_packages)

        # Appliquer les filtres de recherche
        form = PackageSearchForm(self.request.GET)
        if form.is_valid():
            queryset = self.apply_search_filters(queryset, form.cleaned_data)

        return queryset

    def apply_search_filters(self, queryset, cleaned_data):
        """Applique les filtres de recherche"""
        if cleaned_data.get('q'):
            search_term = cleaned_data['q']
            queryset = queryset.filter(
                Q(title__icontains=search_term) |
                Q(description__icontains=search_term)
            )

        if cleaned_data.get('category'):
            category = cleaned_data['category']
            subcategories = category.get_descendants(include_self=True)
            queryset = queryset.filter(category__in=subcategories)

        if cleaned_data.get('pickup_country'):
            queryset = queryset.filter(pickup_country=cleaned_data['pickup_country'])

        if cleaned_data.get('delivery_country'):
            queryset = queryset.filter(delivery_country=cleaned_data['delivery_country'])

        if cleaned_data.get('pickup_city'):
            queryset = queryset.filter(pickup_city__icontains=cleaned_data['pickup_city'])

        if cleaned_data.get('delivery_city'):
            queryset = queryset.filter(delivery_city__icontains=cleaned_data['delivery_city'])

        if cleaned_data.get('pickup_date_from'):
            queryset = queryset.filter(pickup_date__gte=cleaned_data['pickup_date_from'])

        if cleaned_data.get('pickup_date_to'):
            queryset = queryset.filter(pickup_date__lte=cleaned_data['pickup_date_to'])

        if cleaned_data.get('max_weight'):
            queryset = queryset.filter(weight__lte=cleaned_data['max_weight'])

        if cleaned_data.get('max_volume'):
            queryset = queryset.filter(volume__lte=cleaned_data['max_volume'])

        if cleaned_data.get('min_price'):
            queryset = queryset.filter(asking_price__gte=cleaned_data['min_price'])

        if cleaned_data.get('max_price'):
            queryset = queryset.filter(asking_price__lte=cleaned_data['max_price'])

        if cleaned_data.get('flexible_dates'):
            queryset = queryset.filter(flexible_dates=True)

        # Tri
        sort_by = cleaned_data.get('sort_by', '-created_at')
        if sort_by in ['pickup_date', '-pickup_date', 'asking_price', '-asking_price', '-created_at']:
            queryset = queryset.order_by(sort_by)

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['search_form'] = PackageSearchForm(self.request.GET)
        context['total_packages'] = self.get_queryset().count()

        # Statistiques du transporteur
        carrier = self.request.user.carrier_profile
        context['carrier_stats'] = {
            'max_weight': carrier.max_weight,
            'max_volume': carrier.max_volume,
            'completed_missions': carrier.completed_missions,
            'average_rating': carrier.average_rating,
        }

        return context


class CarrierDashboardView(LoginRequiredMixin, TemplateView):
    """Tableau de bord du transporteur"""
    template_name = 'colis/carrier_dashboard.html'

    def dispatch(self, request, *args, **kwargs):
        # Vérifier que l'utilisateur est un transporteur
        if not hasattr(request.user, 'carrier_profile'):
            messages.error(request, _("Vous devez être transporteur pour accéder au tableau de bord."))
            return redirect('carriers:apply')

        return super().dispatch(request, *args, **kwargs)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        carrier = self.request.user.carrier_profile

        # Statistiques
        offers = TransportOffer.objects.filter(carrier=carrier)

        stats = {
            'total_offers': offers.count(),
            'pending_offers': offers.filter(status=TransportOffer.Status.PENDING).count(),
            'accepted_offers': offers.filter(status=TransportOffer.Status.ACCEPTED).count(),
            'rejected_offers': offers.filter(status=TransportOffer.Status.REJECTED).count(),
            'total_earnings': offers.filter(status=TransportOffer.Status.ACCEPTED).aggregate(
                total=Sum('price')
            )['total'] or 0,
        }

        # Offres récentes
        recent_offers = offers.select_related('package', 'package__sender').order_by('-created_at')[:5]

        # Colis en transit
        packages_in_transit = Package.objects.filter(
            transport_offers__carrier=carrier,
            transport_offers__status=TransportOffer.Status.ACCEPTED,
            status=Package.Status.IN_TRANSIT
        ).select_related('sender')[:5]

        context.update({
            'carrier': carrier,
            'stats': stats,
            'recent_offers': recent_offers,
            'packages_in_transit': packages_in_transit,
        })

        return context


# ============================================================================
# SIGNALEMENT ET MODÉRATION
# ============================================================================

class PackageReportView(LoginRequiredMixin, CreateView):
    """Signaler un colis"""
    model = PackageReport
    form_class = PackageReportForm
    template_name = 'colis/package_report.html'

    def dispatch(self, request, *args, **kwargs):
        self.package = get_object_or_404(Package, slug=kwargs['slug'])

        # Empêcher l'utilisateur de signaler son propre colis
        if request.user == self.package.sender:
            messages.error(request, _("Vous ne pouvez pas signaler votre propre colis."))
            return redirect('colis:package_detail', slug=self.package.slug)

        # Vérifier si l'utilisateur a déjà signalé ce colis
        if PackageReport.objects.filter(package=self.package, reporter=request.user).exists():
            messages.warning(request, _("Vous avez déjà signalé ce colis."))
            return redirect('colis:package_detail', slug=self.package.slug)

        return super().dispatch(request, *args, **kwargs)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['package'] = self.package
        return context

    def form_valid(self, form):
        form.instance.package = self.package
        form.instance.reporter = self.request.user

        messages.success(
            self.request,
            _("Votre signalement a été soumis. Nous l'examinerons sous 24 heures.")
        )
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('colis:package_detail', kwargs={'slug': self.package.slug})


# ============================================================================
# RECHERCHE ET FONCTIONNALITÉS
# ============================================================================

def search_packages(request):
    """Recherche avancée de colis"""
    form = PackageSearchForm(request.GET)
    packages = Package.objects.filter(status=Package.Status.AVAILABLE)

    if form.is_valid():
        packages = apply_search_filters(packages, form.cleaned_data)

    # Pagination
    paginator = Paginator(packages, 20)
    page = request.GET.get('page')
    packages_page = paginator.get_page(page)

    context = {
        'packages': packages_page,
        'search_form': form,
        'total_packages': packages.count(),
    }

    return render(request, 'colis/search_results.html', context)


def apply_search_filters(queryset, cleaned_data):
    """Applique les filtres de recherche"""
    if cleaned_data.get('q'):
        search_term = cleaned_data['q']
        queryset = queryset.filter(
            Q(title__icontains=search_term) |
            Q(description__icontains=search_term)
        )

    if cleaned_data.get('category'):
        category = cleaned_data['category']
        subcategories = category.get_descendants(include_self=True)
        queryset = queryset.filter(category__in=subcategories)

    if cleaned_data.get('package_type'):
        queryset = queryset.filter(package_type=cleaned_data['package_type'])

    if cleaned_data.get('pickup_country'):
        queryset = queryset.filter(pickup_country=cleaned_data['pickup_country'])

    if cleaned_data.get('delivery_country'):
        queryset = queryset.filter(delivery_country=cleaned_data['delivery_country'])

    if cleaned_data.get('pickup_city'):
        queryset = queryset.filter(pickup_city__icontains=cleaned_data['pickup_city'])

    if cleaned_data.get('delivery_city'):
        queryset = queryset.filter(delivery_city__icontains=cleaned_data['delivery_city'])

    if cleaned_data.get('pickup_date_from'):
        queryset = queryset.filter(pickup_date__gte=cleaned_data['pickup_date_from'])

    if cleaned_data.get('pickup_date_to'):
        queryset = queryset.filter(pickup_date__lte=cleaned_data['pickup_date_to'])

    if cleaned_data.get('max_weight'):
        queryset = queryset.filter(weight__lte=cleaned_data['max_weight'])

    if cleaned_data.get('max_volume'):
        queryset = queryset.filter(volume__lte=cleaned_data['max_volume'])

    if cleaned_data.get('min_price'):
        queryset = queryset.filter(asking_price__gte=cleaned_data['min_price'])

    if cleaned_data.get('max_price'):
        queryset = queryset.filter(asking_price__lte=cleaned_data['max_price'])

    if cleaned_data.get('flexible_dates'):
        queryset = queryset.filter(flexible_dates=True)

    # Tri
    sort_by = cleaned_data.get('sort_by', '-created_at')
    if sort_by in ['pickup_date', '-pickup_date', 'asking_price', '-asking_price', '-created_at', '-view_count']:
        queryset = queryset.order_by(sort_by)

    return queryset


@login_required
@require_GET
def quick_quote(request):
    """Devis rapide pour transporteurs"""
    form = QuickQuoteForm(request.GET)

    if form.is_valid():
        # Calcul simplifié du prix
        # À remplacer par un service de calcul réel
        weight = form.cleaned_data['weight']
        length = form.cleaned_data.get('length', 0)
        width = form.cleaned_data.get('width', 0)
        height = form.cleaned_data.get('height', 0)

        # Calcul de base
        base_price = float(weight) * 0.5  # 0.5€ par kg

        if length and width and height:
            volume = (float(length) * float(width) * float(height)) / 1000000  # m³
            base_price += volume * 10  # 10€ par m³

        # Majorations
        if form.cleaned_data.get('is_fragile'):
            base_price *= 1.2

        if form.cleaned_data.get('requires_insurance'):
            base_price *= 1.1

        estimated_price = round(base_price, 2)

        return JsonResponse({
            'success': True,
            'estimated_price': estimated_price,
            'currency': 'EUR',
            'message': _("Prix estimé basé sur les informations fournies.")
        })

    return JsonResponse({
        'success': False,
        'errors': form.errors
    })


# ============================================================================
# FONCTIONS AJAX ET API
# ============================================================================

@login_required
@require_POST
def update_package_status(request, slug, status):
    """Changer le statut d'un colis (AJAX)"""
    package = get_object_or_404(Package, slug=slug, sender=request.user)

    if status not in dict(Package.Status.choices):
        return JsonResponse({'success': False, 'error': _("Statut invalide.")})

    # Vérifier les transitions autorisées
    allowed_transitions = {
        Package.Status.AVAILABLE: [Package.Status.CANCELLED],
        Package.Status.RESERVED: [Package.Status.IN_TRANSIT, Package.Status.CANCELLED],
        Package.Status.IN_TRANSIT: [Package.Status.DELIVERED, Package.Status.CANCELLED],
    }

    if package.status in allowed_transitions and status not in allowed_transitions[package.status]:
        return JsonResponse({
            'success': False,
            'error': _("Transition de statut non autorisée.")
        })

    previous_status = package.status
    package.status = status

    # Mettre à jour les dates de statut
    if status == Package.Status.IN_TRANSIT:
        package.in_transit_at = timezone.now()
    elif status == Package.Status.DELIVERED:
        package.delivered_at = timezone.now()

    package.save()

    # Notifier les parties concernées
    # send_package_status_update.delay(package.id, previous_status, status)

    return JsonResponse({
        'success': True,
        'new_status': status,
        'new_status_display': package.get_status_display(),
        'message': _("Statut mis à jour avec succès.")
    })


@login_required
@require_GET
def package_stats(request, slug):
    """Récupérer les statistiques d'un colis (AJAX)"""
    package = get_object_or_404(Package, slug=slug)

    # Vérifier les permissions
    if package.sender != request.user and not request.user.is_staff:
        return JsonResponse({'success': False, 'error': _("Accès non autorisé.")})

    stats = {
        'view_count': package.view_count,
        'offer_count': package.offer_count,
        'favorite_count': package.favorite_count,
        'created_at': package.created_at.isoformat(),
        'published_at': package.published_at.isoformat() if package.published_at else None,
        'status': package.status,
        'status_display': package.get_status_display(),
    }

    return JsonResponse({'success': True, 'stats': stats})


# ============================================================================
# VUES DE GESTION ET ADMIN
# ============================================================================

@login_required
def package_management(request, slug):
    """Gestion complète d'un colis (pour l'expéditeur)"""
    package = get_object_or_404(Package, slug=slug)

    # Vérifier les permissions
    if package.sender != request.user and not request.user.is_staff:
        messages.error(request, _("Accès non autorisé."))
        return redirect('colis:package_detail', slug=slug)

    # Récupérer toutes les offres
    offers = package.transport_offers.all().select_related('carrier', 'carrier__user')

    # Récupérer les conversations liées
    conversations = []
    if hasattr(request, 'messaging'):
        # À adapter selon votre app messaging
        pass

    context = {
        'package': package,
        'offers': offers,
        'conversations': conversations,
        'can_edit': package.status in [Package.Status.AVAILABLE, Package.Status.DRAFT],
        'can_delete': package.status in [Package.Status.AVAILABLE, Package.Status.DRAFT, Package.Status.CANCELLED],
    }

    return render(request, 'colis/package_management.html', context)


class PackageStatisticsView(LoginRequiredMixin, TemplateView):
    """Statistiques des colis de l'utilisateur"""
    template_name = 'colis/package_statistics.html'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        user = self.request.user

        # Statistiques générales
        packages = Package.objects.filter(sender=user)

        stats = packages.aggregate(
            total=Count('id'),
            total_views=Sum('view_count'),
            total_offers=Sum('offer_count'),
            total_favorites=Sum('favorite_count'),
            avg_price=Avg('asking_price'),
            total_value=Sum('asking_price'),
        )

        # Statistiques par statut
        status_stats = []
        for status_code, status_name in Package.Status.choices:
            count = packages.filter(status=status_code).count()
            if count > 0:
                status_stats.append({
                    'status': status_code,
                    'status_display': status_name,
                    'count': count,
                    'percentage': round((count / stats['total']) * 100, 1) if stats['total'] > 0 else 0
                })

        # Évolution mensuelle
        monthly_stats = packages.extra(
            select={'month': "strftime('%%Y-%%m', created_at)"}
        ).values('month').annotate(
            count=Count('id'),
            total_views=Sum('view_count'),
            total_offers=Sum('offer_count'),
        ).order_by('month')

        context.update({
            'stats': stats,
            'status_stats': status_stats,
            'monthly_stats': monthly_stats,
        })

        return context


class NewsSitemapView(TemplateView):
    """
    Vue pour générer un sitemap spécifique Google News
    """
    template_name = 'colis/sitemap_news.xml'
    content_type = 'application/xml'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Articles publiés dans les dernières 48h
        two_days_ago = timezone.now() - timedelta(days=2)

        news_packages = Package.objects.filter(
            created_at__gte=two_days_ago,
            status='AVAILABLE',
            is_archived=False
        ).order_by('-created_at')[:1000]

        context['news_packages'] = news_packages
        context['publication_date'] = datetime.now().strftime('%Y-%m-%d')
        context['site_name'] = 'Ebi3 Colis'

        return context


def robots_txt(request):
    """
    Vue pour servir le fichier robots.txt
    """
    lines = [
        "User-agent: *",
        "Allow: /",
        "",
        "# Sitemaps",
        f"Sitemap: https://{request.get_host()}/colis/sitemap.xml",
        f"Sitemap: https://{request.get_host()}/colis/sitemap_index.xml",
        f"Sitemap: https://{request.get_host()}/colis/news-sitemap.xml",
        "",
        "# Disallow certaines pages",
        "Disallow: /admin/",
        "Disallow: /dashboard/",
        "Disallow: /api/",
        "Disallow: /search/?q=*",
        "Disallow: /*/edit/",
        "Disallow: /*/delete/",
        "",
        "# Crawl-delay pour éviter de surcharger le serveur",
        "Crawl-delay: 2",
        "",
        "# User-agents spécifiques",
        "User-agent: GPTBot",
        "Disallow: /",
        "",
        "User-agent: ChatGPT-User",
        "Disallow: /",
        "",
        "# Host (facultatif mais recommandé)",
        f"Host: {request.get_host()}",
    ]

    return HttpResponse("\n".join(lines), content_type="text/plain")

# ============================================================================
# VUES D'ACTIONS EN MASSE - AJOUTÉES
# ============================================================================

@login_required
def bulk_publish_packages(request):
    """Publie tous les colis en brouillon de l'utilisateur"""
    if request.method == 'POST':
        # Récupérer tous les brouillons de l'utilisateur
        draft_packages = Package.objects.filter(
            sender=request.user,
            status=Package.Status.DRAFT
        )

        count = draft_packages.count()

        if count > 0:
            # Mettre à jour le statut
            draft_packages.update(
                status=Package.Status.AVAILABLE,
                published_at=timezone.now()
            )

            messages.success(
                request,
                _(f'{count} colis ont été publiés avec succès.')
            )
        else:
            messages.info(
                request,
                _("Vous n'avez aucun colis en brouillon à publier.")
            )

    return redirect('colis:my_packages')


@login_required
def bulk_expire_packages(request):
    """Marque tous les colis disponibles de l'utilisateur comme expirés"""
    if request.method == 'POST':
        # Récupérer tous les colis disponibles de l'utilisateur
        available_packages = Package.objects.filter(
            sender=request.user,
            status=Package.Status.AVAILABLE
        )

        count = available_packages.count()

        if count > 0:
            # Mettre à jour le statut
            available_packages.update(
                status=Package.Status.EXPIRED,
                expired_at=timezone.now()
            )

            messages.warning(
                request,
                _(f'{count} colis ont été marqués comme expirés.')
            )
        else:
            messages.info(
                request,
                _("Vous n'avez aucun colis disponible à expirer.")
            )

    return redirect('colis:my_packages')


@login_required
def bulk_delete_packages(request):
    """Supprime tous les brouillons de l'utilisateur"""
    if request.method == 'POST':
        # Récupérer tous les brouillons de l'utilisateur
        draft_packages = Package.objects.filter(
            sender=request.user,
            status=Package.Status.DRAFT
        )

        count = draft_packages.count()

        if count > 0:
            # Supprimer les brouillons
            draft_packages.delete()

            messages.success(
                request,
                _(f'{count} brouillons ont été supprimés.')
            )
        else:
            messages.info(
                request,
                _("Vous n'avez aucun brouillon à supprimer.")
            )

    return redirect('colis:my_packages')


@login_required
def bulk_archive_packages(request):
    """Archive tous les colis livrés/annulés/expirés"""
    if request.method == 'POST':
        # Récupérer les colis terminés
        completed_packages = Package.objects.filter(
            sender=request.user,
            status__in=[Package.Status.DELIVERED, Package.Status.CANCELLED, Package.Status.EXPIRED]
        )

        count = completed_packages.count()

        if count > 0:
            # Marquer comme archivés (si vous avez un champ is_archived)
            # Sinon, vous pouvez les déplacer vers une autre table
            # completed_packages.update(is_archived=True)

            messages.info(
                request,
                _(f'{count} colis ont été marqués comme terminés.')
            )
        else:
            messages.info(
                request,
                _("Vous n'avez aucun colis terminé à archiver.")
            )

    return redirect('colis:my_packages')


# ============================================================================
# VUES D'ERREUR
# ============================================================================

def custom_404(request, exception):
    """Vue personnalisée pour l'erreur 404"""
    return render(request, 'colis/errors/404.html', status=404)


def custom_500(request):
    """Vue personnalisée pour l'erreur 500"""
    return render(request, 'colis/errors/500.html', status=500)


========== core/templates/core/500.html ==========
<!DOCTYPE html>
<html>
<head>
    <title>Erreur 500</title>
    <style>
        body { font-family: Arial; text-align: center; padding: 50px; }
        h1 { color: #d00; }
        .container { max-width: 600px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>500 - Erreur serveur</h1>
        <p>Une erreur interne s'est produite.</p>
        <p>Notre équipe technique travaille à résoudre le problème.</p>
        <a href="/">Retour à l'accueil</a>
    </div>
</body>
</html>


========== core/templates/core/base.html ==========
{# ~/ebi3/core/templates/core/base.html #}
<!DOCTYPE html>
{% load static i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% get_current_language_bidi as LANGUAGE_BIDI %}
{% get_available_languages as LANGUAGES %}

<html lang="{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{ SITE_DESCRIPTION }}">

    <title>{% block title %}{{ SITE_NAME }}{% endblock %}</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap RTL pour l'arabe -->
    {% if LANGUAGE_CODE == 'ar' %}
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-rtl@3.4.0/dist/css/bootstrap-rtl.min.css" rel="stylesheet">
    {% endif %}

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <!-- RTL custom styles -->
    {% if LANGUAGE_BIDI %}
        <link rel="stylesheet" href="{% static 'css/rtl.css' %}">
    {% endif %}

    {% block extra_css %}{% endblock %}

    <!-- SEO Meta Tags -->
    {% block meta_tags %}
        <meta property="og:title" content="{% block og_title %}{{ SITE_NAME }}{% endblock %}">
        <meta property="og:description" content="{{ SITE_DESCRIPTION }}">
        <meta property="og:url" content="{{ SITE_URL }}">
        <meta property="og:type" content="website">
        <meta property="og:image" content="{% static 'img/og-image.png' %}">

        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="{{ SITE_NAME }}">
        <meta name="twitter:description" content="{{ SITE_DESCRIPTION }}">
    {% endblock %}
</head>
<body class="d-flex flex-column min-vh-100" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Header -->
    <header>
        <!-- Top Bar -->
        <div class="top-bar bg-primary text-white py-2">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-phone me-2"></i>
                            <span>{{ PHONE_NUMBER }}</span>
                            <i class="fas fa-envelope ms-3 me-2"></i>
                            <span>{{ CONTACT_EMAIL }}</span>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="d-flex align-items-center justify-content-end">
                            <!-- Sélecteur de langue -->
                            <form action="{% url 'set_language' %}" method="post" class="me-3">
                                {% csrf_token %}
                                <input name="next" type="hidden" value="{{ request.path }}">
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <select name="language" class="form-select form-select-sm" onchange="this.form.submit()">
                                        {% for lang_code, lang_name in LANGUAGES %}
                                            <option value="{{ lang_code }}"
                                                    {% if lang_code == LANGUAGE_CODE %}selected{% endif %}>
                                                {{ lang_name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </form>

                            <!-- Liens utilisateur -->
                            {% if user.is_authenticated %}
                                <div class="dropdown">
                                    <button class="btn btn-light btn-sm dropdown-toggle" type="button"
                                            data-bs-toggle="dropdown">
                                        <i class="fas fa-user-circle"></i> {{ user.username }}
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" href="{% url 'users:profile' user.username %}">
                                                <i class="fas fa-user"></i> {% trans "Mon profil" %}
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'ads:my_ads' %}">
                                                <i class="fas fa-list"></i> {% trans "Mes annonces" %}
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'colis:my_packages' %}">
                                                <i class="fas fa-box"></i> {% trans "Mes colis" %}
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'ads:favorite_list' %}">
                                                <i class="fas fa-heart"></i> {% trans "Mes favoris" %}
                                            </a>
                                        </li>
                                        <!-- Lien vers le dashboard transporteur si applicable -->
                                        {% if user.carrier_profile %}
                                            <li>
                                                <a class="dropdown-item" href="{% url 'carriers:carrier_dashboard' %}">
                                                    <i class="fas fa-tachometer-alt"></i> {% trans "Dashboard Transporteur" %}
                                                </a>
                                            </li>
                                        {% endif %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'users:logout' %}">
                                                <i class="fas fa-sign-out-alt"></i> {% trans "Déconnexion" %}
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            {% else %}
                                <a href="{% url 'users:login' %}" class="btn btn-light btn-sm me-2">
                                    <i class="fas fa-sign-in-alt"></i> {% trans "Connexion" %}
                                </a>
                                <a href="{% url 'users:register' %}" class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-user-plus"></i> {% trans "Inscription" %}
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container">
                <!-- Logo -->
                <a class="navbar-brand" href="{% url 'core:home' %}">
                    <div class="d-flex align-items-center">
                        <div class="logo-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                             style="width: 40px; height: 40px;">
                            <i class="fas fa-box"></i>
                        </div>
                        <span class="fw-bold fs-4" style="color: #667eea;">EBI3</span>
                    </div>
                </a>

                <!-- Mobile Toggle -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarMain">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Menu -->
                <div class="collapse navbar-collapse" id="navbarMain">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}"
                               href="{% url 'core:home' %}">
                                <i class="fas fa-home"></i> {% trans "Accueil" %}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.namespace == 'ads' %}active{% endif %}"
                               href="{% url 'ads:ad_list' %}">
                                <i class="fas fa-list"></i> {% trans "Annonces" %}
                            </a>
                        </li>
                        <!-- Lien vers les colis -->
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.namespace == 'colis' %}active{% endif %}"
                               href="{% url 'colis:package_list' %}">
                                <i class="fas fa-box"></i> {% trans "Colis" %}
                            </a>
                        </li>
                        <!-- Lien vers les transporteurs -->
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.namespace == 'carriers' %}active{% endif %}"
                               href="{% url 'carriers:carrier_list' %}">
                                <i class="fas fa-truck"></i> {% trans "Transporteurs" %}
                            </a>
                        </li>

                        <!-- Pages du menu -->
                        {% for page in MENU_PAGES %}
                            {% if not page.show_in_footer %}
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ page.get_absolute_url }}">
                                        {{ page.title }}
                                    </a>
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>

                    <!-- Search Bar -->
                    <form class="d-flex me-3" action="{% url 'ads:search' %}" method="get">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control"
                                   placeholder="{% trans 'Rechercher...' %}"
                                   value="{{ request.GET.q }}">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>

                    <!-- Boutons d'action -->
                    <div class="d-flex gap-2">
                        <!-- Bouton créer annonce -->
                        {% if user.is_authenticated %}
                            <a href="{% url 'ads:ad_create' %}" class="btn btn-success btn-sm">
                                <i class="fas fa-plus"></i> {% trans "Créer une annonce" %}
                            </a>

                            <!-- Bouton publier colis -->
                            <a href="{% url 'colis:package_create' %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-box"></i> {% trans "Publier un colis" %}
                            </a>
                        {% endif %}

                        <!-- Bouton devenir transporteur -->
                        {% if user.is_authenticated and not user.carrier_profile %}
                            <a href="{% url 'carriers:apply' %}" class="btn btn-warning btn-sm">
                                <i class="fas fa-truck"></i> {% trans "Devenir transporteur" %}
                            </a>
                        {% elif user.is_authenticated and user.carrier_profile %}
                            <a href="{% url 'carriers:carrier_dashboard' %}" class="btn btn-info btn-sm">
                                <i class="fas fa-tachometer-alt"></i> {% trans "Dashboard Transport" %}
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-grow-1">
        <!-- Messages -->
        {% if messages %}
            <div class="container mt-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>

<!-- Footer -->
<footer class="text-dark mt-auto" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
    <div class="container py-5">
        <div class="row">
            <!-- Logo et description -->
            <div class="col-lg-4 mb-4">
                <div class="d-flex align-items-center mb-3">
                    <div class="logo-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                         style="width: 40px; height: 40px;">
                        <i class="fas fa-box"></i>
                    </div>
                    <h4 class="mb-0 fw-bold" style="color: #667eea;">EBI3</h4>
                </div>
                <p class="text-muted">
                    {% trans "Plateforme logistique transfrontalière pour les expatriés." %}
                </p>
                <div class="social-links mt-4">
                    {% if FACEBOOK_URL %}
                        <a href="{{ FACEBOOK_URL }}" class="text-secondary me-3">
                            <i class="fab fa-facebook fa-lg"></i>
                        </a>
                    {% endif %}
                    {% if TWITTER_URL %}
                        <a href="{{ TWITTER_URL }}" class="text-secondary me-3">
                            <i class="fab fa-twitter fa-lg"></i>
                        </a>
                    {% endif %}
                    {% if INSTAGRAM_URL %}
                        <a href="{{ INSTAGRAM_URL }}" class="text-secondary me-3">
                            <i class="fab fa-instagram fa-lg"></i>
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Liens rapides -->
            <div class="col-lg-2 col-md-6 mb-4">
                <h6 class="fw-bold mb-3 text-primary">{% trans "Navigation" %}</h6>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <a href="{% url 'core:home' %}" class="text-dark text-decoration-none">
                            <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Accueil" %}
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{% url 'ads:ad_list' %}" class="text-dark text-decoration-none">
                            <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Annonces" %}
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{% url 'colis:package_list' %}" class="text-dark text-decoration-none">
                            <i class="fas fa-chevron-right me-1 text-success"></i> {% trans "Colis" %}
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{% url 'carriers:carrier_list' %}" class="text-dark text-decoration-none">
                            <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Transporteurs" %}
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Liens légaux -->
            <div class="col-lg-2 col-md-6 mb-4">
                <h6 class="fw-bold mb-3 text-primary">{% trans "Légal" %}</h6>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <a href="{% url 'core:terms' %}" class="text-dark text-decoration-none">
                            <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Conditions" %}
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{% url 'core:privacy' %}" class="text-dark text-decoration-none">
                            <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Confidentialité" %}
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{% url 'core:contact' %}" class="text-dark text-decoration-none">
                            <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Contact" %}
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{% url 'colis:how_it_works' %}" class="text-dark text-decoration-none">
                            <i class="fas fa-chevron-right me-1 text-info"></i> {% trans "Comment ça marche" %}
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Contact -->
            <div class="col-lg-4 mb-4">
                <h6 class="fw-bold mb-3 text-primary">{% trans "Contact" %}</h6>
                <ul class="list-unstyled">
                    {% if CONTACT_EMAIL %}
                    <li class="mb-3">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-envelope text-primary mt-1 me-2"></i>
                            <div>
                                <small class="text-muted d-block">{% trans "Email" %}</small>
                                <a href="mailto:{{ CONTACT_EMAIL }}" class="text-dark">{{ CONTACT_EMAIL }}</a>
                            </div>
                        </div>
                    </li>
                    {% endif %}
                    {% if PHONE_NUMBER %}
                    <li class="mb-3">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-phone text-primary mt-1 me-2"></i>
                            <div>
                                <small class="text-muted d-block">{% trans "Téléphone" %}</small>
                                <a href="tel:{{ PHONE_NUMBER }}" class="text-dark">{{ PHONE_NUMBER }}</a>
                            </div>
                        </div>
                    </li>
                    {% endif %}
                </ul>

                <!-- Newsletter -->
                <div class="mt-4">
                    <p class="text-muted mb-2">{% trans "Inscrivez-vous à notre newsletter" %}</p>
                    <form class="d-flex">
                        <input type="email" class="form-control form-control-sm me-2 border-primary"
                               placeholder="Votre email">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Copyright -->
        <div class="row pt-4 border-top">
            <div class="col-md-12 text-center">
                <p class="mb-0 text-muted">
                    &copy; {% now "Y" %} {{ SITE_NAME }}. {% trans "Tous droits réservés." %}
                </p>
            </div>
        </div>
    </div>
</footer>

    <!-- JavaScript -->
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Custom JS -->
    <script src="{% static 'js/main.js' %}"></script>

    <!-- Script pour le multilinguisme et la newsletter -->
    <script>
        $(document).ready(function() {
            // Newsletter subscription
            $('#newsletter-form').submit(function(e) {
                e.preventDefault();

                $.ajax({
                    url: '{% url "core:newsletter_subscribe" %}',
                    type: 'POST',
                    data: $(this).serialize(),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            showToast(response.message, 'success');
                            $('#newsletter-form')[0].reset();
                        } else {
                            showToast('{% trans "Une erreur est survenue" %}', 'error');
                        }
                    },
                    error: function(xhr) {
                        if (xhr.status === 400) {
                            const errors = xhr.responseJSON.errors;
                            let errorMsg = '';

                            for (const field in errors) {
                                errorMsg += errors[field][0] + ' ';
                            }

                            showToast(errorMsg, 'error');
                        } else {
                            showToast('{% trans "Une erreur est survenue" %}', 'error');
                        }
                    }
                });
            });

            // RTL adjustments
            {% if LANGUAGE_BIDI %}
                // Adjustments for RTL layout
                $('.carousel-control-prev').addClass('carousel-control-next');
                $('.carousel-control-next').addClass('carousel-control-prev');

                // Fix dropdown alignment
                $('.dropdown-menu-end').removeClass('dropdown-menu-end').addClass('dropdown-menu-start');
            {% endif %}

            // Helper function for toasts
            function showToast(message, type) {
                const toastHtml = `
                    <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                `;

                $('#toast-container').append(toastHtml);
                const toast = new bootstrap.Toast($('.toast').last()[0]);
                toast.show();

                // Remove toast after hiding
                $('.toast').last().on('hidden.bs.toast', function() {
                    $(this).remove();
                });
            }
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>


========== core/templates/core/home.html ==========
{# ~/ebi3/core/templates/core/home.html #}
{% extends 'core/base.html' %}
{% load i18n static %}

{% block title %}{{ SITE_NAME }} - {% trans "Plateforme Logistique Transfrontalière" %}{% endblock %}

{% block content %}
<!-- Actions Rapides pour Utilisateurs Connectés -->
{% if user.is_authenticated %}
<section class="py-3 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-md-12">
                                <h5 class="mb-2">{% trans "Actions rapides" %}</h5>
                                <div class="d-flex flex-wrap gap-2">
                                    <!-- Créer une annonce -->
                                    {% if user.ads.exists %}
                                    <a href="{% url 'ads:my_ads' %}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-edit me-1"></i> {% trans "Mes annonces" %}
                                    </a>
                                    {% else %}
                                    <a href="{% url 'ads:ad_create' %}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus me-1"></i> {% trans "Créer annonce" %}
                                    </a>
                                    {% endif %}

                                    <!-- Créer un colis -->
                                    <a href="{% url 'colis:package_create' %}" class="btn btn-success btn-sm">
                                        <i class="fas fa-plus me-1"></i> {% trans "Publier colis" %}
                                    </a>

                                    <!-- Voir mes colis -->
                                    <a href="{% url 'colis:my_packages' %}" class="btn btn-outline-success btn-sm">
                                        <i class="fas fa-box me-1"></i> {% trans "Mes colis" %}
                                    </a>

                                    <!-- Ajouter un transporteur -->
                                    {% if user.carrier_profile %}
                                    <a href="{% url 'carriers:carrier_dashboard' %}" class="btn btn-outline-warning btn-sm">
                                        <i class="fas fa-truck me-1"></i> {% trans "Dashboard Transport" %}
                                    </a>
                                    {% else %}
                                    <a href="{% url 'carriers:apply' %}" class="btn btn-warning btn-sm">
                                        <i class="fas fa-truck me-1"></i> {% trans "Devenir transporteur" %}
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Aperçu des Annonces -->
<section class="py-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold mb-1">{% trans "Annonces récentes" %}</h3>
                <p class="text-muted">{% trans "Découvrez les dernières offres" %}</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'ads:ad_list' %}" class="btn btn-outline-primary">
                    {% trans "Toutes les annonces" %}
                </a>
                {% if user.is_authenticated %}
                <a href="{% url 'ads:ad_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> {% trans "Créer" %}
                </a>
                {% endif %}
            </div>
        </div>

        {% if recent_ads %}
        <div class="row g-3">
            {% for ad in recent_ads|slice:":4" %}
            <div class="col-md-3">
                <div class="card h-100 border">
                    {% if ad.images.first %}
                    <img src="{{ ad.images.first.image.url }}"
                         class="card-img-top" alt="{{ ad.title }}" style="height: 150px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 150px;">
                        <i class="fas fa-image fa-2x text-light"></i>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h6 class="card-title">{{ ad.title|truncatechars:40 }}</h6>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="fw-bold text-primary">{{ ad.get_price_with_currency }}</span>
                            <div class="d-flex gap-1">
                                <a href="{{ ad.get_absolute_url }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if user == ad.seller %}
                                <a href="{% url 'ads:ad_edit' ad.slug %}" class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-box fa-3x text-muted mb-3"></i>
            <p class="text-muted">{% trans "Aucune annonce pour le moment" %}</p>
            {% if user.is_authenticated %}
            <a href="{% url 'ads:ad_create' %}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> {% trans "Créer la première annonce" %}
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>

<!-- Services Principaux -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="fw-bold mb-3">{% trans "Nos services" %}</h2>
            <p class="text-muted">{% trans "Trois solutions pour vos besoins transfrontaliers" %}</p>
        </div>

        <div class="row g-4">
            <!-- Service 1 : Annonces -->
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center p-4">
                        <div class="icon-wrapper bg-primary bg-opacity-10 rounded-circle p-4 mb-3 d-inline-block">
                            <i class="fas fa-exchange-alt fa-2x text-primary"></i>
                        </div>
                        <h4 class="fw-bold mb-3">{% trans "Vente P2P" %}</h4>
                        <p class="text-muted mb-4">
                            {% trans "Vendez ou achetez directement entre particuliers" %}
                        </p>
                        <div class="mt-3">
                            <a href="{% url 'ads:ad_list' %}" class="btn btn-outline-primary mb-2">
                                <i class="fas fa-search"></i> {% trans "Explorer" %}
                            </a>
                            {% if user.is_authenticated %}
                            <a href="{% url 'ads:ad_create' %}" class="btn btn-primary mb-2">
                                <i class="fas fa-plus"></i> {% trans "Créer" %}
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service 2 : Colis -->
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center p-4">
                        <div class="icon-wrapper bg-success bg-opacity-10 rounded-circle p-4 mb-3 d-inline-block">
                            <i class="fas fa-box fa-2x text-success"></i>
                        </div>
                        <h4 class="fw-bold mb-3">{% trans "Colis à transporter" %}</h4>
                        <p class="text-muted mb-4">
                            {% trans "Trouvez des colis à transporter ou proposez votre colis" %}
                        </p>
                        <div class="mt-3">
                            <a href="{% url 'colis:package_list' %}" class="btn btn-outline-success mb-2">
                                <i class="fas fa-search"></i> {% trans "Voir colis" %}
                            </a>
                            {% if user.is_authenticated %}
                            <a href="{% url 'colis:package_create' %}" class="btn btn-success mb-2">
                                <i class="fas fa-plus"></i> {% trans "Publier" %}
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service 3 : Transport Pro -->
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center p-4">
                        <div class="icon-wrapper bg-warning bg-opacity-10 rounded-circle p-4 mb-3 d-inline-block">
                            <i class="fas fa-truck fa-2x text-warning"></i>
                        </div>
                        <h4 class="fw-bold mb-3">{% trans "Transport Pro" %}</h4>
                        <p class="text-muted mb-4">
                            {% trans "Transporteurs professionnels avec suivi et assurance" %}
                        </p>
                        <div class="mt-3">
                            <a href="{% url 'carriers:carrier_list' %}" class="btn btn-outline-warning mb-2">
                                <i class="fas fa-search"></i> {% trans "Trouver" %}
                            </a>
                            <a href="{% url 'ads:ad_list' %}?logistics_option=WITH_CARRIER" class="btn btn-warning mb-2">
                                <i class="fas fa-box"></i> {% trans "Colis avec transport" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service 4 : Transport Communautaire -->
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center p-4">
                        <div class="icon-wrapper bg-info bg-opacity-10 rounded-circle p-4 mb-3 d-inline-block">
                            <i class="fas fa-users fa-2x text-info"></i>
                        </div>
                        <h4 class="fw-bold mb-3">{% trans "Transport Communautaire" %}</h4>
                        <p class="text-muted mb-4">
                            {% trans "Expatriés qui transportent lors de leurs voyages" %}
                        </p>
                        <div class="mt-3">
                            <a href="{% url 'carriers:carrier_list' %}?carrier_type=PERSONAL" class="btn btn-outline-info mb-2">
                                <i class="fas fa-search"></i> {% trans "Voir expatriés" %}
                            </a>
                            {% if user.is_authenticated and not user.carrier_profile %}
                            <a href="{% url 'carriers:apply' %}" class="btn btn-info mb-2">
                                <i class="fas fa-truck"></i> {% trans "Devenir transporteur" %}
                            </a>
                            {% elif not user.is_authenticated %}
                            <a href="{% url 'users:register' %}" class="btn btn-info mb-2">
                                <i class="fas fa-user-plus"></i> {% trans "S'inscrire" %}
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liens de gestion pour utilisateurs connectés -->
        {% if user.is_authenticated %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3 text-center">
                            <i class="fas fa-cogs text-primary me-2"></i>
                            {% trans "Gestion de votre compte" %}
                        </h5>
                        <div class="row">
                            <!-- Annonces -->
                            <div class="col-md-3 mb-3 mb-md-0">
                                <div class="d-flex flex-column align-items-center text-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-3 mb-2">
                                        <i class="fas fa-edit fa-lg text-primary"></i>
                                    </div>
                                    <h6 class="fw-bold">{% trans "Annonces" %}</h6>
                                    <p class="small text-muted mb-2">{% trans "Gérez vos publications" %}</p>
                                    <div class="d-flex gap-1">
                                        <a href="{% url 'ads:my_ads' %}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-list"></i> {% trans "Mes annonces" %}
                                        </a>
                                        <a href="{% url 'ads:ad_create' %}" class="btn btn-primary btn-sm">
                                            <i class="fas fa-plus"></i> {% trans "Nouvelle" %}
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Colis -->
                            <div class="col-md-3 mb-3 mb-md-0">
                                <div class="d-flex flex-column align-items-center text-center">
                                    <div class="bg-success bg-opacity-10 rounded-circle p-3 mb-2">
                                        <i class="fas fa-box fa-lg text-success"></i>
                                    </div>
                                    <h6 class="fw-bold">{% trans "Colis" %}</h6>
                                    <p class="small text-muted mb-2">{% trans "Publiez ou gérez vos colis" %}</p>
                                    <div class="d-flex gap-1">
                                        <a href="{% url 'colis:my_packages' %}" class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-boxes"></i> {% trans "Mes colis" %}
                                        </a>
                                        <a href="{% url 'colis:package_create' %}" class="btn btn-success btn-sm">
                                            <i class="fas fa-plus"></i> {% trans "Nouveau" %}
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Offres de transport -->
                            <div class="col-md-3 mb-3 mb-md-0">
                                <div class="d-flex flex-column align-items-center text-center">
                                    <div class="bg-warning bg-opacity-10 rounded-circle p-3 mb-2">
                                        <i class="fas fa-handshake fa-lg text-warning"></i>
                                    </div>
                                    <h6 class="fw-bold">{% trans "Offres" %}</h6>
                                    <p class="small text-muted mb-2">{% trans "Vos offres de transport" %}</p>
                                    <div class="d-flex gap-1">
                                        <a href="{% url 'colis:my_offers' %}" class="btn btn-outline-warning btn-sm">
                                            <i class="fas fa-list"></i> {% trans "Mes offres" %}
                                        </a>
                                        <a href="{% url 'colis:package_list' %}" class="btn btn-warning btn-sm">
                                            <i class="fas fa-search"></i> {% trans "Trouver colis" %}
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Transport -->
                            <div class="col-md-3">
                                <div class="d-flex flex-column align-items-center text-center">
                                    <div class="bg-info bg-opacity-10 rounded-circle p-3 mb-2">
                                        <i class="fas fa-truck fa-lg text-info"></i>
                                    </div>
                                    <h6 class="fw-bold">{% trans "Transport" %}</h6>
                                    <p class="small text-muted mb-2">{% trans "Gérez le transport" %}</p>
                                    <div class="d-flex gap-1">
                                        {% if user.carrier_profile %}
                                        <a href="{% url 'carriers:carrier_dashboard' %}" class="btn btn-outline-info btn-sm">
                                            <i class="fas fa-tachometer-alt"></i> {% trans "Dashboard" %}
                                        </a>
                                        <a href="{% url 'carriers:carrier_dashboard' %}" class="btn btn-info btn-sm">
                                            <i class="fas fa-edit"></i> {% trans "Profil" %}
                                        </a>
                                        {% else %}
                                        <a href="{% url 'carriers:apply' %}" class="btn btn-info btn-sm">
                                            <i class="fas fa-truck"></i> {% trans "Devenir transporteur" %}
                                        </a>
                                        <a href="{% url 'carriers:carrier_list' %}" class="btn btn-outline-info btn-sm">
                                            <i class="fas fa-search"></i> {% trans "Rechercher" %}
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Section : Derniers colis disponibles -->
<section class="py-5">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold mb-1">{% trans "Colis récemment publiés" %}</h3>
                <p class="text-muted">{% trans "Trouvez des colis à transporter" %}</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'colis:package_list' %}" class="btn btn-outline-success">
                    {% trans "Tous les colis" %}
                </a>
                {% if user.is_authenticated %}
                <a href="{% url 'colis:package_create' %}" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i> {% trans "Publier un colis" %}
                </a>
                {% endif %}
            </div>
        </div>

        {% if recent_packages %}
        <div class="row g-3">
            {% for package in recent_packages|slice:":4" %}
            <div class="col-md-3">
                <div class="card h-100 border">
                    {% if package.images.first %}
                    <img src="{{ package.images.first.image.url }}"
                         class="card-img-top" alt="{{ package.title }}" style="height: 150px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 150px;">
                        <i class="fas fa-box fa-2x text-light"></i>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h6 class="card-title">{{ package.title|truncatechars:40 }}</h6>
                        <div class="small text-muted mb-2">
                            <i class="fas fa-map-marker-alt text-danger"></i> {{ package.pickup_city }}
                            <i class="fas fa-arrow-right mx-1"></i>
                            <i class="fas fa-map-marker-alt text-success"></i> {{ package.delivery_city }}
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="fw-bold text-success">{{ package.get_price_with_currency }}</span>
                            <div class="d-flex gap-1">
                                <a href="{{ package.get_absolute_url }}" class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if user.is_authenticated and user != package.sender %}
                                <a href="{% url 'colis:offer_create' package.slug %}" class="btn btn-sm btn-success">
                                    <i class="fas fa-handshake"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-box fa-3x text-muted mb-3"></i>
            <p class="text-muted">{% trans "Aucun colis disponible pour le moment" %}</p>
            {% if user.is_authenticated %}
            <a href="{% url 'colis:package_create' %}" class="btn btn-success">
                <i class="fas fa-plus me-1"></i> {% trans "Publier le premier colis" %}
            </a>
            {% else %}
            <a href="{% url 'users:register' %}" class="btn btn-success">
                <i class="fas fa-user-plus me-1"></i> {% trans "Inscrivez-vous pour publier" %}
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>

<!-- Aperçu des Transporteurs -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold mb-1">{% trans "Transporteurs disponibles" %}</h3>
                <p class="text-muted">{% trans "Des professionnels et expatriés à votre service" %}</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'carriers:carrier_list' %}" class="btn btn-outline-primary">
                    {% trans "Tous les transporteurs" %}
                </a>
                {% if user.is_authenticated and not user.carrier_profile %}
                <a href="{% url 'carriers:apply' %}" class="btn btn-warning">
                    <i class="fas fa-truck me-1"></i> {% trans "Devenir transporteur" %}
                </a>
                {% endif %}
            </div>
        </div>

        {% if recent_carriers %}
        <div class="row g-3">
            {% for carrier in recent_carriers|slice:":4" %}
            <div class="col-md-3">
                <div class="card h-100 border">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                                 style="width: 40px; height: 40px;">
                                {{ carrier.user.username|first|upper }}
                            </div>
                            <div>
                                <h6 class="mb-0">{{ carrier.user.username }}</h6>
                                <small class="text-muted">{{ carrier.get_carrier_type_display }}</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="rating-stars">
                                {% for i in "12345" %}
                                {% if forloop.counter <= carrier.average_rating %}
                                <i class="fas fa-star text-warning"></i>
                                {% else %}
                                <i class="far fa-star text-warning"></i>
                                {% endif %}
                                {% endfor %}
                                <small class="ms-1">{{ carrier.average_rating|floatformat:1 }}</small>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="badge bg-secondary">{{ carrier.vehicle_type }}</span>
                            <div class="d-flex gap-1">
                                <a href="{% url 'carriers:carrier_detail' carrier.user.username %}"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if user.is_authenticated %}
                                <a href="{% url 'messaging:new_conversation' carrier.user.username %}"
                                   class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-envelope"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-truck fa-3x text-muted mb-3"></i>
            <p class="text-muted">{% trans "Aucun transporteur pour le moment" %}</p>
            {% if user.is_authenticated %}
            <a href="{% url 'carriers:apply' %}" class="btn btn-warning">
                <i class="fas fa-truck me-1"></i> {% trans "Devenir le premier transporteur" %}
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>

<!-- Call to Action -->
<section class="py-5 bg-primary bg-opacity-10">
    <div class="container">
        <div class="row justify-content-center text-center">
            <div class="col-lg-8">
                <h3 class="fw-bold mb-3">{% trans "Prêt à commencer ?" %}</h3>
                <p class="mb-4">
                    {% trans "Rejoignez notre communauté d'expatriés et simplifiez vos transactions transfrontalières." %}
                </p>
                <div class="d-flex flex-wrap justify-content-center gap-2">
                    {% if not user.is_authenticated %}
                    <a href="{% url 'users:register' %}" class="btn btn-primary px-4">
                        <i class="fas fa-user-plus me-2"></i> {% trans "Créer un compte" %}
                    </a>
                    {% endif %}
                    <a href="{% url 'ads:ad_create' %}" class="btn btn-outline-primary px-4">
                        <i class="fas fa-plus me-2"></i> {% trans "Publier une annonce" %}
                    </a>
                    <a href="{% url 'colis:package_create' %}" class="btn btn-success px-4">
                        <i class="fas fa-box me-2"></i> {% trans "Publier un colis" %}
                    </a>
                    <a href="{% url 'carriers:apply' %}" class="btn btn-outline-warning px-4">
                        <i class="fas fa-truck me-2"></i> {% trans "Devenir transporteur" %}
                    </a>
                    <a href="{% url 'core:contact' %}" class="btn btn-outline-secondary px-4">
                        <i class="fas fa-question-circle me-2"></i> {% trans "Questions ?" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.icon-wrapper {
    transition: transform 0.3s ease;
}

.card:hover .icon-wrapper {
    transform: scale(1.1);
}

.card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.rating-stars {
    font-size: 0.9rem;
}

/* Styles pour les cartes de gestion */
.management-card {
    border-left: 4px solid;
    transition: all 0.3s ease;
}

.management-card:hover {
    transform: translateX(5px);
}
</style>

<script>
$(document).ready(function() {
    // Animation pour les cartes
    $('.card').hover(
        function() {
            $(this).find('.card-img-top').css('opacity', '0.9');
        },
        function() {
            $(this).find('.card-img-top').css('opacity', '1');
        }
    );

    // Tooltips pour les boutons d'édition
    $('[title]').tooltip({
        trigger: 'hover',
        placement: 'top'
    });
});
</script>
{% endblock %}


========== core/migrations/0001_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 07:58

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name="ContactMessage",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("name", models.CharField(max_length=100, verbose_name="Nom")),
                ("email", models.EmailField(max_length=254, verbose_name="Email")),
                ("subject", models.CharField(max_length=200, verbose_name="Sujet")),
                ("message", models.TextField(verbose_name="Message")),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("NEW", "Nouveau"),
                            ("IN_PROGRESS", "En cours"),
                            ("RESOLVED", "Résolu"),
                            ("SPAM", "Spam"),
                        ],
                        default="NEW",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "ip_address",
                    models.GenericIPAddressField(
                        blank=True, null=True, verbose_name="Adresse IP"
                    ),
                ),
                ("user_agent", models.TextField(blank=True, verbose_name="User Agent")),
                (
                    "admin_notes",
                    models.TextField(
                        blank=True, verbose_name="Notes de l'administrateur"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Message de contact",
                "verbose_name_plural": "Messages de contact",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="Country",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "code",
                    models.CharField(
                        max_length=2, unique=True, verbose_name="Code ISO"
                    ),
                ),
                ("name", models.CharField(max_length=100, verbose_name="Nom")),
                (
                    "name_ar",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Nom en arabe"
                    ),
                ),
                (
                    "name_fr",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Nom en français"
                    ),
                ),
                (
                    "name_en",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Nom en anglais"
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(
                        default=True,
                        help_text="Le pays est-il disponible sur la plateforme ?",
                        verbose_name="Actif",
                    ),
                ),
                (
                    "is_departure",
                    models.BooleanField(
                        default=True,
                        help_text="Peut être un pays de départ",
                        verbose_name="Pays de départ",
                    ),
                ),
                (
                    "is_destination",
                    models.BooleanField(
                        default=True,
                        help_text="Peut être un pays de destination",
                        verbose_name="Pays de destination",
                    ),
                ),
                (
                    "currency_code",
                    models.CharField(
                        default="EUR", max_length=3, verbose_name="Code devise"
                    ),
                ),
                (
                    "currency_symbol",
                    models.CharField(
                        default="€", max_length=10, verbose_name="Symbole devise"
                    ),
                ),
                (
                    "phone_code",
                    models.CharField(
                        blank=True, max_length=10, verbose_name="Indicatif téléphonique"
                    ),
                ),
                (
                    "flag",
                    models.ImageField(
                        blank=True,
                        null=True,
                        upload_to="flags/",
                        verbose_name="Drapeau",
                    ),
                ),
                (
                    "display_order",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Ordre d'affichage"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Pays",
                "verbose_name_plural": "Pays",
                "ordering": ["display_order", "name"],
            },
        ),
        migrations.CreateModel(
            name="NewsletterSubscriber",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "email",
                    models.EmailField(
                        max_length=254, unique=True, verbose_name="Email"
                    ),
                ),
                ("is_active", models.BooleanField(default=True, verbose_name="Actif")),
                ("subscribed_at", models.DateTimeField(auto_now_add=True)),
                ("unsubscribed_at", models.DateTimeField(blank=True, null=True)),
            ],
            options={
                "verbose_name": "Abonné newsletter",
                "verbose_name_plural": "Abonnés newsletter",
                "ordering": ["-subscribed_at"],
            },
        ),
        migrations.CreateModel(
            name="SiteSetting",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "key",
                    models.CharField(
                        help_text="Identifiant unique du paramètre",
                        max_length=100,
                        unique=True,
                        verbose_name="Clé",
                    ),
                ),
                ("name", models.CharField(max_length=200, verbose_name="Nom affiché")),
                (
                    "value",
                    models.TextField(
                        help_text="Valeur du paramètre", verbose_name="Valeur"
                    ),
                ),
                (
                    "setting_type",
                    models.CharField(
                        choices=[
                            ("STRING", "Chaîne de caractères"),
                            ("INTEGER", "Nombre entier"),
                            ("BOOLEAN", "Booléen"),
                            ("JSON", "JSON"),
                            ("TEXT", "Texte long"),
                            ("EMAIL", "Email"),
                            ("URL", "URL"),
                        ],
                        default="STRING",
                        max_length=20,
                        verbose_name="Type de paramètre",
                    ),
                ),
                (
                    "group",
                    models.CharField(
                        default="general",
                        help_text="Groupe de paramètres",
                        max_length=50,
                        verbose_name="Groupe",
                    ),
                ),
                (
                    "is_public",
                    models.BooleanField(
                        default=False,
                        help_text="Peut être accédé dans les templates",
                        verbose_name="Public",
                    ),
                ),
                (
                    "description",
                    models.TextField(
                        blank=True,
                        help_text="Description détaillée du paramètre",
                        verbose_name="Description",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Paramètre du site",
                "verbose_name_plural": "Paramètres du site",
                "ordering": ["group", "key"],
            },
        ),
        migrations.CreateModel(
            name="FAQ",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("question", models.CharField(max_length=500, verbose_name="Question")),
                ("answer", models.TextField(verbose_name="Réponse")),
                (
                    "category",
                    models.CharField(
                        choices=[
                            ("GENERAL", "Général"),
                            ("ACCOUNT", "Compte"),
                            ("ADS", "Annonces"),
                            ("PAYMENTS", "Paiements"),
                            ("LOGISTICS", "Logistique"),
                            ("LEGAL", "Légal"),
                        ],
                        default="GENERAL",
                        max_length=20,
                        verbose_name="Catégorie",
                    ),
                ),
                (
                    "language",
                    models.CharField(
                        choices=[
                            ("ar", "العربية"),
                            ("fr", "Français"),
                            ("en", "English"),
                            ("de", "Deutsch"),
                            ("it", "Italiano"),
                            ("es", "Español"),
                            ("pt", "Português"),
                            ("pl", "Polski"),
                        ],
                        default="fr",
                        max_length=10,
                        verbose_name="Langue",
                    ),
                ),
                (
                    "display_order",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Ordre d'affichage"
                    ),
                ),
                ("is_active", models.BooleanField(default=True, verbose_name="Actif")),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "FAQ",
                "verbose_name_plural": "FAQs",
                "ordering": ["category", "display_order", "question"],
                "indexes": [
                    models.Index(
                        fields=["category", "language", "is_active"],
                        name="core_faq_categor_b657eb_idx",
                    )
                ],
            },
        ),
        migrations.CreateModel(
            name="Page",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("title", models.CharField(max_length=200, verbose_name="Titre")),
                (
                    "slug",
                    models.SlugField(
                        help_text="URL de la page",
                        max_length=200,
                        unique=True,
                        verbose_name="Slug",
                    ),
                ),
                (
                    "content",
                    models.TextField(
                        help_text="Contenu de la page (HTML autorisé)",
                        verbose_name="Contenu",
                    ),
                ),
                (
                    "language",
                    models.CharField(
                        choices=[
                            ("all", "Toutes les langues"),
                            ("ar", "العربية"),
                            ("fr", "Français"),
                            ("en", "English"),
                            ("de", "Deutsch"),
                            ("it", "Italiano"),
                            ("es", "Español"),
                            ("pt", "Português"),
                            ("pl", "Polski"),
                        ],
                        default="all",
                        max_length=10,
                        verbose_name="Langue",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("DRAFT", "Brouillon"),
                            ("PUBLISHED", "Publié"),
                            ("HIDDEN", "Caché"),
                        ],
                        default="DRAFT",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "show_in_footer",
                    models.BooleanField(
                        default=False, verbose_name="Afficher dans le pied de page"
                    ),
                ),
                (
                    "show_in_menu",
                    models.BooleanField(
                        default=False, verbose_name="Afficher dans le menu"
                    ),
                ),
                (
                    "menu_order",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Ordre dans le menu"
                    ),
                ),
                (
                    "meta_title",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Titre SEO"
                    ),
                ),
                (
                    "meta_description",
                    models.TextField(blank=True, verbose_name="Description SEO"),
                ),
                (
                    "meta_keywords",
                    models.CharField(
                        blank=True, max_length=500, verbose_name="Mots-clés SEO"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("published_at", models.DateTimeField(blank=True, null=True)),
            ],
            options={
                "verbose_name": "Page",
                "verbose_name_plural": "Pages",
                "ordering": ["menu_order", "title"],
                "indexes": [
                    models.Index(
                        fields=["slug", "status"], name="core_page_slug_1c639a_idx"
                    ),
                    models.Index(
                        fields=["language", "status"],
                        name="core_page_languag_c21106_idx",
                    ),
                ],
            },
        ),
        migrations.CreateModel(
            name="City",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "name",
                    models.CharField(max_length=100, verbose_name="Nom de la ville"),
                ),
                (
                    "name_ar",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Nom en arabe"
                    ),
                ),
                (
                    "name_fr",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Nom en français"
                    ),
                ),
                (
                    "name_en",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Nom en anglais"
                    ),
                ),
                (
                    "latitude",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Latitude",
                    ),
                ),
                (
                    "longitude",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Longitude",
                    ),
                ),
                ("is_active", models.BooleanField(default=True, verbose_name="Actif")),
                (
                    "population",
                    models.PositiveIntegerField(
                        blank=True, null=True, verbose_name="Population"
                    ),
                ),
                (
                    "timezone",
                    models.CharField(
                        blank=True, max_length=50, verbose_name="Fuseau horaire"
                    ),
                ),
                (
                    "display_order",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Ordre d'affichage"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "country",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="cities",
                        to="core.country",
                        verbose_name="Pays",
                    ),
                ),
            ],
            options={
                "verbose_name": "Ville",
                "verbose_name_plural": "Villes",
                "ordering": ["country", "display_order", "name"],
                "indexes": [
                    models.Index(
                        fields=["country", "is_active"],
                        name="core_city_country_93d21b_idx",
                    ),
                    models.Index(
                        fields=["name", "is_active"], name="core_city_name_85c917_idx"
                    ),
                ],
                "unique_together": {("name", "country")},
            },
        ),
    ]



========== core/migrations/__init__.py ==========



========== core/tests.py ==========
from django.test import TestCase

# Create your tests here.



========== core/admin.py ==========
# ~/ebi3/core/admin.py
from django.contrib import admin
from django.utils.html import format_html
from django.utils.translation import gettext_lazy as _
from .models import SiteSetting, Page, FAQ, Country, NewsletterSubscriber, ContactMessage

@admin.register(SiteSetting)
class SiteSettingAdmin(admin.ModelAdmin):
    """Administration des paramètres du site"""
    list_display = ('key', 'name', 'setting_type', 'group', 'is_public', 'updated_at')
    list_filter = ('setting_type', 'group', 'is_public')
    search_fields = ('key', 'name', 'description')
    list_editable = ('is_public',)

    fieldsets = (
        (_('Paramètre'), {
            'fields': ('key', 'name', 'description', 'group')
        }),
        (_('Valeur'), {
            'fields': ('setting_type', 'value')
        }),
        (_('Visibilité'), {
            'fields': ('is_public',)
        }),
    )

    # ✅ CORRECTION : actions doit être une liste, pas une méthode
    actions = ['clear_cache']

    def clear_cache(self, request, queryset):
        """Efface le cache des paramètres sélectionnés"""
        from django.core.cache import cache
        for setting in queryset:
            cache.delete(f'site_setting_{setting.key}')
        self.message_user(request, _('Cache effacé pour les paramètres sélectionnés.'))
    clear_cache.short_description = _('Effacer le cache')


@admin.register(Page)
class PageAdmin(admin.ModelAdmin):
    """Administration des pages"""
    list_display = ('title', 'slug', 'language', 'status', 'show_in_menu', 'show_in_footer', 'updated_at')
    list_filter = ('status', 'language', 'show_in_menu', 'show_in_footer')
    search_fields = ('title', 'content', 'slug')
    list_editable = ('status', 'show_in_menu', 'show_in_footer')
    prepopulated_fields = {'slug': ('title',)}

    fieldsets = (
        (_('Contenu'), {
            'fields': ('title', 'slug', 'content', 'language')
        }),
        (_('Publication'), {
            'fields': ('status', 'published_at')
        }),
        (_('Navigation'), {
            'fields': ('show_in_menu', 'show_in_footer', 'menu_order')
        }),
        (_('SEO'), {
            'fields': ('meta_title', 'meta_description', 'meta_keywords'),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION : actions doit être une liste de noms de méthodes
    actions = ['make_published', 'make_draft']

    def make_published(self, request, queryset):
        updated = queryset.update(status='PUBLISHED')
        self.message_user(request, _(f'{updated} pages ont été publiées.'))
    make_published.short_description = _('Publier les pages sélectionnées')

    def make_draft(self, request, queryset):
        updated = queryset.update(status='DRAFT')
        self.message_user(request, _(f'{updated} pages sont maintenant en brouillon.'))
    make_draft.short_description = _('Mettre en brouillon')


@admin.register(FAQ)
class FAQAdmin(admin.ModelAdmin):
    """Administration des FAQs"""
    list_display = ('question', 'category', 'language', 'display_order', 'is_active')
    list_filter = ('category', 'language', 'is_active')
    search_fields = ('question', 'answer')
    list_editable = ('display_order', 'is_active')

    fieldsets = (
        (_('Contenu'), {
            'fields': ('question', 'answer', 'category', 'language')
        }),
        (_('Affichage'), {
            'fields': ('display_order', 'is_active')
        }),
    )

    # ✅ CORRECTION : actions doit être une liste de noms de méthodes
    actions = ['activate_faqs', 'deactivate_faqs']

    def activate_faqs(self, request, queryset):
        updated = queryset.update(is_active=True)
        self.message_user(request, _(f'{updated} FAQs ont été activées.'))
    activate_faqs.short_description = _('Activer les FAQs')

    def deactivate_faqs(self, request, queryset):
        updated = queryset.update(is_active=False)
        self.message_user(request, _(f'{updated} FAQs ont été désactivées.'))
    deactivate_faqs.short_description = _('Désactiver les FAQs')


@admin.register(Country)
class CountryAdmin(admin.ModelAdmin):
    """Administration des pays"""
    list_display = ('name', 'code', 'is_active', 'is_departure', 'is_destination', 'currency_code', 'display_order')
    list_filter = ('is_active', 'is_departure', 'is_destination')
    search_fields = ('name', 'code', 'name_ar', 'name_fr', 'name_en')
    list_editable = ('is_active', 'is_departure', 'is_destination', 'display_order')

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('code', 'name', 'name_ar', 'name_fr', 'name_en')
        }),
        (_('Configuration'), {
            'fields': ('is_active', 'is_departure', 'is_destination', 'display_order')
        }),
        (_('Monnaie'), {
            'fields': ('currency_code', 'currency_symbol')
        }),
        (_('Contact'), {
            'fields': ('phone_code', 'flag')
        }),
    )

    # ✅ AJOUT : actions doit être défini (liste vide si pas d'actions)
    actions = []


@admin.register(NewsletterSubscriber)
class NewsletterSubscriberAdmin(admin.ModelAdmin):
    """Administration des abonnés newsletter"""
    list_display = ('email', 'is_active', 'subscribed_at', 'unsubscribed_at')
    list_filter = ('is_active', 'subscribed_at')
    search_fields = ('email',)
    readonly_fields = ('subscribed_at', 'unsubscribed_at')

    # ✅ CORRECTION : actions doit être une liste de noms de méthodes
    actions = ['unsubscribe_selected']

    def unsubscribe_selected(self, request, queryset):
        updated = 0
        for subscriber in queryset:
            subscriber.unsubscribe()
            updated += 1
        self.message_user(request, _(f'{updated} abonnés ont été désinscrits.'))
    unsubscribe_selected.short_description = _('Désinscrire les abonnés sélectionnés')


@admin.register(ContactMessage)
class ContactMessageAdmin(admin.ModelAdmin):
    """Administration des messages de contact"""
    list_display = ('name', 'email', 'subject', 'status', 'created_at')
    list_filter = ('status', 'created_at')
    search_fields = ('name', 'email', 'subject', 'message')
    readonly_fields = ('created_at', 'updated_at', 'ip_address', 'user_agent')
    list_editable = ('status',)

    fieldsets = (
        (_('Message'), {
            'fields': ('name', 'email', 'subject', 'message')
        }),
        (_('Statut'), {
            'fields': ('status', 'admin_notes')
        }),
        (_('Métadonnées'), {
            'fields': ('ip_address', 'user_agent', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION : actions doit être une liste de noms de méthodes
    actions = ['mark_as_resolved', 'mark_as_spam']

    def mark_as_resolved(self, request, queryset):
        updated = queryset.update(status='RESOLVED')
        self.message_user(request, _(f'{updated} messages ont été marqués comme résolus.'))
    mark_as_resolved.short_description = _('Marquer comme résolu')

    def mark_as_spam(self, request, queryset):
        updated = queryset.update(status='SPAM')
        self.message_user(request, _(f'{updated} messages ont été marqués comme spam.'))
    mark_as_spam.short_description = _('Marquer comme spam')


========== core/forms.py ==========
# ~/ebi3/core/forms.py
from django import forms
from django.utils.translation import gettext_lazy as _
from django.core.validators import validate_email
from .models import ContactMessage, NewsletterSubscriber

class ContactForm(forms.ModelForm):
    """Formulaire de contact"""

    class Meta:
        model = ContactMessage
        fields = ['name', 'email', 'subject', 'message']
        widgets = {
            'name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Votre nom complet')
            }),
            'email': forms.EmailInput(attrs={
                'class': 'form-control',
                'placeholder': _('Votre adresse email')
            }),
            'subject': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Sujet de votre message')
            }),
            'message': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 5,
                'placeholder': _('Votre message...')
            }),
        }
        labels = {
            'name': _('Nom'),
            'email': _('Email'),
            'subject': _('Sujet'),
            'message': _('Message'),
        }


class NewsletterForm(forms.Form):
    """Formulaire d'inscription à la newsletter"""

    email = forms.EmailField(
        label=_("Email"),
        widget=forms.EmailInput(attrs={
            'class': 'form-control',
            'placeholder': _('Votre email'),
            'aria-label': _('Email pour newsletter')
        })
    )

    consent = forms.BooleanField(
        required=True,
        label=_("J'accepte de recevoir des newsletters"),
        widget=forms.CheckboxInput(attrs={
            'class': 'form-check-input'
        })
    )

    def clean_email(self):
        email = self.cleaned_data['email']
        validate_email(email)

        # Vérifier si l'email est déjà inscrit et actif
        if NewsletterSubscriber.objects.filter(email=email, is_active=True).exists():
            raise forms.ValidationError(
                _("Cet email est déjà inscrit à notre newsletter.")
            )

        return email

    def save(self, request=None):
        """Sauvegarde l'abonné"""
        email = self.cleaned_data['email']

        # Désactiver l'ancien abonnement s'il existe
        NewsletterSubscriber.objects.filter(email=email).update(is_active=False)

        # Créer un nouvel abonnement
        subscriber = NewsletterSubscriber.objects.create(
            email=email,
            is_active=True
        )

        return subscriber


class LanguageForm(forms.Form):
    """Formulaire de sélection de langue"""

    language = forms.ChoiceField(
        choices=[],
        widget=forms.Select(attrs={
            'class': 'form-select',
            'onchange': 'this.form.submit()'
        })
    )

    def __init__(self, *args, **kwargs):
        from django.conf import settings
        super().__init__(*args, **kwargs)
        self.fields['language'].choices = settings.LANGUAGES


========== core/__init__.py ==========



========== core/apps.py ==========
from django.apps import AppConfig


class CoreConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "core"



========== core/urls.py ==========
# ~/ebi3/core/urls.py
from django.urls import path
from django.views.i18n import set_language
from . import views

app_name = 'core'

urlpatterns = [

    path('', views.HomeView.as_view(), name='home'),
    path('about/', views.AboutView.as_view(), name='about'),
    path('contact/', views.ContactView.as_view(), name='contact'),
    path('faq/', views.FAQListView.as_view(), name='faq'),
    path('terms/', views.TermsView.as_view(), name='terms'),
    path('privacy/', views.PrivacyView.as_view(), name='privacy'),
    path('page/<slug:slug>/', views.PageDetailView.as_view(), name='page'),

    # Actions
    path('set-language/', set_language, name='set_language'),
    path('newsletter/subscribe/', views.newsletter_subscribe, name='newsletter_subscribe'),
]


========== core/context_processors.py ==========
# ~/ebi3/core/context_processors.py
from django.conf import settings
from django.utils.translation import get_language, get_language_bidi
from .models import SiteSetting, Page

def site_settings(request):
    """Context processor pour les paramètres du site"""
    return {
        'SITE_NAME': SiteSetting.get_setting('site_name', 'Ebi3'),
        'SITE_DESCRIPTION': SiteSetting.get_setting('site_description', 'Plateforme de petites annonces et de Logistique Transfrontalière'),
        'SITE_URL': SiteSetting.get_setting('site_url', 'https://ebi3.org'),
        'CONTACT_EMAIL': SiteSetting.get_setting('contact_email', 'contact@ebi3.org'),
        'SUPPORT_EMAIL': SiteSetting.get_setting('support_email', 'support@ebi3.org'),
        'PHONE_NUMBER': SiteSetting.get_setting('phone_number', '+33 1 23 45 67 89'),
        'ADDRESS': SiteSetting.get_setting('address', 'Mulhouse, France'),
        'FACEBOOK_URL': SiteSetting.get_setting('facebook_url', '#'),
        'TWITTER_URL': SiteSetting.get_setting('twitter_url', '#'),
        'INSTAGRAM_URL': SiteSetting.get_setting('instagram_url', '#'),
        'LINKEDIN_URL': SiteSetting.get_setting('linkedin_url', '#'),
        'CURRENT_LANGUAGE': get_language(),
        'LANGUAGE_BIDI': get_language_bidi(),
        'ALL_LANGUAGES': settings.LANGUAGES,
    }

def footer_pages(request):
    """Context processor pour les pages du footer"""
    return {
        'FOOTER_PAGES': Page.objects.filter(
            show_in_footer=True,
            status=Page.Status.PUBLISHED
        ).order_by('menu_order')
    }

def menu_pages(request):
    """Context processor pour les pages du menu"""
    return {
        'MENU_PAGES': Page.objects.filter(
            show_in_menu=True,
            status=Page.Status.PUBLISHED
        ).order_by('menu_order')
    }


========== core/models.py ==========
# ~/ebi3/core/models.py
from django.db import models
from django.utils.translation import gettext_lazy as _
from django.utils.text import slugify
from django.urls import reverse
from django.core.cache import cache
from django.utils import timezone
import json

# SUPPRIMER cette ligne problématique (importation circulaire)
# from core.models import Country, City

class SiteSetting(models.Model):
    """Paramètres globaux du site"""

    class SettingType(models.TextChoices):
        STRING = 'STRING', _('Chaîne de caractères')
        INTEGER = 'INTEGER', _('Nombre entier')
        BOOLEAN = 'BOOLEAN', _('Booléen')
        JSON = 'JSON', _('JSON')
        TEXT = 'TEXT', _('Texte long')
        EMAIL = 'EMAIL', _('Email')
        URL = 'URL', _('URL')

    key = models.CharField(
        max_length=100,
        unique=True,
        verbose_name=_("Clé"),
        help_text=_("Identifiant unique du paramètre")
    )

    name = models.CharField(
        max_length=200,
        verbose_name=_("Nom affiché")
    )

    value = models.TextField(
        verbose_name=_("Valeur"),
        help_text=_("Valeur du paramètre")
    )

    setting_type = models.CharField(
        max_length=20,
        choices=SettingType.choices,
        default=SettingType.STRING,
        verbose_name=_("Type de paramètre")
    )

    group = models.CharField(
        max_length=50,
        default='general',
        verbose_name=_("Groupe"),
        help_text=_("Groupe de paramètres")
    )

    is_public = models.BooleanField(
        default=False,
        verbose_name=_("Public"),
        help_text=_("Peut être accédé dans les templates")
    )

    description = models.TextField(
        blank=True,
        verbose_name=_("Description"),
        help_text=_("Description détaillée du paramètre")
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Paramètre du site")
        verbose_name_plural = _("Paramètres du site")
        ordering = ['group', 'key']

    def __str__(self):
        return f"{self.name} ({self.key})"

    def get_value(self):
        """Retourne la valeur convertie selon le type"""
        if self.setting_type == self.SettingType.BOOLEAN:
            return self.value.lower() in ('true', '1', 'yes', 'y', 't')
        elif self.setting_type == self.SettingType.INTEGER:
            try:
                return int(self.value)
            except ValueError:
                return 0
        elif self.setting_type == self.SettingType.JSON:
            try:
                return json.loads(self.value)
            except json.JSONDecodeError:
                return {}
        else:
            return self.value

    @classmethod
    def get_setting(cls, key, default=None):
        """Récupère un paramètre avec cache"""
        cache_key = f'site_setting_{key}'
        value = cache.get(cache_key)

        if value is None:
            try:
                setting = cls.objects.get(key=key)
                value = setting.get_value()
                cache.set(cache_key, value, 3600)  # Cache pour 1 heure
            except cls.DoesNotExist:
                value = default
                cache.set(cache_key, value, 300)  # Cache court pour les valeurs par défaut

        return value

    @classmethod
    def set_setting(cls, key, value, setting_type='STRING'):
        """Définit un paramètre"""
        setting, created = cls.objects.get_or_create(
            key=key,
            defaults={
                'name': key.replace('_', ' ').title(),
                'value': str(value),
                'setting_type': setting_type,
            }
        )

        if not created:
            setting.value = str(value)
            setting.setting_type = setting_type
            setting.save()

        # Invalider le cache
        cache.delete(f'site_setting_{key}')
        return setting


class Page(models.Model):
    """Pages statiques du site"""

    class Status(models.TextChoices):
        DRAFT = 'DRAFT', _('Brouillon')
        PUBLISHED = 'PUBLISHED', _('Publié')
        HIDDEN = 'HIDDEN', _('Caché')

    title = models.CharField(
        max_length=200,
        verbose_name=_("Titre")
    )

    slug = models.SlugField(
        max_length=200,
        unique=True,
        verbose_name=_("Slug"),
        help_text=_("URL de la page")
    )

    content = models.TextField(
        verbose_name=_("Contenu"),
        help_text=_("Contenu de la page (HTML autorisé)")
    )

    language = models.CharField(
        max_length=10,
        choices=[
            ('all', _('Toutes les langues')),
            ('ar', 'العربية'),
            ('fr', 'Français'),
            ('en', 'English'),
            ('de', 'Deutsch'),
            ('it', 'Italiano'),
            ('es', 'Español'),
            ('pt', 'Português'),
            ('pl', 'Polski'),
        ],
        default='all',
        verbose_name=_("Langue")
    )

    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.DRAFT,
        verbose_name=_("Statut")
    )

    show_in_footer = models.BooleanField(
        default=False,
        verbose_name=_("Afficher dans le pied de page")
    )

    show_in_menu = models.BooleanField(
        default=False,
        verbose_name=_("Afficher dans le menu")
    )

    menu_order = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Ordre dans le menu")
    )

    meta_title = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Titre SEO")
    )

    meta_description = models.TextField(
        blank=True,
        verbose_name=_("Description SEO")
    )

    meta_keywords = models.CharField(
        max_length=500,
        blank=True,
        verbose_name=_("Mots-clés SEO")
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    published_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        verbose_name = _("Page")
        verbose_name_plural = _("Pages")
        ordering = ['menu_order', 'title']
        indexes = [
            models.Index(fields=['slug', 'status']),
            models.Index(fields=['language', 'status']),
        ]

    def __str__(self):
        return self.title

    def save(self, *args, **kwargs):
        if self.status == self.Status.PUBLISHED and not self.published_at:
            self.published_at = timezone.now()

        # Générer le slug s'il n'existe pas
        if not self.slug:
            self.slug = slugify(self.title)

        super().save(*args, **kwargs)

    def get_absolute_url(self):
        return reverse('core:page', kwargs={'slug': self.slug})


class Country(models.Model):
    """Pays supportés avec informations spécifiques"""

    code = models.CharField(
        max_length=2,
        unique=True,
        verbose_name=_("Code ISO")
    )

    name = models.CharField(
        max_length=100,
        verbose_name=_("Nom")
    )

    name_ar = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Nom en arabe")
    )

    name_fr = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Nom en français")
    )

    name_en = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Nom en anglais")
    )

    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Actif"),
        help_text=_("Le pays est-il disponible sur la plateforme ?")
    )

    is_departure = models.BooleanField(
        default=True,
        verbose_name=_("Pays de départ"),
        help_text=_("Peut être un pays de départ")
    )

    is_destination = models.BooleanField(
        default=True,
        verbose_name=_("Pays de destination"),
        help_text=_("Peut être un pays de destination")
    )

    currency_code = models.CharField(
        max_length=3,
        default='EUR',
        verbose_name=_("Code devise")
    )

    currency_symbol = models.CharField(
        max_length=10,
        default='€',
        verbose_name=_("Symbole devise")
    )

    phone_code = models.CharField(
        max_length=10,
        blank=True,
        verbose_name=_("Indicatif téléphonique")
    )

    flag = models.ImageField(
        upload_to='flags/',
        null=True,
        blank=True,
        verbose_name=_("Drapeau")
    )

    display_order = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Ordre d'affichage")
    )

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Pays")
        verbose_name_plural = _("Pays")
        ordering = ['display_order', 'name']

    def __str__(self):
        return self.name

    def get_name(self, language=None):
        """Retourne le nom dans la langue spécifiée"""
        if language == 'ar' and self.name_ar:
            return self.name_ar
        elif language == 'fr' and self.name_fr:
            return self.name_fr
        elif language == 'en' and self.name_en:
            return self.name_en
        return self.name


class City(models.Model):
    """Villes supportées avec géolocalisation"""

    name = models.CharField(
        max_length=100,
        verbose_name=_("Nom de la ville")
    )

    name_ar = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Nom en arabe")
    )

    name_fr = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Nom en français")
    )

    name_en = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Nom en anglais")
    )

    country = models.ForeignKey(
        Country,
        on_delete=models.CASCADE,
        related_name='cities',
        verbose_name=_("Pays")
    )

    latitude = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Latitude")
    )

    longitude = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Longitude")
    )

    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Actif")
    )

    population = models.PositiveIntegerField(
        null=True,
        blank=True,
        verbose_name=_("Population")
    )

    timezone = models.CharField(
        max_length=50,
        blank=True,
        verbose_name=_("Fuseau horaire")
    )

    display_order = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Ordre d'affichage")
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Ville")
        verbose_name_plural = _("Villes")
        ordering = ['country', 'display_order', 'name']
        unique_together = ['name', 'country']
        indexes = [
            models.Index(fields=['country', 'is_active']),
            models.Index(fields=['name', 'is_active']),
        ]

    def __str__(self):
        return f"{self.name}, {self.country.name}"

    def get_name(self, language=None):
        """Retourne le nom dans la langue spécifiée"""
        if language == 'ar' and self.name_ar:
            return self.name_ar
        elif language == 'fr' and self.name_fr:
            return self.name_fr
        elif language == 'en' and self.name_en:
            return self.name_en
        return self.name


class FAQ(models.Model):
    """FAQ du site"""

    class Category(models.TextChoices):
        GENERAL = 'GENERAL', _('Général')
        ACCOUNT = 'ACCOUNT', _('Compte')
        ADS = 'ADS', _('Annonces')
        PAYMENTS = 'PAYMENTS', _('Paiements')
        LOGISTICS = 'LOGISTICS', _('Logistique')
        LEGAL = 'LEGAL', _('Légal')

    question = models.CharField(
        max_length=500,
        verbose_name=_("Question")
    )

    answer = models.TextField(
        verbose_name=_("Réponse")
    )

    category = models.CharField(
        max_length=20,
        choices=Category.choices,
        default=Category.GENERAL,
        verbose_name=_("Catégorie")
    )

    language = models.CharField(
        max_length=10,
        choices=[
            ('ar', 'العربية'),
            ('fr', 'Français'),
            ('en', 'English'),
            ('de', 'Deutsch'),
            ('it', 'Italiano'),
            ('es', 'Español'),
            ('pt', 'Português'),
            ('pl', 'Polski'),
        ],
        default='fr',
        verbose_name=_("Langue")
    )

    display_order = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Ordre d'affichage")
    )

    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Actif")
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("FAQ")
        verbose_name_plural = _("FAQs")
        ordering = ['category', 'display_order', 'question']
        indexes = [
            models.Index(fields=['category', 'language', 'is_active']),
        ]

    def __str__(self):
        return f"{self.question[:50]}..."


class NewsletterSubscriber(models.Model):
    """Abonnés à la newsletter"""

    email = models.EmailField(
        unique=True,
        verbose_name=_("Email")
    )

    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Actif")
    )

    subscribed_at = models.DateTimeField(auto_now_add=True)
    unsubscribed_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        verbose_name = _("Abonné newsletter")
        verbose_name_plural = _("Abonnés newsletter")
        ordering = ['-subscribed_at']

    def __str__(self):
        return self.email

    def unsubscribe(self):
        self.is_active = False
        self.unsubscribed_at = timezone.now()
        self.save()


class ContactMessage(models.Model):
    """Messages de contact"""

    class Status(models.TextChoices):
        NEW = 'NEW', _('Nouveau')
        IN_PROGRESS = 'IN_PROGRESS', _('En cours')
        RESOLVED = 'RESOLVED', _('Résolu')
        SPAM = 'SPAM', _('Spam')

    name = models.CharField(
        max_length=100,
        verbose_name=_("Nom")
    )

    email = models.EmailField(
        verbose_name=_("Email")
    )

    subject = models.CharField(
        max_length=200,
        verbose_name=_("Sujet")
    )

    message = models.TextField(
        verbose_name=_("Message")
    )

    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.NEW,
        verbose_name=_("Statut")
    )

    ip_address = models.GenericIPAddressField(
        null=True,
        blank=True,
        verbose_name=_("Adresse IP")
    )

    user_agent = models.TextField(
        blank=True,
        verbose_name=_("User Agent")
    )

    admin_notes = models.TextField(
        blank=True,
        verbose_name=_("Notes de l'administrateur")
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Message de contact")
        verbose_name_plural = _("Messages de contact")
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.subject} - {self.email}"


========== core/views.py ==========
# ~/ebi3/core/views.py
from django.shortcuts import render, get_object_or_404, redirect
from django.views.generic import TemplateView, ListView, DetailView, CreateView
from django.utils.translation import gettext_lazy as _, activate, get_language
from django.contrib import messages
from django.urls import reverse_lazy
from django.conf import settings
from django.http import JsonResponse, HttpResponseRedirect
from django.views.decorators.http import require_POST
from django.views.decorators.csrf import csrf_protect
from django.utils.decorators import method_decorator

from .models import Page, FAQ, Country, ContactMessage, NewsletterSubscriber
from .forms import ContactForm, NewsletterForm


class HomeView(TemplateView):
    """Page d'accueil"""
    template_name = 'core/home.html'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Import des modèles nécessaires
        from ads.models import Ad
        from carriers.models import Carrier
        from users.models import User
        from colis.models import Package

        # Debug: Vérifier toutes les annonces
        all_ads = Ad.objects.all()
        active_ads = Ad.objects.filter(status=Ad.Status.ACTIVE)

        print(f"DEBUG - Toutes les annonces: {all_ads.count()}")
        print(f"DEBUG - Annonces ACTIVES: {active_ads.count()}")

        for ad in all_ads:
            print(f"DEBUG - Annonce: {ad.title}, Statut: {ad.status}")

        # Statistiques pour la page d'accueil
        context.update({
            'total_ads': active_ads.count(),
            'total_carriers': Carrier.objects.filter(status='APPROVED').count(),
            'total_users': User.objects.filter(is_active=True).count(),
        })

        # Annonces récentes - INCLURE D'AUTRES STATUTS POUR LE TEST
        context['recent_ads'] = Ad.objects.filter(
            status__in=[Ad.Status.ACTIVE, Ad.Status.RESERVED, Ad.Status.DRAFT, Ad.Status.PENDING]  # Ajouter d'autres statuts si nécessaire
        ).select_related('seller', 'category').prefetch_related('images').order_by('-created_at')[:8]  # Augmenter à 8 pour le test

        # Colis récents
        try:
            context['recent_packages'] = Package.objects.filter(
                status='PUBLISHED'
            ).select_related('sender').prefetch_related('images').order_by('-created_at')[:4]
        except Exception as e:
            print(f"DEBUG - Erreur packages: {e}")
            context['recent_packages'] = []

        # Transporteurs récents
        context['recent_carriers'] = Carrier.objects.filter(
            status='APPROVED',
            is_available=True
        ).select_related('user').order_by('-created_at')[:4]

        # Annonces en vedette
        context['featured_ads'] = Ad.objects.filter(
            is_featured=True,
            status__in=[Ad.Status.ACTIVE, Ad.Status.RESERVED]
        ).select_related('seller', 'category').prefetch_related('images')[:4]

        return context


class PageDetailView(DetailView):
    """Détail d'une page statique"""
    model = Page
    template_name = 'core/page.html'
    context_object_name = 'page'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'

    def get_queryset(self):
        return Page.objects.filter(status=Page.Status.PUBLISHED)


class FAQListView(ListView):
    """Liste des FAQs"""
    model = FAQ
    template_name = 'core/faq.html'
    context_object_name = 'faqs'

    def get_queryset(self):
        current_language = get_language()
        return FAQ.objects.filter(
            language=current_language,
            is_active=True
        ).order_by('category', 'display_order')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Grouper les FAQs par catégorie
        faqs_by_category = {}
        for faq in context['faqs']:
            if faq.category not in faqs_by_category:
                faqs_by_category[faq.category] = []
            faqs_by_category[faq.category].append(faq)

        context['faqs_by_category'] = faqs_by_category
        return context


class ContactView(CreateView):
    """Page de contact"""
    model = ContactMessage
    form_class = ContactForm
    template_name = 'core/contact.html'
    success_url = reverse_lazy('core:contact')

    def form_valid(self, form):
        # Ajouter les informations de la requête
        contact_message = form.save(commit=False)
        contact_message.ip_address = self.request.META.get('REMOTE_ADDR')
        contact_message.user_agent = self.request.META.get('HTTP_USER_AGENT', '')
        contact_message.save()

        messages.success(
            self.request,
            _("Votre message a été envoyé avec succès. Nous vous répondrons dans les plus brefs délais.")
        )
        return super().form_valid(form)


class AboutView(TemplateView):
    """Page À propos"""
    template_name = 'core/about.html'


class TermsView(TemplateView):
    """Conditions d'utilisation"""
    template_name = 'core/terms.html'


class PrivacyView(TemplateView):
    """Politique de confidentialité"""
    template_name = 'core/privacy.html'


@csrf_protect
@require_POST
def change_language(request):
    """Changer la langue du site"""
    language = request.POST.get('language')

    if language in [lang[0] for lang in settings.LANGUAGES]:
        activate(language)
        request.session[settings.LANGUAGE_COOKIE_NAME] = language

        # Rediriger vers la même page
        next_url = request.POST.get('next', request.META.get('HTTP_REFERER', '/'))
        response = HttpResponseRedirect(next_url)
        response.set_cookie(
            settings.LANGUAGE_COOKIE_NAME,
            language,
            max_age=settings.LANGUAGE_COOKIE_AGE,
            path=settings.LANGUAGE_COOKIE_PATH,
            secure=settings.LANGUAGE_COOKIE_SECURE,
            httponly=settings.LANGUAGE_COOKIE_HTTPONLY,
            samesite=settings.LANGUAGE_COOKIE_SAMESITE
        )
        return response

    return redirect('core:home')


@csrf_protect
@require_POST
def newsletter_subscribe(request):
    """S'abonner à la newsletter"""
    form = NewsletterForm(request.POST)

    if form.is_valid():
        subscriber = form.save()

        if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({
                'status': 'success',
                'message': str(_("Vous êtes maintenant inscrit à notre newsletter !"))
            })

        messages.success(request, _("Vous êtes maintenant inscrit à notre newsletter !"))
        return redirect(request.META.get('HTTP_REFERER', 'core:home'))

    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        return JsonResponse({
            'status': 'error',
            'errors': form.errors
        }, status=400)

    messages.error(request, _("Une erreur est survenue. Veuillez réessayer."))
    return redirect(request.META.get('HTTP_REFERER', 'core:home'))


def handler404(request, exception):
    """Handler 404 personnalisé"""
    return render(request, 'core/404.html', status=404)


def handler500(request):
    """Handler 500 personnalisé"""
    return render(request, 'core/500.html', status=500)


def handler403(request, exception):
    """Handler 403 personnalisé"""
    return render(request, 'core/403.html', status=403)


def handler400(request, exception):
    """Handler 400 personnalisé"""
    return render(request, 'core/400.html', status=400)




========== dashboard/migrations/__init__.py ==========



========== dashboard/tests.py ==========
from django.test import TestCase

# Create your tests here.



========== dashboard/admin.py ==========
from django.contrib import admin



========== dashboard/__init__.py ==========



========== dashboard/apps.py ==========
from django.apps import AppConfig


class DashboardConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "dashboard"



========== dashboard/urls.py ==========
from django.urls import path

app_name = 'dashboard'
urlpatterns = []



========== dashboard/models.py ==========
from django.db import models

# Create your models here.



========== dashboard/views.py ==========
from django.shortcuts import render

# Create your views here.



========== ebi3/middlewares/audit.py ==========
# ~/ebi3/ebi3/middlewares/audit.py
"""
Middleware d'audit pour le logging complet des requêtes et réponses
"""
import time
import json
import logging
# from django.utils.deprecation import MiddlewareMixin  # REMOVED for Django 6.0
from django.utils import timezone
from django.conf import settings

logger = logging.getLogger(__name__)


class AuditMiddleware::
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # Appeler process_request si existant
        if hasattr(self, 'process_request'):
            response = self.process_request(request)
            if response is not None:
                return response

        response = self.get_response(request)
        return response
    """
    Middleware d'audit qui logge :
    - Toutes les requêtes entrantes
    - Les réponses sortantes
    - Les erreurs
    - Les requêtes lentes
    """

    def __init__(self, get_response):
        self.get_response = get_response
        self.config = getattr(settings, 'AUDIT_MIDDLEWARE_CONFIG', {})

    def get_client_ip(self, request):
        """Obtenir l'adresse IP réelle du client"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0]
        else:
            ip = request.META.get('REMOTE_ADDR')
        return ip

    def mask_sensitive_data(self, data):
        """Masquer les données sensibles"""
        if not isinstance(data, dict):
            return data

        masked_fields = self.config.get('mask_fields', [])
        result = data.copy()

        for key, value in result.items():
            if isinstance(value, dict):
                result[key] = self.mask_sensitive_data(value)
            elif isinstance(value, str) and any(field in key.lower() for field in masked_fields):
                result[key] = '***MASKED***'

        return result

    def process_request(self, request):
        """Enregistrer le début de la requête"""
        if not self.config.get('log_requests', True):
            return None

        # Début du timer
        request.start_time = time.time()

        # Préparer les données de log
        ip = self.get_client_ip(request)
        user = request.user if request.user.is_authenticated else 'anonymous'

        log_data = {
            'timestamp': timezone.now().isoformat(),
            'type': 'REQUEST_START',
            'ip': ip,
            'user': str(user),
            'method': request.method,
            'path': request.path,
            'query_string': request.META.get('QUERY_STRING', ''),
            'content_type': request.content_type,
            'user_agent': request.META.get('HTTP_USER_AGENT', '')[:200],
            'referer': request.META.get('HTTP_REFERER', '')[:200],
        }

        # Ajouter les paramètres (masqués si nécessaire)
        if self.config.get('log_sensitive_data', False):
            if request.method == 'GET':
                log_data['get_params'] = dict(request.GET)
            elif request.method == 'POST':
                log_data['post_params'] = dict(request.POST)
        else:
            if request.method == 'GET':
                log_data['get_params'] = self.mask_sensitive_data(dict(request.GET))
            elif request.method == 'POST':
                log_data['post_params'] = self.mask_sensitive_data(dict(request.POST))

        # Logger
        logger.info(f"AUDIT REQUEST: {json.dumps(log_data)}")

        return None

    def process_response(self, request, response):
        """Enregistrer la fin de la requête"""
        if not hasattr(request, 'start_time'):
            return response

        end_time = time.time()
        duration = end_time - request.start_time

        # Vérifier les requêtes lentes
        slow_threshold = self.config.get('slow_request_threshold', 5.0)
        is_slow = duration > slow_threshold

        if self.config.get('log_responses', True) or (is_slow and self.config.get('log_slow_requests', True)):
            ip = self.get_client_ip(request)
            user = request.user if request.user.is_authenticated else 'anonymous'

            log_data = {
                'timestamp': timezone.now().isoformat(),
                'type': 'REQUEST_END',
                'ip': ip,
                'user': str(user),
                'method': request.method,
                'path': request.path,
                'status_code': response.status_code,
                'duration': round(duration, 3),
                'is_slow': is_slow,
                'content_length': len(response.content) if hasattr(response, 'content') else 0,
            }

            # Ajouter les détails d'erreur pour les codes 4xx/5xx
            if response.status_code >= 400:
                log_data['error'] = True
                if hasattr(response, 'content'):
                    try:
                        content = response.content.decode('utf-8')[:500]
                        log_data['error_content'] = content
                    except:
                        pass

            # Logger
            logger.info(f"AUDIT RESPONSE: {json.dumps(log_data)}")

            # Alerter pour les requêtes lentes
            if is_slow:
                logger.warning(f"SLOW REQUEST ({duration:.2f}s): {request.method} {request.path}")

            # Sauvegarder dans la base de données
            from audit.models import AuditLog
            try:
                AuditLog.objects.create(
                    timestamp=timezone.now(),
                    user=user if user != 'anonymous' else None,
                    action=f"{request.method} {request.path}",
                    ip_address=ip,
                    user_agent=request.META.get('HTTP_USER_AGENT', '')[:200],
                    status_code=response.status_code,
                    duration=duration,
                    is_slow=is_slow,
                    metadata=log_data
                )
            except Exception as e:
                logger.error(f"Failed to save audit log: {e}")

        return response

    def process_exception(self, request, exception):
        """Enregistrer les exceptions"""
        if not self.config.get('log_errors', True):
            return None

        ip = self.get_client_ip(request)
        user = request.user if request.user.is_authenticated else 'anonymous'

        log_data = {
            'timestamp': timezone.now().isoformat(),
            'type': 'EXCEPTION',
            'ip': ip,
            'user': str(user),
            'method': request.method,
            'path': request.path,
            'exception_type': type(exception).__name__,
            'exception_message': str(exception),
            'traceback': self.get_traceback(exception),
        }

        # Logger
        logger.error(f"AUDIT EXCEPTION: {json.dumps(log_data)}")

        # Sauvegarder dans la base de données
        from audit.models import ErrorLog
        try:
            ErrorLog.objects.create(
                timestamp=timezone.now(),
                user=user if user != 'anonymous' else None,
                ip_address=ip,
                method=request.method,
                path=request.path,
                exception_type=type(exception).__name__,
                exception_message=str(exception)[:500],
                traceback=log_data['traceback'][:2000],
                metadata=log_data
            )
        except Exception as e:
            logger.error(f"Failed to save error log: {e}")

        return None

    def get_traceback(self, exception):
        """Obtenir la traceback de l'exception"""
        import traceback
        return ''.join(traceback.format_exception(type(exception), exception, exception.__traceback__))


========== ebi3/middlewares/minimal.py ==========
"""
Middleware minimal compatible Django 6.0
"""

class MinimalMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
        self.async_mode = False

    def __call__(self, request):
        response = self.get_response(request)
        return response

    async def __acall__(self, request):
        response = await self.get_response(request)
        return response



========== ebi3/middlewares/two_factor.py ==========
# ~/ebi3/ebi3/middlewares/two_factor.py
"""
Middleware pour la vérification 2FA
"""
from django.shortcuts import redirect
from django.urls import reverse, NoReverseMatch
from django.conf import settings
import logging

logger = logging.getLogger(__name__)


class TwoFactorAuthMiddleware:
    """
    Middleware qui vérifie la 2FA pour les routes sensibles
    Compatible avec Django 6.0+
    """

    def __init__(self, get_response):
        self.get_response = get_response
        self.config = getattr(settings, 'TWO_FACTOR_MIDDLEWARE_CONFIG', {})

        # Routes exemptées de la 2FA
        self.exempt_paths = [
            reverse('users:login'),
            reverse('users:logout'),
            reverse('users:register'),
            reverse('core:home'),
            '/static/',
            '/media/',
            '/admin/login/',
            '/admin/jsi18n/',
            '/favicon.ico',
            '/robots.txt',
        ]

        # Ajouter payment_webhook seulement si l'URL existe
        try:
            self.exempt_paths.append(reverse('payments:payment_webhook'))
        except NoReverseMatch:
            logger.warning("URL 'payments:payment_webhook' not found, skipping from 2FA exemptions")
            pass

    def __call__(self, request):
        """Méthode principale du middleware pour Django 6.0+"""
        # Appeler process_request pour la logique 2FA
        response = self.process_request(request)

        # Si process_request retourne une réponse, c'est une redirection
        if response is not None:
            return response

        # Sinon, continuer avec le middleware suivant
        response = self.get_response(request)
        return response

    def process_request(self, request):
        """Vérifier si la 2FA est requise"""

        # Si le middleware n'est pas activé
        if not self.config.get('enabled', True):
            return None

        # Vérifier si l'utilisateur est authentifié
        if not request.user.is_authenticated:
            return None

        # Vérifier les chemins exemptés
        if any(request.path.startswith(path) for path in self.exempt_paths):
            return None

        # Vérifier si l'utilisateur a la 2FA activée
        if not hasattr(request.user, 'two_factor_enabled') or not request.user.two_factor_enabled:
            return None

        # Vérifier si la session a déjà validé la 2FA
        if request.session.get('2fa_verified', False):
            # Vérifier si la session 2FA est encore valide
            from django.utils import timezone
            verified_at = request.session.get('2fa_verified_at')
            if verified_at:
                verified_time = timezone.datetime.fromisoformat(verified_at)
                remember_days = self.config.get('remember_device_days', 30)

                # Si "se souvenir de l'appareil" est activé et valide
                if request.session.get('2fa_remember_device'):
                    if timezone.now() - verified_time < timezone.timedelta(days=remember_days):
                        return None
                # Sinon, vérifier si c'est dans la même session
                elif timezone.now() - verified_time < timezone.timedelta(hours=1):
                    return None

        # Vérifier si la route est sensible
        sensitive_paths = self.config.get('sensitive_paths', [])
        is_sensitive_path = any(request.path.startswith(path) for path in sensitive_paths)

        # Pour le staff, toujours vérifier
        is_staff_required = self.config.get('required_for_staff', True) and request.user.is_staff

        # Pour les actions sensibles, toujours vérifier
        is_sensitive_action = self.config.get('required_for_sensitive_actions', True) and is_sensitive_path

        if is_staff_required or is_sensitive_action:
            # Rediriger vers la vérification 2FA
            from django.urls import reverse
            verify_url = reverse('users:verify_2fa')

            # Stocker la prochaine URL
            request.session['next_url'] = request.get_full_path()

            logger.info(f"2FA required for user {request.user} accessing {request.path}")
            return redirect(verify_url)

        return None


========== ebi3/middlewares/rate_limit.py ==========
# ~/ebi3/ebi3/middlewares/rate_limit.py
"""
Middleware pour la limitation de débit (rate limiting)
"""
import time
import hashlib
from django.core.cache import cache
# from django.utils.deprecation import MiddlewareMixin  # REMOVED for Django 6.0
from django.http import HttpResponseForbidden, JsonResponse
from django.conf import settings
import logging
from django.utils import timezone

logger = logging.getLogger(__name__)


class RateLimitMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # Appeler process_request si existant
        if hasattr(self, 'process_request'):
            response = self.process_request(request)
            if response is not None:
                return response

        response = self.get_response(request)
        return response
    """
    Middleware de limitation de débit par IP et utilisateur
    """

    def __init__(self, get_response):
        self.get_response = get_response
        self.config = {
            'enabled': getattr(settings, 'RATE_LIMIT_ENABLED', True),
            'default': getattr(settings, 'RATE_LIMIT_DEFAULT', '1000/hour'),
            'anonymous': getattr(settings, 'RATE_LIMIT_ANONYMOUS', '100/hour'),
            'authenticated': getattr(settings, 'RATE_LIMIT_AUTHENTICATED', '5000/hour'),
            'special': getattr(settings, 'RATE_LIMIT_SPECIAL', {}),
        }

    def parse_rate(self, rate):
        """
        Parse une chaîne de rate limit comme '100/hour'
        Retourne (nombre, secondes)
        """
        if rate == 'unlimited':
            return None, None

        try:
            num, period = rate.split('/')
            num = int(num)

            if period == 'second':
                period_seconds = 1
            elif period == 'minute':
                period_seconds = 60
            elif period == 'hour':
                period_seconds = 3600
            elif period == 'day':
                period_seconds = 86400
            else:
                raise ValueError(f"Unknown period: {period}")

            return num, period_seconds
        except ValueError as e:
            logger.error(f"Invalid rate limit format: {rate} - {e}")
            return 1000, 3600  # Default fallback

    def get_rate_limit_for_path(self, path):
        """Obtenir la limite de débit pour un chemin spécifique"""
        for route, rate in self.config['special'].items():
            if path.startswith(route):
                return rate
        return None

    def get_client_identifier(self, request):
        """
        Obtenir un identifiant unique pour le client.
        Utilise l'IP pour les anonymes, user_id pour les authentifiés.
        """
        # Obtenir l'IP
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0]
        else:
            ip = request.META.get('REMOTE_ADDR')

        # Pour les utilisateurs authentifiés, combiner IP et user_id
        if request.user.is_authenticated:
            identifier = f"user:{request.user.id}:{ip}"
        else:
            identifier = f"anon:{ip}"

        return identifier

    def is_rate_limited(self, request):
        """Vérifier si le client a dépassé la limite de débit"""
        if not self.config['enabled']:
            return False

        identifier = self.get_client_identifier(request)
        path = request.path

        # Déterminer la limite à appliquer
        special_rate = self.get_rate_limit_for_path(path)

        if special_rate:
            rate_limit = special_rate
        elif request.user.is_authenticated:
            rate_limit = self.config['authenticated']
        else:
            rate_limit = self.config['anonymous']

        # Si pas de limite
        if rate_limit == 'unlimited':
            return False

        # Parse la limite
        num_requests, period_seconds = self.parse_rate(rate_limit)

        if num_requests is None:
            return False

        # Créer une clé de cache basée sur l'identifiant, le chemin et la période
        current_window = int(time.time() / period_seconds)
        cache_key = f"ratelimit:{identifier}:{path}:{current_window}"

        # Obtenir le compteur actuel
        current_count = cache.get(cache_key, 0)

        # Si la limite est dépassée
        if current_count >= num_requests:
            logger.warning(f"Rate limit exceeded: {identifier} on {path}")

            # Enregistrer l'événement
            from audit.models import RateLimitEvent
            try:
                RateLimitEvent.objects.create(
                    identifier=identifier[:100],
                    ip_address=request.META.get('REMOTE_ADDR', ''),
                    path=path[:200],
                    user=request.user if request.user.is_authenticated else None,
                    limit=num_requests,
                    period=period_seconds,
                    count=current_count + 1
                )
            except:
                pass

            return True

        # Incrémenter le compteur
        cache.set(cache_key, current_count + 1, period_seconds)

        return False

    def process_request(self, request):
        """Vérifier la limite de débit avant de traiter la requête"""

        # Chemins exemptés
        exempt_paths = [
            '/admin/',
            '/static/',
            '/media/',
            '/favicon.ico',
            '/robots.txt',
        ]

        if any(request.path.startswith(path) for path in exempt_paths):
            return None

        # Vérifier la limite
        if self.is_rate_limited(request):
            response_data = {
                'error': 'rate_limit_exceeded',
                'message': 'Too many requests. Please try again later.',
                'retry_after': 60,  # secondes
            }

            response = JsonResponse(response_data, status=429)
            response['Retry-After'] = '60'
            return response

        return None

    def process_response(self, request, response):
        """Ajouter des headers de rate limiting à la réponse"""
        if not self.config['enabled']:
            return response

        identifier = self.get_client_identifier(request)
        path = request.path

        # Obtenir la limite actuelle
        special_rate = self.get_rate_limit_for_path(path)

        if special_rate:
            rate_limit = special_rate
        elif request.user.is_authenticated:
            rate_limit = self.config['authenticated']
        else:
            rate_limit = self.config['anonymous']

        if rate_limit != 'unlimited':
            num_requests, period_seconds = self.parse_rate(rate_limit)

            if num_requests:
                # Ajouter les headers de rate limiting
                current_window = int(time.time() / period_seconds)
                cache_key = f"ratelimit:{identifier}:{path}:{current_window}"
                current_count = cache.get(cache_key, 0)

                response['X-RateLimit-Limit'] = str(num_requests)
                response['X-RateLimit-Remaining'] = str(max(0, num_requests - current_count))
                response['X-RateLimit-Reset'] = str((current_window + 1) * period_seconds)

        return response


========== ebi3/middlewares/security.py ==========
# ~/ebi3/ebi3/middlewares/security.py
"""
Middleware de sécurité avancé pour la détection et prévention d'attaques
"""
import re
import time
import hashlib
from django.conf import settings
from django.core.cache import cache
from django.http import HttpResponseForbidden, HttpResponse
# from django.utils.deprecation import MiddlewareMixin  # REMOVED for Django 6.0
from django.utils import timezone
import logging
from ipaddress import ip_address, ip_network
import json

logger = logging.getLogger(__name__)


class SecurityMiddleware::
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # Appeler process_request si existant
        if hasattr(self, 'process_request'):
            response = self.process_request(request)
            if response is not None:
                return response

        response = self.get_response(request)
        return response
    """
    Middleware de sécurité avancé qui détecte et bloque :
    - Attaques par injection SQL
    - Tentatives XSS
    - Attaques par force brute
    - IPs suspectes
    - Requêtes malveillantes
    """

    def __init__(self, get_response):
        self.get_response = get_response
        self.config = getattr(settings, 'SECURITY_MIDDLEWARE_CONFIG', {})

        # Patterns de détection
        self.sql_injection_patterns = [
            r"(\%27)|(\')|(\-\-)|(\%23)|(#)",
            r"((\%3D)|(=))[^\n]*((\%27)|(\')|(\-\-)|(\%3B)|(;))",
            r"\w*((\%27)|(\'))((\%6F)|o|(\%4F))((\%72)|r|(\%52))",
            r"((\%27)|(\'))union",
            r"exec(\s|\+)+(s|x)p\w+",
            r"insert\s+into.+values",
            r"select\s+.+from",
            r"drop\s+(table|database)",
            r"update\s+.+set",
            r"delete\s+from",
            r"truncate\s+table",
        ]

        self.xss_patterns = [
            r"<script.*?>.*?</script>",
            r"javascript:",
            r"onload\s*=",
            r"onerror\s*=",
            r"onclick\s*=",
            r"onmouseover\s*=",
            r"alert\(",
            r"document\.cookie",
            r"eval\(",
            r"<iframe.*?>",
            r"<object.*?>",
            r"<embed.*?>",
            r"<applet.*?>",
        ]

        # Liste noire d'IPs (peut être chargée depuis une base de données)
        self.blacklisted_ips = set()
        self.suspicious_ips = {}

        # Charger les IPs blacklistées depuis le cache
        self.load_blacklisted_ips()

    def load_blacklisted_ips(self):
        """Charger les IPs blacklistées depuis le cache"""
        cached = cache.get('security:blacklisted_ips')
        if cached:
            self.blacklisted_ips = set(cached)

    def save_blacklisted_ips(self):
        """Sauvegarder les IPs blacklistées dans le cache"""
        cache.set('security:blacklisted_ips', list(self.blacklisted_ips), 3600)

    def get_client_ip(self, request):
        """Obtenir l'adresse IP réelle du client"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0]
        else:
            ip = request.META.get('REMOTE_ADDR')
        return ip

    def is_ip_blacklisted(self, ip):
        """Vérifier si une IP est blacklistée"""
        return ip in self.blacklisted_ips

    def blacklist_ip(self, ip, reason="Suspicious activity"):
        """Ajouter une IP à la liste noire"""
        self.blacklisted_ips.add(ip)
        self.save_blacklisted_ips()

        # Log l'événement
        logger.warning(f"IP {ip} blacklisted: {reason}")

        # Sauvegarder dans la base de données si nécessaire
        from audit.models import SecurityEvent
        SecurityEvent.objects.create(
            event_type='IP_BLACKLISTED',
            ip_address=ip,
            description=reason,
            severity='HIGH'
        )

    def detect_sql_injection(self, request):
        """Détecter les tentatives d'injection SQL"""
        if not self.config.get('detect_sql_injection', True):
            return False

        # Vérifier les paramètres GET
        for key, value in request.GET.items():
            if isinstance(value, str):
                for pattern in self.sql_injection_patterns:
                    if re.search(pattern, value, re.IGNORECASE):
                        return True

        # Vérifier les paramètres POST
        for key, value in request.POST.items():
            if isinstance(value, str):
                for pattern in self.sql_injection_patterns:
                    if re.search(pattern, value, re.IGNORECASE):
                        return True

        # Vérifier le body pour les requêtes JSON
        if request.content_type == 'application/json' and request.body:
            try:
                data = json.loads(request.body.decode('utf-8'))
                # Convertir le dictionnaire en chaîne pour vérification
                data_str = json.dumps(data)
                for pattern in self.sql_injection_patterns:
                    if re.search(pattern, data_str, re.IGNORECASE):
                        return True
            except:
                pass

        return False

    def detect_xss(self, request):
        """Détecter les tentatives XSS"""
        if not self.config.get('detect_xss', True):
            return False

        # Vérifier les paramètres GET
        for key, value in request.GET.items():
            if isinstance(value, str):
                for pattern in self.xss_patterns:
                    if re.search(pattern, value, re.IGNORECASE):
                        return True

        # Vérifier les paramètres POST
        for key, value in request.POST.items():
            if isinstance(value, str):
                for pattern in self.xss_patterns:
                    if re.search(pattern, value, re.IGNORECASE):
                        return True

        return False

    def detect_bruteforce(self, request):
        """Détecter les attaques par force brute"""
        if not self.config.get('detect_bruteforce', True):
            return False

        ip = self.get_client_ip(request)
        path = request.path

        # Vérifier les tentatives de login
        if '/login/' in path or '/signin/' in path:
            cache_key = f'bruteforce:{ip}:{path}'
            attempts = cache.get(cache_key, 0)

            max_attempts = self.config.get('max_login_attempts', 5)
            if attempts >= max_attempts:
                # Bloquer l'IP temporairement
                block_time = self.config.get('login_block_time', 3600)
                cache_key_block = f'ip_blocked:{ip}'
                cache.set(cache_key_block, True, block_time)

                # Ajouter à la liste noire si trop d'échecs
                if attempts >= max_attempts * 2:
                    self.blacklist_ip(ip, "Too many failed login attempts")

                return True

            # Incrémenter le compteur
            cache.set(cache_key, attempts + 1, 300)  # 5 minutes

        return False

    def check_request_frequency(self, request):
        """Vérifier la fréquence des requêtes"""
        ip = self.get_client_ip(request)
        cache_key = f'request_freq:{ip}'

        # Obtenir l'historique des requêtes
        request_history = cache.get(cache_key, [])
        current_time = time.time()

        # Filtrer les requêtes des dernières secondes
        recent_requests = [t for t in request_history if current_time - t < 10]

        # Si trop de requêtes en 10 secondes
        if len(recent_requests) > 100:  # 10 requêtes par seconde max
            return True

        # Ajouter la requête actuelle
        recent_requests.append(current_time)
        cache.set(cache_key, recent_requests[-100:], 60)  # Garder 100 dernières

        return False

    def process_request(self, request):
        """Traiter la requête avant qu'elle n'atteigne la vue"""

        # Récupérer l'IP du client
        ip = self.get_client_ip(request)

        # 1. Vérifier si l'IP est blacklistée
        if self.is_ip_blacklisted(ip):
            logger.warning(f"Blacklisted IP attempted access: {ip}")
            return HttpResponseForbidden(
                "Access denied. Your IP address has been blocked for security reasons."
            )

        # 2. Vérifier si l'IP est temporairement bloquée
        if cache.get(f'ip_blocked:{ip}'):
            logger.warning(f"Temporarily blocked IP attempted access: {ip}")
            return HttpResponseForbidden(
                "Access temporarily blocked. Please try again later."
            )

        # 3. Détecter les attaques par injection SQL
        if self.detect_sql_injection(request):
            logger.warning(f"SQL injection attempt from IP {ip}")
            self.blacklist_ip(ip, "SQL injection attempt")
            return HttpResponseForbidden("Security violation detected.")

        # 4. Détecter les tentatives XSS
        if self.detect_xss(request):
            logger.warning(f"XSS attempt from IP {ip}")
            self.blacklist_ip(ip, "XSS attempt")
            return HttpResponseForbidden("Security violation detected.")

        # 5. Détecter les attaques par force brute
        if self.detect_bruteforce(request):
            logger.warning(f"Bruteforce attempt from IP {ip}")
            return HttpResponseForbidden(
                "Too many login attempts. Please try again later."
            )

        # 6. Vérifier la fréquence des requêtes
        if self.check_request_frequency(request):
            logger.warning(f"High request frequency from IP {ip}")
            # Bloquer temporairement
            cache.set(f'ip_blocked:{ip}', True, 300)  # 5 minutes
            return HttpResponseForbidden(
                "Request rate limit exceeded. Please slow down."
            )

        # 7. Vérifier les headers suspects
        user_agent = request.META.get('HTTP_USER_AGENT', '')
        if self.is_suspicious_user_agent(user_agent):
            logger.warning(f"Suspicious User-Agent from IP {ip}: {user_agent}")
            # Suivre mais ne pas bloquer immédiatement
            self.track_suspicious_activity(ip, "Suspicious User-Agent")

        # Ajouter l'IP à l'objet request pour un usage ultérieur
        request.client_ip = ip

        return None

    def is_suspicious_user_agent(self, user_agent):
        """Détecter les User-Agents suspects"""
        suspicious_patterns = [
            r'sqlmap', r'nmap', r'nikto', r'hydra',
            r'wget', r'curl', r'python-requests',
            r'^$',  # User-Agent vide
        ]

        if not user_agent:
            return True

        for pattern in suspicious_patterns:
            if re.search(pattern, user_agent, re.IGNORECASE):
                return True

        return False

    def track_suspicious_activity(self, ip, reason):
        """Suivre les activités suspectes"""
        cache_key = f'suspicious:{ip}'
        activities = cache.get(cache_key, [])
        activities.append({
            'timestamp': timezone.now().isoformat(),
            'reason': reason
        })
        cache.set(cache_key, activities[-10:], 3600)  # Garder 10 dernières

        # Si trop d'activités suspectes, blacklister
        if len(activities) >= 5:
            self.blacklist_ip(ip, f"Multiple suspicious activities: {reason}")

    def process_response(self, request, response):
        """Traiter la réponse après la vue"""

        # Ajouter des headers de sécurité
        response['X-Content-Type-Options'] = 'nosniff'
        response['X-Frame-Options'] = 'DENY'
        response['X-XSS-Protection'] = '1; mode=block'
        response['Referrer-Policy'] = 'strict-origin-when-cross-origin'

        # Content Security Policy (CSP)
        # Note: À adapter selon les besoins de votre application
        csp_policy = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://code.jquery.com; "
            "style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; "
            "img-src 'self' data: https:; "
            "font-src 'self' https://cdn.jsdelivr.net; "
            "connect-src 'self'; "
            "frame-ancestors 'none'; "
            "base-uri 'self'; "
            "form-action 'self';"
        )
        response['Content-Security-Policy'] = csp_policy

        # Feature Policy
        response['Feature-Policy'] = (
            "camera 'none'; "
            "microphone 'none'; "
            "geolocation 'none'; "
            "payment 'none';"
        )

        # Permissions Policy (remplace Feature-Policy)
        response['Permissions-Policy'] = (
            "camera=(), "
            "microphone=(), "
            "geolocation=(), "
            "payment=()"
        )

        # Désactiver la mise en cache pour les pages sensibles
        sensitive_paths = ['/admin/', '/payments/', '/wallet/', '/settings/']
        if any(request.path.startswith(path) for path in sensitive_paths):
            response['Cache-Control'] = 'no-store, no-cache, must-revalidate, max-age=0'
            response['Pragma'] = 'no-cache'
            response['Expires'] = '0'

        # Log si configuré
        if self.config.get('log_all_requests', True):
            self.log_request(request, response)

        return response

    def log_request(self, request, response):
        """Logger les détails de la requête"""
        ip = self.get_client_ip(request)
        user = request.user if hasattr(request, 'user') else 'anonymous'

        log_data = {
            'timestamp': timezone.now().isoformat(),
            'ip': ip,
            'user': str(user),
            'method': request.method,
            'path': request.path,
            'status_code': response.status_code,
            'user_agent': request.META.get('HTTP_USER_AGENT', ''),
            'referer': request.META.get('HTTP_REFERER', ''),
            'content_type': request.content_type,
        }

        # Ne pas logger les données sensibles
        sensitive_keys = ['password', 'token', 'secret', 'key', 'pin', 'cvv']

        if request.method == 'GET':
            # Filtrer les paramètres GET sensibles
            filtered_params = {}
            for key, value in request.GET.items():
                if any(sensitive in key.lower() for sensitive in sensitive_keys):
                    filtered_params[key] = '***FILTERED***'
                else:
                    filtered_params[key] = value
            log_data['get_params'] = filtered_params

        elif request.method == 'POST':
            # Filtrer les paramètres POST sensibles
            filtered_params = {}
            for key, value in request.POST.items():
                if any(sensitive in key.lower() for sensitive in sensitive_keys):
                    filtered_params[key] = '***FILTERED***'
                else:
                    filtered_params[key] = value
            log_data['post_params'] = filtered_params

        # Logger
        logger.info(f"Security log: {json.dumps(log_data)}")

        # Sauvegarder dans la base de données si nécessaire
        from audit.models import RequestLog
        try:
            RequestLog.objects.create(
                ip_address=ip,
                user=user if user != 'anonymous' else None,
                method=request.method,
                path=request.path,
                status_code=response.status_code,
                user_agent=log_data['user_agent'][:200],
                referer=log_data['referer'][:200],
                request_data=log_data
            )
        except:
            pass  # Ne pas bloquer si le logging échoue


========== ebi3/middlewares/fix_security.py ==========
# ~/ebi3/ebi3/middlewares/fix_security.py
"""
Middleware de correction pour Django 6.0 async_mode error
"""

class FixedSecurityMiddleware:
    """Version corrigée pour Django 6.0+"""

    def __init__(self, get_response):
        self.get_response = get_response
        # Ajoute l'attribut manquant qui cause l'erreur
        self.async_mode = False

    def __call__(self, request):
        response = self.get_response(request)
        return response

    async def __acall__(self, request):
        # Version asynchrone
        response = await self.get_response(request)
        return response



========== ebi3/middlewares/custom_security.py ==========
"""
Middleware de sécurité personnalisé
"""

class SecurityMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
        self.async_mode = False  # Fix for Django 6.0

    def __call__(self, request):
        # Votre logique de sécurité ici
        response = self.get_response(request)
        return response



========== ebi3/asgi.py ==========
"""
ASGI config for ebi3 project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "ebi3.settings")

application = get_asgi_application()



========== ebi3/celery.py ==========
# ~/ebi3/ebi3/celery.py

import os
from celery import Celery
from celery.schedules import crontab

# Définir les paramètres Django par défaut
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'ebi3.settings')

app = Celery('ebi3')

# Configuration Celery à partir des paramètres Django
app.config_from_object('django.conf:settings', namespace='CELERY')

# Découverte automatique des tâches dans les apps
app.autodiscover_tasks()

# Configuration des tâches périodiques
from logistics.tasks import CELERY_BEAT_SCHEDULE
app.conf.beat_schedule = CELERY_BEAT_SCHEDULE

@app.task(bind=True)
def debug_task(self):
    print(f'Request: {self.request!r}')


========== ebi3/settings.py ==========
"""
Django settings for ebi3 project.
Generated by 'django-admin startproject' using Django 4.2.
"""

from pathlib import Path
import os

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = "django-insecure-^i3vk0pvad&06t9-a(+(^#fmmsl_a=qh+8wfe=q_)#ab9n0o*%"

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['saidi19.pythonanywhere.com', 'localhost', '127.0.0.1']

# Application definition
INSTALLED_APPS = [
    # Django core apps
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'django.contrib.gis',
    'django.contrib.sites',

    # Vos applications
    'users.apps.UsersConfig',
    'ads.apps.AdsConfig',
    'carriers.apps.CarriersConfig',
    'colis.apps.ColisConfig',
    'payments.apps.PaymentsConfig',
    'core.apps.CoreConfig',
    'dashboard.apps.DashboardConfig',
    'logistics.apps.LogisticsConfig',
    'messaging.apps.MessagingConfig',
    'reviews.apps.ReviewsConfig',
    'tracking.apps.TrackingConfig',
    'translations.apps.TranslationsConfig',

    # Nouvelle application d'audit
    'audit.apps.AuditConfig',

    # Packages tiers
    'crispy_forms',
    'crispy_bootstrap5',
    'phonenumber_field',
    'django_countries',
    'rosetta',
    'mptt',
    'django_cleanup.apps.CleanupConfig',
]

MIDDLEWARE = [
    'ebi3.middlewares.minimal.MinimalMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.locale.LocaleMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'ebi3.middlewares.two_factor.TwoFactorAuthMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.common.CommonMiddleware',
]

ROOT_URLCONF = "ebi3.urls"

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [
            os.path.join(BASE_DIR, 'core/templates'),
            os.path.join(BASE_DIR, 'templates'),
        ],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                'django.template.context_processors.i18n',
                'django.template.context_processors.media',
                'django.template.context_processors.static',
                'core.context_processors.site_settings',
            ],
        },
    },
]

WSGI_APPLICATION = "ebi3.wsgi.application"

# Configuration de la base de données MySQL

DATABASES = {
    'default': {
        'ENGINE': 'django.contrib.gis.db.backends.mysql',  # <- GIS engine
        'NAME': 'saidi19$ebi3db',
        'USER': 'saidi19',
        'PASSWORD': 'azer1234db',
        'HOST': 'saidi19.mysql.pythonanywhere-services.com',
        'PORT': 3306,
        'OPTIONS': {
            'init_command': "SET sql_mode='STRICT_TRANS_TABLES'",
            'charset': 'utf8mb4',
        }
    }
}

AUTH_PASSWORD_VALIDATORS = [
    {
        "NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.MinimumLengthValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.CommonPasswordValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.NumericPasswordValidator",
    },
]

LANGUAGES = [
    ('ar', 'العربية'),
    ('fr', 'Français'),
    ('en', 'English'),
    ('de', 'Deutsch'),
    ('it', 'Italiano'),
    ('es', 'Español'),
    ('pt', 'Português'),
    ('pl', 'Polski'),
]

LANGUAGE_CODE = 'fr'

LOCALE_PATHS = [
    os.path.join(BASE_DIR, 'locale'),
]

TIME_ZONE = 'UTC'
USE_I18N = True
USE_L10N = True
USE_TZ = True

AUTH_USER_MODEL = 'users.User'
LOGIN_URL = 'users:login'
LOGIN_REDIRECT_URL = 'core:home'
LOGOUT_REDIRECT_URL = 'core:home'

CRISPY_ALLOWED_TEMPLATE_PACKS = "bootstrap5"
CRISPY_TEMPLATE_PACK = "bootstrap5"

STATIC_URL = '/static/'
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'static'),
]
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

# Configuration Celery
CELERY_BROKER_URL = os.environ.get('REDIS_URL', 'redis://localhost:6379/0')
CELERY_RESULT_BACKEND = os.environ.get('REDIS_URL', 'redis://localhost:6379/0')
CELERY_ACCEPT_CONTENT = ['json']
CELERY_TASK_SERIALIZER = 'json'
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = 'Europe/Paris'

CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
        'LOCATION': 'unique-snowflake',
    },
    'translations': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
        'LOCATION': 'translation-cache',
    }
}

SITE_ID = 1

# ============================================================================
# CONFIGURATION DEEPSEEK TRANSLATION
# ============================================================================

# Configuration de base DeepSeek
DEEPSEEK_API_KEY = os.environ.get('DEEPSEEK_API_KEY', '')
DEEPSEEK_CONFIG = {
    'API_KEY': DEEPSEEK_API_KEY,
    'ENABLED_LANGUAGES': ['fr', 'en', 'ar', 'es', 'de', 'it', 'pt', 'ru', 'zh', 'tr', 'nl'],
    'AUTO_TRANSLATE_FIELDS': ['title', 'description', 'content', 'body', 'message', 'comment'],
    'BATCH_SIZE': 5,
    'RETRY_ATTEMPTS': 3,
    'QUALITY_THRESHOLD': 0.7,
    'RATE_LIMIT_PER_MINUTE': 60,
    'API_URL': 'https://api.deepseek.com/v1/chat/completions',
    'MODEL': 'deepseek-chat',
    'TIMEOUT': 30,
    'TEMPERATURE': 0.1,
    'MAX_TOKENS': 4000,
}

# Middleware pour la traduction
MIDDLEWARE += [
    'translations.middleware.LanguageDetectionMiddleware',
    'translations.middleware.TranslationPreferencesMiddleware',
]

# Ajouter les langues DeepSeek à LANGUAGES si elles n'existent pas déjà
DEEPSEEK_LANGUAGES = [
    ('fr', 'Français'),
    ('en', 'English'),
    ('ar', 'العربية'),
    ('es', 'Español'),
    ('de', 'Deutsch'),
    ('it', 'Italiano'),
    ('pt', 'Português'),
    ('ru', 'Русский'),
    ('zh', '中文'),
    ('tr', 'Türkçe'),
    ('nl', 'Nederlands'),
]

for lang in DEEPSEEK_LANGUAGES:
    if lang not in LANGUAGES:
        LANGUAGES.append(lang)

# Configuration Celery pour les traductions
try:
    from celery.schedules import crontab
    TRANSLATION_CELERY_BEAT_SCHEDULE = {
        'cleanup-old-translation-jobs': {
            'task': 'translations.tasks.cleanup_old_jobs',
            'schedule': crontab(hour=3, minute=0),
            'args': (30,),
        },
        'retry-failed-translation-jobs': {
            'task': 'translations.tasks.retry_failed_jobs',
            'schedule': crontab(hour='*/2', minute=30),
        },
        'update-translation-cache': {
            'task': 'translations.tasks.update_translation_cache',
            'schedule': crontab(hour=4, minute=0),
        },
    }

    # Fusionner avec le schedule existant
    if 'CELERY_BEAT_SCHEDULE' not in locals():
        CELERY_BEAT_SCHEDULE = {}

    CELERY_BEAT_SCHEDULE.update(TRANSLATION_CELERY_BEAT_SCHEDULE)

except ImportError:
    print("Celery non disponible pour les tâches de traduction")

# Paramètres de sécurité pour les traductions
TRANSLATION_SECURITY = {
    'DATA_RETENTION_DAYS': 365,
    'MAX_TEXT_LENGTH': 10000,
    'DAILY_LIMIT_PER_USER': 100,
}

SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True


========== ebi3/settings_production.py ==========
# Configuration de sécurité pour la production
if not DEBUG:
    # HTTPS
    SECURE_SSL_REDIRECT = True
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    LANGUAGE_COOKIE_SECURE = True

    # Headers
    SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')

    # Cache pour la production
    CACHES = {
        'default': {
            'BACKEND': 'django.core.cache.backends.redis.RedisCache',
            'LOCATION': os.environ.get('REDIS_URL', 'redis://localhost:6379/1'),
            'OPTIONS': {
                'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            }
        }
    }


========== ebi3/__init__.py ==========



========== ebi3/urls.py ==========
# ~/ebi3/ebi3/urls.py
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.i18n import i18n_patterns
from django.conf.urls.static import static
from django.views.i18n import set_language

urlpatterns = [
    path('set-language/', set_language, name='set_language'),
    path('admin/', admin.site.urls),
    path('rosetta/', include('rosetta.urls')),
    # REMOVED: path('logistics-admin/', logistics_admin_site.urls),  # Cette ligne a été supprimée
]

# URLs avec support de langue
urlpatterns += i18n_patterns(
    path('', include('core.urls')),
    path('users/', include('users.urls', namespace='users')),
    path('ads/', include('ads.urls', namespace='ads')),
    path('carriers/', include('carriers.urls', namespace='carriers')),
    path('colis/', include('colis.urls', namespace='colis')),
    path('payments/', include('payments.urls', namespace='payments')),
    path('dashboard/', include('dashboard.urls', namespace='dashboard')),
    # COMMENTEZ TEMPORAIREMENT CETTE LIGNE POUR DIAGNOSTIQUER
    # path('logistics/', include('logistics.urls', namespace='logistics')),
    path('messages/', include('messaging.urls', namespace='messaging')),
    path('reviews/', include('reviews.urls', namespace='reviews')),
    path('tracking/', include('tracking.urls', namespace='tracking')),
    prefix_default_language=True,
)

# Fichiers statiques et médias en développement
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)

# Handlers d'erreur
handler404 = 'core.views.handler404'
handler500 = 'core.views.handler500'
handler403 = 'core.views.handler403'
handler400 = 'core.views.handler400'


========== ebi3/settings_deepseek.py ==========
"""
Configuration spécifique pour le module de traduction DeepSeek.
À importer dans settings.py principal.
"""
import os
from datetime import timedelta
from celery.schedules import crontab

# ============================================================================
# CONFIGURATION DEEPSEEK TRANSLATION
# ============================================================================

# Clé API DeepSeek (à définir dans les variables d'environnement)
DEEPSEEK_API_KEY = os.environ.get('sk-4f4d359edced46c9b28c5e3e9532b943', '')

# Configuration du module de traduction
DEEPSEEK_CONFIG = {
    'API_KEY': DEEPSEEK_API_KEY,
    'ENABLED_LANGUAGES': ['fr', 'en', 'ar', 'es', 'de', 'it', 'pt', 'ru', 'zh', 'tr', 'nl'],
    'AUTO_TRANSLATE_FIELDS': ['title', 'description', 'content', 'body', 'message', 'comment'],
    'BATCH_SIZE': 5,
    'RETRY_ATTEMPTS': 3,
    'QUALITY_THRESHOLD': 0.7,
    'RATE_LIMIT_PER_MINUTE': 60,
    'API_URL': 'https://api.deepseek.com/v1/chat/completions',
    'MODEL': 'deepseek-chat',
    'TIMEOUT': 30,
    'TEMPERATURE': 0.1,
    'MAX_TOKENS': 4000,
}

# Cache Redis pour les traductions (configuration optionnelle)
TRANSLATION_CACHE_CONFIG = {
    'BACKEND': 'django.core.cache.backends.redis.RedisCache',
    'LOCATION': os.environ.get('REDIS_URL', 'redis://127.0.0.1:6379/1'),
    'TIMEOUT': 86400,  # 24 heures
    'KEY_PREFIX': 'translations',
}

# Configuration Celery pour les tâches asynchrones de traduction
TRANSLATION_CELERY_BEAT_SCHEDULE = {
    # Tâches de nettoyage des traductions
    'cleanup-old-translation-jobs': {
        'task': 'translations.tasks.cleanup_old_jobs',
        'schedule': crontab(hour=3, minute=0),  # 3h00 chaque jour
        'args': (30,),  # Supprime les jobs de plus de 30 jours
    },
    'retry-failed-translation-jobs': {
        'task': 'translations.tasks.retry_failed_jobs',
        'schedule': crontab(hour='*/2', minute=30),  # Toutes les 2h30
    },
    'update-translation-cache': {
        'task': 'translations.tasks.update_translation_cache',
        'schedule': crontab(hour=4, minute=0),  # 4h00 chaque jour
    },
    # Statistiques quotidiennes
    'generate-translation-stats': {
        'task': 'translations.tasks.generate_daily_stats',
        'schedule': crontab(hour=5, minute=0),  # 5h00 chaque jour
    },
}

# Middleware pour la traduction
TRANSLATION_MIDDLEWARE = [
    'translations.middleware.LanguageDetectionMiddleware',
    'translations.middleware.TranslationPreferencesMiddleware',
]

# Applications pour la traduction
TRANSLATION_APPS = [
    'translations',
]

# Configuration des langues supportées
TRANSLATION_LANGUAGES = [
    ('fr', 'Français'),
    ('en', 'English'),
    ('ar', 'العربية'),
    ('es', 'Español'),
    ('de', 'Deutsch'),
    ('it', 'Italiano'),
    ('pt', 'Português'),
    ('ru', 'Русский'),
    ('zh', '中文'),
    ('tr', 'Türkçe'),
    ('nl', 'Nederlands'),
]

# Paramètres de sécurité pour les données de traduction
TRANSLATION_SECURITY = {
    'DATA_RETENTION_DAYS': 365,  # Conservation des données
    'MAX_TEXT_LENGTH': 10000,  # Longueur max par texte
    'DAILY_LIMIT_PER_USER': 100,  # Limite quotidienne par utilisateur
    'MAX_BATCH_SIZE': 50,  # Taille max des batchs
    'ALLOW_USER_DISABLE': True,  # Autoriser la désactivation par utilisateur
}

# Configuration du monitoring
TRANSLATION_MONITORING = {
    'ENABLE_LOGGING': True,
    'LOG_LEVEL': 'INFO',
    'ENABLE_METRICS': True,
    'METRICS_PORT': 9090,  # Port pour les métriques Prometheus (optionnel)
    'ALERT_THRESHOLDS': {
        'ERROR_RATE': 0.05,  # 5% d'erreurs max
        'AVG_RESPONSE_TIME': 2.0,  # 2 secondes max
        'CACHE_HIT_RATIO': 0.3,  # 30% de cache hit minimum
    },
}

# Configuration de l'interface utilisateur
TRANSLATION_UI = {
    'SHOW_TRANSLATION_BADGE': True,
    'ALLOW_MANUAL_TRANSLATION': True,
    'ALLOW_TRANSLATION_EDITING': True,
    'SHOW_LANGUAGE_SELECTOR': True,
    'DEFAULT_VIEW_MODE': 'auto',  # 'auto', 'original', 'translated'
    'ENABLE_PREVIEW': True,
    'PREVIEW_CHAR_LIMIT': 500,
}

# Configuration des webhooks (optionnel)
TRANSLATION_WEBHOOKS = {
    'ENABLE': False,
    'URL': os.environ.get('TRANSLATION_WEBHOOK_URL', ''),
    'SECRET': os.environ.get('TRANSLATION_WEBHOOK_SECRET', ''),
    'EVENTS': ['translation.completed', 'translation.failed', 'job.completed'],
}

# Configuration du fallback
TRANSLATION_FALLBACK = {
    'ENABLE': True,
    'STRATEGY': 'original',  # 'original', 'cached', 'similar'
    'MIN_CONFIDENCE': 0.5,
    'MAX_ATTEMPTS': 2,
}

# Configuration du coût et du budget
TRANSLATION_BUDGET = {
    'MONTHLY_LIMIT': 100.00,  # $100 par mois
    'COST_PER_CHARACTER': 0.000002,  # Coût approximatif par caractère
    'ALERT_THRESHOLD': 0.8,  # Alerte à 80% du budget
    'ENABLE_LIMITS': True,
}

# URLs des traductions
TRANSLATION_URLS = {
    'API_PREFIX': 'api/translations/',
    'ADMIN_PREFIX': 'admin/translations/',
    'USER_PREFIX': 'translations/',
}

# Feature flags (activation progressive des fonctionnalités)
TRANSLATION_FEATURE_FLAGS = {
    'ENABLE_REAL_TIME_UPDATES': False,  # WebSockets/SSE
    'ENABLE_BATCH_PROCESSING': True,
    'ENABLE_MEMORY_CACHE': True,
    'ENABLE_QUALITY_SCORING': True,
    'ENABLE_USER_PREFERENCES': True,
    'ENABLE_ADMIN_DASHBOARD': True,
}


========== ebi3/wsgi.py ==========
"""
WSGI config for ebi3 project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "ebi3.settings")

application = get_wsgi_application()



========== logistics/templates/logistics/includes/logistics_nav.html ==========
{# ~/ebi3/logistics/templates/logistics/includes/logistics_nav.html #}

<nav class="logistics-nav">
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
               href="{% url 'logistics:dashboard' %}">
                <i class="fas fa-tachometer-alt me-2"></i> {% trans "Tableau de bord" %}
            </a>
        </li>

        <!-- Réservations -->
        <li class="nav-item">
            <a class="nav-link {% if 'reservation' in request.resolver_match.url_name %}active{% endif %}"
               href="{% url 'logistics:reservation_list' %}">
                <i class="fas fa-shopping-cart me-2"></i> {% trans "Mes réservations" %}
                {% if user.reservations_pending %}
                    <span class="badge bg-warning float-end">{{ user.reservations_pending }}</span>
                {% endif %}
            </a>
        </li>

        <!-- Missions (pour transporteurs et acheteurs) -->
        {% if user.role == 'CARRIER' or user.reservations.exists %}
        <li class="nav-item">
            <a class="nav-link {% if 'mission' in request.resolver_match.url_name %}active{% endif %}"
               href="{% url 'logistics:mission_list' %}">
                <i class="fas fa-truck me-2"></i> {% trans "Mes missions" %}
                {% if user.active_missions %}
                    <span class="badge bg-info float-end">{{ user.active_missions }}</span>
                {% endif %}
            </a>
        </li>
        {% endif %}

        <!-- Routes (pour transporteurs) -->
        {% if user.role == 'CARRIER' and user.carrier_profile %}
        <li class="nav-item">
            <a class="nav-link {% if 'route' in request.resolver_match.url_name %}active{% endif %}"
               href="{% url 'logistics:route_list' %}">
                <i class="fas fa-route me-2"></i> {% trans "Mes routes" %}
                {% if user.active_routes %}
                    <span class="badge bg-success float-end">{{ user.active_routes }}</span>
                {% endif %}
            </a>
        </li>
        {% endif %}

        <!-- Propositions (pour vendeurs et transporteurs) -->
        {% if user.role == 'SELLER' or user.role == 'CARRIER' %}
        <li class="nav-item">
            <a class="nav-link {% if 'proposal' in request.resolver_match.url_name %}active{% endif %}"
               href="{% url 'logistics:proposal_list' %}">
                <i class="fas fa-handshake me-2"></i> {% trans "Propositions" %}
                {% if user.pending_proposals %}
                    <span class="badge bg-primary float-end">{{ user.pending_proposals }}</span>
                {% endif %}
            </a>
        </li>
        {% endif %}

        <li class="nav-item mt-3">
            <div class="nav-link text-muted small">
                <i class="fas fa-info-circle me-2"></i> {% trans "Aide" %}
            </div>
        </li>

        <li class="nav-item">
            <a class="nav-link" href="{% url 'logistics:faq' %}">
                <i class="fas fa-question-circle me-2"></i> {% trans "FAQ" %}
            </a>
        </li>

        <li class="nav-item">
            <a class="nav-link" href="{% url 'logistics:guide' %}">
                <i class="fas fa-book me-2"></i> {% trans "Guide" %}
            </a>
        </li>

        <!-- Admin links -->
        {% if user.is_staff %}
        <li class="nav-item mt-3">
            <div class="nav-link text-muted small">
                <i class="fas fa-cog me-2"></i> {% trans "Administration" %}
            </div>
        </li>

        <li class="nav-item">
            <a class="nav-link" href="{% url 'logistics:settings' %}">
                <i class="fas fa-sliders-h me-2"></i> {% trans "Paramètres" %}
            </a>
        </li>

        <li class="nav-item">
            <a class="nav-link" href="{% url 'logistics:reports' %}">
                <i class="fas fa-chart-bar me-2"></i> {% trans "Rapports" %}
            </a>
        </li>
        {% endif %}
    </ul>
</nav>


========== logistics/templates/logistics/reservations/reservation_list.html ==========
{# ~/ebi3/logistics/templates/logistics/reservations/reservation_list.html #}

{% extends 'logistics/base_logistics.html' %}
{% load i18n %}

{% block logistics_title %}{% trans "Mes réservations" %}{% endblock %}

{% block logistics_subtitle %}{% trans "Gérez toutes vos réservations" %}{% endblock %}

{% block logistics_breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">{% trans "Réservations" %}</li>
{% endblock %}

{% block logistics_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">{% trans "Réservations" %}</h3>
    <div class="d-flex gap-2">
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-filter me-2"></i> {% trans "Filtrer" %}
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="?status=all">{% trans "Tous" %}</a></li>
                {% for status, label in status_choices %}
                <li><a class="dropdown-item" href="?status={{ status }}">{{ label }}</a></li>
                {% endfor %}
            </ul>
        </div>
        <a href="{% url 'ads:ad_list' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i> {% trans "Nouvelle réservation" %}
        </a>
    </div>
</div>

<!-- Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ stats.total }}</h3>
                <p class="text-muted mb-0">{% trans "Total" %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h3 class="text-warning">{{ stats.pending }}</h3>
                <p class="text-muted mb-0">{% trans "En attente" %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h3 class="text-info">{{ stats.in_transit }}</h3>
                <p class="text-muted mb-0">{% trans "En transit" %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h3 class="text-success">{{ stats.delivered }}</h3>
                <p class="text-muted mb-0">{% trans "Livrées" %}</p>
            </div>
        </div>
    </div>
</div>

<!-- Reservations List -->
{% if reservations %}
    <div class="row">
        {% for reservation in reservations %}
        <div class="col-md-6 col-lg-4 mb-4">
            {% include 'logistics/partials/reservation_card.html' with reservation=reservation %}
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if current_status != 'all' %}&status={{ current_status }}{% endif %}{% if current_date_filter != 'all' %}&date={{ current_date_filter }}{% endif %}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if current_status != 'all' %}&status={{ current_status }}{% endif %}{% if current_date_filter != 'all' %}&date={{ current_date_filter }}{% endif %}">
                        {{ num }}
                    </a>
                </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if current_status != 'all' %}&status={{ current_status }}{% endif %}{% if current_date_filter != 'all' %}&date={{ current_date_filter }}{% endif %}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
        <h4 class="text-muted mb-3">{% trans "Aucune réservation" %}</h4>
        <p class="text-muted mb-4">
            {% if current_status != 'all' %}
                {% trans "Aucune réservation avec ce statut." %}
            {% else %}
                {% trans "Vous n'avez pas encore fait de réservation." %}
            {% endif %}
        </p>
        <a href="{% url 'ads:ad_list' %}" class="btn btn-primary btn-lg">
            <i class="fas fa-search me-2"></i> {% trans "Parcourir les annonces" %}
        </a>
    </div>
{% endif %}
{% endblock %}


========== logistics/templates/logistics/reservations/reservation_detail.html ==========
{# ~/ebi3/logistics/templates/logistics/reservations/reservation_detail.html #}

{% extends 'logistics/base_logistics.html' %}
{% load i18n %}

{% block logistics_title %}{% trans "Réservation" %} #{{ reservation.id }}{% endblock %}

{% block logistics_subtitle %}{{ reservation.ad.title }}{% endblock %}

{% block logistics_breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'logistics:reservation_list' %}">{% trans "Réservations" %}</a>
</li>
<li class="breadcrumb-item active" aria-current="page">#{{ reservation.id }}</li>
{% endblock %}

{% block logistics_content %}
<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Status and Actions -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            {% trans "Statut :" %}
                            <span class="status-badge status-{{ reservation.status|lower }}">
                                {{ reservation.get_status_display }}
                            </span>
                        </h5>
                        <small class="text-muted">
                            {% trans "Créée le" %} {{ reservation.created_at|date:"d/m/Y à H:i" }}
                        </small>
                    </div>

                    <div class="action-buttons">
                        {% if can_edit %}
                        <a href="{% url 'logistics:reservation_update' reservation.pk %}" class="btn btn-primary">
                            <i class="fas fa-edit me-2"></i> {% trans "Modifier" %}
                        </a>
                        {% endif %}

                        {% if can_cancel %}
                        <form method="post" action="{% url 'logistics:reservation_cancel' reservation.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger confirm-action"
                                    data-confirm-message="{% trans 'Êtes-vous sûr de vouloir annuler cette réservation ?' %}">
                                <i class="fas fa-times me-2"></i> {% trans "Annuler" %}
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Annonce Details -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-box me-2"></i> {% trans "Détails de l'annonce" %}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p>
                            <strong>{% trans "Titre :" %}</strong>
                            <a href="{{ reservation.ad.get_absolute_url }}">{{ reservation.ad.title }}</a>
                        </p>
                        <p>
                            <strong>{% trans "Catégorie :" %}</strong>
                            {{ reservation.ad.category.name }}
                        </p>
                        <p>
                            <strong>{% trans "Prix de l'objet :" %}</strong>
                            {{ reservation.ad.get_price_with_currency }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p>
                            <strong>{% trans "Vendeur :" %}</strong>
                            <a href="{% url 'users:profile' reservation.ad.seller.username %}">
                                {{ reservation.ad.seller.username }}
                            </a>
                        </p>
                        <p>
                            <strong>{% trans "Condition :" %}</strong>
                            {{ reservation.ad.get_condition_display }}
                        </p>
                        <p>
                            <strong>{% trans "Poids :" %}</strong>
                            {{ reservation.ad.weight|default:"0" }} kg
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logistics Information -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-shipping-fast me-2"></i> {% trans "Informations logistiques" %}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>{% trans "Option logistique" %}</h6>
                        <p>
                            <span class="badge bg-primary">{{ reservation.get_logistics_option_display }}</span>
                            {% if reservation.carrier %}
                                <br>
                                <small class="text-muted">
                                    {% trans "Transporteur :" %}
                                    <a href="{% url 'carriers:carrier_detail' reservation.carrier.user.username %}">
                                        {{ reservation.carrier.user.username }}
                                    </a>
                                </small>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>{% trans "Adresses" %}</h6>
                        <p class="mb-1">
                            <strong>{% trans "Départ :" %}</strong><br>
                            {{ reservation.pickup_address|default:reservation.ad.address_from|truncatechars:100 }}
                        </p>
                        <p class="mb-0">
                            <strong>{% trans "Arrivée :" %}</strong><br>
                            {{ reservation.delivery_address|default:reservation.ad.address_to|truncatechars:100 }}
                        </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <h6>{% trans "Dates" %}</h6>
                        <p class="mb-1">
                            <strong>{% trans "Prise en charge :" %}</strong><br>
                            {% if reservation.pickup_date %}
                                {{ reservation.pickup_date|date:"d/m/Y" }}
                            {% else %}
                                <span class="text-muted">{% trans "À définir" %}</span>
                            {% endif %}
                        </p>
                        <p class="mb-0">
                            <strong>{% trans "Livraison estimée :" %}</strong><br>
                            {% if reservation.delivery_date %}
                                {{ reservation.delivery_date|date:"d/m/Y" }}
                            {% else %}
                                <span class="text-muted">{% trans "À définir" %}</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>{% trans "Services additionnels" %}</h6>
                        <ul class="list-unstyled">
                            {% if reservation.requires_insurance %}
                            <li>
                                <i class="fas fa-check text-success me-2"></i>
                                {% trans "Assurance" %}
                                {% if reservation.insurance_value %}
                                    ({{ reservation.insurance_value }} €)
                                {% endif %}
                            </li>
                            {% endif %}
                            {% if reservation.requires_packaging %}
                            <li>
                                <i class="fas fa-check text-success me-2"></i>
                                {% trans "Emballage professionnel" %}
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mission Tracking -->
        {% if mission %}
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-truck me-2"></i> {% trans "Suivi de la mission" %}</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <a href="{% url 'logistics:mission_detail' mission.pk %}" class="btn btn-info">
                        <i class="fas fa-external-link-alt me-2"></i> {% trans "Voir le suivi détaillé" %}
                    </a>
                </div>

                <!-- Quick Status -->
                <div class="row mb-4">
                    <div class="col-md-4 text-center">
                        <div class="display-6 fw-bold text-info">{{ mission.progress_percentage }}%</div>
                        <small class="text-muted">{% trans "Progression" %}</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="display-6 fw-bold">
                            {% if mission.current_location %}
                                {{ mission.current_location|truncatechars:20 }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                        <small class="text-muted">{% trans "Localisation actuelle" %}</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="display-6 fw-bold">
                            {% if mission.estimated_delivery %}
                                {{ mission.estimated_delivery|date:"d/m" }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                        <small class="text-muted">{% trans "Livraison estimée" %}</small>
                    </div>
                </div>

                <!-- Recent Tracking Events -->
                {% if tracking_events %}
                <h6 class="mb-3">{% trans "Derniers événements" %}</h6>
                <div class="tracking-timeline">
                    {% for event in tracking_events|slice:":3" %}
                    <div class="tracking-event {% if forloop.first %}current{% else %}completed{% endif %}">
                        <h6 class="mb-1">{{ event.get_event_type_display }}</h6>
                        <p class="mb-1">{{ event.description }}</p>
                        <small class="text-muted">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            {{ event.location|default:"Localisation inconnue" }}
                            •
                            <i class="fas fa-clock me-1"></i>
                            {{ event.created_at|date:"d/m/Y H:i" }}
                        </small>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Payment Information -->
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-euro-sign me-2"></i> {% trans "Informations de paiement" %}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td>{% trans "Prix de l'objet :" %}</td>
                                <td class="text-end">{{ reservation.price_agreed }} €</td>
                            </tr>
                            <tr>
                                <td>{% trans "Frais de transport :" %}</td>
                                <td class="text-end">{{ reservation.shipping_cost }} €</td>
                            </tr>
                            {% if reservation.insurance_cost %}
                            <tr>
                                <td>{% trans "Assurance :" %}</td>
                                <td class="text-end">{{ reservation.insurance_cost }} €</td>
                            </tr>
                            {% endif %}
                            <tr class="table-active fw-bold">
                                <td>{% trans "Total :" %}</td>
                                <td class="text-end">{{ reservation.total_price }} €</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex flex-column h-100 justify-content-center">
                            <div class="mb-3">
                                <strong>{% trans "Statut du paiement :" %}</strong>
                                <span class="badge {% if reservation.is_paid %}bg-success{% else %}bg-warning{% endif %} ms-2">
                                    {% if reservation.is_paid %}
                                        {% trans "Payé" %}
                                    {% else %}
                                        {% trans "En attente" %}
                                    {% endif %}
                                </span>
                            </div>

                            {% if not reservation.is_paid and reservation.status == 'PAYMENT_PENDING' %}
                            <div>
                                <a href="#" class="btn btn-success w-100">
                                    <i class="fas fa-credit-card me-2"></i> {% trans "Procéder au paiement" %}
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Status Update -->
        {% if can_update_status %}
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-sync-alt me-2"></i> {% trans "Mettre à jour le statut" %}</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'logistics:reservation_update_status' reservation.pk %}" class="status-update-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ status_form.status }}
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save me-2"></i> {% trans "Mettre à jour" %}
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Contact Information -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i> {% trans "Contacts" %}</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>{% trans "Acheteur" %}</h6>
                    <div class="d-flex align-items-center">
                        <div class="avatar-circle bg-primary me-3">
                            <span class="avatar-text">{{ reservation.buyer.username|first|upper }}</span>
                        </div>
                        <div>
                            <a href="{% url 'users:profile' reservation.buyer.username %}" class="text-decoration-none">
                                <strong>{{ reservation.buyer.username }}</strong>
                            </a>
                            <br>
                            <small class="text-muted">{{ reservation.buyer.email }}</small>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <h6>{% trans "Vendeur" %}</h6>
                    <div class="d-flex align-items-center">
                        <div class="avatar-circle bg-success me-3">
                            <span class="avatar-text">{{ reservation.ad.seller.username|first|upper }}</span>
                        </div>
                        <div>
                            <a href="{% url 'users:profile' reservation.ad.seller.username %}" class="text-decoration-none">
                                <strong>{{ reservation.ad.seller.username }}</strong>
                            </a>
                            <br>
                            <small class="text-muted">{{ reservation.ad.seller.email }}</small>
                        </div>
                    </div>
                </div>

                {% if reservation.carrier %}
                <div class="mb-3">
                    <h6>{% trans "Transporteur" %}</h6>
                    <div class="d-flex align-items-center">
                        <div class="avatar-circle bg-info me-3">
                            <span class="avatar-text">{{ reservation.carrier.user.username|first|upper }}</span>
                        </div>
                        <div>
                            <a href="{% url 'carriers:carrier_detail' reservation.carrier.user.username %}" class="text-decoration-none">
                                <strong>{{ reservation.carrier.user.username }}</strong>
                            </a>
                            <br>
                            <small class="text-muted">{{ reservation.carrier.user.email }}</small>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="mt-3">
                    {% if can_message_seller %}
                    <a href="{% url 'messaging:new_conversation' reservation.ad.seller.username %}" class="btn btn-outline-primary w-100 mb-2">
                        <i class="fas fa-envelope me-2"></i> {% trans "Contacter le vendeur" %}
                    </a>
                    {% endif %}

                    {% if reservation.carrier and can_message_carrier %}
                    <a href="{% url 'messaging:new_conversation' reservation.carrier.user.username %}" class="btn btn-outline-info w-100 mb-2">
                        <i class="fas fa-truck me-2"></i> {% trans "Contacter le transporteur" %}
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Important Dates -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i> {% trans "Dates importantes" %}</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <small class="text-muted d-block">{% trans "Création" %}</small>
                        <strong>{{ reservation.created_at|date:"d/m/Y H:i" }}</strong>
                    </li>
                    {% if reservation.pickup_date %}
                    <li class="mb-3">
                        <small class="text-muted d-block">{% trans "Prise en charge" %}</small>
                        <strong>{{ reservation.pickup_date|date:"d/m/Y" }}</strong>
                    </li>
                    {% endif %}
                    {% if reservation.delivery_date %}
                    <li class="mb-3">
                        <small class="text-muted d-block">{% trans "Livraison estimée" %}</small>
                        <strong>{{ reservation.delivery_date|date:"d/m/Y" }}</strong>
                    </li>
                    {% endif %}
                    {% if reservation.actual_delivery_date %}
                    <li class="mb-3">
                        <small class="text-muted d-block">{% trans "Livraison réelle" %}</small>
                        <strong>{{ reservation.actual_delivery_date|date:"d/m/Y" }}</strong>
                    </li>
                    {% endif %}
                    {% if reservation.cancelled_at %}
                    <li class="mb-3">
                        <small class="text-muted d-block">{% trans "Annulation" %}</small>
                        <strong>{{ reservation.cancelled_at|date:"d/m/Y H:i" }}</strong>
                        {% if reservation.cancellation_reason %}
                            <br>
                            <small class="text-muted">{{ reservation.cancellation_reason }}</small>
                        {% endif %}
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}


========== logistics/templates/logistics/reservations/reservation_create.html ==========
{# ~/ebi3/logistics/templates/logistics/reservations/reservation_create.html #}

{% extends 'logistics/base_logistics.html' %}
{% load i18n crispy_forms_tags %}

{% block logistics_title %}{% trans "Nouvelle réservation" %}{% endblock %}

{% block logistics_subtitle %}{{ ad.title }}{% endblock %}

{% block logistics_breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'ads:ad_detail' ad.slug %}">{{ ad.title|truncatechars:30 }}</a>
</li>
<li class="breadcrumb-item active" aria-current="page">{% trans "Réserver" %}</li>
{% endblock %}

{% block logistics_content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i> {% trans "Réserver cette annonce" %}</h5>
            </div>
            <div class="card-body">
                <!-- Annonce Summary -->
                <div class="alert alert-info mb-4">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            {% with ad.images.first as main_image %}
                                {% if main_image %}
                                    <img src="{{ main_image.thumbnail.url|default:main_image.image.url }}"
                                         class="rounded"
                                         style="width: 80px; height: 80px; object-fit: cover;"
                                         alt="{{ ad.title }}">
                                {% else %}
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                         style="width: 80px; height: 80px;">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="alert-heading">{{ ad.title }}</h6>
                            <p class="mb-1">
                                <strong>{% trans "Prix :" %}</strong> {{ ad.get_price_with_currency }}
                                {% if ad.is_negotiable %}
                                    <small class="text-muted">{% trans "(Négociable)" %}</small>
                                {% endif %}
                            </p>
                            <p class="mb-1">
                                <strong>{% trans "Vendeur :" %}</strong>
                                <a href="{% url 'users:profile' ad.seller.username %}">{{ ad.seller.username }}</a>
                            </p>
                            <p class="mb-0">
                                <strong>{% trans "Localisation :" %}</strong>
                                {{ ad.city_from }} → {{ ad.city_to }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Reservation Form -->
                <form method="post" novalidate>
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.logistics_option|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.carrier|as_crispy_field }}
                        </div>
                    </div>

                    <!-- Carrier field will be shown/hidden based on logistics option -->
                    <script>
                        function toggleCarrierField() {
                            const logisticsOption = document.getElementById('id_logistics_option').value;
                            const carrierField = document.getElementById('carrier-select').closest('.mb-3');

                            if (logisticsOption === 'WITH_CARRIER') {
                                carrierField.style.display = 'block';
                            } else {
                                carrierField.style.display = 'none';
                            }
                        }

                        // Initial toggle
                        document.addEventListener('DOMContentLoaded', toggleCarrierField);
                    </script>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.pickup_address|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.delivery_address|as_crispy_field }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.pickup_date|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.delivery_date|as_crispy_field }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.shipping_cost|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.insurance_cost|as_crispy_field }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.requires_insurance }}
                            <label class="form-check-label" for="{{ form.requires_insurance.id_for_label }}">
                                {{ form.requires_insurance.label }}
                            </label>
                        </div>
                    </div>

                    <div class="mb-3" id="insurance-value-field" style="display: none;">
                        {{ form.insurance_value|as_crispy_field }}
                    </div>

                    <script>
                        document.getElementById('{{ form.requires_insurance.id_for_label }}').addEventListener('change', function() {
                            const insuranceValueField = document.getElementById('insurance-value-field');
                            insuranceValueField.style.display = this.checked ? 'block' : 'none';
                        });
                    </script>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.requires_packaging }}
                            <label class="form-check-label" for="{{ form.requires_packaging.id_for_label }}">
                                {{ form.requires_packaging.label }}
                            </label>
                        </div>
                    </div>

                    <div class="mb-3" id="packaging-details-field" style="display: none;">
                        {{ form.packaging_details|as_crispy_field }}
                    </div>

                    <script>
                        document.getElementById('{{ form.requires_packaging.id_for_label }}').addEventListener('change', function() {
                            const packagingDetailsField = document.getElementById('packaging-details-field');
                            packagingDetailsField.style.display = this.checked ? 'block' : 'none';
                        });
                    </script>

                    <div class="mb-4">
                        {{ form.buyer_notes|as_crispy_field }}
                    </div>

                    <!-- Price Summary -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h6 class="card-title">{% trans "Récapitulatif du prix" %}</h6>
                            <table class="table table-sm mb-0">
                                <tr>
                                    <td>{% trans "Prix de l'objet" %}</td>
                                    <td class="text-end">{{ ad.price }} €</td>
                                </tr>
                                <tr>
                                    <td>{% trans "Frais de transport" %}</td>
                                    <td class="text-end">
                                        <span id="shipping-cost-display">0</span> €
                                    </td>
                                </tr>
                                <tr>
                                    <td>{% trans "Assurance" %}</td>
                                    <td class="text-end">
                                        <span id="insurance-cost-display">0</span> €
                                    </td>
                                </tr>
                                <tr class="table-active fw-bold">
                                    <td>{% trans "Total" %}</td>
                                    <td class="text-end">
                                        <span id="total-price-display">{{ ad.price }}</span> €
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <script>
                        function updatePriceSummary() {
                            const itemPrice = {{ ad.price }};
                            const shippingCost = parseFloat(document.getElementById('id_shipping_cost').value) || 0;
                            const insuranceCost = parseFloat(document.getElementById('id_insurance_cost').value) || 0;

                            document.getElementById('shipping-cost-display').textContent = shippingCost.toFixed(2);
                            document.getElementById('insurance-cost-display').textContent = insuranceCost.toFixed(2);

                            const totalPrice = itemPrice + shippingCost + insuranceCost;
                            document.getElementById('total-price-display').textContent = totalPrice.toFixed(2);
                        }

                        // Update price summary when shipping or insurance costs change
                        document.getElementById('id_shipping_cost').addEventListener('input', updatePriceSummary);
                        document.getElementById('id_insurance_cost').addEventListener('input', updatePriceSummary);

                        // Initial update
                        updatePriceSummary();
                    </script>

                    <!-- Terms and Conditions -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                            <label class="form-check-label" for="agreeTerms">
                                {% trans "J'accepte les" %}
                                <a href="{% url 'core:terms' %}" target="_blank">{% trans "conditions générales" %}</a>
                                {% trans "et la" %}
                                <a href="{% url 'core:privacy' %}" target="_blank">{% trans "politique de confidentialité" %}</a>
                            </label>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-check-circle me-2"></i> {% trans "Confirmer la réservation" %}
                        </button>
                        <a href="{% url 'ads:ad_detail' ad.slug %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i> {% trans "Annuler" %}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Recommended Carriers -->
        {% if recommended_carriers %}
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-truck me-2"></i> {% trans "Transporteurs recommandés" %}</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for carrier in recommended_carriers %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ carrier.user.username }}</h6>
                            <small>{{ carrier.base_price_per_kg }} €/kg</small>
                        </div>
                        <p class="mb-1 small">
                            <i class="fas fa-star text-warning"></i> {{ carrier.average_rating|default:"0.0" }}
                            • {{ carrier.completed_missions }} {% trans "missions" %}
                        </p>
                        <small class="text-muted">
                            <i class="fas fa-weight-hanging"></i> {{ carrier.max_weight }} kg
                            • <i class="fas fa-arrows-alt"></i> {{ carrier.max_volume }} m³
                        </small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Help Information -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> {% trans "Informations importantes" %}</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning mb-3">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i> {% trans "À savoir" %}</h6>
                    <ul class="mb-0 small">
                        <li>{% trans "La réservation engage votre achat" %}</li>
                        <li>{% trans "Vous pouvez annuler sous certaines conditions" %}</li>
                        <li>{% trans "Le paiement est sécurisé" %}</li>
                    </ul>
                </div>

                <h6>{% trans "Options logistiques" %}</h6>
                <div class="small">
                    <p class="mb-2">
                        <strong>P2P Direct :</strong>
                        {% trans "Vous organisez le transport directement avec le vendeur" %}
                    </p>
                    <p class="mb-2">
                        <strong>Avec transporteur :</strong>
                        {% trans "Un transporteur professionnel s'occupe de tout" %}
                    </p>
                    <p class="mb-0">
                        <strong>Avec expatrié-transporteur :</strong>
                        {% trans "Un particulier qui voyage transporte votre objet" %}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


========== logistics/templates/logistics/routes/route_list.html ==========
{# ~/ebi3/logistics/templates/logistics/routes/route_list.html #}

{% extends 'logistics/base_logistics.html' %}
{% load i18n %}

{% block logistics_title %}{% trans "Routes disponibles" %}{% endblock %}

{% block logistics_subtitle %}{% trans "Trouvez un transport pour votre objet" %}{% endblock %}

{% block logistics_breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">{% trans "Routes" %}</li>
{% endblock %}

{% block logistics_header_actions %}
{% if user.role == 'CARRIER' and user.carrier_profile %}
<a href="{% url 'logistics:route_create' %}" class="btn btn-success">
    <i class="fas fa-plus me-2"></i> {% trans "Publier une route" %}
</a>
{% endif %}
{% endblock %}

{% block logistics_content %}
<!-- Search and Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">{% trans "Ville de départ" %}</label>
                {{ search_form.start_city }}
            </div>
            <div class="col-md-3">
                <label class="form-label">{% trans "Ville d'arrivée" %}</label>
                {{ search_form.end_city }}
            </div>
            <div class="col-md-3">
                <label class="form-label">{% trans "Date de départ" %}</label>
                {{ search_form.departure_date_from }}
            </div>
            <div class="col-md-3">
                <label class="form-label">{% trans "Date de retour" %}</label>
                {{ search_form.departure_date_to }}
            </div>

            <div class="col-md-3">
                <label class="form-label">{% trans "Prix maximum" %}</label>
                {{ search_form.max_price }}
            </div>
            <div class="col-md-3">
                <label class="form-label">{% trans "Poids disponible" %}</label>
                {{ search_form.min_available_weight }}
            </div>
            <div class="col-md-3">
                <label class="form-label">{% trans "Volume disponible" %}</label>
                {{ search_form.min_available_volume }}
            </div>
            <div class="col-md-3">
                <label class="form-label">{% trans "Trier par" %}</label>
                {{ search_form.sort_by }}
            </div>

            <div class="col-12">
                <div class="form-check form-check-inline">
                    {{ search_form.includes_insurance }}
                    <label class="form-check-label" for="{{ search_form.includes_insurance.id_for_label }}">
                        {{ search_form.includes_insurance.label }}
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    {{ search_form.includes_packaging }}
                    <label class="form-check-label" for="{{ search_form.includes_packaging.id_for_label }}">
                        {{ search_form.includes_packaging.label }}
                    </label>
                </div>
            </div>

            <div class="col-12">
                <div class="d-flex justify-content-between">
                    <div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i> {% trans "Rechercher" %}
                        </button>
                        <a href="{% url 'logistics:route_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i> {% trans "Effacer" %}
                        </a>
                    </div>
                    <div class="text-muted">
                        {{ total_count }} {% trans "résultats" %}
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Stats -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ stats.total_routes|default:"0" }}</h3>
                <p class="text-muted mb-0">{% trans "Routes disponibles" %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h3 class="text-success">{{ stats.professional_carriers|default:"0" }}</h3>
                <p class="text-muted mb-0">{% trans "Transporteurs professionnels" %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h3 class="text-info">{{ stats.personal_carriers|default:"0" }}</h3>
                <p class="text-muted mb-0">{% trans "Transporteurs particuliers" %}</p>
            </div>
        </div>
    </div>
</div>

<!-- Routes List -->
{% if routes %}
    <div class="row">
        {% for route in routes %}
        <div class="col-md-6 col-lg-4 mb-4">
            {% include 'logistics/partials/route_card.html' with route=route %}
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        {{ num }}
                    </a>
                </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-route fa-4x text-muted mb-3"></i>
        <h4 class="text-muted mb-3">{% trans "Aucune route disponible" %}</h4>
        <p class="text-muted mb-4">
            {% if request.GET %}
                {% trans "Aucune route ne correspond à vos critères de recherche." %}
            {% else %}
                {% trans "Aucune route n'est disponible pour le moment." %}
            {% endif %}
        </p>
        {% if user.role == 'CARRIER' and user.carrier_profile %}
        <a href="{% url 'logistics:route_create' %}" class="btn btn-success btn-lg">
            <i class="fas fa-plus me-2"></i> {% trans "Devenir le premier transporteur" %}
        </a>
        {% endif %}
    </div>
{% endif %}
{% endblock %}


========== logistics/templates/logistics/partials/reservation_card.html ==========
{# ~/ebi3/logistics/templates/logistics/partials/reservation_card.html #}

<div class="card logistics-card h-100">
    <div class="card-body d-flex flex-column">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h6 class="card-title mb-1">
                    <a href="{% url 'logistics:reservation_detail' reservation.pk %}" class="text-decoration-none text-dark">
                        #{{ reservation.id }}
                    </a>
                </h6>
                <small class="text-muted">
                    {{ reservation.created_at|date:"d/m/Y" }}
                </small>
            </div>
            <span class="status-badge status-{{ reservation.status|lower }}">
                {{ reservation.get_status_display }}
            </span>
        </div>

        <!-- Annonce -->
        <div class="mb-3">
            <small class="text-muted d-block">{% trans "Annonce" %}</small>
            <a href="{{ reservation.ad.get_absolute_url }}" class="text-decoration-none">
                <strong>{{ reservation.ad.title|truncatechars:40 }}</strong>
            </a>
        </div>

        <!-- Informations -->
        <div class="mb-3">
            <div class="row">
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Option" %}</small>
                    <small class="fw-bold">{{ reservation.get_logistics_option_display }}</small>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Prix total" %}</small>
                    <small class="fw-bold">{{ reservation.total_price }} €</small>
                </div>
            </div>
        </div>

        <!-- Dates -->
        <div class="mb-3">
            <div class="row">
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Prise en charge" %}</small>
                    <small>
                        {% if reservation.pickup_date %}
                            {{ reservation.pickup_date|date:"d/m/Y" }}
                        {% else %}
                            <span class="text-muted">{% trans "À définir" %}</span>
                        {% endif %}
                    </small>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Livraison" %}</small>
                    <small>
                        {% if reservation.delivery_date %}
                            {{ reservation.delivery_date|date:"d/m/Y" }}
                        {% else %}
                            <span class="text-muted">{% trans "À définir" %}</span>
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>

        <!-- Progress bar for active reservations -->
        {% if reservation.status == 'IN_TRANSIT' and reservation.mission %}
        <div class="mb-3">
            <small class="text-muted d-block mb-1">{% trans "Progression" %}</small>
            <div class="progress-bar-logistics">
                <div class="progress-fill bg-info" data-width="{{ reservation.mission.progress_percentage }}"></div>
            </div>
            <small class="text-muted text-end d-block mt-1">{{ reservation.mission.progress_percentage }}%</small>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="mt-auto">
            <div class="d-flex justify-content-between">
                <a href="{% url 'logistics:reservation_detail' reservation.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye me-1"></i> {% trans "Détails" %}
                </a>
                {% if reservation.can_be_cancelled %}
                <form method="post" action="{% url 'logistics:reservation_cancel' reservation.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger confirm-action"
                            data-confirm-message="{% trans 'Êtes-vous sûr de vouloir annuler cette réservation ?' %}">
                        <i class="fas fa-times me-1"></i> {% trans "Annuler" %}
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>


========== logistics/templates/logistics/partials/mission_card.html ==========
{# ~/ebi3/logistics/templates/logistics/partials/mission_card.html #}

<div class="card logistics-card h-100">
    <div class="card-body d-flex flex-column">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h6 class="card-title mb-1">
                    <a href="{% url 'logistics:mission_detail' mission.pk %}" class="text-decoration-none text-dark">
                        Mission #{{ mission.id }}
                    </a>
                </h6>
                <small class="text-muted">
                    {% trans "Réservation" %} #{{ mission.reservation.id }}
                </small>
            </div>
            <span class="status-badge status-{{ mission.status|lower }}">
                {{ mission.get_status_display }}
            </span>
        </div>

        <!-- Annonce -->
        <div class="mb-3">
            <small class="text-muted d-block">{% trans "Objet" %}</small>
            <a href="{{ mission.reservation.ad.get_absolute_url }}" class="text-decoration-none">
                <strong>{{ mission.reservation.ad.title|truncatechars:40 }}</strong>
            </a>
        </div>

        <!-- Transporteur -->
        <div class="mb-3">
            <div class="d-flex align-items-center">
                <div class="avatar-circle bg-info me-2" style="width: 30px; height: 30px;">
                    <span class="avatar-text" style="font-size: 0.8rem;">
                        {{ mission.carrier.user.username|first|upper }}
                    </span>
                </div>
                <div>
                    <small class="text-muted d-block">{% trans "Transporteur" %}</small>
                    <small>
                        <a href="{% url 'carriers:carrier_detail' mission.carrier.user.username %}" class="text-decoration-none">
                            {{ mission.carrier.user.username }}
                        </a>
                    </small>
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div class="mb-3">
            <small class="text-muted d-block mb-1">{% trans "Progression" %}</small>
            <div class="progress-bar-logistics">
                <div class="progress-fill bg-info" data-width="{{ mission.progress_percentage }}"></div>
            </div>
            <small class="text-muted text-end d-block mt-1">{{ mission.progress_percentage }}%</small>
        </div>

        <!-- Dates -->
        <div class="mb-3">
            <div class="row">
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Départ" %}</small>
                    <small>
                        {% if mission.scheduled_pickup %}
                            {{ mission.scheduled_pickup|date:"d/m" }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </small>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Livraison estimée" %}</small>
                    <small>
                        {% if mission.estimated_delivery %}
                            {{ mission.estimated_delivery|date:"d/m" }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="mt-auto">
            <div class="d-flex justify-content-between">
                <a href="{% url 'logistics:mission_detail' mission.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye me-1"></i> {% trans "Détails" %}
                </a>
                {% if mission.status != 'DELIVERED' and mission.status != 'CANCELLED' %}
                <a href="{% url 'logistics:mission_update' mission.pk %}" class="btn btn-sm btn-outline-info">
                    <i class="fas fa-edit me-1"></i> {% trans "Mettre à jour" %}
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>


========== logistics/templates/logistics/partials/route_card.html ==========
{# ~/ebi3/logistics/templates/logistics/partials/route_card.html #}

<div class="card logistics-card h-100">
    <div class="card-body d-flex flex-column">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h6 class="card-title mb-1">
                    <a href="{% url 'logistics:route_detail' route.pk %}" class="text-decoration-none text-dark">
                        {{ route.start_city }} → {{ route.end_city }}
                    </a>
                </h6>
                <small class="text-muted">
                    {{ route.departure_date|date:"d/m/Y" }}
                    {% if route.days_until_departure > 0 %}
                        • {% trans "Dans" %} {{ route.days_until_departure }} {% trans "jours" %}
                    {% endif %}
                </small>
            </div>
            <span class="badge {% if route.status == 'ACTIVE' %}bg-success{% elif route.status == 'FULL' %}bg-warning{% else %}bg-secondary{% endif %}">
                {{ route.get_status_display }}
            </span>
        </div>

        <!-- Carrier -->
        <div class="mb-3">
            <div class="d-flex align-items-center">
                <div class="avatar-circle bg-info me-2" style="width: 30px; height: 30px;">
                    <span class="avatar-text" style="font-size: 0.8rem;">
                        {{ route.carrier.user.username|first|upper }}
                    </span>
                </div>
                <div>
                    <small class="text-muted d-block">{% trans "Transporteur" %}</small>
                    <small>
                        <a href="{% url 'carriers:carrier_detail' route.carrier.user.username %}" class="text-decoration-none">
                            {% if route.carrier.company_name %}
                                {{ route.carrier.company_name }}
                            {% else %}
                                {{ route.carrier.user.username }}
                            {% endif %}
                        </a>
                    </small>
                </div>
            </div>
        </div>

        <!-- Capacity -->
        <div class="mb-3">
            <small class="text-muted d-block">{% trans "Capacité disponible" %}</small>
            <div class="d-flex justify-content-between">
                <div class="text-center">
                    <div class="fw-bold">{{ route.available_weight }} kg</div>
                    <small class="text-muted">{% trans "Poids" %}</small>
                </div>
                <div class="text-center">
                    <div class="fw-bold">{{ route.available_volume }} m³</div>
                    <small class="text-muted">{% trans "Volume" %}</small>
                </div>
            </div>
        </div>

        <!-- Price -->
        <div class="mb-3">
            <small class="text-muted d-block">{% trans "Prix" %}</small>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    {% if route.fixed_price %}
                        <span class="fw-bold">{{ route.fixed_price }} €</span>
                        <br>
                        <small class="text-muted">{% trans "Prix fixe" %}</small>
                    {% else %}
                        <span class="fw-bold">{{ route.price_per_kg|default:"0" }} €/kg</span>
                        <br>
                        <small class="text-muted">{% trans "ou" %} {{ route.price_per_m3|default:"0" }} €/m³</small>
                    {% endif %}
                </div>
                {% if route.is_featured %}
                <span class="badge bg-warning">
                    <i class="fas fa-star me-1"></i> {% trans "Recommandé" %}
                </span>
                {% endif %}
            </div>
        </div>

        <!-- Services -->
        {% if route.includes_insurance or route.includes_packaging %}
        <div class="mb-3">
            <small class="text-muted d-block">{% trans "Services inclus" %}</small>
            <div class="d-flex flex-wrap gap-1">
                {% if route.includes_insurance %}
                <span class="badge bg-success">
                    <i class="fas fa-shield-alt me-1"></i> {% trans "Assurance" %}
                </span>
                {% endif %}
                {% if route.includes_packaging %}
                <span class="badge bg-info">
                    <i class="fas fa-box me-1"></i> {% trans "Emballage" %}
                </span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="mt-auto">
            <div class="d-grid">
                {% if route.is_available %}
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'logistics:route_book' route.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-calendar-check me-2"></i> {% trans "Réserver" %}
                        </button>
                    </form>
                    {% else %}
                    <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-success w-100">
                        <i class="fas fa-calendar-check me-2"></i> {% trans "Réserver" %}
                    </a>
                    {% endif %}
                {% else %}
                    <button class="btn btn-secondary w-100" disabled>
                        <i class="fas fa-times me-2"></i> {% trans "Indisponible" %}
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>


========== logistics/templates/logistics/partials/tracking_timeline.html ==========
{# ~/ebi3/logistics/templates/logistics/partials/tracking_timeline.html #}

<div class="tracking-timeline">
    {% for event in events %}
    <div class="tracking-event {% if forloop.first %}current{% else %}completed{% endif %}">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
                <h6 class="mb-1">{{ event.get_event_type_display }}</h6>
                <p class="mb-1">{{ event.description }}</p>
            </div>
            <small class="text-muted">
                {{ event.created_at|date:"d/m/Y H:i" }}
            </small>
        </div>

        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
                {% if event.location %}
                    <i class="fas fa-map-marker-alt me-1"></i>
                    {{ event.location }}
                {% endif %}
            </small>

            {% if event.photo %}
            <a href="{{ event.photo.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-image me-1"></i> {% trans "Voir photo" %}
            </a>
            {% endif %}
        </div>

        {% if event.created_by %}
        <small class="text-muted d-block mt-1">
            <i class="fas fa-user me-1"></i>
            {{ event.created_by.username }}
        </small>
        {% endif %}
    </div>
    {% endfor %}
</div>


========== logistics/templates/logistics/missions/mission_detail.html ==========
{# ~/ebi3/logistics/templates/logistics/missions/mission_detail.html #}

{% extends 'logistics/base_logistics.html' %}
{% load i18n %}

{% block logistics_title %}{% trans "Mission" %} #{{ mission.id }}{% endblock %}

{% block logistics_subtitle %}{{ mission.reservation.ad.title }}{% endblock %}

{% block logistics_breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'logistics:mission_list' %}">{% trans "Missions" %}</a>
</li>
<li class="breadcrumb-item active" aria-current="page">#{{ mission.id }}</li>
{% endblock %}

{% block logistics_content %}
<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Mission Header -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-0">
                            {% trans "Statut :" %}
                            <span class="status-badge status-{{ mission.status|lower }}">
                                {{ mission.get_status_display }}
                            </span>
                        </h5>
                        <small class="text-muted">
                            {% trans "Créée le" %} {{ mission.created_at|date:"d/m/Y à H:i" }}
                        </small>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="action-buttons">
                            {% if can_update_tracking %}
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTrackingEventModal">
                                <i class="fas fa-plus me-2"></i> {% trans "Ajouter un événement" %}
                            </button>
                            {% endif %}
                            <a href="{% url 'logistics:mission_update' mission.pk %}" class="btn btn-outline-primary">
                                <i class="fas fa-edit me-2"></i> {% trans "Modifier" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tracking Map -->
        {% if mission.latitude and mission.longitude %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i> {% trans "Suivi en temps réel" %}</h5>
            </div>
            <div class="card-body p-0">
                <div id="tracking-map" class="map-container"></div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize map
                const map = L.map('tracking-map').setView([{{ mission.latitude }}, {{ mission.longitude }}], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);

                // Add current location marker
                L.marker([{{ mission.latitude }}, {{ mission.longitude }}])
                    .addTo(map)
                    .bindPopup('{% trans "Position actuelle" %}')
                    .openPopup();

                // Add route markers if available
                {% for event in tracking_events %}
                    {% if event.latitude and event.longitude %}
                    L.marker([{{ event.latitude }}, {{ event.longitude }}])
                        .addTo(map)
                        .bindPopup('{{ event.get_event_type_display }}<br>{{ event.created_at|date:"d/m/Y H:i" }}');
                    {% endif %}
                {% endfor %}
            });
        </script>
        {% endif %}

        <!-- Tracking Timeline -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i> {% trans "Historique du suivi" %}</h5>
            </div>
            <div class="card-body">
                {% if tracking_events %}
                    {% include 'logistics/partials/tracking_timeline.html' with events=tracking_events %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <p class="text-muted">{% trans "Aucun événement de suivi pour le moment" %}</p>
                        {% if can_update_tracking %}
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTrackingEventModal">
                            <i class="fas fa-plus me-2"></i> {% trans "Ajouter le premier événement" %}
                        </button>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Mission Details -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> {% trans "Détails de la mission" %}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>{% trans "Informations de base" %}</h6>
                        <table class="table table-sm">
                            <tr>
                                <td>{% trans "Mission ID :" %}</td>
                                <td class="text-end">#{{ mission.id }}</td>
                            </tr>
                            <tr>
                                <td>{% trans "Réservation :" %}</td>
                                <td class="text-end">
                                    <a href="{% url 'logistics:reservation_detail' mission.reservation.pk %}">
                                        #{{ mission.reservation.id }}
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td>{% trans "Transporteur :" %}</td>
                                <td class="text-end">
                                    <a href="{% url 'carriers:carrier_detail' mission.carrier.user.username %}">
                                        {{ mission.carrier.user.username }}
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td>{% trans "Distance :" %}</td>
                                <td class="text-end">
                                    {% if mission.distance_km %}
                                        {{ mission.distance_km }} km
                                    {% else %}
                                        <span class="text-muted">{% trans "Non définie" %}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>

                    <div class="col-md-6">
                        <h6>{% trans "Dates" %}</h6>
                        <table class="table table-sm">
                            {% if mission.scheduled_pickup %}
                            <tr>
                                <td>{% trans "Prise en charge prévue :" %}</td>
                                <td class="text-end">{{ mission.scheduled_pickup|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% endif %}
                            {% if mission.actual_pickup %}
                            <tr>
                                <td>{% trans "Prise en charge réelle :" %}</td>
                                <td class="text-end">{{ mission.actual_pickup|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% endif %}
                            {% if mission.estimated_delivery %}
                            <tr>
                                <td>{% trans "Livraison estimée :" %}</td>
                                <td class="text-end">{{ mission.estimated_delivery|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% endif %}
                            {% if mission.actual_delivery %}
                            <tr>
                                <td>{% trans "Livraison réelle :" %}</td>
                                <td class="text-end">{{ mission.actual_delivery|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>

                {% if mission.current_location %}
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>{% trans "Localisation actuelle" %}</h6>
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            {{ mission.current_location }}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if mission.notes %}
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>{% trans "Notes" %}</h6>
                        <div class="alert alert-light">
                            {{ mission.notes|linebreaks }}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if mission.delay_reason %}
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>{% trans "Raison du retard" %}</h6>
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {{ mission.delay_reason }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Progress -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> {% trans "Progression" %}</h5>
            </div>
            <div class="card-body text-center">
                <div class="display-1 fw-bold text-primary">{{ mission.progress_percentage }}%</div>
                <div class="progress-bar-logistics mt-3">
                    <div class="progress-fill bg-primary" data-width="{{ mission.progress_percentage }}"></div>
                </div>
                <div class="mt-3">
                    {% if mission.is_delayed %}
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {% trans "Cette mission est en retard" %}
                    </div>
                    {% else %}
                    <div class="alert alert-success mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        {% trans "Cette mission est dans les temps" %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Reservation Summary -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i> {% trans "Réservation associée" %}</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <a href="{% url 'logistics:reservation_detail' mission.reservation.pk %}" class="text-decoration-none">
                        <h6 class="mb-1">#{{ mission.reservation.id }}</h6>
                    </a>
                    <p class="mb-2 small text-muted">{{ mission.reservation.ad.title|truncatechars:50 }}</p>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">{% trans "Prix total" %}</small>
                        <small class="fw-bold">{{ mission.reservation.total_price }} €</small>
                    </div>
                </div>

                <div class="list-group list-group-flush">
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">{% trans "Acheteur" %}</small>
                            <small>
                                <a href="{% url 'users:profile' mission.reservation.buyer.username %}" class="text-decoration-none">
                                    {{ mission.reservation.buyer.username }}
                                </a>
                            </small>
                        </div>
                    </div>
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">{% trans "Vendeur" %}</small>
                            <small>
                                <a href="{% url 'users:profile' mission.reservation.ad.seller.username %}" class="text-decoration-none">
                                    {{ mission.reservation.ad.seller.username }}
                                </a>
                            </small>
                        </div>
                    </div>
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">{% trans "Option logistique" %}</small>
                            <small class="badge bg-secondary">
                                {{ mission.reservation.get_logistics_option_display }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Carrier Information -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-truck me-2"></i> {% trans "Transporteur" %}</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div class="avatar-circle bg-info mx-auto mb-3" style="width: 80px; height: 80px;">
                        <span class="avatar-text" style="font-size: 2rem;">
                            {{ mission.carrier.user.username|first|upper }}
                        </span>
                    </div>
                    <h5>
                        <a href="{% url 'carriers:carrier_detail' mission.carrier.user.username %}" class="text-decoration-none">
                            {% if mission.carrier.company_name %}
                                {{ mission.carrier.company_name }}
                            {% else %}
                                {{ mission.carrier.user.username }}
                            {% endif %}
                        </a>
                    </h5>
                    <div class="rating-stars mb-2">
                        {% with rating=mission.carrier.average_rating|default:0 %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= rating %}
                                    <i class="fas fa-star text-warning"></i>
                                {% else %}
                                    <i class="far fa-star text-warning"></i>
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                        <small class="text-muted ms-1">
                            ({{ mission.carrier.average_rating|default:"0.0" }})
                        </small>
                    </div>
                    <p class="text-muted small mb-0">
                        {{ mission.carrier.completed_missions }} {% trans "missions complétées" %}
                    </p>
                </div>

                <div class="d-grid gap-2">
                    <a href="{% url 'carriers:carrier_detail' mission.carrier.user.username %}" class="btn btn-outline-success">
                        <i class="fas fa-eye me-2"></i> {% trans "Voir le profil" %}
                    </a>
                    <a href="{% url 'messaging:new_conversation' mission.carrier.user.username %}" class="btn btn-outline-primary">
                        <i class="fas fa-envelope me-2"></i> {% trans "Contacter" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Tracking Event Modal -->
{% if can_update_tracking %}
<div class="modal fade" id="addTrackingEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Ajouter un événement de suivi" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'logistics:tracking_event_create' mission.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{% trans "Type d'événement" %}</label>
                        {{ tracking_form.event_type }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Description" %}</label>
                        {{ tracking_form.description }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Localisation" %}</label>
                        {{ tracking_form.location }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Photo (optionnel)" %}</label>
                        {{ tracking_form.photo }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "Annuler" %}
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i> {% trans "Enregistrer" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block logistics_extra_js %}
{% if can_update_tracking %}
<script>
    // Auto-fill location from browser if available
    document.addEventListener('DOMContentLoaded', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                // You could reverse geocode here to get address
                // For now, just show coordinates
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                document.getElementById('{{ tracking_form.location.id_for_label }}').value =
                    `Coordonnées: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            });
        }
    });
</script>
{% endif %}
{% endblock %}


========== logistics/templates/logistics/dashboard.html ==========
{# ~/ebi3/logistics/templates/logistics/dashboard.html #}

{% extends 'logistics/base_logistics.html' %}
{% load i18n %}

{% block logistics_title %}{% trans "Tableau de bord Logistique" %}{% endblock %}

{% block logistics_subtitle %}{% trans "Vue d'ensemble de vos activités logistiques" %}{% endblock %}

{% block logistics_content %}
<div class="row mb-4">
    <!-- Quick Stats -->
    <div class="col-md-3 mb-4">
        <div class="card stats-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number">{{ stats.total_reservations|default:"0" }}</div>
                        <div class="small">{% trans "Réservations" %}</div>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card stats-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number">{{ stats.active_missions_count|default:"0" }}</div>
                        <div class="small">{% trans "Missions actives" %}</div>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card stats-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number">{{ stats.available_routes_count|default:"0" }}</div>
                        <div class="small">{% trans "Routes disponibles" %}</div>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-route"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card stats-card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number">{{ stats.pending_proposals|default:"0" }}</div>
                        <div class="small">{% trans "Propositions en attente" %}</div>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-handshake"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Main Content based on user role -->
    {% if user.role == 'SELLER' %}
        <!-- Seller Dashboard -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i> {% trans "Réservations récentes" %}</h5>
                </div>
                <div class="card-body">
                    {% if active_reservations %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>{% trans "ID" %}</th>
                                        <th>{% trans "Acheteur" %}</th>
                                        <th>{% trans "Option" %}</th>
                                        <th>{% trans "Statut" %}</th>
                                        <th>{% trans "Prix" %}</th>
                                        <th>{% trans "Date" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reservation in active_reservations %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'logistics:reservation_detail' reservation.pk %}" class="text-decoration-none">
                                                #{{ reservation.id }}
                                            </a>
                                        </td>
                                        <td>{{ reservation.buyer.username }}</td>
                                        <td>
                                            <span class="badge bg-secondary">
                                                {{ reservation.get_logistics_option_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="status-badge status-{{ reservation.status|lower }}">
                                                {{ reservation.get_status_display }}
                                            </span>
                                        </td>
                                        <td>{{ reservation.total_price }} €</td>
                                        <td>{{ reservation.created_at|date:"d/m/Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                            <p class="text-muted">{% trans "Aucune réservation récente" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <!-- Sales Stats -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> {% trans "Vos statistiques" %}</h5>
                </div>
                <div class="card-body">
                    {% if sales_stats.total_sales %}
                        <div class="text-center">
                            <h3 class="text-success">{{ sales_stats.total_sales }} €</h3>
                            <p class="text-muted">{% trans "Chiffre d'affaires total" %}</p>

                            <div class="row mt-4">
                                <div class="col-6">
                                    <h4>{{ sales_stats.total_count|default:"0" }}</h4>
                                    <small class="text-muted">{% trans "Transactions" %}</small>
                                </div>
                                <div class="col-6">
                                    <h4>{{ sales_stats.avg_sale|default:"0"|floatformat:2 }} €</h4>
                                    <small class="text-muted">{% trans "Moyenne par vente" %}</small>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <p class="text-muted">{% trans "Aucune statistique disponible" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Pending Proposals -->
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-handshake me-2"></i> {% trans "Propositions en attente" %}</h5>
                </div>
                <div class="card-body">
                    {% if pending_proposals %}
                        <div class="list-group">
                            {% for proposal in pending_proposals %}
                            <a href="{% url 'logistics:proposal_detail' proposal.pk %}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ proposal.carrier.user.username }}</h6>
                                    <small>{{ proposal.proposed_price }} €</small>
                                </div>
                                <p class="mb-1 small text-muted">{{ proposal.ad.title|truncatechars:50 }}</p>
                                <small>
                                    <i class="fas fa-clock me-1"></i>
                                    {% trans "Expire dans" %} {{ proposal.days_until_expiry }} {% trans "jours" %}
                                </small>
                            </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-handshake fa-2x text-muted mb-2"></i>
                            <p class="text-muted">{% trans "Aucune proposition en attente" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    {% elif user.role == 'CARRIER' and user.carrier_profile %}
        <!-- Carrier Dashboard -->
        <div class="col-lg-8 mb-4">
            <!-- Active Missions -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-truck me-2"></i> {% trans "Missions actives" %}</h5>
                </div>
                <div class="card-body">
                    {% if active_missions %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>{% trans "Mission" %}</th>
                                        <th>{% trans "Client" %}</th>
                                        <th>{% trans "Statut" %}</th>
                                        <th>{% trans "Livraison estimée" %}</th>
                                        <th>{% trans "Actions" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mission in active_missions %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'logistics:mission_detail' mission.pk %}" class="text-decoration-none">
                                                #{{ mission.id }}
                                            </a>
                                        </td>
                                        <td>{{ mission.reservation.buyer.username }}</td>
                                        <td>
                                            <span class="status-badge status-{{ mission.status|lower }}">
                                                {{ mission.get_status_display }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if mission.estimated_delivery %}
                                                {{ mission.estimated_delivery|date:"d/m/Y" }}
                                            {% else %}
                                                <span class="text-muted">{% trans "Non définie" %}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{% url 'logistics:mission_update' mission.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'logistics:mission_detail' mission.pk %}" class="btn btn-sm btn-outline-info">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-truck fa-3x text-muted mb-3"></i>
                            <p class="text-muted">{% trans "Aucune mission active" %}</p>
                            <a href="{% url 'logistics:proposal_create' %}" class="btn btn-primary">
                                <i class="fas fa-handshake me-2"></i> {% trans "Proposer des transports" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Available Routes -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-route me-2"></i> {% trans "Vos routes disponibles" %}</h5>
                </div>
                <div class="card-body">
                    {% if available_routes %}
                        <div class="row">
                            {% for route in available_routes %}
                            <div class="col-md-6 mb-3">
                                {% include 'logistics/partials/route_card.html' with route=route %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-route fa-3x text-muted mb-3"></i>
                            <p class="text-muted">{% trans "Aucune route active" %}</p>
                            <a href="{% url 'logistics:route_create' %}" class="btn btn-success">
                                <i class="fas fa-plus me-2"></i> {% trans "Créer une route" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <!-- Carrier Stats -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> {% trans "Vos statistiques" %}</h5>
                </div>
                <div class="card-body">
                    {% if carrier_stats %}
                        <div class="text-center">
                            <h3 class="text-info">{{ carrier_stats.completed_missions|default:"0" }}</h3>
                            <p class="text-muted">{% trans "Missions complétées" %}</p>

                            <div class="row mt-4">
                                <div class="col-6">
                                    <h4>{{ carrier_stats.total_earnings|default:"0"|floatformat:2 }} €</h4>
                                    <small class="text-muted">{% trans "Revenus totaux" %}</small>
                                </div>
                                <div class="col-6">
                                    <h4>{{ carrier_stats.avg_rating|default:"0.0" }}/5</h4>
                                    <small class="text-muted">{% trans "Note moyenne" %}</small>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <p class="text-muted">{% trans "Aucune statistique disponible" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Pending Proposals -->
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i> {% trans "Propositions en attente" %}</h5>
                </div>
                <div class="card-body">
                    {% if pending_proposals %}
                        <div class="list-group">
                            {% for proposal in pending_proposals %}
                            <a href="{% url 'logistics:proposal_detail' proposal.pk %}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ proposal.ad.seller.username }}</h6>
                                    <small>{{ proposal.proposed_price }} €</small>
                                </div>
                                <p class="mb-1 small text-muted">{{ proposal.ad.title|truncatechars:50 }}</p>
                                <small>
                                    <i class="fas fa-clock me-1"></i>
                                    {% trans "Expire dans" %} {{ proposal.days_until_expiry }} {% trans "jours" %}
                                </small>
                            </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-handshake fa-2x text-muted mb-2"></i>
                            <p class="text-muted">{% trans "Aucune proposition en attente" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    {% else %}
        <!-- Buyer Dashboard -->
        <div class="col-lg-8 mb-4">
            <!-- My Reservations -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i> {% trans "Mes réservations" %}</h5>
                </div>
                <div class="card-body">
                    {% if my_reservations %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>{% trans "ID" %}</th>
                                        <th>{% trans "Annonce" %}</th>
                                        <th>{% trans "Statut" %}</th>
                                        <th>{% trans "Prix" %}</th>
                                        <th>{% trans "Date" %}</th>
                                        <th>{% trans "Actions" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reservation in my_reservations %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'logistics:reservation_detail' reservation.pk %}" class="text-decoration-none">
                                                #{{ reservation.id }}
                                            </a>
                                        </td>
                                        <td>
                                            <a href="{{ reservation.ad.get_absolute_url }}" class="text-decoration-none">
                                                {{ reservation.ad.title|truncatechars:30 }}
                                            </a>
                                        </td>
                                        <td>
                                            <span class="status-badge status-{{ reservation.status|lower }}">
                                                {{ reservation.get_status_display }}
                                            </span>
                                        </td>
                                        <td>{{ reservation.total_price }} €</td>
                                        <td>{{ reservation.created_at|date:"d/m/Y" }}</td>
                                        <td>
                                            <a href="{% url 'logistics:reservation_detail' reservation.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <a href="{% url 'logistics:reservation_list' %}" class="btn btn-primary">
                                <i class="fas fa-list me-2"></i> {% trans "Voir toutes mes réservations" %}
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted mb-3">{% trans "Aucune réservation" %}</h4>
                            <p class="text-muted mb-4">{% trans "Vous n'avez pas encore fait de réservation." %}</p>
                            <a href="{% url 'ads:ad_list' %}" class="btn btn-primary btn-lg">
                                <i class="fas fa-search me-2"></i> {% trans "Parcourir les annonces" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tracking Missions -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-truck me-2"></i> {% trans "Mes livraisons en cours" %}</h5>
                </div>
                <div class="card-body">
                    {% if tracking_missions %}
                        <div class="row">
                            {% for mission in tracking_missions %}
                            <div class="col-md-6 mb-3">
                                {% include 'logistics/partials/mission_card.html' with mission=mission %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-truck fa-3x text-muted mb-3"></i>
                            <p class="text-muted">{% trans "Aucune livraison en cours" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i> {% trans "Actions rapides" %}</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'ads:ad_list' %}" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i> {% trans "Trouver un objet" %}
                        </a>
                        <a href="{% url 'logistics:route_list' %}" class="btn btn-success">
                            <i class="fas fa-route me-2"></i> {% trans "Trouver un transport" %}
                        </a>
                        {% if not user.carrier_profile %}
                            <a href="{% url 'carriers:apply' %}" class="btn btn-warning">
                                <i class="fas fa-truck me-2"></i> {% trans "Devenir transporteur" %}
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i> {% trans "Besoin d'aide ?" %}</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="{% url 'logistics:faq' %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-question me-2"></i> {% trans "FAQ" %}
                        </a>
                        <a href="{% url 'logistics:guide' %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-book me-2"></i> {% trans "Guide d'utilisation" %}
                        </a>
                        <a href="{% url 'core:contact' %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-envelope me-2"></i> {% trans "Contactez-nous" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}


========== logistics/templates/logistics/base_logistics.html ==========
{# ~/ebi3/logistics/templates/logistics/base_logistics.html #}

{% extends 'core/base.html' %}
{% load i18n static %}

{% block extra_css %}
{{ block.super }}
<style>
    .logistics-dashboard {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: calc(100vh - 200px);
    }

    .logistics-card {
        transition: all 0.3s ease;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
    }

    .logistics-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-color: #667eea;
    }

    .logistics-nav {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 1rem 0;
    }

    .logistics-nav .nav-link {
        color: #666;
        padding: 0.75rem 1.5rem;
        border-left: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .logistics-nav .nav-link:hover {
        color: #667eea;
        background-color: #f8f9fa;
    }

    .logistics-nav .nav-link.active {
        color: #667eea;
        background-color: #f0f5ff;
        border-left-color: #667eea;
        font-weight: 600;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-confirmed { background-color: #d1ecf1; color: #0c5460; }
    .status-in-transit { background-color: #cce5ff; color: #004085; }
    .status-delivered { background-color: #d4edda; color: #155724; }
    .status-cancelled { background-color: #f8d7da; color: #721c24; }

    .progress-bar-logistics {
        height: 10px;
        border-radius: 5px;
        background-color: #e9ecef;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        border-radius: 5px;
        transition: width 0.3s ease;
    }

    .tracking-timeline {
        position: relative;
        padding-left: 2.5rem;
        margin-left: 1rem;
    }

    .tracking-timeline::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #667eea, #764ba2);
    }

    .tracking-event {
        position: relative;
        margin-bottom: 2rem;
    }

    .tracking-event::before {
        content: '';
        position: absolute;
        left: -2.5rem;
        top: 0;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #667eea;
        border: 3px solid white;
        box-shadow: 0 0 0 2px #667eea;
    }

    .tracking-event.completed::before {
        background: #28a745;
        box-shadow: 0 0 0 2px #28a745;
    }

    .tracking-event.current::before {
        background: #ffc107;
        box-shadow: 0 0 0 2px #ffc107;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
    }

    .map-container {
        height: 300px;
        border-radius: 10px;
        overflow: hidden;
        background-color: #f8f9fa;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .stats-card {
        border: none;
        border-radius: 10px;
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .stats-card:hover {
        transform: translateY(-5px);
    }

    .stats-card .card-body {
        padding: 1.5rem;
    }

    .stats-number {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .stats-icon {
        font-size: 2.5rem;
        opacity: 0.7;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .logistics-nav {
            margin-bottom: 1.5rem;
        }

        .action-buttons {
            flex-direction: column;
        }

        .action-buttons .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="logistics-dashboard py-4">
    <div class="container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 mb-2">{% block logistics_title %}{% trans "Logistique" %}{% endblock %}</h1>
                        <p class="text-muted mb-0">{% block logistics_subtitle %}{% trans "Gestion de vos transports et réservations" %}{% endblock %}</p>
                    </div>
                    <div class="d-flex gap-2">
                        {% block logistics_header_actions %}
                        <a href="{% url 'logistics:reservation_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i> {% trans "Nouvelle réservation" %}
                        </a>
                        {% if user.role == 'CARRIER' and user.carrier_profile %}
                        <a href="{% url 'logistics:route_create' %}" class="btn btn-success">
                            <i class="fas fa-route me-2"></i> {% trans "Publier une route" %}
                        </a>
                        {% endif %}
                        {% endblock %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-lg-3 col-xl-2 mb-4">
                {% include 'logistics/includes/logistics_nav.html' %}
            </div>

            <!-- Main Content -->
            <div class="col-lg-9 col-xl-10">
                <!-- Messages -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <!-- Breadcrumb -->
                {% block logistics_breadcrumb %}
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{% url 'logistics:dashboard' %}">{% trans "Logistique" %}</a>
                        </li>
                        {% block logistics_breadcrumb_items %}{% endblock %}
                    </ol>
                </nav>
                {% endblock %}

                <!-- Content -->
                <div class="card logistics-card">
                    <div class="card-body">
                        {% block logistics_content %}{% endblock %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    // Logistics-specific JavaScript
    $(document).ready(function() {
        // Initialize tooltips
        $('[data-bs-toggle="tooltip"]').tooltip();

        // Initialize popovers
        $('[data-bs-toggle="popover"]').popover();

        // Confirm actions
        $('.confirm-action').click(function(e) {
            if (!confirm($(this).data('confirm-message') || '{% trans "Êtes-vous sûr ?" %}')) {
                e.preventDefault();
            }
        });

        // Dynamic status updates
        $('.status-update-form').submit(function(e) {
            e.preventDefault();
            const form = $(this);
            const url = form.attr('action');
            const data = form.serialize();

            $.ajax({
                url: url,
                type: 'POST',
                data: data,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': form.find('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // Update status badge
                        const statusBadge = form.closest('.card').find('.status-badge');
                        statusBadge.text(response.new_status_display);
                        statusBadge.removeClass().addClass('status-badge status-' + response.new_status.toLowerCase());

                        // Show success message
                        showToast('{% trans "Statut mis à jour avec succès" %}', 'success');
                    }
                },
                error: function() {
                    showToast('{% trans "Une erreur est survenue" %}', 'error');
                }
            });
        });

        // Tracking map initialization
        if ($('#tracking-map').length) {
            initTrackingMap();
        }

        // Progress bar animation
        $('.progress-fill').each(function() {
            const width = $(this).data('width') || 0;
            $(this).css('width', width + '%');
        });
    });

    function initTrackingMap() {
        // Initialize map for tracking
        const map = L.map('tracking-map').setView([48.8566, 2.3522], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Add markers from data attributes
        $('.tracking-marker').each(function() {
            const lat = $(this).data('lat');
            const lng = $(this).data('lng');
            const title = $(this).data('title');

            if (lat && lng) {
                L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup(title);
            }
        });
    }

    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        $('#toast-container').append(toastHtml);
        $('.toast').toast('show');

        setTimeout(function() {
            $('.toast').toast('hide');
        }, 3000);
    }
</script>

<!-- Leaflet for maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

{% block logistics_extra_js %}{% endblock %}
{% endblock %}


========== logistics/migrations/0002_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("ads", "0002_initial"),
        ("carriers", "0002_initial"),
        ("core", "0001_initial"),
        ("logistics", "0001_initial"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name="reservation",
            name="buyer",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="purchases",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Acheteur",
            ),
        ),
        migrations.AddField(
            model_name="reservation",
            name="cancelled_by",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="cancelled_reservations",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Annulé par",
            ),
        ),
        migrations.AddField(
            model_name="reservation",
            name="carrier",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="logistics_routes",
                to="carriers.carrier",
                verbose_name="Transporteur",
            ),
        ),
        migrations.AddField(
            model_name="mission",
            name="reservation",
            field=models.OneToOneField(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="mission",
                to="logistics.reservation",
                verbose_name="Réservation",
            ),
        ),
        migrations.AddField(
            model_name="route",
            name="carrier",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="routes",
                to="carriers.carrier",
                verbose_name="Transporteur",
            ),
        ),
        migrations.AddField(
            model_name="route",
            name="end_country",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="arrival_routes",
                to="core.country",
                verbose_name="Pays d'arrivée",
            ),
        ),
        migrations.AddField(
            model_name="route",
            name="start_country",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="departure_routes",
                to="core.country",
                verbose_name="Pays de départ",
            ),
        ),
        migrations.AddField(
            model_name="trackingevent",
            name="created_by",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                to=settings.AUTH_USER_MODEL,
                verbose_name="Créé par",
            ),
        ),
        migrations.AddField(
            model_name="trackingevent",
            name="mission",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="tracking_events",
                to="logistics.mission",
                verbose_name="Mission",
            ),
        ),
        migrations.AddField(
            model_name="transportproposal",
            name="ad",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="transport_proposals",
                to="ads.ad",
                verbose_name="Annonce",
            ),
        ),
        migrations.AddField(
            model_name="transportproposal",
            name="carrier",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="proposals",
                to="carriers.carrier",
                verbose_name="Transporteur",
            ),
        ),
        migrations.AddIndex(
            model_name="reservation",
            index=models.Index(fields=["status"], name="logistics_r_status_bc9948_idx"),
        ),
        migrations.AddIndex(
            model_name="reservation",
            index=models.Index(
                fields=["buyer", "status"], name="logistics_r_buyer_i_b541fb_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="reservation",
            index=models.Index(
                fields=["ad", "status"], name="logistics_r_ad_id_2abdeb_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="reservation",
            index=models.Index(
                fields=["created_at"], name="logistics_r_created_eb71a7_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="mission",
            index=models.Index(fields=["status"], name="logistics_m_status_270aca_idx"),
        ),
        migrations.AddIndex(
            model_name="mission",
            index=models.Index(
                fields=["carrier", "status"], name="logistics_m_carrier_f902c5_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="mission",
            index=models.Index(
                fields=["estimated_delivery"], name="logistics_m_estimat_ee54d2_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="route",
            index=models.Index(fields=["status"], name="logistics_r_status_7d224f_idx"),
        ),
        migrations.AddIndex(
            model_name="route",
            index=models.Index(
                fields=["departure_date"], name="logistics_r_departu_45551c_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="route",
            index=models.Index(
                fields=["carrier", "status"], name="logistics_r_carrier_f89289_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="route",
            index=models.Index(
                fields=["start_country", "end_country"],
                name="logistics_r_start_c_14ae17_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="trackingevent",
            index=models.Index(
                fields=["mission", "created_at"], name="logistics_t_mission_e9c461_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="trackingevent",
            index=models.Index(
                fields=["event_type"], name="logistics_t_event_t_ebffed_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="transportproposal",
            index=models.Index(fields=["status"], name="logistics_t_status_04e514_idx"),
        ),
        migrations.AddIndex(
            model_name="transportproposal",
            index=models.Index(
                fields=["ad", "status"], name="logistics_t_ad_id_b915a2_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="transportproposal",
            index=models.Index(
                fields=["carrier", "status"], name="logistics_t_carrier_1e3904_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="transportproposal",
            index=models.Index(
                fields=["expires_at"], name="logistics_t_expires_b2ddac_idx"
            ),
        ),
        migrations.AlterUniqueTogether(
            name="transportproposal",
            unique_together={("ad", "carrier")},
        ),
    ]



========== logistics/migrations/0001_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import django.core.validators
import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("ads", "0001_initial"),
        ("carriers", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="LogisticsSettings",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "commission_rate",
                    models.DecimalField(
                        decimal_places=2,
                        default=5.0,
                        max_digits=5,
                        validators=[
                            django.core.validators.MinValueValidator(0),
                            django.core.validators.MaxValueValidator(100),
                        ],
                        verbose_name="Taux de commission (%)",
                    ),
                ),
                (
                    "reservation_expiry_hours",
                    models.PositiveIntegerField(
                        default=48, verbose_name="Expiration réservation (heures)"
                    ),
                ),
                (
                    "proposal_expiry_days",
                    models.PositiveIntegerField(
                        default=7, verbose_name="Expiration proposition (jours)"
                    ),
                ),
                (
                    "payment_hold_days",
                    models.PositiveIntegerField(
                        default=3, verbose_name="Rétention paiement (jours)"
                    ),
                ),
                (
                    "auto_release_payment",
                    models.BooleanField(
                        default=True, verbose_name="Libération automatique paiement"
                    ),
                ),
                (
                    "notify_on_reservation",
                    models.BooleanField(
                        default=True, verbose_name="Notifier nouvelle réservation"
                    ),
                ),
                (
                    "notify_on_status_change",
                    models.BooleanField(
                        default=True, verbose_name="Notifier changement statut"
                    ),
                ),
                (
                    "notify_before_expiry",
                    models.BooleanField(
                        default=True, verbose_name="Notifier avant expiration"
                    ),
                ),
                (
                    "created_at",
                    models.DateTimeField(
                        auto_now_add=True, verbose_name="Date de création"
                    ),
                ),
                (
                    "updated_at",
                    models.DateTimeField(
                        auto_now=True, verbose_name="Date de modification"
                    ),
                ),
            ],
            options={
                "verbose_name": "Paramètre logistique",
                "verbose_name_plural": "Paramètres logistiques",
            },
        ),
        migrations.CreateModel(
            name="Route",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "start_city",
                    models.CharField(max_length=100, verbose_name="Ville de départ"),
                ),
                (
                    "start_address",
                    models.TextField(blank=True, verbose_name="Adresse de départ"),
                ),
                (
                    "end_city",
                    models.CharField(max_length=100, verbose_name="Ville d'arrivée"),
                ),
                (
                    "end_address",
                    models.TextField(blank=True, verbose_name="Adresse d'arrivée"),
                ),
                ("departure_date", models.DateField(verbose_name="Date de départ")),
                ("arrival_date", models.DateField(verbose_name="Date d'arrivée")),
                (
                    "max_weight",
                    models.DecimalField(
                        decimal_places=3,
                        max_digits=10,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Poids maximum (kg)",
                    ),
                ),
                (
                    "max_volume",
                    models.DecimalField(
                        decimal_places=3,
                        max_digits=10,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Volume maximum (m³)",
                    ),
                ),
                (
                    "available_weight",
                    models.DecimalField(
                        decimal_places=3,
                        max_digits=10,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Poids disponible (kg)",
                    ),
                ),
                (
                    "available_volume",
                    models.DecimalField(
                        decimal_places=3,
                        max_digits=10,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Volume disponible (m³)",
                    ),
                ),
                (
                    "fixed_price",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Prix fixe",
                    ),
                ),
                (
                    "price_per_kg",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Prix par kg",
                    ),
                ),
                (
                    "price_per_m3",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Prix par m³",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("ACTIVE", "Active"),
                            ("FULL", "Complète"),
                            ("IN_TRANSIT", "En transit"),
                            ("COMPLETED", "Terminée"),
                            ("CANCELLED", "Annulée"),
                        ],
                        default="ACTIVE",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "includes_insurance",
                    models.BooleanField(
                        default=False, verbose_name="Assurance incluse"
                    ),
                ),
                (
                    "includes_packaging",
                    models.BooleanField(default=False, verbose_name="Emballage inclus"),
                ),
                (
                    "includes_loading",
                    models.BooleanField(
                        default=False, verbose_name="Chargement inclus"
                    ),
                ),
                (
                    "includes_unloading",
                    models.BooleanField(
                        default=False, verbose_name="Déchargement inclus"
                    ),
                ),
                (
                    "description",
                    models.TextField(blank=True, verbose_name="Description"),
                ),
                (
                    "special_conditions",
                    models.TextField(blank=True, verbose_name="Conditions spéciales"),
                ),
                (
                    "is_featured",
                    models.BooleanField(default=False, verbose_name="Mis en avant"),
                ),
                (
                    "view_count",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Nombre de vues"
                    ),
                ),
                (
                    "created_at",
                    models.DateTimeField(
                        auto_now_add=True, verbose_name="Date de création"
                    ),
                ),
                (
                    "updated_at",
                    models.DateTimeField(
                        auto_now=True, verbose_name="Date de modification"
                    ),
                ),
            ],
            options={
                "verbose_name": "Route",
                "verbose_name_plural": "Routes",
                "ordering": ["departure_date", "-created_at"],
            },
        ),
        migrations.CreateModel(
            name="TrackingEvent",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "event_type",
                    models.CharField(
                        choices=[
                            ("PICKUP_SCHEDULED", "Prise en charge planifiée"),
                            ("PICKUP_CONFIRMED", "Prise en charge confirmée"),
                            ("PICKUP_COMPLETED", "Prise en charge effectuée"),
                            ("IN_TRANSIT", "En transit"),
                            ("ARRIVED_AT_HUB", "Arrivé au centre de tri"),
                            ("DEPARTED_FROM_HUB", "Départ du centre de tri"),
                            ("OUT_FOR_DELIVERY", "En cours de livraison"),
                            ("DELIVERY_ATTEMPTED", "Tentative de livraison"),
                            ("DELIVERY_RESCHEDULED", "Livraison reprogrammée"),
                            ("DELIVERED", "Livré"),
                            ("DELAYED", "Retardé"),
                            ("CUSTOMS_CLEARANCE", "Dédouanement"),
                            ("CUSTOMS_HELD", "Retenu en douane"),
                            ("ISSUE_REPORTED", "Problème signalé"),
                            ("ISSUE_RESOLVED", "Problème résolu"),
                        ],
                        max_length=50,
                        verbose_name="Type d'événement",
                    ),
                ),
                ("description", models.TextField(verbose_name="Description")),
                (
                    "location",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Localisation"
                    ),
                ),
                (
                    "latitude",
                    models.FloatField(blank=True, null=True, verbose_name="Latitude"),
                ),
                (
                    "longitude",
                    models.FloatField(blank=True, null=True, verbose_name="Longitude"),
                ),
                (
                    "photo",
                    models.ImageField(
                        blank=True,
                        null=True,
                        upload_to="tracking/events/",
                        verbose_name="Photo",
                    ),
                ),
                (
                    "created_at",
                    models.DateTimeField(
                        auto_now_add=True, verbose_name="Date de création"
                    ),
                ),
            ],
            options={
                "verbose_name": "Événement de suivi",
                "verbose_name_plural": "Événements de suivi",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="TransportProposal",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "proposed_price",
                    models.DecimalField(
                        decimal_places=2,
                        max_digits=10,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Prix proposé",
                    ),
                ),
                ("message", models.TextField(blank=True, verbose_name="Message")),
                (
                    "estimated_pickup_date",
                    models.DateField(
                        blank=True,
                        null=True,
                        verbose_name="Date de prise en charge estimée",
                    ),
                ),
                (
                    "estimated_delivery_date",
                    models.DateField(
                        blank=True, null=True, verbose_name="Date de livraison estimée"
                    ),
                ),
                (
                    "includes_insurance",
                    models.BooleanField(
                        default=False, verbose_name="Assurance incluse"
                    ),
                ),
                (
                    "insurance_value",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Valeur assurée",
                    ),
                ),
                (
                    "includes_packaging",
                    models.BooleanField(default=False, verbose_name="Emballage inclus"),
                ),
                (
                    "includes_loading",
                    models.BooleanField(
                        default=False, verbose_name="Chargement inclus"
                    ),
                ),
                (
                    "includes_unloading",
                    models.BooleanField(
                        default=False, verbose_name="Déchargement inclus"
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("ACCEPTED", "Acceptée"),
                            ("REJECTED", "Rejetée"),
                            ("EXPIRED", "Expirée"),
                            ("CANCELLED", "Annulée"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "created_at",
                    models.DateTimeField(
                        auto_now_add=True, verbose_name="Date de création"
                    ),
                ),
                ("expires_at", models.DateTimeField(verbose_name="Date d'expiration")),
                (
                    "responded_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Date de réponse"
                    ),
                ),
                (
                    "response_message",
                    models.TextField(blank=True, verbose_name="Message de réponse"),
                ),
            ],
            options={
                "verbose_name": "Proposition de transport",
                "verbose_name_plural": "Propositions de transport",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="Mission",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("SCHEDULED", "Planifiée"),
                            ("PICKUP_PENDING", "En attente de prise en charge"),
                            ("PICKED_UP", "Pris en charge"),
                            ("IN_TRANSIT", "En transit"),
                            ("AT_HUB", "Au centre de tri"),
                            ("OUT_FOR_DELIVERY", "En cours de livraison"),
                            ("DELIVERY_PENDING", "En attente de livraison"),
                            ("DELIVERED", "Livrée"),
                            ("CANCELLED", "Annulée"),
                            ("DELAYED", "Retardée"),
                        ],
                        default="SCHEDULED",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "current_location",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Localisation actuelle"
                    ),
                ),
                (
                    "latitude",
                    models.FloatField(blank=True, null=True, verbose_name="Latitude"),
                ),
                (
                    "longitude",
                    models.FloatField(blank=True, null=True, verbose_name="Longitude"),
                ),
                (
                    "scheduled_pickup",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Prise en charge planifiée"
                    ),
                ),
                (
                    "actual_pickup",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Prise en charge réelle"
                    ),
                ),
                (
                    "estimated_delivery",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Livraison estimée"
                    ),
                ),
                (
                    "actual_delivery",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Livraison réelle"
                    ),
                ),
                (
                    "distance_km",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Distance (km)",
                    ),
                ),
                (
                    "pickup_confirmation",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="missions/pickup_confirmations/",
                        verbose_name="Confirmation prise en charge",
                    ),
                ),
                (
                    "delivery_confirmation",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="missions/delivery_confirmations/",
                        verbose_name="Confirmation livraison",
                    ),
                ),
                ("notes", models.TextField(blank=True, verbose_name="Notes")),
                (
                    "delay_reason",
                    models.TextField(blank=True, verbose_name="Raison du retard"),
                ),
                (
                    "created_at",
                    models.DateTimeField(
                        auto_now_add=True, verbose_name="Date de création"
                    ),
                ),
                (
                    "updated_at",
                    models.DateTimeField(
                        auto_now=True, verbose_name="Date de modification"
                    ),
                ),
                (
                    "carrier",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="missions",
                        to="carriers.carrier",
                        verbose_name="Transporteur",
                    ),
                ),
            ],
            options={
                "verbose_name": "Mission",
                "verbose_name_plural": "Missions",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="Reservation",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "logistics_option",
                    models.CharField(
                        choices=[
                            ("P2P_DIRECT", "Direct entre particuliers"),
                            ("WITH_CARRIER", "Avec transporteur"),
                            ("WITH_EXPAT_CARRIER", "Avec expatrié-transporteur"),
                        ],
                        max_length=20,
                        verbose_name="Option logistique",
                    ),
                ),
                (
                    "pickup_address",
                    models.TextField(
                        blank=True, verbose_name="Adresse de prise en charge"
                    ),
                ),
                (
                    "delivery_address",
                    models.TextField(blank=True, verbose_name="Adresse de livraison"),
                ),
                (
                    "pickup_date",
                    models.DateField(
                        blank=True, null=True, verbose_name="Date de prise en charge"
                    ),
                ),
                (
                    "delivery_date",
                    models.DateField(
                        blank=True, null=True, verbose_name="Date de livraison estimée"
                    ),
                ),
                (
                    "actual_delivery_date",
                    models.DateField(
                        blank=True, null=True, verbose_name="Date de livraison réelle"
                    ),
                ),
                (
                    "price_agreed",
                    models.DecimalField(
                        decimal_places=2,
                        max_digits=10,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Prix convenu",
                    ),
                ),
                (
                    "shipping_cost",
                    models.DecimalField(
                        decimal_places=2,
                        default=0,
                        max_digits=10,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Coût du transport",
                    ),
                ),
                (
                    "insurance_cost",
                    models.DecimalField(
                        decimal_places=2,
                        default=0,
                        max_digits=10,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Coût assurance",
                    ),
                ),
                (
                    "total_price",
                    models.DecimalField(
                        decimal_places=2,
                        max_digits=10,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Prix total",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("CONFIRMED", "Confirmée"),
                            ("PAYMENT_PENDING", "Paiement en attente"),
                            ("PAID", "Payée"),
                            ("IN_TRANSIT", "En transit"),
                            ("DELIVERED", "Livrée"),
                            ("CANCELLED", "Annulée"),
                            ("DISPUTED", "En litige"),
                            ("REFUNDED", "Remboursée"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "tracking_number",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Numéro de suivi"
                    ),
                ),
                ("is_paid", models.BooleanField(default=False, verbose_name="Payé")),
                (
                    "payment_method",
                    models.CharField(
                        blank=True, max_length=50, verbose_name="Méthode de paiement"
                    ),
                ),
                (
                    "payment_date",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Date de paiement"
                    ),
                ),
                (
                    "payment_reference",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Référence paiement"
                    ),
                ),
                (
                    "requires_insurance",
                    models.BooleanField(
                        default=False, verbose_name="Assurance requise"
                    ),
                ),
                (
                    "insurance_value",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        validators=[django.core.validators.MinValueValidator(0)],
                        verbose_name="Valeur assurée",
                    ),
                ),
                (
                    "requires_packaging",
                    models.BooleanField(default=False, verbose_name="Emballage requis"),
                ),
                (
                    "packaging_details",
                    models.TextField(blank=True, verbose_name="Détails emballage"),
                ),
                (
                    "buyer_notes",
                    models.TextField(blank=True, verbose_name="Notes acheteur"),
                ),
                (
                    "seller_notes",
                    models.TextField(blank=True, verbose_name="Notes vendeur"),
                ),
                (
                    "carrier_notes",
                    models.TextField(blank=True, verbose_name="Notes transporteur"),
                ),
                (
                    "created_at",
                    models.DateTimeField(
                        auto_now_add=True, verbose_name="Date de création"
                    ),
                ),
                (
                    "updated_at",
                    models.DateTimeField(
                        auto_now=True, verbose_name="Date de modification"
                    ),
                ),
                (
                    "cancelled_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Date d'annulation"
                    ),
                ),
                (
                    "cancellation_reason",
                    models.TextField(blank=True, verbose_name="Raison annulation"),
                ),
                (
                    "ad",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="reservations",
                        to="ads.ad",
                        verbose_name="Annonce",
                    ),
                ),
            ],
            options={
                "verbose_name": "Réservation",
                "verbose_name_plural": "Réservations",
                "ordering": ["-created_at"],
            },
        ),
    ]



========== logistics/migrations/__init__.py ==========



========== logistics/tests.py ==========
from django.test import TestCase

# Create your tests here.



========== logistics/signals.py ==========
# ~/ebi3/logistics/signals.py

from django.db.models.signals import (
    post_save, pre_save, post_delete, m2m_changed, pre_delete
)
from django.dispatch import receiver
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from django.db import transaction
from django.core.cache import cache

from .models import (
    Reservation, Mission, Route, TransportProposal, TrackingEvent,
    LogisticsSettings, ReservationStatus, MissionStatus, RouteStatus,
    TransportProposalStatus, LogisticsOption
)
from ads.models import Ad
from carriers.models import CarrierProfile
from users.models import User, Notification
from core.models import ActivityLog
from messaging.models import Conversation, Message


# ============================================================================
# SIGNALS POUR LES RÉSERVATIONS
# ============================================================================

@receiver(pre_save, sender=Reservation)
def reservation_pre_save(sender, instance, **kwargs):
    """
    Avant de sauvegarder une réservation
    """
    # Calculer le prix total si nécessaire
    if not instance.total_price or instance.pk is None:
        instance.total_price = (
            (instance.price_agreed or 0) +
            (instance.shipping_cost or 0) +
            (instance.insurance_cost or 0)
        )

    # Si c'est une nouvelle réservation, vérifier que l'annonce peut être réservée
    if instance.pk is None:
        if not instance.ad.can_be_reserved:
            raise ValueError(_("Cette annonce n'est pas disponible pour réservation."))

        # Marquer l'annonce comme réservée
        instance.ad.is_reserved = True
        instance.ad.save(update_fields=['is_reserved', 'updated_at'])

    # Si la réservation est annulée, marquer l'annonce comme disponible
    if instance.pk and instance.status == ReservationStatus.CANCELLED:
        old_instance = Reservation.objects.get(pk=instance.pk)
        if old_instance.status != ReservationStatus.CANCELLED:
            instance.ad.is_reserved = False
            instance.ad.save(update_fields=['is_reserved', 'updated_at'])
            instance.cancelled_at = timezone.now()


@receiver(post_save, sender=Reservation)
def reservation_post_save(sender, instance, created, **kwargs):
    """
    Après avoir sauvegardé une réservation
    """
    if created:
        # Créer un log d'activité
        ActivityLog.objects.create(
            user=instance.buyer,
            action_type='RESERVATION_CREATED',
            object_id=instance.id,
            details={
                'ad_id': instance.ad.id,
                'ad_title': instance.ad.title,
                'logistics_option': instance.logistics_option,
                'total_price': str(instance.total_price)
            }
        )

        # Mettre à jour les statistiques du vendeur
        if hasattr(instance.ad.seller, 'profile'):
            profile = instance.ad.seller.profile
            profile.total_reservations = (profile.total_reservations or 0) + 1
            profile.save(update_fields=['total_reservations', 'updated_at'])

        # Invalider le cache des annonces
        cache_keys = [
            f'ad_{instance.ad.id}_details',
            f'user_{instance.buyer.id}_reservations',
            f'user_{instance.ad.seller.id}_seller_stats'
        ]
        for key in cache_keys:
            cache.delete(key)

    # Si le statut a changé
    if instance.pk and not created:
        old_instance = Reservation.objects.get(pk=instance.pk)
        if old_instance.status != instance.status:
            # Créer un log d'activité pour le changement de statut
            ActivityLog.objects.create(
                user=instance.buyer,
                action_type='RESERVATION_STATUS_CHANGED',
                object_id=instance.id,
                details={
                    'old_status': old_instance.status,
                    'new_status': instance.status,
                    'ad_id': instance.ad.id
                }
            )

            # Si la réservation est passée en transit et a un transporteur, créer une mission
            if (instance.status == ReservationStatus.IN_TRANSIT and
                instance.carrier and
                not hasattr(instance, 'mission')):

                Mission.objects.create(
                    reservation=instance,
                    carrier=instance.carrier,
                    status=MissionStatus.IN_TRANSIT,
                    estimated_delivery=instance.delivery_date
                )

            # Si la réservation est livrée, mettre à jour les statistiques
            if instance.status == ReservationStatus.DELIVERED:
                # Mettre à jour le nombre de transactions réussies
                if hasattr(instance.ad.seller, 'profile'):
                    profile = instance.ad.seller.profile
                    profile.successful_transactions = (profile.successful_transactions or 0) + 1
                    profile.save(update_fields=['successful_transactions', 'updated_at'])

                # Mettre à jour les statistiques du transporteur
                if instance.carrier and hasattr(instance.carrier, 'completed_missions'):
                    instance.carrier.completed_missions = (instance.carrier.completed_missions or 0) + 1
                    instance.carrier.save(update_fields=['completed_missions', 'updated_at'])


@receiver(pre_delete, sender=Reservation)
def reservation_pre_delete(sender, instance, **kwargs):
    """
    Avant de supprimer une réservation
    """
    # Marquer l'annonce comme disponible
    instance.ad.is_reserved = False
    instance.ad.save(update_fields=['is_reserved', 'updated_at'])

    # Créer un log d'activité
    ActivityLog.objects.create(
        user=instance.buyer,
        action_type='RESERVATION_DELETED',
        object_id=instance.id,
        details={
            'ad_id': instance.ad.id,
            'ad_title': instance.ad.title,
            'status': instance.status
        }
    )


# ============================================================================
# SIGNALS POUR LES MISSIONS
# ============================================================================

@receiver(pre_save, sender=Mission)
def mission_pre_save(sender, instance, **kwargs):
    """
    Avant de sauvegarder une mission
    """
    # Si la mission est marquée comme livrée, définir la date de livraison
    if instance.status == MissionStatus.DELIVERED and not instance.actual_delivery:
        instance.actual_delivery = timezone.now()

    # Si la mission est retardée et qu'il n'y a pas de raison
    if instance.status == MissionStatus.DELAYED and not instance.delay_reason:
        instance.delay_reason = _("Raison non spécifiée")


@receiver(post_save, sender=Mission)
def mission_post_save(sender, instance, created, **kwargs):
    """
    Après avoir sauvegardé une mission
    """
    if created:
        # Créer un log d'activité
        ActivityLog.objects.create(
            user=instance.carrier.user,
            action_type='MISSION_CREATED',
            object_id=instance.id,
            details={
                'reservation_id': instance.reservation.id,
                'ad_title': instance.reservation.ad.title,
                'status': instance.status
            }
        )

        # Créer une conversation entre les parties
        create_mission_conversation(instance)

    # Si le statut a changé
    if instance.pk and not created:
        old_instance = Mission.objects.get(pk=instance.pk)
        if old_instance.status != instance.status:
            # Créer un log d'activité
            ActivityLog.objects.create(
                user=instance.carrier.user,
                action_type='MISSION_STATUS_CHANGED',
                object_id=instance.id,
                details={
                    'old_status': old_instance.status,
                    'new_status': instance.status
                }
            )

            # Si la mission est livrée, mettre à jour la réservation
            if instance.status == MissionStatus.DELIVERED:
                reservation = instance.reservation
                reservation.status = ReservationStatus.DELIVERED
                reservation.actual_delivery_date = timezone.now().date()
                reservation.save()

                # Notifier l'acheteur et le vendeur
                create_delivery_notifications(reservation)


def create_mission_conversation(mission):
    """
    Créer une conversation pour une mission
    """
    try:
        # Participants : acheteur, vendeur, transporteur
        participants = [
            mission.reservation.buyer,
            mission.reservation.ad.seller,
            mission.carrier.user
        ]

        # Créer ou récupérer la conversation
        conversation, created = Conversation.objects.get_or_create(
            subject=f"Mission #{mission.id} - {mission.reservation.ad.title}",
            defaults={
                'created_by': mission.carrier.user
            }
        )

        if created:
            conversation.participants.set(participants)

            # Message d'introduction
            Message.objects.create(
                conversation=conversation,
                sender=mission.carrier.user,
                content=_(
                    "Bonjour,\n\n"
                    "Je suis votre transporteur pour l'objet '{}'. "
                    "N'hésitez pas à utiliser cette conversation pour coordonner "
                    "la logistique et poser vos questions.\n\n"
                    "Statut actuel : {}\n"
                    "Livraison estimée : {}"
                ).format(
                    mission.reservation.ad.title,
                    mission.get_status_display(),
                    mission.estimated_delivery.strftime('%d/%m/%Y') if mission.estimated_delivery else _('À définir')
                )
            )
    except Exception as e:
        # Log l'erreur mais ne pas bloquer
        import logging
        logger = logging.getLogger(__name__)
        logger.error(f"Erreur création conversation mission: {e}")


def create_delivery_notifications(reservation):
    """
    Créer des notifications pour une livraison
    """
    # Notification à l'acheteur
    Notification.objects.create(
        user=reservation.buyer,
        title=_("Livraison effectuée"),
        message=_("Votre objet '{}' a été livré avec succès !").format(reservation.ad.title),
        url=reservation.get_absolute_url(),
        notification_type='DELIVERY_COMPLETED',
        priority='HIGH'
    )

    # Notification au vendeur
    Notification.objects.create(
        user=reservation.ad.seller,
        title=_("Livraison effectuée"),
        message=_("L'objet '{}' a été livré à l'acheteur.").format(reservation.ad.title),
        url=reservation.get_absolute_url(),
        notification_type='DELIVERY_COMPLETED',
        priority='HIGH'
    )


# ============================================================================
# SIGNALS POUR LES ÉVÉNEMENTS DE SUIVI
# ============================================================================

@receiver(post_save, sender=TrackingEvent)
def tracking_event_post_save(sender, instance, created, **kwargs):
    """
    Après avoir sauvegardé un événement de suivi
    """
    if created:
        # Mettre à jour la localisation de la mission si nécessaire
        if instance.location and instance.mission.current_location != instance.location:
            instance.mission.current_location = instance.location
            instance.mission.save(update_fields=['current_location', 'updated_at'])

        # Créer un log d'activité
        ActivityLog.objects.create(
            user=instance.created_by,
            action_type='TRACKING_EVENT_CREATED',
            object_id=instance.id,
            details={
                'mission_id': instance.mission.id,
                'event_type': instance.event_type,
                'location': instance.location
            }
        )

        # Notifier l'acheteur
        if instance.mission.reservation.buyer != instance.created_by:
            Notification.objects.create(
                user=instance.mission.reservation.buyer,
                title=_("Mise à jour de suivi"),
                message=_("Nouvel événement : {} - {}").format(
                    instance.get_event_type_display(),
                    instance.description[:100]
                ),
                url=instance.mission.get_absolute_url(),
                notification_type='TRACKING_UPDATED'
            )

        # Notifier le vendeur
        if instance.mission.reservation.ad.seller != instance.created_by:
            Notification.objects.create(
                user=instance.mission.reservation.ad.seller,
                title=_("Mise à jour de suivi"),
                message=_("Nouvel événement : {}").format(instance.get_event_type_display()),
                url=instance.mission.get_absolute_url(),
                notification_type='TRACKING_UPDATED'
            )


# ============================================================================
# SIGNALS POUR LES ROUTES
# ============================================================================

@receiver(pre_save, sender=Route)
def route_pre_save(sender, instance, **kwargs):
    """
    Avant de sauvegarder une route
    """
    # Vérifier que les dates sont valides
    if instance.arrival_date < instance.departure_date:
        raise ValueError(_("La date d'arrivée doit être après la date de départ."))

    # Vérifier les capacités
    if instance.available_weight > instance.max_weight:
        raise ValueError(_("Le poids disponible ne peut pas dépasser le poids maximum."))

    if instance.available_volume > instance.max_volume:
        raise ValueError(_("Le volume disponible ne peut pas dépasser le volume maximum."))

    # Mettre à jour le statut si la route est complète
    if instance.available_weight == 0 and instance.available_volume == 0:
        instance.status = RouteStatus.FULL
    elif instance.status == RouteStatus.FULL and (instance.available_weight > 0 or instance.available_volume > 0):
        instance.status = RouteStatus.ACTIVE


@receiver(post_save, sender=Route)
def route_post_save(sender, instance, created, **kwargs):
    """
    Après avoir sauvegardé une route
    """
    if created:
        # Créer un log d'activité
        ActivityLog.objects.create(
            user=instance.carrier.user,
            action_type='ROUTE_CREATED',
            object_id=instance.id,
            details={
                'route': f"{instance.start_city} → {instance.end_city}",
                'departure_date': instance.departure_date.strftime('%d/%m/%Y'),
                'capacity': f"{instance.available_weight}kg / {instance.available_volume}m³"
            }
        )

        # Invalider le cache des routes
        cache.delete('available_routes_list')
        cache.delete(f'carrier_{instance.carrier.id}_routes')

    # Si le statut a changé
    if instance.pk and not created:
        old_instance = Route.objects.get(pk=instance.pk)
        if old_instance.status != instance.status:
            ActivityLog.objects.create(
                user=instance.carrier.user,
                action_type='ROUTE_STATUS_CHANGED',
                object_id=instance.id,
                details={
                    'old_status': old_instance.status,
                    'new_status': instance.status
                }
            )


@receiver(m2m_changed, sender=Route.carrier.through)
def route_carrier_changed(sender, instance, action, **kwargs):
    """
    Quand un transporteur est ajouté ou retiré d'une route
    """
    if action in ['post_add', 'post_remove']:
        # Invalider le cache
        cache.delete('available_routes_list')
        if hasattr(instance, 'carrier'):
            cache.delete(f'carrier_{instance.carrier.id}_routes')


# ============================================================================
# SIGNALS POUR LES PROPOSITIONS DE TRANSPORT
# ============================================================================

@receiver(pre_save, sender=TransportProposal)
def transport_proposal_pre_save(sender, instance, **kwargs):
    """
    Avant de sauvegarder une proposition de transport
    """
    # Définir la date d'expiration par défaut
    if not instance.expires_at:
        settings = LogisticsSettings.load()
        instance.expires_at = timezone.now() + timezone.timedelta(days=settings.proposal_expiry_days)

    # Vérifier que la proposition n'est pas expirée
    if instance.expires_at and timezone.now() > instance.expires_at:
        instance.status = TransportProposalStatus.EXPIRED

    # Vérifier que le transporteur a les capacités nécessaires
    if instance.ad and instance.carrier:
        if instance.ad.weight and instance.carrier.max_weight < instance.ad.weight:
            raise ValueError(_("Le transporteur n'a pas la capacité nécessaire pour cet objet."))

        if hasattr(instance.ad, 'volume') and instance.ad.volume and instance.carrier.max_volume < instance.ad.volume:
            raise ValueError(_("Le transporteur n'a pas le volume nécessaire pour cet objet."))


@receiver(post_save, sender=TransportProposal)
def transport_proposal_post_save(sender, instance, created, **kwargs):
    """
    Après avoir sauvegardé une proposition de transport
    """
    if created:
        # Créer un log d'activité
        ActivityLog.objects.create(
            user=instance.carrier.user,
            action_type='PROPOSAL_CREATED',
            object_id=instance.id,
            details={
                'ad_id': instance.ad.id,
                'ad_title': instance.ad.title,
                'proposed_price': str(instance.proposed_price)
            }
        )

        # Notifier le vendeur
        Notification.objects.create(
            user=instance.ad.seller,
            title=_("Nouvelle proposition de transport"),
            message=_("{} a fait une proposition pour votre annonce '{}'.").format(
                instance.carrier.user.username,
                instance.ad.title[:50]
            ),
            url=instance.get_absolute_url(),
            notification_type='PROPOSAL_RECEIVED',
            priority='MEDIUM'
        )

    # Si le statut a changé
    if instance.pk and not created:
        old_instance = TransportProposal.objects.get(pk=instance.pk)
        if old_instance.status != instance.status:
            ActivityLog.objects.create(
                user=instance.ad.seller if instance.status == 'ACCEPTED' else instance.carrier.user,
                action_type='PROPOSAL_STATUS_CHANGED',
                object_id=instance.id,
                details={
                    'old_status': old_instance.status,
                    'new_status': instance.status
                }
            )

            # Si la proposition est acceptée, créer une réservation
            if instance.status == TransportProposalStatus.ACCEPTED:
                create_reservation_from_proposal(instance)


def create_reservation_from_proposal(proposal):
    """
    Créer une réservation à partir d'une proposition acceptée
    """
    try:
        with transaction.atomic():
            reservation = Reservation.objects.create(
                ad=proposal.ad,
                buyer=None,  # L'acheteur sera défini plus tard
                carrier=proposal.carrier,
                logistics_option=LogisticsOption.WITH_CARRIER,
                price_agreed=proposal.ad.price,
                shipping_cost=proposal.proposed_price,
                total_price=proposal.ad.price + proposal.proposed_price,
                requires_insurance=proposal.includes_insurance,
                insurance_value=proposal.insurance_value,
                requires_packaging=proposal.includes_packaging,
                pickup_date=proposal.estimated_pickup_date,
                delivery_date=proposal.estimated_delivery_date,
                status=ReservationStatus.PENDING,
                buyer_notes=_("Proposition acceptée automatiquement")
            )

            # Notifier le transporteur
            Notification.objects.create(
                user=proposal.carrier.user,
                title=_("Proposition acceptée !"),
                message=_("Votre proposition pour '{}' a été acceptée. Une réservation a été créée.").format(
                    proposal.ad.title
                ),
                url=reservation.get_absolute_url(),
                notification_type='PROPOSAL_ACCEPTED',
                priority='HIGH'
            )

            return reservation
    except Exception as e:
        # Log l'erreur
        import logging
        logger = logging.getLogger(__name__)
        logger.error(f"Erreur création réservation depuis proposition: {e}")
        raise


# ============================================================================
# SIGNALS POUR LES INTERACTIONS AVEC D'AUTRES APPS
# ============================================================================

@receiver(post_save, sender=Ad)
def ad_post_save(sender, instance, created, **kwargs):
    """
    Quand une annonce est sauvegardée
    """
    # Si l'annonce est marquée comme réservée mais n'a pas de réservation active
    if instance.is_reserved and not instance.reservations.filter(
        status__in=['PENDING', 'CONFIRMED', 'PAID', 'IN_TRANSIT']
    ).exists():
        instance.is_reserved = False
        instance.save(update_fields=['is_reserved', 'updated_at'])


@receiver(post_save, sender=CarrierProfile)
def carrier_profile_post_save(sender, instance, created, **kwargs):
    """
    Quand un profil transporteur est sauvegardé
    """
    if created:
        # Ajouter le rôle transporteur à l'utilisateur
        if instance.user.role != 'CARRIER':
            instance.user.role = 'CARRIER'
            instance.user.save(update_fields=['role', 'updated_at'])

        # Créer un log d'activité
        ActivityLog.objects.create(
            user=instance.user,
            action_type='CARRIER_PROFILE_CREATED',
            object_id=instance.id,
            details={
                'company_name': instance.company_name,
                'carrier_type': instance.carrier_type
            }
        )


@receiver(pre_delete, sender=CarrierProfile)
def carrier_profile_pre_delete(sender, instance, **kwargs):
    """
    Avant de supprimer un profil transporteur
    """
    # Annuler toutes les missions actives
    active_missions = instance.missions.filter(
        status__in=['SCHEDULED', 'PICKUP_PENDING', 'PICKED_UP', 'IN_TRANSIT', 'OUT_FOR_DELIVERY']
    )

    for mission in active_missions:
        mission.status = MissionStatus.CANCELLED
        mission.save()

        # Annuler la réservation associée
        reservation = mission.reservation
        reservation.status = ReservationStatus.CANCELLED
        reservation.cancelled_at = timezone.now()
        reservation.save()

        # Notifier les parties
        Notification.objects.create(
            user=reservation.buyer,
            title=_("Mission annulée"),
            message=_("La mission pour '{}' a été annulée car le transporteur a supprimé son compte.").format(
                reservation.ad.title
            ),
            url=reservation.ad.get_absolute_url(),
            notification_type='MISSION_CANCELLED'
        )


# ============================================================================
# SIGNALS POUR LES TÂCHES AUTOMATIQUES
# ============================================================================

@receiver(pre_save, sender=Reservation)
def check_reservation_expiry(sender, instance, **kwargs):
    """
    Vérifier l'expiration des réservations
    """
    if instance.status == ReservationStatus.PENDING:
        settings = LogisticsSettings.load()
        expiry_hours = settings.reservation_expiry_hours

        if instance.created_at and (timezone.now() - instance.created_at).total_seconds() > expiry_hours * 3600:
            instance.status = ReservationStatus.CANCELLED
            instance.cancelled_at = timezone.now()
            instance.cancellation_reason = _("Expiration automatique")

            # Marquer l'annonce comme disponible
            instance.ad.is_reserved = False
            instance.ad.save(update_fields=['is_reserved', 'updated_at'])

            # Notifier l'acheteur
            Notification.objects.create(
                user=instance.buyer,
                title=_("Réservation expirée"),
                message=_("Votre réservation pour '{}' a expiré automatiquement.").format(
                    instance.ad.title
                ),
                url=instance.ad.get_absolute_url(),
                notification_type='RESERVATION_EXPIRED'
            )


@receiver(pre_save, sender=TransportProposal)
def check_proposal_expiry(sender, instance, **kwargs):
    """
    Vérifier l'expiration des propositions
    """
    if instance.status == TransportProposalStatus.PENDING and instance.expires_at:
        if timezone.now() > instance.expires_at:
            instance.status = TransportProposalStatus.EXPIRED

            # Notifier le transporteur
            Notification.objects.create(
                user=instance.carrier.user,
                title=_("Proposition expirée"),
                message=_("Votre proposition pour '{}' a expiré.").format(
                    instance.ad.title
                ),
                url=instance.ad.get_absolute_url(),
                notification_type='PROPOSAL_EXPIRED'
            )


# ============================================================================
# SIGNALS POUR LES STATISTIQUES ET CACHE
# ============================================================================

@receiver(post_save, sender=Reservation)
@receiver(post_delete, sender=Reservation)
def update_reservation_stats(sender, instance, **kwargs):
    """
    Mettre à jour les statistiques des réservations
    """
    # Mettre à jour le cache des statistiques du vendeur
    if hasattr(instance.ad.seller, 'profile'):
        cache_key = f'user_{instance.ad.seller.id}_seller_stats'
        cache.delete(cache_key)

    # Mettre à jour le cache des statistiques de l'acheteur
    cache_key = f'user_{instance.buyer.id}_buyer_stats'
    cache.delete(cache_key)

    # Mettre à jour le cache global
    cache.delete('global_reservation_stats')


@receiver(post_save, sender=Mission)
@receiver(post_delete, sender=Mission)
def update_mission_stats(sender, instance, **kwargs):
    """
    Mettre à jour les statistiques des missions
    """
    # Mettre à jour les statistiques du transporteur
    if instance.carrier:
        # Recalculer le taux de réussite
        total_missions = instance.carrier.missions.count()
        completed_missions = instance.carrier.missions.filter(status='DELIVERED').count()

        if total_missions > 0:
            instance.carrier.success_rate = (completed_missions / total_missions) * 100
            instance.carrier.save(update_fields=['success_rate', 'updated_at'])

        # Invalider le cache
        cache.delete(f'carrier_{instance.carrier.id}_stats')


# ============================================================================
# FONCTIONS UTILITAIRES
# ============================================================================

def create_reservation_notification(reservation, notification_type, recipient=None):
    """
    Créer une notification pour une réservation
    """
    if not recipient:
        recipient = reservation.ad.seller

    notification_map = {
        'CREATED': {
            'title': _("Nouvelle réservation"),
            'message': _("Votre annonce '{}' a été réservée par {}.").format(
                reservation.ad.title, reservation.buyer.username
            )
        },
        'CANCELLED': {
            'title': _("Réservation annulée"),
            'message': _("La réservation pour '{}' a été annulée.").format(
                reservation.ad.title
            )
        },
        'STATUS_CHANGED': {
            'title': _("Statut mis à jour"),
            'message': _("Le statut de la réservation pour '{}' est maintenant '{}'.").format(
                reservation.ad.title, reservation.get_status_display()
            )
        }
    }

    if notification_type in notification_map:
        Notification.objects.create(
            user=recipient,
            title=notification_map[notification_type]['title'],
            message=notification_map[notification_type]['message'],
            url=reservation.get_absolute_url(),
            notification_type=f'RESERVATION_{notification_type}'
        )


# ============================================================================
# CONNEXION DES SIGNALS
# ============================================================================

def connect_signals():
    """
    Connecter tous les signaux
    """
    # Les signaux sont automatiquement connectés via les décorateurs @receiver
    pass


def disconnect_signals():
    """
    Déconnecter tous les signaux (pour les tests)
    """
    from django.db.models import signals

    # Déconnecter tous les signaux de logistics
    signals.pre_save.disconnect(reservation_pre_save, sender=Reservation)
    signals.post_save.disconnect(reservation_post_save, sender=Reservation)
    signals.pre_delete.disconnect(reservation_pre_delete, sender=Reservation)

    signals.pre_save.disconnect(mission_pre_save, sender=Mission)
    signals.post_save.disconnect(mission_post_save, sender=Mission)

    signals.post_save.disconnect(tracking_event_post_save, sender=TrackingEvent)

    signals.pre_save.disconnect(route_pre_save, sender=Route)
    signals.post_save.disconnect(route_post_save, sender=Route)

    signals.pre_save.disconnect(transport_proposal_pre_save, sender=TransportProposal)
    signals.post_save.disconnect(transport_proposal_post_save, sender=TransportProposal)

    signals.post_save.disconnect(ad_post_save, sender=Ad)
    signals.post_save.disconnect(carrier_profile_post_save, sender=CarrierProfile)
    signals.pre_delete.disconnect(carrier_profile_pre_delete, sender=CarrierProfile)


# Import pour s'assurer que les signaux sont enregistrés
default_app_config = 'logistics.apps.LogisticsConfig'


========== logistics/admin.py ==========
# ~/ebi3/logistics/admin.py

from django.contrib import admin
from django.utils.translation import gettext_lazy as _
from django.utils.html import format_html
from django.urls import reverse
from django.contrib.admin import DateFieldListFilter
from django.utils import timezone

from .models import (
    Reservation, Mission, Route, TransportProposal, TrackingEvent,
    LogisticsSettings, LogisticsOption, ReservationStatus, MissionStatus,
    RouteStatus, TransportProposalStatus
)


class StatusFilter(admin.SimpleListFilter):
    """Filtre personnalisé pour les statuts"""
    title = _('Statut')
    parameter_name = 'status'

    def lookups(self, request, model_admin):
        return model_admin.model.STATUS_CHOICES

    def queryset(self, request, queryset):
        if self.value():
            return queryset.filter(status=self.value())
        return queryset


class CreatedAtFilter(admin.SimpleListFilter):
    """Filtre par date de création"""
    title = _('Date de création')
    parameter_name = 'created_at'

    def lookups(self, request, model_admin):
        return [
            ('today', _('Aujourd\'hui')),
            ('this_week', _('Cette semaine')),
            ('this_month', _('Ce mois')),
            ('last_month', _('Le mois dernier')),
        ]

    def queryset(self, request, queryset):
        today = timezone.now().date()

        if self.value() == 'today':
            return queryset.filter(created_at__date=today)
        elif self.value() == 'this_week':
            week_start = today - timezone.timedelta(days=today.weekday())
            return queryset.filter(created_at__date__gte=week_start)
        elif self.value() == 'this_month':
            return queryset.filter(created_at__year=today.year, created_at__month=today.month)
        elif self.value() == 'last_month':
            last_month = today.replace(day=1) - timezone.timedelta(days=1)
            return queryset.filter(created_at__year=last_month.year, created_at__month=last_month.month)

        return queryset


class CarrierFilter(admin.SimpleListFilter):
    """Filtre par transporteur"""
    title = _('Transporteur')
    parameter_name = 'carrier'

    def lookups(self, request, model_admin):
        from carriers.models import Carrier
        carriers = Carrier.objects.all().select_related('user')
        return [(c.id, str(c)) for c in carriers]

    def queryset(self, request, queryset):
        if self.value():
            return queryset.filter(carrier_id=self.value())
        return queryset


class TrackingEventInline(admin.TabularInline):
    """Inline pour les événements de suivi"""
    model = TrackingEvent
    extra = 0
    readonly_fields = ['created_at', 'created_by']
    fields = ['event_type', 'description', 'location', 'photo', 'created_at', 'created_by']
    can_delete = True
    max_num = 10

    def has_add_permission(self, request, obj=None):
        return request.user.is_superuser

    def has_change_permission(self, request, obj=None):
        return request.user.is_superuser


@admin.register(Reservation)
class ReservationAdmin(admin.ModelAdmin):
    """Admin pour les réservations"""

    # ✅ CORRECTION: actions doit être une LISTE, pas une méthode
    actions = ['mark_as_paid', 'mark_as_delivered', 'cancel_reservations', 'export_to_csv']

    list_display = [
        'id', 'get_ad_title', 'get_buyer', 'get_seller', 'logistics_option',
        'status', 'total_price', 'created_at', 'is_paid', 'action_buttons'  # ✅ Changé de 'actions' à 'action_buttons'
    ]

    list_filter = [
        StatusFilter, CreatedAtFilter, 'logistics_option', 'is_paid',
        ('created_at', DateFieldListFilter), CarrierFilter
    ]

    search_fields = [
        'id', 'ad__title', 'buyer__username', 'ad__seller__username',
        'tracking_number', 'payment_reference'
    ]

    readonly_fields = [
        'created_at', 'updated_at', 'cancelled_at', 'cancelled_by',
        'payment_date', 'get_ad_link', 'get_buyer_link', 'get_carrier_link'
    ]

    fieldsets = (
        (_('Informations de base'), {
            'fields': (
                'get_ad_link', 'get_buyer_link', 'get_carrier_link',
                'logistics_option', 'status'
            )
        }),
        (_('Détails logistiques'), {
            'fields': (
                'pickup_address', 'delivery_address',
                'pickup_date', 'delivery_date', 'actual_delivery_date',
                'tracking_number'
            )
        }),
        (_('Prix et paiement'), {
            'fields': (
                'price_agreed', 'shipping_cost', 'insurance_cost', 'total_price',
                'is_paid', 'payment_method', 'payment_date', 'payment_reference'
            )
        }),
        (_('Assurance et emballage'), {
            'fields': (
                'requires_insurance', 'insurance_value',
                'requires_packaging', 'packaging_details'
            )
        }),
        (_('Notes'), {
            'fields': ('buyer_notes', 'seller_notes', 'carrier_notes')
        }),
        (_('Annulation'), {
            'fields': ('cancelled_at', 'cancelled_by', 'cancellation_reason'),
            'classes': ('collapse',)
        }),
        (_('Métadonnées'), {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        queryset = queryset.select_related(
            'ad', 'ad__seller', 'buyer', 'carrier', 'carrier__user'
        )
        return queryset

    def get_ad_title(self, obj):
        return obj.ad.title[:50] + '...' if len(obj.ad.title) > 50 else obj.ad.title
    get_ad_title.short_description = _('Annonce')
    get_ad_title.admin_order_field = 'ad__title'

    def get_buyer(self, obj):
        return obj.buyer.username
    get_buyer.short_description = _('Acheteur')
    get_buyer.admin_order_field = 'buyer__username'

    def get_seller(self, obj):
        return obj.ad.seller.username
    get_seller.short_description = _('Vendeur')
    get_seller.admin_order_field = 'ad__seller__username'

    def get_ad_link(self, obj):
        url = reverse('admin:ads_ad_change', args=[obj.ad.id])
        return format_html('<a href="{}">{}</a>', url, obj.ad.title)
    get_ad_link.short_description = _('Annonce')

    def get_buyer_link(self, obj):
        url = reverse('admin:users_user_change', args=[obj.buyer.id])
        return format_html('<a href="{}">{}</a>', url, obj.buyer.username)
    get_buyer_link.short_description = _('Acheteur')

    def get_carrier_link(self, obj):
        if obj.carrier:
            url = reverse('admin:carriers_carrier_change', args=[obj.carrier.id])
            return format_html('<a href="{}">{}</a>', url, str(obj.carrier))
        return '-'
    get_carrier_link.short_description = _('Transporteur')

    # ✅ CORRECTION: Renommer la méthode 'actions' en 'action_buttons'
    def action_buttons(self, obj):
        links = []

        # Lien vers la mission si elle existe
        if hasattr(obj, 'mission'):
            url = reverse('admin:logistics_mission_change', args=[obj.mission.id])
            links.append(format_html(
                '<a href="{}" class="button" style="background-color:#4CAF50;color:white;padding:2px 6px;border-radius:3px;text-decoration:none;">{}</a>',
                url, _('Mission')
            ))

        # Lien pour voir les détails
        url = reverse('admin:logistics_reservation_change', args=[obj.id])
        links.append(format_html(
            '<a href="{}" class="button" style="background-color:#2196F3;color:white;padding:2px 6px;border-radius:3px;text-decoration:none;">{}</a>',
            url, _('Éditer')
        ))

        return format_html(' '.join(links))
    action_buttons.short_description = _('Actions')  # ✅ Mettre à jour ici aussi

    def mark_as_paid(self, request, queryset):
        updated = queryset.filter(status__in=['PENDING', 'CONFIRMED', 'PAYMENT_PENDING']).update(
            status='PAID',
            is_paid=True,
            payment_date=timezone.now()
        )
        self.message_user(request, _('{} réservations marquées comme payées.').format(updated))
    mark_as_paid.short_description = _('Marquer comme payées')

    def mark_as_delivered(self, request, queryset):
        updated = queryset.filter(status='IN_TRANSIT').update(
            status='DELIVERED',
            actual_delivery_date=timezone.now().date()
        )
        self.message_user(request, _('{} réservations marquées comme livrées.').format(updated))
    mark_as_delivered.short_description = _('Marquer comme livrées')

    def cancel_reservations(self, request, queryset):
        updated = queryset.filter(status__in=['PENDING', 'CONFIRMED', 'PAYMENT_PENDING']).update(
            status='CANCELLED',
            cancelled_at=timezone.now(),
            cancelled_by=request.user
        )
        self.message_user(request, _('{} réservations annulées.').format(updated))
    cancel_reservations.short_description = _('Annuler les réservations')

    def export_to_csv(self, request, queryset):
        import csv
        from django.http import HttpResponse

        response = HttpResponse(content_type='text/csv')
        response['Content-Disposition'] = 'attachment; filename="reservations.csv"'

        writer = csv.writer(response)
        writer.writerow([
            _('ID'), _('Annonce'), _('Acheteur'), _('Vendeur'), _('Transporteur'),
            _('Option'), _('Statut'), _('Prix total'), _('Payé'), _('Date création')
        ])

        for obj in queryset.select_related('ad', 'ad__seller', 'buyer', 'carrier'):
            writer.writerow([
                obj.id,
                obj.ad.title,
                obj.buyer.username,
                obj.ad.seller.username,
                str(obj.carrier) if obj.carrier else '',
                obj.get_logistics_option_display(),
                obj.get_status_display(),
                obj.total_price,
                _('Oui') if obj.is_paid else _('Non'),
                obj.created_at.strftime('%d/%m/%Y %H:%M')
            ])

        return response
    export_to_csv.short_description = _('Exporter en CSV')

    class Media:
        css = {
            'all': ('css/admin-logistics.css',)
        }


@admin.register(Mission)
class MissionAdmin(admin.ModelAdmin):
    """Admin pour les missions"""

    actions = ['mark_as_delivered', 'mark_as_in_transit', 'update_locations']

    list_display = [
        'id', 'get_reservation', 'get_carrier', 'status', 'current_location',
        'estimated_delivery', 'progress_bar', 'created_at'
    ]

    list_filter = [
        StatusFilter, CreatedAtFilter, 'carrier__carrier_type',
        ('estimated_delivery', DateFieldListFilter)
    ]

    search_fields = [
        'id', 'reservation__ad__title', 'carrier__user__username',
        'current_location', 'tracking_number'
    ]

    readonly_fields = [
        'created_at', 'updated_at', 'get_reservation_link', 'get_carrier_link',
        'progress_percentage'
    ]

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('get_reservation_link', 'get_carrier_link', 'status')
        }),
        (_('Suivi'), {
            'fields': (
                'current_location', 'latitude', 'longitude',
                'distance_km'
            )
        }),
        (_('Dates'), {
            'fields': (
                'scheduled_pickup', 'actual_pickup',
                'estimated_delivery', 'actual_delivery'
            )
        }),
        (_('Documents'), {
            'fields': ('pickup_confirmation', 'delivery_confirmation')
        }),
        (_('Notes'), {
            'fields': ('notes', 'delay_reason')
        }),
        (_('Progression'), {
            'fields': ('progress_percentage',),
            'classes': ('wide',)
        }),
        (_('Métadonnées'), {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    inlines = [TrackingEventInline]

    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        queryset = queryset.select_related(
            'reservation', 'reservation__ad', 'carrier', 'carrier__user'
        )
        return queryset

    def get_reservation(self, obj):
        return f"Réservation #{obj.reservation.id}"
    get_reservation.short_description = _('Réservation')
    get_reservation.admin_order_field = 'reservation__id'

    def get_carrier(self, obj):
        return obj.carrier.user.username
    get_carrier.short_description = _('Transporteur')
    get_carrier.admin_order_field = 'carrier__user__username'

    def get_reservation_link(self, obj):
        url = reverse('admin:logistics_reservation_change', args=[obj.reservation.id])
        return format_html('<a href="{}">Réservation #{}</a>', url, obj.reservation.id)
    get_reservation_link.short_description = _('Réservation')

    def get_carrier_link(self, obj):
        url = reverse('admin:carriers_carrier_change', args=[obj.carrier.id])
        return format_html('<a href="{}">{}</a>', url, str(obj.carrier))
    get_carrier_link.short_description = _('Transporteur')

    def progress_bar(self, obj):
        percentage = obj.progress_percentage
        color = '#4CAF50'  # Vert
        if percentage < 30:
            color = '#F44336'  # Rouge
        elif percentage < 70:
            color = '#FFC107'  # Orange

        return format_html(
            '''
            <div style="background-color:#f0f0f0;border-radius:3px;height:20px;width:100px;position:relative;">
                <div style="background-color:{};border-radius:3px;height:100%;width:{}%;"></div>
                <div style="position:absolute;top:0;left:0;right:0;text-align:center;font-size:11px;line-height:20px;">
                    {}%
                </div>
            </div>
            ''',
            color, percentage, percentage
        )
    progress_bar.short_description = _('Progression')

    def mark_as_delivered(self, request, queryset):
        updated = queryset.filter(status__in=['OUT_FOR_DELIVERY', 'DELIVERY_PENDING']).update(
            status='DELIVERED',
            actual_delivery=timezone.now()
        )
        self.message_user(request, _('{} missions marquées comme livrées.').format(updated))
    mark_as_delivered.short_description = _('Marquer comme livrées')

    def mark_as_in_transit(self, request, queryset):
        updated = queryset.filter(status__in=['PICKED_UP', 'SCHEDULED']).update(
            status='IN_TRANSIT'
        )
        self.message_user(request, _('{} missions marquées comme en transit.').format(updated))
    mark_as_in_transit.short_description = _('Marquer comme en transit')

    def update_locations(self, request, queryset):
        # Action pour mettre à jour les localisations
        for mission in queryset:
            # Logique de mise à jour...
            pass
        self.message_user(request, _('Localisations mises à jour.'))
    update_locations.short_description = _('Mettre à jour les localisations')


@admin.register(Route)
class RouteAdmin(admin.ModelAdmin):
    """Admin pour les routes"""

    actions = ['mark_as_featured', 'mark_as_active', 'duplicate_routes']

    list_display = [
        'id', 'start_city', 'end_city', 'get_carrier', 'departure_date',
        'available_capacity', 'status', 'is_featured', 'created_at'
    ]

    list_filter = [
        StatusFilter, CreatedAtFilter, 'is_featured', 'carrier__carrier_type',
        ('departure_date', DateFieldListFilter), 'start_country', 'end_country'
    ]

    search_fields = [
        'start_city', 'end_city', 'carrier__user__username',
        'carrier__company_name', 'description'
    ]

    readonly_fields = [
        'created_at', 'updated_at', 'view_count', 'get_carrier_link',
        'calculate_utilization'
    ]

    fieldsets = (
        (_('Informations de base'), {
            'fields': (
                'get_carrier_link', 'status', 'is_featured'
            )
        }),
        (_('Itinéraire'), {
            'fields': (
                'start_city', 'start_country', 'start_address',
                'end_city', 'end_country', 'end_address'
            )
        }),
        (_('Dates'), {
            'fields': ('departure_date', 'arrival_date')
        }),
        (_('Capacités'), {
            'fields': (
                'max_weight', 'max_volume',
                'available_weight', 'available_volume'
            )
        }),
        (_('Prix'), {
            'fields': (
                'fixed_price', 'price_per_kg', 'price_per_m3'
            )
        }),
        (_('Services inclus'), {
            'fields': (
                'includes_insurance', 'includes_packaging',
                'includes_loading', 'includes_unloading'
            )
        }),
        (_('Description'), {
            'fields': ('description', 'special_conditions')
        }),
        (_('Statistiques'), {
            'fields': ('view_count', 'calculate_utilization'),
            'classes': ('wide',)
        }),
        (_('Métadonnées'), {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        queryset = queryset.select_related('carrier', 'carrier__user', 'start_country', 'end_country')
        return queryset

    def get_carrier(self, obj):
        return obj.carrier.user.username
    get_carrier.short_description = _('Transporteur')
    get_carrier.admin_order_field = 'carrier__user__username'

    def available_capacity(self, obj):
        weight_percent = (obj.available_weight / obj.max_weight * 100) if obj.max_weight > 0 else 0
        volume_percent = (obj.available_volume / obj.max_volume * 100) if obj.max_volume > 0 else 0

        return format_html(
            '<div style="white-space:nowrap;">'
            '<span style="color:#666;">Poids:</span> {}kg ({}%)<br>'
            '<span style="color:#666;">Volume:</span> {}m³ ({}%)'
            '</div>',
            obj.available_weight, round(weight_percent),
            obj.available_volume, round(volume_percent)
        )
    available_capacity.short_description = _('Capacité disponible')

    def get_carrier_link(self, obj):
        url = reverse('admin:carriers_carrier_change', args=[obj.carrier.id])
        return format_html('<a href="{}">{}</a>', url, str(obj.carrier))
    get_carrier_link.short_description = _('Transporteur')

    def calculate_utilization(self, obj):
        weight_utilization = 100 - ((obj.available_weight / obj.max_weight) * 100) if obj.max_weight > 0 else 0
        volume_utilization = 100 - ((obj.available_volume / obj.max_volume) * 100) if obj.max_volume > 0 else 0

        return format_html(
            '''
            <div style="margin:10px 0;">
                <div style="margin-bottom:5px;">
                    <strong>Poids:</strong> {}% utilisé
                    <div style="background-color:#f0f0f0;border-radius:3px;height:10px;width:200px;display:inline-block;margin-left:10px;">
                        <div style="background-color:#4CAF50;border-radius:3px;height:100%;width:{}%;"></div>
                    </div>
                </div>
                <div>
                    <strong>Volume:</strong> {}% utilisé
                    <div style="background-color:#f0f0f0;border-radius:3px;height:10px;width:200px;display:inline-block;margin-left:10px;">
                        <div style="background-color:#2196F3;border-radius:3px;height:100%;width:{}%;"></div>
                    </div>
                </div>
            </div>
            ''',
            round(weight_utilization), weight_utilization,
            round(volume_utilization), volume_utilization
        )
    calculate_utilization.short_description = _('Taux d\'utilisation')

    def mark_as_featured(self, request, queryset):
        updated = queryset.update(is_featured=True)
        self.message_user(request, _('{} routes mises en avant.').format(updated))
    mark_as_featured.short_description = _('Mettre en avant')

    def mark_as_active(self, request, queryset):
        updated = queryset.update(status='ACTIVE')
        self.message_user(request, _('{} routes marquées comme actives.').format(updated))
    mark_as_active.short_description = _('Marquer comme actives')

    def duplicate_routes(self, request, queryset):
        for route in queryset:
            route.pk = None
            route.departure_date = route.departure_date + timezone.timedelta(days=7)
            route.arrival_date = route.arrival_date + timezone.timedelta(days=7)
            route.status = 'ACTIVE'
            route.is_featured = False
            route.save()

        self.message_user(request, _('{} routes dupliquées.').format(queryset.count()))
    duplicate_routes.short_description = _('Dupliquer les routes')


@admin.register(TransportProposal)
class TransportProposalAdmin(admin.ModelAdmin):
    """Admin pour les propositions de transport"""

    actions = ['accept_proposals', 'reject_proposals', 'extend_expiry']

    list_display = [
        'id', 'get_ad', 'get_carrier', 'proposed_price', 'status',
        'days_until_expiry', 'created_at', 'responded_at'
    ]

    list_filter = [
        StatusFilter, CreatedAtFilter, 'includes_insurance', 'includes_packaging',
        ('expires_at', DateFieldListFilter), 'carrier__carrier_type'
    ]

    search_fields = [
        'id', 'ad__title', 'carrier__user__username', 'message',
        'carrier__company_name'
    ]

    readonly_fields = [
        'created_at', 'responded_at', 'get_ad_link', 'get_carrier_link',
        'is_expired'
    ]

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('get_ad_link', 'get_carrier_link', 'status')
        }),
        (_('Détails de la proposition'), {
            'fields': (
                'proposed_price', 'message',
                'estimated_pickup_date', 'estimated_delivery_date'
            )
        }),
        (_('Services'), {
            'fields': (
                'includes_insurance', 'insurance_value',
                'includes_packaging', 'includes_loading', 'includes_unloading'
            )
        }),
        (_('Expiration'), {
            'fields': ('expires_at', 'is_expired', 'days_until_expiry')
        }),
        (_('Réponse'), {
            'fields': ('responded_at', 'response_message')
        }),
        (_('Métadonnées'), {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )

    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        queryset = queryset.select_related('ad', 'carrier', 'carrier__user')
        return queryset

    def get_ad(self, obj):
        return obj.ad.title[:50] + '...' if len(obj.ad.title) > 50 else obj.ad.title
    get_ad.short_description = _('Annonce')
    get_ad.admin_order_field = 'ad__title'

    def get_carrier(self, obj):
        return obj.carrier.user.username
    get_carrier.short_description = _('Transporteur')
    get_carrier.admin_order_field = 'carrier__user__username'

    def days_until_expiry(self, obj):
        days = obj.days_until_expiry
        if days is None:
            return '-'

        if days < 0:
            return format_html('<span style="color:#F44336;">{}</span>', _('Expiré'))
        elif days < 2:
            return format_html('<span style="color:#FF9800;">{}</span>', f"{days} {_('jours')}")
        else:
            return f"{days} {_('jours')}"
    days_until_expiry.short_description = _('Jours avant expiration')

    def get_ad_link(self, obj):
        url = reverse('admin:ads_ad_change', args=[obj.ad.id])
        return format_html('<a href="{}">{}</a>', url, obj.ad.title)
    get_ad_link.short_description = _('Annonce')

    def get_carrier_link(self, obj):
        url = reverse('admin:carriers_carrier_change', args=[obj.carrier.id])
        return format_html('<a href="{}">{}</a>', url, str(obj.carrier))
    get_carrier_link.short_description = _('Transporteur')

    def accept_proposals(self, request, queryset):
        updated = queryset.filter(status='PENDING').update(
            status='ACCEPTED',
            responded_at=timezone.now()
        )
        self.message_user(request, _('{} propositions acceptées.').format(updated))
    accept_proposals.short_description = _('Accepter les propositions')

    def reject_proposals(self, request, queryset):
        updated = queryset.filter(status='PENDING').update(
            status='REJECTED',
            responded_at=timezone.now()
        )
        self.message_user(request, _('{} propositions rejetées.').format(updated))
    reject_proposals.short_description = _('Rejeter les propositions')

    def extend_expiry(self, request, queryset):
        for proposal in queryset:
            proposal.expires_at = proposal.expires_at + timezone.timedelta(days=7)
            proposal.save()

        self.message_user(request, _('{} propositions prolongées de 7 jours.').format(queryset.count()))
    extend_expiry.short_description = _('Prolonger l\'expiration')


@admin.register(TrackingEvent)
class TrackingEventAdmin(admin.ModelAdmin):
    """Admin pour les événements de suivi"""

    # ✅ CORRECTION: Ajouter actions = []
    actions = []

    list_display = [
        'id', 'get_mission', 'event_type', 'location', 'created_at',
        'get_created_by'
    ]

    list_filter = [
        'event_type', CreatedAtFilter,
        ('created_at', DateFieldListFilter)
    ]

    search_fields = [
        'mission__reservation__ad__title', 'description', 'location',
        'created_by__username'
    ]

    readonly_fields = ['created_at', 'get_mission_link', 'get_created_by_link']

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('get_mission_link', 'event_type')
        }),
        (_('Détails'), {
            'fields': ('description', 'location', 'latitude', 'longitude')
        }),
        (_('Photo'), {
            'fields': ('photo',)
        }),
        (_('Création'), {
            'fields': ('get_created_by_link', 'created_at')
        }),
    )

    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        queryset = queryset.select_related('mission', 'mission__reservation', 'created_by')
        return queryset

    def get_mission(self, obj):
        return f"Mission #{obj.mission.id}"
    get_mission.short_description = _('Mission')
    get_mission.admin_order_field = 'mission__id'

    def get_created_by(self, obj):
        return obj.created_by.username if obj.created_by else '-'
    get_created_by.short_description = _('Créé par')
    get_created_by.admin_order_field = 'created_by__username'

    def get_mission_link(self, obj):
        url = reverse('admin:logistics_mission_change', args=[obj.mission.id])
        return format_html('<a href="{}">Mission #{}</a>', url, obj.mission.id)
    get_mission_link.short_description = _('Mission')

    def get_created_by_link(self, obj):
        if obj.created_by:
            url = reverse('admin:users_user_change', args=[obj.created_by.id])
            return format_html('<a href="{}">{}</a>', url, obj.created_by.username)
        return '-'
    get_created_by_link.short_description = _('Créé par')


@admin.register(LogisticsSettings)
class LogisticsSettingsAdmin(admin.ModelAdmin):
    """Admin pour les paramètres logistiques"""

    # ✅ CORRECTION: Ajouter actions = []
    actions = []

    def has_add_permission(self, request):
        # Ne permettre qu'une seule instance
        return not LogisticsSettings.objects.exists()

    def has_delete_permission(self, request, obj=None):
        return False


# Panneau d'administration personnalisé
class LogisticsAdminSite(admin.AdminSite):
    """Site d'administration personnalisé pour la logistique"""
    site_header = _('Administration Logistique Ebi3')
    site_title = _('Administration Logistique')
    index_title = _('Tableau de bord Logistique')

    def get_app_list(self, request, app_label=None):
        """
        Réorganiser la liste des apps pour mettre la logistique en premier
        """
        app_list = super().get_app_list(request, app_label)

        # Trouver et réorganiser l'app logistics
        logistics_app = None
        other_apps = []

        for app in app_list:
            if app['app_label'] == 'logistics':
                logistics_app = app
            else:
                other_apps.append(app)

        if logistics_app:
            return [logistics_app] + other_apps

        return app_list


# Enregistrement du panneau d'administration personnalisé
logistics_admin_site = LogisticsAdminSite(name='logistics_admin')

# Enregistrer les modèles avec le site personnalisé
logistics_admin_site.register(Reservation, ReservationAdmin)
logistics_admin_site.register(Mission, MissionAdmin)
logistics_admin_site.register(Route, RouteAdmin)
logistics_admin_site.register(TransportProposal, TransportProposalAdmin)
logistics_admin_site.register(TrackingEvent, TrackingEventAdmin)
logistics_admin_site.register(LogisticsSettings, LogisticsSettingsAdmin)


========== logistics/forms.py ==========
# ~/ebi3/logistics/forms.py

from django import forms
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import ValidationError
from django.core.validators import MinValueValidator

from .models import (
    Reservation, Mission, Route, TransportProposal, TrackingEvent,
    LogisticsOption, ReservationStatus, MissionStatus, RouteStatus,
    TransportProposalStatus, TrackingEventType
)
from ads.models import Ad
from carriers.models import Carrier
from core.models import Country, City


class ReservationForm(forms.ModelForm):
    """Formulaire de création/modification de réservation"""

    class Meta:
        model = Reservation
        fields = [
            'logistics_option',
            'carrier',
            'pickup_address',
            'delivery_address',
            'pickup_date',
            'delivery_date',
            'shipping_cost',
            'insurance_cost',
            'requires_insurance',
            'insurance_value',
            'requires_packaging',
            'packaging_details',
            'buyer_notes'
        ]
        widgets = {
            'logistics_option': forms.Select(attrs={
                'class': 'form-select',
                'onchange': 'toggleCarrierField()'
            }),
            'carrier': forms.Select(attrs={
                'class': 'form-select',
                'id': 'carrier-select'
            }),
            'pickup_address': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _('Adresse complète de prise en charge')
            }),
            'delivery_address': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _('Adresse complète de livraison')
            }),
            'pickup_date': forms.DateInput(attrs={
                'class': 'form-control',
                'type': 'date',
                'min': timezone.now().date().isoformat()
            }),
            'delivery_date': forms.DateInput(attrs={
                'class': 'form-control',
                'type': 'date',
                'min': timezone.now().date().isoformat()
            }),
            'shipping_cost': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0'
            }),
            'insurance_cost': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0'
            }),
            'insurance_value': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0'
            }),
            'packaging_details': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _('Spécifications d\'emballage si nécessaire')
            }),
            'buyer_notes': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _('Notes ou instructions spéciales')
            }),
        }
        labels = {
            'logistics_option': _('Option logistique'),
            'carrier': _('Transporteur'),
            'pickup_address': _('Adresse de prise en charge'),
            'delivery_address': _('Adresse de livraison'),
            'pickup_date': _('Date de prise en charge'),
            'delivery_date': _('Date de livraison estimée'),
            'shipping_cost': _('Coût du transport (€)'),
            'insurance_cost': _('Coût de l\'assurance (€)'),
            'requires_insurance': _('Nécessite une assurance'),
            'insurance_value': _('Valeur à assurer (€)'),
            'requires_packaging': _('Nécessite un emballage'),
            'packaging_details': _('Détails de l\'emballage'),
            'buyer_notes': _('Notes pour le vendeur/transporteur'),
        }
        help_texts = {
            'logistics_option': _('Choisissez comment vous souhaitez faire livrer l\'objet'),
            'pickup_date': _('Date à laquelle l\'objet sera pris en charge'),
            'delivery_date': _('Date estimée de livraison chez vous'),
        }

    def __init__(self, *args, **kwargs):
        self.ad = kwargs.pop('ad', None)
        self.buyer = kwargs.pop('buyer', None)
        super().__init__(*args, **kwargs)

        if self.ad:
            # Filtrer les transporteurs disponibles pour cette annonce
            self.fields['carrier'].queryset = Carrier.objects.filter(
                is_available=True,
                status=Carrier.Status.APPROVED,
                max_weight__gte=self.ad.weight if self.ad.weight else 0,
                max_volume__gte=self.ad.volume if self.ad.volume else 0
            ).select_related('user')

            # Pré-remplir certaines informations
            if not self.instance.pk:
                self.initial['pickup_address'] = self.ad.address_from
                self.initial['delivery_address'] = self.ad.address_to

                # Calculer le coût de transport estimé
                estimated_cost = self.estimate_shipping_cost()
                if estimated_cost:
                    self.initial['shipping_cost'] = estimated_cost

        # Ajouter des classes CSS aux champs booléens
        for field_name in ['requires_insurance', 'requires_packaging']:
            self.fields[field_name].widget.attrs['class'] = 'form-check-input'

    def estimate_shipping_cost(self):
        """Estime le coût de transport pour cette annonce"""
        if not self.ad:
            return None

        # Logique simplifiée d'estimation
        # Vous pouvez ajuster cette logique selon vos besoins
        base_cost = 10.0  # Coût de base

        if self.ad.weight:
            base_cost += self.ad.weight * 0.5  # 0.5€ par kg

        # Ajouter un coût pour la distance (simplifié)
        # Dans une vraie application, vous utiliseriez une API de distance
        base_cost += 20.0  # Coût distance estimé

        return round(base_cost, 2)

    def clean(self):
        cleaned_data = super().clean()

        logistics_option = cleaned_data.get('logistics_option')
        carrier = cleaned_data.get('carrier')
        pickup_date = cleaned_data.get('pickup_date')
        delivery_date = cleaned_data.get('delivery_date')
        requires_insurance = cleaned_data.get('requires_insurance')
        insurance_value = cleaned_data.get('insurance_value')

        # Validation de l'option logistique
        if logistics_option == LogisticsOption.WITH_CARRIER and not carrier:
            self.add_error('carrier', _('Veuillez sélectionner un transporteur pour cette option.'))

        if logistics_option == LogisticsOption.P2P_DIRECT and carrier:
            self.add_error('carrier', _('L\'option P2P direct ne nécessite pas de transporteur.'))

        # Validation des dates
        if pickup_date and pickup_date < timezone.now().date():
            self.add_error('pickup_date', _('La date de prise en charge ne peut pas être dans le passé.'))

        if delivery_date and pickup_date and delivery_date < pickup_date:
            self.add_error('delivery_date', _('La date de livraison doit être après la date de prise en charge.'))

        # Validation de l'assurance
        if requires_insurance and not insurance_value:
            self.add_error('insurance_value', _('Veuillez spécifier la valeur à assurer.'))

        if insurance_value and not requires_insurance:
            self.add_error('requires_insurance', _('Cochez cette case si vous voulez une assurance.'))

        # Validation du transporteur (capacités)
        if carrier and self.ad:
            if self.ad.weight and carrier.max_weight < self.ad.weight:
                self.add_error('carrier', _('Ce transporteur ne peut pas prendre en charge le poids de cet objet.'))

            if self.ad.volume and carrier.max_volume < self.ad.volume:
                self.add_error('carrier', _('Ce transporteur ne peut pas prendre en charge le volume de cet objet.'))

        return cleaned_data


class ReservationStatusForm(forms.ModelForm):
    """Formulaire de changement de statut d'une réservation"""

    class Meta:
        model = Reservation
        fields = ['status']
        widgets = {
            'status': forms.Select(attrs={'class': 'form-select'})
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        # Filtrer les statuts disponibles selon le statut actuel
        current_status = self.instance.status
        available_statuses = self.get_available_statuses(current_status)

        self.fields['status'].choices = [
            (status.value, label) for status, label in ReservationStatus.choices
            if status in available_statuses
        ]

    def get_available_statuses(self, current_status):
        """Détermine les statuts disponibles selon le statut actuel"""
        status_transitions = {
            ReservationStatus.PENDING: [
                ReservationStatus.CONFIRMED,
                ReservationStatus.CANCELLED
            ],
            ReservationStatus.CONFIRMED: [
                ReservationStatus.PAYMENT_PENDING,
                ReservationStatus.CANCELLED
            ],
            ReservationStatus.PAYMENT_PENDING: [
                ReservationStatus.PAID,
                ReservationStatus.CANCELLED
            ],
            ReservationStatus.PAID: [
                ReservationStatus.IN_TRANSIT,
                ReservationStatus.CANCELLED
            ],
            ReservationStatus.IN_TRANSIT: [
                ReservationStatus.DELIVERED,
                ReservationStatus.DISPUTED
            ],
            ReservationStatus.DELIVERED: [],
            ReservationStatus.CANCELLED: [],
            ReservationStatus.DISPUTED: [
                ReservationStatus.DELIVERED,
                ReservationStatus.REFUNDED
            ],
            ReservationStatus.REFUNDED: [],
        }

        # Toujours permettre de rester dans le même statut
        return [current_status] + status_transitions.get(current_status, [])


class MissionForm(forms.ModelForm):
    """Formulaire de création/modification de mission"""

    class Meta:
        model = Mission
        fields = [
            'status',
            'current_location',
            'estimated_delivery',
            'delay_reason',
            'notes'
        ]
        widgets = {
            'status': forms.Select(attrs={'class': 'form-select'}),
            'current_location': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Ville, pays')
            }),
            'estimated_delivery': forms.DateTimeInput(attrs={
                'class': 'form-control',
                'type': 'datetime-local',
                'min': timezone.now().isoformat()[:16]
            }),
            'delay_reason': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _('Raison du retard...')
            }),
            'notes': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _('Notes internes...')
            }),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        # Si la mission est retardée, rendre le champ delay_reason obligatoire
        if self.instance.status == MissionStatus.DELAYED:
            self.fields['delay_reason'].required = True


class TrackingEventForm(forms.ModelForm):
    """Formulaire de création d'événement de suivi"""

    class Meta:
        model = TrackingEvent
        fields = [
            'event_type',
            'description',
            'location',
            'photo'
        ]
        widgets = {
            'event_type': forms.Select(attrs={'class': 'form-select'}),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _('Détails de l\'événement...')
            }),
            'location': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Ville, pays ou adresse')
            }),
            'photo': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*'
            }),
        }

    def __init__(self, *args, **kwargs):
        self.mission = kwargs.pop('mission', None)
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        # Filtrer les types d'événements selon le statut de la mission
        if self.mission:
            available_events = self.get_available_events(self.mission.status)
            self.fields['event_type'].choices = [
                (event.value, label) for event, label in TrackingEventType.choices
                if event in available_events
            ]

        # Pré-remplir la localisation
        if self.mission and self.mission.current_location:
            self.initial['location'] = self.mission.current_location

    def get_available_events(self, mission_status):
        """Détermine les événements disponibles selon le statut de la mission"""
        event_mapping = {
            MissionStatus.SCHEDULED: [
                TrackingEventType.PICKUP_SCHEDULED,
                TrackingEventType.PICKUP_CONFIRMED,
                TrackingEventType.DELAYED
            ],
            MissionStatus.PICKUP_PENDING: [
                TrackingEventType.PICKUP_CONFIRMED,
                TrackingEventType.PICKUP_COMPLETED,
                TrackingEventType.DELAYED
            ],
            MissionStatus.PICKED_UP: [
                TrackingEventType.IN_TRANSIT,
                TrackingEventType.CUSTOMS_CLEARANCE,
                TrackingEventType.DELAYED
            ],
            MissionStatus.IN_TRANSIT: [
                TrackingEventType.ARRIVED_AT_HUB,
                TrackingEventType.DEPARTED_FROM_HUB,
                TrackingEventType.CUSTOMS_CLEARANCE,
                TrackingEventType.CUSTOMS_HELD,
                TrackingEventType.DELAYED
            ],
            MissionStatus.AT_HUB: [
                TrackingEventType.DEPARTED_FROM_HUB,
                TrackingEventType.OUT_FOR_DELIVERY,
                TrackingEventType.DELAYED
            ],
            MissionStatus.OUT_FOR_DELIVERY: [
                TrackingEventType.DELIVERY_ATTEMPTED,
                TrackingEventType.DELIVERY_RESCHEDULED,
                TrackingEventType.DELIVERED,
                TrackingEventType.DELAYED
            ],
            MissionStatus.DELIVERY_PENDING: [
                TrackingEventType.DELIVERY_ATTEMPTED,
                TrackingEventType.DELIVERY_RESCHEDULED,
                TrackingEventType.DELIVERED,
                TrackingEventType.DELAYED
            ],
            MissionStatus.DELAYED: [
                TrackingEventType.ISSUE_RESOLVED,
                TrackingEventType.IN_TRANSIT,
                TrackingEventType.OUT_FOR_DELIVERY
            ],
            MissionStatus.DELIVERED: [],
            MissionStatus.CANCELLED: [],
        }

        return event_mapping.get(mission_status, [])


class RouteForm(forms.ModelForm):
    """Formulaire de création/modification de route"""

    start_country = forms.ModelChoiceField(
        queryset=Country.objects.all(),
        label=_("Pays de départ"),
        widget=forms.Select(attrs={'class': 'form-select'})
    )

    end_country = forms.ModelChoiceField(
        queryset=Country.objects.all(),
        label=_("Pays d'arrivée"),
        widget=forms.Select(attrs={'class': 'form-select'})
    )

    class Meta:
        model = Route
        fields = [
            'start_city',
            'start_country',
            'start_address',
            'end_city',
            'end_country',
            'end_address',
            'departure_date',
            'arrival_date',
            'max_weight',
            'max_volume',
            'available_weight',
            'available_volume',
            'fixed_price',
            'price_per_kg',
            'price_per_m3',
            'includes_insurance',
            'includes_packaging',
            'includes_loading',
            'includes_unloading',
            'description',
            'special_conditions'
        ]
        widgets = {
            'start_city': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Ville de départ')
            }),
            'end_city': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Ville d\'arrivée')
            }),
            'start_address': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _('Adresse exacte de départ (optionnel)')
            }),
            'end_address': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _('Adresse exacte d\'arrivée (optionnel)')
            }),
            'departure_date': forms.DateInput(attrs={
                'class': 'form-control',
                'type': 'date',
                'min': timezone.now().date().isoformat()
            }),
            'arrival_date': forms.DateInput(attrs={
                'class': 'form-control',
                'type': 'date',
                'min': timezone.now().date().isoformat()
            }),
            'max_weight': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.001',
                'min': '0'
            }),
            'max_volume': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.001',
                'min': '0'
            }),
            'available_weight': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.001',
                'min': '0'
            }),
            'available_volume': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.001',
                'min': '0'
            }),
            'fixed_price': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0'
            }),
            'price_per_kg': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0'
            }),
            'price_per_m3': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0'
            }),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _('Décrivez votre trajet...')
            }),
            'special_conditions': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _('Conditions spéciales, restrictions...')
            }),
        }
        labels = {
            'start_city': _('Ville de départ'),
            'end_city': _('Ville d\'arrivée'),
            'start_address': _('Adresse de départ'),
            'end_address': _('Adresse d\'arrivée'),
            'departure_date': _('Date de départ'),
            'arrival_date': _('Date d\'arrivée'),
            'max_weight': _('Poids maximum (kg)'),
            'max_volume': _('Volume maximum (m³)'),
            'available_weight': _('Poids disponible (kg)'),
            'available_volume': _('Volume disponible (m³)'),
            'fixed_price': _('Prix fixe (€)'),
            'price_per_kg': _('Prix par kg (€)'),
            'price_per_m3': _('Prix par m³ (€)'),
            'includes_insurance': _('Assurance incluse'),
            'includes_packaging': _('Emballage inclus'),
            'includes_loading': _('Chargement inclus'),
            'includes_unloading': _('Déchargement inclus'),
            'description': _('Description'),
            'special_conditions': _('Conditions spéciales'),
        }

    def __init__(self, *args, **kwargs):
        self.carrier = kwargs.pop('carrier', None)
        super().__init__(*args, **kwargs)

        # Si création, pré-remplir avec les capacités du transporteur
        if not self.instance.pk and self.carrier:
            self.initial['max_weight'] = self.carrier.max_weight
            self.initial['max_volume'] = self.carrier.max_volume
            self.initial['available_weight'] = self.carrier.max_weight
            self.initial['available_volume'] = self.carrier.max_volume

            # Utiliser base_price_per_km pour les calculs
            if hasattr(self.carrier, 'base_price_per_km'):
                self.initial['price_per_kg'] = self.carrier.base_price_per_km * 0.1  # Estimation
                self.initial['price_per_m3'] = self.carrier.base_price_per_km * 0.5  # Estimation

        # Ajouter des classes CSS aux champs booléens
        for field_name in ['includes_insurance', 'includes_packaging',
                          'includes_loading', 'includes_unloading']:
            self.fields[field_name].widget.attrs['class'] = 'form-check-input'

    def clean(self):
        cleaned_data = super().clean()

        departure_date = cleaned_data.get('departure_date')
        arrival_date = cleaned_data.get('arrival_date')
        max_weight = cleaned_data.get('max_weight')
        available_weight = cleaned_data.get('available_weight')
        max_volume = cleaned_data.get('max_volume')
        available_volume = cleaned_data.get('available_volume')
        fixed_price = cleaned_data.get('fixed_price')
        price_per_kg = cleaned_data.get('price_per_kg')
        price_per_m3 = cleaned_data.get('price_per_m3')

        # Validation des dates
        if departure_date and departure_date < timezone.now().date():
            self.add_error('departure_date', _('La date de départ ne peut pas être dans le passé.'))

        if arrival_date and departure_date and arrival_date < departure_date:
            self.add_error('arrival_date', _('La date d\'arrivée doit être après la date de départ.'))

        # Validation des capacités
        if max_weight and available_weight and available_weight > max_weight:
            self.add_error('available_weight', _('Le poids disponible ne peut pas dépasser le poids maximum.'))

        if max_volume and available_volume and available_volume > max_volume:
            self.add_error('available_volume', _('Le volume disponible ne peut pas dépasser le volume maximum.'))

        # Validation des prix
        if not fixed_price and not price_per_kg and not price_per_m3:
            self.add_error('fixed_price', _('Veuillez spécifier au moins un type de prix.'))

        # Limiter les capacités selon celles du transporteur
        if self.carrier:
            if max_weight and max_weight > self.carrier.max_weight:
                self.add_error('max_weight', _(
                    f'Votre capacité maximale est de {self.carrier.max_weight} kg.'
                ))

            if max_volume and max_volume > self.carrier.max_volume:
                self.add_error('max_volume', _(
                    f'Votre volume maximal est de {self.carrier.max_volume} m³.'
                ))

        return cleaned_data


class RouteSearchForm(forms.Form):
    """Formulaire de recherche de routes"""

    start_city = forms.CharField(
        required=False,
        label=_('Ville de départ'),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _('Ville de départ')
        })
    )

    start_country = forms.ModelChoiceField(
        required=False,
        queryset=Country.objects.all(),
        label=_('Pays de départ'),
        widget=forms.Select(attrs={'class': 'form-select'})
    )

    end_city = forms.CharField(
        required=False,
        label=_('Ville d\'arrivée'),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _('Ville d\'arrivée')
        })
    )

    end_country = forms.ModelChoiceField(
        required=False,
        queryset=Country.objects.all(),
        label=_('Pays d\'arrivée'),
        widget=forms.Select(attrs={'class': 'form-select'})
    )

    departure_date_from = forms.DateField(
        required=False,
        label=_('Départ après le'),
        widget=forms.DateInput(attrs={
            'class': 'form-control',
            'type': 'date',
            'min': timezone.now().date().isoformat()
        })
    )

    departure_date_to = forms.DateField(
        required=False,
        label=_('Départ avant le'),
        widget=forms.DateInput(attrs={
            'class': 'form-control',
            'type': 'date',
            'min': timezone.now().date().isoformat()
        })
    )

    max_price = forms.DecimalField(
        required=False,
        label=_('Prix maximum (€)'),
        decimal_places=2,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01',
            'min': '0'
        })
    )

    min_available_weight = forms.DecimalField(
        required=False,
        label=_('Poids disponible minimum (kg)'),
        decimal_places=3,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.001',
            'min': '0'
        })
    )

    min_available_volume = forms.DecimalField(
        required=False,
        label=_('Volume disponible minimum (m³)'),
        decimal_places=3,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.001',
            'min': '0'
        })
    )

    includes_insurance = forms.BooleanField(
        required=False,
        label=_('Avec assurance'),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    includes_packaging = forms.BooleanField(
        required=False,
        label=_('Avec emballage'),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    carrier_type = forms.ChoiceField(
        required=False,
        choices=[('', _('Tous'))] + list(Carrier.CarrierType.choices),
        label=_('Type de transporteur'),
        widget=forms.Select(attrs={'class': 'form-select'})
    )

    sort_by = forms.ChoiceField(
        required=False,
        choices=[
            ('departure_date', _('Date de départ')),
            ('price', _('Prix croissant')),
            ('-price', _('Prix décroissant')),
            ('available_weight', _('Capacité disponible')),
            ('-created_at', _('Plus récent')),
        ],
        label=_('Trier par'),
        widget=forms.Select(attrs={'class': 'form-select'})
    )


class TransportProposalForm(forms.ModelForm):
    """Formulaire de création de proposition de transport"""

    class Meta:
        model = TransportProposal
        fields = [
            'proposed_price',
            'message',
            'estimated_pickup_date',
            'estimated_delivery_date',
            'includes_insurance',
            'insurance_value',
            'includes_packaging',
            'includes_loading',
            'includes_unloading'
        ]
        widgets = {
            'proposed_price': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0'
            }),
            'message': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _('Présentez-vous et expliquez votre proposition...')
            }),
            'estimated_pickup_date': forms.DateInput(attrs={
                'class': 'form-control',
                'type': 'date',
                'min': timezone.now().date().isoformat()
            }),
            'estimated_delivery_date': forms.DateInput(attrs={
                'class': 'form-control',
                'type': 'date',
                'min': timezone.now().date().isoformat()
            }),
            'insurance_value': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0'
            }),
        }
        labels = {
            'proposed_price': _('Prix proposé (€)'),
            'message': _('Message au vendeur'),
            'estimated_pickup_date': _('Date de prise en charge estimée'),
            'estimated_delivery_date': _('Date de livraison estimée'),
            'includes_insurance': _('Inclure une assurance'),
            'insurance_value': _('Valeur assurée (€)'),
            'includes_packaging': _('Inclure l\'emballage'),
            'includes_loading': _('Inclure le chargement'),
            'includes_unloading': _('Inclure le déchargement'),
        }

    def __init__(self, *args, **kwargs):
        self.ad = kwargs.pop('ad', None)
        self.carrier = kwargs.pop('carrier', None)
        super().__init__(*args, **kwargs)

        if self.ad:
            # Calculer le prix suggéré basé sur l'annonce
            suggested_price = self.calculate_suggested_price()
            self.initial['proposed_price'] = suggested_price

        # Ajouter des classes CSS aux champs booléens
        for field_name in ['includes_insurance', 'includes_packaging',
                          'includes_loading', 'includes_unloading']:
            self.fields[field_name].widget.attrs['class'] = 'form-check-input'

    def calculate_suggested_price(self):
        """Calcule un prix suggéré pour la proposition"""
        if not self.ad or not self.carrier:
            return 0

        # Prix de base : coût estimé du transport
        base_price = 0

        # Si l'annonce a un poids, utiliser une estimation
        if self.ad.weight and hasattr(self.carrier, 'base_price_per_km'):
            # Estimation: 0.5€ par kg pour les courtes distances
            base_price += self.ad.weight * 0.5

        # Ajouter une marge (20%)
        suggested_price = base_price * 1.2

        # S'assurer que le prix est au moins le prix minimum du transporteur
        if hasattr(self.carrier, 'min_price') and suggested_price < self.carrier.min_price:
            suggested_price = self.carrier.min_price

        # Arrondir à 2 décimales
        return round(suggested_price, 2)

    def clean(self):
        cleaned_data = super().clean()

        estimated_pickup_date = cleaned_data.get('estimated_pickup_date')
        estimated_delivery_date = cleaned_data.get('estimated_delivery_date')
        includes_insurance = cleaned_data.get('includes_insurance')
        insurance_value = cleaned_data.get('insurance_value')
        proposed_price = cleaned_data.get('proposed_price')

        # Validation des dates
        if estimated_pickup_date and estimated_pickup_date < timezone.now().date():
            self.add_error('estimated_pickup_date', _('La date de prise en charge ne peut pas être dans le passé.'))

        if estimated_delivery_date and estimated_pickup_date and estimated_delivery_date < estimated_pickup_date:
            self.add_error('estimated_delivery_date', _('La date de livraison doit être après la date de prise en charge.'))

        # Validation de l'assurance
        if includes_insurance and not insurance_value:
            self.add_error('insurance_value', _('Veuillez spécifier la valeur à assurer.'))

        # Validation du prix
        if proposed_price and proposed_price <= 0:
            self.add_error('proposed_price', _('Le prix doit être supérieur à 0.'))

        # Vérifier les capacités du transporteur
        if self.carrier and self.ad:
            if self.ad.weight and self.carrier.max_weight < self.ad.weight:
                raise ValidationError(_(
                    'Votre capacité maximale est insuffisante pour cet objet.'
                ))

            if self.ad.volume and self.carrier.max_volume < self.ad.volume:
                raise ValidationError(_(
                    'Votre volume maximal est insuffisant pour cet objet.'
                ))

        return cleaned_data


class ProposalResponseForm(forms.ModelForm):
    """Formulaire de réponse à une proposition de transport"""

    accept = forms.BooleanField(
        required=False,
        label=_('Accepter la proposition'),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    class Meta:
        model = TransportProposal
        fields = ['response_message']
        widgets = {
            'response_message': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _('Votre message au transporteur...')
            }),
        }
        labels = {
            'response_message': _('Message'),
        }

    def clean(self):
        cleaned_data = super().clean()
        accept = cleaned_data.get('accept')
        response_message = cleaned_data.get('response_message')

        # Si on accepte, pas besoin de message
        # Si on refuse, un message est recommandé mais pas obligatoire
        if not accept and not response_message:
            self.add_error('response_message', _(
                'Un message expliquant votre refus est recommandé.'
            ))

        return cleaned_data

    def save(self, commit=True):
        instance = super().save(commit=False)

        accept = self.cleaned_data.get('accept')
        if accept:
            instance.status = TransportProposalStatus.ACCEPTED
        else:
            instance.status = TransportProposalStatus.REJECTED

        instance.responded_at = timezone.now()

        if commit:
            instance.save()

        return instance


class LogisticsSettingsForm(forms.Form):
    """Formulaire des paramètres logistiques (formulaire simple, pas ModelForm)"""

    commission_rate = forms.DecimalField(
        label=_('Taux de commission (%)'),
        max_digits=5,
        decimal_places=2,
        min_value=0,
        max_value=100,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01'
        }),
        help_text=_('Pourcentage prélevé sur chaque transaction')
    )

    reservation_expiry_hours = forms.IntegerField(
        label=_('Expiration réservation (heures)'),
        min_value=1,
        widget=forms.NumberInput(attrs={
            'class': 'form-control'
        }),
        help_text=_('Délai avant expiration automatique d\'une réservation non confirmée')
    )

    proposal_expiry_days = forms.IntegerField(
        label=_('Expiration proposition (jours)'),
        min_value=1,
        widget=forms.NumberInput(attrs={
            'class': 'form-control'
        })
    )

    payment_hold_days = forms.IntegerField(
        label=_('Rétention paiement (jours)'),
        min_value=0,
        widget=forms.NumberInput(attrs={
            'class': 'form-control'
        }),
        help_text=_('Nombre de jours où le paiement est retenu après livraison')
    )

    auto_release_payment = forms.BooleanField(
        label=_('Libération automatique paiement'),
        required=False,
        widget=forms.CheckboxInput(attrs={
            'class': 'form-check-input'
        }),
        help_text=_('Libérer automatiquement le paiement après la période de rétention')
    )

    notify_on_reservation = forms.BooleanField(
        label=_('Notifier nouvelle réservation'),
        required=False,
        widget=forms.CheckboxInput(attrs={
            'class': 'form-check-input'
        })
    )

    notify_on_status_change = forms.BooleanField(
        label=_('Notifier changement statut'),
        required=False,
        widget=forms.CheckboxInput(attrs={
            'class': 'form-check-input'
        })
    )

    notify_before_expiry = forms.BooleanField(
        label=_('Notifier avant expiration'),
        required=False,
        widget=forms.CheckboxInput(attrs={
            'class': 'form-check-input'
        })
    )


class QuickReservationForm(forms.Form):
    """Formulaire de réservation rapide (sans transporteur)"""

    pickup_date = forms.DateField(
        label=_('Date de prise en charge'),
        widget=forms.DateInput(attrs={
            'class': 'form-control',
            'type': 'date',
            'min': timezone.now().date().isoformat()
        })
    )

    delivery_date = forms.DateField(
        label=_('Date de livraison estimée'),
        widget=forms.DateInput(attrs={
            'class': 'form-control',
            'type': 'date',
            'min': timezone.now().date().isoformat()
        })
    )

    buyer_notes = forms.CharField(
        required=False,
        label=_('Notes'),
        widget=forms.Textarea(attrs={
            'class': 'form-control',
            'rows': 3,
            'placeholder': _('Notes ou instructions...')
        })
    )

    agree_terms = forms.BooleanField(
        label=_('J\'accepte les conditions de réservation'),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    def clean(self):
        cleaned_data = super().clean()
        pickup_date = cleaned_data.get('pickup_date')
        delivery_date = cleaned_data.get('delivery_date')

        if pickup_date and delivery_date and delivery_date < pickup_date:
            self.add_error('delivery_date', _('La date de livraison doit être après la date de prise en charge.'))

        return cleaned_data


# Formulaire pour les rapports/logistique
class LogisticsReportForm(forms.Form):
    """Formulaire pour générer des rapports logistiques"""

    report_type = forms.ChoiceField(
        label=_('Type de rapport'),
        choices=[
            ('reservations', _('Réservations')),
            ('missions', _('Missions')),
            ('revenue', _('Revenus')),
            ('carrier_performance', _('Performance des transporteurs')),
            ('delivery_times', _('Délais de livraison')),
        ],
        widget=forms.Select(attrs={'class': 'form-select'})
    )

    start_date = forms.DateField(
        label=_('Date de début'),
        widget=forms.DateInput(attrs={
            'class': 'form-control',
            'type': 'date'
        })
    )

    end_date = forms.DateField(
        label=_('Date de fin'),
        widget=forms.DateInput(attrs={
            'class': 'form-control',
            'type': 'date'
        })
    )

    carrier = forms.ModelChoiceField(
        label=_('Transporteur'),
        required=False,
        queryset=Carrier.objects.filter(status=Carrier.Status.APPROVED),
        widget=forms.Select(attrs={'class': 'form-select'})
    )

    def clean(self):
        cleaned_data = super().clean()
        start_date = cleaned_data.get('start_date')
        end_date = cleaned_data.get('end_date')

        if start_date and end_date and end_date < start_date:
            self.add_error('end_date', _('La date de fin doit être après la date de début.'))

        return cleaned_data


# Formulaire pour les notifications
class LogisticsNotificationForm(forms.Form):
    """Formulaire pour gérer les notifications logistiques"""

    email_notifications = forms.BooleanField(
        label=_('Notifications par email'),
        required=False,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    push_notifications = forms.BooleanField(
        label=_('Notifications push'),
        required=False,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    notify_on_reservation = forms.BooleanField(
        label=_('Nouvelle réservation'),
        required=False,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    notify_on_status_change = forms.BooleanField(
        label=_('Changement de statut'),
        required=False,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    notify_on_delay = forms.BooleanField(
        label=_('Retard de livraison'),
        required=False,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    notify_before_pickup = forms.BooleanField(
        label=_('Rappel avant prise en charge'),
        required=False,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    notify_before_delivery = forms.BooleanField(
        label=_('Rappel avant livraison'),
        required=False,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )


========== logistics/__init__.py ==========



========== logistics/apps.py ==========
# ~/ebi3/logistics/apps.py

from django.apps import AppConfig
from django.utils.translation import gettext_lazy as _


class LogisticsConfig(AppConfig):
    name = 'logistics'
    verbose_name = _('Logistique')

    def ready(self):
        """
        Méthode appelée quand l'app est prête
        """
        # Import et connexion des signaux
        try:
            import logistics.signals  # noqa: F401
        except ImportError:
            pass

        # Configuration des tâches périodiques
        self.setup_periodic_tasks()

    def setup_periodic_tasks(self):
        """
        Configurer les tâches périodiques (si vous utilisez Celery)
        """
        try:
            # Vérifier si Celery est installé
            from celery import Celery

            # Tâches pour gérer les expirations
            from .tasks import (
                expire_old_reservations,
                expire_old_proposals,
                update_route_statuses,
                send_delivery_reminders
            )

            # Ces tâches seraient configurées dans celery.py
            pass
        except ImportError:
            # Celery n'est pas installé, utiliser les signaux
            pass


========== logistics/tasks.py ==========
# ~/ebi3/logistics/tasks.py

from celery import shared_task
from celery.utils.log import get_task_logger
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from django.db.models import Q, F, Count, Sum
from django.core.cache import cache
from django.conf import settings

from .models import (
    Reservation, Mission, Route, TransportProposal,
    ReservationStatus, MissionStatus, RouteStatus, TransportProposalStatus,
    LogisticsSettings
)
from users.models import Notification
from core.models import ActivityLog

logger = get_task_logger(__name__)


# ============================================================================
# TÂCHES DE NETTOYAGE ET MAINTENANCE
# ============================================================================

@shared_task(bind=True, max_retries=3)
def expire_old_reservations(self):
    """
    Expirer automatiquement les réservations en attente trop longtemps
    """
    try:
        settings_obj = LogisticsSettings.load()
        expiry_hours = settings_obj.reservation_expiry_hours

        expiry_threshold = timezone.now() - timezone.timedelta(hours=expiry_hours)

        # Trouver les réservations en attente expirées
        expired_reservations = Reservation.objects.filter(
            status=ReservationStatus.PENDING,
            created_at__lt=expiry_threshold
        )

        count = expired_reservations.count()

        for reservation in expired_reservations.select_related('ad', 'buyer'):
            # Marquer comme annulée
            reservation.status = ReservationStatus.CANCELLED
            reservation.cancelled_at = timezone.now()
            reservation.cancellation_reason = _("Expiration automatique")
            reservation.save()

            # Marquer l'annonce comme disponible
            reservation.ad.is_reserved = False
            reservation.ad.save(update_fields=['is_reserved', 'updated_at'])

            # Créer une notification
            Notification.objects.create(
                user=reservation.buyer,
                title=_("Réservation expirée"),
                message=_("Votre réservation pour '{}' a expiré automatiquement après {} heures.").format(
                    reservation.ad.title, expiry_hours
                ),
                url=reservation.ad.get_absolute_url(),
                notification_type='RESERVATION_EXPIRED'
            )

            # Log d'activité
            ActivityLog.objects.create(
                user=reservation.buyer,
                action_type='RESERVATION_EXPIRED_AUTO',
                object_id=reservation.id,
                details={
                    'ad_id': reservation.ad.id,
                    'ad_title': reservation.ad.title,
                    'waiting_hours': expiry_hours
                }
            )

        logger.info(f"Expiré {count} réservations anciennes")
        return {'expired_count': count}

    except Exception as exc:
        logger.error(f"Erreur expiration réservations: {exc}")
        raise self.retry(exc=exc, countdown=60)


@shared_task(bind=True, max_retries=3)
def expire_old_proposals(self):
    """
    Expirer automatiquement les propositions de transport trop anciennes
    """
    try:
        expired_proposals = TransportProposal.objects.filter(
            status=TransportProposalStatus.PENDING,
            expires_at__lt=timezone.now()
        )

        count = expired_proposals.count()

        for proposal in expired_proposals.select_related('carrier', 'carrier__user', 'ad'):
            proposal.status = TransportProposalStatus.EXPIRED
            proposal.save()

            # Notification au transporteur
            Notification.objects.create(
                user=proposal.carrier.user,
                title=_("Proposition expirée"),
                message=_("Votre proposition pour '{}' a expiré.").format(proposal.ad.title),
                url=proposal.ad.get_absolute_url(),
                notification_type='PROPOSAL_EXPIRED'
            )

            # Log d'activité
            ActivityLog.objects.create(
                user=proposal.carrier.user,
                action_type='PROPOSAL_EXPIRED_AUTO',
                object_id=proposal.id,
                details={
                    'ad_id': proposal.ad.id,
                    'ad_title': proposal.ad.title
                }
            )

        logger.info(f"Expiré {count} propositions anciennes")
        return {'expired_count': count}

    except Exception as exc:
        logger.error(f"Erreur expiration propositions: {exc}")
        raise self.retry(exc=exc, countdown=60)


@shared_task(bind=True, max_retries=3)
def update_route_statuses(self):
    """
    Mettre à jour les statuts des routes (actives -> terminées après la date)
    """
    try:
        # Marquer les routes comme terminées après la date d'arrivée
        completed_routes = Route.objects.filter(
            status=RouteStatus.ACTIVE,
            arrival_date__lt=timezone.now().date()
        )

        completed_count = completed_routes.update(status=RouteStatus.COMPLETED)

        # Marquer les routes comme complètes si pas de capacité
        full_routes = Route.objects.filter(
            status=RouteStatus.ACTIVE,
            available_weight=0,
            available_volume=0
        )

        full_count = full_routes.update(status=RouteStatus.FULL)

        logger.info(f"Mis à jour {completed_count} routes terminées, {full_count} routes complètes")
        return {'completed_count': completed_count, 'full_count': full_count}

    except Exception as exc:
        logger.error(f"Erreur mise à jour statuts routes: {exc}")
        raise self.retry(exc=exc, countdown=60)


@shared_task(bind=True, max_retries=3)
def cleanup_old_tracking_events(self, days_old=90):
    """
    Nettoyer les anciens événements de suivi
    """
    try:
        from .models import TrackingEvent

        cutoff_date = timezone.now() - timezone.timedelta(days=days_old)
        deleted_count, _ = TrackingEvent.objects.filter(
            created_at__lt=cutoff_date
        ).delete()

        logger.info(f"Nettoyé {deleted_count} anciens événements de suivi")
        return {'deleted_count': deleted_count}

    except Exception as exc:
        logger.error(f"Erreur nettoyage événements suivi: {exc}")
        raise self.retry(exc=exc, countdown=60)


# ============================================================================
# TÂCHES DE NOTIFICATION ET RAPPEL
# ============================================================================

@shared_task(bind=True, max_retries=3)
def send_delivery_reminders(self):
    """
    Envoyer des rappels pour les livraisons à venir
    """
    try:
        # Missions avec livraison dans les 24 heures
        upcoming_missions = Mission.objects.filter(
            status__in=[MissionStatus.IN_TRANSIT, MissionStatus.OUT_FOR_DELIVERY],
            estimated_delivery__range=[
                timezone.now(),
                timezone.now() + timezone.timedelta(hours=24)
            ]
        ).select_related('reservation', 'reservation__buyer', 'carrier', 'carrier__user')

        count = 0

        for mission in upcoming_missions:
            # Notification à l'acheteur
            Notification.objects.create(
                user=mission.reservation.buyer,
                title=_("Livraison prévue bientôt"),
                message=_("Votre objet '{}' est prévu pour livraison le {}.").format(
                    mission.reservation.ad.title,
                    mission.estimated_delivery.strftime('%d/%m/%Y à %H:%M')
                ),
                url=mission.get_absolute_url(),
                notification_type='DELIVERY_REMINDER'
            )

            # Notification au transporteur
            Notification.objects.create(
                user=mission.carrier.user,
                title=_("Livraison prévue"),
                message=_("La livraison pour '{}' est prévue le {}.").format(
                    mission.reservation.ad.title,
                    mission.estimated_delivery.strftime('%d/%m/%Y à %H:%M')
                ),
                url=mission.get_absolute_url(),
                notification_type='DELIVERY_REMINDER'
            )

            count += 1

        logger.info(f"Envoyé {count} rappels de livraison")
        return {'reminders_sent': count}

    except Exception as exc:
        logger.error(f"Erreur envoi rappels livraison: {exc}")
        raise self.retry(exc=exc, countdown=60)


@shared_task(bind=True, max_retries=3)
def send_payment_reminders(self):
    """
    Envoyer des rappels pour les paiements en attente
    """
    try:
        # Réservations avec paiement en attente depuis plus de 24h
        unpaid_reservations = Reservation.objects.filter(
            status=ReservationStatus.PAYMENT_PENDING,
            created_at__lt=timezone.now() - timezone.timedelta(hours=24)
        ).select_related('buyer', 'ad')

        count = 0

        for reservation in unpaid_reservations:
            Notification.objects.create(
                user=reservation.buyer,
                title=_("Paiement en attente"),
                message=_("Votre réservation pour '{}' attend votre paiement.").format(
                    reservation.ad.title
                ),
                url=reservation.get_absolute_url(),
                notification_type='PAYMENT_REMINDER'
            )

            count += 1

        logger.info(f"Envoyé {count} rappels de paiement")
        return {'reminders_sent': count}

    except Exception as exc:
        logger.error(f"Erreur envoi rappels paiement: {exc}")
        raise self.retry(exc=exc, countdown=60)


@shared_task(bind=True, max_retries=3)
def send_proposal_expiry_warnings(self, days_before=2):
    """
    Avertir les transporteurs de l'expiration proche de leurs propositions
    """
    try:
        expiry_threshold = timezone.now() + timezone.timedelta(days=days_before)

        expiring_proposals = TransportProposal.objects.filter(
            status=TransportProposalStatus.PENDING,
            expires_at__range=[timezone.now(), expiry_threshold]
        ).select_related('carrier', 'carrier__user', 'ad')

        count = 0

        for proposal in expiring_proposals:
            days_left = (proposal.expires_at - timezone.now()).days

            Notification.objects.create(
                user=proposal.carrier.user,
                title=_("Proposition expirant bientôt"),
                message=_("Votre proposition pour '{}' expire dans {} jours.").format(
                    proposal.ad.title, days_left
                ),
                url=proposal.get_absolute_url(),
                notification_type='PROPOSAL_EXPIRY_WARNING'
            )

            count += 1

        logger.info(f"Envoyé {count} avertissements d'expiration de propositions")
        return {'warnings_sent': count}

    except Exception as exc:
        logger.error(f"Erreur envoi avertissements expiration: {exc}")
        raise self.retry(exc=exc, countdown=60)


# ============================================================================
# TÂCHES DE STATISTIQUES ET RAPPORTS
# ============================================================================

@shared_task(bind=True, max_retries=3)
def update_daily_statistics(self):
    """
    Mettre à jour les statistiques quotidiennes
    """
    try:
        today = timezone.now().date()
        yesterday = today - timezone.timedelta(days=1)

        # Statistiques des réservations
        reservation_stats = {
            'date': today.isoformat(),
            'total_reservations': Reservation.objects.count(),
            'new_today': Reservation.objects.filter(created_at__date=today).count(),
            'completed_today': Reservation.objects.filter(
                status=ReservationStatus.DELIVERED,
                actual_delivery_date=today
            ).count(),
            'cancelled_today': Reservation.objects.filter(
                status=ReservationStatus.CANCELLED,
                cancelled_at__date=today
            ).count(),
            'revenue_today': Reservation.objects.filter(
                status=ReservationStatus.DELIVERED,
                actual_delivery_date=today
            ).aggregate(total=Sum('total_price'))['total'] or 0
        }

        # Statistiques des missions
        mission_stats = {
            'date': today.isoformat(),
            'total_missions': Mission.objects.count(),
            'active_missions': Mission.objects.filter(
                status__in=[
                    MissionStatus.SCHEDULED, MissionStatus.PICKUP_PENDING,
                    MissionStatus.PICKED_UP, MissionStatus.IN_TRANSIT,
                    MissionStatus.OUT_FOR_DELIVERY
                ]
            ).count(),
            'delivered_today': Mission.objects.filter(
                status=MissionStatus.DELIVERED,
                actual_delivery__date=today
            ).count(),
            'delayed_missions': Mission.objects.filter(
                status=MissionStatus.DELAYED
            ).count()
        }

        # Statistiques des routes
        route_stats = {
            'date': today.isoformat(),
            'total_routes': Route.objects.count(),
            'active_routes': Route.objects.filter(status=RouteStatus.ACTIVE).count(),
            'routes_today': Route.objects.filter(departure_date=today).count(),
            'available_capacity': Route.objects.filter(
                status=RouteStatus.ACTIVE
            ).aggregate(
                total_weight=Sum('available_weight'),
                total_volume=Sum('available_volume')
            )
        }

        # Mettre en cache
        cache_key = f'logistics_daily_stats_{today}'
        cache.set(cache_key, {
            'reservations': reservation_stats,
            'missions': mission_stats,
            'routes': route_stats,
            'updated_at': timezone.now().isoformat()
        }, timeout=86400)  # 24 heures

        logger.info(f"Statistiques quotidiennes mises à jour pour {today}")
        return {
            'reservation_stats': reservation_stats,
            'mission_stats': mission_stats,
            'route_stats': route_stats
        }

    except Exception as exc:
        logger.error(f"Erreur mise à jour statistiques: {exc}")
        raise self.retry(exc=exc, countdown=60)


@shared_task(bind=True, max_retries=3)
def generate_weekly_report(self):
    """
    Générer un rapport hebdomadaire pour les administrateurs
    """
    try:
        from django.template.loader import render_to_string
        from django.core.mail import EmailMultiAlternatives

        week_start = timezone.now() - timezone.timedelta(days=7)

        # Données du rapport
        report_data = {
            'period': f"{week_start.date()} - {timezone.now().date()}",
            'reservations': {
                'total': Reservation.objects.filter(created_at__gte=week_start).count(),
                'by_status': Reservation.objects.filter(
                    created_at__gte=week_start
                ).values('status').annotate(count=Count('id')),
                'revenue': Reservation.objects.filter(
                    created_at__gte=week_start,
                    status=ReservationStatus.DELIVERED
                ).aggregate(total=Sum('total_price'))['total'] or 0
            },
            'missions': {
                'completed': Mission.objects.filter(
                    status=MissionStatus.DELIVERED,
                    actual_delivery__gte=week_start
                ).count(),
                'in_progress': Mission.objects.filter(
                    status__in=[
                        MissionStatus.SCHEDULED, MissionStatus.PICKUP_PENDING,
                        MissionStatus.PICKED_UP, MissionStatus.IN_TRANSIT,
                        MissionStatus.OUT_FOR_DELIVERY
                    ]
                ).count()
            },
            'routes': {
                'created': Route.objects.filter(created_at__gte=week_start).count(),
                'active': Route.objects.filter(status=RouteStatus.ACTIVE).count()
            },
            'top_carriers': Mission.objects.filter(
                actual_delivery__gte=week_start
            ).values(
                'carrier__user__username',
                'carrier__company_name'
            ).annotate(
                missions=Count('id'),
                revenue=Sum('reservation__shipping_cost')
            ).order_by('-revenue')[:5]
        }

        # Rendre le template HTML
        html_content = render_to_string('logistics/emails/weekly_report.html', {
            'report': report_data
        })

        # Envoyer aux administrateurs
        from django.contrib.auth import get_user_model
        User = get_user_model()
        admins = User.objects.filter(is_staff=True, is_active=True)

        for admin in admins:
            email = EmailMultiAlternatives(
                subject=f"Rapport hebdomadaire logistique - {report_data['period']}",
                body="Veuillez activer HTML pour voir ce message.",
                from_email=settings.DEFAULT_FROM_EMAIL,
                to=[admin.email]
            )
            email.attach_alternative(html_content, "text/html")
            email.send()

        logger.info(f"Rapport hebdomadaire généré pour {report_data['period']}")
        return {'report_sent': True, 'admin_count': admins.count()}

    except Exception as exc:
        logger.error(f"Erreur génération rapport: {exc}")
        raise self.retry(exc=exc, countdown=60)


@shared_task(bind=True, max_retries=3)
def update_carrier_ratings(self):
    """
    Recalculer les notes moyennes des transporteurs
    """
    try:
        from carriers.models import CarrierProfile
        from reviews.models import Review  # Supposant qu'une app reviews existe

        carriers = CarrierProfile.objects.all()

        for carrier in carriers:
            # Calculer la note moyenne à partir des avis
            reviews = Review.objects.filter(
                mission__carrier=carrier,
                mission__status=MissionStatus.DELIVERED
            )

            if reviews.exists():
                avg_rating = reviews.aggregate(
                    avg_communication=Avg('communication'),
                    avg_punctuality=Avg('punctuality'),
                    avg_handling=Avg('handling'),
                    avg_professionalism=Avg('professionalism')
                )

                # Calculer la note globale
                overall_rating = (
                    avg_rating['avg_communication'] +
                    avg_rating['avg_punctuality'] +
                    avg_rating['avg_handling'] +
                    avg_rating['avg_professionalism']
                ) / 4

                carrier.average_rating = round(overall_rating, 1)
                carrier.total_reviews = reviews.count()
                carrier.save(update_fields=['average_rating', 'total_reviews', 'updated_at'])

        logger.info(f"Notes de {carriers.count()} transporteurs mises à jour")
        return {'carriers_updated': carriers.count()}

    except Exception as exc:
        logger.error(f"Erreur mise à jour notes transporteurs: {exc}")
        raise self.retry(exc=exc, countdown=60)


# ============================================================================
# TÂCHES D'INTÉGRATION ET SYNCHRONISATION
# ============================================================================

@shared_task(bind=True, max_retries=3)
def sync_with_shipping_apis(self):
    """
    Synchroniser avec les APIs de transport externes
    """
    try:
        # Missions en transit qui pourraient avoir un suivi externe
        missions = Mission.objects.filter(
            status=MissionStatus.IN_TRANSIT,
            tracking_number__isnull=False
        ).select_related('reservation')

        updated_count = 0

        for mission in missions:
            # Ici, on intègrerait avec une API de transporteur
            # Exemple: DHL, UPS, FedEx, etc.
            # Pour l'instant, c'est un placeholder

            # Simuler une mise à jour
            # En production, on appellerait l'API du transporteur
            pass

        logger.info(f"Synchronisé {updated_count} missions avec APIs externes")
        return {'missions_synced': updated_count}

    except Exception as exc:
        logger.error(f"Erreur synchronisation APIs: {exc}")
        raise self.retry(exc=exc, countdown=60)


@shared_task(bind=True, max_retries=3)
def calculate_route_distances(self):
    """
    Calculer les distances pour les routes sans distance
    """
    try:
        from geopy.distance import geodesic

        routes_without_distance = Route.objects.filter(
            distance_km__isnull=True
        ).select_related('start_country', 'end_country')

        updated_count = 0

        for route in routes_without_distance:
            try:
                # Pour l'exemple, utiliser des coordonnées fictives
                # En production, utiliser geocoding pour obtenir les coordonnées
                start_coords = (48.8566, 2.3522)  # Paris
                end_coords = (51.5074, -0.1278)   # Londres

                distance = geodesic(start_coords, end_coords).kilometers
                route.distance_km = round(distance, 2)
                route.save(update_fields=['distance_km', 'updated_at'])

                updated_count += 1

            except Exception as e:
                logger.warning(f"Erreur calcul distance route {route.id}: {e}")
                continue

        logger.info(f"Calculé distances pour {updated_count} routes")
        return {'routes_updated': updated_count}

    except Exception as exc:
        logger.error(f"Erreur calcul distances routes: {exc}")
        raise self.retry(exc=exc, countdown=60)


# ============================================================================
# TÂCHES DE SAUVEGARDE ET BACKUP
# ============================================================================

@shared_task(bind=True, max_retries=3)
def backup_logistics_data(self):
    """
    Sauvegarder les données logistiques importantes
    """
    try:
        import json
        from django.core.files.storage import default_storage
        from django.core.serializers import serialize

        timestamp = timezone.now().strftime('%Y%m%d_%H%M%S')

        # Données à sauvegarder
        data_to_backup = {
            'timestamp': timestamp,
            'reservations': json.loads(serialize('json', Reservation.objects.all()[:1000])),
            'missions': json.loads(serialize('json', Mission.objects.all()[:1000])),
            'routes': json.loads(serialize('json', Route.objects.all()[:1000])),
            'statistics': {
                'total_reservations': Reservation.objects.count(),
                'total_missions': Mission.objects.count(),
                'total_routes': Route.objects.count(),
                'active_missions': Mission.objects.filter(
                    status__in=['IN_TRANSIT', 'OUT_FOR_DELIVERY']
                ).count()
            }
        }

        # Sauvegarder dans un fichier
        backup_filename = f'logistics_backup_{timestamp}.json'
        backup_content = json.dumps(data_to_backup, indent=2, ensure_ascii=False)

        # Sauvegarder dans le stockage par défaut
        default_storage.save(f'backups/{backup_filename}', backup_content)

        logger.info(f"Sauvegarde créée: {backup_filename}")
        return {'backup_filename': backup_filename}

    except Exception as exc:
        logger.error(f"Erreur sauvegarde données: {exc}")
        raise self.retry(exc=exc, countdown=60)


# ============================================================================
# TÂCHES DE SURVEILLANCE ET ALERTES
# ============================================================================

@shared_task(bind=True, max_retries=3)
def monitor_system_health(self):
    """
    Surveiller la santé du système logistique
    """
    try:
        alerts = []

        # Vérifier les missions en retard
        delayed_missions = Mission.objects.filter(
            status__in=[MissionStatus.IN_TRANSIT, MissionStatus.OUT_FOR_DELIVERY],
            estimated_delivery__lt=timezone.now()
        ).count()

        if delayed_missions > 0:
            alerts.append({
                'type': 'DELAYED_MISSIONS',
                'count': delayed_missions,
                'message': f"{delayed_missions} missions sont en retard"
            })

        # Vérifier les réservations en attente de paiement
        unpaid_count = Reservation.objects.filter(
            status=ReservationStatus.PAYMENT_PENDING,
            created_at__lt=timezone.now() - timezone.timedelta(hours=48)
        ).count()

        if unpaid_count > 0:
            alerts.append({
                'type': 'UNPAID_RESERVATIONS',
                'count': unpaid_count,
                'message': f"{unpaid_count} réservations attendent un paiement depuis plus de 48h"
            })

        # Vérifier les routes sans capacité
        full_routes = Route.objects.filter(
            status=RouteStatus.ACTIVE,
            available_weight=0,
            available_volume=0
        ).count()

        if full_routes > 0:
            alerts.append({
                'type': 'FULL_ROUTES',
                'count': full_routes,
                'message': f"{full_routes} routes sont pleines mais toujours marquées comme actives"
            })

        # Enregistrer les alertes
        if alerts:
            cache_key = 'logistics_health_alerts'
            cache.set(cache_key, alerts, timeout=3600)  # 1 heure

            # Notifier les administrateurs si nécessaire
            if len(alerts) > 3:  # Seuil configurable
                from django.contrib.auth import get_user_model
                User = get_user_model()

                for admin in User.objects.filter(is_staff=True, is_superuser=True):
                    Notification.objects.create(
                        user=admin,
                        title=_("Alertes système logistique"),
                        message=_("{} problèmes détectés dans le système logistique.").format(len(alerts)),
                        url='/admin/logistics/',
                        notification_type='SYSTEM_ALERT',
                        priority='HIGH'
                    )

        logger.info(f"Surveillance système: {len(alerts)} alertes détectées")
        return {'alerts': alerts, 'alert_count': len(alerts)}

    except Exception as exc:
        logger.error(f"Erreur surveillance système: {exc}")
        raise self.retry(exc=exc, countdown=60)


# ============================================================================
# CONFIGURATION DES TÂCHES PÉRIODIQUES
# ============================================================================

CELERY_BEAT_SCHEDULE = {
    # Nettoyage quotidien
    'expire-old-reservations': {
        'task': 'logistics.tasks.expire_old_reservations',
        'schedule': 3600,  # Toutes les heures
    },
    'expire-old-proposals': {
        'task': 'logistics.tasks.expire_old_proposals',
        'schedule': 3600,  # Toutes les heures
    },
    'update-route-statuses': {
        'task': 'logistics.tasks.update_route_statuses',
        'schedule': 1800,  # Toutes les 30 minutes
    },

    # Notifications
    'send-delivery-reminders': {
        'task': 'logistics.tasks.send_delivery_reminders',
        'schedule': 3600,  # Toutes les heures
    },
    'send-payment-reminders': {
        'task': 'logistics.tasks.send_payment_reminders',
        'schedule': 7200,  # Toutes les 2 heures
    },
    'send-proposal-expiry-warnings': {
        'task': 'logistics.tasks.send_proposal_expiry_warnings',
        'schedule': 86400,  # Tous les jours
    },

    # Statistiques
    'update-daily-statistics': {
        'task': 'logistics.tasks.update_daily_statistics',
        'schedule': 300,  # Toutes les 5 minutes
    },
    'generate-weekly-report': {
        'task': 'logistics.tasks.generate_weekly_report',
        'schedule': 604800,  # Toutes les semaines
    },
    'update-carrier-ratings': {
        'task': 'logistics.tasks.update_carrier_ratings',
        'schedule': 86400,  # Tous les jours
    },

    # Maintenance
    'cleanup-old-tracking-events': {
        'task': 'logistics.tasks.cleanup_old_tracking_events',
        'schedule': 86400,  # Tous les jours
    },
    'calculate-route-distances': {
        'task': 'logistics.tasks.calculate_route_distances',
        'schedule': 43200,  # Toutes les 12 heures
    },

    # Surveillance
    'monitor-system-health': {
        'task': 'logistics.tasks.monitor_system_health',
        'schedule': 900,  # Toutes les 15 minutes
    },

    # Sauvegarde
    'backup-logistics-data': {
        'task': 'logistics.tasks.backup_logistics_data',
        'schedule': 86400,  # Tous les jours
    },
}


========== logistics/urls.py ==========
# ~/ebi3/logistics/urls.py

from django.urls import path, include
from django.views.generic import RedirectView
from . import views

app_name = 'logistics'

urlpatterns = [
    # Dashboard et page d'accueil
    path('', views.LogisticsDashboardView.as_view(), name='dashboard'),
    path('dashboard/', RedirectView.as_view(pattern_name='logistics:dashboard'), name='dashboard_redirect'),

    # Réservations
    path('reservations/', views.ReservationListView.as_view(), name='reservation_list'),
    path('reservations/create/<slug:slug>/', views.ReservationCreateView.as_view(), name='reservation_create'),
    path('reservations/create-with-route/<int:route_id>/', views.reservation_create_with_route, name='reservation_create_with_route'),
    path('reservations/<int:pk>/', views.ReservationDetailView.as_view(), name='reservation_detail'),
    path('reservations/<int:pk>/edit/', views.ReservationUpdateView.as_view(), name='reservation_update'),
    path('reservations/<int:pk>/cancel/', views.ReservationCancelView.as_view(), name='reservation_cancel'),
    path('reservations/<int:pk>/update-status/', views.ReservationStatusUpdateView.as_view(), name='reservation_update_status'),
    path('reservations/<int:pk>/quick-pay/', views.ReservationStatusUpdateView.as_view(), name='reservation_quick_pay'),  # Pour paiement rapide

    # Missions
    path('missions/', views.MissionListView.as_view(), name='mission_list'),
    path('missions/<int:pk>/', views.MissionDetailView.as_view(), name='mission_detail'),
    path('missions/<int:pk>/update/', views.MissionUpdateView.as_view(), name='mission_update'),
    path('missions/<int:mission_id>/tracking/', views.TrackingEventCreateView.as_view(), name='tracking_event_create'),

    # Routes
    path('routes/', views.RouteListView.as_view(), name='route_list'),
    path('routes/create/', views.RouteCreateView.as_view(), name='route_create'),
    path('routes/<int:pk>/', views.RouteDetailView.as_view(), name='route_detail'),
    path('routes/<int:pk>/edit/', views.RouteUpdateView.as_view(), name='route_update'),
    path('routes/<int:pk>/delete/', views.RouteDeleteView.as_view(), name='route_delete'),
    path('routes/<int:pk>/book/', views.RouteDetailView.as_view(), name='route_book'),  # POST seulement

    # Propositions de transport
    path('proposals/', views.MyProposalsListView.as_view(), name='proposal_list'),
    path('proposals/create/<slug:slug>/', views.TransportProposalCreateView.as_view(), name='proposal_create'),
    path('proposals/<int:pk>/', views.TransportProposalDetailView.as_view(), name='proposal_detail'),
    path('proposals/<int:pk>/respond/', views.TransportProposalRespondView.as_view(), name='proposal_respond'),
    path('proposals/<int:pk>/cancel/', views.cancel_proposal, name='proposal_cancel'),

    # API pour suivi en temps réel
    path('api/tracking/<int:pk>/', views.TrackingAPIView.as_view(), name='tracking_api'),
    path('api/update-location/<int:mission_id>/', views.update_location_api, name='update_location_api'),

    # Notifications
    path('notifications/', views.logistics_notifications, name='notifications'),

    # Administration et paramètres
    path('settings/', views.LogisticsSettingsView.as_view(), name='settings'),
    path('reports/', views.LogisticsReportsView.as_view(), name='reports'),

    # Pages d'information
    path('faq/', views.LogisticsFAQView.as_view(), name='faq'),
    path('guide/', views.LogisticsGuideView.as_view(), name='guide'),

    # API REST (pour développement futur)
    path('api/v1/', include([
        path('reservations/', views.ReservationListView.as_view(), name='api_reservation_list'),
        path('reservations/<int:pk>/', views.ReservationDetailView.as_view(), name='api_reservation_detail'),
        path('missions/', views.MissionListView.as_view(), name='api_mission_list'),
        path('missions/<int:pk>/', views.MissionDetailView.as_view(), name='api_mission_detail'),
        path('routes/', views.RouteListView.as_view(), name='api_route_list'),
        path('routes/<int:pk>/', views.RouteDetailView.as_view(), name='api_route_detail'),
    ])),
]

# URLs spécifiques pour les intégrations avec d'autres apps
integration_urls = [
    # Intégration avec ads - pour créer des réservations depuis les annonces
    path('ad/<slug:slug>/reserve/', views.ReservationCreateView.as_view(), name='ad_reserve'),

    # Intégration avec carriers - pour voir les missions d'un transporteur
    path('carrier/<str:username>/missions/', views.MissionListView.as_view(), name='carrier_missions'),

    # Intégration avec users - pour voir les réservations d'un utilisateur
    path('user/<str:username>/reservations/', views.ReservationListView.as_view(), name='user_reservations'),
]

urlpatterns += integration_urls

# URLs de debug/development (à désactiver en production)
debug_urls = [
    path('test/notifications/', views.logistics_notifications, name='test_notifications'),
    path('test/api/', views.TrackingAPIView.as_view(), name='test_api'),
]

# Ajouter les URLs de debug si en mode développement
import sys
if 'runserver' in sys.argv or 'test' in sys.argv:
    urlpatterns += debug_urls


========== logistics/models.py ==========
# ~/ebi3/logistics/models.py

from django.db import models
from django.conf import settings
from django.core.validators import MinValueValidator, MaxValueValidator
from django.utils import timezone
from django.core.exceptions import ValidationError
from django.utils.translation import gettext_lazy as _

# Import des apps existantes
from ads.models import Ad
from carriers.models import Carrier  # CORRECTION: Carrier au lieu de CarrierProfile
from core.models import Country, City


class LogisticsOption(models.TextChoices):
    """Options logistiques disponibles"""
    P2P_DIRECT = 'P2P_DIRECT', _('Direct entre particuliers')
    WITH_CARRIER = 'WITH_CARRIER', _('Avec transporteur')
    WITH_EXPAT_CARRIER = 'WITH_EXPAT_CARRIER', _('Avec expatrié-transporteur')


class ReservationStatus(models.TextChoices):
    """Statuts d'une réservation"""
    PENDING = 'PENDING', _('En attente')
    CONFIRMED = 'CONFIRMED', _('Confirmée')
    PAYMENT_PENDING = 'PAYMENT_PENDING', _('Paiement en attente')
    PAID = 'PAID', _('Payée')
    IN_TRANSIT = 'IN_TRANSIT', _('En transit')
    DELIVERED = 'DELIVERED', _('Livrée')
    CANCELLED = 'CANCELLED', _('Annulée')
    DISPUTED = 'DISPUTED', _('En litige')
    REFUNDED = 'REFUNDED', _('Remboursée')


class Reservation(models.Model):
    """
    Réservation d'une annonce avec option logistique
    """
    ad = models.ForeignKey(
        Ad,
        on_delete=models.CASCADE,
        related_name='reservations',
        verbose_name=_('Annonce')
    )
    buyer = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='purchases',
        verbose_name=_('Acheteur')
    )
    carrier = models.ForeignKey(
        Carrier,  # CORRECTION: Carrier au lieu de CarrierProfile
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='logistics_routes',
        verbose_name=_('Transporteur')
    )

    # Informations logistiques
    logistics_option = models.CharField(
        max_length=20,
        choices=LogisticsOption.choices,
        verbose_name=_('Option logistique')
    )
    pickup_address = models.TextField(
        verbose_name=_('Adresse de prise en charge'),
        blank=True
    )
    delivery_address = models.TextField(
        verbose_name=_('Adresse de livraison'),
        blank=True
    )

    # Dates
    pickup_date = models.DateField(
        verbose_name=_('Date de prise en charge'),
        null=True,
        blank=True
    )
    delivery_date = models.DateField(
        verbose_name=_('Date de livraison estimée'),
        null=True,
        blank=True
    )
    actual_delivery_date = models.DateField(
        verbose_name=_('Date de livraison réelle'),
        null=True,
        blank=True
    )

    # Prix et paiement
    price_agreed = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_('Prix convenu'),
        validators=[MinValueValidator(0)]
    )
    shipping_cost = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_('Coût du transport'),
        default=0,
        validators=[MinValueValidator(0)]
    )
    insurance_cost = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_('Coût assurance'),
        default=0,
        validators=[MinValueValidator(0)]
    )
    total_price = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_('Prix total'),
        validators=[MinValueValidator(0)]
    )

    # Statut
    status = models.CharField(
        max_length=20,
        choices=ReservationStatus.choices,
        default=ReservationStatus.PENDING,
        verbose_name=_('Statut')
    )

    # Suivi
    tracking_number = models.CharField(
        max_length=100,
        verbose_name=_('Numéro de suivi'),
        blank=True
    )

    # Paiement
    is_paid = models.BooleanField(
        default=False,
        verbose_name=_('Payé')
    )
    payment_method = models.CharField(
        max_length=50,
        verbose_name=_('Méthode de paiement'),
        blank=True
    )
    payment_date = models.DateTimeField(
        verbose_name=_('Date de paiement'),
        null=True,
        blank=True
    )
    payment_reference = models.CharField(
        max_length=100,
        verbose_name=_('Référence paiement'),
        blank=True
    )

    # Assurance
    requires_insurance = models.BooleanField(
        default=False,
        verbose_name=_('Assurance requise')
    )
    insurance_value = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_('Valeur assurée'),
        null=True,
        blank=True,
        validators=[MinValueValidator(0)]
    )

    # Emballage
    requires_packaging = models.BooleanField(
        default=False,
        verbose_name=_('Emballage requis')
    )
    packaging_details = models.TextField(
        verbose_name=_('Détails emballage'),
        blank=True
    )

    # Notes
    buyer_notes = models.TextField(
        verbose_name=_('Notes acheteur'),
        blank=True
    )
    seller_notes = models.TextField(
        verbose_name=_('Notes vendeur'),
        blank=True
    )
    carrier_notes = models.TextField(
        verbose_name=_('Notes transporteur'),
        blank=True
    )

    # Métadonnées
    created_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name=_('Date de création')
    )
    updated_at = models.DateTimeField(
        auto_now=True,
        verbose_name=_('Date de modification')
    )
    cancelled_at = models.DateTimeField(
        verbose_name=_('Date d\'annulation'),
        null=True,
        blank=True
    )
    cancelled_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='cancelled_reservations',
        verbose_name=_('Annulé par')
    )
    cancellation_reason = models.TextField(
        verbose_name=_('Raison annulation'),
        blank=True
    )

    class Meta:
        verbose_name = _('Réservation')
        verbose_name_plural = _('Réservations')
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status']),
            models.Index(fields=['buyer', 'status']),
            models.Index(fields=['ad', 'status']),
            models.Index(fields=['created_at']),
        ]

    def __str__(self):
        return f"Réservation #{self.id} - {self.ad.title}"

    def clean(self):
        """Validation personnalisée"""
        super().clean()

        # Vérifier que l'acheteur n'est pas le vendeur
        if self.buyer == self.ad.seller:
            raise ValidationError(_("Vous ne pouvez pas réserver votre propre annonce."))

        # Vérifier la date de livraison
        if self.delivery_date and self.pickup_date:
            if self.delivery_date < self.pickup_date:
                raise ValidationError(_("La date de livraison doit être après la date de prise en charge."))

        # Vérifier l'option logistique
        if self.logistics_option == LogisticsOption.WITH_CARRIER and not self.carrier:
            raise ValidationError(_("Une option avec transporteur nécessite un transporteur."))

        # Calcul du prix total
        self.total_price = self.price_agreed + self.shipping_cost + self.insurance_cost

    def save(self, *args, **kwargs):
        self.full_clean()
        super().save(*args, **kwargs)

    def get_absolute_url(self):
        from django.urls import reverse
        return reverse('logistics:reservation_detail', kwargs={'pk': self.pk})

    @property
    def can_be_cancelled(self):
        """Vérifie si la réservation peut être annulée"""
        cancellable_statuses = [
            ReservationStatus.PENDING,
            ReservationStatus.CONFIRMED,
            ReservationStatus.PAYMENT_PENDING
        ]
        return self.status in cancellable_statuses

    @property
    def is_active(self):
        """Vérifie si la réservation est active"""
        active_statuses = [
            ReservationStatus.PENDING,
            ReservationStatus.CONFIRMED,
            ReservationStatus.PAYMENT_PENDING,
            ReservationStatus.PAID,
            ReservationStatus.IN_TRANSIT
        ]
        return self.status in active_statuses

    @property
    def days_since_creation(self):
        """Nombre de jours depuis la création"""
        return (timezone.now() - self.created_at).days


class MissionStatus(models.TextChoices):
    """Statuts d'une mission de transport"""
    SCHEDULED = 'SCHEDULED', _('Planifiée')
    PICKUP_PENDING = 'PICKUP_PENDING', _('En attente de prise en charge')
    PICKED_UP = 'PICKED_UP', _('Pris en charge')
    IN_TRANSIT = 'IN_TRANSIT', _('En transit')
    AT_HUB = 'AT_HUB', _('Au centre de tri')
    OUT_FOR_DELIVERY = 'OUT_FOR_DELIVERY', _('En cours de livraison')
    DELIVERY_PENDING = 'DELIVERY_PENDING', _('En attente de livraison')
    DELIVERED = 'DELIVERED', _('Livrée')
    CANCELLED = 'CANCELLED', _('Annulée')
    DELAYED = 'DELAYED', _('Retardée')


class Mission(models.Model):
    """
    Mission de transport pour une réservation
    """
    reservation = models.OneToOneField(
        Reservation,
        on_delete=models.CASCADE,
        related_name='mission',
        verbose_name=_('Réservation')
    )
    carrier = models.ForeignKey(
        Carrier,  # CORRECTION: Carrier au lieu de CarrierProfile
        on_delete=models.CASCADE,
        related_name='missions',
        verbose_name=_('Transporteur')
    )

    # Statut
    status = models.CharField(
        max_length=20,
        choices=MissionStatus.choices,
        default=MissionStatus.SCHEDULED,
        verbose_name=_('Statut')
    )

    # Localisation
    current_location = models.CharField(
        max_length=200,
        verbose_name=_('Localisation actuelle'),
        blank=True
    )
    latitude = models.FloatField(
        verbose_name=_('Latitude'),
        null=True,
        blank=True
    )
    longitude = models.FloatField(
        verbose_name=_('Longitude'),
        null=True,
        blank=True
    )

    # Dates
    scheduled_pickup = models.DateTimeField(
        verbose_name=_('Prise en charge planifiée'),
        null=True,
        blank=True
    )
    actual_pickup = models.DateTimeField(
        verbose_name=_('Prise en charge réelle'),
        null=True,
        blank=True
    )
    estimated_delivery = models.DateTimeField(
        verbose_name=_('Livraison estimée'),
        null=True,
        blank=True
    )
    actual_delivery = models.DateTimeField(
        verbose_name=_('Livraison réelle'),
        null=True,
        blank=True
    )

    # Distance
    distance_km = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_('Distance (km)'),
        null=True,
        blank=True,
        validators=[MinValueValidator(0)]
    )

    # Documents
    pickup_confirmation = models.FileField(
        upload_to='missions/pickup_confirmations/',
        verbose_name=_('Confirmation prise en charge'),
        null=True,
        blank=True
    )
    delivery_confirmation = models.FileField(
        upload_to='missions/delivery_confirmations/',
        verbose_name=_('Confirmation livraison'),
        null=True,
        blank=True
    )

    # Notes
    notes = models.TextField(
        verbose_name=_('Notes'),
        blank=True
    )
    delay_reason = models.TextField(
        verbose_name=_('Raison du retard'),
        blank=True
    )

    # Métadonnées
    created_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name=_('Date de création')
    )
    updated_at = models.DateTimeField(
        auto_now=True,
        verbose_name=_('Date de modification')
    )

    class Meta:
        verbose_name = _('Mission')
        verbose_name_plural = _('Missions')
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status']),
            models.Index(fields=['carrier', 'status']),
            models.Index(fields=['estimated_delivery']),
        ]

    def __str__(self):
        return f"Mission #{self.id} - {self.reservation.ad.title}"

    @property
    def is_delayed(self):
        """Vérifie si la mission est en retard"""
        if self.estimated_delivery and not self.actual_delivery:
            return timezone.now() > self.estimated_delivery
        return False

    @property
    def progress_percentage(self):
        """Pourcentage de progression de la mission"""
        status_progress = {
            MissionStatus.SCHEDULED: 10,
            MissionStatus.PICKUP_PENDING: 20,
            MissionStatus.PICKED_UP: 40,
            MissionStatus.IN_TRANSIT: 60,
            MissionStatus.AT_HUB: 70,
            MissionStatus.OUT_FOR_DELIVERY: 80,
            MissionStatus.DELIVERY_PENDING: 90,
            MissionStatus.DELIVERED: 100,
            MissionStatus.CANCELLED: 0,
            MissionStatus.DELAYED: 50,  # Réduit si retardé
        }
        return status_progress.get(self.status, 0)


class TrackingEventType(models.TextChoices):
    """Types d'événements de suivi"""
    PICKUP_SCHEDULED = 'PICKUP_SCHEDULED', _('Prise en charge planifiée')
    PICKUP_CONFIRMED = 'PICKUP_CONFIRMED', _('Prise en charge confirmée')
    PICKUP_COMPLETED = 'PICKUP_COMPLETED', _('Prise en charge effectuée')
    IN_TRANSIT = 'IN_TRANSIT', _('En transit')
    ARRIVED_AT_HUB = 'ARRIVED_AT_HUB', _('Arrivé au centre de tri')
    DEPARTED_FROM_HUB = 'DEPARTED_FROM_HUB', _('Départ du centre de tri')
    OUT_FOR_DELIVERY = 'OUT_FOR_DELIVERY', _('En cours de livraison')
    DELIVERY_ATTEMPTED = 'DELIVERY_ATTEMPTED', _('Tentative de livraison')
    DELIVERY_RESCHEDULED = 'DELIVERY_RESCHEDULED', _('Livraison reprogrammée')
    DELIVERED = 'DELIVERED', _('Livré')
    DELAYED = 'DELAYED', _('Retardé')
    CUSTOMS_CLEARANCE = 'CUSTOMS_CLEARANCE', _('Dédouanement')
    CUSTOMS_HELD = 'CUSTOMS_HELD', _('Retenu en douane')
    ISSUE_REPORTED = 'ISSUE_REPORTED', _('Problème signalé')
    ISSUE_RESOLVED = 'ISSUE_RESOLVED', _('Problème résolu')


class TrackingEvent(models.Model):
    """
    Événement de suivi pour une mission
    """
    mission = models.ForeignKey(
        Mission,
        on_delete=models.CASCADE,
        related_name='tracking_events',
        verbose_name=_('Mission')
    )
    event_type = models.CharField(
        max_length=50,
        choices=TrackingEventType.choices,
        verbose_name=_('Type d\'événement')
    )
    description = models.TextField(
        verbose_name=_('Description')
    )
    location = models.CharField(
        max_length=200,
        verbose_name=_('Localisation'),
        blank=True
    )
    latitude = models.FloatField(
        verbose_name=_('Latitude'),
        null=True,
        blank=True
    )
    longitude = models.FloatField(
        verbose_name=_('Longitude'),
        null=True,
        blank=True
    )

    # Photos/Preuves
    photo = models.ImageField(
        upload_to='tracking/events/',
        verbose_name=_('Photo'),
        null=True,
        blank=True
    )

    # Métadonnées
    created_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name=_('Date de création')
    )
    created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        verbose_name=_('Créé par')
    )

    class Meta:
        verbose_name = _('Événement de suivi')
        verbose_name_plural = _('Événements de suivi')
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['mission', 'created_at']),
            models.Index(fields=['event_type']),
        ]

    def __str__(self):
        return f"{self.get_event_type_display()} - {self.created_at.strftime('%d/%m/%Y %H:%M')}"


class RouteStatus(models.TextChoices):
    """Statuts d'une route"""
    ACTIVE = 'ACTIVE', _('Active')
    FULL = 'FULL', _('Complète')
    IN_TRANSIT = 'IN_TRANSIT', _('En transit')
    COMPLETED = 'COMPLETED', _('Terminée')
    CANCELLED = 'CANCELLED', _('Annulée')


class Route(models.Model):
    """
    Route publiée par un transporteur
    """
    carrier = models.ForeignKey(
        Carrier,  # CORRECTION: Carrier au lieu de CarrierProfile
        on_delete=models.CASCADE,
        related_name='routes',
        verbose_name=_('Transporteur')
    )

    # Départ
    start_city = models.CharField(
        max_length=100,
        verbose_name=_('Ville de départ')
    )
    start_country = models.ForeignKey(
        Country,
        on_delete=models.CASCADE,
        related_name='departure_routes',
        verbose_name=_('Pays de départ')
    )
    start_address = models.TextField(
        verbose_name=_('Adresse de départ'),
        blank=True
    )

    # Arrivée
    end_city = models.CharField(
        max_length=100,
        verbose_name=_('Ville d\'arrivée')
    )
    end_country = models.ForeignKey(
        Country,
        on_delete=models.CASCADE,
        related_name='arrival_routes',
        verbose_name=_('Pays d\'arrivée')
    )
    end_address = models.TextField(
        verbose_name=_('Adresse d\'arrivée'),
        blank=True
    )

    # Dates
    departure_date = models.DateField(
        verbose_name=_('Date de départ')
    )
    arrival_date = models.DateField(
        verbose_name=_('Date d\'arrivée')
    )

    # Capacités
    max_weight = models.DecimalField(
        max_digits=10,
        decimal_places=3,
        verbose_name=_('Poids maximum (kg)'),
        validators=[MinValueValidator(0)]
    )
    max_volume = models.DecimalField(
        max_digits=10,
        decimal_places=3,
        verbose_name=_('Volume maximum (m³)'),
        validators=[MinValueValidator(0)]
    )
    available_weight = models.DecimalField(
        max_digits=10,
        decimal_places=3,
        verbose_name=_('Poids disponible (kg)'),
        validators=[MinValueValidator(0)]
    )
    available_volume = models.DecimalField(
        max_digits=10,
        decimal_places=3,
        verbose_name=_('Volume disponible (m³)'),
        validators=[MinValueValidator(0)]
    )

    # Prix
    fixed_price = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_('Prix fixe'),
        null=True,
        blank=True,
        validators=[MinValueValidator(0)]
    )
    price_per_kg = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_('Prix par kg'),
        null=True,
        blank=True,
        validators=[MinValueValidator(0)]
    )
    price_per_m3 = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_('Prix par m³'),
        null=True,
        blank=True,
        validators=[MinValueValidator(0)]
    )

    # Statut
    status = models.CharField(
        max_length=20,
        choices=RouteStatus.choices,
        default=RouteStatus.ACTIVE,
        verbose_name=_('Statut')
    )

    # Services inclus
    includes_insurance = models.BooleanField(
        default=False,
        verbose_name=_('Assurance incluse')
    )
    includes_packaging = models.BooleanField(
        default=False,
        verbose_name=_('Emballage inclus')
    )
    includes_loading = models.BooleanField(
        default=False,
        verbose_name=_('Chargement inclus')
    )
    includes_unloading = models.BooleanField(
        default=False,
        verbose_name=_('Déchargement inclus')
    )

    # Description
    description = models.TextField(
        verbose_name=_('Description'),
        blank=True
    )
    special_conditions = models.TextField(
        verbose_name=_('Conditions spéciales'),
        blank=True
    )

    # Métadonnées
    is_featured = models.BooleanField(
        default=False,
        verbose_name=_('Mis en avant')
    )
    view_count = models.PositiveIntegerField(
        default=0,
        verbose_name=_('Nombre de vues')
    )
    created_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name=_('Date de création')
    )
    updated_at = models.DateTimeField(
        auto_now=True,
        verbose_name=_('Date de modification')
    )

    class Meta:
        verbose_name = _('Route')
        verbose_name_plural = _('Routes')
        ordering = ['departure_date', '-created_at']
        indexes = [
            models.Index(fields=['status']),
            models.Index(fields=['departure_date']),
            models.Index(fields=['carrier', 'status']),
            models.Index(fields=['start_country', 'end_country']),
        ]

    def __str__(self):
        return f"{self.start_city} → {self.end_city} ({self.departure_date})"

    def clean(self):
        """Validation personnalisée"""
        super().clean()

        # Vérifier les dates
        if self.arrival_date < self.departure_date:
            raise ValidationError(_("La date d'arrivée doit être après la date de départ."))

        # Vérifier la disponibilité
        if self.available_weight > self.max_weight:
            raise ValidationError(_("Le poids disponible ne peut pas dépasser le poids maximum."))
        if self.available_volume > self.max_volume:
            raise ValidationError(_("Le volume disponible ne peut pas dépasser le volume maximum."))

        # Mettre à jour le statut si complet
        if self.available_weight == 0 and self.available_volume == 0:
            self.status = RouteStatus.FULL
        elif self.status == RouteStatus.FULL and (self.available_weight > 0 or self.available_volume > 0):
            self.status = RouteStatus.ACTIVE

    def save(self, *args, **kwargs):
        self.full_clean()
        super().save(*args, **kwargs)

    @property
    def is_available(self):
        """Vérifie si la route est disponible"""
        return self.status == RouteStatus.ACTIVE and (
            self.available_weight > 0 or self.available_volume > 0
        )

    @property
    def days_until_departure(self):
        """Jours restants avant le départ"""
        delta = self.departure_date - timezone.now().date()
        return delta.days if delta.days > 0 else 0

    @property
    def calculate_price(self, weight=None, volume=None):
        """Calcule le prix en fonction du poids et/ou volume"""
        if self.fixed_price:
            return self.fixed_price

        price = 0
        if weight and self.price_per_kg:
            price += weight * self.price_per_kg
        if volume and self.price_per_m3:
            price += volume * self.price_per_m3

        return price


class TransportProposalStatus(models.TextChoices):
    """Statuts d'une proposition de transport"""
    PENDING = 'PENDING', _('En attente')
    ACCEPTED = 'ACCEPTED', _('Acceptée')
    REJECTED = 'REJECTED', _('Rejetée')
    EXPIRED = 'EXPIRED', _('Expirée')
    CANCELLED = 'CANCELLED', _('Annulée')


class TransportProposal(models.Model):
    """
    Proposition de transport pour une annonce
    """
    ad = models.ForeignKey(
        Ad,
        on_delete=models.CASCADE,
        related_name='transport_proposals',
        verbose_name=_('Annonce')
    )
    carrier = models.ForeignKey(
        Carrier,  # CORRECTION: Carrier au lieu de CarrierProfile
        on_delete=models.CASCADE,
        related_name='proposals',
        verbose_name=_('Transporteur')
    )

    # Détails de la proposition
    proposed_price = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_('Prix proposé'),
        validators=[MinValueValidator(0)]
    )
    message = models.TextField(
        verbose_name=_('Message'),
        blank=True
    )

    # Dates
    estimated_pickup_date = models.DateField(
        verbose_name=_('Date de prise en charge estimée'),
        null=True,
        blank=True
    )
    estimated_delivery_date = models.DateField(
        verbose_name=_('Date de livraison estimée'),
        null=True,
        blank=True
    )

    # Services
    includes_insurance = models.BooleanField(
        default=False,
        verbose_name=_('Assurance incluse')
    )
    insurance_value = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_('Valeur assurée'),
        null=True,
        blank=True,
        validators=[MinValueValidator(0)]
    )
    includes_packaging = models.BooleanField(
        default=False,
        verbose_name=_('Emballage inclus')
    )
    includes_loading = models.BooleanField(
        default=False,
        verbose_name=_('Chargement inclus')
    )
    includes_unloading = models.BooleanField(
        default=False,
        verbose_name=_('Déchargement inclus')
    )

    # Statut
    status = models.CharField(
        max_length=20,
        choices=TransportProposalStatus.choices,
        default=TransportProposalStatus.PENDING,
        verbose_name=_('Statut')
    )

    # Expiration
    created_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name=_('Date de création')
    )
    expires_at = models.DateTimeField(
        verbose_name=_('Date d\'expiration')
    )

    # Réponse
    responded_at = models.DateTimeField(
        verbose_name=_('Date de réponse'),
        null=True,
        blank=True
    )
    response_message = models.TextField(
        verbose_name=_('Message de réponse'),
        blank=True
    )

    class Meta:
        verbose_name = _('Proposition de transport')
        verbose_name_plural = _('Propositions de transport')
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status']),
            models.Index(fields=['ad', 'status']),
            models.Index(fields=['carrier', 'status']),
            models.Index(fields=['expires_at']),
        ]
        unique_together = ['ad', 'carrier']

    def __str__(self):
        return f"Proposition #{self.id} - {self.ad.title}"

    def clean(self):
        """Validation personnalisée"""
        super().clean()

        # Vérifier les dates
        if self.estimated_delivery_date and self.estimated_pickup_date:
            if self.estimated_delivery_date < self.estimated_pickup_date:
                raise ValidationError(_("La date de livraison doit être après la date de prise en charge."))

        # Définir l'expiration par défaut (7 jours)
        if not self.expires_at:
            self.expires_at = timezone.now() + timezone.timedelta(days=7)

    def save(self, *args, **kwargs):
        self.full_clean()

        # Mettre à jour le statut si expiré
        if self.expires_at and timezone.now() > self.expires_at:
            self.status = TransportProposalStatus.EXPIRED

        super().save(*args, **kwargs)

    @property
    def is_expired(self):
        """Vérifie si la proposition est expirée"""
        return self.expires_at and timezone.now() > self.expires_at

    @property
    def can_be_accepted(self):
        """Vérifie si la proposition peut être acceptée"""
        return (self.status == TransportProposalStatus.PENDING and
                not self.is_expired)

    @property
    def days_until_expiry(self):
        """Jours restants avant expiration"""
        if not self.expires_at:
            return None
        delta = self.expires_at - timezone.now()
        return delta.days if delta.days > 0 else 0


class LogisticsSettings(models.Model):
    """
    Paramètres généraux de la logistique
    """
    # Commissions
    commission_rate = models.DecimalField(
        max_digits=5,
        decimal_places=2,
        default=5.00,
        verbose_name=_('Taux de commission (%)'),
        validators=[MinValueValidator(0), MaxValueValidator(100)]
    )

    # Délais
    reservation_expiry_hours = models.PositiveIntegerField(
        default=48,
        verbose_name=_('Expiration réservation (heures)')
    )
    proposal_expiry_days = models.PositiveIntegerField(
        default=7,
        verbose_name=_('Expiration proposition (jours)')
    )

    # Paiement
    payment_hold_days = models.PositiveIntegerField(
        default=3,
        verbose_name=_('Rétention paiement (jours)')
    )
    auto_release_payment = models.BooleanField(
        default=True,
        verbose_name=_('Libération automatique paiement')
    )

    # Notifications
    notify_on_reservation = models.BooleanField(
        default=True,
        verbose_name=_('Notifier nouvelle réservation')
    )
    notify_on_status_change = models.BooleanField(
        default=True,
        verbose_name=_('Notifier changement statut')
    )
    notify_before_expiry = models.BooleanField(
        default=True,
        verbose_name=_('Notifier avant expiration')
    )

    # Métadonnées
    created_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name=_('Date de création')
    )
    updated_at = models.DateTimeField(
        auto_now=True,
        verbose_name=_('Date de modification')
    )

    class Meta:
        verbose_name = _('Paramètre logistique')
        verbose_name_plural = _('Paramètres logistiques')

    def __str__(self):
        return "Paramètres Logistiques"

    def save(self, *args, **kwargs):
        # S'assurer qu'il n'y a qu'une seule instance
        self.pk = 1
        super().save(*args, **kwargs)

    @classmethod
    def load(cls):
        """Charge les paramètres ou crée des valeurs par défaut"""
        obj, created = cls.objects.get_or_create(pk=1)
        return obj


========== logistics/views.py ==========
# ~/ebi3/logistics/views.py

from django.shortcuts import render, get_object_or_404, redirect
from django.views.generic import (
    ListView, DetailView, CreateView, UpdateView, DeleteView, TemplateView
)
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.contrib import messages
from django.urls import reverse_lazy, reverse
from django.http import JsonResponse, HttpResponseForbidden, HttpResponseRedirect
from django.db.models import Q, F, Sum, Count, Avg
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import PermissionDenied
from django.views.decorators.http import require_POST, require_GET
from django.contrib.auth.decorators import login_required
from django.utils.decorators import method_decorator
from django.views.decorators.csrf import csrf_exempt

from .models import (
    Reservation, Mission, Route, TransportProposal, TrackingEvent,
    LogisticsSettings, LogisticsOption, ReservationStatus, MissionStatus,
    RouteStatus, TransportProposalStatus
)
from .forms import (
    ReservationForm, ReservationStatusForm, MissionForm, TrackingEventForm,
    RouteForm, RouteSearchForm, TransportProposalForm, ProposalResponseForm,
    LogisticsSettingsForm, QuickReservationForm
)
from ads.models import Ad
from carriers.models import Carrier
from users.models import User
from carriers.models import CarrierNotification


class LogisticsDashboardView(LoginRequiredMixin, TemplateView):
    """Tableau de bord logistique"""
    template_name = 'logistics/dashboard.html'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        user = self.request.user

        if user.role == 'SELLER':
            # Dashboard vendeur
            context['active_reservations'] = Reservation.objects.filter(
                ad__seller=user,
                status__in=['CONFIRMED', 'PAID', 'IN_TRANSIT']
            ).select_related('buyer', 'carrier', 'ad').order_by('-created_at')[:5]

            context['pending_proposals'] = TransportProposal.objects.filter(
                ad__seller=user,
                status='PENDING'
            ).select_related('carrier', 'ad').order_by('-created_at')[:5]

            context['sales_stats'] = Reservation.objects.filter(
                ad__seller=user,
                status='DELIVERED'
            ).aggregate(
                total_sales=Sum('total_price'),
                total_count=Count('id'),
                avg_sale=Avg('total_price')
            )

        elif user.role == 'CARRIER' and hasattr(user, 'carrier_profile'):
            # Dashboard transporteur
            carrier = user.carrier_profile

            context['active_missions'] = Mission.objects.filter(
                carrier=carrier,
                status__in=['SCHEDULED', 'PICKUP_PENDING', 'PICKED_UP', 'IN_TRANSIT', 'OUT_FOR_DELIVERY']
            ).select_related('reservation', 'reservation__ad', 'reservation__buyer').order_by('-created_at')[:5]

            context['pending_proposals'] = TransportProposal.objects.filter(
                carrier=carrier,
                status='PENDING'
            ).select_related('ad', 'ad__seller').order_by('-created_at')[:5]

            context['available_routes'] = Route.objects.filter(
                carrier=carrier,
                status='ACTIVE',
                departure_date__gte=timezone.now().date()
            ).order_by('departure_date')[:5]

            context['carrier_stats'] = Mission.objects.filter(
                carrier=carrier
            ).aggregate(
                completed_missions=Count('id', filter=Q(status='DELIVERED')),
                total_earnings=Sum('reservation__shipping_cost'),
                avg_rating=carrier.average_rating
            )

        else:
            # Dashboard acheteur
            context['my_reservations'] = Reservation.objects.filter(
                buyer=user
            ).select_related('ad', 'carrier', 'ad__seller').order_by('-created_at')[:5]

            context['tracking_missions'] = Mission.objects.filter(
                reservation__buyer=user,
                status__in=['PICKUP_PENDING', 'PICKED_UP', 'IN_TRANSIT', 'OUT_FOR_DELIVERY', 'DELIVERY_PENDING']
            ).select_related('reservation', 'reservation__ad').order_by('-created_at')[:5]

        # Statistiques générales
        context['total_reservations'] = Reservation.objects.count()
        context['active_missions_count'] = Mission.objects.filter(
            status__in=['SCHEDULED', 'PICKUP_PENDING', 'PICKED_UP', 'IN_TRANSIT', 'OUT_FOR_DELIVERY']
        ).count()
        context['available_routes_count'] = Route.objects.filter(
            status='ACTIVE',
            departure_date__gte=timezone.now().date()
        ).count()

        return context


class ReservationListView(LoginRequiredMixin, ListView):
    """Liste des réservations de l'utilisateur"""
    model = Reservation
    template_name = 'logistics/reservation_list.html'
    context_object_name = 'reservations'
    paginate_by = 20

    def get_queryset(self):
        user = self.request.user
        status_filter = self.request.GET.get('status')
        date_filter = self.request.GET.get('date')

        # Base queryset selon le rôle
        if user.role == 'SELLER':
            queryset = Reservation.objects.filter(ad__seller=user)
        elif user.role == 'CARRIER' and hasattr(user, 'carrier_profile'):
            queryset = Reservation.objects.filter(carrier=user.carrier_profile)
        else:
            queryset = Reservation.objects.filter(buyer=user)

        # Filtres
        if status_filter and status_filter != 'all':
            queryset = queryset.filter(status=status_filter)

        if date_filter == 'this_week':
            week_start = timezone.now() - timezone.timedelta(days=7)
            queryset = queryset.filter(created_at__gte=week_start)
        elif date_filter == 'this_month':
            month_start = timezone.now() - timezone.timedelta(days=30)
            queryset = queryset.filter(created_at__gte=month_start)

        return queryset.select_related(
            'ad', 'ad__seller', 'buyer', 'carrier'
        ).order_by('-created_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['status_choices'] = ReservationStatus.choices
        context['current_status'] = self.request.GET.get('status', 'all')
        context['current_date_filter'] = self.request.GET.get('date', 'all')

        # Statistiques
        queryset = self.get_queryset()
        context['stats'] = {
            'total': queryset.count(),
            'pending': queryset.filter(status='PENDING').count(),
            'in_transit': queryset.filter(status='IN_TRANSIT').count(),
            'delivered': queryset.filter(status='DELIVERED').count(),
        }

        return context


class ReservationDetailView(LoginRequiredMixin, UserPassesTestMixin, DetailView):
    """Détail d'une réservation"""
    model = Reservation
    template_name = 'logistics/reservation_detail.html'
    context_object_name = 'reservation'

    def test_func(self):
        reservation = self.get_object()
        user = self.request.user

        # Autoriser le vendeur, l'acheteur ou le transporteur
        return (
            user == reservation.ad.seller or
            user == reservation.buyer or
            (reservation.carrier and user == reservation.carrier.user)
        )

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        reservation = self.object

        context['can_edit'] = (
            self.request.user == reservation.buyer and
            reservation.status in ['PENDING', 'CONFIRMED']
        )

        context['can_cancel'] = (
            reservation.can_be_cancelled and
            (
                self.request.user == reservation.buyer or
                self.request.user == reservation.ad.seller
            )
        )

        context['can_update_status'] = (
            self.request.user == reservation.ad.seller or
            self.request.user == reservation.buyer
        )

        context['status_form'] = ReservationStatusForm(instance=reservation)

        # Récupérer la mission associée si elle existe
        if hasattr(reservation, 'mission'):
            context['mission'] = reservation.mission
            context['tracking_events'] = reservation.mission.tracking_events.all().order_by('-created_at')

        # Messages entre parties
        context['can_message_seller'] = self.request.user != reservation.ad.seller
        context['can_message_buyer'] = self.request.user != reservation.buyer
        if reservation.carrier:
            context['can_message_carrier'] = self.request.user != reservation.carrier.user

        return context


class ReservationCreateView(LoginRequiredMixin, CreateView):
    """Création d'une réservation"""
    model = Reservation
    form_class = ReservationForm
    template_name = 'logistics/reservation_create.html'

    def get_initial(self):
        initial = super().get_initial()
        self.ad = get_object_or_404(Ad, slug=self.kwargs['slug'])

        # Calculer le prix total initial
        initial['price_agreed'] = self.ad.price

        # Vérifier si l'annonce peut être réservée
        if not self.ad.can_be_reserved:
            messages.error(self.request, _("Cette annonce n'est pas disponible pour réservation."))
            raise PermissionDenied

        return initial

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['ad'] = self.ad
        kwargs['buyer'] = self.request.user
        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['ad'] = self.ad

        # Récupérer les transporteurs recommandés pour cette annonce
        if hasattr(self.ad, 'calculate_shipping_cost'):
            context['recommended_carriers'] = Carrier.objects.filter(
                is_available=True,
                max_weight__gte=self.ad.weight if self.ad.weight else 0
            ).order_by('base_price_per_kg')[:3]

        return context

    def form_valid(self, form):
        form.instance.ad = self.ad
        form.instance.buyer = self.request.user
        form.instance.price_agreed = self.ad.price

        # Calculer le prix total
        shipping_cost = form.cleaned_data.get('shipping_cost', 0)
        insurance_cost = form.cleaned_data.get('insurance_cost', 0)
        form.instance.total_price = self.ad.price + shipping_cost + insurance_cost

        response = super().form_valid(form)

        # Créer une notification pour le vendeur
        Notification.objects.create(
            user=self.ad.seller,
            title=_("Nouvelle réservation"),
            message=_("Votre annonce '{}' a été réservée.").format(self.ad.title),
            url=self.object.get_absolute_url(),
            notification_type='RESERVATION_CREATED'
        )

        messages.success(self.request, _("Réservation créée avec succès !"))
        return response

    def get_success_url(self):
        return reverse('logistics:reservation_detail', kwargs={'pk': self.object.pk})


class ReservationUpdateView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
    """Modification d'une réservation"""
    model = Reservation
    form_class = ReservationForm
    template_name = 'logistics/reservation_update.html'

    def test_func(self):
        reservation = self.get_object()
        return (
            self.request.user == reservation.buyer and
            reservation.status in ['PENDING', 'CONFIRMED']
        )

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['ad'] = self.object.ad
        kwargs['buyer'] = self.request.user
        return kwargs

    def form_valid(self, form):
        response = super().form_valid(form)
        messages.success(self.request, _("Réservation mise à jour avec succès !"))
        return response

    def get_success_url(self):
        return reverse('logistics:reservation_detail', kwargs={'pk': self.object.pk})


@method_decorator(require_POST, name='dispatch')
class ReservationCancelView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
    """Annulation d'une réservation"""
    model = Reservation
    fields = []
    http_method_names = ['post']

    def test_func(self):
        reservation = self.get_object()
        return (
            self.request.user == reservation.buyer or
            self.request.user == reservation.ad.seller
        ) and reservation.can_be_cancelled

    def post(self, request, *args, **kwargs):
        reservation = self.get_object()

        # Annuler la réservation
        reservation.status = ReservationStatus.CANCELLED
        reservation.cancelled_at = timezone.now()
        reservation.cancelled_by = request.user
        reservation.cancellation_reason = request.POST.get('reason', '')
        reservation.save()

        # Mettre à jour l'annonce pour la rendre à nouveau disponible
        reservation.ad.is_reserved = False
        reservation.ad.save()

        # Notifier les autres parties
        if request.user == reservation.buyer:
            # Notifier le vendeur
            Notification.objects.create(
                user=reservation.ad.seller,
                title=_("Réservation annulée"),
                message=_("La réservation de votre annonce '{}' a été annulée par l'acheteur.").format(reservation.ad.title),
                url=reservation.ad.get_absolute_url(),
                notification_type='RESERVATION_CANCELLED'
            )
        else:
            # Notifier l'acheteur
            Notification.objects.create(
                user=reservation.buyer,
                title=_("Réservation annulée"),
                message=_("Votre réservation pour '{}' a été annulée par le vendeur.").format(reservation.ad.title),
                url=reservation.ad.get_absolute_url(),
                notification_type='RESERVATION_CANCELLED'
            )

        messages.success(request, _("Réservation annulée avec succès."))

        if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({'success': True})

        return redirect('logistics:reservation_detail', pk=reservation.pk)


@method_decorator(require_POST, name='dispatch')
class ReservationStatusUpdateView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
    """Mise à jour du statut d'une réservation"""
    model = Reservation
    form_class = ReservationStatusForm
    http_method_names = ['post']

    def test_func(self):
        reservation = self.get_object()
        return (
            self.request.user == reservation.ad.seller or
            self.request.user == reservation.buyer
        )

    def form_valid(self, form):
        old_status = self.object.status
        response = super().form_valid(form)

        # Si le statut passe à "EN TRANSIT", créer une mission
        if self.object.status == ReservationStatus.IN_TRANSIT and self.object.carrier:
            Mission.objects.create(
                reservation=self.object,
                carrier=self.object.carrier,
                status=MissionStatus.IN_TRANSIT
            )

        # Notifier les parties concernées
        self.send_status_notification(old_status)

        if self.request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({'success': True, 'new_status': self.object.status})

        messages.success(self.request, _("Statut mis à jour avec succès."))
        return response

    def send_status_notification(self, old_status):
        """Envoyer des notifications selon le changement de statut"""
        if old_status == self.object.status:
            return

        # Notification à l'acheteur
        if self.request.user != self.object.buyer:
            Notification.objects.create(
                user=self.object.buyer,
                title=_("Mise à jour de votre réservation"),
                message=_("Le statut de votre réservation #{} est maintenant '{}'.").format(
                    self.object.id, self.object.get_status_display()
                ),
                url=self.object.get_absolute_url(),
                notification_type='RESERVATION_STATUS_CHANGED'
            )

        # Notification au transporteur s'il y en a un
        if self.object.carrier and self.request.user != self.object.carrier.user:
            Notification.objects.create(
                user=self.object.carrier.user,
                title=_("Mise à jour de mission"),
                message=_("Le statut de la réservation #{} est maintenant '{}'.").format(
                    self.object.id, self.object.get_status_display()
                ),
                url=self.object.get_absolute_url(),
                notification_type='MISSION_STATUS_CHANGED'
            )

    def get_success_url(self):
        return reverse('logistics:reservation_detail', kwargs={'pk': self.object.pk})


class MissionListView(LoginRequiredMixin, ListView):
    """Liste des missions de l'utilisateur"""
    model = Mission
    template_name = 'logistics/mission_list.html'
    context_object_name = 'missions'
    paginate_by = 20

    def get_queryset(self):
        user = self.request.user

        if user.role == 'CARRIER' and hasattr(user, 'carrier_profile'):
            # Missions du transporteur
            queryset = Mission.objects.filter(carrier=user.carrier_profile)
        else:
            # Missions où l'utilisateur est acheteur ou vendeur
            queryset = Mission.objects.filter(
                Q(reservation__buyer=user) |
                Q(reservation__ad__seller=user)
            )

        # Filtres
        status_filter = self.request.GET.get('status')
        if status_filter and status_filter != 'all':
            queryset = queryset.filter(status=status_filter)

        return queryset.select_related(
            'reservation',
            'reservation__ad',
            'reservation__buyer',
            'carrier'
        ).order_by('-created_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['status_choices'] = MissionStatus.choices
        context['current_status'] = self.request.GET.get('status', 'all')
        return context


class MissionDetailView(LoginRequiredMixin, UserPassesTestMixin, DetailView):
    """Détail d'une mission avec suivi"""
    model = Mission
    template_name = 'logistics/mission_detail.html'
    context_object_name = 'mission'

    def test_func(self):
        mission = self.get_object()
        user = self.request.user

        # Autoriser le transporteur, l'acheteur ou le vendeur
        return (
            user == mission.carrier.user or
            user == mission.reservation.buyer or
            user == mission.reservation.ad.seller
        )

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        mission = self.object

        context['tracking_events'] = mission.tracking_events.all().order_by('-created_at')
        context['tracking_form'] = TrackingEventForm()
        context['can_update_tracking'] = (
            self.request.user == mission.carrier.user and
            mission.status != 'DELIVERED' and
            mission.status != 'CANCELLED'
        )

        # Statistiques de la mission
        context['mission_stats'] = {
            'distance_traveled': mission.distance_km,
            'estimated_time_remaining': None,
            'delivery_on_time': not mission.is_delayed
        }

        return context


class MissionUpdateView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
    """Mise à jour d'une mission"""
    model = Mission
    form_class = MissionForm
    template_name = 'logistics/mission_update.html'

    def test_func(self):
        mission = self.get_object()
        return self.request.user == mission.carrier.user

    def form_valid(self, form):
        old_status = self.object.status
        response = super().form_valid(form)

        # Si la mission est marquée comme livrée
        if self.object.status == MissionStatus.DELIVERED:
            self.object.actual_delivery = timezone.now()
            self.object.save()

            # Mettre à jour la réservation
            reservation = self.object.reservation
            reservation.status = ReservationStatus.DELIVERED
            reservation.actual_delivery_date = timezone.now().date()
            reservation.save()

        # Envoyer des notifications
        self.send_status_notification(old_status)

        messages.success(self.request, _("Mission mise à jour avec succès."))
        return response

    def send_status_notification(self, old_status):
        """Envoyer des notifications pour changement de statut"""
        if old_status == self.object.status:
            return

        # Notifier l'acheteur
        Notification.objects.create(
            user=self.object.reservation.buyer,
            title=_("Mise à jour de votre livraison"),
            message=_("Le statut de votre livraison est maintenant '{}'.").format(
                self.object.get_status_display()
            ),
            url=self.object.get_absolute_url(),
            notification_type='MISSION_STATUS_CHANGED'
        )

        # Notifier le vendeur
        Notification.objects.create(
            user=self.object.reservation.ad.seller,
            title=_("Mise à jour de livraison"),
            message=_("Le statut de la livraison pour votre annonce est maintenant '{}'.").format(
                self.object.get_status_display()
            ),
            url=self.object.get_absolute_url(),
            notification_type='MISSION_STATUS_CHANGED'
        )

    def get_success_url(self):
        return reverse('logistics:mission_detail', kwargs={'pk': self.object.pk})


@method_decorator(require_POST, name='dispatch')
class TrackingEventCreateView(LoginRequiredMixin, UserPassesTestMixin, CreateView):
    """Création d'un événement de suivi"""
    model = TrackingEvent
    form_class = TrackingEventForm

    def test_func(self):
        mission = get_object_or_404(Mission, pk=self.kwargs['mission_id'])
        return (
            self.request.user == mission.carrier.user and
            mission.status != 'DELIVERED' and
            mission.status != 'CANCELLED'
        )

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['mission'] = get_object_or_404(Mission, pk=self.kwargs['mission_id'])
        kwargs['user'] = self.request.user
        return kwargs

    def form_valid(self, form):
        mission = get_object_or_404(Mission, pk=self.kwargs['mission_id'])

        form.instance.mission = mission
        form.instance.created_by = self.request.user

        # Mettre à jour la localisation de la mission
        if form.cleaned_data.get('location'):
            mission.current_location = form.cleaned_data['location']
            mission.save(update_fields=['current_location'])

        response = super().form_valid(form)

        # Notifier l'acheteur
        Notification.objects.create(
            user=mission.reservation.buyer,
            title=_("Mise à jour de suivi"),
            message=_("Nouvel événement de suivi : {}").format(
                form.instance.get_event_type_display()
            ),
            url=mission.get_absolute_url(),
            notification_type='TRACKING_UPDATED'
        )

        if self.request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({
                'success': True,
                'event': {
                    'type': form.instance.get_event_type_display(),
                    'description': form.instance.description,
                    'location': form.instance.location,
                    'created_at': form.instance.created_at.strftime('%d/%m/%Y %H:%M'),
                    'photo_url': form.instance.photo.url if form.instance.photo else None
                }
            })

        messages.success(self.request, _("Événement de suivi ajouté avec succès."))
        return redirect('logistics:mission_detail', pk=mission.pk)

    def form_invalid(self, form):
        if self.request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({'success': False, 'errors': form.errors})
        return super().form_invalid(form)


class RouteListView(ListView):
    """Liste des routes disponibles"""
    model = Route
    template_name = 'logistics/route_list.html'
    context_object_name = 'routes'
    paginate_by = 12

    def get_queryset(self):
        queryset = Route.objects.filter(
            status=RouteStatus.ACTIVE,
            departure_date__gte=timezone.now().date()
        ).select_related('carrier', 'carrier__user', 'start_country', 'end_country')

        # Appliquer les filtres de recherche
        form = RouteSearchForm(self.request.GET)
        if form.is_valid():
            data = form.cleaned_data

            if data.get('start_city'):
                queryset = queryset.filter(start_city__icontains=data['start_city'])

            if data.get('start_country'):
                queryset = queryset.filter(start_country=data['start_country'])

            if data.get('end_city'):
                queryset = queryset.filter(end_city__icontains=data['end_city'])

            if data.get('end_country'):
                queryset = queryset.filter(end_country=data['end_country'])

            if data.get('departure_date_from'):
                queryset = queryset.filter(departure_date__gte=data['departure_date_from'])

            if data.get('departure_date_to'):
                queryset = queryset.filter(departure_date__lte=data['departure_date_to'])

            if data.get('max_price'):
                # Filtrer par prix (fixe ou calculé)
                queryset = queryset.filter(
                    Q(fixed_price__lte=data['max_price']) |
                    Q(fixed_price__isnull=True, price_per_kg__lte=data['max_price']/10)  # Estimation
                )

            if data.get('min_available_weight'):
                queryset = queryset.filter(available_weight__gte=data['min_available_weight'])

            if data.get('min_available_volume'):
                queryset = queryset.filter(available_volume__gte=data['min_available_volume'])

            if data.get('includes_insurance'):
                queryset = queryset.filter(includes_insurance=True)

            if data.get('includes_packaging'):
                queryset = queryset.filter(includes_packaging=True)

            if data.get('carrier_type'):
                queryset = queryset.filter(carrier__carrier_type=data['carrier_type'])

            # Tri
            sort_by = data.get('sort_by', 'departure_date')
            if sort_by == 'price':
                queryset = queryset.order_by(
                    'fixed_price', 'price_per_kg', 'price_per_m3'
                )
            elif sort_by == '-price':
                queryset = queryset.order_by(
                    '-fixed_price', '-price_per_kg', '-price_per_m3'
                )
            else:
                queryset = queryset.order_by(sort_by)

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['search_form'] = RouteSearchForm(self.request.GET)
        context['total_count'] = self.get_queryset().count()
        context['countries'] = Route.objects.values_list(
            'start_country__name', flat=True
        ).distinct().order_by('start_country__name')

        # Statistiques
        context['stats'] = {
            'total_routes': Route.objects.filter(
                status=RouteStatus.ACTIVE,
                departure_date__gte=timezone.now().date()
            ).count(),
            'professional_carriers': Route.objects.filter(
                carrier__carrier_type='PROFESSIONAL'
            ).values('carrier').distinct().count(),
            'personal_carriers': Route.objects.filter(
                carrier__carrier_type='PERSONAL'
            ).values('carrier').distinct().count(),
        }

        return context


class RouteDetailView(DetailView):
    """Détail d'une route"""
    model = Route
    template_name = 'logistics/route_detail.html'
    context_object_name = 'route'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        route = self.object

        # Calculer le prix estimé pour un objet standard
        context['estimated_price'] = route.calculate_price(weight=10, volume=0.1)

        # Vérifier si l'utilisateur peut réserver
        context['can_book'] = (
            self.request.user.is_authenticated and
            route.is_available
        )

        # Routes similaires
        context['similar_routes'] = Route.objects.filter(
            start_country=route.start_country,
            end_country=route.end_country,
            status=RouteStatus.ACTIVE,
            departure_date__gte=timezone.now().date()
        ).exclude(id=route.id).select_related('carrier')[:4]

        return context

    def post(self, request, *args, **kwargs):
        """Réservation d'une route"""
        if not request.user.is_authenticated:
            return redirect('users:login') + f'?next={request.path}'

        route = self.get_object()

        if not route.is_available:
            messages.error(request, _("Cette route n'est plus disponible."))
            return redirect('logistics:route_detail', pk=route.pk)

        # Rediriger vers la création de réservation avec cette route
        return redirect('logistics:reservation_create_with_route', route_id=route.pk)


class RouteCreateView(LoginRequiredMixin, UserPassesTestMixin, CreateView):
    """Création d'une route"""
    model = Route
    form_class = RouteForm
    template_name = 'logistics/route_create.html'

    def test_func(self):
        # Seuls les transporteurs peuvent créer des routes
        return (
            self.request.user.role == 'CARRIER' and
            hasattr(self.request.user, 'carrier_profile')
        )

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['carrier'] = self.request.user.carrier_profile
        return kwargs

    def form_valid(self, form):
        form.instance.carrier = self.request.user.carrier_profile

        # S'assurer que les capacités disponibles sont égales aux capacités max initialement
        if not form.instance.pk:
            form.instance.available_weight = form.instance.max_weight
            form.instance.available_volume = form.instance.max_volume

        response = super().form_valid(form)
        messages.success(self.request, _("Route créée avec succès !"))
        return response

    def get_success_url(self):
        return reverse('logistics:route_detail', kwargs={'pk': self.object.pk})


class RouteUpdateView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
    """Modification d'une route"""
    model = Route
    form_class = RouteForm
    template_name = 'logistics/route_update.html'

    def test_func(self):
        route = self.get_object()
        return self.request.user == route.carrier.user

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['carrier'] = self.object.carrier
        return kwargs

    def form_valid(self, form):
        response = super().form_valid(form)
        messages.success(self.request, _("Route mise à jour avec succès !"))
        return response

    def get_success_url(self):
        return reverse('logistics:route_detail', kwargs={'pk': self.object.pk})


@method_decorator(require_POST, name='dispatch')
class RouteDeleteView(LoginRequiredMixin, UserPassesTestMixin, DeleteView):
    """Suppression d'une route"""
    model = Route

    def test_func(self):
        route = self.get_object()
        return self.request.user == route.carrier.user

    def delete(self, request, *args, **kwargs):
        route = self.get_object()
        route.delete()

        messages.success(request, _("Route supprimée avec succès."))

        if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({'success': True})

        return redirect('logistics:route_list')


class TransportProposalCreateView(LoginRequiredMixin, UserPassesTestMixin, CreateView):
    """Création d'une proposition de transport"""
    model = TransportProposal
    form_class = TransportProposalForm
    template_name = 'logistics/proposal_create.html'

    def test_func(self):
        # Seuls les transporteurs peuvent faire des propositions
        return (
            self.request.user.role == 'CARRIER' and
            hasattr(self.request.user, 'carrier_profile')
        )

    def get_initial(self):
        initial = super().get_initial()
        self.ad = get_object_or_404(Ad, slug=self.kwargs['slug'])
        return initial

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['ad'] = self.ad
        kwargs['carrier'] = self.request.user.carrier_profile
        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['ad'] = self.ad
        return context

    def form_valid(self, form):
        form.instance.ad = self.ad
        form.instance.carrier = self.request.user.carrier_profile

        # Définir la date d'expiration (7 jours par défaut)
        if not form.instance.expires_at:
            form.instance.expires_at = timezone.now() + timezone.timedelta(days=7)

        response = super().form_valid(form)

        # Créer une notification pour le vendeur
        Notification.objects.create(
            user=self.ad.seller,
            title=_("Nouvelle proposition de transport"),
            message=_("Un transporteur a fait une proposition pour votre annonce '{}'.").format(self.ad.title),
            url=self.object.get_absolute_url(),
            notification_type='PROPOSAL_CREATED'
        )

        messages.success(self.request, _("Proposition envoyée avec succès !"))
        return response

    def get_success_url(self):
        return reverse('logistics:proposal_detail', kwargs={'pk': self.object.pk})


class TransportProposalDetailView(LoginRequiredMixin, UserPassesTestMixin, DetailView):
    """Détail d'une proposition de transport"""
    model = TransportProposal
    template_name = 'logistics/proposal_detail.html'
    context_object_name = 'proposal'

    def test_func(self):
        proposal = self.get_object()
        user = self.request.user

        # Autoriser le vendeur ou le transporteur
        return (
            user == proposal.ad.seller or
            user == proposal.carrier.user
        )

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        proposal = self.object

        context['can_respond'] = (
            self.request.user == proposal.ad.seller and
            proposal.can_be_accepted
        )

        if context['can_respond']:
            context['response_form'] = ProposalResponseForm(instance=proposal)

        context['is_expired'] = proposal.is_expired
        context['days_until_expiry'] = proposal.days_until_expiry

        return context


@method_decorator(require_POST, name='dispatch')
class TransportProposalRespondView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
    """Réponse à une proposition de transport"""
    model = TransportProposal
    form_class = ProposalResponseForm

    def test_func(self):
        proposal = self.get_object()
        return (
            self.request.user == proposal.ad.seller and
            proposal.can_be_accepted
        )

    def form_valid(self, form):
        old_status = self.object.status
        response = super().form_valid(form)

        # Si la proposition est acceptée, créer une réservation
        if self.object.status == TransportProposalStatus.ACCEPTED:
            reservation = Reservation.objects.create(
                ad=self.object.ad,
                buyer=None,  # À définir plus tard
                carrier=self.object.carrier,
                logistics_option=LogisticsOption.WITH_CARRIER,
                price_agreed=self.object.ad.price,
                shipping_cost=self.object.proposed_price,
                total_price=self.object.ad.price + self.object.proposed_price,
                requires_insurance=self.object.includes_insurance,
                insurance_value=self.object.insurance_value,
                requires_packaging=self.object.includes_packaging,
                pickup_date=self.object.estimated_pickup_date,
                delivery_date=self.object.estimated_delivery_date,
                status=ReservationStatus.PENDING
            )

            # Notifier le transporteur
            Notification.objects.create(
                user=self.object.carrier.user,
                title=_("Proposition acceptée !"),
                message=_("Votre proposition pour '{}' a été acceptée.").format(self.object.ad.title),
                url=reservation.get_absolute_url(),
                notification_type='PROPOSAL_ACCEPTED'
            )

        elif self.object.status == TransportProposalStatus.REJECTED:
            # Notifier le transporteur
            Notification.objects.create(
                user=self.object.carrier.user,
                title=_("Proposition refusée"),
                message=_("Votre proposition pour '{}' a été refusée.").format(self.object.ad.title),
                url=self.object.ad.get_absolute_url(),
                notification_type='PROPOSAL_REJECTED'
            )

        if self.request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({'success': True, 'new_status': self.object.status})

        messages.success(self.request, _("Réponse envoyée avec succès."))
        return redirect('logistics:proposal_detail', pk=self.object.pk)

    def get_success_url(self):
        return reverse('logistics:proposal_detail', kwargs={'pk': self.object.pk})


@login_required
@require_POST
def cancel_proposal(request, pk):
    """Annulation d'une proposition par le transporteur"""
    proposal = get_object_or_404(TransportProposal, pk=pk)

    if request.user != proposal.carrier.user:
        return HttpResponseForbidden()

    if not proposal.can_be_accepted:
        messages.error(request, _("Cette proposition ne peut pas être annulée."))
        return redirect('logistics:proposal_detail', pk=proposal.pk)

    proposal.status = TransportProposalStatus.CANCELLED
    proposal.responded_at = timezone.now()
    proposal.save()

    messages.success(request, _("Proposition annulée avec succès."))
    return redirect('logistics:proposal_detail', pk=proposal.pk)


class MyProposalsListView(LoginRequiredMixin, ListView):
    """Liste des propositions de l'utilisateur"""
    template_name = 'logistics/proposal_list.html'
    context_object_name = 'proposals'
    paginate_by = 20

    def get_queryset(self):
        user = self.request.user

        if user.role == 'SELLER':
            # Propositions reçues pour les annonces du vendeur
            queryset = TransportProposal.objects.filter(ad__seller=user)
        elif user.role == 'CARRIER' and hasattr(user, 'carrier_profile'):
            # Propositions faites par le transporteur
            queryset = TransportProposal.objects.filter(carrier=user.carrier_profile)
        else:
            queryset = TransportProposal.objects.none()

        # Filtre par statut
        status_filter = self.request.GET.get('status')
        if status_filter and status_filter != 'all':
            queryset = queryset.filter(status=status_filter)

        return queryset.select_related('ad', 'carrier', 'carrier__user').order_by('-created_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['status_choices'] = TransportProposalStatus.choices
        context['current_status'] = self.request.GET.get('status', 'all')
        return context


# API Views pour le suivi en temps réel

@method_decorator(csrf_exempt, name='dispatch')
@method_decorator(login_required, name='dispatch')
class TrackingAPIView(DetailView):
    """API pour récupérer les événements de suivi d'une mission"""
    model = Mission

    def get(self, request, *args, **kwargs):
        mission = self.get_object()

        # Vérifier les permissions
        if not (
            request.user == mission.carrier.user or
            request.user == mission.reservation.buyer or
            request.user == mission.reservation.ad.seller
        ):
            return JsonResponse({'error': 'Permission denied'}, status=403)

        # Récupérer les événements de suivi
        events = mission.tracking_events.all().order_by('-created_at')

        events_data = []
        for event in events:
            events_data.append({
                'id': event.id,
                'event_type': event.get_event_type_display(),
                'description': event.description,
                'location': event.location,
                'latitude': event.latitude,
                'longitude': event.longitude,
                'photo_url': event.photo.url if event.photo else None,
                'created_at': event.created_at.isoformat(),
                'created_by': event.created_by.username if event.created_by else None
            })

        return JsonResponse({
            'mission_id': mission.id,
            'status': mission.get_status_display(),
            'current_location': mission.current_location,
            'estimated_delivery': mission.estimated_delivery.isoformat() if mission.estimated_delivery else None,
            'progress': mission.progress_percentage,
            'events': events_data
        })


@login_required
@require_POST
@csrf_exempt
def update_location_api(request, mission_id):
    """API pour mettre à jour la localisation d'une mission"""
    mission = get_object_or_404(Mission, pk=mission_id)

    # Vérifier que l'utilisateur est le transporteur
    if request.user != mission.carrier.user:
        return JsonResponse({'error': 'Permission denied'}, status=403)

    latitude = request.POST.get('latitude')
    longitude = request.POST.get('longitude')
    location = request.POST.get('location')

    if latitude and longitude:
        mission.latitude = float(latitude)
        mission.longitude = float(longitude)

    if location:
        mission.current_location = location

    mission.save()

    # Créer un événement de suivi automatique
    TrackingEvent.objects.create(
        mission=mission,
        event_type='IN_TRANSIT',
        description=_('Mise à jour de localisation'),
        location=mission.current_location or _('Localisation inconnue'),
        latitude=mission.latitude,
        longitude=mission.longitude,
        created_by=request.user
    )

    return JsonResponse({
        'success': True,
        'location': mission.current_location,
        'latitude': mission.latitude,
        'longitude': mission.longitude,
        'updated_at': timezone.now().isoformat()
    })


# Vues pour l'administration

class LogisticsSettingsView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
    """Vue pour modifier les paramètres logistiques"""
    model = LogisticsSettings
    form_class = LogisticsSettingsForm
    template_name = 'logistics/settings.html'

    def test_func(self):
        # Seuls les administrateurs peuvent modifier les paramètres
        return self.request.user.is_staff

    def get_object(self):
        return LogisticsSettings.load()

    def form_valid(self, form):
        response = super().form_valid(form)
        messages.success(self.request, _("Paramètres mis à jour avec succès."))
        return response

    def get_success_url(self):
        return reverse('logistics:settings')


# Vues utilitaires

class LogisticsFAQView(TemplateView):
    """FAQ sur la logistique"""
    template_name = 'logistics/faq.html'


class LogisticsGuideView(TemplateView):
    """Guide d'utilisation de la logistique"""
    template_name = 'logistics/guide.html'


@login_required
def reservation_create_with_route(request, route_id):
    """Créer une réservation à partir d'une route"""
    route = get_object_or_404(Route, pk=route_id)

    if not route.is_available:
        messages.error(request, _("Cette route n'est plus disponible."))
        return redirect('logistics:route_detail', pk=route_id)

    # Rediriger vers la liste des annonces compatibles avec cette route
    return redirect('ads:ad_list') + f'?country_from={route.start_country_id}&country_to={route.end_country_id}'


# Vue de rapport/logs

class LogisticsReportsView(LoginRequiredMixin, UserPassesTestMixin, TemplateView):
    """Rapports et statistiques logistiques"""
    template_name = 'logistics/reports.html'

    def test_func(self):
        return self.request.user.is_staff

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Statistiques générales
        context['stats'] = {
            'total_reservations': Reservation.objects.count(),
            'reservations_this_month': Reservation.objects.filter(
                created_at__month=timezone.now().month,
                created_at__year=timezone.now().year
            ).count(),
            'total_missions': Mission.objects.count(),
            'completed_missions': Mission.objects.filter(status='DELIVERED').count(),
            'total_routes': Route.objects.count(),
            'active_routes': Route.objects.filter(status='ACTIVE').count(),
            'total_proposals': TransportProposal.objects.count(),
            'accepted_proposals': TransportProposal.objects.filter(status='ACCEPTED').count(),
        }

        # Revenus
        context['revenue_stats'] = Reservation.objects.filter(
            status='DELIVERED'
        ).aggregate(
            total_revenue=Sum('total_price'),
            shipping_revenue=Sum('shipping_cost'),
            avg_transaction=Avg('total_price')
        )

        # Tendances
        last_30_days = timezone.now() - timezone.timedelta(days=30)
        context['trends'] = {
            'reservations_last_30': Reservation.objects.filter(
                created_at__gte=last_30_days
            ).count(),
            'reservations_previous_30': Reservation.objects.filter(
                created_at__gte=last_30_days - timezone.timedelta(days=30),
                created_at__lt=last_30_days
            ).count(),
        }

        return context


# Vues de notification

@login_required
def logistics_notifications(request):
    """Notifications spécifiques à la logistique"""
    notifications = Notification.objects.filter(
        user=request.user,
        notification_type__in=[
            'RESERVATION_CREATED', 'RESERVATION_STATUS_CHANGED',
            'RESERVATION_CANCELLED', 'MISSION_STATUS_CHANGED',
            'TRACKING_UPDATED', 'PROPOSAL_CREATED',
            'PROPOSAL_ACCEPTED', 'PROPOSAL_REJECTED'
        ]
    ).order_by('-created_at')[:50]

    # Marquer comme lues
    unread_notifications = notifications.filter(is_read=False)
    unread_notifications.update(is_read=True)

    return render(request, 'logistics/notifications.html', {
        'notifications': notifications
    })


========== messaging/templates/messaging/notifications.html ==========
{# ~/ebi3/messaging/templates/messaging/notifications.html #}
{% extends 'messaging/base_messaging.html' %}
{% load i18n %}

{% block title %}{% trans "Notifications" %} - Ebi3{% endblock %}

{% block messaging_content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-bell"></i> {% trans "Notifications" %}
                {% if unread_count > 0 %}
                    <span class="badge bg-danger ms-2">{{ unread_count }}</span>
                {% endif %}
            </h1>
            <div>
                {% if unread_count > 0 %}
                    <form method="post" action="{% url 'messaging:mark_all_notifications_read' %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-success">
                            <i class="fas fa-check-double"></i> {% trans "Tout marquer comme lu" %}
                        </button>
                    </form>
                {% endif %}
                <div class="dropdown d-inline-block ms-2">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                        <i class="fas fa-filter"></i> {% trans "Filtrer" %}
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="?filter=unread">
                                <i class="fas fa-envelope"></i> {% trans "Non lues" %}
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="?filter=important">
                                <i class="fas fa-star"></i> {% trans "Importantes" %}
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="?filter=all">
                                <i class="fas fa-list"></i> {% trans "Toutes" %}
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        {% if notifications %}
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for notification in notifications %}
                            {% include 'messaging/partials/notification_item.html' with notification=notification %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Pagination -->
                {% if is_paginated %}
                    <nav class="p-3">
                        <ul class="pagination justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            {{ num }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            </div>
        {% else %}
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-bell-slash fa-4x text-muted mb-3"></i>
                    <h4>{% trans "Aucune notification" %}</h4>
                    <p class="text-muted">
                        {% trans "Vous n'avez aucune notification pour le moment." %}
                    </p>
                    <a href="{% url 'messaging:inbox' %}" class="btn btn-primary mt-3">
                        <i class="fas fa-inbox"></i> {% trans "Voir mes messages" %}
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Statistiques -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <div class="display-4 text-primary">{{ unread_count }}</div>
                <p class="text-muted mb-0">{% trans "Non lues" %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <div class="display-4 text-info">{{ total_notifications }}</div>
                <p class="text-muted mb-0">{% trans "Total" %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <div class="display-4 text-success">{{ important_count }}</div>
                <p class="text-muted mb-0">{% trans "Importantes" %}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}


========== messaging/templates/messaging/new_conversation.html ==========
{# ~/ebi3/messaging/templates/messaging/new_conversation.html #}
{% extends 'messaging/base_messaging.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Nouvelle conversation" %} - Ebi3{% endblock %}

{% block messaging_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="fas fa-comment-medical"></i> {% trans "Nouvelle conversation" %}
                </h2>
            </div>
            <div class="card-body p-4">
                <form method="post" id="new-conversation-form">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{% trans "À :" %}</label>
                            {{ form.recipient }}
                            {% if form.recipient.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.recipient.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                {% trans "Entrez le nom d'utilisateur ou l'email du destinataire" %}
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">{% trans "Sujet (optionnel) :" %}</label>
                            {{ form.subject }}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">{% trans "Message :" %}</label>
                        {{ form.message }}
                        {% if form.message.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.message.errors }}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            {% trans "Écrivez votre message ici. Vous pourrez ajouter des pièces jointes après." %}
                        </div>
                    </div>

                    <!-- Suggestions de contacts -->
                    {% if suggested_contacts %}
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-users"></i> {% trans "Contacts suggérés" %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for contact in suggested_contacts %}
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-center p-2 border rounded">
                                                <div class="flex-shrink-0">
                                                    <div class="conversation-avatar bg-primary text-white d-flex align-items-center justify-content-center"
                                                         style="width: 40px; height: 40px;">
                                                        {{ contact.username|first|upper }}
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <div class="fw-bold">{{ contact.username }}</div>
                                                    <div class="small text-muted">{{ contact.get_role_display }}</div>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary select-contact"
                                                        data-username="{{ contact.username }}">
                                                    <i class="fas fa-user-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Contacts récents -->
                    {% if recent_contacts %}
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-history"></i> {% trans "Contacts récents" %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-wrap gap-2">
                                    {% for contact in recent_contacts %}
                                        <button type="button" class="btn btn-outline-secondary select-contact"
                                                data-username="{{ contact.username }}">
                                            <i class="fas fa-user me-2"></i> {{ contact.username }}
                                        </button>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="{% url 'messaging:inbox' %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times"></i> {% trans "Annuler" %}
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> {% trans "Envoyer le message" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Informations importantes -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> {% trans "Conseils pour une bonne communication" %}</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>{% trans "Soyez clair et précis dans votre message" %}</li>
                    <li>{% trans "Respectez les règles de politesse et de courtoisie" %}</li>
                    <li>{% trans "Évitez d'envoyer des informations personnelles sensibles" %}</li>
                    <li>{% trans "Signalez tout comportement inapproprié à notre équipe" %}</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Auto-suggestion pour le champ destinataire
        $('#id_recipient').on('input', function() {
            const query = $(this).val();
            if (query.length > 2) {
                $.get('/api/users/search/', { q: query }, function(data) {
                    // Afficher les suggestions
                    // À implémenter selon l'API disponible
                });
            }
        });

        // Sélectionner un contact depuis les suggestions
        $('.select-contact').click(function() {
            const username = $(this).data('username');
            $('#id_recipient').val(username);
        });

        // Validation du formulaire
        $('#new-conversation-form').submit(function(e) {
            const recipient = $('#id_recipient').val();
            const message = $('#id_message').val();

            if (!recipient.trim()) {
                alert('{% trans "Veuillez entrer un destinataire." %}');
                e.preventDefault();
                return false;
            }

            if (!message.trim()) {
                alert('{% trans "Veuillez écrire un message." %}');
                e.preventDefault();
                return false;
            }

            return true;
        });
    });
</script>
{% endblock %}


========== messaging/templates/messaging/guide.html ==========
{# ~/ebi3/messaging/templates/messaging/guide.html #}
{% extends 'messaging/base_messaging.html' %}
{% load i18n %}

{% block title %}{% trans "Guide de la messagerie" %} - Ebi3{% endblock %}

{% block messaging_content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h1 class="mb-0">
                    <i class="fas fa-book"></i> {% trans "Guide de la messagerie Ebi3" %}
                </h1>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Navigation -->
                    <div class="col-md-3">
                        <div class="sticky-top" style="top: 20px;">
                            <nav id="guide-nav" class="nav flex-column">
                                <a class="nav-link" href="#basics">{% trans "Les bases" %}</a>
                                <a class="nav-link" href="#sending">{% trans "Envoyer des messages" %}</a>
                                <a class="nav-link" href="#attachments">{% trans "Pièces jointes" %}</a>
                                <a class="nav-link" href="#privacy">{% trans "Confidentialité" %}</a>
                                <a class="nav-link" href="#troubleshooting">{% trans "Dépannage" %}</a>
                            </nav>
                        </div>
                    </div>

                    <!-- Contenu -->
                    <div class="col-md-9">
                        <!-- Les bases -->
                        <section id="basics" class="mb-5">
                            <h2 class="border-bottom pb-2">
                                <i class="fas fa-graduation-cap text-primary"></i> {% trans "Les bases" %}
                            </h2>
                            <p>{% trans "La messagerie Ebi3 vous permet de communiquer avec d'autres membres de la plateforme." %}</p>

                            <h4>{% trans "Boîte de réception" %}</h4>
                            <p>{% trans "Votre boîte de réception affiche toutes vos conversations. Vous pouvez :" %}</p>
                            <ul>
                                <li>{% trans "Filtrer par type de conversation" %}</li>
                                <li>{% trans "Rechercher dans les messages" %}</li>
                                <li>{% trans "Archiver les anciennes conversations" %}</li>
                                <li>{% trans "Marquer les messages comme lus/non lus" %}</li>
                            </ul>

                            <h4>{% trans "Conversations" %}</h4>
                            <p>{% trans "Une conversation regroupe tous les messages échangés avec une ou plusieurs personnes." %}</p>
                        </section>

                        <!-- Envoyer des messages -->
                        <section id="sending" class="mb-5">
                            <h2 class="border-bottom pb-2">
                                <i class="fas fa-paper-plane text-primary"></i> {% trans "Envoyer des messages" %}
                            </h2>

                            <h4>{% trans "Nouvelle conversation" %}</h4>
                            <p>{% trans "Pour démarrer une nouvelle conversation :" %}</p>
                            <ol>
                                <li>{% trans "Cliquez sur 'Nouveau message'" %}</li>
                                <li>{% trans "Entrez le nom d'utilisateur du destinataire" %}</li>
                                <li>{% trans "Ajoutez un sujet (optionnel)" %}</li>
                                <li>{% trans "Rédigez votre message" %}</li>
                                <li>{% trans "Cliquez sur 'Envoyer'" %}</li>
                            </ol>

                            <h4>{% trans "Répondre à un message" %}</h4>
                            <p>{% trans "Pour répondre à un message existant :" %}</p>
                            <ul>
                                <li>{% trans "Cliquez sur une conversation" %}</li>
                                <li>{% trans "Tapez votre message dans la zone de texte" %}</li>
                                <li>{% trans "Appuyez sur Entrée ou cliquez sur l'icône d'envoi" %}</li>
                            </ul>
                        </section>

                        <!-- Plus de sections... -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #guide-nav .nav-link {
        color: #666;
        border-left: 3px solid transparent;
        padding-left: 15px;
        margin-bottom: 5px;
    }

    #guide-nav .nav-link:hover,
    #guide-nav .nav-link.active {
        color: #2196f3;
        border-left-color: #2196f3;
        background: #f8f9fa;
    }

    section {
        scroll-margin-top: 20px;
    }
</style>

<script>
    $(document).ready(function() {
        // Navigation active
        const sections = $('section');
        const navLinks = $('#guide-nav .nav-link');

        $(window).scroll(function() {
            const currentPos = $(this).scrollTop();

            sections.each(function() {
                const top = $(this).offset().top - 100;
                const bottom = top + $(this).outerHeight();

                if (currentPos >= top && currentPos <= bottom) {
                    const id = $(this).attr('id');
                    navLinks.removeClass('active');
                    $(`#guide-nav .nav-link[href="#${id}"]`).addClass('active');
                }
            });
        });
    });
</script>
{% endblock %}


========== messaging/templates/messaging/blocked_users.html ==========
{# ~/ebi3/messaging/templates/messaging/blocked_users.html #}
{% extends 'messaging/base_messaging.html' %}
{% load i18n %}

{% block title %}{% trans "Utilisateurs bloqués" %} - Ebi3{% endblock %}

{% block messaging_content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-ban"></i> {% trans "Utilisateurs bloqués" %}</h1>
            <a href="{% url 'messaging:inbox' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "Retour" %}
            </a>
        </div>

        {% if blocked_users %}
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for blocked in blocked_users %}
                            <div class="list-group-item">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="conversation-avatar bg-secondary text-white d-flex align-items-center justify-content-center">
                                                {{ blocked.blocked.username|first|upper }}
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">{{ blocked.blocked.username }}</h6>
                                            <small class="text-muted">
                                                {% trans "Bloqué le" %} {{ blocked.created_at|date:"d/m/Y" }}
                                                {% if blocked.reason %}
                                                    • {{ blocked.reason }}
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                    <form method="post" action="{% url 'messaging:unblock_user' blocked.blocked.username %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-check"></i> {% trans "Débloquer" %}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                    <h4>{% trans "Aucun utilisateur bloqué" %}</h4>
                    <p class="text-muted">
                        {% trans "Vous n'avez bloqué aucun utilisateur." %}
                    </p>
                </div>
            </div>
        {% endif %}

        <div class="card shadow-sm mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> {% trans "À propos du blocage" %}</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>{% trans "Les utilisateurs bloqués ne peuvent pas vous envoyer de messages" %}</li>
                    <li>{% trans "Vous ne pouvez pas envoyer de messages aux utilisateurs que vous avez bloqués" %}</li>
                    <li>{% trans "Le blocage est réversible à tout moment" %}</li>
                    <li>{% trans "Les administrateurs peuvent toujours voir les conversations bloquées" %}</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}


========== messaging/templates/messaging/conversation_detail.html ==========
{# ~/ebi3/messaging/templates/messaging/conversation_detail.html #}
{% extends 'messaging/base_messaging.html' %}
{% load i18n %}

{% block title %}{{ conversation.subject|default:other_participant.username }} - {% trans "Conversation" %} - Ebi3{% endblock %}

{% block messaging_content %}
<div class="messaging-container">
    <!-- Sidebar des conversations -->
    <div class="conversations-sidebar">
        <div class="search-container">
            <div class="input-group input-group-sm">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" placeholder="{% trans 'Rechercher...' %}" id="conversation-search">
            </div>
        </div>

        <div class="conversation-list">
            {% for conv in recent_conversations %}
                <div class="conversation-item {% if conv.uuid == conversation.uuid %}active{% endif %} {% if conv.unread_count > 0 %}unread{% endif %}"
                     onclick="location.href='{% url 'messaging:conversation_detail' conv.uuid %}'">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 position-relative">
                            <div class="conversation-avatar bg-primary text-white d-flex align-items-center justify-content-center">
                                {% with other=conv.get_other_participant %}
                                    {{ other.username|first|upper }}
                                {% endwith %}
                            </div>
                            {% with other=conv.get_other_participant %}
                                {% if other.profile.is_online %}
                                    <span class="online-status online position-absolute"
                                          style="bottom: 0; right: 0;"></span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="flex-grow-1 ms-3 overflow-hidden">
                            <div class="d-flex justify-content-between">
                                <h6 class="mb-0 text-truncate">
                                    {% with other=conv.get_other_participant %}
                                        {{ other.username }}
                                    {% endwith %}
                                </h6>
                                <small class="conversation-time">
                                    {% with last_msg=conv.messages.last %}
                                        {% if last_msg %}
                                            {{ last_msg.sent_at|date:"H:i" }}
                                        {% endif %}
                                    {% endwith %}
                                </small>
                            </div>
                            <div class="conversation-preview">
                                {% with last_msg=conv.messages.last %}
                                    {% if last_msg %}
                                        {% if last_msg.sender == request.user %}
                                            <i class="fas fa-reply text-muted me-1"></i>
                                        {% endif %}
                                        {{ last_msg.content|truncatechars:30 }}
                                    {% else %}
                                        {% trans "Aucun message" %}
                                    {% endif %}
                                {% endwith %}
                            </div>
                            {% if conv.unread_count > 0 %}
                                <span class="unread-badge">{{ conv.unread_count }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Contenu de la conversation -->
    <div class="conversation-content">
        <!-- En-tête de la conversation -->
        <div class="d-flex align-items-center justify-content-between border-bottom p-3 bg-light">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0 position-relative me-3">
                    <div class="conversation-avatar bg-primary text-white d-flex align-items-center justify-content-center"
                         style="width: 50px; height: 50px;">
                        {{ other_participant.username|first|upper }}
                    </div>
                    {% if other_participant.profile.is_online %}
                        <span class="online-status online position-absolute"
                              style="bottom: 5px; right: 5px;"></span>
                    {% endif %}
                </div>
                <div>
                    <h5 class="mb-1">
                        {% if conversation.subject %}
                            {{ conversation.subject }}
                        {% else %}
                            {{ other_participant.username }}
                        {% endif %}
                    </h5>
                    <small class="text-muted">
                        {% if other_participant.profile.is_online %}
                            <span class="text-success">
                                <i class="fas fa-circle"></i> {% trans "En ligne" %}
                            </span>
                        {% else %}
                            <span class="text-muted">
                                <i class="fas fa-circle"></i> {% trans "Hors ligne" %}
                            </span>
                        {% endif %}
                        {% if conversation.get_conversation_type_display %}
                            • {{ conversation.get_conversation_type_display }}
                        {% endif %}
                    </small>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                        data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    {% if conversation.subject %}
                        <li><a class="dropdown-item" href="#">
                            <i class="fas fa-edit me-2"></i> {% trans "Modifier le sujet" %}
                        </a></li>
                    {% endif %}
                    <li>
                        <a class="dropdown-item" href="{% url 'messaging:archive_conversation' conversation.uuid %}">
                            <i class="fas fa-archive me-2"></i>
                            {% if conversation.is_archived %}
                                {% trans "Désarchiver" %}
                            {% else %}
                                {% trans "Archiver" %}
                            {% endif %}
                        </a>
                    </li>
                    {% if not is_blocked %}
                        <li>
                            <a class="dropdown-item" href="{% url 'messaging:block_user' other_participant.username %}">
                                <i class="fas fa-ban me-2"></i> {% trans "Bloquer l'utilisateur" %}
                            </a>
                        </li>
                    {% else %}
                        <li>
                            <a class="dropdown-item" href="{% url 'messaging:unblock_user' other_participant.username %}">
                                <i class="fas fa-check me-2"></i> {% trans "Débloquer l'utilisateur" %}
                            </a>
                        </li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item text-danger" href="{% url 'messaging:delete_conversation' conversation.uuid %}"
                           onclick="return confirm('{% trans 'Êtes-vous sûr de vouloir supprimer cette conversation ?' %}')">
                            <i class="fas fa-trash me-2"></i> {% trans "Supprimer la conversation" %}
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Messages -->
        <div class="messages-container" data-conversation-uuid="{{ conversation.uuid }}">
            {% if messages %}
                <!-- Date séparateur -->
                {% for message in messages %}
                    {% ifchanged message.sent_at.date %}
                        <div class="text-center my-4">
                            <span class="badge bg-secondary px-3 py-2">
                                {{ message.sent_at|date:"d F Y" }}
                            </span>
                        </div>
                    {% endifchanged %}

                    <div class="message-bubble {% if message.sender == request.user %}sent{% else %}received{% endif %}"
                         data-message-id="{{ message.id }}">

                        {% if message.sender != request.user %}
                            <div class="message-sender">
                                {{ message.sender.username }}
                                {% if message.sender.profile.is_online %}
                                    <span class="online-status online"></span>
                                {% endif %}
                            </div>
                        {% endif %}

                        <div class="message-text">
                            {{ message.content|linebreaks }}
                        </div>

                        <!-- Pièce jointe -->
                        {% if message.attachment %}
                            {% include 'messaging/partials/attachment_preview.html' with attachment=message.attachment %}
                        {% endif %}

                        <!-- Message parent (réponse) -->
                        {% if message.parent_message %}
                            <div class="reply-to mt-2 p-2 border-start border-3 border-primary bg-light rounded">
                                <small class="text-muted">
                                    <i class="fas fa-reply"></i> {% trans "Réponse à" %} {{ message.parent_message.sender.username }}
                                </small>
                                <div class="small mt-1">
                                    {{ message.parent_message.content|truncatechars:50 }}
                                </div>
                            </div>
                        {% endif %}

                        <div class="message-time">
                            {{ message.sent_at|date:"H:i" }}
                            {% if message.sender == request.user %}
                                {% if message.is_read %}
                                    <i class="fas fa-check-double text-success ms-1" title="{% trans 'Lu' %}"></i>
                                {% else %}
                                    <i class="fas fa-check text-muted ms-1" title="{% trans 'Envoyé' %}"></i>
                                {% endif %}
                            {% endif %}
                        </div>

                        <!-- Actions du message -->
                        <div class="message-actions mt-2 opacity-0" style="transition: opacity 0.2s;">
                            <button class="btn btn-sm btn-outline-secondary reply-btn"
                                    data-message-id="{{ message.id }}"
                                    title="{% trans 'Répondre' %}">
                                <i class="fas fa-reply"></i>
                            </button>
                            {% if message.sender == request.user %}
                                <button class="btn btn-sm btn-outline-warning edit-btn"
                                        data-message-id="{{ message.id }}"
                                        title="{% trans 'Modifier' %}">
                                    <i class="fas fa-edit"></i>
                                </button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-danger delete-btn"
                                    data-message-id="{{ message.id }}"
                                    data-url="{% url 'messaging:delete_message' message.uuid %}"
                                    title="{% trans 'Supprimer' %}">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info report-btn"
                                    data-message-id="{{ message.id }}"
                                    data-url="{% url 'messaging:report_message' message.uuid %}"
                                    title="{% trans 'Signaler' %}">
                                <i class="fas fa-flag"></i>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                    <h4>{% trans "Commencez la conversation" %}</h4>
                    <p class="text-muted">
                        {% trans "Envoyez votre premier message à" %} {{ other_participant.username }}
                    </p>
                </div>
            {% endif %}
        </div>

        <!-- Indicateur de frappe -->
        <div id="typing-indicator" class="d-none">
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- Formulaire d'envoi de message -->
        <div class="message-input-container">
            {% if can_send_message and not is_blocked %}
                <form method="post" action="{% url 'messaging:send_message' conversation.uuid %}"
                      id="message-form" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Prévisualisation du fichier -->
                    <div id="file-preview" class="mb-3"></div>

                    <div class="input-group">
                        <button type="button" class="btn btn-outline-secondary emoji-btn"
                                data-bs-toggle="tooltip" title="{% trans 'Émojis' %}">
                            <i class="far fa-smile"></i>
                        </button>

                        <button type="button" class="btn btn-outline-secondary attachment-btn"
                                onclick="$('#id_attachment').click()"
                                data-bs-toggle="tooltip" title="{% trans 'Pièce jointe' %}">
                            <i class="fas fa-paperclip"></i>
                        </button>

                        <input type="file" name="attachment" id="id_attachment" class="d-none">

                        <textarea name="content" class="form-control message-input"
                                  placeholder="{% trans 'Tapez votre message ici...' %}"
                                  rows="1" required></textarea>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>

                    <div class="mt-2 small text-muted">
                        <i class="fas fa-info-circle"></i>
                        {% trans "Appuyez sur Ctrl+Enter pour envoyer" %}
                    </div>
                </form>
            {% elif is_blocked %}
                <div class="alert alert-warning text-center">
                    <i class="fas fa-ban"></i>
                    {% trans "Vous avez bloqué cet utilisateur. Vous ne pouvez pas lui envoyer de messages." %}
                    <a href="{% url 'messaging:unblock_user' other_participant.username %}" class="alert-link">
                        {% trans "Débloquer" %}
                    </a>
                </div>
            {% else %}
                <div class="alert alert-warning text-center">
                    <i class="fas fa-lock"></i>
                    {% trans "Cet utilisateur n'accepte pas de messages pour le moment." %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Modal de réponse -->
<div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Répondre au message" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="original-message" class="mb-3 p-2 bg-light rounded"></div>
                <textarea class="form-control" rows="3" placeholder="{% trans 'Votre réponse...' %}"
                          id="reply-content"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Annuler" %}
                </button>
                <button type="button" class="btn btn-primary" id="send-reply">
                    <i class="fas fa-paper-plane"></i> {% trans "Envoyer la réponse" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'édition -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Modifier le message" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" rows="3" placeholder="{% trans 'Modifier le message...' %}"
                          id="edit-content"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Annuler" %}
                </button>
                <button type="button" class="btn btn-primary" id="save-edit">
                    <i class="fas fa-save"></i> {% trans "Enregistrer" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Hover sur les messages pour afficher les actions
        $('.message-bubble').hover(function() {
            $(this).find('.message-actions').css('opacity', '1');
        }, function() {
            $(this).find('.message-actions').css('opacity', '0');
        });

        // Répondre à un message
        $('.reply-btn').click(function() {
            const messageId = $(this).data('message-id');
            const messageContent = $(this).closest('.message-bubble').find('.message-text').text();

            $('#original-message').html(`<strong>Message original:</strong><br>${messageContent}`);
            $('#replyModal').data('message-id', messageId);
            $('#replyModal').modal('show');
        });

        // Envoyer la réponse
        $('#send-reply').click(function() {
            const messageId = $('#replyModal').data('message-id');
            const content = $('#reply-content').val();

            $.post(`/messaging/message/${messageId}/reply/`, {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                content: content,
                parent_message_id: messageId
            }, function(response) {
                if (response.success) {
                    $('#replyModal').modal('hide');
                    $('#reply-content').val('');
                    // Ajouter le nouveau message à la conversation
                    location.reload();
                }
            });
        });

        // Supprimer un message
        $('.delete-btn').click(function() {
            if (confirm('{% trans "Êtes-vous sûr de vouloir supprimer ce message ?" %}')) {
                const url = $(this).data('url');
                $.post(url, {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }, function() {
                    location.reload();
                });
            }
        });

        // Signaler un message
        $('.report-btn').click(function() {
            const url = $(this).data('url');
            location.href = url;
        });

        // Auto-expansion de la zone de texte
        $('.message-input').on('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Envoi du formulaire AJAX
        $('#message-form').submit(function(e) {
            e.preventDefault();

            const form = $(this);
            const formData = new FormData(form[0]);

            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        // Ajouter le nouveau message
                        const messageHtml = `
                            <div class="message-bubble sent message-enter">
                                <div class="message-text">${response.content}</div>
                                <div class="message-time">${response.sent_at}</div>
                            </div>
                        `;
                        $('.messages-container').append(messageHtml);
                        $('.message-input').val('');
                        $('.message-input').height('auto');
                        $('#file-preview').empty();
                        $('input[type="file"]').val('');

                        // Scroll vers le bas
                        const container = $('.messages-container');
                        container.scrollTop(container[0].scrollHeight);
                    }
                }
            });
        });
    });
</script>
{% endblock %}


========== messaging/templates/messaging/settings.html ==========
{# ~/ebi3/messaging/templates/messaging/settings.html #}
{% extends 'messaging/base_messaging.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Paramètres de messagerie" %} - Ebi3{% endblock %}

{% block messaging_content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="fas fa-cog"></i> {% trans "Paramètres de messagerie" %}
                </h2>
            </div>

            <div class="card-body p-0">
                <!-- Navigation des onglets -->
                <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="notifications-tab" data-bs-toggle="tab"
                                data-bs-target="#notifications" type="button">
                            <i class="fas fa-bell"></i> {% trans "Notifications" %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="privacy-tab" data-bs-toggle="tab"
                                data-bs-target="#privacy" type="button">
                            <i class="fas fa-shield-alt"></i> {% trans "Confidentialité" %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="appearance-tab" data-bs-toggle="tab"
                                data-bs-target="#appearance" type="button">
                            <i class="fas fa-paint-brush"></i> {% trans "Apparence" %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="storage-tab" data-bs-toggle="tab"
                                data-bs-target="#storage" type="button">
                            <i class="fas fa-database"></i> {% trans "Stockage" %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="security-tab" data-bs-toggle="tab"
                                data-bs-target="#security" type="button">
                            <i class="fas fa-lock"></i> {% trans "Sécurité" %}
                        </button>
                    </li>
                </ul>

                <!-- Contenu des onglets -->
                <div class="tab-content p-4" id="settingsTabsContent">
                    <!-- Notifications -->
                    <div class="tab-pane fade show active" id="notifications" role="tabpanel">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="tab" value="notifications">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">{% trans "Types de notifications" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    {{ form.email_notifications }}
                                                    <label class="form-check-label" for="{{ form.email_notifications.id_for_label }}">
                                                        {% trans "Notifications par email" %}
                                                    </label>
                                                </div>
                                                <small class="text-muted">
                                                    {% trans "Recevez des emails pour les nouveaux messages" %}
                                                </small>
                                            </div>

                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    {{ form.push_notifications }}
                                                    <label class="form-check-label" for="{{ form.push_notifications.id_for_label }}">
                                                        {% trans "Notifications push" %}
                                                    </label>
                                                </div>
                                                <small class="text-muted">
                                                    {% trans "Notifications sur votre appareil mobile" %}
                                                </small>
                                            </div>

                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    {{ form.desktop_notifications }}
                                                    <label class="form-check-label" for="{{ form.desktop_notifications.id_for_label }}">
                                                        {% trans "Notifications bureau" %}
                                                    </label>
                                                </div>
                                                <small class="text-muted">
                                                    {% trans "Notifications sur votre ordinateur" %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">{% trans "Préférences de notification" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle"></i>
                                                {% trans "Vous recevrez des notifications pour :" %}
                                                <ul class="mb-0 mt-2">
                                                    <li>{% trans "Nouveaux messages" %}</li>
                                                    <li>{% trans "Messages non lus" %}</li>
                                                    <li>{% trans "Nouvelles conversations" %}</li>
                                                    <li>{% trans "Messages importants" %}</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> {% trans "Enregistrer les modifications" %}
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Confidentialité -->
                    <div class="tab-pane fade" id="privacy" role="tabpanel">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="tab" value="privacy">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">{% trans "Qui peut vous contacter ?" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">{% trans "Autoriser les messages de :" %}</label>
                                                {{ form.allow_messages_from }}
                                                <div class="form-text">
                                                    {% trans "Contrôlez qui peut vous envoyer des messages" %}
                                                </div>
                                            </div>

                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <strong>{% trans "Note :" %}</strong>
                                                {% trans "Les administrateurs peuvent toujours vous contacter pour les communications importantes." %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">{% trans "Visibilité" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    {{ form.show_online_status }}
                                                    <label class="form-check-label" for="{{ form.show_online_status.id_for_label }}">
                                                        {% trans "Afficher le statut en ligne" %}
                                                    </label>
                                                </div>
                                                <small class="text-muted">
                                                    {% trans "Les autres utilisateurs verront si vous êtes en ligne" %}
                                                </small>
                                            </div>

                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    {{ form.show_read_receipts }}
                                                    <label class="form-check-label" for="{{ form.show_read_receipts.id_for_label }}">
                                                        {% trans "Afficher les accusés de lecture" %}
                                                    </label>
                                                </div>
                                                <small class="text-muted">
                                                    {% trans "Les expéditeurs sauront quand vous avez lu leurs messages" %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> {% trans "Enregistrer les modifications" %}
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Apparence -->
                    <div class="tab-pane fade" id="appearance" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">{% trans "Thème de messagerie" %}</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6 mb-3">
                                                <div class="theme-option p-3 border rounded text-center cursor-pointer"
                                                     data-theme="light">
                                                    <i class="fas fa-sun fa-2x mb-2"></i>
                                                    <div>{% trans "Clair" %}</div>
                                                </div>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <div class="theme-option p-3 border rounded text-center cursor-pointer"
                                                     data-theme="dark">
                                                    <i class="fas fa-moon fa-2x mb-2"></i>
                                                    <div>{% trans "Sombre" %}</div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="theme-option p-3 border rounded text-center cursor-pointer"
                                                     data-theme="blue">
                                                    <i class="fas fa-tint fa-2x mb-2"></i>
                                                    <div>{% trans "Bleu" %}</div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="theme-option p-3 border rounded text-center cursor-pointer"
                                                     data-theme="green">
                                                    <i class="fas fa-leaf fa-2x mb-2"></i>
                                                    <div>{% trans "Vert" %}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">{% trans "Aperçu" %}</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="preview-messages">
                                            <div class="message-bubble received mb-2">
                                                <div class="message-sender">Utilisateur</div>
                                                <div class="message-text">Bonjour ! Comment ça va ?</div>
                                                <div class="message-time">10:30</div>
                                            </div>
                                            <div class="message-bubble sent mb-2">
                                                <div class="message-text">Ça va bien, merci !</div>
                                                <div class="message-time">10:31</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-primary" id="save-theme">
                                <i class="fas fa-save"></i> {% trans "Appliquer le thème" %}
                            </button>
                        </div>
                    </div>

                    <!-- Stockage -->
                    <div class="tab-pane fade" id="storage" role="tabpanel">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="tab" value="storage">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">{% trans "Gestion automatique" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    {{ form.auto_archive_conversations }}
                                                    <label class="form-check-label" for="{{ form.auto_archive_conversations.id_for_label }}">
                                                        {% trans "Archiver automatiquement les conversations" %}
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">{% trans "Archiver après :" %}</label>
                                                <div class="input-group">
                                                    {{ form.archive_after_days }}
                                                    <span class="input-group-text">{% trans "jours" %}</span>
                                                </div>
                                                <div class="form-text">
                                                    {% trans "Archiver automatiquement les conversations inactives" %}
                                                </div>
                                            </div>

                                            <hr>

                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    {{ form.auto_delete_messages }}
                                                    <label class="form-check-label" for="{{ form.auto_delete_messages.id_for_label }}">
                                                        {% trans "Supprimer automatiquement les messages" %}
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">{% trans "Supprimer après :" %}</label>
                                                <div class="input-group">
                                                    {{ form.delete_after_days }}
                                                    <span class="input-group-text">{% trans "jours" %}</span>
                                                </div>
                                                <div class="form-text">
                                                    {% trans "Supprimer automatiquement les anciens messages" %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">{% trans "Statistiques de stockage" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">{% trans "Messages stockés :" %}</label>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-success" style="width: 65%">
                                                        65% (1,250 messages)
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">{% trans "Pièces jointes :" %}</label>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-info" style="width: 30%">
                                                        30% (150 MB)
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">{% trans "Espace total utilisé :" %}</label>
                                                <div class="d-flex justify-content-between">
                                                    <span>200 MB</span>
                                                    <span class="text-muted">sur 1 GB</span>
                                                </div>
                                            </div>

                                            <hr>

                                            <button type="button" class="btn btn-outline-danger w-100"
                                                    onclick="confirmCleanup()">
                                                <i class="fas fa-broom"></i> {% trans "Nettoyer le stockage" %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> {% trans "Enregistrer les modifications" %}
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Sécurité -->
                    <div class="tab-pane fade" id="security" role="tabpanel">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="tab" value="security">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">{% trans "Filtres de sécurité" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    {{ form.block_spam_messages }}
                                                    <label class="form-check-label" for="{{ form.block_spam_messages.id_for_label }}">
                                                        {% trans "Bloquer les messages indésirables" %}
                                                    </label>
                                                </div>
                                                <small class="text-muted">
                                                    {% trans "Filtrer automatiquement les messages suspects" %}
                                                </small>
                                            </div>

                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    {{ form.filter_profanity }}
                                                    <label class="form-check-label" for="{{ form.filter_profanity.id_for_label }}">
                                                        {% trans "Filtrer les gros mots" %}
                                                    </label>
                                                </div>
                                                <small class="text-muted">
                                                    {% trans "Masquer automatiquement le langage inapproprié" %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">{% trans "Journal de sécurité" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-info">
                                                <i class="fas fa-shield-alt"></i>
                                                <strong>{% trans "Dernières activités :" %}</strong>
                                                <ul class="mb-0 mt-2">
                                                    <li>{% trans "Connexion depuis Paris - Aujourd'hui 10:30" %}</li>
                                                    <li>{% trans "Message supprimé - Hier 15:45" %}</li>
                                                    <li>{% trans "Utilisateur bloqué - 2 jours" %}</li>
                                                </ul>
                                            </div>

                                            <a href="#" class="btn btn-outline-info w-100">
                                                <i class="fas fa-history"></i> {% trans "Voir le journal complet" %}
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> {% trans "Enregistrer les modifications" %}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sauvegarde des paramètres -->
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-cloud-download-alt"></i> {% trans "Sauvegarder vos paramètres" %}</h5>
                        <p class="text-muted">
                            {% trans "Téléchargez une copie de vos paramètres de messagerie." %}
                        </p>
                        <button class="btn btn-outline-primary">
                            <i class="fas fa-download"></i> {% trans "Télécharger la sauvegarde" %}
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-redo"></i> {% trans "Réinitialiser les paramètres" %}</h5>
                        <p class="text-muted">
                            {% trans "Remettre tous les paramètres à leurs valeurs par défaut." %}
                        </p>
                        <button class="btn btn-outline-danger" onclick="confirmReset()">
                            <i class="fas fa-undo"></i> {% trans "Réinitialiser" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Sélection de thème
        $('.theme-option').click(function() {
            $('.theme-option').removeClass('border-primary bg-light');
            $(this).addClass('border-primary bg-light');
            const theme = $(this).data('theme');

            // Appliquer l'aperçu
            $('.preview-messages').removeClass('theme-light theme-dark theme-blue theme-green');
            $('.preview-messages').addClass('theme-' + theme);
        });

        // Sauvegarder le thème
        $('#save-theme').click(function() {
            const theme = $('.theme-option.border-primary').data('theme');
            $.post('/api/messaging/settings/theme/', {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                theme: theme
            }, function(response) {
                if (response.success) {
                    showToast('{% trans "Thème appliqué avec succès !" %}', 'success');
                    // Recharger pour appliquer le thème
                    setTimeout(() => location.reload(), 1000);
                }
            });
        });

        // Confirmation de nettoyage
        window.confirmCleanup = function() {
            if (confirm('{% trans "Êtes-vous sûr de vouloir nettoyer le stockage ? Cette action supprimera les messages et pièces jointes les plus anciens." %}')) {
                $.post('/api/messaging/cleanup/', {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }, function(response) {
                    if (response.success) {
                        showToast('{% trans "Nettoyage terminé !" %}', 'success');
                        location.reload();
                    }
                });
            }
        };

        // Confirmation de réinitialisation
        window.confirmReset = function() {
            if (confirm('{% trans "Êtes-vous sûr de vouloir réinitialiser tous vos paramètres ? Cette action est irréversible." %}')) {
                $.post('/api/messaging/settings/reset/', {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }, function(response) {
                    if (response.success) {
                        showToast('{% trans "Paramètres réinitialisés !" %}', 'success');
                        location.reload();
                    }
                });
            }
        };

        // Fonction pour afficher les toasts
        function showToast(message, type) {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            $('.toast-container').append(toastHtml);
            $('.toast').toast('show');

            $('.toast').on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }
    });
</script>

<style>
    .theme-option {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .theme-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .theme-option.border-primary {
        border-width: 2px !important;
    }

    /* Aperçu des thèmes */
    .theme-light .message-bubble.received {
        background: #f1f1f1;
        color: #333;
    }

    .theme-dark .message-bubble.received {
        background: #2d2d2d;
        color: #fff;
    }

    .theme-blue .message-bubble.received {
        background: #e3f2fd;
        color: #1565c0;
    }

    .theme-green .message-bubble.received {
        background: #e8f5e9;
        color: #2e7d32;
    }
</style>
{% endblock %}


========== messaging/templates/messaging/report_message.html ==========
{# ~/ebi3/messaging/templates/messaging/report_message.html #}
{% extends 'messaging/base_messaging.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Signaler un message" %} - Ebi3{% endblock %}

{% block messaging_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-lg">
            <div class="card-header bg-warning text-white">
                <h2 class="mb-0">
                    <i class="fas fa-flag"></i> {% trans "Signaler un message" %}
                </h2>
            </div>
            <div class="card-body">
                <!-- Message original -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">{% trans "Message à signaler" %}</h6>
                    </div>
                    <div class="card-body">
                        <div class="message-bubble {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                            <div class="message-sender">{{ message.sender.username }}</div>
                            <div class="message-text">{{ message.content }}</div>
                            <div class="message-time">{{ message.sent_at|date:"d/m/Y H:i" }}</div>
                        </div>
                    </div>
                </div>

                <!-- Formulaire de signalement -->
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    {{ form|crispy }}

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>{% trans "Important :" %}</strong>
                        {% trans "Votre signalement sera examiné par notre équipe de modération. Vous serez informé de l'issue de l'examen." %}
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="{% url 'messaging:conversation_detail' message.conversation.uuid %}"
                           class="btn btn-secondary me-md-2">
                            <i class="fas fa-times"></i> {% trans "Annuler" %}
                        </a>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-flag"></i> {% trans "Signaler le message" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Informations sur le signalement -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-question-circle"></i> {% trans "Pourquoi signaler un message ?" %}</h5>
            </div>
            <div class="card-body">
                <p>{% trans "Signalez un message s'il contient :" %}</p>
                <ul>
                    <li>{% trans "Contenu offensant, haineux ou discriminatoire" %}</li>
                    <li>{% trans "Spam ou publicité non sollicitée" %}</li>
                    <li>{% trans "Menaces ou harcèlement" %}</li>
                    <li>{% trans "Contenu illégal ou dangereux" %}</li>
                    <li>{% trans "Tentative d'arnaque ou de fraude" %}</li>
                    <li>{% trans "Informations personnelles sans consentement" %}</li>
                </ul>
                <p class="mb-0">
                    <strong>{% trans "Note :" %}</strong>
                    {% trans "Les signalements abusifs peuvent entraîner des sanctions." %}
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}


========== messaging/templates/messaging/generic_list.html ==========
{# ~/ebi3/messaging/templates/messaging/generic_list.html #}
{% extends 'messaging/base_messaging.html' %}
{% load i18n %}

{% block title %}{{ title }} - Ebi3{% endblock %}

{% block messaging_content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="{{ icon }}"></i> {{ title }}
                {% if count > 0 %}
                    <span class="badge bg-info ms-2">{{ count }}</span>
                {% endif %}
            </h1>
            <a href="{% url 'messaging:inbox' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "Retour à la boîte de réception" %}
            </a>
        </div>
        <p class="text-muted">{{ description }}</p>
    </div>
</div>

{% if items %}
    <div class="card shadow-sm">
        <div class="card-body p-0">
            {% if template_name == 'conversation' %}
                <div class="list-group list-group-flush">
                    {% for item in items %}
                        {% include 'messaging/partials/conversation_list_item.html' with conversation=item %}
                    {% endfor %}
                </div>
            {% elif template_name == 'message' %}
                <div class="list-group list-group-flush">
                    {% for item in items %}
                        <div class="list-group-item">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 me-3">
                                    <div class="conversation-avatar bg-primary text-white d-flex align-items-center justify-content-center">
                                        {% if item.sender == request.user %}
                                            <i class="fas fa-paper-plane"></i>
                                        {% else %}
                                            {{ item.sender.username|first|upper }}
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        {% if item.sender == request.user %}
                                            {% trans "À" %} {{ item.recipient.username }}
                                        {% else %}
                                            {% trans "De" %} {{ item.sender.username }}
                                        {% endif %}
                                    </h6>
                                    <p class="mb-1 text-truncate">{{ item.content|truncatechars:100 }}</p>
                                    <small class="text-muted">
                                        {{ item.sent_at|date:"d/m/Y H:i" }}
                                        {% if item.conversation.subject %}
                                            • {{ item.conversation.subject }}
                                        {% endif %}
                                    </small>
                                </div>
                                <div>
                                    <a href="{% url 'messaging:conversation_detail' item.conversation.uuid %}"
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Pagination -->
            {% if is_paginated %}
                <nav class="p-3">
                    <ul class="pagination justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    </div>
{% else %}
    <div class="card shadow-sm">
        <div class="card-body text-center py-5">
            <i class="{{ empty_icon|default:'fas fa-inbox' }} fa-4x text-muted mb-3"></i>
            <h4>{{ empty_title }}</h4>
            <p class="text-muted">{{ empty_message }}</p>
            <a href="{% url 'messaging:inbox' %}" class="btn btn-primary mt-3">
                <i class="fas fa-inbox"></i> {% trans "Retour à la boîte de réception" %}
            </a>
        </div>
    </div>
{% endif %}
{% endblock %}


========== messaging/templates/messaging/base_messaging.html ==========
{# ~/ebi3/messaging/templates/messaging/base_messaging.html #}
{% extends 'core/base.html' %}
{% load i18n %}

{% block extra_css %}
<style>
    /* Styles spécifiques à la messagerie */
    .messaging-container {
        display: flex;
        height: calc(100vh - 200px);
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
    }

    .conversations-sidebar {
        width: 350px;
        border-right: 1px solid #e0e0e0;
        background: #f8f9fa;
        overflow-y: auto;
    }

    .conversation-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
    }

    .message-input-container {
        border-top: 1px solid #e0e0e0;
        padding: 20px;
        background: white;
    }

    /* Styles des conversations */
    .conversation-item {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .conversation-item:hover {
        background: #e9ecef;
    }

    .conversation-item.active {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
    }

    .conversation-item.unread {
        background: #fff3e0;
    }

    .conversation-item.unread.active {
        background: #ffe0b2;
    }

    .conversation-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .conversation-preview {
        font-size: 0.9rem;
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 200px;
    }

    .conversation-time {
        font-size: 0.8rem;
        color: #999;
    }

    .unread-badge {
        background: #ff5722;
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        min-width: 20px;
        text-align: center;
        font-weight: bold;
    }

    /* Styles des messages */
    .message-bubble {
        max-width: 70%;
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
    }

    .message-bubble.sent {
        background: #2196f3;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 5px;
    }

    .message-bubble.received {
        background: #f1f1f1;
        color: #333;
        margin-right: auto;
        border-bottom-left-radius: 5px;
    }

    .message-bubble .message-time {
        font-size: 0.75rem;
        opacity: 0.8;
        margin-top: 5px;
        text-align: right;
    }

    .message-bubble.sent .message-time {
        color: rgba(255, 255, 255, 0.9);
    }

    .message-bubble.received .message-time {
        color: #666;
    }

    .message-bubble .message-sender {
        font-weight: bold;
        font-size: 0.85rem;
        margin-bottom: 3px;
        color: #666;
    }

    /* Pièces jointes */
    .attachment-preview {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
        background: white;
    }

    .attachment-icon {
        font-size: 2rem;
        color: #666;
    }

    /* Notifications */
    .notification-item {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        transition: background 0.2s ease;
    }

    .notification-item.unread {
        background: #f0f7ff;
        border-left: 4px solid #2196f3;
    }

    .notification-item:hover {
        background: #e9ecef;
    }

    .notification-time {
        font-size: 0.8rem;
        color: #999;
    }

    /* Typing indicator */
    .typing-indicator {
        display: flex;
        padding: 10px 15px;
        background: #f1f1f1;
        border-radius: 18px;
        width: fit-content;
        margin-bottom: 15px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #666;
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
        30% { transform: translateY(-5px); opacity: 1; }
    }

    /* Search and filters */
    .search-container {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        background: white;
    }

    /* Online status */
    .online-status {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }

    .online-status.online {
        background: #4caf50;
    }

    .online-status.offline {
        background: #999;
    }

    .online-status.away {
        background: #ff9800;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .messaging-container {
            flex-direction: column;
            height: auto;
        }

        .conversations-sidebar {
            width: 100%;
            height: 300px;
            border-right: none;
            border-bottom: 1px solid #e0e0e0;
        }

        .message-bubble {
            max-width: 85%;
        }
    }

    /* Animations */
    .message-enter {
        animation: messageEnter 0.3s ease;
    }

    @keyframes messageEnter {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Scrollbar styling */
    .messages-container::-webkit-scrollbar {
        width: 8px;
    }

    .messages-container::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .messages-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .messages-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Loading spinner */
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #2196f3;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    {% block messaging_content %}{% endblock %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Scripts de base pour la messagerie
    $(document).ready(function() {
        // Auto-scroll vers le bas des messages
        function scrollToBottom() {
            const container = $('.messages-container');
            container.scrollTop(container[0].scrollHeight);
        }

        // Initial scroll to bottom
        setTimeout(scrollToBottom, 100);

        // Mark messages as read when visible
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const messageId = entry.target.dataset.messageId;
                    if (messageId && !entry.target.dataset.read) {
                        // Mark as read via AJAX
                        $.post(`/messaging/api/message/${messageId}/read/`, {
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        });
                        entry.target.dataset.read = 'true';
                    }
                }
            });
        }, { threshold: 0.5 });

        // Observe all unread messages
        $('.message-bubble[data-message-id]').each(function() {
            observer.observe(this);
        });

        // Check for new messages periodically
        let lastMessageId = 0;
        function checkNewMessages() {
            const conversationUuid = $('.messages-container').data('conversation-uuid');
            if (!conversationUuid) return;

            $.get(`/messaging/api/check-new-messages/?conversation_uuid=${conversationUuid}&last_message_id=${lastMessageId}`, function(data) {
                if (data.has_new) {
                    // Add new messages
                    data.messages.forEach(msg => {
                        const messageHtml = `
                            <div class="message-bubble ${msg.is_own ? 'sent' : 'received'} message-enter"
                                 data-message-id="${msg.id}">
                                ${msg.is_own ? '' : `<div class="message-sender">${msg.sender}</div>`}
                                <div class="message-text">${msg.content}</div>
                                <div class="message-time">${msg.sent_at}</div>
                            </div>
                        `;
                        $('.messages-container').append(messageHtml);
                        lastMessageId = msg.id;
                    });

                    // Scroll to bottom if user is near bottom
                    const container = $('.messages-container');
                    const isNearBottom = container.scrollTop() + container.innerHeight() >= container[0].scrollHeight - 100;
                    if (isNearBottom) {
                        scrollToBottom();
                    }

                    // Update unread count
                    updateUnreadCount();
                }
            });
        }

        // Update unread count
        function updateUnreadCount() {
            $.get('/messaging/api/unread-count/', function(data) {
                $('#unread-count').text(data.unread_count);
                if (data.unread_count > 0) {
                    $('#unread-count').addClass('badge bg-danger');
                } else {
                    $('#unread-count').removeClass('badge bg-danger');
                }
            });
        }

        // Check for new messages every 5 seconds
        setInterval(checkNewMessages, 5000);

        // File upload preview
        $('input[type="file"]').change(function() {
            const file = this.files[0];
            if (file) {
                const preview = $('#file-preview');
                preview.html(`
                    <div class="attachment-preview">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file attachment-icon me-3"></i>
                            <div>
                                <div class="fw-bold">${file.name}</div>
                                <div class="text-muted small">${(file.size / 1024).toFixed(1)} KB</div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-auto remove-file">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `);

                // Remove file button
                $('.remove-file').click(function() {
                    $('input[type="file"]').val('');
                    preview.empty();
                });
            }
        });

        // Send message on Ctrl+Enter
        $('.message-input').keydown(function(e) {
            if (e.ctrlKey && e.keyCode === 13) {
                e.preventDefault();
                $(this).closest('form').submit();
            }
        });

        // Typing indicator
        let typingTimeout;
        $('.message-input').on('input', function() {
            // Implement typing indicator logic here
            // This would require WebSockets or similar technology
        });

        // Initialize tooltips
        $('[data-bs-toggle="tooltip"]').tooltip();

        // Initialize emoji picker
        $('.emoji-btn').click(function() {
            // Implement emoji picker
        });
    });
</script>
{% endblock %}


========== messaging/templates/messaging/inbox.html ==========
{# ~/ebi3/messaging/templates/messaging/inbox.html #}
{% extends 'messaging/base_messaging.html' %}
{% load i18n %}

{% block title %}{% trans "Boîte de réception" %} - Ebi3{% endblock %}

{% block messaging_content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="fas fa-inbox"></i> {% trans "Boîte de réception" %}
                {% if unread_messages_count > 0 %}
                    <span id="unread-count" class="badge bg-danger ms-2">{{ unread_messages_count }}</span>
                {% endif %}
            </h1>
            <div>
                <a href="{% url 'messaging:new_conversation' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> {% trans "Nouveau message" %}
                </a>
                <div class="dropdown d-inline-block ms-2">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                        <i class="fas fa-filter"></i> {% trans "Filtrer" %}
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="{% url 'messaging:unread' %}">
                                <i class="fas fa-envelope"></i> {% trans "Non lus" %}
                                {% if unread_messages_count > 0 %}
                                    <span class="badge bg-danger float-end">{{ unread_messages_count }}</span>
                                {% endif %}
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{% url 'messaging:sent' %}">
                                <i class="fas fa-paper-plane"></i> {% trans "Envoyés" %}
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{% url 'messaging:archived' %}">
                                <i class="fas fa-archive"></i> {% trans "Archivés" %}
                                {% if archived_conversations_count > 0 %}
                                    <span class="badge bg-info float-end">{{ archived_conversations_count }}</span>
                                {% endif %}
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="{% url 'messaging:with_attachments' %}">
                                <i class="fas fa-paperclip"></i> {% trans "Avec pièces jointes" %}
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <p class="text-muted">
            {% blocktranslate count total=total_conversations %}
                {{ total }} conversation
            {% plural %}
                {{ total }} conversations
            {% endblocktranslate %}
        </p>
    </div>
</div>

<div class="row">
    <div class="col-md-4 col-lg-3 mb-4">
        <!-- Filtres rapides -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-filter"></i> {% trans "Filtres rapides" %}</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <a href="{% url 'messaging:inbox' %}"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if not request.GET.conversation_type %}active{% endif %}">
                        <span>
                            <i class="fas fa-inbox me-2"></i> {% trans "Toutes" %}
                        </span>
                        <span class="badge bg-secondary rounded-pill">{{ total_conversations }}</span>
                    </a>
                    {% for type_code, type_name in conversation_types %}
                        <a href="?conversation_type={{ type_code }}"
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if request.GET.conversation_type == type_code %}active{% endif %}">
                            <span>
                                <i class="fas fa-{{ type_code|lower }} me-2"></i> {{ type_name }}
                            </span>
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Contacts fréquents -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-users"></i> {% trans "Contacts fréquents" %}</h6>
            </div>
            <div class="card-body">
                {% for contact in frequent_contacts|slice:":5" %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <div class="conversation-avatar bg-primary text-white d-flex align-items-center justify-content-center"
                                 style="width: 40px; height: 40px;">
                                {{ contact.username|first|upper }}
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="fw-bold">{{ contact.username }}</div>
                            <div class="small text-muted">{{ contact.get_role_display }}</div>
                        </div>
                        <a href="{% url 'messaging:new_conversation_with_user' contact.username %}"
                           class="btn btn-sm btn-outline-primary" title="{% trans 'Envoyer un message' %}">
                            <i class="fas fa-paper-plane"></i>
                        </a>
                    </div>
                {% empty %}
                    <p class="text-muted text-center small mb-0">
                        <i class="fas fa-info-circle"></i> {% trans "Aucun contact récent" %}
                    </p>
                {% endfor %}
                <a href="{% url 'users:user_list' %}" class="btn btn-sm btn-outline-secondary w-100 mt-2">
                    <i class="fas fa-search"></i> {% trans "Trouver des contacts" %}
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-8 col-lg-9">
        <!-- Recherche -->
        <div class="card shadow-sm mb-4">
            <div class="card-body p-0">
                <form method="get" class="search-container">
                    <div class="input-group">
                        <input type="text" name="q" class="form-control"
                               placeholder="{% trans 'Rechercher dans les conversations...' %}"
                               value="{{ request.GET.q|default:'' }}">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                        {% if request.GET.q %}
                            <a href="{% url 'messaging:inbox' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <!-- Liste des conversations -->
        <div class="card shadow-sm">
            <div class="card-body p-0">
                {% if conversations %}
                    <div class="list-group list-group-flush">
                        {% for conversation in conversations %}
                            {% include 'messaging/partials/conversation_list_item.html' with conversation=conversation %}
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if is_paginated %}
                        <nav class="p-3">
                            <ul class="pagination justify-content-center mb-0">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                                {{ num }}
                                            </a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                        <h4>{% trans "Votre boîte de réception est vide" %}</h4>
                        <p class="text-muted">
                            {% trans "Commencez une nouvelle conversation pour discuter avec d'autres membres." %}
                        </p>
                        <a href="{% url 'messaging:new_conversation' %}" class="btn btn-primary mt-3">
                            <i class="fas fa-plus"></i> {% trans "Nouveau message" %}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Variables globales pour le template -->
<script>
    const conversation_types = [
        {% for type_code, type_name in conversation_types %}
            ['{{ type_code }}', '{{ type_name }}'],
        {% endfor %}
    ];
</script>
{% endblock %}


========== messaging/templates/partials/notification_item.html ==========
{# ~/ebi3/messaging/templates/messaging/partials/notification_item.html #}
<div class="list-group-item notification-item {% if not notification.is_read %}unread{% endif %}">
    <div class="d-flex align-items-start">
        <!-- Icône -->
        <div class="flex-shrink-0 me-3">
            <div class="notification-icon
                        {% if notification.notification_type == 'MESSAGE_RECEIVED' %}text-primary
                        {% elif notification.notification_type == 'MESSAGE_READ' %}text-success
                        {% elif notification.notification_type == 'SYSTEM' %}text-info
                        {% else %}text-warning{% endif %}">
                <i class="fas
                    {% if notification.notification_type == 'MESSAGE_RECEIVED' %}fa-envelope
                    {% elif notification.notification_type == 'MESSAGE_READ' %}fa-check-double
                    {% elif notification.notification_type == 'SYSTEM' %}fa-info-circle
                    {% elif notification.notification_type == 'AD_RELATED' %}fa-ad
                    {% elif notification.notification_type == 'PAYMENT' %}fa-credit-card
                    {% else %}fa-bell{% endif %} fa-2x">
                </i>
            </div>
        </div>

        <!-- Contenu -->
        <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">
                        {% if not notification.is_read %}
                            <span class="badge bg-danger me-2">{% trans "Nouveau" %}</span>
                        {% endif %}
                        {{ notification.title }}
                        {% if notification.is_important %}
                            <i class="fas fa-star text-warning ms-1" title="{% trans 'Important' %}"></i>
                        {% endif %}
                    </h6>
                    <p class="mb-1">{{ notification.message }}</p>

                    <div class="small text-muted">
                        <i class="fas fa-clock"></i>
                        {{ notification.created_at|timesince }}

                        {% if notification.related_conversation %}
                            •
                            <a href="{% url 'messaging:conversation_detail' notification.related_conversation.uuid %}"
                               class="text-decoration-none">
                                <i class="fas fa-comments"></i> {% trans "Voir la conversation" %}
                            </a>
                        {% endif %}

                        {% if notification.related_ad %}
                            •
                            <a href="{{ notification.related_ad.get_absolute_url }}"
                               class="text-decoration-none">
                                <i class="fas fa-ad"></i> {% trans "Voir l'annonce" %}
                            </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Actions -->
                <div class="btn-group">
                    {% if not notification.is_read %}
                        <form method="post" action="{% url 'messaging:mark_notification_read' notification.pk %}"
                              class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-success"
                                    title="{% trans 'Marquer comme lu' %}">
                                <i class="fas fa-check"></i>
                            </button>
                        </form>
                    {% endif %}

                    <form method="post" action="{% url 'messaging:delete_notification' notification.pk %}"
                          class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('{% trans 'Supprimer cette notification ?' %}')"
                                title="{% trans 'Supprimer' %}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Action -->
            {% if notification.action_url %}
                <div class="mt-2">
                    <a href="{{ notification.action_url }}" class="btn btn-sm btn-primary">
                        {% if notification.action_text %}
                            {{ notification.action_text }}
                        {% else %}
                            <i class="fas fa-external-link-alt"></i> {% trans "Voir" %}
                        {% endif %}
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>


========== messaging/templates/partials/conversation_list_item.html ==========
{# ~/ebi3/messaging/templates/messaging/partials/conversation_list_item.html #}
<div class="list-group-item conversation-item
            {% if conversation.unread_count > 0 %}unread{% endif %}
            {% if conversation.uuid == active_conversation.uuid|default:'' %}active{% endif %}"
     onclick="location.href='{% url 'messaging:conversation_detail' conversation.uuid %}'">

    <div class="d-flex align-items-center">
        <!-- Avatar -->
        <div class="flex-shrink-0 position-relative">
            <div class="conversation-avatar bg-primary text-white d-flex align-items-center justify-content-center">
                {% with other=conversation.get_other_participant request.user %}
                    {% if other %}
                        {{ other.username|first|upper }}
                    {% else %}
                        <i class="fas fa-users"></i>
                    {% endif %}
                {% endwith %}
            </div>

            <!-- Statut en ligne -->
            {% with other=conversation.get_other_participant request.user %}
                {% if other and other.profile.is_online %}
                    <span class="online-status online position-absolute"
                          style="bottom: 0; right: 0;"></span>
                {% endif %}
            {% endwith %}
        </div>

        <!-- Contenu -->
        <div class="flex-grow-1 ms-3 overflow-hidden">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-0 text-truncate">
                        {% if conversation.subject %}
                            {{ conversation.subject }}
                        {% else %}
                            {% with other=conversation.get_other_participant request.user %}
                                {% if other %}
                                    {{ other.username }}
                                {% else %}
                                    {% trans "Groupe" %}
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </h6>

                    <div class="small text-muted">
                        {% with other=conversation.get_other_participant request.user %}
                            {% if other %}
                                {{ other.get_role_display }}
                            {% endif %}
                        {% endwith %}
                        {% if conversation.related_ad %}
                            • <i class="fas fa-ad"></i> {{ conversation.related_ad.title|truncatechars:20 }}
                        {% endif %}
                    </div>
                </div>

                <div class="text-end">
                    <small class="conversation-time">
                        {% if conversation.last_message_at %}
                            {{ conversation.last_message_at|timesince }}
                        {% endif %}
                    </small>

                    {% if conversation.unread_count > 0 %}
                        <div>
                            <span class="unread-badge">{{ conversation.unread_count }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Dernier message -->
            <div class="conversation-preview mt-1">
                {% with last_msg=conversation.messages.last %}
                    {% if last_msg %}
                        {% if last_msg.sender == request.user %}
                            <i class="fas fa-reply text-muted me-1"></i>
                        {% endif %}
                        {% if last_msg.attachment %}
                            <i class="fas fa-paperclip text-muted me-1"></i>
                        {% endif %}
                        {{ last_msg.content|truncatechars:50 }}
                    {% else %}
                        <span class="text-muted">{% trans "Aucun message" %}</span>
                    {% endif %}
                {% endwith %}
            </div>
        </div>
    </div>
</div>


========== messaging/templates/partials/attachment_preview.html ==========
{# ~/ebi3/messaging/templates/messaging/partials/attachment_preview.html #}
<div class="attachment-preview mt-2">
    {% with ext=attachment.name|lower|slice:"-4:" %}
        <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
                {% if ext in '.jpg.jpeg.png.gif.webp' %}
                    <i class="fas fa-file-image fa-2x text-primary"></i>
                {% elif ext in '.pdf' %}
                    <i class="fas fa-file-pdf fa-2x text-danger"></i>
                {% elif ext in '.doc.docx' %}
                    <i class="fas fa-file-word fa-2x text-info"></i>
                {% elif ext in '.xls.xlsx' %}
                    <i class="fas fa-file-excel fa-2x text-success"></i>
                {% elif ext in '.zip.rar.7z' %}
                    <i class="fas fa-file-archive fa-2x text-warning"></i>
                {% else %}
                    <i class="fas fa-file fa-2x text-secondary"></i>
                {% endif %}
            </div>
            <div class="flex-grow-1 ms-3">
                <div class="fw-bold text-truncate">{{ attachment.name }}</div>
                <div class="small text-muted">
                    {% if attachment.size %}
                        {{ attachment.size|filesizeformat }}
                    {% endif %}
                    {% if ext %}
                        • {{ ext|upper }}
                    {% endif %}
                </div>
            </div>
            <div class="flex-shrink-0">
                <a href="{{ attachment.url }}" class="btn btn-sm btn-outline-primary"
                   target="_blank" title="{% trans 'Télécharger' %}">
                    <i class="fas fa-download"></i>
                </a>
            </div>
        </div>
    {% endwith %}
</div>


========== messaging/migrations/0002_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("ads", "0002_initial"),
        ("carriers", "0002_initial"),
        ("messaging", "0001_initial"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name="blockeduser",
            name="blocked",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="blocked_by",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Bloqué",
            ),
        ),
        migrations.AddField(
            model_name="blockeduser",
            name="blocker",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="blocked_users",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Bloqueur",
            ),
        ),
        migrations.AddField(
            model_name="conversation",
            name="blocked_by",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="blocked_conversations",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Bloquée par",
            ),
        ),
        migrations.AddField(
            model_name="conversation",
            name="participants",
            field=models.ManyToManyField(
                related_name="conversations",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Participants",
            ),
        ),
        migrations.AddField(
            model_name="conversation",
            name="related_ad",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="conversations",
                to="ads.ad",
                verbose_name="Annonce liée",
            ),
        ),
        migrations.AddField(
            model_name="conversation",
            name="related_carrier",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="conversations",
                to="carriers.carrier",
                verbose_name="Transporteur lié",
            ),
        ),
        migrations.AddField(
            model_name="conversationarchive",
            name="conversation",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="archives",
                to="messaging.conversation",
                verbose_name="Conversation",
            ),
        ),
        migrations.AddField(
            model_name="conversationarchive",
            name="user",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="archived_conversations",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="message",
            name="conversation",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="messages",
                to="messaging.conversation",
                verbose_name="Conversation",
            ),
        ),
        migrations.AddField(
            model_name="message",
            name="deleted_by",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="deleted_messages",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Supprimé par",
            ),
        ),
        migrations.AddField(
            model_name="message",
            name="parent_message",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="replies",
                to="messaging.message",
                verbose_name="Message parent",
            ),
        ),
        migrations.AddField(
            model_name="message",
            name="recipient",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="received_messages",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Destinataire",
            ),
        ),
        migrations.AddField(
            model_name="message",
            name="sender",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="sent_messages",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Expéditeur",
            ),
        ),
        migrations.AddField(
            model_name="messagereport",
            name="message",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="reports",
                to="messaging.message",
                verbose_name="Message",
            ),
        ),
        migrations.AddField(
            model_name="messagereport",
            name="reporter",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="message_reports",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Signaleur",
            ),
        ),
        migrations.AddField(
            model_name="messagereport",
            name="resolved_by",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="resolved_message_reports",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Résolu par",
            ),
        ),
        migrations.AddField(
            model_name="notification",
            name="related_ad",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="notifications",
                to="ads.ad",
                verbose_name="Annonce liée",
            ),
        ),
        migrations.AddField(
            model_name="notification",
            name="related_conversation",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="notifications",
                to="messaging.conversation",
                verbose_name="Conversation liée",
            ),
        ),
        migrations.AddField(
            model_name="notification",
            name="related_message",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="notifications",
                to="messaging.message",
                verbose_name="Message lié",
            ),
        ),
        migrations.AddField(
            model_name="notification",
            name="user",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="notifications",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="usermessagesettings",
            name="user",
            field=models.OneToOneField(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="message_settings",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AlterUniqueTogether(
            name="blockeduser",
            unique_together={("blocker", "blocked")},
        ),
        migrations.AddIndex(
            model_name="conversation",
            index=models.Index(fields=["uuid"], name="messaging_c_uuid_521233_idx"),
        ),
        migrations.AddIndex(
            model_name="conversation",
            index=models.Index(
                fields=["conversation_type", "is_active"],
                name="messaging_c_convers_6a9ad5_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="conversation",
            index=models.Index(
                fields=["last_message_at"], name="messaging_c_last_me_87f299_idx"
            ),
        ),
        migrations.AlterUniqueTogether(
            name="conversationarchive",
            unique_together={("user", "conversation")},
        ),
        migrations.AddIndex(
            model_name="message",
            index=models.Index(fields=["uuid"], name="messaging_m_uuid_9bbd15_idx"),
        ),
        migrations.AddIndex(
            model_name="message",
            index=models.Index(
                fields=["conversation", "sent_at"],
                name="messaging_m_convers_118d4c_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="message",
            index=models.Index(
                fields=["sender", "sent_at"], name="messaging_m_sender__0f8c6f_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="message",
            index=models.Index(
                fields=["recipient", "is_read", "sent_at"],
                name="messaging_m_recipie_749da0_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="message",
            index=models.Index(
                fields=["is_deleted", "sent_at"], name="messaging_m_is_dele_1387ad_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="notification",
            index=models.Index(
                fields=["user", "is_read", "created_at"],
                name="messaging_n_user_id_1f2092_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="notification",
            index=models.Index(
                fields=["notification_type", "created_at"],
                name="messaging_n_notific_d000e1_idx",
            ),
        ),
    ]



========== messaging/migrations/0001_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name="BlockedUser",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "reason",
                    models.CharField(blank=True, max_length=200, verbose_name="Raison"),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Utilisateur bloqué",
                "verbose_name_plural": "Utilisateurs bloqués",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="Conversation",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "uuid",
                    models.UUIDField(
                        default=uuid.uuid4,
                        editable=False,
                        unique=True,
                        verbose_name="UUID",
                    ),
                ),
                (
                    "conversation_type",
                    models.CharField(
                        choices=[
                            ("PRIVATE", "Privé"),
                            ("GROUP", "Groupe"),
                            ("AD_RELATED", "Lié à une annonce"),
                            ("CARRIER_RELATED", "Lié à un transporteur"),
                            ("SUPPORT", "Support"),
                        ],
                        default="PRIVATE",
                        max_length=20,
                        verbose_name="Type de conversation",
                    ),
                ),
                (
                    "subject",
                    models.CharField(blank=True, max_length=200, verbose_name="Sujet"),
                ),
                ("is_active", models.BooleanField(default=True, verbose_name="Active")),
                (
                    "is_archived",
                    models.BooleanField(default=False, verbose_name="Archivée"),
                ),
                (
                    "is_blocked",
                    models.BooleanField(default=False, verbose_name="Bloquée"),
                ),
                (
                    "blocked_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Bloquée le"
                    ),
                ),
                (
                    "last_message_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Dernier message le"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Conversation",
                "verbose_name_plural": "Conversations",
                "ordering": ["-last_message_at", "-created_at"],
            },
        ),
        migrations.CreateModel(
            name="ConversationArchive",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("archived_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Archive de conversation",
                "verbose_name_plural": "Archives de conversations",
                "ordering": ["-archived_at"],
            },
        ),
        migrations.CreateModel(
            name="Message",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "uuid",
                    models.UUIDField(
                        default=uuid.uuid4,
                        editable=False,
                        unique=True,
                        verbose_name="UUID",
                    ),
                ),
                (
                    "content",
                    models.TextField(
                        help_text="Contenu du message", verbose_name="Contenu"
                    ),
                ),
                ("is_read", models.BooleanField(default=False, verbose_name="Lu")),
                (
                    "read_at",
                    models.DateTimeField(blank=True, null=True, verbose_name="Lu le"),
                ),
                (
                    "is_deleted",
                    models.BooleanField(default=False, verbose_name="Supprimé"),
                ),
                (
                    "deleted_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Supprimé le"
                    ),
                ),
                (
                    "attachment",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="messaging/attachments/%Y/%m/%d/",
                        verbose_name="Pièce jointe",
                    ),
                ),
                (
                    "attachment_name",
                    models.CharField(
                        blank=True, max_length=255, verbose_name="Nom du fichier"
                    ),
                ),
                (
                    "attachment_size",
                    models.PositiveIntegerField(
                        blank=True, null=True, verbose_name="Taille du fichier (octets)"
                    ),
                ),
                ("sent_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Message",
                "verbose_name_plural": "Messages",
                "ordering": ["sent_at"],
            },
        ),
        migrations.CreateModel(
            name="MessageReport",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "reason",
                    models.CharField(
                        choices=[
                            ("SPAM", "Spam"),
                            ("HARASSMENT", "Harcèlement"),
                            ("INAPPROPRIATE", "Contenu inapproprié"),
                            ("SCAM", "Arnaque"),
                            ("THREAT", "Menace"),
                            ("OTHER", "Autre"),
                        ],
                        max_length=20,
                        verbose_name="Raison",
                    ),
                ),
                (
                    "description",
                    models.TextField(blank=True, verbose_name="Description"),
                ),
                (
                    "evidence",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="messaging/reports/%Y/%m/%d/",
                        verbose_name="Preuve",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("UNDER_REVIEW", "En examen"),
                            ("RESOLVED", "Résolu"),
                            ("DISMISSED", "Rejeté"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "admin_notes",
                    models.TextField(
                        blank=True, verbose_name="Notes de l'administrateur"
                    ),
                ),
                (
                    "resolved_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Résolu le"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Signalement de message",
                "verbose_name_plural": "Signalements de messages",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="Notification",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "notification_type",
                    models.CharField(
                        choices=[
                            ("MESSAGE_RECEIVED", "Message reçu"),
                            ("MESSAGE_READ", "Message lu"),
                            ("CONVERSATION_NEW", "Nouvelle conversation"),
                            ("CONVERSATION_ARCHIVED", "Conversation archivée"),
                            ("SYSTEM", "Système"),
                            ("AD_RELATED", "Lié à une annonce"),
                            ("CARRIER_RELATED", "Lié à un transporteur"),
                            ("PAYMENT", "Paiement"),
                            ("SECURITY", "Sécurité"),
                        ],
                        max_length=30,
                        verbose_name="Type de notification",
                    ),
                ),
                ("title", models.CharField(max_length=200, verbose_name="Titre")),
                ("message", models.TextField(verbose_name="Message")),
                ("is_read", models.BooleanField(default=False, verbose_name="Lue")),
                (
                    "is_important",
                    models.BooleanField(default=False, verbose_name="Importante"),
                ),
                (
                    "action_url",
                    models.URLField(blank=True, verbose_name="URL d'action"),
                ),
                (
                    "action_text",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Texte de l'action"
                    ),
                ),
                (
                    "expires_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Expire le"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Notification",
                "verbose_name_plural": "Notifications",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="UserMessageSettings",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "email_notifications",
                    models.BooleanField(
                        default=True, verbose_name="Notifications par email"
                    ),
                ),
                (
                    "push_notifications",
                    models.BooleanField(
                        default=True, verbose_name="Notifications push"
                    ),
                ),
                (
                    "desktop_notifications",
                    models.BooleanField(
                        default=True, verbose_name="Notifications bureau"
                    ),
                ),
                (
                    "allow_messages_from",
                    models.CharField(
                        choices=[
                            ("EVERYONE", "Tout le monde"),
                            ("CONTACTS", "Contacts uniquement"),
                            ("NOBODY", "Personne"),
                        ],
                        default="EVERYONE",
                        max_length=20,
                        verbose_name="Autoriser les messages de",
                    ),
                ),
                (
                    "auto_archive_conversations",
                    models.BooleanField(
                        default=False,
                        verbose_name="Archiver automatiquement les conversations",
                    ),
                ),
                (
                    "archive_after_days",
                    models.PositiveIntegerField(
                        default=30, verbose_name="Archiver après (jours)"
                    ),
                ),
                (
                    "auto_delete_messages",
                    models.BooleanField(
                        default=False,
                        verbose_name="Supprimer automatiquement les messages",
                    ),
                ),
                (
                    "delete_after_days",
                    models.PositiveIntegerField(
                        default=365, verbose_name="Supprimer après (jours)"
                    ),
                ),
                (
                    "show_online_status",
                    models.BooleanField(
                        default=True, verbose_name="Afficher le statut en ligne"
                    ),
                ),
                (
                    "show_read_receipts",
                    models.BooleanField(
                        default=True, verbose_name="Afficher les accusés de lecture"
                    ),
                ),
                (
                    "block_spam_messages",
                    models.BooleanField(
                        default=True, verbose_name="Bloquer les messages indésirables"
                    ),
                ),
                (
                    "filter_profanity",
                    models.BooleanField(
                        default=True, verbose_name="Filtrer les gros mots"
                    ),
                ),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Paramètres de messagerie",
                "verbose_name_plural": "Paramètres de messagerie",
            },
        ),
    ]



========== messaging/migrations/__init__.py ==========



========== messaging/tests.py ==========
# ~/ebi3/messaging/tests.py
from django.test import TestCase, Client
from django.urls import reverse
from django.contrib.auth import get_user_model
from django.utils import timezone
from django.core.files.uploadedfile import SimpleUploadedFile

from .models import (
    Conversation, Message, Notification,
    UserMessageSettings, BlockedUser,
    ConversationArchive, MessageReport
)

User = get_user_model()

class MessagingModelsTest(TestCase):
    """Tests des modèles de messagerie"""

    def setUp(self):
        # Créer des utilisateurs
        self.user1 = User.objects.create_user(
            username='user1',
            email='user1@test.com',
            password='password123'
        )

        self.user2 = User.objects.create_user(
            username='user2',
            email='user2@test.com',
            password='password123'
        )

        # Créer des paramètres de messagerie
        UserMessageSettings.objects.create(user=self.user1)
        UserMessageSettings.objects.create(user=self.user2)

    def test_conversation_creation(self):
        """Test la création d'une conversation"""
        conversation = Conversation.objects.create(
            conversation_type=Conversation.ConversationType.PRIVATE
        )
        conversation.participants.add(self.user1, self.user2)

        self.assertEqual(conversation.conversation_type, Conversation.ConversationType.PRIVATE)
        self.assertEqual(conversation.participants.count(), 2)
        self.assertTrue(conversation.is_active)
        self.assertFalse(conversation.is_blocked)

    def test_conversation_str_method(self):
        """Test la méthode __str__ de Conversation"""
        conversation = Conversation.objects.create(
            conversation_type=Conversation.ConversationType.PRIVATE,
            subject="Test Conversation"
        )
        conversation.participants.add(self.user1, self.user2)

        self.assertEqual(str(conversation), "Test Conversation (Privé)")

    def test_message_creation(self):
        """Test la création d'un message"""
        conversation = Conversation.objects.create(
            conversation_type=Conversation.ConversationType.PRIVATE
        )
        conversation.participants.add(self.user1, self.user2)

        message = Message.objects.create(
            conversation=conversation,
            sender=self.user1,
            recipient=self.user2,
            content="Hello, this is a test message."
        )

        self.assertEqual(message.sender, self.user1)
        self.assertEqual(message.recipient, self.user2)
        self.assertEqual(message.content, "Hello, this is a test message.")
        self.assertFalse(message.is_read)
        self.assertFalse(message.is_deleted)

    def test_message_mark_as_read(self):
        """Test le marquage d'un message comme lu"""
        conversation = Conversation.objects.create(
            conversation_type=Conversation.ConversationType.PRIVATE
        )
        conversation.participants.add(self.user1, self.user2)

        message = Message.objects.create(
            conversation=conversation,
            sender=self.user1,
            recipient=self.user2,
            content="Test message"
        )

        self.assertFalse(message.is_read)
        self.assertIsNone(message.read_at)

        message.mark_as_read()
        message.refresh_from_db()

        self.assertTrue(message.is_read)
        self.assertIsNotNone(message.read_at)

    def test_conversation_get_other_participant(self):
        """Test la méthode get_other_participant de Conversation"""
        conversation = Conversation.objects.create(
            conversation_type=Conversation.ConversationType.PRIVATE
        )
        conversation.participants.add(self.user1, self.user2)

        other = conversation.get_other_participant(self.user1)
        self.assertEqual(other, self.user2)

        other = conversation.get_other_participant(self.user2)
        self.assertEqual(other, self.user1)

    def test_conversation_get_or_create(self):
        """Test la méthode get_or_create_conversation"""
        # Première création
        conversation1 = Conversation.get_or_create_conversation(
            self.user1, self.user2
        )
        self.assertIsNotNone(conversation1)
        self.assertEqual(conversation1.participants.count(), 2)

        # Récupération de la même conversation
        conversation2 = Conversation.get_or_create_conversation(
            self.user1, self.user2
        )
        self.assertEqual(conversation1.id, conversation2.id)

    def test_notification_creation(self):
        """Test la création d'une notification"""
        notification = Notification.objects.create(
            user=self.user1,
            notification_type=Notification.NotificationType.MESSAGE_RECEIVED,
            title="Test Notification",
            message="This is a test notification"
        )

        self.assertEqual(notification.user, self.user1)
        self.assertEqual(notification.notification_type, Notification.NotificationType.MESSAGE_RECEIVED)
        self.assertFalse(notification.is_read)
        self.assertFalse(notification.is_expired())

    def test_blocked_user_creation(self):
        """Test la création d'un blocage d'utilisateur"""
        blocked = BlockedUser.objects.create(
            blocker=self.user1,
            blocked=self.user2,
            reason="Test reason"
        )

        self.assertEqual(blocked.blocker, self.user1)
        self.assertEqual(blocked.blocked, self.user2)
        self.assertEqual(blocked.reason, "Test reason")

    def test_message_settings_creation(self):
        """Test la création des paramètres de messagerie"""
        settings = UserMessageSettings.objects.get(user=self.user1)

        self.assertEqual(settings.user, self.user1)
        self.assertTrue(settings.email_notifications)
        self.assertEqual(settings.allow_messages_from, 'EVERYONE')


class MessagingViewsTest(TestCase):
    """Tests des vues de messagerie"""

    def setUp(self):
        self.client = Client()

        # Créer des utilisateurs
        self.user1 = User.objects.create_user(
            username='testuser1',
            email='test1@test.com',
            password='testpass123'
        )

        self.user2 = User.objects.create_user(
            username='testuser2',
            email='test2@test.com',
            password='testpass123'
        )

        # Créer des paramètres
        UserMessageSettings.objects.create(user=self.user1)
        UserMessageSettings.objects.create(user=self.user2)

        # Créer une conversation
        self.conversation = Conversation.objects.create(
            conversation_type=Conversation.ConversationType.PRIVATE
        )
        self.conversation.participants.add(self.user1, self.user2)

    def test_inbox_view_authenticated(self):
        """Test la vue de la boîte de réception pour un utilisateur authentifié"""
        self.client.login(username='testuser1', password='testpass123')
        response = self.client.get(reverse('messaging:inbox'))
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'messaging/inbox.html')

    def test_inbox_view_unauthenticated(self):
        """Test la redirection pour un utilisateur non authentifié"""
        response = self.client.get(reverse('messaging:inbox'))
        # Devrait rediriger vers la page de connexion
        self.assertEqual(response.status_code, 302)
        self.assertIn('login', response.url)

    def test_conversation_detail_view(self):
        """Test la vue de détail d'une conversation"""
        self.client.login(username='testuser1', password='testpass123')

        response = self.client.get(reverse('messaging:conversation_detail',
                                         kwargs={'uuid': self.conversation.uuid}))
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'messaging/conversation_detail.html')

    def test_new_conversation_view_get(self):
        """Test la vue de nouvelle conversation (GET)"""
        self.client.login(username='testuser1', password='testpass123')

        response = self.client.get(reverse('messaging:new_conversation'))
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'messaging/new_conversation.html')

    def test_new_conversation_view_post(self):
        """Test la vue de nouvelle conversation (POST)"""
        self.client.login(username='testuser1', password='testpass123')

        data = {
            'recipient': 'testuser2',
            'subject': 'Test Subject',
            'message': 'This is a test message.'
        }

        response = self.client.post(reverse('messaging:new_conversation'), data)

        # Devrait rediriger vers la conversation créée
        self.assertEqual(response.status_code, 302)

        # Vérifier que la conversation a été créée
        conversation = Conversation.objects.filter(
            participants=self.user1
        ).filter(
            participants=self.user2
        ).first()

        self.assertIsNotNone(conversation)

        # Vérifier que le message a été créé
        message = Message.objects.filter(
            conversation=conversation,
            sender=self.user1,
            recipient=self.user2
        ).first()

        self.assertIsNotNone(message)
        self.assertEqual(message.content, 'This is a test message.')

    def test_send_message_view(self):
        """Test la vue d'envoi de message"""
        self.client.login(username='testuser1', password='testpass123')

        data = {
            'content': 'This is a reply message.'
        }

        response = self.client.post(
            reverse('messaging:send_message', kwargs={'uuid': self.conversation.uuid}),
            data
        )

        # Devrait retourner JSON pour AJAX
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response['Content-Type'], 'application/json')

        # Vérifier que le message a été créé
        message = Message.objects.filter(
            conversation=self.conversation,
            sender=self.user1,
            recipient=self.user2
        ).last()

        self.assertIsNotNone(message)
        self.assertEqual(message.content, 'This is a reply message.')


class MessagingFormsTest(TestCase):
    """Tests des formulaires de messagerie"""

    def setUp(self):
        self.user1 = User.objects.create_user(
            username='user1',
            email='user1@test.com',
            password='password123'
        )

        self.user2 = User.objects.create_user(
            username='user2',
            email='user2@test.com',
            password='password123'
        )

        UserMessageSettings.objects.create(user=self.user1)
        UserMessageSettings.objects.create(user=self.user2)

    def test_new_conversation_form_valid(self):
        """Test le formulaire de nouvelle conversation avec des données valides"""
        form_data = {
            'recipient': 'user2',
            'subject': 'Test Subject',
            'message': 'Hello!'
        }

        form = NewConversationForm(data=form_data, user=self.user1)
        self.assertTrue(form.is_valid())

    def test_new_conversation_form_invalid_self_message(self):
        """Test le formulaire de nouvelle conversation avec envoi à soi-même"""
        form_data = {
            'recipient': 'user1',
            'subject': 'Test Subject',
            'message': 'Hello!'
        }

        form = NewConversationForm(data=form_data, user=self.user1)
        self.assertFalse(form.is_valid())
        self.assertIn('recipient', form.errors)

    def test_new_conversation_form_invalid_recipient(self):
        """Test le formulaire avec un destinataire invalide"""
        form_data = {
            'recipient': 'nonexistent',
            'subject': 'Test Subject',
            'message': 'Hello!'
        }

        form = NewConversationForm(data=form_data, user=self.user1)
        self.assertFalse(form.is_valid())
        self.assertIn('recipient', form.errors)

    def test_message_form_valid(self):
        """Test le formulaire de message avec des données valides"""
        conversation = Conversation.objects.create(
            conversation_type=Conversation.ConversationType.PRIVATE
        )
        conversation.participants.add(self.user1, self.user2)

        form_data = {
            'content': 'This is a test message.'
        }

        form = MessageForm(
            data=form_data,
            conversation=conversation,
            sender=self.user1,
            recipient=self.user2
        )

        self.assertTrue(form.is_valid())

    def test_message_form_invalid_empty(self):
        """Test le formulaire de message vide"""
        conversation = Conversation.objects.create(
            conversation_type=Conversation.ConversationType.PRIVATE
        )
        conversation.participants.add(self.user1, self.user2)

        form_data = {}

        form = MessageForm(
            data=form_data,
            conversation=conversation,
            sender=self.user1,
            recipient=self.user2
        )

        self.assertFalse(form.is_valid())
        self.assertIn('content', form.errors)

    def test_message_form_with_attachment(self):
        """Test le formulaire de message avec pièce jointe"""
        conversation = Conversation.objects.create(
            conversation_type=Conversation.ConversationType.PRIVATE
        )
        conversation.participants.add(self.user1, self.user2)

        # Créer un faux fichier
        file_content = b"Test file content"
        uploaded_file = SimpleUploadedFile(
            "test.txt",
            file_content,
            content_type="text/plain"
        )

        form_data = {
            'content': 'Message with attachment',
            'attachment': uploaded_file
        }

        form = MessageForm(
            data=form_data,
            conversation=conversation,
            sender=self.user1,
            recipient=self.user2
        )

        self.assertTrue(form.is_valid())

    def test_block_user_form_valid(self):
        """Test le formulaire de blocage d'utilisateur"""
        form_data = {
            'reason': 'Test reason for blocking'
        }

        form = BlockUserForm(
            data=form_data,
            blocker=self.user1,
            blocked=self.user2
        )

        self.assertTrue(form.is_valid())

    def test_block_user_form_self_block(self):
        """Test le formulaire de blocage avec soi-même"""
        form_data = {
            'reason': 'Test reason'
        }

        form = BlockUserForm(
            data=form_data,
            blocker=self.user1,
            blocked=self.user1
        )

        self.assertFalse(form.is_valid())
        self.assertIn('__all__', form.errors)


class MessagingAPITest(TestCase):
    """Tests pour les endpoints API"""

    def setUp(self):
        self.client = Client()

        self.user1 = User.objects.create_user(
            username='apiuser1',
            email='api1@test.com',
            password='password123'
        )

        self.user2 = User.objects.create_user(
            username='apiuser2',
            email='api2@test.com',
            password='password123'
        )

        UserMessageSettings.objects.create(user=self.user1)

    def test_unread_count_api(self):
        """Test l'API du nombre de messages non lus"""
        self.client.login(username='apiuser1', password='password123')

        response = self.client.get(reverse('messaging:api_unread_count'))
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response['Content-Type'], 'application/json')

        data = response.json()
        self.assertIn('unread_count', data)
        self.assertEqual(data['unread_count'], 0)

    def test_mark_as_read_api(self):
        """Test l'API de marquage comme lu"""
        self.client.login(username='apiuser1', password='password123')

        # Créer une conversation et un message
        conversation = Conversation.objects.create(
            conversation_type=Conversation.ConversationType.PRIVATE
        )
        conversation.participants.add(self.user1, self.user2)

        message = Message.objects.create(
            conversation=conversation,
            sender=self.user2,
            recipient=self.user1,
            content="Unread message"
        )

        # Marquer comme lu via API
        response = self.client.post(
            reverse('messaging:api_mark_as_read', kwargs={'message_uuid': message.uuid})
        )

        self.assertEqual(response.status_code, 200)

        # Vérifier que le message est marqué comme lu
        message.refresh_from_db()
        self.assertTrue(message.is_read)
        self.assertIsNotNone(message.read_at)


========== messaging/signals.py ==========
# ~/ebi3/messaging/signals.py
from django.db.models.signals import post_save, pre_save, post_delete
from django.dispatch import receiver
from django.utils import timezone
from django.core.cache import cache
from django.utils.translation import gettext_lazy as _

from .models import (
    Conversation, Message, Notification,
    UserMessageSettings, BlockedUser,
    ConversationArchive, MessageReport
)

@receiver(post_save, sender=Message)
def create_notification_on_new_message(sender, instance, created, **kwargs):
    """Créer une notification lors d'un nouveau message"""
    if created:
        # Créer une notification pour le destinataire
        Notification.objects.create(
            user=instance.recipient,
            notification_type=Notification.NotificationType.MESSAGE_RECEIVED,
            title=_("Nouveau message"),
            message=_("Vous avez reçu un nouveau message de {}").format(
                instance.sender.username
            ),
            related_conversation=instance.conversation,
            related_message=instance,
            action_url=instance.conversation.get_absolute_url()
        )

        # Invalider le cache du nombre de messages non lus
        cache_key = f"unread_messages_count_{instance.recipient.id}"
        cache.delete(cache_key)

@receiver(post_save, sender=Message)
def update_conversation_last_message(sender, instance, created, **kwargs):
    """Mettre à jour le dernier message de la conversation"""
    if created:
        instance.conversation.last_message_at = instance.sent_at
        instance.conversation.save(update_fields=['last_message_at'])

@receiver(post_save, sender=Conversation)
def create_default_settings(sender, instance, created, **kwargs):
    """Créer des paramètres par défaut pour les nouveaux utilisateurs"""
    if created:
        # Cette logique serait dans le signal de création d'utilisateur
        pass

@receiver(post_save, sender=BlockedUser)
def block_conversations_on_user_block(sender, instance, created, **kwargs):
    """Bloquer les conversations existantes lors du blocage d'un utilisateur"""
    if created:
        # Trouver toutes les conversations entre ces deux utilisateurs
        conversations = Conversation.objects.filter(
            participants=instance.blocker
        ).filter(
            participants=instance.blocked
        ).filter(
            is_active=True,
            is_blocked=False
        )

        for conversation in conversations:
            conversation.is_blocked = True
            conversation.blocked_by = instance.blocker
            conversation.blocked_at = timezone.now()
            conversation.save(update_fields=['is_blocked', 'blocked_by', 'blocked_at'])

@receiver(post_delete, sender=BlockedUser)
def unblock_conversations_on_user_unblock(sender, instance, **kwargs):
    """Débloquer les conversations lors du déblocage d'un utilisateur"""
    # Débloquer les conversations entre ces deux utilisateurs
    conversations = Conversation.objects.filter(
        participants=instance.blocker
    ).filter(
        participants=instance.blocked
    ).filter(
        is_blocked=True,
        blocked_by=instance.blocker
    )

    for conversation in conversations:
        conversation.is_blocked = False
        conversation.blocked_by = None
        conversation.blocked_at = None
        conversation.save(update_fields=['is_blocked', 'blocked_by', 'blocked_at'])

@receiver(pre_save, sender=Notification)
def set_expiration_date(sender, instance, **kwargs):
    """Définir une date d'expiration pour les notifications"""
    if not instance.expires_at:
        # Par défaut, les notifications expirent après 30 jours
        instance.expires_at = timezone.now() + timezone.timedelta(days=30)

@receiver(post_save, sender=MessageReport)
def notify_admin_on_message_report(sender, instance, created, **kwargs):
    """Notifier les administrateurs lors d'un signalement de message"""
    if created and instance.status == 'PENDING':
        from django.contrib.auth.models import User

        # Notifier les administrateurs
        admins = User.objects.filter(is_staff=True)
        for admin in admins:
            Notification.objects.create(
                user=admin,
                notification_type=Notification.NotificationType.SYSTEM,
                title=_("Nouveau signalement de message"),
                message=_("Un message a été signalé par {}").format(
                    instance.reporter.username
                ),
                action_url=f"/admin/messaging/messagereport/{instance.id}/change/",
                is_important=True
            )

@receiver(post_save, sender=ConversationArchive)
def archive_conversation_for_user(sender, instance, created, **kwargs):
    """Archiver la conversation pour l'utilisateur spécifique"""
    if created:
        # Marquer la conversation comme archivée pour cet utilisateur
        # (Cette logique peut être étendue pour gérer l'archivage multiple)
        pass

@receiver(post_delete, sender=ConversationArchive)
def unarchive_conversation_for_user(sender, instance, **kwargs):
    """Désarchiver la conversation pour l'utilisateur"""
    # (Cette logique peut être étendue pour gérer le désarchivage)
    pass

@receiver(pre_save, sender=Message)
def check_message_block_status(sender, instance, **kwargs):
    """Vérifier si l'expéditeur est bloqué par le destinataire"""
    if instance.pk is None:  # Nouveau message seulement
        if BlockedUser.objects.filter(
            blocker=instance.recipient,
            blocked=instance.sender
        ).exists():
            # L'expéditeur est bloqué par le destinataire
            # On peut soit empêcher l'envoi, soit marquer le message comme bloqué
            instance.is_deleted = True
            instance.deleted_by = instance.recipient
            instance.deleted_at = timezone.now()

# CORRECTION : Utiliser une importation différée pour éviter les import circulaires
@receiver(post_save)
def create_user_message_settings(sender, instance, created, **kwargs):
    """Créer des paramètres de messagerie par défaut pour les nouveaux utilisateurs"""
    # Vérifier si c'est le modèle User
    if sender.__name__ == 'User' and created:
        # Utiliser une importation locale pour éviter les problèmes circulaires
        from .models import UserMessageSettings
        UserMessageSettings.objects.get_or_create(user=instance)

# Alternative : Déplacer ce signal dans apps.py pour un meilleur contrôle


========== messaging/admin.py ==========
# ~/ebi3/messaging/admin.py
from django.contrib import admin
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from django.utils.html import format_html
from django.urls import reverse
from django.contrib import messages
from django.http import HttpResponseRedirect

from .models import (
    Conversation, Message, Notification,
    UserMessageSettings, BlockedUser,
    ConversationArchive, MessageReport
)

@admin.register(Conversation)
class ConversationAdmin(admin.ModelAdmin):
    """Administration des conversations"""

    list_display = (
        'uuid_short', 'conversation_type', 'subject_preview',
        'participants_count', 'is_active', 'is_blocked',
        'last_message_at', 'created_at'
    )

    list_filter = (
        'conversation_type', 'is_active', 'is_blocked',
        'is_archived', 'created_at'
    )

    search_fields = (
        'uuid', 'subject', 'participants__username',
        'participants__email', 'related_ad__title'
    )

    readonly_fields = (
        'uuid', 'created_at', 'updated_at',
        'last_message_at', 'blocked_at'
    )

    filter_horizontal = ('participants',)

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('uuid', 'conversation_type', 'subject')
        }),
        (_('Participants'), {
            'fields': ('participants',)
        }),
        (_('Liens'), {
            'fields': ('related_ad', 'related_carrier'),
            'classes': ('collapse',)
        }),
        (_('Statut'), {
            'fields': ('is_active', 'is_archived', 'is_blocked')
        }),
        (_('Bloquage'), {
            'fields': ('blocked_by', 'blocked_at'),
            'classes': ('collapse',)
        }),
        (_('Dates'), {
            'fields': ('last_message_at', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION : actions doit être une LISTE de noms de méthodes
    actions = [
        'activate_conversations', 'deactivate_conversations',
        'archive_conversations', 'unarchive_conversations',
        'block_conversations', 'unblock_conversations'
    ]

    def uuid_short(self, obj):
        return str(obj.uuid)[:8]
    uuid_short.short_description = _('UUID')
    uuid_short.admin_order_field = 'uuid'

    def subject_preview(self, obj):
        if obj.subject:
            return obj.subject[:50]
        participants = obj.participants.all()[:3]
        names = ", ".join([p.username for p in participants])
        if obj.participants.count() > 3:
            names += "..."
        return names
    subject_preview.short_description = _('Sujet/Participants')

    def participants_count(self, obj):
        return obj.participants.count()
    participants_count.short_description = _('Participants')

    # Les méthodes d'action doivent être séparées
    def activate_conversations(self, request, queryset):
        updated = queryset.update(is_active=True)
        self.message_user(request, _(f'{updated} conversations ont été activées.'))
    activate_conversations.short_description = _('Activer les conversations')

    def deactivate_conversations(self, request, queryset):
        updated = queryset.update(is_active=False)
        self.message_user(request, _(f'{updated} conversations ont été désactivées.'))
    deactivate_conversations.short_description = _('Désactiver les conversations')

    def archive_conversations(self, request, queryset):
        updated = queryset.update(is_archived=True)
        self.message_user(request, _(f'{updated} conversations ont été archivées.'))
    archive_conversations.short_description = _('Archiver les conversations')

    def unarchive_conversations(self, request, queryset):
        updated = queryset.update(is_archived=False)
        self.message_user(request, _(f'{updated} conversations ont été désarchivées.'))
    unarchive_conversations.short_description = _('Désarchiver les conversations')

    def block_conversations(self, request, queryset):
        updated = queryset.update(
            is_blocked=True,
            blocked_by=request.user,
            blocked_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} conversations ont été bloquées.'))
    block_conversations.short_description = _('Bloquer les conversations')

    def unblock_conversations(self, request, queryset):
        updated = queryset.update(
            is_blocked=False,
            blocked_by=None,
            blocked_at=None
        )
        self.message_user(request, _(f'{updated} conversations ont été débloquées.'))
    unblock_conversations.short_description = _('Débloquer les conversations')

    def get_queryset(self, request):
        return super().get_queryset(request).prefetch_related('participants')


@admin.register(Message)
class MessageAdmin(admin.ModelAdmin):
    """Administration des messages"""

    list_display = (
        'uuid_short', 'conversation_link', 'sender_username',
        'recipient_username', 'content_preview', 'is_read',
        'is_deleted', 'sent_at'
    )

    list_filter = (
        'is_read', 'is_deleted', 'sent_at',
        'conversation__conversation_type'
    )

    search_fields = (
        'uuid', 'content', 'sender__username',
        'recipient__username', 'conversation__subject'
    )

    readonly_fields = (
        'uuid', 'sent_at', 'updated_at',
        'read_at', 'deleted_at'
    )

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('uuid', 'conversation', 'sender', 'recipient')
        }),
        (_('Contenu'), {
            'fields': ('content', 'parent_message')
        }),
        (_('Pièces jointes'), {
            'fields': ('attachment', 'attachment_name', 'attachment_size'),
            'classes': ('collapse',)
        }),
        (_('Statut'), {
            'fields': ('is_read', 'read_at', 'is_deleted', 'deleted_by', 'deleted_at')
        }),
        (_('Dates'), {
            'fields': ('sent_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ actions doit être une liste
    actions = ['mark_as_read', 'mark_as_unread', 'soft_delete_messages', 'restore_messages']

    def uuid_short(self, obj):
        return str(obj.uuid)[:8]
    uuid_short.short_description = _('UUID')

    def conversation_link(self, obj):
        url = reverse('admin:messaging_conversation_change', args=[obj.conversation.id])
        return format_html('<a href="{}">{}</a>', url, obj.conversation.uuid_short())
    conversation_link.short_description = _('Conversation')
    conversation_link.admin_order_field = 'conversation'

    def sender_username(self, obj):
        return obj.sender.username
    sender_username.short_description = _('Expéditeur')
    sender_username.admin_order_field = 'sender__username'

    def recipient_username(self, obj):
        return obj.recipient.username
    recipient_username.short_description = _('Destinataire')
    recipient_username.admin_order_field = 'recipient__username'

    def content_preview(self, obj):
        return obj.content[:100] + ('...' if len(obj.content) > 100 else '')
    content_preview.short_description = _('Contenu')

    # Actions
    def mark_as_read(self, request, queryset):
        updated = queryset.update(is_read=True, read_at=timezone.now())
        self.message_user(request, _(f'{updated} messages ont été marqués comme lus.'))
    mark_as_read.short_description = _('Marquer comme lu')

    def mark_as_unread(self, request, queryset):
        updated = queryset.update(is_read=False, read_at=None)
        self.message_user(request, _(f'{updated} messages ont été marqués comme non lus.'))
    mark_as_unread.short_description = _('Marquer comme non lu')

    def soft_delete_messages(self, request, queryset):
        for message in queryset:
            message.soft_delete(request.user)
        self.message_user(request, _(f'{queryset.count()} messages ont été supprimés.'))
    soft_delete_messages.short_description = _('Supprimer (soft delete)')

    def restore_messages(self, request, queryset):
        updated = queryset.update(
            is_deleted=False,
            deleted_by=None,
            deleted_at=None
        )
        self.message_user(request, _(f'{updated} messages ont été restaurés.'))
    restore_messages.short_description = _('Restaurer')

    def has_add_permission(self, request):
        # Empêcher l'ajout manuel de messages via l'admin
        return False

    def get_queryset(self, request):
        return super().get_queryset(request).select_related(
            'conversation', 'sender', 'recipient', 'deleted_by'
        )


@admin.register(Notification)
class NotificationAdmin(admin.ModelAdmin):
    """Administration des notifications"""

    list_display = (
        'user_username', 'notification_type', 'title_preview',
        'is_read', 'is_important', 'created_at'
    )

    list_filter = (
        'notification_type', 'is_read', 'is_important',
        'created_at'
    )

    search_fields = (
        'user__username', 'title', 'message',
        'related_conversation__subject'
    )

    readonly_fields = ('created_at',)

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('user', 'notification_type', 'title', 'message')
        }),
        (_('Liens'), {
            'fields': ('related_conversation', 'related_message', 'related_ad'),
            'classes': ('collapse',)
        }),
        (_('Statut'), {
            'fields': ('is_read', 'is_important')
        }),
        (_('Action'), {
            'fields': ('action_url', 'action_text', 'expires_at')
        }),
        (_('Dates'), {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )

    # ✅ actions doit être une liste
    actions = ['mark_as_read', 'mark_as_unread', 'mark_as_important', 'mark_as_unimportant']

    def user_username(self, obj):
        return obj.user.username
    user_username.short_description = _('Utilisateur')
    user_username.admin_order_field = 'user__username'

    def title_preview(self, obj):
        return obj.title[:50] + ('...' if len(obj.title) > 50 else '')
    title_preview.short_description = _('Titre')

    # Actions
    def mark_as_read(self, request, queryset):
        updated = queryset.update(is_read=True)
        self.message_user(request, _(f'{updated} notifications ont été marquées comme lues.'))
    mark_as_read.short_description = _('Marquer comme lu')

    def mark_as_unread(self, request, queryset):
        updated = queryset.update(is_read=False)
        self.message_user(request, _(f'{updated} notifications ont été marquées comme non lues.'))
    mark_as_unread.short_description = _('Marquer comme non lu')

    def mark_as_important(self, request, queryset):
        updated = queryset.update(is_important=True)
        self.message_user(request, _(f'{updated} notifications ont été marquées comme importantes.'))
    mark_as_important.short_description = _('Marquer comme important')

    def mark_as_unimportant(self, request, queryset):
        updated = queryset.update(is_important=False)
        self.message_user(request, _(f'{updated} notifications ont été marquées comme non importantes.'))
    mark_as_unimportant.short_description = _('Marquer comme non important')

    def has_add_permission(self, request):
        # Permettre l'ajout manuel pour le support
        return request.user.is_superuser

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('user')


@admin.register(UserMessageSettings)
class UserMessageSettingsAdmin(admin.ModelAdmin):
    """Administration des paramètres de messagerie"""

    list_display = (
        'user_username', 'email_notifications',
        'allow_messages_from', 'show_online_status',
        'updated_at'
    )

    list_filter = (
        'email_notifications', 'push_notifications',
        'desktop_notifications', 'allow_messages_from',
        'show_online_status'
    )

    search_fields = ('user__username', 'user__email')

    readonly_fields = ('updated_at',)

    fieldsets = (
        (_('Notifications'), {
            'fields': (
                'email_notifications', 'push_notifications',
                'desktop_notifications'
            )
        }),
        (_('Confidentialité'), {
            'fields': ('allow_messages_from',)
        }),
        (_('Gestion automatique'), {
            'fields': (
                'auto_archive_conversations', 'archive_after_days',
                'auto_delete_messages', 'delete_after_days'
            )
        }),
        (_('Apparence'), {
            'fields': ('show_online_status', 'show_read_receipts')
        }),
        (_('Sécurité'), {
            'fields': ('block_spam_messages', 'filter_profanity')
        }),
        (_('Métadonnées'), {
            'fields': ('updated_at',),
            'classes': ('collapse',)
        }),
    )

    # ✅ actions doit être une liste (vide si pas d'actions)
    actions = []

    def user_username(self, obj):
        return obj.user.username
    user_username.short_description = _('Utilisateur')
    user_username.admin_order_field = 'user__username'

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('user')


@admin.register(BlockedUser)
class BlockedUserAdmin(admin.ModelAdmin):
    """Administration des utilisateurs bloqués"""

    list_display = (
        'blocker_username', 'blocked_username',
        'reason_preview', 'created_at'
    )

    list_filter = ('created_at',)

    search_fields = (
        'blocker__username', 'blocked__username',
        'reason'
    )

    readonly_fields = ('created_at',)

    fieldsets = (
        (_('Utilisateurs'), {
            'fields': ('blocker', 'blocked')
        }),
        (_('Raison'), {
            'fields': ('reason',)
        }),
        (_('Dates'), {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )

    # ✅ actions doit être une liste
    actions = ['unblock_users']

    def blocker_username(self, obj):
        return obj.blocker.username
    blocker_username.short_description = _('Bloqueur')
    blocker_username.admin_order_field = 'blocker__username'

    def blocked_username(self, obj):
        return obj.blocked.username
    blocked_username.short_description = _('Bloqué')
    blocked_username.admin_order_field = 'blocked__username'

    def reason_preview(self, obj):
        return obj.reason[:50] if obj.reason else '-'
    reason_preview.short_description = _('Raison')

    # Actions
    def unblock_users(self, request, queryset):
        deleted_count, _ = queryset.delete()
        self.message_user(request, _(f'{deleted_count} blocages ont été supprimés.'))
    unblock_users.short_description = _('Débloquer les utilisateurs')

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('blocker', 'blocked')


@admin.register(ConversationArchive)
class ConversationArchiveAdmin(admin.ModelAdmin):
    """Administration des archives de conversations"""

    list_display = (
        'user_username', 'conversation_subject',
        'archived_at'
    )

    list_filter = ('archived_at',)

    search_fields = (
        'user__username', 'conversation__subject',
        'conversation__uuid'
    )

    readonly_fields = ('archived_at',)

    # ✅ actions doit être une liste
    actions = ['unarchive_conversations']

    def user_username(self, obj):
        return obj.user.username
    user_username.short_description = _('Utilisateur')
    user_username.admin_order_field = 'user__username'

    def conversation_subject(self, obj):
        return obj.conversation.subject[:50] if obj.conversation.subject else str(obj.conversation.uuid)[:8]
    conversation_subject.short_description = _('Conversation')
    conversation_subject.admin_order_field = 'conversation__subject'

    # Actions
    def unarchive_conversations(self, request, queryset):
        deleted_count, _ = queryset.delete()
        self.message_user(request, _(f'{deleted_count} archives ont été supprimées.'))
    unarchive_conversations.short_description = _('Désarchiver')

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('user', 'conversation')


@admin.register(MessageReport)
class MessageReportAdmin(admin.ModelAdmin):
    """Administration des signalements de messages"""

    list_display = (
        'reporter_username', 'message_preview',
        'reason', 'status', 'created_at'
    )

    list_filter = ('reason', 'status', 'created_at')

    search_fields = (
        'reporter__username', 'message__content',
        'description', 'admin_notes'
    )

    readonly_fields = ('created_at', 'resolved_at')

    list_editable = ('status',)

    fieldsets = (
        (_('Signalement'), {
            'fields': ('reporter', 'message', 'reason', 'description', 'evidence')
        }),
        (_('Traitement'), {
            'fields': ('status', 'admin_notes', 'resolved_by', 'resolved_at')
        }),
        (_('Dates'), {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )

    # ✅ actions doit être une liste
    actions = ['mark_as_resolved', 'mark_as_dismissed']

    def reporter_username(self, obj):
        return obj.reporter.username
    reporter_username.short_description = _('Signaleur')
    reporter_username.admin_order_field = 'reporter__username'

    def message_preview(self, obj):
        return obj.message.content[:100] if obj.message.content else '-'
    message_preview.short_description = _('Message')

    # Actions
    def mark_as_resolved(self, request, queryset):
        updated = queryset.update(
            status='RESOLVED',
            resolved_by=request.user,
            resolved_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} signalements ont été résolus.'))
    mark_as_resolved.short_description = _('Marquer comme résolu')

    def mark_as_dismissed(self, request, queryset):
        updated = queryset.update(
            status='DISMISSED',
            resolved_by=request.user,
            resolved_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} signalements ont été rejetés.'))
    mark_as_dismissed.short_description = _('Marquer comme rejeté')

    def get_queryset(self, request):
        return super().get_queryset(request).select_related(
            'reporter', 'message', 'message__sender',
            'message__recipient', 'resolved_by'
        )


========== messaging/forms.py ==========
# ~/ebi3/messaging/forms.py
from django import forms
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import ValidationError
from django.utils import timezone
from django.core.validators import FileExtensionValidator, MaxValueValidator

from .models import (
    Conversation, Message, Notification,
    UserMessageSettings, BlockedUser,
    ConversationArchive, MessageReport
)

class NewConversationForm(forms.Form):
    """Formulaire pour démarrer une nouvelle conversation"""

    recipient = forms.CharField(
        max_length=150,
        label=_("Destinataire"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Nom d'utilisateur ou email"),
            'autocomplete': 'off'
        })
    )

    subject = forms.CharField(
        max_length=200,
        required=False,
        label=_("Sujet"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Sujet de la conversation (optionnel)")
        })
    )

    message = forms.CharField(
        label=_("Message"),
        widget=forms.Textarea(attrs={
            'class': 'form-control',
            'rows': 5,
            'placeholder': _("Votre message..."),
            'style': 'resize: none;'
        })
    )

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

    def clean_recipient(self):
        recipient_identifier = self.cleaned_data.get('recipient')

        from users.models import User

        # Rechercher l'utilisateur par username ou email
        try:
            if '@' in recipient_identifier:
                recipient = User.objects.get(email=recipient_identifier)
            else:
                recipient = User.objects.get(username=recipient_identifier)
        except User.DoesNotExist:
            raise ValidationError(_("Utilisateur non trouvé."))

        # Ne pas permettre de s'envoyer un message à soi-même
        if recipient == self.user:
            raise ValidationError(_("Vous ne pouvez pas vous envoyer un message à vous-même."))

        # Vérifier si l'utilisateur n'est pas bloqué
        if BlockedUser.objects.filter(blocker=self.user, blocked=recipient).exists():
            raise ValidationError(_("Vous avez bloqué cet utilisateur."))

        # Vérifier les paramètres de confidentialité du destinataire
        try:
            recipient_settings = recipient.message_settings
            if recipient_settings.allow_messages_from == 'CONTACTS':
                # Vérifier si l'expéditeur est dans les contacts
                # À implémenter: logique des contacts
                pass
            elif recipient_settings.allow_messages_from == 'NOBODY':
                raise ValidationError(_("Cet utilisateur n'accepte pas de messages."))
        except UserMessageSettings.DoesNotExist:
            pass

        return recipient

    def clean_message(self):
        message = self.cleaned_data.get('message')
        if len(message.strip()) < 2:
            raise ValidationError(_("Le message est trop court."))
        if len(message) > 5000:
            raise ValidationError(_("Le message est trop long (maximum 5000 caractères)."))
        return message


class MessageForm(forms.ModelForm):
    """Formulaire pour envoyer un message"""

    class Meta:
        model = Message
        fields = ['content', 'attachment']
        widgets = {
            'content': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _("Tapez votre message ici..."),
                'style': 'resize: none;'
            }),
            'attachment': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': '.jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.zip'
            })
        }
        labels = {
            'content': _("Message"),
            'attachment': _("Pièce jointe")
        }

    def __init__(self, *args, **kwargs):
        self.conversation = kwargs.pop('conversation', None)
        self.sender = kwargs.pop('sender', None)
        self.recipient = kwargs.pop('recipient', None)
        super().__init__(*args, **kwargs)

    def clean_attachment(self):
        attachment = self.cleaned_data.get('attachment')

        if attachment:
            # Valider le type de fichier
            allowed_extensions = ['jpg', 'jpeg', 'png', 'gif', 'pdf',
                                 'doc', 'docx', 'xls', 'xlsx', 'zip']
            validator = FileExtensionValidator(allowed_extensions)
            validator(attachment)

            # Valider la taille (10MB maximum)
            max_size = 10 * 1024 * 1024  # 10MB
            if attachment.size > max_size:
                raise ValidationError(
                    _(f"Le fichier est trop volumineux. Taille maximum: {max_size/(1024*1024):.0f}MB")
                )

        return attachment

    def clean(self):
        cleaned_data = super().clean()
        content = cleaned_data.get('content')
        attachment = cleaned_data.get('attachment')

        # Un message doit avoir au moins du contenu ou une pièce jointe
        if not content and not attachment:
            raise ValidationError(_("Le message doit contenir du texte ou une pièce jointe."))

        return cleaned_data

    def save(self, commit=True):
        message = super().save(commit=False)

        if self.conversation:
            message.conversation = self.conversation

        if self.sender:
            message.sender = self.sender

        if self.recipient:
            message.recipient = self.recipient

        if message.attachment:
            message.attachment_name = message.attachment.name
            message.attachment_size = message.attachment.size

        if commit:
            message.save()

        return message


class ConversationSearchForm(forms.Form):
    """Formulaire de recherche de conversations"""

    q = forms.CharField(
        required=False,
        label=_("Rechercher"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Rechercher dans les conversations...")
        })
    )

    conversation_type = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous"))] + list(Conversation.ConversationType.choices),
        label=_("Type de conversation"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    date_from = forms.DateField(
        required=False,
        label=_("Du"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    date_to = forms.DateField(
        required=False,
        label=_("Au"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    has_attachment = forms.ChoiceField(
        required=False,
        choices=[
            ('', _("Tous")),
            ('yes', _("Avec pièces jointes")),
            ('no', _("Sans pièces jointes"))
        ],
        label=_("Pièces jointes"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    is_read = forms.ChoiceField(
        required=False,
        choices=[
            ('', _("Tous")),
            ('read', _("Lus")),
            ('unread', _("Non lus"))
        ],
        label=_("Statut de lecture"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    def clean(self):
        cleaned_data = super().clean()
        date_from = cleaned_data.get('date_from')
        date_to = cleaned_data.get('date_to')

        if date_from and date_to:
            if date_to < date_from:
                raise ValidationError(_("La date de fin doit être postérieure à la date de début."))

        return cleaned_data


class MessageReportForm(forms.ModelForm):
    """Formulaire pour signaler un message"""

    class Meta:
        model = MessageReport
        fields = ['reason', 'description', 'evidence']
        widgets = {
            'reason': forms.Select(attrs={'class': 'form-control'}),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _("Décrivez le problème en détail...")
            }),
            'evidence': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*,.pdf,.doc,.docx'
            }),
        }
        labels = {
            'reason': _("Raison du signalement"),
            'description': _("Description"),
            'evidence': _("Preuve (optionnel)")
        }

    def __init__(self, *args, **kwargs):
        self.reporter = kwargs.pop('reporter', None)
        self.message = kwargs.pop('message', None)
        super().__init__(*args, **kwargs)

    def clean(self):
        cleaned_data = super().clean()

        # Vérifier si l'utilisateur a déjà signalé ce message
        if self.reporter and self.message:
            if MessageReport.objects.filter(
                reporter=self.reporter,
                message=self.message
            ).exists():
                raise ValidationError(_("Vous avez déjà signalé ce message."))

        return cleaned_data

    def save(self, commit=True):
        report = super().save(commit=False)

        if self.reporter:
            report.reporter = self.reporter

        if self.message:
            report.message = self.message

        if commit:
            report.save()

        return report


class BlockUserForm(forms.ModelForm):
    """Formulaire pour bloquer un utilisateur"""

    class Meta:
        model = BlockedUser
        fields = ['reason']
        widgets = {
            'reason': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Raison du blocage (optionnel)")
            })
        }
        labels = {
            'reason': _("Raison (optionnel)")
        }

    def __init__(self, *args, **kwargs):
        self.blocker = kwargs.pop('blocker', None)
        self.blocked = kwargs.pop('blocked', None)
        super().__init__(*args, **kwargs)

    def clean(self):
        cleaned_data = super().clean()

        # Ne pas permettre de se bloquer soi-même
        if self.blocker == self.blocked:
            raise ValidationError(_("Vous ne pouvez pas vous bloquer vous-même."))

        # Vérifier si l'utilisateur est déjà bloqué
        if BlockedUser.objects.filter(
            blocker=self.blocker,
            blocked=self.blocked
        ).exists():
            raise ValidationError(_("Vous avez déjà bloqué cet utilisateur."))

        return cleaned_data

    def save(self, commit=True):
        blocked_user = super().save(commit=False)

        if self.blocker:
            blocked_user.blocker = self.blocker

        if self.blocked:
            blocked_user.blocked = self.blocked

        if commit:
            blocked_user.save()

        return blocked_user


class UserMessageSettingsForm(forms.ModelForm):
    """Formulaire pour les paramètres de messagerie"""

    class Meta:
        model = UserMessageSettings
        fields = [
            'email_notifications', 'push_notifications', 'desktop_notifications',
            'allow_messages_from', 'auto_archive_conversations', 'archive_after_days',
            'auto_delete_messages', 'delete_after_days', 'show_online_status',
            'show_read_receipts', 'block_spam_messages', 'filter_profanity'
        ]

        widgets = {
            'allow_messages_from': forms.Select(attrs={'class': 'form-control'}),
            'archive_after_days': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '1',
                'max': '365'
            }),
            'delete_after_days': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '30',
                'max': '3650'
            }),
        }

        labels = {
            'email_notifications': _("Notifications par email"),
            'push_notifications': _("Notifications push"),
            'desktop_notifications': _("Notifications bureau"),
            'allow_messages_from': _("Autoriser les messages de"),
            'auto_archive_conversations': _("Archiver automatiquement les conversations"),
            'archive_after_days': _("Archiver après (jours)"),
            'auto_delete_messages': _("Supprimer automatiquement les messages"),
            'delete_after_days': _("Supprimer après (jours)"),
            'show_online_status': _("Afficher le statut en ligne"),
            'show_read_receipts': _("Afficher les accusés de lecture"),
            'block_spam_messages': _("Bloquer les messages indésirables"),
            'filter_profanity': _("Filtrer les gros mots"),
        }

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

    def save(self, commit=True):
        settings = super().save(commit=False)

        if self.user:
            settings.user = self.user

        if commit:
            settings.save()

        return settings


class ReplyMessageForm(forms.ModelForm):
    """Formulaire pour répondre à un message"""

    class Meta:
        model = Message
        fields = ['content', 'attachment']
        widgets = {
            'content': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _("Votre réponse..."),
                'style': 'resize: none;'
            }),
            'attachment': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': '.jpg,.jpeg,.png,.gif,.pdf,.doc,.docx'
            })
        }

    def __init__(self, *args, **kwargs):
        self.parent_message = kwargs.pop('parent_message', None)
        self.conversation = kwargs.pop('conversation', None)
        self.sender = kwargs.pop('sender', None)
        self.recipient = kwargs.pop('recipient', None)
        super().__init__(*args, **kwargs)

    def save(self, commit=True):
        message = super().save(commit=False)

        if self.parent_message:
            message.parent_message = self.parent_message

        if self.conversation:
            message.conversation = self.conversation

        if self.sender:
            message.sender = self.sender

        if self.recipient:
            message.recipient = self.recipient

        if message.attachment:
            message.attachment_name = message.attachment.name
            message.attachment_size = message.attachment.size

        if commit:
            message.save()

        return message


class ArchiveConversationForm(forms.Form):
    """Formulaire pour archiver une conversation"""

    confirm = forms.BooleanField(
        required=True,
        label=_("Confirmer l'archivage"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        self.conversation = kwargs.pop('conversation', None)
        super().__init__(*args, **kwargs)


========== messaging/__init__.py ==========
# ~/ebi3/messaging/__init__.py
"""
Application de messagerie pour Ebi3
Permet la communication entre utilisateurs, transporteurs et vendeurs
"""


========== messaging/apps.py ==========
# ~/ebi3/messaging/apps.py
from django.apps import AppConfig
from django.utils.translation import gettext_lazy as _

class MessagingConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'messaging'
    verbose_name = _("Messagerie")

    def ready(self):
        import messaging.signals  # Import des signaux


========== messaging/urls.py ==========
# ~/ebi3/messaging/urls.py
from django.urls import path
from django.contrib.auth.decorators import login_required
from . import views

app_name = 'messaging'

urlpatterns = [
    # Vues principales
    path('inbox/', views.InboxView.as_view(), name='inbox'),
    path('conversation/<uuid:uuid>/', views.ConversationDetailView.as_view(), name='conversation_detail'),
    path('new/', views.NewConversationView.as_view(), name='new_conversation'),
    path('new/<str:username>/', views.NewConversationWithUserView.as_view(), name='new_conversation_with_user'),
    path('conversation/<uuid:uuid>/send/', views.SendMessageView.as_view(), name='send_message'),
    path('conversation/<uuid:uuid>/archive/', views.ArchiveConversationView.as_view(), name='archive_conversation'),
    path('conversation/<uuid:uuid>/unarchive/', views.UnarchiveConversationView.as_view(), name='unarchive_conversation'),
    path('conversation/<uuid:uuid>/delete/', views.DeleteConversationView.as_view(), name='delete_conversation'),

    # Gestion des messages
    path('message/<uuid:message_uuid>/read/', views.MarkMessageAsReadView.as_view(), name='mark_message_read'),
    path('message/<uuid:message_uuid>/delete/', views.DeleteMessageView.as_view(), name='delete_message'),

    # Blocage d'utilisateurs
    path('block/<str:username>/', views.BlockUserView.as_view(), name='block_user'),
    path('unblock/<str:username>/', views.UnblockUserView.as_view(), name='unblock_user'),

    # Notifications
    path('notifications/', views.NotificationsView.as_view(), name='notifications'),
    path('notifications/<int:pk>/read/', views.MarkNotificationAsReadView.as_view(), name='mark_notification_read'),
    path('notifications/mark-all-read/', views.MarkAllNotificationsReadView.as_view(), name='mark_all_notifications_read'),

    # Signalements
    path('message/<uuid:message_uuid>/report/', views.ReportMessageView.as_view(), name='report_message'),

    # Paramètres
    path('settings/', views.MessageSettingsView.as_view(), name='settings'),

    # Vues spéciales
    path('sent/', views.SentMessagesView.as_view(), name='sent_messages'),
    path('archived/', views.ArchivedConversationsView.as_view(), name='archived_conversations'),
    path('unread/', views.UnreadMessagesView.as_view(), name='unread_messages'),
    path('with-attachments/', views.MessagesWithAttachmentsView.as_view(), name='messages_with_attachments'),
    path('blocked-users/', views.BlockedUsersView.as_view(), name='blocked_users'),
    path('my-reports/', views.MyReportsView.as_view(), name='my_reports'),

    # API endpoints (AJAX)
    path('api/unread-count/', views.UnreadCountAPIView.as_view(), name='api_unread_count'),
    path('api/message/<uuid:message_uuid>/mark-read/', views.MarkAsReadAPIView.as_view(), name='api_mark_read'),
    path('api/check-new-messages/', views.CheckNewMessagesAPIView.as_view(), name='api_check_new_messages'),
    path('api/upload-attachment/', views.UploadAttachmentAPIView.as_view(), name='api_upload_attachment'),
]


========== messaging/models.py ==========
# ~/ebi3/messaging/models.py
from django.db import models
from django.conf import settings
from django.utils.translation import gettext_lazy as _
from django.utils import timezone
from django.urls import reverse
import uuid


class Conversation(models.Model):
    """Modèle pour une conversation entre utilisateurs"""

    class ConversationType(models.TextChoices):
        PRIVATE = 'PRIVATE', _('Privé')
        GROUP = 'GROUP', _('Groupe')
        AD_RELATED = 'AD_RELATED', _('Lié à une annonce')
        CARRIER_RELATED = 'CARRIER_RELATED', _('Lié à un transporteur')
        SUPPORT = 'SUPPORT', _('Support')

    uuid = models.UUIDField(
        default=uuid.uuid4,
        editable=False,
        unique=True,
        verbose_name=_("UUID")
    )

    conversation_type = models.CharField(
        max_length=20,
        choices=ConversationType.choices,
        default=ConversationType.PRIVATE,
        verbose_name=_("Type de conversation")
    )

    participants = models.ManyToManyField(
        settings.AUTH_USER_MODEL,
        related_name='conversations',
        verbose_name=_("Participants")
    )

    subject = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Sujet")
    )

    # Liens vers d'autres modèles
    related_ad = models.ForeignKey(
        'ads.Ad',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='conversations',
        verbose_name=_("Annonce liée")
    )

    related_carrier = models.ForeignKey(
        'carriers.Carrier',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='conversations',
        verbose_name=_("Transporteur lié")
    )

    # Métadonnées
    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Active")
    )

    is_archived = models.BooleanField(
        default=False,
        verbose_name=_("Archivée")
    )

    is_blocked = models.BooleanField(
        default=False,
        verbose_name=_("Bloquée")
    )

    blocked_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='blocked_conversations',
        verbose_name=_("Bloquée par")
    )

    blocked_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Bloquée le")
    )

    last_message_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Dernier message le")
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Conversation")
        verbose_name_plural = _("Conversations")
        ordering = ['-last_message_at', '-created_at']
        indexes = [
            models.Index(fields=['uuid']),
            models.Index(fields=['conversation_type', 'is_active']),
            models.Index(fields=['last_message_at']),
        ]

    def __str__(self):
        if self.subject:
            return f"{self.subject} ({self.get_conversation_type_display()})"
        participants = self.participants.all()[:3]
        names = ", ".join([p.username for p in participants])
        if self.participants.count() > 3:
            names += f" + {self.participants.count() - 3} autres"
        return names

    def get_absolute_url(self):
        return reverse('messaging:conversation_detail', kwargs={'uuid': self.uuid})

    def get_participants_except(self, user):
        """Obtenir tous les participants sauf l'utilisateur spécifié"""
        return self.participants.exclude(id=user.id)

    def get_other_participant(self, user):
        """Obtenir l'autre participant (pour les conversations à 2)"""
        if self.participants.count() == 2:
            return self.participants.exclude(id=user.id).first()
        return None

    def update_last_message_time(self):
        """Mettre à jour le temps du dernier message"""
        last_message = self.messages.filter(is_deleted=False).last()
        if last_message:
            self.last_message_at = last_message.sent_at
            self.save(update_fields=['last_message_at'])

    def mark_as_read_for_user(self, user):
        """Marquer tous les messages non lus comme lus pour un utilisateur"""
        self.messages.filter(
            is_read=False,
            recipient=user
        ).update(is_read=True, read_at=timezone.now())

    def get_unread_count_for_user(self, user):
        """Obtenir le nombre de messages non lus pour un utilisateur"""
        return self.messages.filter(
            recipient=user,
            is_read=False,
            is_deleted=False
        ).count()

    def can_user_access(self, user):
        """Vérifier si un utilisateur peut accéder à la conversation"""
        if not self.is_active or self.is_blocked:
            return False
        return self.participants.filter(id=user.id).exists()

    @classmethod
    def get_or_create_conversation(cls, user1, user2, **kwargs):
        """Obtenir ou créer une conversation entre deux utilisateurs"""
        # Rechercher une conversation existante
        conversations = cls.objects.filter(
            participants=user1
        ).filter(
            participants=user2
        ).filter(
            conversation_type=cls.ConversationType.PRIVATE
        ).filter(
            is_active=True,
            is_blocked=False
        )

        if conversations.exists():
            return conversations.first()

        # Créer une nouvelle conversation
        conversation = cls.objects.create(
            conversation_type=cls.ConversationType.PRIVATE,
            **kwargs
        )
        conversation.participants.add(user1, user2)
        return conversation


class Message(models.Model):
    """Modèle pour un message dans une conversation"""

    uuid = models.UUIDField(
        default=uuid.uuid4,
        editable=False,
        unique=True,
        verbose_name=_("UUID")
    )

    conversation = models.ForeignKey(
        Conversation,
        on_delete=models.CASCADE,
        related_name='messages',
        verbose_name=_("Conversation")
    )

    sender = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='sent_messages',
        verbose_name=_("Expéditeur")
    )

    recipient = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='received_messages',
        verbose_name=_("Destinataire")
    )

    content = models.TextField(
        verbose_name=_("Contenu"),
        help_text=_("Contenu du message")
    )

    # Métadonnées du message
    is_read = models.BooleanField(
        default=False,
        verbose_name=_("Lu")
    )

    read_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Lu le")
    )

    is_deleted = models.BooleanField(
        default=False,
        verbose_name=_("Supprimé")
    )

    deleted_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Supprimé le")
    )

    deleted_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='deleted_messages',
        verbose_name=_("Supprimé par")
    )

    # Fichiers joints
    attachment = models.FileField(
        upload_to='messaging/attachments/%Y/%m/%d/',
        null=True,
        blank=True,
        verbose_name=_("Pièce jointe")
    )

    attachment_name = models.CharField(
        max_length=255,
        blank=True,
        verbose_name=_("Nom du fichier")
    )

    attachment_size = models.PositiveIntegerField(
        null=True,
        blank=True,
        verbose_name=_("Taille du fichier (octets)")
    )

    # Références
    parent_message = models.ForeignKey(
        'self',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='replies',
        verbose_name=_("Message parent")
    )

    # Timestamps
    sent_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Message")
        verbose_name_plural = _("Messages")
        ordering = ['sent_at']
        indexes = [
            models.Index(fields=['uuid']),
            models.Index(fields=['conversation', 'sent_at']),
            models.Index(fields=['sender', 'sent_at']),
            models.Index(fields=['recipient', 'is_read', 'sent_at']),
            models.Index(fields=['is_deleted', 'sent_at']),
        ]

    def __str__(self):
        return f"Message de {self.sender.username} à {self.recipient.username}"

    def save(self, *args, **kwargs):
        # Mettre à jour le temps du dernier message dans la conversation
        is_new = self.pk is None
        super().save(*args, **kwargs)

        if is_new:
            self.conversation.update_last_message_time()

    def mark_as_read(self):
        """Marquer le message comme lu"""
        if not self.is_read:
            self.is_read = True
            self.read_at = timezone.now()
            self.save(update_fields=['is_read', 'read_at'])

    def soft_delete(self, user):
        """Supprimer doucement le message"""
        self.is_deleted = True
        self.deleted_at = timezone.now()
        self.deleted_by = user
        self.save(update_fields=['is_deleted', 'deleted_at', 'deleted_by'])

    def can_user_access(self, user):
        """Vérifier si un utilisateur peut accéder au message"""
        if self.is_deleted and user != self.deleted_by:
            return False
        return user in [self.sender, self.recipient]


class Notification(models.Model):
    """Modèle pour les notifications"""

    class NotificationType(models.TextChoices):
        MESSAGE_RECEIVED = 'MESSAGE_RECEIVED', _('Message reçu')
        MESSAGE_READ = 'MESSAGE_READ', _('Message lu')
        CONVERSATION_NEW = 'CONVERSATION_NEW', _('Nouvelle conversation')
        CONVERSATION_ARCHIVED = 'CONVERSATION_ARCHIVED', _('Conversation archivée')
        SYSTEM = 'SYSTEM', _('Système')
        AD_RELATED = 'AD_RELATED', _('Lié à une annonce')
        CARRIER_RELATED = 'CARRIER_RELATED', _('Lié à un transporteur')
        PAYMENT = 'PAYMENT', _('Paiement')
        SECURITY = 'SECURITY', _('Sécurité')

    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='notifications',
        verbose_name=_("Utilisateur")
    )

    notification_type = models.CharField(
        max_length=30,
        choices=NotificationType.choices,
        verbose_name=_("Type de notification")
    )

    title = models.CharField(
        max_length=200,
        verbose_name=_("Titre")
    )

    message = models.TextField(
        verbose_name=_("Message")
    )

    # Liens
    related_conversation = models.ForeignKey(
        Conversation,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='notifications',
        verbose_name=_("Conversation liée")
    )

    related_message = models.ForeignKey(
        Message,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='notifications',
        verbose_name=_("Message lié")
    )

    related_ad = models.ForeignKey(
        'ads.Ad',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='notifications',
        verbose_name=_("Annonce liée")
    )

    # Métadonnées
    is_read = models.BooleanField(
        default=False,
        verbose_name=_("Lue")
    )

    is_important = models.BooleanField(
        default=False,
        verbose_name=_("Importante")
    )

    action_url = models.URLField(
        blank=True,
        verbose_name=_("URL d'action")
    )

    action_text = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Texte de l'action")
    )

    expires_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Expire le")
    )

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Notification")
        verbose_name_plural = _("Notifications")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['user', 'is_read', 'created_at']),
            models.Index(fields=['notification_type', 'created_at']),
        ]

    def __str__(self):
        return f"Notification pour {self.user.username}: {self.title}"

    def mark_as_read(self):
        """Marquer la notification comme lue"""
        if not self.is_read:
            self.is_read = True
            self.save(update_fields=['is_read'])

    def is_expired(self):
        """Vérifier si la notification est expirée"""
        if self.expires_at:
            return timezone.now() > self.expires_at
        return False


class UserMessageSettings(models.Model):
    """Paramètres de messagerie pour chaque utilisateur"""

    user = models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='message_settings',
        verbose_name=_("Utilisateur")
    )

    # Notifications
    email_notifications = models.BooleanField(
        default=True,
        verbose_name=_("Notifications par email")
    )

    push_notifications = models.BooleanField(
        default=True,
        verbose_name=_("Notifications push")
    )

    desktop_notifications = models.BooleanField(
        default=True,
        verbose_name=_("Notifications bureau")
    )

    # Privacy
    allow_messages_from = models.CharField(
        max_length=20,
        choices=[
            ('EVERYONE', _('Tout le monde')),
            ('CONTACTS', _('Contacts uniquement')),
            ('NOBODY', _('Personne')),
        ],
        default='EVERYONE',
        verbose_name=_("Autoriser les messages de")
    )

    auto_archive_conversations = models.BooleanField(
        default=False,
        verbose_name=_("Archiver automatiquement les conversations")
    )

    archive_after_days = models.PositiveIntegerField(
        default=30,
        verbose_name=_("Archiver après (jours)")
    )

    auto_delete_messages = models.BooleanField(
        default=False,
        verbose_name=_("Supprimer automatiquement les messages")
    )

    delete_after_days = models.PositiveIntegerField(
        default=365,
        verbose_name=_("Supprimer après (jours)")
    )

    # Appearance
    show_online_status = models.BooleanField(
        default=True,
        verbose_name=_("Afficher le statut en ligne")
    )

    show_read_receipts = models.BooleanField(
        default=True,
        verbose_name=_("Afficher les accusés de lecture")
    )

    # Security
    block_spam_messages = models.BooleanField(
        default=True,
        verbose_name=_("Bloquer les messages indésirables")
    )

    filter_profanity = models.BooleanField(
        default=True,
        verbose_name=_("Filtrer les gros mots")
    )

    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Paramètres de messagerie")
        verbose_name_plural = _("Paramètres de messagerie")

    def __str__(self):
        return f"Paramètres de messagerie pour {self.user.username}"


class BlockedUser(models.Model):
    """Utilisateurs bloqués"""

    blocker = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='blocked_users',
        verbose_name=_("Bloqueur")
    )

    blocked = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='blocked_by',
        verbose_name=_("Bloqué")
    )

    reason = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Raison")
    )

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Utilisateur bloqué")
        verbose_name_plural = _("Utilisateurs bloqués")
        unique_together = ['blocker', 'blocked']
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.blocker.username} a bloqué {self.blocked.username}"


class ConversationArchive(models.Model):
    """Archive des conversations"""

    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='archived_conversations',
        verbose_name=_("Utilisateur")
    )

    conversation = models.ForeignKey(
        Conversation,
        on_delete=models.CASCADE,
        related_name='archives',
        verbose_name=_("Conversation")
    )

    archived_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Archive de conversation")
        verbose_name_plural = _("Archives de conversations")
        unique_together = ['user', 'conversation']
        ordering = ['-archived_at']

    def __str__(self):
        return f"Archive: {self.conversation} par {self.user.username}"


class MessageReport(models.Model):
    """Signalements de messages"""

    class ReportReason(models.TextChoices):
        SPAM = 'SPAM', _('Spam')
        HARASSMENT = 'HARASSMENT', _('Harcèlement')
        INAPPROPRIATE = 'INAPPROPRIATE', _('Contenu inapproprié')
        SCAM = 'SCAM', _('Arnaque')
        THREAT = 'THREAT', _('Menace')
        OTHER = 'OTHER', _('Autre')

    reporter = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='message_reports',
        verbose_name=_("Signaleur")
    )

    message = models.ForeignKey(
        Message,
        on_delete=models.CASCADE,
        related_name='reports',
        verbose_name=_("Message")
    )

    reason = models.CharField(
        max_length=20,
        choices=ReportReason.choices,
        verbose_name=_("Raison")
    )

    description = models.TextField(
        blank=True,
        verbose_name=_("Description")
    )

    evidence = models.FileField(
        upload_to='messaging/reports/%Y/%m/%d/',
        null=True,
        blank=True,
        verbose_name=_("Preuve")
    )

    status = models.CharField(
        max_length=20,
        choices=[
            ('PENDING', _('En attente')),
            ('UNDER_REVIEW', _('En examen')),
            ('RESOLVED', _('Résolu')),
            ('DISMISSED', _('Rejeté')),
        ],
        default='PENDING',
        verbose_name=_("Statut")
    )

    admin_notes = models.TextField(
        blank=True,
        verbose_name=_("Notes de l'administrateur")
    )

    resolved_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Résolu le")
    )

    resolved_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='resolved_message_reports',
        verbose_name=_("Résolu par")
    )

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Signalement de message")
        verbose_name_plural = _("Signalements de messages")
        ordering = ['-created_at']

    def __str__(self):
        return f"Signalement de {self.reporter.username} sur le message {self.message.id}"


========== messaging/views.py ==========
# ~/ebi3/messaging/views.py
from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib.auth.mixins import LoginRequiredMixin
from django.views.generic import (
    ListView, DetailView, CreateView,
    UpdateView, DeleteView, TemplateView, View
)
from django.db.models import Q, Count, Max
from django.utils import timezone
from django.urls import reverse_lazy
from django.contrib import messages
from django.utils.translation import gettext_lazy as _
from django.core.paginator import Paginator
from django.http import JsonResponse, HttpResponseForbidden
from django.views.decorators.http import require_POST
from django.views.decorators.csrf import csrf_protect
from django.db import transaction
import json

from .models import (
    Conversation, Message, Notification,
    UserMessageSettings, BlockedUser,
    ConversationArchive, MessageReport
)
from .forms import (
    NewConversationForm, MessageForm,
    ConversationSearchForm, MessageReportForm,
    BlockUserForm, UserMessageSettingsForm,
    ReplyMessageForm, ArchiveConversationForm
)
from users.models import User


class InboxView(LoginRequiredMixin, ListView):
    """Vue de la boîte de réception"""
    model = Conversation
    template_name = 'messaging/inbox.html'
    context_object_name = 'conversations'
    paginate_by = 20

    def get_queryset(self):
        # Récupérer les conversations où l'utilisateur est participant
        queryset = Conversation.objects.filter(
            participants=self.request.user,
            is_active=True,
            is_blocked=False
        ).annotate(
            unread_count=Count('messages', filter=Q(
                messages__recipient=self.request.user,
                messages__is_read=False,
                messages__is_deleted=False
            )),
            last_message_time=Max('messages__sent_at')
        ).order_by('-last_message_time', '-created_at')

        # Filtrer par recherche
        form = ConversationSearchForm(self.request.GET)
        if form.is_valid():
            search_term = form.cleaned_data.get('q')
            if search_term:
                queryset = queryset.filter(
                    Q(subject__icontains=search_term) |
                    Q(messages__content__icontains=search_term) |
                    Q(participants__username__icontains=search_term)
                ).distinct()

            conversation_type = form.cleaned_data.get('conversation_type')
            if conversation_type:
                queryset = queryset.filter(conversation_type=conversation_type)

            date_from = form.cleaned_data.get('date_from')
            date_to = form.cleaned_data.get('date_to')
            if date_from:
                queryset = queryset.filter(messages__sent_at__gte=date_from)
            if date_to:
                queryset = queryset.filter(messages__sent_at__lte=date_to)

            has_attachment = form.cleaned_data.get('has_attachment')
            if has_attachment == 'yes':
                queryset = queryset.filter(messages__attachment__isnull=False).distinct()
            elif has_attachment == 'no':
                queryset = queryset.filter(messages__attachment__isnull=True).distinct()

            is_read = form.cleaned_data.get('is_read')
            if is_read == 'read':
                queryset = queryset.filter(
                    messages__recipient=self.request.user,
                    messages__is_read=True
                ).distinct()
            elif is_read == 'unread':
                queryset = queryset.filter(
                    messages__recipient=self.request.user,
                    messages__is_read=False
                ).distinct()

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['search_form'] = ConversationSearchForm(self.request.GET)

        # Statistiques
        context['total_conversations'] = self.get_queryset().count()
        context['unread_messages_count'] = Message.objects.filter(
            recipient=self.request.user,
            is_read=False,
            is_deleted=False
        ).count()

        # Conversations archivées
        context['archived_conversations_count'] = ConversationArchive.objects.filter(
            user=self.request.user
        ).count()

        return context


class ConversationDetailView(LoginRequiredMixin, DetailView):
    """Vue de détail d'une conversation"""
    model = Conversation
    template_name = 'messaging/conversation_detail.html'
    context_object_name = 'conversation'

    def get_object(self):
        # Récupérer la conversation par UUID
        uuid = self.kwargs.get('uuid')
        conversation = get_object_or_404(
            Conversation.objects.prefetch_related('participants'),
            uuid=uuid
        )

        # Vérifier les permissions
        if not conversation.can_user_access(self.request.user):
            raise HttpResponseForbidden(_("Vous n'avez pas accès à cette conversation."))

        return conversation

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        conversation = self.object

        # Marquer tous les messages comme lus
        conversation.mark_as_read_for_user(self.request.user)

        # Récupérer les messages
        messages = conversation.messages.filter(
            is_deleted=False
        ).select_related('sender', 'recipient', 'parent_message').order_by('sent_at')

        # Pagination
        paginator = Paginator(messages, 50)
        page = self.request.GET.get('page')
        messages_page = paginator.get_page(page)

        # Formulaire de réponse
        context['message_form'] = MessageForm(
            conversation=conversation,
            sender=self.request.user,
            recipient=conversation.get_other_participant(self.request.user)
        )

        # Informations supplémentaires
        context['messages'] = messages_page
        context['other_participant'] = conversation.get_other_participant(self.request.user)
        context['is_blocked'] = BlockedUser.objects.filter(
            blocker=self.request.user,
            blocked=context['other_participant']
        ).exists() if context['other_participant'] else False

        # Vérifier si l'utilisateur peut envoyer des messages
        if context['other_participant']:
            try:
                recipient_settings = context['other_participant'].message_settings
                context['can_send_message'] = recipient_settings.allow_messages_from != 'NOBODY'
            except UserMessageSettings.DoesNotExist:
                context['can_send_message'] = True
        else:
            context['can_send_message'] = True

        return context


class NewConversationView(LoginRequiredMixin, CreateView):
    """Vue pour démarrer une nouvelle conversation"""
    template_name = 'messaging/new_conversation.html'
    form_class = NewConversationForm

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['user'] = self.request.user
        return kwargs

    def form_valid(self, form):
        recipient = form.cleaned_data['recipient']
        subject = form.cleaned_data.get('subject', '')
        message_content = form.cleaned_data['message']

        with transaction.atomic():
            # Obtenir ou créer la conversation
            conversation = Conversation.get_or_create_conversation(
                self.request.user,
                recipient,
                subject=subject
            )

            # Créer le premier message
            Message.objects.create(
                conversation=conversation,
                sender=self.request.user,
                recipient=recipient,
                content=message_content
            )

        messages.success(self.request, _("Message envoyé avec succès !"))
        return redirect('messaging:conversation_detail', uuid=conversation.uuid)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['title'] = _("Nouvelle conversation")
        return context


class NewConversationWithUserView(LoginRequiredMixin, View):
    """Vue pour démarrer une conversation avec un utilisateur spécifique"""

    def get(self, request, username):
        recipient = get_object_or_404(User, username=username)

        # Vérifier si l'utilisateur n'est pas bloqué
        if BlockedUser.objects.filter(blocker=request.user, blocked=recipient).exists():
            messages.error(request, _("Vous avez bloqué cet utilisateur."))
            return redirect('messaging:inbox')

        # Vérifier les paramètres de confidentialité
        try:
            recipient_settings = recipient.message_settings
            if recipient_settings.allow_messages_from == 'NOBODY':
                messages.error(request, _("Cet utilisateur n'accepte pas de messages."))
                return redirect('messaging:inbox')
        except UserMessageSettings.DoesNotExist:
            pass

        # Vérifier s'il existe déjà une conversation
        existing_conversation = Conversation.objects.filter(
            participants=request.user
        ).filter(
            participants=recipient
        ).filter(
            conversation_type=Conversation.ConversationType.PRIVATE,
            is_active=True,
            is_blocked=False
        ).first()

        if existing_conversation:
            return redirect('messaging:conversation_detail', uuid=existing_conversation.uuid)

        # Créer une nouvelle conversation
        conversation = Conversation.objects.create(
            conversation_type=Conversation.ConversationType.PRIVATE
        )
        conversation.participants.add(request.user, recipient)

        return redirect('messaging:conversation_detail', uuid=conversation.uuid)


class SendMessageView(LoginRequiredMixin, View):
    """Vue pour envoyer un message dans une conversation"""

    def post(self, request, uuid):
        conversation = get_object_or_404(Conversation, uuid=uuid)

        # Vérifier les permissions
        if not conversation.can_user_access(request.user):
            return JsonResponse({'error': _("Accès refusé.")}, status=403)

        # Vérifier si la conversation est bloquée
        if conversation.is_blocked:
            return JsonResponse({'error': _("Cette conversation est bloquée.")}, status=400)

        # Récupérer le destinataire
        other_participant = conversation.get_other_participant(request.user)
        if not other_participant:
            return JsonResponse({'error': _("Destinataire non trouvé.")}, status=400)

        # Vérifier si l'utilisateur n'est pas bloqué
        if BlockedUser.objects.filter(blocker=other_participant, blocked=request.user).exists():
            return JsonResponse({'error': _("Vous êtes bloqué par cet utilisateur.")}, status=400)

        # Vérifier les paramètres de confidentialité
        try:
            recipient_settings = other_participant.message_settings
            if recipient_settings.allow_messages_from == 'NOBODY':
                return JsonResponse({'error': _("Cet utilisateur n'accepte pas de messages.")}, status=400)
        except UserMessageSettings.DoesNotExist:
            pass

        form = MessageForm(
            request.POST,
            request.FILES,
            conversation=conversation,
            sender=request.user,
            recipient=other_participant
        )

        if form.is_valid():
            message = form.save()

            # Réponse pour AJAX
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'success': True,
                    'message_id': message.id,
                    'content': message.content,
                    'sent_at': message.sent_at.strftime('%H:%M'),
                    'sender': message.sender.username
                })

            messages.success(request, _("Message envoyé avec succès !"))
            return redirect('messaging:conversation_detail', uuid=conversation.uuid)
        else:
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'error': form.errors.as_json()
                }, status=400)

            messages.error(request, _("Erreur lors de l'envoi du message."))
            return redirect('messaging:conversation_detail', uuid=conversation.uuid)


class ArchiveConversationView(LoginRequiredMixin, View):
    """Vue pour archiver une conversation"""

    def post(self, request, uuid):
        conversation = get_object_or_404(Conversation, uuid=uuid)

        # Vérifier les permissions
        if not conversation.can_user_access(request.user):
            messages.error(request, _("Accès refusé."))
            return redirect('messaging:inbox')

        form = ArchiveConversationForm(
            request.POST,
            user=request.user,
            conversation=conversation
        )

        if form.is_valid():
            # Créer une archive
            ConversationArchive.objects.get_or_create(
                user=request.user,
                conversation=conversation
            )

            messages.success(request, _("Conversation archivée avec succès."))
        else:
            messages.error(request, _("Erreur lors de l'archivage."))

        return redirect('messaging:inbox')


class UnarchiveConversationView(LoginRequiredMixin, View):
    """Vue pour désarchiver une conversation"""

    def post(self, request, uuid):
        conversation = get_object_or_404(Conversation, uuid=uuid)

        # Supprimer l'archive
        ConversationArchive.objects.filter(
            user=request.user,
            conversation=conversation
        ).delete()

        messages.success(request, _("Conversation désarchivée avec succès."))
        return redirect('messaging:inbox')


class DeleteConversationView(LoginRequiredMixin, View):
    """Vue pour supprimer une conversation"""

    def post(self, request, uuid):
        conversation = get_object_or_404(Conversation, uuid=uuid)

        # Vérifier les permissions
        if not conversation.can_user_access(request.user):
            messages.error(request, _("Accès refusé."))
            return redirect('messaging:inbox')

        # Supprimer tous les messages de l'utilisateur dans cette conversation
        Message.objects.filter(
            conversation=conversation,
            recipient=request.user
        ).update(
            is_deleted=True,
            deleted_by=request.user,
            deleted_at=timezone.now()
        )

        # Si l'utilisateur est expéditeur, supprimer aussi ses messages envoyés
        Message.objects.filter(
            conversation=conversation,
            sender=request.user
        ).update(
            is_deleted=True,
            deleted_by=request.user,
            deleted_at=timezone.now()
        )

        messages.success(request, _("Conversation supprimée avec succès."))
        return redirect('messaging:inbox')


class MarkMessageAsReadView(LoginRequiredMixin, View):
    """Vue pour marquer un message comme lu"""

    def post(self, request, message_uuid):
        message = get_object_or_404(Message, uuid=message_uuid)

        # Vérifier les permissions
        if message.recipient != request.user:
            return JsonResponse({'error': _("Accès refusé.")}, status=403)

        message.mark_as_read()

        if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({'success': True})

        return redirect('messaging:conversation_detail', uuid=message.conversation.uuid)


class DeleteMessageView(LoginRequiredMixin, View):
    """Vue pour supprimer un message"""

    def post(self, request, message_uuid):
        message = get_object_or_404(Message, uuid=message_uuid)

        # Vérifier les permissions
        if message.sender != request.user and message.recipient != request.user:
            messages.error(request, _("Accès refusé."))
            return redirect('messaging:inbox')

        message.soft_delete(request.user)

        messages.success(request, _("Message supprimé avec succès."))
        return redirect('messaging:conversation_detail', uuid=message.conversation.uuid)


class BlockUserView(LoginRequiredMixin, View):
    """Vue pour bloquer un utilisateur"""

    def post(self, request, username):
        blocked_user = get_object_or_404(User, username=username)

        # Ne pas permettre de se bloquer soi-même
        if blocked_user == request.user:
            messages.error(request, _("Vous ne pouvez pas vous bloquer vous-même."))
            return redirect('messaging:inbox')

        form = BlockUserForm(
            request.POST,
            blocker=request.user,
            blocked=blocked_user
        )

        if form.is_valid():
            form.save()
            messages.success(request, _("Utilisateur bloqué avec succès."))
        else:
            for error in form.errors.values():
                messages.error(request, error)

        return redirect('messaging:inbox')


class UnblockUserView(LoginRequiredMixin, View):
    """Vue pour débloquer un utilisateur"""

    def post(self, request, username):
        blocked_user = get_object_or_404(User, username=username)

        # Supprimer le blocage
        BlockedUser.objects.filter(
            blocker=request.user,
            blocked=blocked_user
        ).delete()

        messages.success(request, _("Utilisateur débloqué avec succès."))
        return redirect('messaging:inbox')


class NotificationsView(LoginRequiredMixin, ListView):
    """Vue des notifications"""
    model = Notification
    template_name = 'messaging/notifications.html'
    context_object_name = 'notifications'
    paginate_by = 20

    def get_queryset(self):
        return Notification.objects.filter(
            user=self.request.user
        ).exclude(
            expires_at__lt=timezone.now()
        ).order_by('-created_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['unread_count'] = self.get_queryset().filter(is_read=False).count()
        return context


class MarkNotificationAsReadView(LoginRequiredMixin, View):
    """Vue pour marquer une notification comme lue"""

    def post(self, request, pk):
        notification = get_object_or_404(
            Notification,
            pk=pk,
            user=request.user
        )

        notification.mark_as_read()

        if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({'success': True})

        return redirect('messaging:notifications')


class MarkAllNotificationsReadView(LoginRequiredMixin, View):
    """Vue pour marquer toutes les notifications comme lues"""

    def post(self, request):
        Notification.objects.filter(
            user=request.user,
            is_read=False
        ).update(is_read=True)

        messages.success(request, _("Toutes les notifications ont été marquées comme lues."))
        return redirect('messaging:notifications')


class ReportMessageView(LoginRequiredMixin, CreateView):
    """Vue pour signaler un message"""
    template_name = 'messaging/report_message.html'
    form_class = MessageReportForm

    def dispatch(self, request, *args, **kwargs):
        self.message = get_object_or_404(Message, uuid=kwargs.get('message_uuid'))

        # Vérifier si l'utilisateur a accès au message
        if not self.message.can_user_access(request.user):
            messages.error(request, _("Accès refusé."))
            return redirect('messaging:inbox')

        # Vérifier si l'utilisateur a déjà signalé ce message
        if MessageReport.objects.filter(
            reporter=request.user,
            message=self.message
        ).exists():
            messages.warning(request, _("Vous avez déjà signalé ce message."))
            return redirect('messaging:conversation_detail', uuid=self.message.conversation.uuid)

        return super().dispatch(request, *args, **kwargs)

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['reporter'] = self.request.user
        kwargs['message'] = self.message
        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['message'] = self.message
        return context

    def form_valid(self, form):
        report = form.save()

        messages.success(
            self.request,
            _("Votre signalement a été soumis. Notre équipe l'examinera sous 24 heures.")
        )
        return redirect('messaging:conversation_detail', uuid=self.message.conversation.uuid)


class MessageSettingsView(LoginRequiredMixin, UpdateView):
    """Vue pour les paramètres de messagerie"""
    template_name = 'messaging/settings.html'
    form_class = UserMessageSettingsForm

    def get_object(self):
        # Obtenir ou créer les paramètres
        obj, created = UserMessageSettings.objects.get_or_create(
            user=self.request.user
        )
        return obj

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['user'] = self.request.user
        return kwargs

    def form_valid(self, form):
        messages.success(self.request, _("Paramètres mis à jour avec succès."))
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('messaging:settings')


# ============================================================================
# VUES API (AJAX)
# ============================================================================

class UnreadCountAPIView(LoginRequiredMixin, View):
    """API pour obtenir le nombre de messages non lus"""

    def get(self, request):
        unread_count = Message.objects.filter(
            recipient=request.user,
            is_read=False,
            is_deleted=False
        ).count()

        return JsonResponse({'unread_count': unread_count})


class MarkAsReadAPIView(LoginRequiredMixin, View):
    """API pour marquer un message comme lu"""

    def post(self, request, message_uuid):
        message = get_object_or_404(Message, uuid=message_uuid)

        if message.recipient != request.user:
            return JsonResponse({'error': _("Accès refusé.")}, status=403)

        message.mark_as_read()

        return JsonResponse({'success': True})


class CheckNewMessagesAPIView(LoginRequiredMixin, View):
    """API pour vérifier les nouveaux messages"""

    def get(self, request):
        conversation_uuid = request.GET.get('conversation_uuid')

        if conversation_uuid:
            # Vérifier les nouveaux messages dans une conversation spécifique
            conversation = get_object_or_404(Conversation, uuid=conversation_uuid)

            if not conversation.can_user_access(request.user):
                return JsonResponse({'error': _("Accès refusé.")}, status=403)

            last_message_id = request.GET.get('last_message_id', 0)

            new_messages = conversation.messages.filter(
                id__gt=last_message_id,
                is_deleted=False
            ).order_by('sent_at')

            messages_data = []
            for msg in new_messages:
                messages_data.append({
                    'id': msg.id,
                    'content': msg.content,
                    'sender': msg.sender.username,
                    'sent_at': msg.sent_at.strftime('%H:%M'),
                    'is_own': msg.sender == request.user
                })

            return JsonResponse({
                'has_new': len(messages_data) > 0,
                'messages': messages_data,
                'last_message_id': new_messages.last().id if new_messages.exists() else last_message_id
            })
        else:
            # Vérifier s'il y a de nouvelles conversations
            # (à implémenter selon les besoins)
            return JsonResponse({'has_new': False})


class UploadAttachmentAPIView(LoginRequiredMixin, View):
    """API pour uploader une pièce jointe"""

    def post(self, request):
        if 'file' not in request.FILES:
            return JsonResponse({'error': _("Aucun fichier fourni.")}, status=400)

        file = request.FILES['file']

        # Validation de la taille
        max_size = 10 * 1024 * 1024  # 10MB
        if file.size > max_size:
            return JsonResponse({
                'error': _(f"Le fichier est trop volumineux. Taille maximum: {max_size/(1024*1024):.0f}MB")
            }, status=400)

        # Validation du type
        allowed_extensions = ['.jpg', '.jpeg', '.png', '.gif', '.pdf',
                             '.doc', '.docx', '.xls', '.xlsx', '.zip']
        import os
        ext = os.path.splitext(file.name)[1].lower()

        if ext not in allowed_extensions:
            return JsonResponse({
                'error': _(f"Type de fichier non autorisé. Types autorisés: {', '.join(allowed_extensions)}")
            }, status=400)

        # Pour l'instant, retourner juste le nom du fichier
        # Dans une implémentation réelle, vous sauvegarderiez le fichier
        return JsonResponse({
            'success': True,
            'filename': file.name,
            'size': file.size
        })


# ============================================================================
# VUES SUPPLEMENTAIRES
# ============================================================================

class SentMessagesView(LoginRequiredMixin, ListView):
    """Vue des messages envoyés"""
    template_name = 'messaging/sent.html'
    context_object_name = 'messages'
    paginate_by = 20

    def get_queryset(self):
        return Message.objects.filter(
            sender=self.request.user,
            is_deleted=False
        ).select_related(
            'conversation', 'recipient'
        ).order_by('-sent_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['title'] = _("Messages envoyés")
        return context


class ArchivedConversationsView(LoginRequiredMixin, ListView):
    """Vue des conversations archivées"""
    template_name = 'messaging/archived.html'
    context_object_name = 'conversations'
    paginate_by = 20

    def get_queryset(self):
        return Conversation.objects.filter(
            archives__user=self.request.user
        ).annotate(
            last_message_time=Max('messages__sent_at')
        ).order_by('-last_message_time')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['title'] = _("Conversations archivées")
        return context


class UnreadMessagesView(LoginRequiredMixin, ListView):
    """Vue des messages non lus"""
    template_name = 'messaging/unread.html'
    context_object_name = 'messages'
    paginate_by = 20

    def get_queryset(self):
        return Message.objects.filter(
            recipient=self.request.user,
            is_read=False,
            is_deleted=False
        ).select_related(
            'conversation', 'sender'
        ).order_by('-sent_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['title'] = _("Messages non lus")
        return context


class MessagesWithAttachmentsView(LoginRequiredMixin, ListView):
    """Vue des messages avec pièces jointes"""
    template_name = 'messaging/with_attachments.html'
    context_object_name = 'messages'
    paginate_by = 20

    def get_queryset(self):
        return Message.objects.filter(
            Q(sender=self.request.user) | Q(recipient=self.request.user),
            attachment__isnull=False,
            is_deleted=False
        ).select_related(
            'conversation', 'sender', 'recipient'
        ).order_by('-sent_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['title'] = _("Messages avec pièces jointes")
        return context


class BlockedUsersView(LoginRequiredMixin, ListView):
    """Vue des utilisateurs bloqués"""
    template_name = 'messaging/blocked_users.html'
    context_object_name = 'blocked_users'

    def get_queryset(self):
        return BlockedUser.objects.filter(
            blocker=self.request.user
        ).select_related('blocked').order_by('-created_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['title'] = _("Utilisateurs bloqués")
        return context


class MyReportsView(LoginRequiredMixin, ListView):
    """Vue des signalements de l'utilisateur"""
    template_name = 'messaging/my_reports.html'
    context_object_name = 'reports'
    paginate_by = 20

    def get_queryset(self):
        return MessageReport.objects.filter(
            reporter=self.request.user
        ).select_related(
            'message', 'message__conversation'
        ).order_by('-created_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['title'] = _("Mes signalements")
        return context


========== payments/middleware.py ==========
# ~/ebi3/payments/middleware.py
"""
Middleware pour la sécurité des paiements
"""

import logging
import time
from django.utils.deprecation import MiddlewareMixin
from django.conf import settings
from django.http import HttpResponseForbidden, JsonResponse
from django.utils.translation import gettext_lazy as _
from django.core.cache import cache
from ipaddress import ip_address, ip_network

from .exceptions import RateLimitExceededError, FraudDetectionError

logger = logging.getLogger(__name__)


class PaymentSecurityMiddleware(MiddlewareMixin):
    """
    Middleware de sécurité pour les paiements
    - Limite de taux
    - Détection de fraude
    - Filtrage IP
    """

    def __init__(self, get_response):
        super().__init__(get_response)
        self.get_response = get_response

        # Configuration
        self.rate_limit = getattr(settings, 'PAYMENT_RATE_LIMIT', {
            'requests_per_minute': 60,
            'requests_per_hour': 300,
            'requests_per_day': 1000,
        })

        self.blocked_ips = getattr(settings, 'BLOCKED_IPS', [])
        self.allowed_countries = getattr(settings, 'ALLOWED_COUNTRIES_FOR_PAYMENTS', [])

        logger.info("PaymentSecurityMiddleware initialized")

    def __call__(self, request):
        # Ne pas appliquer le middleware aux URLs admin et statiques
        if self._should_skip_middleware(request):
            return self.get_response(request)

        # Vérifier si c'est une requête de paiement
        if self._is_payment_request(request):
            try:
                # 1. Vérifier l'adresse IP
                self._check_ip_address(request)

                # 2. Appliquer la limite de taux
                self._apply_rate_limiting(request)

                # 3. Détecter les comportements suspects
                self._detect_suspicious_behavior(request)

            except (RateLimitExceededError, FraudDetectionError) as e:
                logger.warning(f"Payment security violation: {str(e)} - IP: {self._get_client_ip(request)}")
                return self._security_error_response(request, e)
            except Exception as e:
                logger.error(f"Payment security middleware error: {str(e)}")
                # Ne pas bloquer en cas d'erreur interne

        return self.get_response(request)

    def _should_skip_middleware(self, request):
        """Déterminer si le middleware doit être ignoré"""
        skip_paths = [
            '/admin/',
            '/static/',
            '/media/',
            '/favicon.ico',
            '/health/',
            '/api/docs/',
        ]

        path = request.path
        return any(path.startswith(skip_path) for skip_path in skip_paths)

    def _is_payment_request(self, request):
        """Déterminer si c'est une requête de paiement"""
        payment_paths = [
            '/payments/',
            '/checkout/',
            '/api/payments/',
            '/webhooks/stripe/',
            '/webhooks/paypal/',
        ]

        path = request.path
        return any(path.startswith(payment_path) for payment_path in payment_paths)

    def _get_client_ip(self, request):
        """Obtenir l'adresse IP du client"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0]
        else:
            ip = request.META.get('REMOTE_ADDR')
        return ip

    def _check_ip_address(self, request):
        """Vérifier l'adresse IP du client"""
        client_ip = self._get_client_ip(request)

        # Vérifier les IPs bloquées
        for blocked_ip in self.blocked_ips:
            if ip_address(client_ip) in ip_network(blocked_ip):
                logger.warning(f"Blocked IP attempt: {client_ip}")
                raise FraudDetectionError(
                    message=_("Accès non autorisé."),
                    risk_level='HIGH'
                )

        # Vérifier le pays (si géolocalisation activée)
        if hasattr(settings, 'GEOIP_PATH') and self.allowed_countries:
            try:
                from django.contrib.gis.geoip2 import GeoIP2
                g = GeoIP2()
                country_code = g.country_code(client_ip)

                if country_code and country_code not in self.allowed_countries:
                    logger.warning(f"Payment attempt from restricted country: {country_code} - IP: {client_ip}")
                    raise FraudDetectionError(
                        message=_("Paiements non autorisés depuis votre pays."),
                        risk_level='MEDIUM'
                    )
            except Exception as e:
                logger.debug(f"GeoIP check failed: {str(e)}")
                # Ne pas bloquer en cas d'erreur de géolocalisation

    def _apply_rate_limiting(self, request):
        """Appliquer la limite de taux"""
        client_ip = self._get_client_ip(request)
        user_id = request.user.id if request.user.is_authenticated else None

        # Clés de cache pour la limite de taux
        minute_key = f"rate_limit:minute:{client_ip}:{user_id}"
        hour_key = f"rate_limit:hour:{client_ip}:{user_id}"
        day_key = f"rate_limit:day:{client_ip}:{user_id}"

        current_time = int(time.time())

        # Limite par minute
        minute_requests = cache.get(minute_key, [])
        minute_requests = [t for t in minute_requests if t > current_time - 60]

        if len(minute_requests) >= self.rate_limit['requests_per_minute']:
            raise RateLimitExceededError(
                message=_("Trop de requêtes. Veuillez réessayer dans une minute."),
                retry_after=60
            )

        minute_requests.append(current_time)
        cache.set(minute_key, minute_requests, 60)

        # Limite par heure
        hour_requests = cache.get(hour_key, [])
        hour_requests = [t for t in hour_requests if t > current_time - 3600]

        if len(hour_requests) >= self.rate_limit['requests_per_hour']:
            raise RateLimitExceededError(
                message=_("Trop de requêtes. Veuillez réessayer dans une heure."),
                retry_after=3600
            )

        hour_requests.append(current_time)
        cache.set(hour_key, hour_requests, 3600)

        # Limite par jour
        day_requests = cache.get(day_key, [])
        day_requests = [t for t in day_requests if t > current_time - 86400]

        if len(day_requests) >= self.rate_limit['requests_per_day']:
            raise RateLimitExceededError(
                message=_("Limite quotidienne dépassée. Réessayez demain."),
                retry_after=86400
            )

        day_requests.append(current_time)
        cache.set(day_key, day_requests, 86400)

    def _detect_suspicious_behavior(self, request):
        """Détecter les comportements suspects"""
        # 1. Vérifier les en-têtes User-Agent
        user_agent = request.META.get('HTTP_USER_AGENT', '')
        if not user_agent or len(user_agent) < 10:
            logger.warning(f"Suspicious request: Missing or short User-Agent - IP: {self._get_client_ip(request)}")
            raise FraudDetectionError(
                message=_("Requête suspecte détectée."),
                risk_level='LOW'
            )

        # 2. Vérifier les bots connus
        bot_keywords = ['bot', 'crawler', 'spider', 'scraper']
        if any(keyword in user_agent.lower() for keyword in bot_keywords):
            logger.warning(f"Bot detected: {user_agent} - IP: {self._get_client_ip(request)}")
            raise FraudDetectionError(
                message=_("Les bots ne sont pas autorisés."),
                risk_level='MEDIUM'
            )

        # 3. Vérifier les requêtes POST sans Referer (pour les formulaires)
        if request.method == 'POST' and not request.META.get('HTTP_REFERER'):
            if request.path.startswith('/payments/') or request.path.startswith('/checkout/'):
                logger.warning(f"Suspicious POST without Referer: {request.path} - IP: {self._get_client_ip(request)}")
                raise FraudDetectionError(
                    message=_("Requête suspecte détectée."),
                    risk_level='MEDIUM'
                )

        # 4. Vérifier les tailles de requêtes anormales
        content_length = request.META.get('CONTENT_LENGTH')
        if content_length and int(content_length) > 10 * 1024 * 1024:  # 10MB
            logger.warning(f"Oversized request: {content_length} bytes - IP: {self._get_client_ip(request)}")
            raise FraudDetectionError(
                message=_("Requête trop volumineuse."),
                risk_level='LOW'
            )

    def _security_error_response(self, request, exception):
        """Réponse d'erreur de sécurité"""
        if request.headers.get('X-Requested-With') == 'XMLHttpRequest' or request.path.startswith('/api/'):
            return JsonResponse({
                'error': True,
                'message': str(exception),
                'code': getattr(exception, '__class__.__name__', 'SECURITY_ERROR')
            }, status=429 if isinstance(exception, RateLimitExceededError) else 403)

        return HttpResponseForbidden(f"""
            <html>
                <head>
                    <title>Erreur de sécurité</title>
                    <style>
                        body {{ font-family: Arial, sans-serif; text-align: center; padding: 50px; }}
                        .error {{ color: #d32f2f; }}
                    </style>
                </head>
                <body>
                    <h1 class="error">Erreur de sécurité</h1>
                    <p>{str(exception)}</p>
                    <p>Veuillez contacter le support si vous pensez qu'il s'agit d'une erreur.</p>
                </body>
            </html>
        """)


class PaymentDataMiddleware(MiddlewareMixin):
    """
    Middleware pour sécuriser les données de paiement
    - Masquer les données sensibles dans les logs
    - Valider les tokens CSRF pour les paiements
    - Prévenir les fuites d'informations
    """

    def __init__(self, get_response):
        super().__init__(get_response)
        self.get_response = get_response

        # Données sensibles à masquer
        self.sensitive_fields = [
            'card_number', 'cvv', 'expiry_date',
            'password', 'token', 'secret_key',
            'iban', 'bic', 'account_number',
            'private_key', 'api_key'
        ]

        logger.info("PaymentDataMiddleware initialized")

    def process_request(self, request):
        """Traiter la requête entrante"""
        # Renforcer la validation CSRF pour les paiements
        if self._is_sensitive_payment_request(request):
            if not request.META.get('CSRF_COOKIE'):
                logger.warning(f"Missing CSRF token for payment request: {request.path}")
                # Ne pas bloquer, mais logger l'événement

        return None

    def process_response(self, request, response):
        """Traiter la réponse sortante"""
        # Masquer les données sensibles dans les logs
        if hasattr(response, 'data'):
            self._mask_sensitive_data(response.data)

        # Ajouter des en-têtes de sécurité
        response['X-Payment-Security'] = 'enabled'
        response['X-Content-Type-Options'] = 'nosniff'
        response['X-Frame-Options'] = 'DENY'
        response['X-XSS-Protection'] = '1; mode=block'

        # Pour les réponses JSON de paiement, ne pas mettre en cache
        if request.path.startswith('/payments/') or request.path.startswith('/api/payments/'):
            response['Cache-Control'] = 'no-store, no-cache, must-revalidate, max-age=0'
            response['Pragma'] = 'no-cache'
            response['Expires'] = '0'

        return response

    def _is_sensitive_payment_request(self, request):
        """Déterminer si c'est une requête de paiement sensible"""
        sensitive_paths = [
            '/payments/process/',
            '/payments/webhook/',
            '/checkout/confirm/',
            '/api/payments/charge/',
        ]

        return any(request.path.startswith(path) for path in sensitive_paths)

    def _mask_sensitive_data(self, data):
        """Masquer les données sensibles"""
        if isinstance(data, dict):
            for key, value in data.items():
                if isinstance(key, str) and any(sensitive in key.lower() for sensitive in self.sensitive_fields):
                    data[key] = '***MASKED***'
                elif isinstance(value, (dict, list)):
                    self._mask_sensitive_data(value)
        elif isinstance(data, list):
            for item in data:
                self._mask_sensitive_data(item)

    def process_exception(self, request, exception):
        """Traiter les exceptions"""
        # Ne pas logger les données sensibles dans les exceptions
        logger.error(f"Payment exception: {type(exception).__name__} - Path: {request.path}")
        return None


class PaymentSessionMiddleware(MiddlewareMixin):
    """
    Middleware pour la gestion des sessions de paiement
    - Session dédiée pour les paiements
    - Timeout de session
    - Validation de session
    """

    def __init__(self, get_response):
        super().__init__(get_response)
        self.get_response = get_response

        self.session_timeout = getattr(settings, 'PAYMENT_SESSION_TIMEOUT', 1800)  # 30 minutes
        self.payment_session_key = 'payment_session_data'

        logger.info("PaymentSessionMiddleware initialized")

    def process_request(self, request):
        """Traiter la requête entrante"""
        if self._is_payment_flow(request):
            # Initialiser ou vérifier la session de paiement
            self._initialize_payment_session(request)

            # Vérifier le timeout de session
            if self._is_session_expired(request):
                logger.info(f"Payment session expired for user: {request.user.id if request.user.is_authenticated else 'anonymous'}")
                # Nettoyer la session expirée
                if self.payment_session_key in request.session:
                    del request.session[self.payment_session_key]

        return None

    def process_response(self, request, response):
        """Traiter la réponse sortante"""
        if self._is_payment_flow(request):
            # Mettre à jour le timestamp de la session
            if hasattr(request, 'payment_session'):
                request.session[f'{self.payment_session_key}_timestamp'] = time.time()
                request.session.modified = True

        return response

    def _is_payment_flow(self, request):
        """Déterminer si c'est un flux de paiement"""
        payment_paths = [
            '/checkout/',
            '/payments/checkout/',
            '/payments/confirm/',
            '/payments/process/',
        ]

        return any(request.path.startswith(path) for path in payment_paths)

    def _initialize_payment_session(self, request):
        """Initialiser la session de paiement"""
        if self.payment_session_key not in request.session:
            request.session[self.payment_session_key] = {
                'started_at': time.time(),
                'step': 'initialized',
                'data': {},
                'attempts': 0,
            }
            request.session[f'{self.payment_session_key}_timestamp'] = time.time()
            request.session.modified = True

        # Stocker dans l'objet request pour un accès facile
        request.payment_session = request.session[self.payment_session_key]

    def _is_session_expired(self, request):
        """Vérifier si la session a expiré"""
        if f'{self.payment_session_key}_timestamp' not in request.session:
            return True

        last_activity = request.session[f'{self.payment_session_key}_timestamp']
        return (time.time() - last_activity) > self.session_timeout

    def get_payment_session_data(self, request, key=None, default=None):
        """Obtenir les données de session de paiement"""
        if not hasattr(request, 'payment_session'):
            return default

        if key:
            return request.payment_session.get('data', {}).get(key, default)

        return request.payment_session.get('data', {})

    def set_payment_session_data(self, request, key, value):
        """Définir les données de session de paiement"""
        if not hasattr(request, 'payment_session'):
            self._initialize_payment_session(request)

        if 'data' not in request.payment_session:
            request.payment_session['data'] = {}

        request.payment_session['data'][key] = value
        request.session.modified = True

    def increment_payment_attempts(self, request):
        """Incrémenter le compteur de tentatives"""
        if not hasattr(request, 'payment_session'):
            self._initialize_payment_session(request)

        request.payment_session['attempts'] = request.payment_session.get('attempts', 0) + 1
        request.session.modified = True

        return request.payment_session['attempts']

    def clear_payment_session(self, request):
        """Effacer la session de paiement"""
        if self.payment_session_key in request.session:
            del request.session[self.payment_session_key]

        if f'{self.payment_session_key}_timestamp' in request.session:
            del request.session[f'{self.payment_session_key}_timestamp']

        if hasattr(request, 'payment_session'):
            delattr(request, 'payment_session')

        request.session.modified = True


class FraudDetectionMiddleware(MiddlewareMixin):
    """
    Middleware de détection de fraude avancée
    - Analyse comportementale
    - Score de risque
    - Blocage automatique
    """

    def __init__(self, get_response):
        super().__init__(get_response)
        self.get_response = get_response

        # Configuration de détection de fraude
        self.risk_threshold = getattr(settings, 'FRAUD_RISK_THRESHOLD', 70)
        self.suspicious_patterns = [
            # Adresses email suspectes
            r'[\w\.-]+@[\w\.-]+\.(xyz|top|club|win|bid)',
            # IPs de VPN/Tor
            r'^(?:tor|vpn|proxy)',
            # User-Agents malformés
            r'^$|^(?:Mozilla|curl|Python|Java)/?',
        ]

        logger.info("FraudDetectionMiddleware initialized")

    def process_request(self, request):
        """Analyser la requête pour détecter la fraude"""
        if not self._is_payment_request(request):
            return None

        # Calculer le score de risque
        risk_score = self._calculate_risk_score(request)

        if risk_score >= self.risk_threshold:
            logger.warning(f"High risk payment detected: Score={risk_score}, IP={self._get_client_ip(request)}, Path={request.path}")

            # Bloquer immédiatement les scores très élevés
            if risk_score >= 90:
                raise FraudDetectionError(
                    message=_("Transaction bloquée pour des raisons de sécurité."),
                    risk_level='CRITICAL'
                )

            # Marquer pour examen manuel
            request.high_risk_payment = True
            request.risk_score = risk_score

        return None

    def _is_payment_request(self, request):
        """Vérifier si c'est une requête de paiement"""
        return request.path.startswith('/payments/') or request.path.startswith('/checkout/')

    def _get_client_ip(self, request):
        """Obtenir l'adresse IP du client"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        return x_forwarded_for.split(',')[0] if x_forwarded_for else request.META.get('REMOTE_ADDR')

    def _calculate_risk_score(self, request):
        """Calculer le score de risque"""
        score = 0

        # 1. Vérifier l'adresse IP (30 points max)
        ip_score = self._calculate_ip_risk(request)
        score += ip_score

        # 2. Vérifier l'email (20 points max)
        email_score = self._calculate_email_risk(request)
        score += email_score

        # 3. Vérifier le comportement (30 points max)
        behavior_score = self._calculate_behavior_risk(request)
        score += behavior_score

        # 4. Vérifier les données de paiement (20 points max)
        payment_score = self._calculate_payment_data_risk(request)
        score += payment_score

        return min(score, 100)

    def _calculate_ip_risk(self, request):
        """Calculer le risque basé sur l'IP"""
        score = 0
        client_ip = self._get_client_ip(request)

        # Vérifier les IPs à haut risque
        high_risk_ips = getattr(settings, 'HIGH_RISK_IPS', [])
        for risky_ip in high_risk_ips:
            if ip_address(client_ip) in ip_network(risky_ip):
                score += 30
                break

        # Vérifier la géolocalisation
        try:
            from django.contrib.gis.geoip2 import GeoIP2
            g = GeoIP2()
            country = g.country_code(client_ip)

            high_risk_countries = getattr(settings, 'HIGH_RISK_COUNTRIES', [])
            if country in high_risk_countries:
                score += 20
        except Exception:
            pass

        # Vérifier si c'est une IP partagée (VPN/Proxy)
        if self._is_shared_ip(client_ip):
            score += 15

        return score

    def _calculate_email_risk(self, request):
        """Calculer le risque basé sur l'email"""
        score = 0

        # Récupérer l'email de la requête
        email = None
        if request.method == 'POST':
            if 'email' in request.POST:
                email = request.POST['email']
            elif hasattr(request, 'data') and 'email' in request.data:
                email = request.data['email']

        if email:
            # Vérifier les domaines à risque
            import re
            for pattern in self.suspicious_patterns:
                if re.search(pattern, email, re.IGNORECASE):
                    score += 20
                    break

            # Vérifier l'âge du compte (si utilisateur authentifié)
            if request.user.is_authenticated:
                account_age = (timezone.now() - request.user.date_joined).days
                if account_age < 1:  # Compte créé aujourd'hui
                    score += 10

        return score

    def _calculate_behavior_risk(self, request):
        """Calculer le risque basé sur le comportement"""
        score = 0

        # Vitesse de remplissage du formulaire
        if request.method == 'POST' and hasattr(request, 'payment_session'):
            session_data = request.payment_session
            if 'form_start_time' in session_data:
                form_time = time.time() - session_data['form_start_time']
                if form_time < 2:  # Formulaire rempli en moins de 2 secondes
                    score += 15

        # Heure de la transaction
        current_hour = timezone.now().hour
        if current_hour < 6 or current_hour > 22:  # Transactions nocturnes
            score += 10

        # Tentatives échouées récentes
        if hasattr(request, 'payment_session'):
            attempts = request.payment_session.get('attempts', 0)
            if attempts > 3:
                score += attempts * 5

        return score

    def _calculate_payment_data_risk(self, request):
        """Calculer le risque basé sur les données de paiement"""
        score = 0

        if request.method == 'POST':
            # Montant inhabituel
            amount = None
            if 'amount' in request.POST:
                try:
                    amount = float(request.POST['amount'])
                except ValueError:
                    pass

            if amount:
                # Montant très élevé
                if amount > 10000:
                    score += 15
                # Montant très faible (test)
                elif amount < 1:
                    score += 10

            # Données de carte BIN suspectes
            if 'card_number' in request.POST:
                card_number = request.POST['card_number'].replace(' ', '')
                if len(card_number) >= 6:
                    bin_number = card_number[:6]
                    suspicious_bins = getattr(settings, 'SUSPICIOUS_CARD_BINS', [])
                    if bin_number in suspicious_bins:
                        score += 20

        return score

    def _is_shared_ip(self, ip):
        """Vérifier si c'est une IP partagée (VPN/Proxy)"""
        # Liste simplifiée de plages IP connues pour les VPN/Proxy
        shared_ip_ranges = [
            '10.0.0.0/8',
            '172.16.0.0/12',
            '192.168.0.0/16',
            '100.64.0.0/10',  # CGNAT
        ]

        try:
            ip_addr = ip_address(ip)
            for ip_range in shared_ip_ranges:
                if ip_addr in ip_network(ip_range):
                    return True
        except ValueError:
            pass

        return False


class CORSMiddleware(MiddlewareMixin):
    """
    Middleware CORS spécifique aux paiements
    """

    def process_response(self, request, response):
        """Ajouter les en-têtes CORS pour les paiements"""
        # Appliquer seulement aux APIs de paiement
        if request.path.startswith('/api/payments/'):
            origin = request.META.get('HTTP_ORIGIN', '')

            # Vérifier les origines autorisées
            allowed_origins = getattr(settings, 'CORS_ALLOWED_ORIGINS', [])
            if origin in allowed_origins or '*' in allowed_origins:
                response['Access-Control-Allow-Origin'] = origin
                response['Access-Control-Allow-Credentials'] = 'true'
                response['Access-Control-Allow-Methods'] = 'GET, POST, PUT, DELETE, OPTIONS'
                response['Access-Control-Allow-Headers'] = 'Content-Type, Authorization, X-Requested-With'
                response['Access-Control-Max-Age'] = '86400'  # 24 heures

        return response


========== payments/backends.py ==========
# ~/ebi3/payments/backends.py
"""
Backends de paiement pour différentes passerelles
"""

import logging
from abc import ABC, abstractmethod
from django.conf import settings
from django.utils.translation import gettext_lazy as _
from .exceptions import (
    StripeError, PayPalError, PaymentGatewayError,
    CardDeclinedError, InsufficientFundsError
)

logger = logging.getLogger(__name__)


class PaymentBackend(ABC):
    """Interface de base pour les backends de paiement"""

    def __init__(self, **kwargs):
        self.config = kwargs

    @abstractmethod
    def create_payment_intent(self, amount, currency, **kwargs):
        """Créer une intention de paiement"""
        pass

    @abstractmethod
    def confirm_payment(self, payment_intent_id, **kwargs):
        """Confirmer un paiement"""
        pass

    @abstractmethod
    def refund_payment(self, payment_intent_id, amount=None, **kwargs):
        """Rembourser un paiement"""
        pass

    @abstractmethod
    def get_payment_status(self, payment_intent_id):
        """Obtenir le statut d'un paiement"""
        pass

    @abstractmethod
    def create_customer(self, user_data, **kwargs):
        """Créer un client"""
        pass

    @abstractmethod
    def setup_subscription(self, customer_id, plan_data, **kwargs):
        """Configurer un abonnement"""
        pass

    def validate_amount(self, amount):
        """Valider le montant"""
        if amount <= 0:
            raise ValueError(_("Le montant doit être positif"))
        return amount

    def validate_currency(self, currency):
        """Valider la devise"""
        supported_currencies = getattr(self, 'supported_currencies', ['EUR', 'USD'])
        if currency not in supported_currencies:
            raise ValueError(_(f"Devise non supportée: {currency}"))
        return currency


class StripeBackend(PaymentBackend):
    """Backend Stripe"""

    supported_currencies = ['EUR', 'USD', 'GBP', 'CAD', 'AUD', 'JPY']

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        import stripe

        # Configuration Stripe
        api_key = kwargs.get('api_key', settings.STRIPE_SECRET_KEY)
        stripe.api_key = api_key

        self.stripe = stripe
        self.webhook_secret = kwargs.get('webhook_secret', settings.STRIPE_WEBHOOK_SECRET)

        logger.info("Stripe backend initialized")

    def create_payment_intent(self, amount, currency, **kwargs):
        """Créer une intention de paiement Stripe"""
        try:
            # Convertir le montant en centimes pour Stripe
            amount_in_cents = int(amount * 100)

            intent_data = {
                'amount': amount_in_cents,
                'currency': currency.lower(),
                'automatic_payment_methods': {
                    'enabled': True,
                },
                'metadata': kwargs.get('metadata', {}),
            }

            # Ajouter le client si fourni
            if 'customer_id' in kwargs:
                intent_data['customer'] = kwargs['customer_id']

            # Ajouter la description
            if 'description' in kwargs:
                intent_data['description'] = kwargs['description']

            # Créer l'intention de paiement
            intent = self.stripe.PaymentIntent.create(**intent_data)

            logger.info(f"Stripe payment intent created: {intent.id}")

            return {
                'payment_intent_id': intent.id,
                'client_secret': intent.client_secret,
                'status': intent.status,
                'amount': intent.amount / 100,
                'currency': intent.currency.upper(),
                'next_action': intent.get('next_action'),
            }

        except self.stripe.error.CardError as e:
            logger.error(f"Stripe card error: {e.user_message}")
            raise CardDeclinedError(
                message=e.user_message,
                decline_code=e.code,
                stripe_error=e
            )
        except self.stripe.error.RateLimitError as e:
            logger.error(f"Stripe rate limit error: {str(e)}")
            raise PaymentGatewayError(
                message=_("Trop de requêtes. Veuillez réessayer plus tard."),
                gateway='stripe'
            )
        except self.stripe.error.InvalidRequestError as e:
            logger.error(f"Stripe invalid request: {str(e)}")
            raise PaymentGatewayError(
                message=_("Requête invalide."),
                gateway='stripe'
            )
        except self.stripe.error.AuthenticationError as e:
            logger.error(f"Stripe authentication error: {str(e)}")
            raise PaymentGatewayError(
                message=_("Erreur d'authentification Stripe."),
                gateway='stripe'
            )
        except self.stripe.error.StripeError as e:
            logger.error(f"Stripe error: {str(e)}")
            raise StripeError(stripe_error=e)
        except Exception as e:
            logger.error(f"Unexpected error creating Stripe payment intent: {str(e)}")
            raise PaymentGatewayError(
                message=_("Erreur inattendue lors de la création du paiement."),
                gateway='stripe'
            )

    def confirm_payment(self, payment_intent_id, **kwargs):
        """Confirmer un paiement Stripe"""
        try:
            intent = self.stripe.PaymentIntent.confirm(
                payment_intent_id,
                **kwargs
            )

            logger.info(f"Stripe payment confirmed: {intent.id}")

            return {
                'payment_intent_id': intent.id,
                'status': intent.status,
                'amount_received': intent.amount_received / 100 if intent.amount_received else 0,
                'currency': intent.currency.upper(),
                'charges': [
                    {
                        'id': charge.id,
                        'amount': charge.amount / 100,
                        'status': charge.status,
                        'payment_method': charge.payment_method_details.type if charge.payment_method_details else None
                    }
                    for charge in intent.charges.data
                ] if intent.charges else []
            }

        except self.stripe.error.StripeError as e:
            logger.error(f"Stripe error confirming payment: {str(e)}")
            raise StripeError(stripe_error=e)

    def refund_payment(self, payment_intent_id, amount=None, **kwargs):
        """Rembourser un paiement Stripe"""
        try:
            # Récupérer le paiement
            intent = self.stripe.PaymentIntent.retrieve(payment_intent_id)

            # Créer le remboursement
            refund_data = {
                'payment_intent': payment_intent_id,
                'metadata': kwargs.get('metadata', {}),
            }

            if amount:
                # Convertir en centimes
                refund_data['amount'] = int(amount * 100)

            if 'reason' in kwargs:
                refund_data['reason'] = kwargs['reason']

            refund = self.stripe.Refund.create(**refund_data)

            logger.info(f"Stripe refund created: {refund.id}")

            return {
                'refund_id': refund.id,
                'amount': refund.amount / 100,
                'currency': refund.currency.upper(),
                'status': refund.status,
                'reason': refund.reason,
            }

        except self.stripe.error.StripeError as e:
            logger.error(f"Stripe error creating refund: {str(e)}")
            raise StripeError(stripe_error=e)

    def get_payment_status(self, payment_intent_id):
        """Obtenir le statut d'un paiement Stripe"""
        try:
            intent = self.stripe.PaymentIntent.retrieve(payment_intent_id)

            return {
                'payment_intent_id': intent.id,
                'status': intent.status,
                'amount': intent.amount / 100,
                'currency': intent.currency.upper(),
                'charges': [
                    {
                        'id': charge.id,
                        'status': charge.status,
                        'paid': charge.paid,
                        'refunded': charge.refunded,
                        'amount_refunded': charge.amount_refunded / 100,
                    }
                    for charge in intent.charges.data
                ] if intent.charges else []
            }

        except self.stripe.error.StripeError as e:
            logger.error(f"Stripe error retrieving payment: {str(e)}")
            raise StripeError(stripe_error=e)

    def create_customer(self, user_data, **kwargs):
        """Créer un client Stripe"""
        try:
            customer_data = {
                'email': user_data.get('email'),
                'name': user_data.get('name'),
                'metadata': {
                    'user_id': str(user_data.get('id')),
                    'username': user_data.get('username'),
                }
            }

            if 'phone' in user_data:
                customer_data['phone'] = user_data['phone']

            if 'address' in user_data:
                customer_data['address'] = user_data['address']

            customer = self.stripe.Customer.create(**customer_data)

            logger.info(f"Stripe customer created: {customer.id}")

            return {
                'customer_id': customer.id,
                'email': customer.email,
                'name': customer.name,
            }

        except self.stripe.error.StripeError as e:
            logger.error(f"Stripe error creating customer: {str(e)}")
            raise StripeError(stripe_error=e)

    def setup_subscription(self, customer_id, plan_data, **kwargs):
        """Configurer un abonnement Stripe"""
        try:
            # Créer le produit et le prix si nécessaire
            product = self.stripe.Product.create(
                name=plan_data['name'],
                description=plan_data.get('description', ''),
            )

            price = self.stripe.Price.create(
                product=product.id,
                unit_amount=int(plan_data['price'] * 100),
                currency=plan_data.get('currency', 'eur').lower(),
                recurring={
                    'interval': plan_data.get('interval', 'month'),
                    'interval_count': plan_data.get('interval_count', 1),
                },
            )

            # Créer l'abonnement
            subscription_data = {
                'customer': customer_id,
                'items': [{'price': price.id}],
                'payment_behavior': 'default_incomplete',
                'expand': ['latest_invoice.payment_intent'],
            }

            if 'trial_period_days' in kwargs:
                subscription_data['trial_period_days'] = kwargs['trial_period_days']

            subscription = self.stripe.Subscription.create(**subscription_data)

            logger.info(f"Stripe subscription created: {subscription.id}")

            return {
                'subscription_id': subscription.id,
                'status': subscription.status,
                'current_period_start': subscription.current_period_start,
                'current_period_end': subscription.current_period_end,
                'latest_invoice': {
                    'id': subscription.latest_invoice.id,
                    'payment_intent': {
                        'id': subscription.latest_invoice.payment_intent.id,
                        'client_secret': subscription.latest_invoice.payment_intent.client_secret,
                    } if subscription.latest_invoice.payment_intent else None,
                } if subscription.latest_invoice else None,
            }

        except self.stripe.error.StripeError as e:
            logger.error(f"Stripe error setting up subscription: {str(e)}")
            raise StripeError(stripe_error=e)

    def verify_webhook(self, payload, signature):
        """Vérifier la signature d'un webhook Stripe"""
        try:
            event = self.stripe.Webhook.construct_event(
                payload, signature, self.webhook_secret
            )
            return event
        except self.stripe.error.SignatureVerificationError as e:
            logger.error(f"Stripe webhook signature verification failed: {str(e)}")
            raise
        except Exception as e:
            logger.error(f"Error verifying Stripe webhook: {str(e)}")
            raise

    def create_checkout_session(self, success_url, cancel_url, **kwargs):
        """Créer une session de checkout Stripe"""
        try:
            session_data = {
                'success_url': success_url,
                'cancel_url': cancel_url,
                'mode': kwargs.get('mode', 'payment'),
                'payment_method_types': kwargs.get('payment_method_types', ['card']),
                'client_reference_id': kwargs.get('client_reference_id'),
                'metadata': kwargs.get('metadata', {}),
            }

            if kwargs.get('mode') == 'payment':
                session_data['line_items'] = [{
                    'price_data': {
                        'currency': kwargs.get('currency', 'eur').lower(),
                        'product_data': {
                            'name': kwargs.get('name', 'Purchase'),
                            'description': kwargs.get('description', ''),
                        },
                        'unit_amount': int(kwargs['amount'] * 100),
                    },
                    'quantity': kwargs.get('quantity', 1),
                }]

            elif kwargs.get('mode') == 'subscription':
                session_data['line_items'] = [{
                    'price': kwargs['price_id'],
                    'quantity': kwargs.get('quantity', 1),
                }]

            if 'customer_id' in kwargs:
                session_data['customer'] = kwargs['customer_id']
            elif 'customer_email' in kwargs:
                session_data['customer_email'] = kwargs['customer_email']

            session = self.stripe.checkout.Session.create(**session_data)

            logger.info(f"Stripe checkout session created: {session.id}")

            return {
                'session_id': session.id,
                'url': session.url,
                'payment_intent': session.payment_intent if hasattr(session, 'payment_intent') else None,
                'subscription': session.subscription if hasattr(session, 'subscription') else None,
            }

        except self.stripe.error.StripeError as e:
            logger.error(f"Stripe error creating checkout session: {str(e)}")
            raise StripeError(stripe_error=e)


class PayPalBackend(PaymentBackend):
    """Backend PayPal"""

    supported_currencies = ['EUR', 'USD', 'GBP', 'CAD', 'AUD']

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        from paypalcheckoutsdk.core import PayPalHttpClient, SandboxEnvironment, LiveEnvironment

        # Configuration PayPal
        client_id = kwargs.get('client_id', settings.PAYPAL_CLIENT_ID)
        client_secret = kwargs.get('client_secret', settings.PAYPAL_CLIENT_SECRET)
        environment = kwargs.get('environment', settings.PAYPAL_ENVIRONMENT)

        if environment == 'sandbox':
            paypal_environment = SandboxEnvironment(
                client_id=client_id,
                client_secret=client_secret
            )
        else:
            paypal_environment = LiveEnvironment(
                client_id=client_id,
                client_secret=client_secret
            )

        self.client = PayPalHttpClient(paypal_environment)
        self.environment = environment

        logger.info(f"PayPal backend initialized ({environment})")

    def create_payment_intent(self, amount, currency, **kwargs):
        """Créer une intention de paiement PayPal"""
        try:
            from paypalcheckoutsdk.orders import OrdersCreateRequest

            request = OrdersCreateRequest()
            request.prefer('return=representation')

            request.request_body({
                "intent": "CAPTURE",
                "purchase_units": [
                    {
                        "amount": {
                            "currency_code": currency.upper(),
                            "value": str(amount)
                        },
                        "description": kwargs.get('description', ''),
                        "custom_id": kwargs.get('custom_id'),
                    }
                ],
                "application_context": {
                    "return_url": kwargs.get('return_url'),
                    "cancel_url": kwargs.get('cancel_url'),
                    "brand_name": kwargs.get('brand_name', settings.SITE_NAME),
                    "user_action": "PAY_NOW",
                }
            })

            response = self.client.execute(request)
            order = response.result

            logger.info(f"PayPal order created: {order.id}")

            return {
                'order_id': order.id,
                'status': order.status,
                'amount': amount,
                'currency': currency,
                'approval_url': next(
                    link.href for link in order.links if link.rel == 'approve'
                ),
            }

        except Exception as e:
            logger.error(f"PayPal error creating order: {str(e)}")
            raise PayPalError(paypal_error=e)

    def confirm_payment(self, order_id, **kwargs):
        """Confirmer un paiement PayPal"""
        try:
            from paypalcheckoutsdk.orders import OrdersCaptureRequest

            request = OrdersCaptureRequest(order_id)
            response = self.client.execute(request)
            capture = response.result

            logger.info(f"PayPal order captured: {capture.id}")

            return {
                'order_id': capture.id,
                'status': capture.status,
                'amount': float(capture.purchase_units[0].payments.captures[0].amount.value),
                'currency': capture.purchase_units[0].payments.captures[0].amount.currency_code,
            }

        except Exception as e:
            logger.error(f"PayPal error capturing order: {str(e)}")
            raise PayPalError(paypal_error=e)

    def refund_payment(self, capture_id, amount=None, **kwargs):
        """Rembourser un paiement PayPal"""
        try:
            from paypalcheckoutsdk.payments import CapturesRefundRequest

            request = CapturesRefundRequest(capture_id)
            request.prefer('return=representation')

            refund_data = {}
            if amount:
                refund_data['amount'] = {
                    'value': str(amount),
                    'currency_code': kwargs.get('currency', 'EUR')
                }

            if 'note' in kwargs:
                refund_data['note_to_payer'] = kwargs['note']

            request.request_body(refund_data)

            response = self.client.execute(request)
            refund = response.result

            logger.info(f"PayPal refund created: {refund.id}")

            return {
                'refund_id': refund.id,
                'amount': float(refund.amount.value),
                'currency': refund.amount.currency_code,
                'status': refund.status,
            }

        except Exception as e:
            logger.error(f"PayPal error creating refund: {str(e)}")
            raise PayPalError(paypal_error=e)

    def get_payment_status(self, order_id):
        """Obtenir le statut d'un paiement PayPal"""
        try:
            from paypalcheckoutsdk.orders import OrdersGetRequest

            request = OrdersGetRequest(order_id)
            response = self.client.execute(request)
            order = response.result

            return {
                'order_id': order.id,
                'status': order.status,
                'amount': float(order.purchase_units[0].amount.value),
                'currency': order.purchase_units[0].amount.currency_code,
            }

        except Exception as e:
            logger.error(f"PayPal error getting order: {str(e)}")
            raise PayPalError(paypal_error=e)

    def create_customer(self, user_data, **kwargs):
        """Créer un client PayPal (pour les abonnements)"""
        # PayPal n'a pas de concept de client comme Stripe
        # On retourne un identifiant basé sur l'email
        return {
            'customer_id': f"paypal_{user_data.get('email')}",
            'email': user_data.get('email'),
            'name': user_data.get('name'),
        }

    def setup_subscription(self, customer_id, plan_data, **kwargs):
        """Configurer un abonnement PayPal"""
        try:
            from paypalcheckoutsdk.subscriptions import SubscriptionsCreateRequest

            request = SubscriptionsCreateRequest()
            request.prefer('return=representation')

            subscription_data = {
                "plan_id": plan_data['plan_id'],
                "start_time": kwargs.get('start_time'),
                "quantity": kwargs.get('quantity', '1'),
                "shipping_amount": {
                    "currency_code": plan_data.get('currency', 'EUR'),
                    "value": "0"
                },
                "subscriber": {
                    "name": {
                        "given_name": kwargs.get('first_name'),
                        "surname": kwargs.get('last_name')
                    },
                    "email_address": kwargs.get('email'),
                    "shipping_address": kwargs.get('shipping_address', {})
                },
                "application_context": {
                    "brand_name": kwargs.get('brand_name', settings.SITE_NAME),
                    "locale": kwargs.get('locale', 'fr-FR'),
                    "shipping_preference": "SET_PROVIDED_ADDRESS",
                    "user_action": "SUBSCRIBE_NOW",
                    "payment_method": {
                        "payer_selected": "PAYPAL",
                        "payee_preferred": "IMMEDIATE_PAYMENT_REQUIRED"
                    },
                    "return_url": kwargs.get('return_url'),
                    "cancel_url": kwargs.get('cancel_url')
                }
            }

            request.request_body(subscription_data)
            response = self.client.execute(request)
            subscription = response.result

            logger.info(f"PayPal subscription created: {subscription.id}")

            return {
                'subscription_id': subscription.id,
                'status': subscription.status,
                'approval_url': next(
                    link.href for link in subscription.links if link.rel == 'approve'
                ),
            }

        except Exception as e:
            logger.error(f"PayPal error setting up subscription: {str(e)}")
            raise PayPalError(paypal_error=e)

    def verify_webhook(self, payload, signature, transmission_id):
        """Vérifier un webhook PayPal"""
        try:
            from paypalcheckoutsdk.core import PayPalWebhookEvent

            # Vérification de la signature PayPal
            # Cette logique dépend de la configuration PayPal
            event = PayPalWebhookEvent(payload, transmission_id, signature)

            return event
        except Exception as e:
            logger.error(f"PayPal webhook verification failed: {str(e)}")
            raise


class BankTransferBackend(PaymentBackend):
    """Backend pour virements bancaires"""

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.bank_details = kwargs.get('bank_details', {
            'bank_name': settings.BANK_NAME,
            'account_holder': settings.BANK_ACCOUNT_HOLDER,
            'iban': settings.BANK_IBAN,
            'bic': settings.BANK_BIC,
        })

        logger.info("Bank transfer backend initialized")

    def create_payment_intent(self, amount, currency, **kwargs):
        """Créer une intention de paiement pour virement"""
        reference = kwargs.get('reference', f"PAY-{kwargs.get('user_id', '000000')}")

        return {
            'payment_intent_id': reference,
            'status': 'PENDING',
            'amount': amount,
            'currency': currency,
            'bank_details': self.bank_details,
            'reference': reference,
            'instructions': _(
                "Veuillez effectuer un virement bancaire avec la référence ci-dessus. "
                "Votre paiement sera confirmé manuellement après réception des fonds."
            ),
        }

    def confirm_payment(self, payment_intent_id, **kwargs):
        """Confirmer un virement (manuellement)"""
        return {
            'payment_intent_id': payment_intent_id,
            'status': 'MANUAL_CONFIRMATION_REQUIRED',
            'message': _("Le virement doit être confirmé manuellement par un administrateur."),
        }

    def refund_payment(self, payment_intent_id, amount=None, **kwargs):
        """Rembourser un virement"""
        return {
            'refund_id': f"REFUND-{payment_intent_id}",
            'status': 'MANUAL_PROCESSING_REQUIRED',
            'message': _("Le remboursement nécessite un traitement manuel."),
        }

    def get_payment_status(self, payment_intent_id):
        """Obtenir le statut d'un virement"""
        return {
            'payment_intent_id': payment_intent_id,
            'status': 'PENDING',
            'message': _("En attente de virement bancaire."),
        }

    def create_customer(self, user_data, **kwargs):
        """Créer un client pour virement"""
        return {
            'customer_id': f"BANK_{user_data.get('id', '000000')}",
            'name': user_data.get('name'),
            'email': user_data.get('email'),
        }

    def setup_subscription(self, customer_id, plan_data, **kwargs):
        """Les virements ne supportent pas les abonnements"""
        raise PaymentGatewayError(
            message=_("Les abonnements ne sont pas supportés pour les virements bancaires."),
            gateway='bank_transfer'
        )


class PaymentBackendFactory:
    """Factory pour créer les backends de paiement"""

    @staticmethod
    def get_backend(backend_name, **kwargs):
        """
        Récupérer un backend de paiement par nom

        Args:
            backend_name: Nom du backend ('stripe', 'paypal', 'bank_transfer')
            **kwargs: Arguments de configuration

        Returns:
            PaymentBackend instance
        """
        backends = {
            'stripe': StripeBackend,
            'paypal': PayPalBackend,
            'bank_transfer': BankTransferBackend,
        }

        backend_class = backends.get(backend_name.lower())

        if not backend_class:
            raise ValueError(_(f"Backend de paiement inconnu: {backend_name}"))

        return backend_class(**kwargs)

    @staticmethod
    def get_available_backends():
        """Obtenir la liste des backends disponibles"""
        return [
            {
                'name': 'stripe',
                'display_name': 'Stripe',
                'currencies': StripeBackend.supported_currencies,
                'supports_subscriptions': True,
                'supports_refunds': True,
            },
            {
                'name': 'paypal',
                'display_name': 'PayPal',
                'currencies': PayPalBackend.supported_currencies,
                'supports_subscriptions': True,
                'supports_refunds': True,
            },
            {
                'name': 'bank_transfer',
                'display_name': 'Virement Bancaire',
                'currencies': ['EUR', 'USD', 'GBP'],
                'supports_subscriptions': False,
                'supports_refunds': True,
            },
        ]

    @staticmethod
    def get_default_backend():
        """Obtenir le backend par défaut"""
        default_backend = getattr(settings, 'DEFAULT_PAYMENT_BACKEND', 'stripe')
        return PaymentBackendFactory.get_backend(default_backend)


========== payments/templates/payments/css/payments.css ==========
/* ~/ebi3/payments/static/payments/css/payments.css */

/* Variables */
:root {
    --payment-primary: #667eea;
    --payment-success: #28a745;
    --payment-danger: #dc3545;
    --payment-warning: #ffc107;
    --payment-info: #17a2b8;
    --payment-light: #f8f9fa;
    --payment-dark: #343a40;
    --payment-border: #dee2e6;
    --payment-shadow: rgba(0, 0, 0, 0.1);
}

/* Général */
.payment-page {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    padding: 20px 0;
}

/* Cartes */
.payment-card {
    transition: all 0.3s ease;
    border: none;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 20px;
}

.payment-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px var(--payment-shadow);
}

/* En-têtes */
.payment-header {
    background: linear-gradient(135deg, var(--payment-primary) 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 15px 15px 0 0 !important;
}

/* Badges de statut */
.payment-status {
    display: inline-block;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-pending {
    background-color: var(--payment-warning);
    color: #000;
}

.status-completed {
    background-color: var(--payment-success);
    color: white;
}

.status-failed {
    background-color: var(--payment-danger);
    color: white;
}

.status-refunded {
    background-color: var(--payment-info);
    color: white;
}

.status-processing {
    background-color: #6f42c1;
    color: white;
}

/* Icônes de méthode de paiement */
.payment-method-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    background: white;
    box-shadow: 0 4px 6px var(--payment-shadow);
    margin: 0 auto 15px;
    color: var(--payment-primary);
    font-size: 1.8rem;
}

/* Montants */
.amount-large {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--payment-success);
    line-height: 1;
}

.amount-small {
    font-size: 1.2rem;
    color: var(--payment-dark);
}

.currency {
    font-size: 1.5rem;
    color: var(--payment-dark);
    opacity: 0.7;
}

/* Timeline de paiement */
.payment-timeline {
    position: relative;
    padding-left: 30px;
}

.payment-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--payment-border);
    z-index: 1;
}

.timeline-item {
    position: relative;
    margin-bottom: 25px;
    z-index: 2;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -23px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--payment-primary);
    border: 3px solid white;
    box-shadow: 0 0 0 3px var(--payment-border);
    z-index: 3;
}

.timeline-item.completed::before {
    background: var(--payment-success);
}

.timeline-item.failed::before {
    background: var(--payment-danger);
}

.timeline-item.pending::before {
    background: var(--payment-warning);
}

/* Formulaires */
.payment-form .form-control {
    border-radius: 8px;
    border: 1px solid var(--payment-border);
    padding: 12px 15px;
    transition: all 0.3s ease;
}

.payment-form .form-control:focus {
    border-color: var(--payment-primary);
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

.payment-form label {
    font-weight: 600;
    color: var(--payment-dark);
    margin-bottom: 8px;
}

/* Boutons */
.payment-btn {
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    border: none;
}

.payment-btn-primary {
    background: linear-gradient(135deg, var(--payment-primary) 0%, #764ba2 100%);
    color: white;
}

.payment-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.payment-btn-success {
    background: linear-gradient(135deg, var(--payment-success) 0%, #20c997 100%);
    color: white;
}

/* Tableaux */
.payment-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 6px var(--payment-shadow);
}

.payment-table th {
    background-color: var(--payment-primary);
    color: white;
    padding: 15px;
    text-align: left;
    font-weight: 600;
}

.payment-table td {
    padding: 15px;
    border-bottom: 1px solid var(--payment-border);
    background-color: white;
}

.payment-table tr:last-child td {
    border-bottom: none;
}

.payment-table tr:hover td {
    background-color: var(--payment-light);
}

/* Alertes */
.payment-alert {
    border-radius: 10px;
    border: none;
    padding: 20px;
    margin-bottom: 20px;
}

.payment-alert-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1565c0;
    border-left: 4px solid #2196f3;
}

.payment-alert-warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
    border-left: 4px solid #ffc107;
}

.payment-alert-success {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
    border-left: 4px solid #28a745;
}

.payment-alert-danger {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
    border-left: 4px solid #dc3545;
}

/* Badges de sécurité */
.security-badge {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    background: linear-gradient(135deg, var(--payment-success) 0%, #20c997 100%);
    color: white;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
}

.security-badge i {
    margin-right: 8px;
    font-size: 1.1rem;
}

/* QR Code */
.qr-code-container {
    text-align: center;
    padding: 25px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px var(--payment-shadow);
    margin: 20px 0;
}

.qr-code-container img {
    max-width: 100%;
    height: auto;
    border: 1px solid var(--payment-border);
    border-radius: 8px;
    padding: 10px;
    background: white;
}

/* Compte à rebours */
.countdown {
    font-family: 'Courier New', monospace;
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--payment-danger);
    text-align: center;
    padding: 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 6px var(--payment-shadow);
    margin: 20px 0;
}

.countdown.expired {
    color: var(--payment-dark);
    background: var(--payment-light);
}

/* Étapes de paiement */
.payment-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin: 40px 0;
}

.payment-steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 10%;
    right: 10%;
    height: 3px;
    background: var(--payment-border);
    z-index: 1;
}

.step {
    text-align: center;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    background: var(--payment-light);
    color: var(--payment-dark);
    border: 3px solid var(--payment-border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 auto 10px;
    transition: all 0.3s ease;
}

.step.active .step-number {
    background: var(--payment-primary);
    color: white;
    border-color: var(--payment-primary);
    transform: scale(1.1);
}

.step.completed .step-number {
    background: var(--payment-success);
    color: white;
    border-color: var(--payment-success);
}

.step-content {
    max-width: 150px;
    margin: 0 auto;
}

.step-content h5 {
    font-size: 0.9rem;
    margin-bottom: 5px;
    color: var(--payment-dark);
}

.step-content p {
    font-size: 0.8rem;
    color: #6c757d;
}

/* Receipt */
.receipt {
    border: 2px solid var(--payment-border);
    border-radius: 15px;
    overflow: hidden;
}

.receipt-header {
    background: linear-gradient(135deg, var(--payment-primary) 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    text-align: center;
}

.receipt-body {
    padding: 30px;
    background: white;
}

.receipt-footer {
    background: var(--payment-light);
    padding: 20px;
    text-align: center;
    border-top: 1px solid var(--payment-border);
}

/* Responsive */
@media (max-width: 768px) {
    .payment-steps {
        flex-direction: column;
        align-items: center;
    }

    .payment-steps::before {
        display: none;
    }

    .step {
        margin-bottom: 30px;
    }

    .amount-large {
        font-size: 2rem;
    }

    .payment-table {
        font-size: 0.9rem;
    }

    .payment-table th,
    .payment-table td {
        padding: 10px;
    }
}

/* Animations */
@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
    }
}

.pulse {
    animation: pulse 2s infinite;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: fadeIn 0.5s ease forwards;
}

/* Loader */
.payment-loader {
    display: inline-block;
    width: 30px;
    height: 30px;
    border: 3px solid var(--payment-light);
    border-top: 3px solid var(--payment-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Custom scrollbar */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: var(--payment-light);
}

::-webkit-scrollbar-thumb {
    background: var(--payment-primary);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #5a67d8;
}

/* Print styles */
@media print {
    .payment-page {
        background: white;
        padding: 0;
    }

    .payment-card {
        box-shadow: none;
        border: 1px solid #000;
    }

    .no-print {
        display: none !important;
    }

    .receipt {
        border: 1px solid #000;
    }
}


========== payments/templates/payments/checkout/checkout.html ==========
{# ~/ebi3/payments/templates/payments/checkout/checkout.html #}
{% extends 'payments/base_payments.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Paiement" %} - Ebi3{% endblock %}

{% block payments_content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card payment-card mb-4">
            <div class="card-header payment-header">
                <h3 class="mb-0">
                    <i class="fas fa-shopping-cart"></i> {% trans "Finaliser votre paiement" %}
                </h3>
            </div>

            <div class="card-body">
                <!-- Étapes du paiement -->
                <div class="payment-steps">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <small>{% trans "Montant" %}</small>
                            <br>
                            <strong>{% trans "Détails" %}</strong>
                        </div>
                    </div>
                    <div class="step {% if step >= 2 %}active{% endif %}">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <small>{% trans "Méthode" %}</small>
                            <br>
                            <strong>{% trans "Paiement" %}</strong>
                        </div>
                    </div>
                    <div class="step {% if step >= 3 %}active{% endif %}">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <small>{% trans "Confirmation" %}</small>
                            <br>
                            <strong>{% trans "Validation" %}</strong>
                        </div>
                    </div>
                </div>

                <!-- Détails de la transaction -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-receipt"></i> {% trans "Détails de la transaction" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>{% trans "Référence :" %}</strong> {{ transaction.transaction_id }}</p>
                                <p><strong>{% trans "Date :" %}</strong> {{ transaction.created_at|date:"d/m/Y H:i" }}</p>
                                <p><strong>{% trans "Statut :" %}</strong>
                                    <span class="payment-status status-{{ transaction.status|lower }}">
                                        {{ transaction.get_status_display }}
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>{% trans "But :" %}</strong> {{ transaction.get_purpose_display }}</p>
                                {% if transaction.description %}
                                    <p><strong>{% trans "Description :" %}</strong> {{ transaction.description }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sélection de la méthode de paiement -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-credit-card"></i> {% trans "Méthode de paiement" %}</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" class="payment-form" id="payment-form">
                            {% csrf_token %}
                            <input type="hidden" name="step" value="2">
                            <input type="hidden" id="selected_payment_method" name="payment_method" value="">

                            <div class="payment-methods-grid">
                                {% for method in payment_methods %}
                                    <div class="payment-method-card" data-method="{{ method.value }}">
                                        <i class="{{ method.icon }}"></i>
                                        <h6>{{ method.name }}</h6>
                                        <small class="text-muted">{{ method.description }}</small>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Détails de la carte (affichés si carte sélectionnée) -->
                            <div id="card-details" style="display: none;" class="mt-4">
                                <h6>{% trans "Informations de la carte" %}</h6>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">{% trans "Numéro de carte" %}</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control"
                                                   placeholder="1234 5678 9012 3456"
                                                   maxlength="19"
                                                   data-mask="0000 0000 0000 0000">
                                            <span class="input-group-text">
                                                <i class="fas fa-credit-card"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">{% trans "Date d'expiration" %}</label>
                                        <input type="text" class="form-control"
                                               placeholder="MM/AA"
                                               maxlength="5"
                                               data-mask="00/00">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">CVV</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control"
                                                   placeholder="123"
                                                   maxlength="4">
                                            <span class="input-group-text" data-bs-toggle="tooltip"
                                                  title="{% trans 'Les 3 derniers chiffres au dos de votre carte' %}">
                                                <i class="fas fa-question-circle"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">{% trans "Nom sur la carte" %}</label>
                                        <input type="text" class="form-control"
                                               placeholder="{% trans 'Nom complet' %}">
                                    </div>
                                </div>
                            </div>

                            <!-- Détails PayPal (affichés si PayPal sélectionné) -->
                            <div id="paypal-details" style="display: none;" class="mt-4">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    {% trans "Vous serez redirigé vers PayPal pour compléter votre paiement." %}
                                </div>
                            </div>

                            <!-- Détails virement bancaire -->
                            <div id="bank-transfer-details" style="display: none;" class="mt-4">
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-university"></i> {% trans "Virement bancaire" %}</h6>
                                    <p class="mb-2">{% trans "Veuillez effectuer un virement aux coordonnées suivantes :" %}</p>
                                    <p class="mb-1"><strong>{% trans "Bénéficiaire :" %}</strong> {{ bank_details.account_holder }}</p>
                                    <p class="mb-1"><strong>IBAN :</strong> {{ bank_details.iban }}</p>
                                    <p class="mb-1"><strong>BIC :</strong> {{ bank_details.bic }}</p>
                                    <p class="mb-0"><strong>{% trans "Référence :" %}</strong> {{ transaction.transaction_id }}</p>
                                </div>
                            </div>

                            <div class="mt-4">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="terms" required>
                                    <label class="form-check-label" for="terms">
                                        {% trans "J'accepte les" %}
                                        <a href="{% url 'legal:terms' %}" target="_blank">{% trans "conditions générales" %}</a>
                                        {% trans "et la" %}
                                        <a href="{% url 'legal:privacy' %}" target="_blank">{% trans "politique de confidentialité" %}</a>.
                                    </label>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'payments:cancel_payment' transaction.id %}"
                                       class="btn btn-outline-secondary">
                                        <i class="fas fa-times"></i> {% trans "Annuler" %}
                                    </a>
                                    <button type="submit" id="submit-btn" class="btn btn-primary" disabled>
                                        <i class="fas fa-lock"></i> {% trans "Payer maintenant" %}
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Informations de sécurité -->
                <div class="card">
                    <div class="card-body text-center">
                        <div class="security-badge mb-2">
                            <i class="fas fa-shield-alt"></i> {% trans "Paiement sécurisé" %}
                        </div>
                        <p class="text-muted small mb-0">
                            <i class="fas fa-lock"></i> {% trans "Vos données sont cryptées et protégées." %}
                            <br>
                            <i class="fas fa-credit-card"></i> {% trans "Nous ne stockons pas vos informations de carte." %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar avec récapitulatif -->
    <div class="col-lg-4">
        <div class="card payment-card sticky-top" style="top: 20px;">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-file-invoice-dollar"></i> {% trans "Récapitulatif" %}</h5>
            </div>
            <div class="card-body">
                <!-- Montant total -->
                <div class="text-center mb-4">
                    <div class="amount-display">
                        {{ transaction.amount|floatformat:2 }}
                        <span class="currency-symbol">{{ transaction.get_currency_display }}</span>
                    </div>
                    <p class="text-muted">{% trans "Total à payer" %}</p>
                </div>

                <!-- Détails des frais -->
                <div class="mb-4">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td>{% trans "Sous-total" %}</td>
                                <td class="text-end">{{ transaction.amount|floatformat:2 }} {{ transaction.get_currency_display }}</td>
                            </tr>
                            {% if transaction.tax_amount %}
                                <tr>
                                    <td>{% trans "TVA" %} ({{ transaction.tax_rate }}%)</td>
                                    <td class="text-end">{{ transaction.tax_amount|floatformat:2 }} {{ transaction.get_currency_display }}</td>
                                </tr>
                            {% endif %}
                            {% if transaction.processing_fee %}
                                <tr>
                                    <td>{% trans "Frais de traitement" %}</td>
                                    <td class="text-end">{{ transaction.processing_fee|floatformat:2 }} {{ transaction.get_currency_display }}</td>
                                </tr>
                            {% endif %}
                            <tr class="total-row">
                                <td><strong>{% trans "Total" %}</strong></td>
                                <td class="text-end">
                                    <strong>{{ transaction.total_amount|floatformat:2 }} {{ transaction.get_currency_display }}</strong>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Compte à rebours -->
                {% if transaction.status == 'PENDING' %}
                    <div class="countdown-timer mb-4" data-seconds="{{ session_timeout }}">
                        <i class="fas fa-clock"></i>
                        {% trans "Temps restant :" %}
                        <span id="countdown-timer">{{ session_timeout|divisibleby:60|yesno:"session_timeout|divisibleby:60,?minute(s)" }}</span>
                    </div>
                {% endif %}

                <!-- Informations de support -->
                <div class="alert alert-light border">
                    <h6><i class="fas fa-headset"></i> {% trans "Besoin d'aide ?" %}</h6>
                    <p class="small mb-2">{% trans "Notre équipe est disponible pour vous aider." %}</p>
                    <a href="{% url 'core:contact' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-envelope"></i> {% trans "Contactez-nous" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les conditions -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Conditions de paiement" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Contenu des conditions -->
                {% include 'payments/partials/terms_content.html' %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Fermer" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Gestion de l'affichage des détails selon la méthode de paiement
    $('.payment-method-card').click(function() {
        const method = $(this).data('method');

        // Masquer tous les détails
        $('#card-details, #paypal-details, #bank-transfer-details').hide();

        // Afficher les détails appropriés
        if (method === 'CREDIT_CARD' || method === 'DEBIT_CARD') {
            $('#card-details').show();
        } else if (method === 'PAYPAL') {
            $('#paypal-details').show();
        } else if (method === 'BANK_TRANSFER') {
            $('#bank-transfer-details').show();
        }

        // Activer le bouton de soumission
        $('#submit-btn').prop('disabled', false);
    });

    // Validation du formulaire de carte
    $('#payment-form').submit(function(e) {
        const selectedMethod = $('#selected_payment_method').val();

        if (!selectedMethod) {
            e.preventDefault();
            showToast('{% trans "Veuillez sélectionner une méthode de paiement." %}', 'error');
            return false;
        }

        if (selectedMethod === 'CREDIT_CARD' || selectedMethod === 'DEBIT_CARD') {
            // Validation des champs de carte
            const cardNumber = $('input[placeholder*="Numéro de carte"]').val().replace(/\s/g, '');
            const expiryDate = $('input[placeholder*="MM/AA"]').val();
            const cvv = $('input[placeholder*="CVV"]').val();
            const cardName = $('input[placeholder*="Nom complet"]').val();

            if (!cardNumber || cardNumber.length < 13) {
                e.preventDefault();
                showToast('{% trans "Veuillez saisir un numéro de carte valide." %}', 'error');
                return false;
            }

            if (!expiryDate || !/^\d{2}\/\d{2}$/.test(expiryDate)) {
                e.preventDefault();
                showToast('{% trans "Veuillez saisir une date d\'expiration valide (MM/AA)." %}', 'error');
                return false;
            }

            if (!cvv || (cvv.length !== 3 && cvv.length !== 4)) {
                e.preventDefault();
                showToast('{% trans "Veuillez saisir un code CVV valide." %}', 'error');
                return false;
            }

            if (!cardName) {
                e.preventDefault();
                showToast('{% trans "Veuillez saisir le nom figurant sur la carte." %}', 'error');
                return false;
            }
        }

        // Vérifier l'acceptation des conditions
        if (!$('#terms').is(':checked')) {
            e.preventDefault();
            showToast('{% trans "Veuillez accepter les conditions générales." %}', 'error');
            return false;
        }
    });

    // Masquage des numéros de carte
    $('input[placeholder*="Numéro de carte"]').on('input', function() {
        let value = $(this).val().replace(/\s/g, '');
        let formatted = '';

        for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) {
                formatted += ' ';
            }
            formatted += value[i];
        }

        $(this).val(formatted);
    });
});
</script>
{% endblock %}


========== payments/templates/payments/checkout/checkout_success.html ==========
{# ~/ebi3/payments/templates/payments/checkout/checkout_success.html #}
{% extends 'payments/base_payments.html' %}
{% load i18n %}

{% block title %}{% trans "Paiement réussi" %} - Ebi3{% endblock %}

{% block payments_content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card payment-card">
            <div class="card-header payment-header">
                <h3 class="mb-0 text-center">
                    <i class="fas fa-check-circle"></i> {% trans "Paiement réussi !" %}
                </h3>
            </div>

            <div class="card-body text-center py-5">
                <!-- Animation de succès -->
                <div class="mb-4">
                    <div class="success-animation">
                        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                    </div>
                </div>

                <h4 class="mb-3">{% trans "Merci pour votre paiement" %}</h4>
                <p class="text-muted mb-4">
                    {% trans "Votre transaction a été traitée avec succès." %}
                </p>

                <!-- Détails de la transaction -->
                <div class="receipt-container mb-4">
                    <div class="receipt-header">
                        <h5 class="mb-0">{% trans "Reçu de paiement" %}</h5>
                        <small class="text-light">{% trans "Numéro" %} #{{ transaction.transaction_id }}</small>
                    </div>
                    <div class="receipt-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">{% trans "Date" %}</small>
                                <p class="mb-0"><strong>{{ transaction.processed_at|date:"d/m/Y H:i" }}</strong></p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">{% trans "Statut" %}</small>
                                <p class="mb-0">
                                    <span class="payment-status status-completed">
                                        {{ transaction.get_status_display }}
                                    </span>
                                </p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">{% trans "Méthode" %}</small>
                                <p class="mb-0"><strong>{{ transaction.get_payment_method_display }}</strong></p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">{% trans "Montant" %}</small>
                                <p class="mb-0">
                                    <strong class="amount-display">
                                        {{ transaction.total_amount|floatformat:2 }}
                                        <span class="currency-symbol">{{ transaction.get_currency_display }}</span>
                                    </strong>
                                </p>
                            </div>
                        </div>

                        {% if invoice %}
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-file-invoice"></i>
                                {% trans "Votre facture a été générée." %}
                                <a href="{% url 'payments:invoice_detail' invoice.id %}" class="alert-link">
                                    {% trans "Télécharger la facture" %}
                                </a>
                            </div>
                        {% endif %}
                    </div>
                    <div class="receipt-footer">
                        <small class="text-muted">
                            {% trans "Un email de confirmation a été envoyé à" %} {{ transaction.user.email }}
                        </small>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <a href="{% url 'payments:transaction_detail' transaction.id %}" class="btn btn-outline-primary me-md-2">
                        <i class="fas fa-receipt"></i> {% trans "Voir le détail" %}
                    </a>

                    {% if invoice %}
                        <a href="{% url 'payments:download_invoice' invoice.id %}" class="btn btn-primary me-md-2">
                            <i class="fas fa-download"></i> {% trans "Télécharger la facture" %}
                        </a>
                    {% endif %}

                    <a href="{% url 'core:home' %}" class="btn btn-success">
                        <i class="fas fa-home"></i> {% trans "Retour à l'accueil" %}
                    </a>
                </div>

                <!-- Informations supplémentaires -->
                <div class="mt-4 pt-4 border-top">
                    <p class="text-muted small mb-2">
                        <i class="fas fa-info-circle"></i>
                        {% trans "Conservez ce reçu pour vos archives." %}
                    </p>
                    <p class="text-muted small mb-0">
                        {% trans "En cas de problème, contactez notre support en fournissant la référence" %}
                        <code>{{ transaction.transaction_id }}</code>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.success-animation {
    width: 100px;
    height: 100px;
    margin: 0 auto;
}

.checkmark {
    width: 100px;
    height: 100px;
}

.checkmark__circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 2;
    stroke-miterlimit: 10;
    stroke: #28a745;
    fill: none;
    animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}

.checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    stroke-width: 3;
    stroke-linecap: round;
    stroke-linejoin: round;
    stroke: #28a745;
    animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke {
    100% {
        stroke-dashoffset: 0;
    }
}

@keyframes scale {
    0%, 100% {
        transform: none;
    }
    50% {
        transform: scale3d(1.1, 1.1, 1);
    }
}

@keyframes fill {
    100% {
        box-shadow: inset 0px 0px 0px 30px #28a745;
    }
}
</style>
{% endblock %}


========== payments/templates/payments/base_payments.html ==========
{# ~/ebi3/payments/templates/payments/base_payments.html #}
{% extends 'core/base.html' %}
{% load i18n static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'payments/css/payments.css' %}">
<style>
.payment-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.payment-card {
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border: none;
}

.payment-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px 10px 0 0 !important;
}

.payment-status {
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: bold;
}

.status-pending { background-color: #ffc107; color: #000; }
.status-completed { background-color: #28a745; color: white; }
.status-failed { background-color: #dc3545; color: white; }
.status-refunded { background-color: #17a2b8; color: white; }

.payment-method-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    background: #f8f9fa;
    color: #667eea;
    font-size: 1.5rem;
}

.amount-display {
    font-size: 2.5rem;
    font-weight: bold;
    color: #28a745;
}

.currency-symbol {
    font-size: 1.5rem;
    color: #6c757d;
}

.payment-timeline {
    position: relative;
    padding-left: 30px;
}

.payment-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -23px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #667eea;
    border: 3px solid white;
    box-shadow: 0 0 0 3px #dee2e6;
}

.timeline-item.completed::before {
    background: #28a745;
}

.timeline-item.failed::before {
    background: #dc3545;
}

.invoice-table {
    width: 100%;
    border-collapse: collapse;
}

.invoice-table th {
    background-color: #f8f9fa;
    padding: 12px;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
}

.invoice-table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
}

.invoice-table tr:last-child td {
    border-bottom: none;
}

.total-row {
    background-color: #f8f9fa;
    font-weight: bold;
}

.security-badge {
    display: inline-flex;
    align-items: center;
    padding: 5px 10px;
    background: #28a745;
    color: white;
    border-radius: 15px;
    font-size: 0.85rem;
}

.security-badge i {
    margin-right: 5px;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.qr-code-container {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    margin: 20px 0;
}

.countdown-timer {
    font-size: 1.2rem;
    font-weight: bold;
    color: #dc3545;
    text-align: center;
    padding: 10px;
    background: #fff3cd;
    border-radius: 5px;
    margin: 10px 0;
}

.payment-steps {
    display: flex;
    justify-content: space-between;
    margin: 30px 0;
    position: relative;
}

.payment-steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: #dee2e6;
    z-index: 1;
}

.step {
    text-align: center;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    background: #6c757d;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 auto 10px;
}

.step.active .step-number {
    background: #667eea;
}

.step.completed .step-number {
    background: #28a745;
}

.step-content {
    max-width: 150px;
    margin: 0 auto;
}

.payment-methods-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.payment-method-card {
    padding: 20px;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-method-card:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
}

.payment-method-card.selected {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.payment-method-card i {
    font-size: 2rem;
    color: #667eea;
    margin-bottom: 10px;
}

.receipt-container {
    border: 1px solid #dee2e6;
    border-radius: 10px;
    overflow: hidden;
}

.receipt-header {
    background: #667eea;
    color: white;
    padding: 20px;
    text-align: center;
}

.receipt-body {
    padding: 30px;
}

.receipt-footer {
    background: #f8f9fa;
    padding: 20px;
    text-align: center;
    border-top: 1px solid #dee2e6;
}

/* Responsive design */
@media (max-width: 768px) {
    .payment-steps {
        flex-direction: column;
        align-items: center;
    }

    .payment-steps::before {
        display: none;
    }

    .step {
        margin-bottom: 20px;
    }

    .payment-methods-grid {
        grid-template-columns: 1fr;
    }

    .amount-display {
        font-size: 2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="payment-container">
    {% block payments_content %}{% endblock %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'payments/js/payments.js' %}"></script>
<script>
$(document).ready(function() {
    // Initialisation des tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Gestion des méthodes de paiement
    $('.payment-method-card').click(function() {
        $('.payment-method-card').removeClass('selected');
        $(this).addClass('selected');
        $('#selected_payment_method').val($(this).data('method'));
    });

    // Validation des formulaires de paiement
    $('.payment-form').submit(function(e) {
        const amount = parseFloat($('#amount').val());
        const minAmount = parseFloat($('#amount').data('min'));
        const maxAmount = parseFloat($('#amount').data('max'));

        if (amount < minAmount) {
            e.preventDefault();
            showToast('{% trans "Le montant minimum est" %} ' + minAmount + ' €', 'error');
            return false;
        }

        if (amount > maxAmount) {
            e.preventDefault();
            showToast('{% trans "Le montant maximum est" %} ' + maxAmount + ' €', 'error');
            return false;
        }

        // Afficher le loader
        $('#submit-btn').prop('disabled', true);
        $('#submit-btn').html('<span class="loading-spinner"></span> {% trans "Traitement en cours..." %}');
    });

    // Fonction pour afficher les toasts
    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        const container = $('#toast-container');
        if (container.length === 0) {
            $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
        }

        $('#toast-container').append(toastHtml);
        $('.toast').toast('show');

        // Supprimer le toast après disparition
        $('.toast').on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }

    // Compte à rebours pour les sessions de paiement
    function startCountdown(seconds) {
        const timerElement = $('#countdown-timer');
        if (timerElement.length === 0) return;

        let timeLeft = seconds;

        const timer = setInterval(function() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;

            timerElement.text(`${minutes}:${seconds.toString().padStart(2, '0')}`);

            if (timeLeft <= 0) {
                clearInterval(timer);
                timerElement.html('<i class="fas fa-exclamation-triangle"></i> {% trans "Session expirée" %}');
                $('.payment-form').find('button').prop('disabled', true);
                showToast('{% trans "Votre session a expiré. Veuillez recommencer." %}', 'error');
            }

            timeLeft--;
        }, 1000);
    }

    // Démarrer le compte à rebours si présent
    const countdownSeconds = $('#countdown-timer').data('seconds');
    if (countdownSeconds) {
        startCountdown(countdownSeconds);
    }

    // Copier le lien de paiement
    $('.copy-payment-link').click(function() {
        const link = $(this).data('link');
        navigator.clipboard.writeText(link).then(() => {
            showToast('{% trans "Lien copié dans le presse-papier" %}', 'success');
        });
    });

    // Générer QR Code
    $('.generate-qr').click(function() {
        const data = $(this).data('qr-data');
        const size = $(this).data('qr-size') || 200;

        $.ajax({
            url: '{% url "payments:generate_qr_code" %}',
            method: 'POST',
            data: {
                data: data,
                size: size,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                $('#qr-code-container').html(`<img src="${response.qr_code}" alt="QR Code">`);
            }
        });
    });
});
</script>
{% endblock %}


========== payments/templates/payments/js/payments.js ==========
// ~/ebi3/payments/static/payments/js/payments.js

class PaymentManager {
    constructor() {
        this.initialize();
    }

    initialize() {
        this.setupEventListeners();
        this.setupPaymentForm();
        this.setupCountdownTimers();
        this.setupQRCodeGenerator();
        this.setupPrintFunctionality();
    }

    setupEventListeners() {
        // Gestion des méthodes de paiement
        document.querySelectorAll('.payment-method-card').forEach(card => {
            card.addEventListener('click', (e) => this.selectPaymentMethod(e));
        });

        // Validation des formulaires
        document.querySelectorAll('.payment-form').forEach(form => {
            form.addEventListener('submit', (e) => this.validatePaymentForm(e));
        });

        // Copie des références
        document.querySelectorAll('.copy-reference').forEach(button => {
            button.addEventListener('click', (e) => this.copyToClipboard(e));
        });

        // Téléchargement des factures
        document.querySelectorAll('.download-invoice').forEach(button => {
            button.addEventListener('click', (e) => this.downloadInvoice(e));
        });

        // Affichage des détails
        document.querySelectorAll('.toggle-details').forEach(button => {
            button.addEventListener('click', (e) => this.toggleDetails(e));
        });
    }

    setupPaymentForm() {
        const paymentForm = document.getElementById('payment-form');
        if (!paymentForm) return;

        // Masquage des numéros de carte
        const cardNumberInput = paymentForm.querySelector('input[name="card_number"]');
        if (cardNumberInput) {
            cardNumberInput.addEventListener('input', (e) => this.formatCardNumber(e));
        }

        // Formatage de la date d'expiration
        const expiryInput = paymentForm.querySelector('input[name="expiry_date"]');
        if (expiryInput) {
            expiryInput.addEventListener('input', (e) => this.formatExpiryDate(e));
        }

        // Validation en temps réel
        paymentForm.querySelectorAll('input').forEach(input => {
            input.addEventListener('blur', (e) => this.validateField(e.target));
        });
    }

    setupCountdownTimers() {
        const countdownElements = document.querySelectorAll('.countdown-timer');
        countdownElements.forEach(element => {
            const seconds = parseInt(element.dataset.seconds) || 1800; // 30 minutes par défaut
            this.startCountdown(element, seconds);
        });
    }

    setupQRCodeGenerator() {
        const generateQRButtons = document.querySelectorAll('.generate-qr');
        generateQRButtons.forEach(button => {
            button.addEventListener('click', (e) => this.generateQRCode(e));
        });
    }

    setupPrintFunctionality() {
        const printButtons = document.querySelectorAll('.print-receipt');
        printButtons.forEach(button => {
            button.addEventListener('click', (e) => this.printReceipt(e));
        });
    }

    selectPaymentMethod(event) {
        const card = event.currentTarget;
        const method = card.dataset.method;

        // Désélectionner toutes les cartes
        document.querySelectorAll('.payment-method-card').forEach(c => {
            c.classList.remove('selected');
        });

        // Sélectionner la carte cliquée
        card.classList.add('selected');

        // Mettre à jour le champ caché
        const hiddenInput = document.getElementById('selected_payment_method');
        if (hiddenInput) {
            hiddenInput.value = method;
        }

        // Afficher/masquer les détails spécifiques
        this.togglePaymentDetails(method);

        // Activer le bouton de soumission
        const submitButton = document.getElementById('submit-btn');
        if (submitButton) {
            submitButton.disabled = false;
        }

        // Envoyer un événement analytics
        this.trackEvent('payment_method_selected', { method: method });
    }

    togglePaymentDetails(method) {
        // Masquer tous les détails
        const allDetails = document.querySelectorAll('.payment-details');
        allDetails.forEach(detail => {
            detail.style.display = 'none';
        });

        // Afficher les détails spécifiques
        const targetDetails = document.getElementById(`${method}-details`);
        if (targetDetails) {
            targetDetails.style.display = 'block';
        }
    }

    formatCardNumber(event) {
        let value = event.target.value.replace(/\s/g, '');
        let formatted = '';

        for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) {
                formatted += ' ';
            }
            formatted += value[i];
        }

        event.target.value = formatted;

        // Détecter le type de carte
        const cardType = this.detectCardType(value);
        this.updateCardIcon(cardType);
    }

    detectCardType(cardNumber) {
        const patterns = {
            visa: /^4/,
            mastercard: /^(5[1-5]|2[2-7])/,
            amex: /^3[47]/,
            discover: /^6(?:011|5)/,
            diners: /^3(?:0[0-5]|[68])/,
            jcb: /^35/,
            unionpay: /^62/,
        };

        for (const [type, pattern] of Object.entries(patterns)) {
            if (pattern.test(cardNumber)) {
                return type;
            }
        }

        return 'unknown';
    }

    updateCardIcon(cardType) {
        const iconMap = {
            visa: 'fab fa-cc-visa',
            mastercard: 'fab fa-cc-mastercard',
            amex: 'fab fa-cc-amex',
            discover: 'fab fa-cc-discover',
            diners: 'fab fa-cc-diners-club',
            jcb: 'fab fa-cc-jcb',
            unionpay: 'fab fa-cc-unionpay',
            unknown: 'fas fa-credit-card'
        };

        const iconElement = document.querySelector('.card-type-icon');
        if (iconElement) {
            iconElement.className = iconMap[cardType] || 'fas fa-credit-card';
        }
    }

    formatExpiryDate(event) {
        let value = event.target.value.replace(/\D/g, '');

        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }

        event.target.value = value;
    }

    validateField(field) {
        const value = field.value.trim();
        const name = field.name;
        let isValid = true;
        let message = '';

        switch (name) {
            case 'card_number':
                isValid = this.validateCardNumber(value);
                message = isValid ? '' : 'Numéro de carte invalide';
                break;
            case 'expiry_date':
                isValid = this.validateExpiryDate(value);
                message = isValid ? '' : 'Date d\'expiration invalide';
                break;
            case 'cvv':
                isValid = this.validateCVV(value);
                message = isValid ? '' : 'CVV invalide';
                break;
            case 'amount':
                isValid = this.validateAmount(value);
                message = isValid ? '' : 'Montant invalide';
                break;
        }

        this.showFieldValidation(field, isValid, message);
        return isValid;
    }

    validateCardNumber(cardNumber) {
        const cleaned = cardNumber.replace(/\s/g, '');

        // Vérifier la longueur
        if (cleaned.length < 13 || cleaned.length > 19) {
            return false;
        }

        // Algorithme de Luhn
        let sum = 0;
        let isEven = false;

        for (let i = cleaned.length - 1; i >= 0; i--) {
            let digit = parseInt(cleaned.charAt(i), 10);

            if (isEven) {
                digit *= 2;
                if (digit > 9) {
                    digit -= 9;
                }
            }

            sum += digit;
            isEven = !isEven;
        }

        return (sum % 10) === 0;
    }

    validateExpiryDate(expiryDate) {
        if (!/^\d{2}\/\d{2}$/.test(expiryDate)) {
            return false;
        }

        const [month, year] = expiryDate.split('/').map(Number);
        const now = new Date();
        const currentYear = now.getFullYear() % 100;
        const currentMonth = now.getMonth() + 1;

        if (month < 1 || month > 12) {
            return false;
        }

        if (year < currentYear || (year === currentYear && month < currentMonth)) {
            return false;
        }

        return true;
    }

    validateCVV(cvv) {
        return /^\d{3,4}$/.test(cvv);
    }

    validateAmount(amount) {
        const min = parseFloat(document.getElementById('amount').dataset.min) || 0.01;
        const max = parseFloat(document.getElementById('amount').dataset.max) || 100000;
        const value = parseFloat(amount);

        return !isNaN(value) && value >= min && value <= max;
    }

    showFieldValidation(field, isValid, message) {
        const feedbackElement = field.nextElementSibling;

        if (feedbackElement && feedbackElement.classList.contains('invalid-feedback')) {
            feedbackElement.textContent = message;
            feedbackElement.style.display = message ? 'block' : 'none';
        }

        if (isValid) {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        } else {
            field.classList.remove('is-valid');
            field.classList.add('is-invalid');
        }
    }

    validatePaymentForm(event) {
        const form = event.currentTarget;
        const selectedMethod = document.getElementById('selected_payment_method')?.value;

        if (!selectedMethod) {
            event.preventDefault();
            this.showToast('Veuillez sélectionner une méthode de paiement', 'error');
            return false;
        }

        // Validation spécifique selon la méthode
        let isValid = true;

        if (selectedMethod === 'CREDIT_CARD' || selectedMethod === 'DEBIT_CARD') {
            isValid = this.validateCardForm();
        } else if (selectedMethod === 'BANK_TRANSFER') {
            isValid = this.validateBankTransferForm();
        }

        if (!isValid) {
            event.preventDefault();
            return false;
        }

        // Validation des conditions générales
        const termsCheckbox = document.getElementById('terms');
        if (termsCheckbox && !termsCheckbox.checked) {
            event.preventDefault();
            this.showToast('Veuillez accepter les conditions générales', 'error');
            return false;
        }

        // Afficher le loader
        const submitButton = form.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="payment-loader"></span> Traitement en cours...';
        }

        // Envoyer un événement analytics
        this.trackEvent('payment_form_submitted', {
            method: selectedMethod,
            amount: document.getElementById('amount')?.value
        });

        return true;
    }

    validateCardForm() {
        const cardNumber = document.querySelector('input[name="card_number"]')?.value;
        const expiryDate = document.querySelector('input[name="expiry_date"]')?.value;
        const cvv = document.querySelector('input[name="cvv"]')?.value;
        const cardName = document.querySelector('input[name="card_name"]')?.value;

        let isValid = true;

        if (!this.validateCardNumber(cardNumber)) {
            this.showToast('Numéro de carte invalide', 'error');
            isValid = false;
        }

        if (!this.validateExpiryDate(expiryDate)) {
            this.showToast('Date d\'expiration invalide', 'error');
            isValid = false;
        }

        if (!this.validateCVV(cvv)) {
            this.showToast('CVV invalide', 'error');
            isValid = false;
        }

        if (!cardName || cardName.trim().length < 2) {
            this.showToast('Nom sur la carte invalide', 'error');
            isValid = false;
        }

        return isValid;
    }

    validateBankTransferForm() {
        // Validation spécifique aux virements bancaires
        return true;
    }

    startCountdown(element, seconds) {
        let timeLeft = seconds;

        const updateTimer = () => {
            const minutes = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;

            element.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            if (timeLeft <= 0) {
                clearInterval(timer);
                element.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Session expirée';
                element.classList.add('expired');

                // Désactiver le formulaire
                const form = element.closest('form');
                if (form) {
                    form.querySelectorAll('button').forEach(btn => {
                        btn.disabled = true;
                    });
                }

                this.showToast('Votre session a expiré. Veuillez recommencer.', 'error');
            }

            timeLeft--;
        };

        updateTimer();
        const timer = setInterval(updateTimer, 1000);
    }

    generateQRCode(event) {
        const button = event.currentTarget;
        const data = button.dataset.qrData;
        const size = button.dataset.qrSize || 200;
        const container = document.getElementById('qr-code-container');

        if (!container) return;

        // Afficher un loader
        container.innerHTML = '<div class="payment-loader"></div>';

        // Générer le QR code avec une API
        fetch('/payments/api/generate-qr/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCSRFToken()
            },
            body: JSON.stringify({
                data: data,
                size: size
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                container.innerHTML = `<img src="${result.qr_code}" alt="QR Code" class="img-fluid">`;
                this.showToast('QR Code généré avec succès', 'success');
            } else {
                container.innerHTML = '<p class="text-danger">Erreur lors de la génération</p>';
                this.showToast('Erreur lors de la génération du QR Code', 'error');
            }
        })
        .catch(error => {
            console.error('Error generating QR code:', error);
            container.innerHTML = '<p class="text-danger">Erreur réseau</p>';
            this.showToast('Erreur réseau', 'error');
        });
    }

    copyToClipboard(event) {
        const button = event.currentTarget;
        const text = button.dataset.copyText || button.textContent;

        navigator.clipboard.writeText(text).then(() => {
            this.showToast('Copié dans le presse-papier', 'success');

            // Changer temporairement l'icône
            const icon = button.querySelector('i');
            if (icon) {
                const originalClass = icon.className;
                icon.className = 'fas fa-check';

                setTimeout(() => {
                    icon.className = originalClass;
                }, 2000);
            }
        }).catch(err => {
            console.error('Failed to copy:', err);
            this.showToast('Échec de la copie', 'error');
        });
    }

    downloadInvoice(event) {
        const button = event.currentTarget;
        const invoiceId = button.dataset.invoiceId;

        // Afficher un loader
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="payment-loader"></span> Téléchargement...';
        button.disabled = true;

        // Télécharger la facture
        fetch(`/payments/invoices/${invoiceId}/download/`)
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `facture-${invoiceId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                this.showToast('Facture téléchargée', 'success');
            })
            .catch(error => {
                console.error('Download error:', error);
                this.showToast('Erreur lors du téléchargement', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    toggleDetails(event) {
        const button = event.currentTarget;
        const targetId = button.dataset.target;
        const target = document.getElementById(targetId);

        if (target) {
            const isHidden = target.style.display === 'none';
            target.style.display = isHidden ? 'block' : 'none';
            button.querySelector('i').className = isHidden ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        }
    }

    printReceipt(event) {
        window.print();
    }

    showToast(message, type = 'info') {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(container);
        }

        const toastElement = document.createElement('div');
        toastElement.innerHTML = toastHtml;
        container.appendChild(toastElement.firstElementChild);

        const toast = new bootstrap.Toast(toastElement.firstElementChild);
        toast.show();

        // Supprimer le toast après disparition
        toastElement.firstElementChild.addEventListener('hidden.bs.toast', function () {
            this.remove();
        });
    }

    trackEvent(eventName, data) {
        // Implémentation de tracking (Google Analytics, etc.)
        if (typeof gtag !== 'undefined') {
            gtag('event', eventName, data);
        }

        // Envoyer à votre propre backend
        fetch('/payments/api/track-event/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCSRFToken()
            },
            body: JSON.stringify({
                event: eventName,
                data: data,
                timestamp: new Date().toISOString()
            })
        }).catch(error => console.error('Tracking error:', error));
    }

    getCSRFToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue || '';
    }
}

// Initialisation lorsque le DOM est chargé
document.addEventListener('DOMContentLoaded', function() {
    window.paymentManager = new PaymentManager();
});

// Exports pour les tests
if (typeof module !== 'undefined' && module.exports) {
    module.exports = PaymentManager;
}


========== payments/utils.py ==========
# ~/ebi3/payments/utils.py
"""
Utilitaires pour l'application payments
Fonctions de chiffrement, validation, calculs financiers, etc.
"""

import json
import uuid
import hashlib
import hmac
import base64
import logging
from datetime import datetime, timedelta
from decimal import Decimal, ROUND_HALF_UP
from typing import Dict, List, Optional, Tuple, Any
from enum import Enum

from django.conf import settings
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import ValidationError
from django.core.mail import send_mail
from django.template.loader import render_to_string
from django.utils.crypto import get_random_string, constant_time_compare
from cryptography.fernet import Fernet, InvalidToken
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
import stripe
import paypalrestsdk
import requests
from requests.exceptions import RequestException

from .models import (
    PaymentTransaction, Invoice, Refund, Payout, Wallet,
    WalletTransaction, Tax, ExchangeRate, FraudAlert, AuditLog
)
from users.models import User

# Configuration du logger
logger = logging.getLogger(__name__)

# ============================================================================
# CONSTANTES ET CONFIGURATION
# ============================================================================

class PaymentErrorCode(Enum):
    """Codes d'erreur standardisés pour les paiements"""
    INSUFFICIENT_FUNDS = "insufficient_funds"
    CARD_DECLINED = "card_declined"
    EXPIRED_CARD = "expired_card"
    INVALID_CVC = "invalid_cvc"
    PROCESSING_ERROR = "processing_error"
    FRAUD_DETECTED = "fraud_detected"
    LIMIT_EXCEEDED = "limit_exceeded"
    CURRENCY_MISMATCH = "currency_mismatch"
    NETWORK_ERROR = "network_error"
    TIMEOUT = "timeout"


class Currency(Enum):
    """Devises supportées avec précision"""
    EUR = {"symbol": "€", "decimal_places": 2}
    USD = {"symbol": "$", "decimal_places": 2}
    GBP = {"symbol": "£", "decimal_places": 2}
    MAD = {"symbol": "DH", "decimal_places": 2}
    XOF = {"symbol": "CFA", "decimal_places": 0}
    XAF = {"symbol": "FCFA", "decimal_places": 0}
    TND = {"symbol": "DT", "decimal_places": 3}
    DZD = {"symbol": "DA", "decimal_places": 2}


# ============================================================================
# CHIFFREMENT ET SÉCURITÉ
# ============================================================================

class EncryptionManager:
    """Gestionnaire de chiffrement pour les données sensibles"""

    def __init__(self):
        self.key = self._load_encryption_key()
        self.fernet = Fernet(self.key)

    def _load_encryption_key(self) -> bytes:
        """Charge ou génère la clé de chiffrement"""
        key = settings.PAYMENT_ENCRYPTION_KEY

        if not key:
            # Générer une nouvelle clé (pour le développement seulement)
            logger.warning("No encryption key found, generating temporary key")
            key = Fernet.generate_key()

        if isinstance(key, str):
            key = key.encode('utf-8')

        return key

    def encrypt_data(self, data: Dict) -> str:
        """Chiffre les données sensibles"""
        try:
            json_data = json.dumps(data).encode('utf-8')
            encrypted = self.fernet.encrypt(json_data)
            return base64.urlsafe_b64encode(encrypted).decode('utf-8')
        except Exception as e:
            logger.error(f"Encryption error: {e}")
            raise ValueError(_("Erreur de chiffrement des données"))

    def decrypt_data(self, encrypted_data: str) -> Dict:
        """Déchiffre les données sensibles"""
        try:
            encrypted = base64.urlsafe_b64decode(encrypted_data.encode('utf-8'))
            decrypted = self.fernet.decrypt(encrypted)
            return json.loads(decrypted.decode('utf-8'))
        except InvalidToken:
            logger.error("Invalid encryption token")
            raise ValueError(_("Token de chiffrement invalide"))
        except Exception as e:
            logger.error(f"Decryption error: {e}")
            raise ValueError(_("Erreur de déchiffrement des données"))

    def generate_token(self, data: Dict, expiry_hours: int = 24) -> str:
        """Génère un token sécurisé avec expiration"""
        payload = {
            'data': data,
            'expiry': (timezone.now() + timedelta(hours=expiry_hours)).isoformat(),
            'nonce': get_random_string(32)
        }

        encrypted = self.encrypt_data(payload)

        # Ajouter une signature HMAC
        signature = hmac.new(
            self.key,
            encrypted.encode('utf-8'),
            hashlib.sha256
        ).hexdigest()

        return f"{encrypted}.{signature}"

    def validate_token(self, token: str) -> Optional[Dict]:
        """Valide et décode un token"""
        try:
            encrypted, signature = token.rsplit('.', 1)

            # Vérifier la signature
            expected_signature = hmac.new(
                self.key,
                encrypted.encode('utf-8'),
                hashlib.sha256
            ).hexdigest()

            if not constant_time_compare(signature, expected_signature):
                logger.warning("Invalid token signature")
                return None

            # Déchiffrer les données
            payload = self.decrypt_data(encrypted)

            # Vérifier l'expiration
            expiry = datetime.fromisoformat(payload['expiry'])
            if timezone.make_aware(expiry) < timezone.now():
                logger.warning("Token expired")
                return None

            return payload['data']

        except (ValueError, KeyError) as e:
            logger.error(f"Token validation error: {e}")
            return None


class CardDataEncryptor:
    """Spécialisé dans le chiffrement des données de carte"""

    def __init__(self):
        self.encryption_manager = EncryptionManager()

    def encrypt_card(self, card_data: Dict) -> Dict:
        """Chiffre les données de carte de manière sécurisée"""
        required_fields = ['number', 'exp_month', 'exp_year', 'cvc']

        if not all(field in card_data for field in required_fields):
            raise ValueError(_("Données de carte incomplètes"))

        # Extraire les 4 derniers chiffres pour l'affichage
        last4 = card_data['number'][-4:]

        # Chiffrer les données complètes
        encrypted = self.encryption_manager.encrypt_data(card_data)

        # Générer un token unique pour cette carte
        card_token = f"card_{uuid.uuid4().hex}"

        return {
            'encrypted_data': encrypted,
            'last4': last4,
            'exp_month': card_data['exp_month'],
            'exp_year': card_data['exp_year'],
            'brand': self._detect_card_brand(card_data['number']),
            'token': card_token,
            'fingerprint': self._generate_card_fingerprint(card_data)
        }

    def decrypt_card(self, encrypted_card: Dict) -> Optional[Dict]:
        """Déchiffre les données de carte"""
        try:
            return self.encryption_manager.decrypt_data(encrypted_card['encrypted_data'])
        except Exception as e:
            logger.error(f"Card decryption error: {e}")
            return None

    def _detect_card_brand(self, card_number: str) -> str:
        """Détecte la marque de la carte"""
        card_number = card_number.replace(' ', '')

        if card_number.startswith('4'):
            return 'VISA'
        elif card_number.startswith(('51', '52', '53', '54', '55')):
            return 'MASTERCARD'
        elif card_number.startswith(('34', '37')):
            return 'AMEX'
        elif card_number.startswith(('300', '301', '302', '303', '304', '305', '36', '38')):
            return 'DINERS'
        elif card_number.startswith(('6011', '65')):
            return 'DISCOVER'
        elif card_number.startswith(('35', '2131', '1800')):
            return 'JCB'
        else:
            return 'UNKNOWN'

    def _generate_card_fingerprint(self, card_data: Dict) -> str:
        """Génère une empreinte unique pour la carte"""
        data = f"{card_data['number'][-8:]}{card_data['exp_month']}{card_data['exp_year']}"
        return hashlib.sha256(data.encode('utf-8')).hexdigest()[:16]


# ============================================================================
# CALCULS FINANCIERS
# ============================================================================

class FinancialCalculator:
    """Effectue tous les calculs financiers"""

    @staticmethod
    def calculate_fees(
        amount: Decimal,
        payment_method: str,
        currency: str = 'EUR'
    ) -> Dict[str, Decimal]:
        """Calcule les frais de transaction"""

        # Taux de frais par méthode (en pourcentage)
        fee_rates = {
            'CREDIT_CARD': Decimal('0.029'),  # 2.9%
            'DEBIT_CARD': Decimal('0.019'),   # 1.9%
            'PAYPAL': Decimal('0.034'),       # 3.4%
            'STRIPE': Decimal('0.029'),       # 2.9%
            'EBI3_WALLET': Decimal('0.01'),   # 1%
            'BANK_TRANSFER': Decimal('0.005'), # 0.5%
            'PAYSTACK': Decimal('0.015'),     # 1.5%
            'CINETPAY': Decimal('0.02'),      # 2%
            'ORANGE_MONEY': Decimal('0.02'),  # 2%
            'MTN_MONEY': Decimal('0.02'),     # 2%
        }

        # Frais fixes par devise
        fixed_fees = {
            'EUR': Decimal('0.30'),
            'USD': Decimal('0.30'),
            'GBP': Decimal('0.25'),
            'MAD': Decimal('3.00'),
            'XOF': Decimal('200'),
            'XAF': Decimal('200'),
            'TND': Decimal('0.80'),
            'DZD': Decimal('40'),
        }

        # Récupérer les taux
        rate = fee_rates.get(payment_method, Decimal('0.03'))  # 3% par défaut
        fixed = fixed_fees.get(currency, Decimal('0.30'))

        # Calculer les frais variables
        variable_fee = amount * rate

        # Total des frais
        total_fee = variable_fee + fixed

        # Arrondir selon la devise
        total_fee = FinancialCalculator._round_currency(total_fee, currency)

        return {
            'variable_fee': variable_fee,
            'fixed_fee': fixed,
            'total_fee': total_fee,
            'rate': rate
        }

    @staticmethod
    def calculate_tax(
        amount: Decimal,
        user: User,
        country_code: Optional[str] = None
    ) -> Dict[str, Decimal]:
        """Calcule la TVA/Taxe applicable"""

        # Déterminer le pays
        if not country_code and hasattr(user, 'profile'):
            country_code = user.profile.country.code if user.profile.country else None

        if not country_code:
            country_code = 'FR'  # Par défaut France

        # Chercher le taux de taxe
        try:
            tax = Tax.objects.get(country=country_code, is_active=True)
            tax_rate = tax.tax_rate / 100
            tax_name = tax.tax_name
        except Tax.DoesNotExist:
            # Taux par défaut selon le pays
            default_rates = {
                'FR': Decimal('0.20'),   # 20%
                'BE': Decimal('0.21'),   # 21%
                'DE': Decimal('0.19'),   # 19%
                'ES': Decimal('0.21'),   # 21%
                'IT': Decimal('0.22'),   # 22%
                'MA': Decimal('0.20'),   # 20%
                'TN': Decimal('0.19'),   # 19%
                'DZ': Decimal('0.19'),   # 19%
                'SN': Decimal('0.18'),   # 18%
                'CI': Decimal('0.18'),   # 18%
            }
            tax_rate = default_rates.get(country_code, Decimal('0'))
            tax_name = "TVA" if tax_rate > 0 else "Taxe"

        # Calculer le montant taxable (souvent le net après frais)
        taxable_amount = amount

        # Calculer la taxe
        tax_amount = taxable_amount * tax_rate

        # Arrondir
        tax_amount = tax_amount.quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)

        return {
            'tax_rate': tax_rate * 100,  # En pourcentage
            'tax_amount': tax_amount,
            'tax_name': tax_name,
            'country_code': country_code
        }

    @staticmethod
    def calculate_commission(
        amount: Decimal,
        transaction_type: str
    ) -> Dict[str, Decimal]:
        """Calcule la commission Ebi3"""

        # Taux de commission par type de transaction
        commission_rates = {
            'AD_PURCHASE': Decimal('0.10'),      # 10%
            'AD_FEATURED': Decimal('0.15'),      # 15%
            'AD_RESERVATION': Decimal('0.05'),   # 5%
            'MISSION_PAYMENT': Decimal('0.05'),  # 5%
            'WALLET_TRANSFER': Decimal('0.01'),  # 1%
            'SUBSCRIPTION': Decimal('0.00'),     # 0% pour abonnements
            'OTHER': Decimal('0.03'),            # 3% par défaut
        }

        rate = commission_rates.get(transaction_type, Decimal('0.03'))
        commission = amount * rate

        # Minimum de commission
        min_commission = Decimal('0.10')  # 0.10€ minimum

        if commission < min_commission:
            commission = min_commission

        return {
            'rate': rate,
            'amount': commission,
            'min_commission': min_commission
        }

    @staticmethod
    def calculate_net_amount(
        gross_amount: Decimal,
        fees: Decimal,
        tax: Decimal,
        commission: Decimal = Decimal('0')
    ) -> Decimal:
        """Calcule le montant net après déduction des frais"""
        net_amount = gross_amount - fees - tax - commission

        # Vérifier que le montant net n'est pas négatif
        if net_amount < Decimal('0'):
            raise ValueError(_("Le montant net ne peut pas être négatif"))

        return net_amount

    @staticmethod
    def convert_currency(
        amount: Decimal,
        from_currency: str,
        to_currency: str,
        date: Optional[datetime] = None
    ) -> Dict[str, Any]:
        """Convertit un montant d'une devise à une autre"""

        if from_currency == to_currency:
            return {
                'amount': amount,
                'converted_amount': amount,
                'rate': Decimal('1'),
                'from_currency': from_currency,
                'to_currency': to_currency
            }

        # Récupérer le taux de change
        try:
            if date:
                exchange_rate = ExchangeRate.objects.get(
                    base_currency=from_currency,
                    target_currency=to_currency,
                    last_updated__date=date.date(),
                    is_active=True
                )
            else:
                exchange_rate = ExchangeRate.objects.filter(
                    base_currency=from_currency,
                    target_currency=to_currency,
                    is_active=True
                ).latest('last_updated')

            rate = exchange_rate.rate
            source = exchange_rate.source

        except ExchangeRate.DoesNotExist:
            # Taux de change par défaut (pour développement)
            default_rates = {
                ('EUR', 'USD'): Decimal('1.08'),
                ('EUR', 'GBP'): Decimal('0.86'),
                ('EUR', 'MAD'): Decimal('10.75'),
                ('EUR', 'XOF'): Decimal('655.957'),
                ('USD', 'EUR'): Decimal('0.93'),
                ('GBP', 'EUR'): Decimal('1.16'),
                ('MAD', 'EUR'): Decimal('0.093'),
            }

            rate = default_rates.get((from_currency, to_currency))
            source = 'DEFAULT'

            if not rate:
                raise ValueError(_(f"Taux de change non disponible pour {from_currency} -> {to_currency}"))

        # Convertir le montant
        converted_amount = amount * rate

        # Arrondir selon la devise de destination
        converted_amount = FinancialCalculator._round_currency(converted_amount, to_currency)

        return {
            'amount': amount,
            'converted_amount': converted_amount,
            'rate': rate,
            'from_currency': from_currency,
            'to_currency': to_currency,
            'source': source,
            'date': date or timezone.now()
        }

    @staticmethod
    def _round_currency(amount: Decimal, currency: str) -> Decimal:
        """Arrondit un montant selon les règles de la devise"""
        try:
            currency_info = Currency[currency]
            decimal_places = currency_info.value['decimal_places']

            # Pour les devises sans décimales (comme XOF)
            if decimal_places == 0:
                return amount.quantize(Decimal('1'), rounding=ROUND_HALF_UP)

            # Pour les devises avec décimales
            quantizer = Decimal(f"0.{'0' * decimal_places}")
            return amount.quantize(quantizer, rounding=ROUND_HALF_UP)

        except KeyError:
            # Arrondi par défaut à 2 décimales
            return amount.quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)

    @staticmethod
    def calculate_monthly_interest(
        principal: Decimal,
        annual_rate: Decimal,
        days: int = 30
    ) -> Decimal:
        """Calcule les intérêts mensuels"""
        daily_rate = annual_rate / Decimal('365')
        interest = principal * daily_rate * Decimal(days)
        return interest.quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)


# ============================================================================
# GÉNÉRATION DE DOCUMENTS
# ============================================================================

class DocumentGenerator:
    """Génère des documents financiers (factures, reçus, etc.)"""

    @staticmethod
    def generate_invoice_pdf(invoice: Invoice) -> bytes:
        """Génère le PDF d'une facture"""
        try:
            # Rendre le template HTML
            html_content = render_to_string('payments/invoices/pdf_template.html', {
                'invoice': invoice,
                'company': {
                    'name': settings.COMPANY_NAME,
                    'address': settings.COMPANY_ADDRESS,
                    'vat_number': settings.COMPANY_VAT_NUMBER,
                    'logo_url': settings.COMPANY_LOGO_URL,
                }
            })

            # Convertir HTML en PDF
            # Note: Implémentation réelle nécessite WeasyPrint ou ReportLab
            pdf_content = DocumentGenerator._html_to_pdf(html_content)

            return pdf_content

        except Exception as e:
            logger.error(f"Invoice PDF generation error: {e}")
            raise

    @staticmethod
    def generate_receipt(transaction: PaymentTransaction) -> Dict:
        """Génère un reçu numérique signé"""

        # Créer le contenu du reçu
        receipt_data = {
            'receipt_id': f"RCP-{uuid.uuid4().hex[:8].upper()}",
            'transaction_id': str(transaction.transaction_id),
            'reference': transaction.reference,
            'date': timezone.now().isoformat(),
            'payer': {
                'id': str(transaction.payer.id) if transaction.payer else None,
                'username': transaction.payer.username if transaction.payer else None,
                'email': transaction.payer.email if transaction.payer else None,
            },
            'payee': {
                'id': str(transaction.payee.id) if transaction.payee else None,
                'username': transaction.payee.username if transaction.payee else None,
            },
            'amount': {
                'gross': str(transaction.amount),
                'currency': transaction.currency,
                'fees': str(transaction.fee_amount),
                'tax': str(transaction.tax_amount),
                'net': str(transaction.net_amount),
            },
            'payment_method': transaction.get_payment_method_display(),
            'status': transaction.get_status_display(),
            'description': f"Paiement {transaction.get_payment_type_display()}",
            'merchant': {
                'name': settings.COMPANY_NAME,
                'website': settings.SITE_URL,
                'support_email': settings.SUPPORT_EMAIL,
            }
        }

        # Signer le reçu
        signature = DocumentGenerator._sign_data(receipt_data)

        receipt_data['signature'] = signature
        receipt_data['verification_url'] = f"{settings.SITE_URL}/verify-receipt/{receipt_data['receipt_id']}"

        return receipt_data

    @staticmethod
    def generate_financial_report(
        start_date: datetime,
        end_date: datetime,
        report_type: str = 'DETAILED'
    ) -> Dict:
        """Génère un rapport financier"""

        # Récupérer les transactions
        transactions = PaymentTransaction.objects.filter(
            created_at__range=[start_date, end_date],
            status=PaymentTransaction.Status.COMPLETED
        )

        # Calculer les statistiques
        stats = {
            'period': {
                'start': start_date.isoformat(),
                'end': end_date.isoformat(),
            },
            'summary': {
                'total_transactions': transactions.count(),
                'total_volume': transactions.aggregate(total=Sum('amount'))['total'] or Decimal('0'),
                'total_fees': transactions.aggregate(total=Sum('fee_amount'))['total'] or Decimal('0'),
                'total_tax': transactions.aggregate(total=Sum('tax_amount'))['total'] or Decimal('0'),
                'net_volume': transactions.aggregate(total=Sum('net_amount'))['total'] or Decimal('0'),
            },
            'by_currency': {},
            'by_method': {},
            'by_type': {},
        }

        # Statistiques par devise
        currency_stats = transactions.values('currency').annotate(
            count=Count('id'),
            volume=Sum('amount'),
            fees=Sum('fee_amount')
        )

        for stat in currency_stats:
            stats['by_currency'][stat['currency']] = {
                'count': stat['count'],
                'volume': stat['volume'],
                'fees': stat['fees'],
            }

        # Statistiques par méthode de paiement
        method_stats = transactions.values('payment_method').annotate(
            count=Count('id'),
            volume=Sum('amount')
        )

        for stat in method_stats:
            stats['by_method'][stat['payment_method']] = {
                'count': stat['count'],
                'volume': stat['volume'],
            }

        # Statistiques par type de transaction
        type_stats = transactions.values('payment_type').annotate(
            count=Count('id'),
            volume=Sum('amount')
        )

        for stat in type_stats:
            stats['by_type'][stat['payment_type']] = {
                'count': stat['count'],
                'volume': stat['volume'],
            }

        # Transactions détaillées si nécessaire
        if report_type == 'DETAILED':
            stats['transactions'] = list(transactions.values(
                'reference', 'created_at', 'amount', 'currency',
                'payment_method', 'payment_type', 'payer__username'
            )[:100])  # Limiter à 100 transactions

        return stats

    @staticmethod
    def _html_to_pdf(html_content: str) -> bytes:
        """Convertit HTML en PDF (implémentation simplifiée)"""
        # En production, utiliser WeasyPrint ou ReportLab
        # Ceci est un placeholder pour la démonstration
        try:
            # Pour l'instant, retourner du HTML
            # Dans une implémentation réelle :
            # from weasyprint import HTML
            # pdf = HTML(string=html_content).write_pdf()
            return html_content.encode('utf-8')
        except Exception as e:
            logger.error(f"HTML to PDF conversion error: {e}")
            raise

    @staticmethod
    def _sign_data(data: Dict) -> str:
        """Signe numériquement des données"""
        # Créer une chaîne de données à signer
        data_string = json.dumps(data, sort_keys=True)

        # Générer la signature HMAC
        secret = settings.SECRET_KEY.encode('utf-8')
        signature = hmac.new(secret, data_string.encode('utf-8'), hashlib.sha256)

        return base64.urlsafe_b64encode(signature.digest()).decode('utf-8')


# ============================================================================
# NOTIFICATIONS ET COMMUNICATIONS
# ============================================================================

class NotificationManager:
    """Gère l'envoi des notifications de paiement"""

    @staticmethod
    def send_payment_confirmation(transaction: PaymentTransaction) -> bool:
        """Envoie une confirmation de paiement"""
        try:
            if not transaction.payer or not transaction.payer.email:
                return False

            subject = _("Confirmation de paiement - {}").format(transaction.reference)

            # Rendre le template d'email
            context = {
                'transaction': transaction,
                'user': transaction.payer,
                'site_url': settings.SITE_URL,
                'support_email': settings.SUPPORT_EMAIL,
            }

            html_message = render_to_string('payments/emails/payment_confirmation.html', context)
            text_message = render_to_string('payments/emails/payment_confirmation.txt', context)

            # Envoyer l'email
            send_mail(
                subject=subject,
                message=text_message,
                html_message=html_message,
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=[transaction.payer.email],
                fail_silently=False
            )

            logger.info(f"Payment confirmation sent for transaction {transaction.reference}")
            return True

        except Exception as e:
            logger.error(f"Payment confirmation email error: {e}")
            return False

    @staticmethod
    def send_payment_received(transaction: PaymentTransaction) -> bool:
        """Notifie le bénéficiaire qu'un paiement a été reçu"""
        try:
            if not transaction.payee or not transaction.payee.email:
                return False

            subject = _("Paiement reçu - {}").format(transaction.reference)

            context = {
                'transaction': transaction,
                'user': transaction.payee,
                'site_url': settings.SITE_URL,
            }

            html_message = render_to_string('payments/emails/payment_received.html', context)
            text_message = render_to_string('payments/emails/payment_received.txt', context)

            send_mail(
                subject=subject,
                message=text_message,
                html_message=html_message,
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=[transaction.payee.email],
                fail_silently=False
            )

            logger.info(f"Payment received notification sent for transaction {transaction.reference}")
            return True

        except Exception as e:
            logger.error(f"Payment received email error: {e}")
            return False

    @staticmethod
    def send_refund_status(refund: Refund) -> bool:
        """Notifie du statut d'un remboursement"""
        try:
            if not refund.requested_by or not refund.requested_by.email:
                return False

            subject = _("Statut de votre remboursement - {}").format(refund.transaction.reference)

            context = {
                'refund': refund,
                'user': refund.requested_by,
                'site_url': settings.SITE_URL,
            }

            html_message = render_to_string('payments/emails/refund_status.html', context)
            text_message = render_to_string('payments/emails/refund_status.txt', context)

            send_mail(
                subject=subject,
                message=text_message,
                html_message=html_message,
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=[refund.requested_by.email],
                fail_silently=False
            )

            logger.info(f"Refund status notification sent for refund {refund.id}")
            return True

        except Exception as e:
            logger.error(f"Refund status email error: {e}")
            return False

    @staticmethod
    def send_payout_notification(payout: Payout) -> bool:
        """Notifie du traitement d'un versement"""
        try:
            if not payout.user or not payout.user.email:
                return False

            subject = _("Statut de votre versement - {}").format(payout.payout_id)

            context = {
                'payout': payout,
                'user': payout.user,
                'site_url': settings.SITE_URL,
            }

            html_message = render_to_string('payments/emails/payout_notification.html', context)
            text_message = render_to_string('payments/emails/payout_notification.txt', context)

            send_mail(
                subject=subject,
                message=text_message,
                html_message=html_message,
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=[payout.user.email],
                fail_silently=False
            )

            logger.info(f"Payout notification sent for payout {payout.payout_id}")
            return True

        except Exception as e:
            logger.error(f"Payout notification email error: {e}")
            return False

    @staticmethod
    def send_fraud_alert(fraud_alert: FraudAlert) -> bool:
        """Envoie une alerte de fraude aux administrateurs"""
        try:
            admin_emails = User.objects.filter(
                is_staff=True,
                is_active=True
            ).values_list('email', flat=True)

            if not admin_emails:
                return False

            subject = _("🚨 Alerte de fraude - Transaction {}").format(
                fraud_alert.transaction.reference
            )

            context = {
                'fraud_alert': fraud_alert,
                'transaction': fraud_alert.transaction,
                'site_url': settings.SITE_URL,
            }

            html_message = render_to_string('payments/emails/fraud_alert.html', context)
            text_message = render_to_string('payments/emails/fraud_alert.txt', context)

            send_mail(
                subject=subject,
                message=text_message,
                html_message=html_message,
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=list(admin_emails),
                fail_silently=False
            )

            logger.info(f"Fraud alert sent for transaction {fraud_alert.transaction.reference}")
            return True

        except Exception as e:
            logger.error(f"Fraud alert email error: {e}")
            return False


# ============================================================================
# DÉTECTION DE FRAUDE
# ============================================================================

class FraudDetector:
    """Détecte les activités frauduleuses"""

    def __init__(self):
        self.rules = self._load_fraud_rules()

    def _load_fraud_rules(self) -> List[Dict]:
        """Charge les règles de détection de fraude"""
        return [
            {
                'name': 'HIGH_AMOUNT',
                'condition': lambda t: t.amount > Decimal('10000'),
                'score': 30,
                'message': _("Montant anormalement élevé"),
            },
            {
                'name': 'FREQUENT_TRANSACTIONS',
                'condition': lambda t: self._check_frequent_transactions(t),
                'score': 25,
                'message': _("Transactions trop fréquentes"),
            },
            {
                'name': 'MULTIPLE_FAILED_ATTEMPTS',
                'condition': lambda t: self._check_failed_attempts(t),
                'score': 40,
                'message': _("Multiples tentatives échouées"),
            },
            {
                'name': 'NEW_USER_HIGH_AMOUNT',
                'condition': lambda t: self._check_new_user_high_amount(t),
                'score': 35,
                'message': _("Nouvel utilisateur avec montant élevé"),
            },
            {
                'name': 'COUNTRY_MISMATCH',
                'condition': lambda t: self._check_country_mismatch(t),
                'score': 20,
                'message': _("Incohérence de pays"),
            },
            {
                'name': 'UNUSUAL_TIME',
                'condition': lambda t: self._check_unusual_time(t),
                'score': 15,
                'message': _("Heure de transaction inhabituelle"),
            },
        ]

    def analyze_transaction(self, transaction: PaymentTransaction) -> Dict:
        """Analyse une transaction pour détecter la fraude"""
        fraud_score = 0
        reasons = []

        for rule in self.rules:
            try:
                if rule['condition'](transaction):
                    fraud_score += rule['score']
                    reasons.append({
                        'rule': rule['name'],
                        'score': rule['score'],
                        'message': rule['message']
                    })
            except Exception as e:
                logger.error(f"Fraud rule error {rule['name']}: {e}")
                continue

        # Calculer le niveau de risque
        risk_level = self._calculate_risk_level(fraud_score)

        return {
            'fraud_score': fraud_score,
            'risk_level': risk_level,
            'reasons': reasons,
            'recommendation': self._get_recommendation(risk_level),
            'timestamp': timezone.now()
        }

    def _check_frequent_transactions(self, transaction: PaymentTransaction) -> bool:
        """Vérifie les transactions trop fréquentes"""
        if not transaction.payer:
            return False

        # Nombre de transactions dans les dernières 10 minutes
        recent_count = PaymentTransaction.objects.filter(
            payer=transaction.payer,
            created_at__gte=timezone.now() - timedelta(minutes=10)
        ).count()

        return recent_count > 5

    def _check_failed_attempts(self, transaction: PaymentTransaction) -> bool:
        """Vérifie les tentatives échouées récentes"""
        if not transaction.payer:
            return False

        # Nombre de transactions échouées dans la dernière heure
        failed_count = PaymentTransaction.objects.filter(
            payer=transaction.payer,
            status=PaymentTransaction.Status.FAILED,
            created_at__gte=timezone.now() - timedelta(hours=1)
        ).count()

        return failed_count >= 3

    def _check_new_user_high_amount(self, transaction: PaymentTransaction) -> bool:
        """Vérifie si un nouvel utilisateur fait un gros paiement"""
        if not transaction.payer:
            return False

        # Vérifier si l'utilisateur est nouveau (moins de 7 jours)
        user_age = timezone.now() - transaction.payer.date_joined
        is_new_user = user_age.days < 7

        # Vérifier si le montant est élevé
        is_high_amount = transaction.amount > Decimal('1000')

        return is_new_user and is_high_amount

    def _check_country_mismatch(self, transaction: PaymentTransaction) -> bool:
        """Vérifie les incohérences de pays"""
        if not transaction.payer or not hasattr(transaction.payer, 'profile'):
            return False

        # Cette règle nécessite des données de géolocalisation
        # Pour l'instant, retourner False
        return False

    def _check_unusual_time(self, transaction: PaymentTransaction) -> bool:
        """Vérifie si la transaction est à une heure inhabituelle"""
        # Transactions entre 2h et 5h du matin
        hour = transaction.created_at.hour
        return 2 <= hour <= 5

    def _calculate_risk_level(self, fraud_score: int) -> str:
        """Calcule le niveau de risque"""
        if fraud_score >= 70:
            return 'CRITICAL'
        elif fraud_score >= 50:
            return 'HIGH'
        elif fraud_score >= 30:
            return 'MEDIUM'
        elif fraud_score >= 15:
            return 'LOW'
        else:
            return 'NONE'

    def _get_recommendation(self, risk_level: str) -> str:
        """Retourne la recommandation basée sur le niveau de risque"""
        recommendations = {
            'CRITICAL': _("Bloquer la transaction et contacter le client"),
            'HIGH': _("Exiger une vérification supplémentaire (3D Secure)"),
            'MEDIUM': _("Surveiller et possiblement demander une confirmation"),
            'LOW': _("Autoriser mais surveiller"),
            'NONE': _("Autoriser la transaction"),
        }
        return recommendations.get(risk_level, _("Autoriser la transaction"))

    def create_fraud_alert(self, transaction: PaymentTransaction, analysis: Dict) -> Optional[FraudAlert]:
        """Crée une alerte de fraude si nécessaire"""
        if analysis['risk_level'] in ['MEDIUM', 'HIGH', 'CRITICAL']:
            try:
                fraud_alert = FraudAlert.objects.create(
                    transaction=transaction,
                    severity=analysis['risk_level'],
                    fraud_score=analysis['fraud_score'],
                    reasons=analysis['reasons']
                )

                # Envoyer une notification
                NotificationManager.send_fraud_alert(fraud_alert)

                return fraud_alert
            except Exception as e:
                logger.error(f"Error creating fraud alert: {e}")

        return None


# ============================================================================
# INTÉGRATION AVEC LES PASSERELLES DE PAIEMENT
# ============================================================================

class PaymentGatewayManager:
    """Gère l'intégration avec les différentes passerelles de paiement"""

    @staticmethod
    def process_stripe_payment(
        amount: Decimal,
        currency: str,
        payment_method_id: str,
        metadata: Dict,
        customer_email: Optional[str] = None
    ) -> Dict:
        """Traite un paiement via Stripe"""
        try:
            # Convertir le montant en cents
            amount_cents = int(amount * 100)

            # Créer ou récupérer le client
            customer = None
            if customer_email:
                customers = stripe.Customer.list(email=customer_email, limit=1)
                if customers.data:
                    customer = customers.data[0]
                else:
                    customer = stripe.Customer.create(email=customer_email)

            # Créer le PaymentIntent
            intent_data = {
                'amount': amount_cents,
                'currency': currency.lower(),
                'payment_method': payment_method_id,
                'confirmation_method': 'manual',
                'confirm': True,
                'metadata': metadata,
                'capture_method': 'automatic',
            }

            if customer:
                intent_data['customer'] = customer.id

            # Activer 3D Secure si nécessaire
            if amount > Decimal('100'):  # Au-dessus de 100€
                intent_data['payment_method_options'] = {
                    'card': {
                        'request_three_d_secure': 'any'
                    }
                }

            payment_intent = stripe.PaymentIntent.create(**intent_data)

            return {
                'success': True,
                'payment_intent_id': payment_intent.id,
                'client_secret': payment_intent.client_secret,
                'status': payment_intent.status,
                'requires_action': payment_intent.status == 'requires_action',
                'next_action': payment_intent.next_action if hasattr(payment_intent, 'next_action') else None,
            }

        except stripe.error.CardError as e:
            logger.error(f"Stripe card error: {e.error.code} - {e.error.message}")
            return {
                'success': False,
                'error_code': e.error.code,
                'error_message': e.error.message,
                'gateway': 'stripe',
            }
        except stripe.error.StripeError as e:
            logger.error(f"Stripe error: {e}")
            return {
                'success': False,
                'error_code': 'stripe_error',
                'error_message': str(e),
                'gateway': 'stripe',
            }

    @staticmethod
    def process_paypal_payment(
        amount: Decimal,
        currency: str,
        return_url: str,
        cancel_url: str,
        description: str = ""
    ) -> Dict:
        """Crée un paiement PayPal"""
        try:
            payment = paypalrestsdk.Payment({
                "intent": "sale",
                "payer": {
                    "payment_method": "paypal"
                },
                "redirect_urls": {
                    "return_url": return_url,
                    "cancel_url": cancel_url
                },
                "transactions": [{
                    "amount": {
                        "total": str(amount),
                        "currency": currency
                    },
                    "description": description or f"Payment of {amount} {currency}"
                }]
            })

            if payment.create():
                # Trouver le lien d'approbation
                approval_url = None
                for link in payment.links:
                    if link.rel == "approval_url":
                        approval_url = link.href
                        break

                return {
                    'success': True,
                    'payment_id': payment.id,
                    'approval_url': approval_url,
                    'status': payment.state,
                }
            else:
                logger.error(f"PayPal payment creation failed: {payment.error}")
                return {
                    'success': False,
                    'error_code': 'payment_creation_failed',
                    'error_message': str(payment.error),
                    'gateway': 'paypal',
                }

        except Exception as e:
            logger.error(f"PayPal error: {e}")
            return {
                'success': False,
                'error_code': 'paypal_error',
                'error_message': str(e),
                'gateway': 'paypal',
            }

    @staticmethod
    def execute_paypal_payment(payment_id: str, payer_id: str) -> Dict:
        """Exécute un paiement PayPal après approbation"""
        try:
            payment = paypalrestsdk.Payment.find(payment_id)

            if payment.execute({"payer_id": payer_id}):
                # Récupérer les détails de la transaction
                sale = payment.transactions[0].related_resources[0].sale

                return {
                    'success': True,
                    'sale_id': sale.id,
                    'state': sale.state,
                    'amount': sale.amount.total,
                    'currency': sale.amount.currency,
                    'create_time': sale.create_time,
                }
            else:
                logger.error(f"PayPal payment execution failed: {payment.error}")
                return {
                    'success': False,
                    'error_code': 'payment_execution_failed',
                    'error_message': str(payment.error),
                    'gateway': 'paypal',
                }

        except Exception as e:
            logger.error(f"PayPal execution error: {e}")
            return {
                'success': False,
                'error_code': 'execution_error',
                'error_message': str(e),
                'gateway': 'paypal',
            }

    @staticmethod
    def process_mobile_money_payment(
        provider: str,
        phone_number: str,
        amount: Decimal,
        currency: str,
        country: str
    ) -> Dict:
        """Traite un paiement par mobile money"""
        # Implémentation spécifique au fournisseur
        # Ceci est un exemple simplifié

        providers_config = {
            'ORANGE_MONEY': {
                'api_url': settings.ORANGE_MONEY_API_URL,
                'api_key': settings.ORANGE_MONEY_API_KEY,
            },
            'MTN_MONEY': {
                'api_url': settings.MTN_MONEY_API_URL,
                'api_key': settings.MTN_MONEY_API_KEY,
            },
        }

        config = providers_config.get(provider)
        if not config:
            return {
                'success': False,
                'error_code': 'provider_not_supported',
                'error_message': _("Fournisseur non supporté"),
            }

        try:
            # Préparer la requête
            headers = {
                'Authorization': f'Bearer {config["api_key"]}',
                'Content-Type': 'application/json',
            }

            payload = {
                'phone_number': phone_number,
                'amount': str(amount),
                'currency': currency,
                'country': country,
                'reference': f"EBI3_{uuid.uuid4().hex[:8].upper()}",
            }

            # Envoyer la requête
            response = requests.post(
                config['api_url'],
                json=payload,
                headers=headers,
                timeout=30
            )

            if response.status_code == 200:
                data = response.json()
                return {
                    'success': True,
                    'transaction_id': data.get('transaction_id'),
                    'status': data.get('status'),
                    'message': data.get('message'),
                    'gateway': provider.lower(),
                }
            else:
                logger.error(f"Mobile money API error: {response.status_code} - {response.text}")
                return {
                    'success': False,
                    'error_code': 'api_error',
                    'error_message': response.text,
                    'gateway': provider.lower(),
                }

        except RequestException as e:
            logger.error(f"Mobile money request error: {e}")
            return {
                'success': False,
                'error_code': 'network_error',
                'error_message': str(e),
                'gateway': provider.lower(),
            }


# ============================================================================
# UTILITAIRES DIVERS
# ============================================================================

class PaymentValidator:
    """Valide les données de paiement"""

    @staticmethod
    def validate_card_number(card_number: str) -> Tuple[bool, str]:
        """Valide un numéro de carte avec l'algorithme de Luhn"""
        card_number = card_number.replace(' ', '').replace('-', '')

        if not card_number.isdigit():
            return False, _("Le numéro de carte doit contenir uniquement des chiffres")

        if len(card_number) < 13 or len(card_number) > 19:
            return False, _("Numéro de carte invalide")

        # Algorithme de Luhn
        def luhn_checksum(card_number: str) -> bool:
            digits = [int(d) for d in card_number]
            odd_digits = digits[-1::-2]
            even_digits = digits[-2::-2]
            checksum = sum(odd_digits)
            for d in even_digits:
                checksum += sum([int(x) for x in str(d * 2)])
            return checksum % 10 == 0

        if not luhn_checksum(card_number):
            return False, _("Numéro de carte invalide")

        return True, ""

    @staticmethod
    def validate_cvv(cvv: str) -> Tuple[bool, str]:
        """Valide un code CVV"""
        cvv = cvv.strip()

        if not cvv.isdigit():
            return False, _("Le CVV doit contenir uniquement des chiffres")

        if len(cvv) not in [3, 4]:
            return False, _("Le CVV doit contenir 3 ou 4 chiffres")

        return True, ""

    @staticmethod
    def validate_expiry_date(month: int, year: int) -> Tuple[bool, str]:
        """Valide une date d'expiration"""
        current_year = timezone.now().year
        current_month = timezone.now().month

        if year < current_year or (year == current_year and month < current_month):
            return False, _("La carte est expirée")

        if year > current_year + 20:
            return False, _("Date d'expiration invalide")

        if month < 1 or month > 12:
            return False, _("Mois invalide")

        return True, ""

    @staticmethod
    def validate_iban(iban: str) -> Tuple[bool, str]:
        """Valide un numéro IBAN"""
        iban = iban.upper().replace(' ', '')

        # Vérifier la longueur
        if len(iban) < 15 or len(iban) > 34:
            return False, _("IBAN invalide : longueur incorrecte")

        # Vérifier le format
        import re
        if not re.match(r'^[A-Z]{2}[0-9]{2}[A-Z0-9]{11,30}$', iban):
            return False, _("Format IBAN invalide")

        # Vérifier le pays
        supported_countries = ['FR', 'BE', 'DE', 'ES', 'IT', 'LU', 'NL', 'MA', 'TN', 'DZ']
        country_code = iban[:2]
        if country_code not in supported_countries:
            return False, _(f"IBAN du pays {country_code} non supporté")

        # Algorithme de vérification IBAN
        def iban_checksum(iban: str) -> bool:
            # Déplacer les 4 premiers caractères à la fin
            rearranged = iban[4:] + iban[:4]
            # Convertir les lettres en chiffres
            digits = ''
            for char in rearranged:
                if char.isdigit():
                    digits += char
                else:
                    digits += str(ord(char) - 55)
            # Calculer le modulo 97
            return int(digits) % 97 == 1

        if not iban_checksum(iban):
            return False, _("IBAN invalide")

        return True, ""


class ReferenceGenerator:
    """Génère des références uniques"""

    @staticmethod
    def generate_transaction_reference(prefix: str = "PAY") -> str:
        """Génère une référence de transaction unique"""
        date_str = timezone.now().strftime("%Y%m%d")
        random_str = uuid.uuid4().hex[:8].upper()
        return f"{prefix}{date_str}{random_str}"

    @staticmethod
    def generate_invoice_number() -> str:
        """Génère un numéro de facture unique"""
        year = timezone.now().strftime("%Y")
        month = timezone.now().strftime("%m")

        # Compter les factures du mois
        count = Invoice.objects.filter(
            invoice_date__year=int(year),
            invoice_date__month=int(month)
        ).count() + 1

        return f"INV{year}{month}{count:04d}"

    @staticmethod
    def generate_payout_reference() -> str:
        """Génère une référence de versement unique"""
        date_str = timezone.now().strftime("%Y%m%d")
        random_str = uuid.uuid4().hex[:6].upper()
        return f"PO{date_str}{random_str}"


# ============================================================================
# FONCTIONS D'AUDIT ET DE LOGGING
# ============================================================================

class AuditLogger:
    """Gère les logs d'audit pour la conformité"""

    @staticmethod
    def log_payment_action(
        user: User,
        action: str,
        transaction: Optional[PaymentTransaction] = None,
        details: Dict = None
    ) -> AuditLog:
        """Log une action de paiement"""
        try:
            audit_log = AuditLog.objects.create(
                user=user,
                action_type=action,
                action_description=AuditLogger._get_action_description(action, details),
                object_type='PaymentTransaction',
                object_id=str(transaction.transaction_id) if transaction else 'N/A',
                old_data=details.get('old_data') if details else None,
                new_data=details.get('new_data') if details else None,
                ip_address=AuditLogger._get_client_ip(),
                user_agent=AuditLogger._get_user_agent(),
            )
            return audit_log
        except Exception as e:
            logger.error(f"Audit log error: {e}")
            return None

    @staticmethod
    def log_refund_action(
        user: User,
        action: str,
        refund: Refund,
        details: Dict = None
    ) -> AuditLog:
        """Log une action de remboursement"""
        try:
            audit_log = AuditLog.objects.create(
                user=user,
                action_type=action,
                action_description=AuditLogger._get_action_description(action, details),
                object_type='Refund',
                object_id=str(refund.refund_id),
                old_data=details.get('old_data') if details else None,
                new_data=details.get('new_data') if details else None,
                ip_address=AuditLogger._get_client_ip(),
                user_agent=AuditLogger._get_user_agent(),
            )
            return audit_log
        except Exception as e:
            logger.error(f"Audit log error: {e}")
            return None

    @staticmethod
    def _get_action_description(action: str, details: Dict) -> str:
        """Génère une description d'action"""
        descriptions = {
            'CREATE': _("Création de transaction"),
            'UPDATE': _("Mise à jour de transaction"),
            'DELETE': _("Suppression de transaction"),
            'REFUND': _("Remboursement"),
            'PAYOUT': _("Versement"),
            'APPROVE': _("Approbation"),
            'REJECT': _("Rejet"),
        }

        base_description = descriptions.get(action, action)

        if details and 'amount' in details:
            return f"{base_description} - Montant: {details['amount']}"

        return base_description

    @staticmethod
    def _get_client_ip() -> Optional[str]:
        """Récupère l'adresse IP du client"""
        # À implémenter selon le middleware utilisé
        return None

    @staticmethod
    def _get_user_agent() -> Optional[str]:
        """Récupère le User Agent du client"""
        # À implémenter selon la requête
        return None


# ============================================================================
# INSTANCES GLOBALES POUR FACILITER L'UTILISATION
# ============================================================================

# Instances globales pour un accès facile
encryption_manager = EncryptionManager()
card_encryptor = CardDataEncryptor()
financial_calculator = FinancialCalculator()
fraud_detector = FraudDetector()
payment_validator = PaymentValidator()
reference_generator = ReferenceGenerator()
notification_manager = NotificationManager()
document_generator = DocumentGenerator()
payment_gateway_manager = PaymentGatewayManager()
audit_logger = AuditLogger()


========== payments/constants.py ==========
# ~/ebi3/payments/constants.py
"""
Constantes pour l'application payments
"""

from django.utils.translation import gettext_lazy as _

# ============================================================================
# STATUTS DES TRANSACTIONS
# ============================================================================

TRANSACTION_STATUS = {
    'PENDING': _('En attente'),
    'PROCESSING': _('En traitement'),
    'COMPLETED': _('Complétée'),
    'FAILED': _('Échouée'),
    'CANCELED': _('Annulée'),
    'REFUNDED': _('Remboursée'),
    'PARTIALLY_REFUNDED': _('Partiellement remboursée'),
    'EXPIRED': _('Expirée'),
    'REVERSED': _('Annulée (reversée)'),
    'CHARGEBACK': _('Contestée'),
}

TRANSACTION_STATUS_CHOICES = [
    ('PENDING', TRANSACTION_STATUS['PENDING']),
    ('PROCESSING', TRANSACTION_STATUS['PROCESSING']),
    ('COMPLETED', TRANSACTION_STATUS['COMPLETED']),
    ('FAILED', TRANSACTION_STATUS['FAILED']),
    ('CANCELED', TRANSACTION_STATUS['CANCELED']),
    ('REFUNDED', TRANSACTION_STATUS['REFUNDED']),
    ('PARTIALLY_REFUNDED', TRANSACTION_STATUS['PARTIALLY_REFUNDED']),
    ('EXPIRED', TRANSACTION_STATUS['EXPIRED']),
    ('REVERSED', TRANSACTION_STATUS['REVERSED']),
    ('CHARGEBACK', TRANSACTION_STATUS['CHARGEBACK']),
]

# ============================================================================
# MÉTHODES DE PAIEMENT
# ============================================================================

PAYMENT_METHODS = {
    'CREDIT_CARD': _('Carte de crédit'),
    'DEBIT_CARD': _('Carte de débit'),
    'PAYPAL': _('PayPal'),
    'BANK_TRANSFER': _('Virement bancaire'),
    'STRIPE': _('Stripe'),
    'CASH': _('Espèces'),
    'MOBILE_MONEY': _('Mobile Money'),
    'CRYPTO': _('Cryptomonnaie'),
    'APPLE_PAY': _('Apple Pay'),
    'GOOGLE_PAY': _('Google Pay'),
}

PAYMENT_METHOD_CHOICES = [
    ('CREDIT_CARD', PAYMENT_METHODS['CREDIT_CARD']),
    ('DEBIT_CARD', PAYMENT_METHODS['DEBIT_CARD']),
    ('PAYPAL', PAYMENT_METHODS['PAYPAL']),
    ('BANK_TRANSFER', PAYMENT_METHODS['BANK_TRANSFER']),
    ('STRIPE', PAYMENT_METHODS['STRIPE']),
    ('CASH', PAYMENT_METHODS['CASH']),
    ('MOBILE_MONEY', PAYMENT_METHODS['MOBILE_MONEY']),
    ('CRYPTO', PAYMENT_METHODS['CRYPTO']),
    ('APPLE_PAY', PAYMENT_METHODS['APPLE_PAY']),
    ('GOOGLE_PAY', PAYMENT_METHODS['GOOGLE_PAY']),
]

# ============================================================================
# BUTS DES TRANSACTIONS
# ============================================================================

TRANSACTION_PURPOSES = {
    'AD_PROMOTION': _('Promotion d\'annonce'),
    'FEATURED_AD': _('Annonce en vedette'),
    'ADDITIONAL_IMAGES': _('Images supplémentaires'),
    'VIDEO_UPLOAD': _('Téléchargement de vidéo'),
    'MEMBERSHIP': _('Adhésion'),
    'SUBSCRIPTION': _('Abonnement'),
    'PRODUCT_PURCHASE': _('Achat de produit'),
    'SERVICE_PAYMENT': _('Paiement de service'),
    'DONATION': _('Don'),
    'DEPOSIT': _('Dépôt'),
    'WITHDRAWAL': _('Retrait'),
    'REFUND': _('Remboursement'),
    'COMMISSION': _('Commission'),
    'TAX': _('Taxe'),
    'SHIPPING': _('Livraison'),
    'INSURANCE': _('Assurance'),
    'OTHER': _('Autre'),
}

TRANSACTION_PURPOSE_CHOICES = [
    ('AD_PROMOTION', TRANSACTION_PURPOSES['AD_PROMOTION']),
    ('FEATURED_AD', TRANSACTION_PURPOSES['FEATURED_AD']),
    ('ADDITIONAL_IMAGES', TRANSACTION_PURPOSES['ADDITIONAL_IMAGES']),
    ('VIDEO_UPLOAD', TRANSACTION_PURPOSES['VIDEO_UPLOAD']),
    ('MEMBERSHIP', TRANSACTION_PURPOSES['MEMBERSHIP']),
    ('SUBSCRIPTION', TRANSACTION_PURPOSES['SUBSCRIPTION']),
    ('PRODUCT_PURCHASE', TRANSACTION_PURPOSES['PRODUCT_PURCHASE']),
    ('SERVICE_PAYMENT', TRANSACTION_PURPOSES['SERVICE_PAYMENT']),
    ('DONATION', TRANSACTION_PURPOSES['DONATION']),
    ('DEPOSIT', TRANSACTION_PURPOSES['DEPOSIT']),
    ('WITHDRAWAL', TRANSACTION_PURPOSES['WITHDRAWAL']),
    ('REFUND', TRANSACTION_PURPOSES['REFUND']),
    ('COMMISSION', TRANSACTION_PURPOSES['COMMISSION']),
    ('TAX', TRANSACTION_PURPOSES['TAX']),
    ('SHIPPING', TRANSACTION_PURPOSES['SHIPPING']),
    ('INSURANCE', TRANSACTION_PURPOSES['INSURANCE']),
    ('OTHER', TRANSACTION_PURPOSES['OTHER']),
]

# ============================================================================
# STATUTS DES FACTURES
# ============================================================================

INVOICE_STATUS = {
    'DRAFT': _('Brouillon'),
    'SENT': _('Envoyée'),
    'PAID': _('Payée'),
    'OVERDUE': _('En retard'),
    'CANCELED': _('Annulée'),
    'REFUNDED': _('Remboursée'),
}

INVOICE_STATUS_CHOICES = [
    ('DRAFT', INVOICE_STATUS['DRAFT']),
    ('SENT', INVOICE_STATUS['SENT']),
    ('PAID', INVOICE_STATUS['PAID']),
    ('OVERDUE', INVOICE_STATUS['OVERDUE']),
    ('CANCELED', INVOICE_STATUS['CANCELED']),
    ('REFUNDED', INVOICE_STATUS['REFUNDED']),
]

# ============================================================================
# STATUTS DES REMBOURSEMENTS
# ============================================================================

REFUND_STATUS = {
    'PENDING': _('En attente'),
    'PROCESSING': _('En traitement'),
    'COMPLETED': _('Complété'),
    'FAILED': _('Échoué'),
    'CANCELED': _('Annulé'),
}

REFUND_STATUS_CHOICES = [
    ('PENDING', REFUND_STATUS['PENDING']),
    ('PROCESSING', REFUND_STATUS['PROCESSING']),
    ('COMPLETED', REFUND_STATUS['COMPLETED']),
    ('FAILED', REFUND_STATUS['FAILED']),
    ('CANCELED', REFUND_STATUS['CANCELED']),
]

REFUND_REASONS = {
    'DUPLICATE_CHARGE': _('Double facturation'),
    'FRAUDULENT_CHARGE': _('Facturation frauduleuse'),
    'CANCELLED_ORDER': _('Commande annulée'),
    'DEFECTIVE_PRODUCT': _('Produit défectueux'),
    'NOT_AS_DESCRIBED': _('Non conforme à la description'),
    'DISSATISFIED_SERVICE': _('Service non satisfaisant'),
    'OTHER': _('Autre'),
}

REFUND_REASON_CHOICES = [
    ('DUPLICATE_CHARGE', REFUND_REASONS['DUPLICATE_CHARGE']),
    ('FRAUDULENT_CHARGE', REFUND_REASONS['FRAUDULENT_CHARGE']),
    ('CANCELLED_ORDER', REFUND_REASONS['CANCELLED_ORDER']),
    ('DEFECTIVE_PRODUCT', REFUND_REASONS['DEFECTIVE_PRODUCT']),
    ('NOT_AS_DESCRIBED', REFUND_REASONS['NOT_AS_DESCRIBED']),
    ('DISSATISFIED_SERVICE', REFUND_REASONS['DISSATISFIED_SERVICE']),
    ('OTHER', REFUND_REASONS['OTHER']),
]

# ============================================================================
# STATUTS DES ABONNEMENTS
# ============================================================================

SUBSCRIPTION_STATUS = {
    'PENDING': _('En attente'),
    'ACTIVE': _('Actif'),
    'PAST_DUE': _('En retard'),
    'CANCELED': _('Annulé'),
    'EXPIRED': _('Expiré'),
    'SUSPENDED': _('Suspendu'),
}

SUBSCRIPTION_STATUS_CHOICES = [
    ('PENDING', SUBSCRIPTION_STATUS['PENDING']),
    ('ACTIVE', SUBSCRIPTION_STATUS['ACTIVE']),
    ('PAST_DUE', SUBSCRIPTION_STATUS['PAST_DUE']),
    ('CANCELED', SUBSCRIPTION_STATUS['CANCELED']),
    ('EXPIRED', SUBSCRIPTION_STATUS['EXPIRED']),
    ('SUSPENDED', SUBSCRIPTION_STATUS['SUSPENDED']),
]

SUBSCRIPTION_INTERVALS = {
    'DAILY': _('Quotidien'),
    'WEEKLY': _('Hebdomadaire'),
    'MONTHLY': _('Mensuel'),
    'QUARTERLY': _('Trimestriel'),
    'SEMI_ANNUAL': _('Semestriel'),
    'ANNUAL': _('Annuel'),
}

SUBSCRIPTION_INTERVAL_CHOICES = [
    ('DAILY', SUBSCRIPTION_INTERVALS['DAILY']),
    ('WEEKLY', SUBSCRIPTION_INTERVALS['WEEKLY']),
    ('MONTHLY', SUBSCRIPTION_INTERVALS['MONTHLY']),
    ('QUARTERLY', SUBSCRIPTION_INTERVALS['QUARTERLY']),
    ('SEMI_ANNUAL', SUBSCRIPTION_INTERVALS['SEMI_ANNUAL']),
    ('ANNUAL', SUBSCRIPTION_INTERVALS['ANNUAL']),
]

# ============================================================================
# TYPES DE COUPONS
# ============================================================================

COUPON_TYPES = {
    'PERCENTAGE': _('Pourcentage'),
    'FIXED_AMOUNT': _('Montant fixe'),
    'FREE_SHIPPING': _('Livraison gratuite'),
}

COUPON_TYPE_CHOICES = [
    ('PERCENTAGE', COUPON_TYPES['PERCENTAGE']),
    ('FIXED_AMOUNT', COUPON_TYPES['FIXED_AMOUNT']),
    ('FREE_SHIPPING', COUPON_TYPES['FREE_SHIPPING']),
]

# ============================================================================
# TYPES DE TAXES
# ============================================================================

TAX_TYPES = {
    'VAT': _('TVA'),
    'GST': _('GST'),
    'SALES_TAX': _('Taxe de vente'),
    'SERVICE_TAX': _('Taxe sur les services'),
    'OTHER': _('Autre'),
}

TAX_TYPE_CHOICES = [
    ('VAT', TAX_TYPES['VAT']),
    ('GST', TAX_TYPES['GST']),
    ('SALES_TAX', TAX_TYPES['SALES_TAX']),
    ('SERVICE_TAX', TAX_TYPES['SERVICE_TAX']),
    ('OTHER', TAX_TYPES['OTHER']),
]

# ============================================================================
# DEVISES SUPPORTÉES
# ============================================================================

CURRENCIES = {
    'EUR': {'symbol': '€', 'name': _('Euro')},
    'USD': {'symbol': '$', 'name': _('Dollar américain')},
    'GBP': {'symbol': '£', 'name': _('Livre sterling')},
    'MAD': {'symbol': 'DH', 'name': _('Dirham marocain')},
    'XOF': {'symbol': 'CFA', 'name': _('Franc CFA')},
    'CAD': {'symbol': '$', 'name': _('Dollar canadien')},
    'AUD': {'symbol': '$', 'name': _('Dollar australien')},
    'JPY': {'symbol': '¥', 'name': _('Yen japonais')},
    'CHF': {'symbol': 'CHF', 'name': _('Franc suisse')},
    'CNY': {'symbol': '¥', 'name': _('Yuan chinois')},
    'INR': {'symbol': '₹', 'name': _('Roupie indienne')},
    'RUB': {'symbol': '₽', 'name': _('Rouble russe')},
    'BRL': {'symbol': 'R$', 'name': _('Real brésilien')},
    'ZAR': {'symbol': 'R', 'name': _('Rand sud-africain')},
}

CURRENCY_CHOICES = [
    ('EUR', f"€ - {CURRENCIES['EUR']['name']}"),
    ('USD', f"$ - {CURRENCIES['USD']['name']}"),
    ('GBP', f"£ - {CURRENCIES['GBP']['name']}"),
    ('MAD', f"DH - {CURRENCIES['MAD']['name']}"),
    ('XOF', f"CFA - {CURRENCIES['XOF']['name']}"),
    ('CAD', f"$ - {CURRENCIES['CAD']['name']}"),
    ('AUD', f"$ - {CURRENCIES['AUD']['name']}"),
    ('JPY', f"¥ - {CURRENCIES['JPY']['name']}"),
    ('CHF', f"CHF - {CURRENCIES['CHF']['name']}"),
    ('CNY', f"¥ - {CURRENCIES['CNY']['name']}"),
    ('INR', f"₹ - {CURRENCIES['INR']['name']}"),
    ('RUB', f"₽ - {CURRENCIES['RUB']['name']}"),
    ('BRL', f"R$ - {CURRENCIES['BRL']['name']}"),
    ('ZAR', f"R - {CURRENCIES['ZAR']['name']}"),
]

# ============================================================================
# PAYS POUR LES TAXES
# ============================================================================

EU_COUNTRIES = [
    'AT', 'BE', 'BG', 'CY', 'CZ', 'DE', 'DK', 'EE', 'ES', 'FI',
    'FR', 'GR', 'HR', 'HU', 'IE', 'IT', 'LT', 'LU', 'LV', 'MT',
    'NL', 'PL', 'PT', 'RO', 'SE', 'SI', 'SK'
]

# ============================================================================
# TAUX DE TVA STANDARD PAR PAYS (en %)
# ============================================================================

VAT_RATES = {
    'FR': 20.0,   # France
    'DE': 19.0,   # Allemagne
    'IT': 22.0,   # Italie
    'ES': 21.0,   # Espagne
    'BE': 21.0,   # Belgique
    'NL': 21.0,   # Pays-Bas
    'LU': 17.0,   # Luxembourg
    'AT': 20.0,   # Autriche
    'FI': 24.0,   # Finlande
    'SE': 25.0,   # Suède
    'DK': 25.0,   # Danemark
    'IE': 23.0,   # Irlande
    'PT': 23.0,   # Portugal
    'GR': 24.0,   # Grèce
    'PL': 23.0,   # Pologne
    'CZ': 21.0,   # République Tchèque
    'HU': 27.0,   # Hongrie
    'RO': 19.0,   # Roumanie
    'BG': 20.0,   # Bulgarie
    'HR': 25.0,   # Croatie
    'SI': 22.0,   # Slovénie
    'SK': 20.0,   # Slovaquie
    'EE': 20.0,   # Estonie
    'LV': 21.0,   # Lettonie
    'LT': 21.0,   # Lituanie
    'CY': 19.0,   # Chypre
    'MT': 18.0,   # Malte
}

# ============================================================================
# LIMITES ET CONFIGURATIONS
# ============================================================================

# Limites de montant (en devise par défaut)
MIN_TRANSACTION_AMOUNT = 0.01
MAX_TRANSACTION_AMOUNT = 100000.00

# Délais d'expiration (en secondes)
PAYMENT_SESSION_TIMEOUT = 1800  # 30 minutes
PENDING_TRANSACTION_TIMEOUT = 3600  # 1 heure

# Tentatives maximum
MAX_PAYMENT_ATTEMPTS = 3
MAX_REFUND_ATTEMPTS = 2

# Configuration des frais
PROCESSING_FEE_PERCENTAGE = 2.9  # 2.9%
PROCESSING_FEE_FIXED = 0.30      # 0.30 unités de devise
MIN_PROCESSING_FEE = 0.50

# Configuration des remboursements
REFUND_PROCESSING_DAYS = {
    'CREDIT_CARD': 5,
    'PAYPAL': 3,
    'BANK_TRANSFER': 7,
    'CASH': 0,
}

# ============================================================================
# ERREURS ET CODES
# ============================================================================

ERROR_CODES = {
    # Erreurs générales
    'INVALID_REQUEST': 'PAYMENT_001',
    'MISSING_PARAMETER': 'PAYMENT_002',
    'INVALID_PARAMETER': 'PAYMENT_003',
    'UNAUTHORIZED': 'PAYMENT_004',
    'FORBIDDEN': 'PAYMENT_005',
    'NOT_FOUND': 'PAYMENT_006',
    'RATE_LIMIT_EXCEEDED': 'PAYMENT_007',

    # Erreurs de paiement
    'INSUFFICIENT_FUNDS': 'PAYMENT_101',
    'CARD_DECLINED': 'PAYMENT_102',
    'EXPIRED_CARD': 'PAYMENT_103',
    'INVALID_CARD': 'PAYMENT_104',
    'INVALID_CVV': 'PAYMENT_105',
    'PROCESSING_ERROR': 'PAYMENT_106',
    'GATEWAY_ERROR': 'PAYMENT_107',
    'TIMEOUT': 'PAYMENT_108',

    # Erreurs de remboursement
    'REFUND_NOT_ALLOWED': 'PAYMENT_201',
    'REFUND_AMOUNT_EXCEEDED': 'PAYMENT_202',
    'REFUND_TIME_LIMIT_EXCEEDED': 'PAYMENT_203',
    'REFUND_PROCESSING_ERROR': 'PAYMENT_204',

    # Erreurs de sécurité
    'FRAUD_DETECTED': 'PAYMENT_301',
    'SECURITY_VIOLATION': 'PAYMENT_302',
    'SUSPICIOUS_ACTIVITY': 'PAYMENT_303',

    # Erreurs de configuration
    'CONFIGURATION_ERROR': 'PAYMENT_401',
    'GATEWAY_NOT_CONFIGURED': 'PAYMENT_402',

    # Erreurs de devise
    'CURRENCY_NOT_SUPPORTED': 'PAYMENT_501',
    'CURRENCY_MISMATCH': 'PAYMENT_502',

    # Erreurs de taxe
    'TAX_CALCULATION_ERROR': 'PAYMENT_601',
    'INVALID_TAX_RATE': 'PAYMENT_602',
}

# ============================================================================
# REGEX ET FORMATS
# ============================================================================

REGEX_PATTERNS = {
    'CREDIT_CARD': r'^[0-9]{13,19}$',
    'CVV': r'^[0-9]{3,4}$',
    'EXPIRY_DATE': r'^(0[1-9]|1[0-2])/([0-9]{2})$',
    'IBAN': r'^[A-Z]{2}[0-9]{2}[A-Z0-9]{1,30}$',
    'BIC': r'^[A-Z]{6}[A-Z0-9]{2}([A-Z0-9]{3})?$',
    'EMAIL': r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$',
    'PHONE': r'^\+[1-9]\d{1,14}$',
}

# ============================================================================
# NOMS DE FICHIERS ET PATHS
# ============================================================================

FILE_PATHS = {
    'INVOICE_PDFS': 'invoices/pdfs/',
    'RECEIPT_PDFS': 'receipts/pdfs/',
    'PAYMENT_PROOFS': 'payments/proofs/',
    'REFUND_DOCUMENTS': 'refunds/documents/',
}

# ============================================================================
# NOMS DES ÉVÉNEMENTS WEBHOOK
# ============================================================================

WEBHOOK_EVENTS = {
    'STRIPE': [
        'payment_intent.succeeded',
        'payment_intent.payment_failed',
        'payment_intent.canceled',
        'charge.refunded',
        'charge.dispute.created',
        'invoice.payment_succeeded',
        'invoice.payment_failed',
        'customer.subscription.created',
        'customer.subscription.updated',
        'customer.subscription.deleted',
    ],
    'PAYPAL': [
        'PAYMENT.CAPTURE.COMPLETED',
        'PAYMENT.CAPTURE.DENIED',
        'PAYMENT.CAPTURE.REFUNDED',
        'PAYMENT.CAPTURE.REVERSED',
        'BILLING.SUBSCRIPTION.ACTIVATED',
        'BILLING.SUBSCRIPTION.CANCELLED',
    ],
}

# ============================================================================
# MESSAGES DE SUCCÈS
# ============================================================================

SUCCESS_MESSAGES = {
    'PAYMENT_COMPLETED': _('Paiement effectué avec succès.'),
    'REFUND_PROCESSED': _('Remboursement traité avec succès.'),
    'INVOICE_GENERATED': _('Facture générée avec succès.'),
    'SUBSCRIPTION_ACTIVATED': _('Abonnement activé avec succès.'),
    'COUPON_APPLIED': _('Coupon appliqué avec succès.'),
}

# ============================================================================
# CONFIGURATION PAR DÉFAUT
# ============================================================================

DEFAULT_CONFIG = {
    'DEFAULT_CURRENCY': 'EUR',
    'DEFAULT_TIMEZONE': 'Europe/Paris',
    'DEFAULT_LANGUAGE': 'fr',
    'DEFAULT_DATE_FORMAT': 'd/m/Y',
    'DEFAULT_DATETIME_FORMAT': 'd/m/Y H:i:s',
    'RECORDS_PER_PAGE': 20,
    'AUTO_GENERATE_INVOICE': True,
    'SEND_PAYMENT_EMAILS': True,
    'ENABLE_TAX_CALCULATION': True,
}

# ============================================================================
# VERSIONS D'API
# ============================================================================

API_VERSIONS = {
    'V1': '1.0',
    'V2': '2.0',
    'CURRENT': '1.0',
}

# ============================================================================
# PERMISSIONS
# ============================================================================

PERMISSIONS = {
    'VIEW_TRANSACTIONS': 'payments.view_transaction',
    'ADD_TRANSACTIONS': 'payments.add_transaction',
    'CHANGE_TRANSACTIONS': 'payments.change_transaction',
    'DELETE_TRANSACTIONS': 'payments.delete_transaction',
    'PROCESS_REFUNDS': 'payments.process_refunds',
    'VIEW_INVOICES': 'payments.view_invoice',
    'GENERATE_INVOICES': 'payments.generate_invoice',
    'MANAGE_SUBSCRIPTIONS': 'payments.manage_subscriptions',
    'VIEW_REPORTS': 'payments.view_reports',
}

# ============================================================================
# NOMS DES BACKENDS DE PAIEMENT
# ============================================================================

PAYMENT_BACKENDS = {
    'STRIPE': 'stripe',
    'PAYPAL': 'paypal',
    'BANK_TRANSFER': 'bank_transfer',
    'CASH_ON_DELIVERY': 'cash_on_delivery',
    'MOBILE_MONEY': 'mobile_money',
}


========== payments/migrations/0002_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("ads", "0002_initial"),
        ("carriers", "0002_initial"),
        ("logistics", "0001_initial"),
        ("payments", "0001_initial"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name="auditlog",
            name="user",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AlterUniqueTogether(
            name="exchangerate",
            unique_together={("base_currency", "target_currency")},
        ),
        migrations.AddField(
            model_name="fraudalert",
            name="reviewed_by",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                to=settings.AUTH_USER_MODEL,
                verbose_name="Revu par",
            ),
        ),
        migrations.AddField(
            model_name="invoiceitem",
            name="invoice",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="items",
                to="payments.invoice",
                verbose_name="Facture",
            ),
        ),
        migrations.AddField(
            model_name="paymentcard",
            name="user",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="payment_cards",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="paymentmethod",
            name="user",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="payment_methods",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="paymentsession",
            name="user",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="payment_sessions",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="paymenttransaction",
            name="ad",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="payments",
                to="ads.ad",
                verbose_name="Annonce liée",
            ),
        ),
        migrations.AddField(
            model_name="paymenttransaction",
            name="carrier",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="payments",
                to="carriers.carrier",
                verbose_name="Transporteur lié",
            ),
        ),
        migrations.AddField(
            model_name="paymenttransaction",
            name="mission",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="payments",
                to="logistics.mission",
                verbose_name="Mission liée",
            ),
        ),
        migrations.AddField(
            model_name="paymenttransaction",
            name="payee",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.PROTECT,
                related_name="payment_received",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Bénéficiaire",
            ),
        ),
        migrations.AddField(
            model_name="paymenttransaction",
            name="payer",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.PROTECT,
                related_name="payment_sent",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Payeur",
            ),
        ),
        migrations.AddField(
            model_name="paymenttransaction",
            name="transport_proposal",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="payments",
                to="logistics.transportproposal",
                verbose_name="Proposition transport liée",
            ),
        ),
        migrations.AddField(
            model_name="invoice",
            name="transaction",
            field=models.OneToOneField(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="invoice",
                to="payments.paymenttransaction",
                verbose_name="Transaction",
            ),
        ),
        migrations.AddField(
            model_name="fraudalert",
            name="transaction",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="fraud_alerts",
                to="payments.paymenttransaction",
                verbose_name="Transaction",
            ),
        ),
        migrations.AddField(
            model_name="commission",
            name="transaction",
            field=models.OneToOneField(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="commission",
                to="payments.paymenttransaction",
                verbose_name="Transaction",
            ),
        ),
        migrations.AddField(
            model_name="payout",
            name="transactions",
            field=models.ManyToManyField(
                related_name="payouts",
                to="payments.paymenttransaction",
                verbose_name="Transactions incluses",
            ),
        ),
        migrations.AddField(
            model_name="payout",
            name="user",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.PROTECT,
                related_name="payouts",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Bénéficiaire",
            ),
        ),
        migrations.AddField(
            model_name="refund",
            name="requested_by",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.PROTECT,
                related_name="refunds_requested",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Demandé par",
            ),
        ),
        migrations.AddField(
            model_name="refund",
            name="reviewed_by",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="refunds_reviewed",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Revu par",
            ),
        ),
        migrations.AddField(
            model_name="refund",
            name="transaction",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.PROTECT,
                related_name="refunds",
                to="payments.paymenttransaction",
                verbose_name="Transaction originale",
            ),
        ),
        migrations.AddField(
            model_name="subscription",
            name="plan",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.PROTECT,
                related_name="subscriptions",
                to="payments.plan",
                verbose_name="Plan",
            ),
        ),
        migrations.AddField(
            model_name="subscription",
            name="user",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="subscriptions",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="wallet",
            name="user",
            field=models.OneToOneField(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="wallet",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="wallettransaction",
            name="payment_transaction",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="wallet_transactions",
                to="payments.paymenttransaction",
                verbose_name="Transaction de paiement liée",
            ),
        ),
        migrations.AddField(
            model_name="wallettransaction",
            name="wallet",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="transactions",
                to="payments.wallet",
                verbose_name="Portefeuille",
            ),
        ),
        migrations.AddIndex(
            model_name="auditlog",
            index=models.Index(
                fields=["user", "created_at"], name="payments_au_user_id_52d5af_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="auditlog",
            index=models.Index(
                fields=["object_type", "object_id"],
                name="payments_au_object__ed6e2c_idx",
            ),
        ),
        migrations.AlterUniqueTogether(
            name="paymentcard",
            unique_together={("user", "token")},
        ),
        migrations.AlterUniqueTogether(
            name="paymentmethod",
            unique_together={("user", "encryption_key_id")},
        ),
        migrations.AddIndex(
            model_name="paymenttransaction",
            index=models.Index(
                fields=["status", "created_at"], name="payments_pa_status_c4e513_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="paymenttransaction",
            index=models.Index(
                fields=["payer", "status"], name="payments_pa_payer_i_2437ab_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="paymenttransaction",
            index=models.Index(
                fields=["payee", "status"], name="payments_pa_payee_i_59280c_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="paymenttransaction",
            index=models.Index(
                fields=["payment_type", "status"], name="payments_pa_payment_c7d4e5_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="paymenttransaction",
            index=models.Index(
                fields=["reference"], name="payments_pa_referen_72073c_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="paymenttransaction",
            index=models.Index(
                fields=["payment_gateway_id"], name="payments_pa_payment_8e4726_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="invoice",
            index=models.Index(
                fields=["invoice_number"], name="payments_in_invoice_3fa711_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="invoice",
            index=models.Index(
                fields=["status", "due_date"], name="payments_in_status_68daea_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="payout",
            index=models.Index(
                fields=["status", "created_at"], name="payments_pa_status_2b7eb1_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="payout",
            index=models.Index(
                fields=["user", "status"], name="payments_pa_user_id_024e9b_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="refund",
            index=models.Index(
                fields=["status", "created_at"], name="payments_re_status_698972_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="refund",
            index=models.Index(
                fields=["transaction", "status"], name="payments_re_transac_a3e947_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="subscription",
            index=models.Index(
                fields=["user", "status"], name="payments_su_user_id_058311_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="subscription",
            index=models.Index(
                fields=["current_period_end"], name="payments_su_current_d26b0c_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="wallettransaction",
            index=models.Index(
                fields=["wallet", "created_at"], name="payments_wa_wallet__9a8a81_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="wallettransaction",
            index=models.Index(
                fields=["transaction_type", "created_at"],
                name="payments_wa_transac_b3760c_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="wallettransaction",
            index=models.Index(
                fields=["status", "created_at"], name="payments_wa_status_d9255e_idx"
            ),
        ),
    ]



========== payments/migrations/0001_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import django.core.validators
import django.utils.timezone
import django_countries.fields
import uuid
from decimal import Decimal
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name="AuditLog",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "action_type",
                    models.CharField(
                        choices=[
                            ("CREATE", "Création"),
                            ("UPDATE", "Mise à jour"),
                            ("DELETE", "Suppression"),
                            ("APPROVE", "Approbation"),
                            ("REJECT", "Rejet"),
                            ("REFUND", "Remboursement"),
                            ("PAYOUT", "Versement"),
                            ("LOGIN", "Connexion"),
                            ("LOGOUT", "Déconnexion"),
                            ("WALLET_LOGIN", "Connexion portefeuille"),
                            ("WALLET_PIN_CHANGE", "Changement PIN portefeuille"),
                            (
                                "WALLET_SECURITY_CHANGE",
                                "Changement sécurité portefeuille",
                            ),
                            ("WALLET_CREATION", "Création portefeuille"),
                        ],
                        max_length=50,
                        verbose_name="Type d'action",
                    ),
                ),
                (
                    "action_description",
                    models.TextField(verbose_name="Description de l'action"),
                ),
                (
                    "object_type",
                    models.CharField(max_length=100, verbose_name="Type d'objet"),
                ),
                (
                    "object_id",
                    models.CharField(max_length=100, verbose_name="ID de l'objet"),
                ),
                (
                    "old_data",
                    models.JSONField(
                        blank=True, null=True, verbose_name="Anciennes données"
                    ),
                ),
                (
                    "new_data",
                    models.JSONField(
                        blank=True, null=True, verbose_name="Nouvelles données"
                    ),
                ),
                (
                    "ip_address",
                    models.GenericIPAddressField(
                        blank=True, null=True, verbose_name="Adresse IP"
                    ),
                ),
                ("user_agent", models.TextField(blank=True, verbose_name="User Agent")),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
            ],
            options={
                "verbose_name": "Journal d'audit",
                "verbose_name_plural": "Journaux d'audit",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="Commission",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "commission_rate",
                    models.DecimalField(
                        decimal_places=4,
                        max_digits=5,
                        verbose_name="Taux de commission",
                    ),
                ),
                (
                    "commission_amount",
                    models.DecimalField(
                        decimal_places=4,
                        max_digits=12,
                        verbose_name="Montant commission",
                    ),
                ),
                (
                    "vat_on_commission",
                    models.DecimalField(
                        decimal_places=4,
                        default=0,
                        max_digits=12,
                        verbose_name="TVA sur commission",
                    ),
                ),
                (
                    "net_commission",
                    models.DecimalField(
                        decimal_places=4, max_digits=12, verbose_name="Commission nette"
                    ),
                ),
                (
                    "is_paid",
                    models.BooleanField(default=False, verbose_name="Commission payée"),
                ),
                (
                    "paid_at",
                    models.DateTimeField(blank=True, null=True, verbose_name="Payé le"),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Commission",
                "verbose_name_plural": "Commissions",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="Coupon",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "code",
                    models.CharField(max_length=50, unique=True, verbose_name="Code"),
                ),
                (
                    "discount_type",
                    models.CharField(
                        choices=[
                            ("PERCENTAGE", "Pourcentage"),
                            ("FIXED_AMOUNT", "Montant fixe"),
                            ("FREE_SHIPPING", "Livraison gratuite"),
                        ],
                        max_length=20,
                        verbose_name="Type de réduction",
                    ),
                ),
                (
                    "discount_value",
                    models.DecimalField(
                        decimal_places=2,
                        max_digits=10,
                        verbose_name="Valeur de la réduction",
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        blank=True,
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                            ("XAF", "FCFA"),
                            ("TND", "DT"),
                            ("DZD", "DA"),
                        ],
                        max_length=3,
                        null=True,
                        verbose_name="Devise (pour montant fixe)",
                    ),
                ),
                ("valid_from", models.DateTimeField(verbose_name="Valide à partir de")),
                ("valid_until", models.DateTimeField(verbose_name="Valide jusqu'à")),
                (
                    "max_uses",
                    models.PositiveIntegerField(
                        default=1, verbose_name="Utilisations maximum"
                    ),
                ),
                (
                    "used_count",
                    models.PositiveIntegerField(default=0, verbose_name="Utilisations"),
                ),
                ("is_active", models.BooleanField(default=True, verbose_name="Actif")),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Coupon",
                "verbose_name_plural": "Coupons",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="Currency",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "code",
                    models.CharField(
                        max_length=3, unique=True, verbose_name="Code devise"
                    ),
                ),
                (
                    "name",
                    models.CharField(max_length=50, verbose_name="Nom de la devise"),
                ),
                ("symbol", models.CharField(max_length=5, verbose_name="Symbole")),
                ("is_active", models.BooleanField(default=True, verbose_name="Active")),
                (
                    "exchange_rate",
                    models.DecimalField(
                        decimal_places=6,
                        default=1.0,
                        max_digits=10,
                        verbose_name="Taux de change",
                    ),
                ),
                (
                    "display_order",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Ordre d'affichage"
                    ),
                ),
            ],
            options={
                "verbose_name": "Devise",
                "verbose_name_plural": "Devises",
                "ordering": ["display_order", "code"],
            },
        ),
        migrations.CreateModel(
            name="ExchangeRate",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "base_currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                            ("XAF", "FCFA"),
                            ("TND", "DT"),
                            ("DZD", "DA"),
                        ],
                        max_length=3,
                        verbose_name="Devise de base",
                    ),
                ),
                (
                    "target_currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                            ("XAF", "FCFA"),
                            ("TND", "DT"),
                            ("DZD", "DA"),
                        ],
                        max_length=3,
                        verbose_name="Devise cible",
                    ),
                ),
                (
                    "rate",
                    models.DecimalField(
                        decimal_places=6, max_digits=10, verbose_name="Taux"
                    ),
                ),
                (
                    "last_updated",
                    models.DateTimeField(
                        auto_now=True, verbose_name="Dernière mise à jour"
                    ),
                ),
                ("source", models.CharField(max_length=50, verbose_name="Source")),
                ("is_active", models.BooleanField(default=True, verbose_name="Actif")),
            ],
            options={
                "verbose_name": "Taux de change",
                "verbose_name_plural": "Taux de change",
            },
        ),
        migrations.CreateModel(
            name="FraudAlert",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "detected_at",
                    models.DateTimeField(auto_now_add=True, verbose_name="Détecté le"),
                ),
                (
                    "severity",
                    models.CharField(
                        choices=[
                            ("LOW", "Faible"),
                            ("MEDIUM", "Moyen"),
                            ("HIGH", "Élevé"),
                            ("CRITICAL", "Critique"),
                        ],
                        max_length=20,
                        verbose_name="Sévérité",
                    ),
                ),
                (
                    "fraud_score",
                    models.DecimalField(
                        decimal_places=2, max_digits=5, verbose_name="Score de fraude"
                    ),
                ),
                ("reasons", models.JSONField(verbose_name="Raisons de l'alerte")),
                (
                    "action_taken",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Action prise"
                    ),
                ),
                (
                    "reviewed_at",
                    models.DateTimeField(blank=True, null=True, verbose_name="Revu le"),
                ),
                (
                    "review_notes",
                    models.TextField(blank=True, verbose_name="Notes de revue"),
                ),
                (
                    "is_resolved",
                    models.BooleanField(default=False, verbose_name="Résolu"),
                ),
                (
                    "resolved_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Résolu le"
                    ),
                ),
                (
                    "resolution_notes",
                    models.TextField(blank=True, verbose_name="Notes de résolution"),
                ),
            ],
            options={
                "verbose_name": "Alerte de fraude",
                "verbose_name_plural": "Alertes de fraude",
                "ordering": ["-detected_at"],
            },
        ),
        migrations.CreateModel(
            name="Invoice",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "invoice_number",
                    models.CharField(
                        db_index=True,
                        max_length=50,
                        unique=True,
                        verbose_name="Numéro de facture",
                    ),
                ),
                (
                    "billing_name",
                    models.CharField(max_length=200, verbose_name="Nom de facturation"),
                ),
                (
                    "billing_address",
                    models.TextField(verbose_name="Adresse de facturation"),
                ),
                (
                    "billing_country",
                    django_countries.fields.CountryField(
                        max_length=2, verbose_name="Pays de facturation"
                    ),
                ),
                (
                    "billing_vat",
                    models.CharField(
                        blank=True, max_length=50, verbose_name="Numéro TVA"
                    ),
                ),
                (
                    "subtotal",
                    models.DecimalField(
                        decimal_places=4, max_digits=12, verbose_name="Sous-total"
                    ),
                ),
                (
                    "tax_rate",
                    models.DecimalField(
                        decimal_places=2,
                        default=0,
                        max_digits=5,
                        verbose_name="Taux TVA (%)",
                    ),
                ),
                (
                    "tax_amount",
                    models.DecimalField(
                        decimal_places=4, max_digits=12, verbose_name="Montant TVA"
                    ),
                ),
                (
                    "total_amount",
                    models.DecimalField(
                        decimal_places=4, max_digits=12, verbose_name="Montant total"
                    ),
                ),
                (
                    "invoice_date",
                    models.DateField(
                        default=django.utils.timezone.now,
                        verbose_name="Date de facture",
                    ),
                ),
                ("due_date", models.DateField(verbose_name="Date d'échéance")),
                (
                    "paid_date",
                    models.DateField(
                        blank=True, null=True, verbose_name="Date de paiement"
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("DRAFT", "Brouillon"),
                            ("SENT", "Envoyée"),
                            ("PAID", "Payée"),
                            ("OVERDUE", "En retard"),
                            ("CANCELLED", "Annulée"),
                        ],
                        default="DRAFT",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "notes",
                    models.TextField(blank=True, verbose_name="Notes additionnelles"),
                ),
                (
                    "pdf_file",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="invoices/%Y/%m/",
                        verbose_name="Fichier PDF",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Facture",
                "verbose_name_plural": "Factures",
                "ordering": ["-invoice_date"],
            },
        ),
        migrations.CreateModel(
            name="InvoiceItem",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "description",
                    models.CharField(max_length=255, verbose_name="Description"),
                ),
                (
                    "quantity",
                    models.DecimalField(
                        decimal_places=2,
                        default=1,
                        max_digits=10,
                        verbose_name="Quantité",
                    ),
                ),
                (
                    "unit_price",
                    models.DecimalField(
                        decimal_places=4, max_digits=12, verbose_name="Prix unitaire"
                    ),
                ),
                (
                    "tax_rate",
                    models.DecimalField(
                        decimal_places=2,
                        default=0,
                        max_digits=5,
                        verbose_name="Taux de taxe (%)",
                    ),
                ),
                (
                    "created_at",
                    models.DateTimeField(
                        auto_now_add=True, verbose_name="Date de création"
                    ),
                ),
                (
                    "updated_at",
                    models.DateTimeField(
                        auto_now=True, verbose_name="Date de modification"
                    ),
                ),
            ],
            options={
                "verbose_name": "Élément de facture",
                "verbose_name_plural": "Éléments de facture",
                "ordering": ["created_at"],
            },
        ),
        migrations.CreateModel(
            name="PaymentCard",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "last_four",
                    models.CharField(max_length=4, verbose_name="4 derniers chiffres"),
                ),
                (
                    "expiry_month",
                    models.CharField(max_length=2, verbose_name="Mois d'expiration"),
                ),
                (
                    "expiry_year",
                    models.CharField(max_length=4, verbose_name="Année d'expiration"),
                ),
                (
                    "cardholder_name",
                    models.CharField(max_length=100, verbose_name="Nom du titulaire"),
                ),
                (
                    "card_type",
                    models.CharField(
                        choices=[
                            ("VISA", "Visa"),
                            ("MASTERCARD", "Mastercard"),
                            ("AMEX", "American Express"),
                            ("DISCOVER", "Discover"),
                            ("DINERS", "Diners Club"),
                            ("JCB", "JCB"),
                            ("UNKNOWN", "Inconnu"),
                        ],
                        default="UNKNOWN",
                        max_length=20,
                        verbose_name="Type de carte",
                    ),
                ),
                (
                    "token",
                    models.CharField(
                        blank=True, max_length=255, verbose_name="Token sécurisé"
                    ),
                ),
                (
                    "provider",
                    models.CharField(
                        default="STRIPE", max_length=50, verbose_name="Fournisseur"
                    ),
                ),
                (
                    "is_default",
                    models.BooleanField(default=False, verbose_name="Carte par défaut"),
                ),
                ("is_active", models.BooleanField(default=True, verbose_name="Active")),
                (
                    "is_verified",
                    models.BooleanField(default=False, verbose_name="Vérifiée"),
                ),
                (
                    "last_used",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Dernière utilisation"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Carte bancaire",
                "verbose_name_plural": "Cartes bancaires",
                "ordering": ["-is_default", "-last_used"],
            },
        ),
        migrations.CreateModel(
            name="PaymentMethod",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "method_type",
                    models.CharField(
                        choices=[
                            ("CARD", "Carte bancaire"),
                            ("BANK_ACCOUNT", "Compte bancaire"),
                            ("DIGITAL_WALLET", "Portefeuille numérique"),
                            ("MOBILE_MONEY", "Mobile Money"),
                        ],
                        max_length=20,
                        verbose_name="Type de méthode",
                    ),
                ),
                (
                    "is_default",
                    models.BooleanField(
                        default=False, verbose_name="Méthode par défaut"
                    ),
                ),
                (
                    "is_verified",
                    models.BooleanField(default=False, verbose_name="Vérifiée"),
                ),
                (
                    "encrypted_data",
                    models.TextField(editable=False, verbose_name="Données chiffrées"),
                ),
                (
                    "encryption_key_id",
                    models.CharField(
                        editable=False,
                        max_length=100,
                        verbose_name="ID clé de chiffrement",
                    ),
                ),
                (
                    "last_used",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Dernière utilisation"
                    ),
                ),
                ("is_active", models.BooleanField(default=True, verbose_name="Active")),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Méthode de paiement",
                "verbose_name_plural": "Méthodes de paiement",
                "ordering": ["-is_default", "-last_used"],
            },
        ),
        migrations.CreateModel(
            name="PaymentSession",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "session_id",
                    models.UUIDField(
                        default=uuid.uuid4,
                        editable=False,
                        unique=True,
                        verbose_name="ID de session",
                    ),
                ),
                (
                    "amount",
                    models.DecimalField(
                        decimal_places=4, max_digits=12, verbose_name="Montant"
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                            ("XAF", "FCFA"),
                            ("TND", "DT"),
                            ("DZD", "DA"),
                        ],
                        default="EUR",
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "payment_method",
                    models.CharField(
                        choices=[
                            ("CREDIT_CARD", "Carte de crédit"),
                            ("DEBIT_CARD", "Carte de débit"),
                            ("PAYPAL", "PayPal"),
                            ("STRIPE", "Stripe"),
                            ("BANK_TRANSFER", "Virement bancaire"),
                            ("CASH", "Espèces"),
                            ("EBI3_WALLET", "Portefeuille Ebi3"),
                            ("PAYSTACK", "Paystack"),
                            ("CINETPAY", "CinetPay"),
                            ("ORANGE_MONEY", "Orange Money"),
                            ("MTN_MONEY", "MTN Money"),
                        ],
                        max_length=20,
                        verbose_name="Méthode de paiement",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("PROCESSING", "En traitement"),
                            ("COMPLETED", "Complété"),
                            ("FAILED", "Échoué"),
                            ("REFUNDED", "Remboursé"),
                            ("PARTIALLY_REFUNDED", "Partiellement remboursé"),
                            ("CANCELLED", "Annulé"),
                            ("EXPIRED", "Expiré"),
                            ("DISPUTED", "En litige"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "metadata",
                    models.JSONField(
                        blank=True, default=dict, verbose_name="Métadonnées"
                    ),
                ),
                ("expires_at", models.DateTimeField(verbose_name="Expire à")),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Session de paiement",
                "verbose_name_plural": "Sessions de paiement",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="PaymentTransaction",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "transaction_id",
                    models.UUIDField(
                        default=uuid.uuid4,
                        editable=False,
                        unique=True,
                        verbose_name="ID transaction",
                    ),
                ),
                (
                    "reference",
                    models.CharField(
                        db_index=True,
                        max_length=50,
                        unique=True,
                        verbose_name="Référence transaction",
                    ),
                ),
                (
                    "amount",
                    models.DecimalField(
                        decimal_places=4,
                        max_digits=12,
                        validators=[
                            django.core.validators.MinValueValidator(Decimal("0.01"))
                        ],
                        verbose_name="Montant",
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                            ("XAF", "FCFA"),
                            ("TND", "DT"),
                            ("DZD", "DA"),
                        ],
                        default="EUR",
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "exchange_rate",
                    models.DecimalField(
                        decimal_places=6,
                        default=1.0,
                        max_digits=10,
                        verbose_name="Taux de change",
                    ),
                ),
                (
                    "amount_converted",
                    models.DecimalField(
                        decimal_places=4,
                        editable=False,
                        max_digits=12,
                        verbose_name="Montant converti",
                    ),
                ),
                (
                    "fee_amount",
                    models.DecimalField(
                        decimal_places=4,
                        default=0,
                        max_digits=12,
                        verbose_name="Frais de transaction",
                    ),
                ),
                (
                    "tax_amount",
                    models.DecimalField(
                        decimal_places=4,
                        default=0,
                        max_digits=12,
                        verbose_name="Montant taxes",
                    ),
                ),
                (
                    "net_amount",
                    models.DecimalField(
                        decimal_places=4,
                        editable=False,
                        max_digits=12,
                        verbose_name="Montant net",
                    ),
                ),
                (
                    "payment_type",
                    models.CharField(
                        choices=[
                            ("AD_PURCHASE", "Achat annonce"),
                            ("AD_FEATURED", "Mise en vedette"),
                            ("AD_RESERVATION", "Réservation annonce"),
                            ("MISSION_PAYMENT", "Paiement mission"),
                            ("CARRIER_PAYOUT", "Versement transporteur"),
                            ("COMMISSION", "Commission Ebi3"),
                            ("WALLET_TOPUP", "Rechargement portefeuille"),
                            ("WALLET_TRANSFER", "Transfert portefeuille"),
                            ("REFUND", "Remboursement"),
                            ("SUBSCRIPTION", "Abonnement"),
                            ("OTHER", "Autre"),
                        ],
                        max_length=20,
                        verbose_name="Type de paiement",
                    ),
                ),
                (
                    "payment_method",
                    models.CharField(
                        choices=[
                            ("CREDIT_CARD", "Carte de crédit"),
                            ("DEBIT_CARD", "Carte de débit"),
                            ("PAYPAL", "PayPal"),
                            ("STRIPE", "Stripe"),
                            ("BANK_TRANSFER", "Virement bancaire"),
                            ("CASH", "Espèces"),
                            ("EBI3_WALLET", "Portefeuille Ebi3"),
                            ("PAYSTACK", "Paystack"),
                            ("CINETPAY", "CinetPay"),
                            ("ORANGE_MONEY", "Orange Money"),
                            ("MTN_MONEY", "MTN Money"),
                        ],
                        max_length=20,
                        verbose_name="Méthode de paiement",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("PROCESSING", "En traitement"),
                            ("COMPLETED", "Complété"),
                            ("FAILED", "Échoué"),
                            ("REFUNDED", "Remboursé"),
                            ("PARTIALLY_REFUNDED", "Partiellement remboursé"),
                            ("CANCELLED", "Annulé"),
                            ("EXPIRED", "Expiré"),
                            ("DISPUTED", "En litige"),
                        ],
                        db_index=True,
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "payment_token",
                    models.CharField(
                        blank=True,
                        editable=False,
                        max_length=255,
                        verbose_name="Token de paiement",
                    ),
                ),
                (
                    "payment_gateway_id",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="ID passerelle"
                    ),
                ),
                (
                    "payment_gateway_data",
                    models.JSONField(
                        blank=True, null=True, verbose_name="Données passerelle"
                    ),
                ),
                (
                    "three_d_secure",
                    models.BooleanField(default=False, verbose_name="3D Secure activé"),
                ),
                (
                    "three_d_secure_status",
                    models.CharField(
                        blank=True,
                        choices=[
                            ("NOT_SUPPORTED", "Non supporté"),
                            ("SUCCESS", "Succès"),
                            ("FAILED", "Échoué"),
                            ("SKIPPED", "Ignoré"),
                        ],
                        max_length=20,
                        verbose_name="Statut 3D Secure",
                    ),
                ),
                (
                    "fraud_score",
                    models.DecimalField(
                        decimal_places=2,
                        default=0,
                        max_digits=5,
                        verbose_name="Score fraude",
                    ),
                ),
                (
                    "ip_address",
                    models.GenericIPAddressField(
                        blank=True, null=True, verbose_name="Adresse IP"
                    ),
                ),
                ("user_agent", models.TextField(blank=True, verbose_name="User Agent")),
                (
                    "risk_checked",
                    models.BooleanField(
                        default=False, verbose_name="Contrôle risque effectué"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("completed_at", models.DateTimeField(blank=True, null=True)),
                ("expires_at", models.DateTimeField(blank=True, null=True)),
                (
                    "metadata",
                    models.JSONField(blank=True, null=True, verbose_name="Métadonnées"),
                ),
                ("notes", models.TextField(blank=True, verbose_name="Notes internes")),
            ],
            options={
                "verbose_name": "Transaction de paiement",
                "verbose_name_plural": "Transactions de paiement",
                "ordering": ["-created_at"],
                "permissions": [
                    ("can_view_all_transactions", "Peut voir toutes les transactions"),
                    ("can_refund_transactions", "Peut effectuer des remboursements"),
                    (
                        "can_export_financial_data",
                        "Peut exporter les données financières",
                    ),
                    ("can_manage_fraud_detection", "Peut gérer la détection de fraude"),
                ],
            },
        ),
        migrations.CreateModel(
            name="Payout",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "payout_id",
                    models.UUIDField(
                        default=uuid.uuid4,
                        editable=False,
                        unique=True,
                        verbose_name="ID versement",
                    ),
                ),
                (
                    "amount",
                    models.DecimalField(
                        decimal_places=4,
                        max_digits=12,
                        validators=[
                            django.core.validators.MinValueValidator(Decimal("0.01"))
                        ],
                        verbose_name="Montant",
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                            ("XAF", "FCFA"),
                            ("TND", "DT"),
                            ("DZD", "DA"),
                        ],
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "fee_amount",
                    models.DecimalField(
                        decimal_places=4,
                        default=0,
                        max_digits=12,
                        verbose_name="Frais de versement",
                    ),
                ),
                (
                    "net_amount",
                    models.DecimalField(
                        decimal_places=4, max_digits=12, verbose_name="Montant net"
                    ),
                ),
                (
                    "payout_method",
                    models.CharField(
                        choices=[
                            ("BANK_TRANSFER", "Virement bancaire"),
                            ("PAYPAL", "PayPal"),
                            ("STRIPE_CONNECT", "Stripe Connect"),
                            ("EBI3_WALLET", "Portefeuille Ebi3"),
                            ("WESTERN_UNION", "Western Union"),
                            ("MONEYGRAM", "MoneyGram"),
                        ],
                        max_length=20,
                        verbose_name="Méthode de versement",
                    ),
                ),
                (
                    "beneficiary_data",
                    models.TextField(
                        editable=False, verbose_name="Données bénéficiaire"
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("PROCESSING", "En traitement"),
                            ("COMPLETED", "Complété"),
                            ("FAILED", "Échoué"),
                            ("CANCELLED", "Annulé"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "payout_gateway_id",
                    models.CharField(
                        blank=True,
                        max_length=100,
                        verbose_name="ID versement passerelle",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("processed_at", models.DateTimeField(blank=True, null=True)),
            ],
            options={
                "verbose_name": "Versement",
                "verbose_name_plural": "Versements",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="Plan",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("name", models.CharField(max_length=100, verbose_name="Nom du plan")),
                ("description", models.TextField(verbose_name="Description")),
                (
                    "price",
                    models.DecimalField(
                        decimal_places=4, max_digits=12, verbose_name="Prix"
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                            ("XAF", "FCFA"),
                            ("TND", "DT"),
                            ("DZD", "DA"),
                        ],
                        default="EUR",
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "interval",
                    models.CharField(
                        choices=[
                            ("DAILY", "Quotidien"),
                            ("WEEKLY", "Hebdomadaire"),
                            ("MONTHLY", "Mensuel"),
                            ("QUARTERLY", "Trimestriel"),
                            ("SEMI_ANNUAL", "Semestriel"),
                            ("ANNUAL", "Annuel"),
                        ],
                        default="MONTHLY",
                        max_length=20,
                        verbose_name="Intervalle",
                    ),
                ),
                (
                    "interval_count",
                    models.PositiveIntegerField(
                        default=1, verbose_name="Nombre d'intervalles"
                    ),
                ),
                (
                    "trial_period_days",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Période d'essai (jours)"
                    ),
                ),
                ("is_active", models.BooleanField(default=True, verbose_name="Actif")),
                (
                    "features",
                    models.JSONField(default=dict, verbose_name="Fonctionnalités"),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Plan d'abonnement",
                "verbose_name_plural": "Plans d'abonnement",
                "ordering": ["price"],
            },
        ),
        migrations.CreateModel(
            name="Refund",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "refund_id",
                    models.UUIDField(
                        default=uuid.uuid4,
                        editable=False,
                        unique=True,
                        verbose_name="ID remboursement",
                    ),
                ),
                (
                    "amount",
                    models.DecimalField(
                        decimal_places=4,
                        max_digits=12,
                        validators=[
                            django.core.validators.MinValueValidator(Decimal("0.01"))
                        ],
                        verbose_name="Montant remboursé",
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                            ("XAF", "FCFA"),
                            ("TND", "DT"),
                            ("DZD", "DA"),
                        ],
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "reason",
                    models.CharField(
                        choices=[
                            ("DUPLICATE_CHARGE", "Double facturation"),
                            ("UNAUTHORIZED", "Non autorisé"),
                            ("PRODUCT_DEFECT", "Défaut produit"),
                            ("NOT_RECEIVED", "Non reçu"),
                            ("WRONG_AMOUNT", "Mauvais montant"),
                            ("CANCELLED", "Annulé par client"),
                            ("OTHER", "Autre"),
                        ],
                        max_length=20,
                        verbose_name="Raison",
                    ),
                ),
                ("description", models.TextField(verbose_name="Description détaillée")),
                (
                    "evidence",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="refunds/evidence/",
                        verbose_name="Preuve",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("REQUESTED", "Demandé"),
                            ("UNDER_REVIEW", "En revue"),
                            ("APPROVED", "Approuvé"),
                            ("REJECTED", "Rejeté"),
                            ("PROCESSING", "En traitement"),
                            ("COMPLETED", "Complété"),
                            ("FAILED", "Échoué"),
                        ],
                        default="REQUESTED",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "review_notes",
                    models.TextField(blank=True, verbose_name="Notes de revue"),
                ),
                (
                    "rejection_reason",
                    models.TextField(blank=True, verbose_name="Raison du rejet"),
                ),
                (
                    "refund_gateway_id",
                    models.CharField(
                        blank=True,
                        max_length=100,
                        verbose_name="ID remboursement passerelle",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("processed_at", models.DateTimeField(blank=True, null=True)),
            ],
            options={
                "verbose_name": "Remboursement",
                "verbose_name_plural": "Remboursements",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="Subscription",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("ACTIVE", "Actif"),
                            ("PAST_DUE", "En retard"),
                            ("CANCELLED", "Annulé"),
                            ("EXPIRED", "Expiré"),
                            ("SUSPENDED", "Suspendu"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "current_period_start",
                    models.DateTimeField(verbose_name="Début de la période actuelle"),
                ),
                (
                    "current_period_end",
                    models.DateTimeField(verbose_name="Fin de la période actuelle"),
                ),
                (
                    "cancel_at_period_end",
                    models.BooleanField(
                        default=False, verbose_name="Annuler à la fin de la période"
                    ),
                ),
                (
                    "canceled_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Annulé le"
                    ),
                ),
                (
                    "metadata",
                    models.JSONField(
                        blank=True, default=dict, verbose_name="Métadonnées"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Abonnement",
                "verbose_name_plural": "Abonnements",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="Tax",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "country",
                    django_countries.fields.CountryField(
                        max_length=2, unique=True, verbose_name="Pays"
                    ),
                ),
                (
                    "tax_rate",
                    models.DecimalField(
                        decimal_places=2, max_digits=5, verbose_name="Taux TVA (%)"
                    ),
                ),
                (
                    "tax_name",
                    models.CharField(max_length=100, verbose_name="Nom de la taxe"),
                ),
                ("is_active", models.BooleanField(default=True, verbose_name="Active")),
                (
                    "exempt_categories",
                    models.JSONField(
                        blank=True, null=True, verbose_name="Catégories exemptées"
                    ),
                ),
                (
                    "minimum_amount",
                    models.DecimalField(
                        blank=True,
                        decimal_places=4,
                        max_digits=12,
                        null=True,
                        verbose_name="Montant minimum",
                    ),
                ),
            ],
            options={
                "verbose_name": "Taxe",
                "verbose_name_plural": "Taxes",
            },
        ),
        migrations.CreateModel(
            name="Wallet",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "balance",
                    models.DecimalField(
                        decimal_places=4,
                        default=0,
                        max_digits=12,
                        validators=[
                            django.core.validators.MinValueValidator(Decimal("0"))
                        ],
                        verbose_name="Solde",
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                            ("XAF", "FCFA"),
                            ("TND", "DT"),
                            ("DZD", "DA"),
                        ],
                        default="EUR",
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "reserved_balance",
                    models.DecimalField(
                        decimal_places=4,
                        default=0,
                        max_digits=12,
                        verbose_name="Solde réservé",
                    ),
                ),
                (
                    "available_balance",
                    models.DecimalField(
                        decimal_places=4,
                        editable=False,
                        max_digits=12,
                        verbose_name="Solde disponible",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("ACTIVE", "Actif"),
                            ("SUSPENDED", "Suspendu"),
                            ("LOCKED", "Verrouillé"),
                            ("CLOSED", "Fermé"),
                        ],
                        default="ACTIVE",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "daily_limit",
                    models.DecimalField(
                        decimal_places=4,
                        default=Decimal("1000"),
                        max_digits=12,
                        verbose_name="Limite quotidienne",
                    ),
                ),
                (
                    "monthly_limit",
                    models.DecimalField(
                        decimal_places=4,
                        default=Decimal("5000"),
                        max_digits=12,
                        verbose_name="Limite mensuelle",
                    ),
                ),
                (
                    "pin_hash",
                    models.CharField(
                        blank=True,
                        editable=False,
                        max_length=255,
                        verbose_name="Hash du PIN",
                    ),
                ),
                (
                    "is_locked",
                    models.BooleanField(default=False, verbose_name="Verrouillé"),
                ),
                (
                    "locked_until",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Verrouillé jusqu'à"
                    ),
                ),
                (
                    "is_verified",
                    models.BooleanField(default=False, verbose_name="Vérifié"),
                ),
                (
                    "risk_score",
                    models.DecimalField(
                        decimal_places=2,
                        default=0,
                        max_digits=5,
                        verbose_name="Score de risque",
                    ),
                ),
                (
                    "blocked_balance",
                    models.DecimalField(
                        decimal_places=4,
                        default=0,
                        max_digits=12,
                        verbose_name="Solde bloqué",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Portefeuille",
                "verbose_name_plural": "Portefeuilles",
            },
        ),
        migrations.CreateModel(
            name="WalletTransaction",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "amount",
                    models.DecimalField(
                        decimal_places=4, max_digits=12, verbose_name="Montant"
                    ),
                ),
                (
                    "transaction_type",
                    models.CharField(
                        choices=[
                            ("DEPOSIT", "Dépôt"),
                            ("WITHDRAWAL", "Retrait"),
                            ("TRANSFER", "Transfert"),
                            ("PAYMENT", "Paiement"),
                            ("REFUND", "Remboursement"),
                            ("COMMISSION", "Commission"),
                            ("BLOCK", "Blocage"),
                            ("CREDIT", "Crédit"),
                            ("DEBIT", "Débit"),
                        ],
                        max_length=20,
                        verbose_name="Type de transaction",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("PROCESSING", "En traitement"),
                            ("COMPLETED", "Complété"),
                            ("FAILED", "Échoué"),
                            ("CANCELLED", "Annulé"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "description",
                    models.CharField(max_length=255, verbose_name="Description"),
                ),
                (
                    "reference",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Référence"
                    ),
                ),
                (
                    "metadata",
                    models.JSONField(blank=True, null=True, verbose_name="Métadonnées"),
                ),
                (
                    "balance_before",
                    models.DecimalField(
                        decimal_places=4, max_digits=12, verbose_name="Solde avant"
                    ),
                ),
                (
                    "balance_after",
                    models.DecimalField(
                        decimal_places=4, max_digits=12, verbose_name="Solde après"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Transaction portefeuille",
                "verbose_name_plural": "Transactions portefeuille",
                "ordering": ["-created_at"],
            },
        ),
    ]



========== payments/migrations/__init__.py ==========



========== payments/tests.py ==========
# ~/ebi3/payments/tests.py
from django.test import TestCase, Client
from django.urls import reverse
from django.contrib.auth import get_user_model
from django.utils import timezone
from django.core.files.uploadedfile import SimpleUploadedFile
from datetime import timedelta
import json

from .models import (
    Transaction, PaymentSession, Invoice, Refund,
    PaymentMethod, Subscription, Plan, Coupon, TaxRate
)

User = get_user_model()

class PaymentModelsTests(TestCase):
    """Tests pour les modèles de paiement"""

    def setUp(self):
        self.user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='testpass123'
        )

        self.plan = Plan.objects.create(
            name='Plan Test',
            description='Plan de test',
            price=9.99,
            currency='EUR',
            billing_cycle_days=30,
            is_active=True
        )

    def test_transaction_creation(self):
        """Test la création d'une transaction"""
        transaction = Transaction.objects.create(
            user=self.user,
            amount=100.00,
            currency='EUR',
            payment_method='CREDIT_CARD',
            status='COMPLETED',
            purpose='AD_PROMOTION'
        )

        self.assertEqual(transaction.amount, 100.00)
        self.assertEqual(transaction.status, 'COMPLETED')
        self.assertEqual(transaction.user.username, 'testuser')
        self.assertIsNotNone(transaction.transaction_id)

    def test_invoice_generation(self):
        """Test la génération d'une facture"""
        transaction = Transaction.objects.create(
            user=self.user,
            amount=150.00,
            currency='EUR',
            payment_method='CREDIT_CARD',
            status='COMPLETED'
        )

        invoice = Invoice.objects.create(
            user=self.user,
            transaction=transaction,
            amount=150.00,
            currency='EUR',
            status='PAID'
        )

        self.assertEqual(invoice.invoice_number, f'INV-{invoice.id:06d}')
        self.assertEqual(invoice.amount, 150.00)
        self.assertEqual(invoice.status, 'PAID')

    def test_payment_session_expiration(self):
        """Test l'expiration d'une session de paiement"""
        payment_session = PaymentSession.objects.create(
            user=self.user,
            amount=50.00,
            currency='EUR',
            expires_at=timezone.now() - timedelta(minutes=5)
        )

        self.assertTrue(payment_session.is_expired())

    def test_refund_creation(self):
        """Test la création d'un remboursement"""
        transaction = Transaction.objects.create(
            user=self.user,
            amount=200.00,
            currency='EUR',
            payment_method='CREDIT_CARD',
            status='COMPLETED'
        )

        refund = Refund.objects.create(
            transaction=transaction,
            amount=100.00,
            reason='DOUBLE_CHARGE',
            status='PENDING'
        )

        self.assertEqual(refund.amount, 100.00)
        self.assertEqual(refund.status, 'PENDING')
        self.assertEqual(refund.transaction, transaction)

    def test_coupon_validation(self):
        """Test la validation d'un coupon"""
        coupon = Coupon.objects.create(
            code='TEST20',
            discount_type='PERCENTAGE',
            discount_value=20,
            max_uses=10,
            valid_from=timezone.now() - timedelta(days=1),
            valid_until=timezone.now() + timedelta(days=30)
        )

        self.assertTrue(coupon.is_valid())
        self.assertEqual(coupon.calculate_discount(100), 20)

    def test_subscription_creation(self):
        """Test la création d'un abonnement"""
        subscription = Subscription.objects.create(
            user=self.user,
            plan=self.plan,
            status='ACTIVE',
            current_period_start=timezone.now().date(),
            current_period_end=timezone.now().date() + timedelta(days=30),
            next_billing_date=timezone.now().date() + timedelta(days=30)
        )

        self.assertEqual(subscription.status, 'ACTIVE')
        self.assertEqual(subscription.plan.name, 'Plan Test')
        self.assertTrue(subscription.is_active())


class PaymentViewsTests(TestCase):
    """Tests pour les vues de paiement"""

    def setUp(self):
        self.client = Client()
        self.user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='testpass123'
        )
        self.client.login(username='testuser', password='testpass123')

        self.transaction = Transaction.objects.create(
            user=self.user,
            amount=100.00,
            currency='EUR',
            payment_method='CREDIT_CARD',
            status='COMPLETED'
        )

    def test_checkout_view_get(self):
        """Test l'accès à la page de checkout"""
        response = self.client.get(reverse('payments:checkout'))
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'payments/checkout/checkout.html')

    def test_transaction_history_view(self):
        """Test la vue d'historique des transactions"""
        response = self.client.get(reverse('payments:transaction_history'))
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'payments/dashboard/transaction_history.html')
        self.assertContains(response, 'Historique des transactions')

    def test_invoice_detail_view(self):
        """Test la vue de détail d'une facture"""
        invoice = Invoice.objects.create(
            user=self.user,
            transaction=self.transaction,
            amount=100.00,
            currency='EUR'
        )

        response = self.client.get(reverse('payments:invoice_detail', kwargs={'pk': invoice.pk}))
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'payments/invoices/invoice_detail.html')

    def test_request_refund_view(self):
        """Test la vue de demande de remboursement"""
        response = self.client.get(reverse('payments:request_refund', kwargs={'transaction_id': self.transaction.id}))
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'payments/refunds/request_refund.html')

    def test_payment_dashboard_view(self):
        """Test la vue du tableau de bord des paiements"""
        response = self.client.get(reverse('payments:payment_dashboard'))
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'payments/dashboard/payment_dashboard.html')

    def test_create_checkout_session_view(self):
        """Test la création d'une session de paiement (Stripe)"""
        response = self.client.post(reverse('payments:create_checkout_session'), {
            'amount': 50.00,
            'currency': 'EUR',
            'success_url': 'http://test.com/success',
            'cancel_url': 'http://test.com/cancel'
        })

        # Redirection ou réponse JSON attendue
        self.assertIn(response.status_code, [200, 302])

    def test_payment_webhook_view(self):
        """Test le webhook de paiement"""
        response = self.client.post(
            reverse('payments:stripe_webhook'),
            json.dumps({'type': 'payment_intent.succeeded'}),
            content_type='application/json'
        )
        self.assertEqual(response.status_code, 200)


class PaymentFormsTests(TestCase):
    """Tests pour les formulaires de paiement"""

    def setUp(self):
        self.user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='testpass123'
        )

        self.transaction = Transaction.objects.create(
            user=self.user,
            amount=100.00,
            currency='EUR',
            payment_method='CREDIT_CARD',
            status='COMPLETED'
        )

    def test_payment_form_valid(self):
        """Test un formulaire de paiement valide"""
        from .forms import PaymentForm

        form_data = {
            'amount': 50.00,
            'currency': 'EUR',
            'payment_method': 'CREDIT_CARD',
            'description': 'Test payment'
        }

        form = PaymentForm(data=form_data)
        self.assertTrue(form.is_valid())

    def test_refund_form_valid(self):
        """Test un formulaire de remboursement valide"""
        from .forms import RefundRequestForm

        form_data = {
            'amount': 50.00,
            'reason': 'CANCELLED_ORDER',
            'description': 'Order was cancelled',
            'evidence': SimpleUploadedFile("test.jpg", b"file_content", content_type="image/jpeg")
        }

        form = RefundRequestForm(data=form_data, files=form_data)
        self.assertTrue(form.is_valid())

    def test_coupon_form_valid(self):
        """Test un formulaire de coupon valide"""
        from .forms import CouponForm

        form_data = {
            'code': 'TEST2024',
            'discount_type': 'PERCENTAGE',
            'discount_value': 15,
            'max_uses': 100,
            'valid_from': '2024-01-01',
            'valid_until': '2024-12-31'
        }

        form = CouponForm(data=form_data)
        self.assertTrue(form.is_valid())


class PaymentUtilsTests(TestCase):
    """Tests pour les utilitaires de paiement"""

    def test_transaction_id_generation(self):
        """Test la génération d'ID de transaction"""
        from .utils import generate_transaction_id

        transaction_id = generate_transaction_id()
        self.assertTrue(transaction_id.startswith('TXN'))
        self.assertEqual(len(transaction_id), 15)  # TXN + timestamp

    def test_invoice_number_generation(self):
        """Test la génération de numéro de facture"""
        from .utils import generate_invoice_number

        invoice_number = generate_invoice_number(1)
        self.assertEqual(invoice_number, 'INV-000001')

        invoice_number = generate_invoice_number(999)
        self.assertEqual(invoice_number, 'INV-000999')

    def test_amount_validation(self):
        """Test la validation des montants"""
        from .utils import validate_amount

        self.assertTrue(validate_amount(10.00))
        self.assertTrue(validate_amount(0.01))
        self.assertFalse(validate_amount(0))
        self.assertFalse(validate_amount(-10))

    def test_currency_conversion(self):
        """Test la conversion de devises"""
        from .utils import convert_currency

        # Test avec taux de change fictif
        converted = convert_currency(100, 'EUR', 'USD', 1.10)
        self.assertEqual(converted, 110.00)

        converted = convert_currency(50, 'USD', 'EUR', 0.91)
        self.assertAlmostEqual(converted, 45.50, places=2)


class PaymentIntegrationTests(TestCase):
    """Tests d'intégration pour les paiements"""

    def setUp(self):
        self.client = Client()
        self.user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='testpass123'
        )
        self.client.login(username='testuser', password='testpass123')

    def test_complete_payment_flow(self):
        """
        Test un flux complet de paiement:
        1. Création d'une session
        2. Paiement
        3. Vérification du statut
        4. Génération de facture
        """
        # 1. Créer une session de paiement
        session_response = self.client.post(reverse('payments:create_checkout_session'), {
            'amount': 75.00,
            'currency': 'EUR',
            'description': 'Test payment flow'
        })

        self.assertEqual(session_response.status_code, 200)
        session_data = session_response.json()
        self.assertIn('session_id', session_data)

        # 2. Simuler un paiement réussi
        # (Dans un test réel, on appellerait l'API Stripe)

        # 3. Vérifier l'historique
        history_response = self.client.get(reverse('payments:transaction_history'))
        self.assertEqual(history_response.status_code, 200)

    def test_refund_flow(self):
        """
        Test un flux complet de remboursement
        """
        # Créer une transaction complétée
        transaction = Transaction.objects.create(
            user=self.user,
            amount=100.00,
            currency='EUR',
            payment_method='CREDIT_CARD',
            status='COMPLETED'
        )

        # Demander un remboursement
        refund_response = self.client.post(
            reverse('payments:request_refund', kwargs={'transaction_id': transaction.id}),
            {
                'amount': 50.00,
                'reason': 'PARTIAL_REFUND',
                'description': 'Partial refund test'
            }
        )

        # Vérifier la redirection vers la page de statut
        self.assertEqual(refund_response.status_code, 302)

        # Vérifier que le remboursement a été créé
        refund = Refund.objects.filter(transaction=transaction).first()
        self.assertIsNotNone(refund)
        self.assertEqual(refund.amount, 50.00)
        self.assertEqual(refund.status, 'PENDING')

    def test_subscription_flow(self):
        """
        Test un flux d'abonnement
        """
        plan = Plan.objects.create(
            name='Premium',
            price=29.99,
            currency='EUR',
            billing_cycle_days=30,
            is_active=True
        )

        # S'abonner à un plan
        subscribe_response = self.client.post(
            reverse('payments:subscribe'),
            {
                'plan_id': plan.id,
                'payment_method': 'CREDIT_CARD'
            }
        )

        self.assertEqual(subscribe_response.status_code, 200)

        # Vérifier que l'abonnement a été créé
        subscription = Subscription.objects.filter(user=self.user, plan=plan).first()
        self.assertIsNotNone(subscription)
        self.assertEqual(subscription.status, 'PENDING')


class PaymentSecurityTests(TestCase):
    """Tests de sécurité pour les paiements"""

    def test_csrf_protection(self):
        """Test la protection CSRF sur les formulaires sensibles"""
        client = Client(enforce_csrf_checks=True)
        user = User.objects.create_user(
            username='securityuser',
            password='testpass123'
        )
        client.login(username='securityuser', password='testpass123')

        # Tentative de POST sans CSRF token
        response = client.post(reverse('payments:create_checkout_session'), {
            'amount': 100.00,
            'currency': 'EUR'
        })

        self.assertEqual(response.status_code, 403)  # Forbidden

    def test_xss_protection(self):
        """Test la protection contre les attaques XSS"""
        malicious_input = '<script>alert("XSS")</script>'

        transaction = Transaction.objects.create(
            user=self.user,
            amount=100.00,
            currency='EUR',
            payment_method='CREDIT_CARD',
            description=malicious_input,
            status='COMPLETED'
        )

        # La description devrait être échappée dans les templates
        response = self.client.get(reverse('payments:transaction_detail', kwargs={'pk': transaction.pk}))
        self.assertNotContains(response, '<script>')
        self.assertContains(response, '&lt;script&gt;alert')  # HTML échappé

    def test_sql_injection_protection(self):
        """Test la protection contre les injections SQL"""
        # Les modèles Django protègent automatiquement contre les injections SQL
        # Ce test vérifie que les requêtes sont sûres

        suspicious_input = "100.00'; DROP TABLE payments_transaction; --"

        try:
            transaction = Transaction.objects.create(
                user=self.user,
                amount=suspicious_input,  # Ce champ est un DecimalField, donc converti
                currency='EUR',
                payment_method='CREDIT_CARD'
            )

            # Si on arrive ici, l'entrée a été validée
            # Vérifier que la table existe toujours
            count = Transaction.objects.count()
            self.assertGreaterEqual(count, 1)

        except Exception:
            # Une exception est attendue pour entrée invalide
            pass


class PaymentPerformanceTests(TestCase):
    """Tests de performance pour les paiements"""

    def test_transaction_list_performance(self):
        """Test les performances de la liste des transactions"""
        # Créer 100 transactions
        for i in range(100):
            Transaction.objects.create(
                user=self.user,
                amount=i + 1.00,
                currency='EUR',
                payment_method='CREDIT_CARD',
                status='COMPLETED'
            )

        # Mesurer le temps de chargement
        import time
        start_time = time.time()

        self.client.login(username='testuser', password='testpass123')
        response = self.client.get(reverse('payments:transaction_history'))

        end_time = time.time()
        load_time = end_time - start_time

        self.assertEqual(response.status_code, 200)
        self.assertLess(load_time, 2.0)  # Doit charger en moins de 2 secondes

    def test_bulk_operations(self):
        """Test les opérations en masse"""
        # Créer 1000 transactions en une requête (bulk_create)
        transactions = [
            Transaction(
                user=self.user,
                amount=i + 1.00,
                currency='EUR',
                payment_method='CREDIT_CARD'
            )
            for i in range(1000)
        ]

        Transaction.objects.bulk_create(transactions)

        # Vérifier le compte
        count = Transaction.objects.count()
        self.assertEqual(count, 1000)


========== payments/validators.py ==========
# ~/ebi3/payments/validators.py
from django.core.exceptions import ValidationError
from django.utils.translation import gettext_lazy as _
from django.utils import timezone
import re

def validate_credit_card_number(value):
    """
    Valider un numéro de carte de crédit avec l'algorithme de Luhn
    """
    # Supprimer les espaces et tirets
    value = re.sub(r'[\s-]', '', value)

    if not value.isdigit():
        raise ValidationError(_('Le numéro de carte ne doit contenir que des chiffres.'))

    if len(value) < 13 or len(value) > 19:
        raise ValidationError(_('Le numéro de carte doit avoir entre 13 et 19 chiffres.'))

    # Algorithme de Luhn
    def luhn_checksum(card_number):
        def digits_of(n):
            return [int(d) for d in str(n)]
        digits = digits_of(card_number)
        odd_digits = digits[-1::-2]
        even_digits = digits[-2::-2]
        checksum = sum(odd_digits)
        for d in even_digits:
            checksum += sum(digits_of(d*2))
        return checksum % 10

    if luhn_checksum(value) != 0:
        raise ValidationError(_('Numéro de carte de crédit invalide.'))

    return value

def validate_expiry_date(value):
    """
    Valider une date d'expiration de carte (format MM/YY)
    """
    if not re.match(r'^(0[1-9]|1[0-2])/\d{2}$', value):
        raise ValidationError(_('Format invalide. Utilisez MM/YY.'))

    month, year = map(int, value.split('/'))
    current_year = timezone.now().year % 100
    current_month = timezone.now().month

    if year < current_year or (year == current_year and month < current_month):
        raise ValidationError(_('La carte a expiré.'))

    if year > current_year + 20:
        raise ValidationError(_('Date d\'expiration invalide.'))

    return value

def validate_cvv(value):
    """
    Valider un code CVV
    """
    if not value.isdigit():
        raise ValidationError(_('Le CVV doit contenir uniquement des chiffres.'))

    if len(value) not in [3, 4]:
        raise ValidationError(_('Le CVV doit avoir 3 ou 4 chiffres.'))

    return value

def validate_iban(value):
    """
    Valider un numéro IBAN
    """
    # Supprimer les espaces
    value = value.replace(' ', '').upper()

    if len(value) < 15 or len(value) > 34:
        raise ValidationError(_('IBAN invalide: longueur incorrecte.'))

    # Vérifier le format de base
    if not re.match(r'^[A-Z]{2}[0-9]{2}[A-Z0-9]{1,30}$', value):
        raise ValidationError(_('Format IBAN invalide.'))

    # Déplacer les 4 premiers caractères à la fin
    rearranged = value[4:] + value[:4]

    # Convertir les lettres en nombres (A=10, B=11, etc.)
    def convert_to_numbers(s):
        return ''.join(str(ord(c) - 55) if c.isalpha() else c for c in s)

    converted = convert_to_numbers(rearranged)

    # Vérifier avec modulo 97
    if int(converted) % 97 != 1:
        raise ValidationError(_('IBAN invalide: vérification échouée.'))

    return value

def validate_bic(value):
    """
    Valider un code BIC/SWIFT
    """
    value = value.upper().replace(' ', '')

    # Format BIC: 8 ou 11 caractères
    if not re.match(r'^[A-Z]{6}[A-Z0-9]{2}([A-Z0-9]{3})?$', value):
        raise ValidationError(_('Format BIC/SWIFT invalide.'))

    return value

def validate_amount(value):
    """
    Valider un montant monétaire
    """
    if value <= 0:
        raise ValidationError(_('Le montant doit être supérieur à zéro.'))

    if value > 1000000:  # 1 million
        raise ValidationError(_('Le montant est trop élevé.'))

    # Vérifier les décimales
    str_value = str(value)
    if '.' in str_value:
        decimal_part = str_value.split('.')[1]
        if len(decimal_part) > 2:
            raise ValidationError(_('Maximum 2 décimales autorisées.'))

    return value

def validate_currency(value):
    """
    Valider un code de devise
    """
    valid_currencies = ['EUR', 'USD', 'GBP', 'MAD', 'XOF', 'CAD', 'AUD', 'JPY', 'CHF']

    if value not in valid_currencies:
        raise ValidationError(_('Devise non supportée.'))

    return value

def validate_transaction_id(value):
    """
    Valider un ID de transaction
    """
    if not re.match(r'^TXN[A-Z0-9]{12}$', value):
        raise ValidationError(_('Format d\'ID de transaction invalide.'))

    return value

def validate_invoice_number(value):
    """
    Valider un numéro de facture
    """
    if not re.match(r'^INV-\d{6}$', value):
        raise ValidationError(_('Format de numéro de facture invalide. Doit être INV-XXXXXX.'))

    return value

def validate_coupon_code(value):
    """
    Valider un code de coupon
    """
    if len(value) < 4 or len(value) > 20:
        raise ValidationError(_('Le code coupon doit avoir entre 4 et 20 caractères.'))

    if not re.match(r'^[A-Z0-9-_]+$', value):
        raise ValidationError(_('Le code coupon ne peut contenir que des lettres majuscules, chiffres, tirets et underscores.'))

    return value.upper()

def validate_tax_rate(value):
    """
    Valider un taux de taxe
    """
    if value < 0 or value > 100:
        raise ValidationError(_('Le taux de taxe doit être entre 0 et 100.'))

    return value

def validate_discount_value(value, discount_type):
    """
    Valider une valeur de réduction selon son type
    """
    if discount_type == 'PERCENTAGE':
        if value < 0 or value > 100:
            raise ValidationError(_('La réduction en pourcentage doit être entre 0 et 100.'))
    elif discount_type == 'FIXED_AMOUNT':
        if value <= 0:
            raise ValidationError(_('La réduction fixe doit être supérieure à zéro.'))

    return value

def validate_payment_method(value):
    """
    Valider une méthode de paiement
    """
    valid_methods = ['CREDIT_CARD', 'DEBIT_CARD', 'PAYPAL', 'BANK_TRANSFER',
                     'STRIPE', 'CASH', 'MOBILE_MONEY', 'CRYPTO']

    if value not in valid_methods:
        raise ValidationError(_('Méthode de paiement non supportée.'))

    return value

def validate_card_holder_name(value):
    """
    Valider un nom de titulaire de carte
    """
    if len(value) < 2 or len(value) > 50:
        raise ValidationError(_('Le nom doit avoir entre 2 et 50 caractères.'))

    if not re.match(r'^[a-zA-Z\s\'-]+$', value):
        raise ValidationError(_('Le nom ne peut contenir que des lettres, espaces, apostrophes et tirets.'))

    return value.title()

def validate_phone_number_for_payment(value):
    """
    Valider un numéro de téléphone pour le paiement mobile
    """
    # Format international simple
    if not re.match(r'^\+[1-9]\d{1,14}$', value):
        raise ValidationError(_('Format de numéro de téléphone invalide. Utilisez le format international: +33123456789'))

    return value

def validate_wallet_address(value, cryptocurrency):
    """
    Valider une adresse de portefeuille crypto
    """
    crypto_patterns = {
        'BTC': r'^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$|^bc1[ac-hj-np-z02-9]{11,71}$',
        'ETH': r'^0x[a-fA-F0-9]{40}$',
        'LTC': r'^[LM3][a-km-zA-HJ-NP-Z1-9]{26,33}$',
        'XRP': r'^r[0-9a-zA-Z]{24,34}$',
        'BCH': r'^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$|^bitcoincash:q[0-9a-z]{41}$',
    }

    if cryptocurrency not in crypto_patterns:
        raise ValidationError(_('Cryptomonnaie non supportée.'))

    pattern = crypto_patterns[cryptocurrency]
    if not re.match(pattern, value):
        raise ValidationError(_('Adresse de portefeuille invalide pour cette cryptomonnaie.'))

    return value

def validate_bank_account_number(value, country_code='FR'):
    """
    Valider un numéro de compte bancaire selon le pays
    """
    value = value.replace(' ', '').replace('-', '')

    # Validation pour la France (RIB)
    if country_code == 'FR':
        if len(value) != 23:
            raise ValidationError(_('Le RIB français doit avoir 23 chiffres.'))

        if not value.isdigit():
            raise ValidationError(_('Le RIB ne doit contenir que des chiffres.'))

        # Vérifier la clé RIB
        bank_code = value[0:5]
        branch_code = value[5:10]
        account_number = value[10:21]
        key = value[21:23]

        # Calcul de la clé RIB
        def calculate_rib_key(bank, branch, account):
            # Convertir en entier et calculer
            import math
            total = 89 * int(bank) + 15 * int(branch) + 3 * int(account)
            return str(97 - (total % 97)).zfill(2)

        calculated_key = calculate_rib_key(bank_code, branch_code, account_number)
        if calculated_key != key:
            raise ValidationError(_('Clé RIB invalide.'))

    # Ajouter d'autres validations par pays si nécessaire

    return value

def validate_file_size(file, max_size_mb=5):
    """
    Valider la taille d'un fichier
    """
    max_size = max_size_mb * 1024 * 1024  # Convertir en bytes

    if file.size > max_size:
        raise ValidationError(_(f'La taille du fichier ne doit pas dépasser {max_size_mb}MB.'))

    return file

def validate_file_type(file, allowed_types=None):
    """
    Valider le type d'un fichier
    """
    if allowed_types is None:
        allowed_types = ['pdf', 'jpg', 'jpeg', 'png', 'doc', 'docx']

    ext = file.name.split('.')[-1].lower()

    if ext not in allowed_types:
        raise ValidationError(_(f'Type de fichier non autorisé. Types autorisés: {", ".join(allowed_types)}'))

    return file

def validate_json_schema(value, schema_name='transaction_metadata'):
    """
    Valider un JSON selon un schéma
    """
    import json

    try:
        data = json.loads(value) if isinstance(value, str) else value

        # Schémas de validation
        schemas = {
            'transaction_metadata': {
                'required': ['transaction_type', 'items'],
                'properties': {
                    'transaction_type': {'type': 'string'},
                    'items': {'type': 'array'},
                    'shipping_address': {'type': 'object', 'optional': True},
                    'billing_address': {'type': 'object', 'optional': True}
                }
            },
            'invoice_data': {
                'required': ['invoice_number', 'date', 'client'],
                'properties': {
                    'invoice_number': {'type': 'string'},
                    'date': {'type': 'string'},
                    'client': {'type': 'object'}
                }
            }
        }

        if schema_name not in schemas:
            return value

        schema = schemas[schema_name]

        # Validation simple
        for required_field in schema['required']:
            if required_field not in data:
                raise ValidationError(_(f'Champ requis manquant: {required_field}'))

        return value

    except json.JSONDecodeError:
        raise ValidationError(_('JSON invalide.'))


========== payments/admin.py ==========
from django.contrib import admin



========== payments/forms.py ==========
# ~/ebi3/payments/forms.py
from django import forms
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import ValidationError
from django.utils import timezone
from django.forms import inlineformset_factory
from django.core.validators import RegexValidator
from django.utils.text import slugify
from django.db.models import Sum
import re
from decimal import Decimal
import uuid

from .models import (
    PaymentTransaction, PaymentMethod, Invoice, Refund,
    Commission, Payout, Wallet, WalletTransaction,
    Tax, ExchangeRate, FraudAlert, PaymentSession, PaymentCard,
    InvoiceItem, Currency, Plan, Subscription, Coupon
)
from users.models import User
from ads.models import Ad
from logistics.models import Mission

# ============================================================================
# VALIDATEURS PERSONNALISÉS
# ============================================================================

class CardNumberValidator:
    """Validateur de numéro de carte avec algorithme de Luhn"""

    def __call__(self, value):
        # Supprimer les espaces et tirets
        value = re.sub(r'\s+|-', '', value)

        if not value.isdigit():
            raise ValidationError(_("Le numéro de carte doit contenir uniquement des chiffres."))

        if len(value) < 13 or len(value) > 19:
            raise ValidationError(_("Numéro de carte invalide."))

        # Algorithme de Luhn
        def luhn_checksum(card_number):
            digits = [int(d) for d in str(card_number)]
            odd_digits = digits[-1::-2]
            even_digits = digits[-2::-2]
            checksum = sum(odd_digits)
            for d in even_digits:
                checksum += sum([int(x) for x in str(d * 2)])
            return checksum % 10

        if luhn_checksum(value) != 0:
            raise ValidationError(_("Numéro de carte invalide."))

        # Détection du type de carte
        if value.startswith('4'):
            card_type = 'VISA'
        elif value.startswith(('51', '52', '53', '54', '55')):
            card_type = 'MASTERCARD'
        elif value.startswith(('34', '37')):
            card_type = 'AMEX'
        elif value.startswith(('300', '301', '302', '303', '304', '305', '36', '38')):
            card_type = 'DINERS'
        elif value.startswith(('6011', '65')):
            card_type = 'DISCOVER'
        else:
            card_type = 'UNKNOWN'

        return value, card_type


class CVVValidator:
    """Validateur de code de sécurité CVV"""

    def __call__(self, value):
        value = str(value).strip()

        if not value.isdigit():
            raise ValidationError(_("Le CVV doit contenir uniquement des chiffres."))

        if len(value) not in [3, 4]:
            raise ValidationError(_("Le CVV doit contenir 3 ou 4 chiffres."))

        return value


class ExpiryDateValidator:
    """Validateur de date d'expiration"""

    def __call__(self, value):
        today = timezone.now().date()

        # Vérifier que la date n'est pas passée
        if value < today:
            raise ValidationError(_("La date d'expiration est dépassée."))

        # Vérifier que la date n'est pas trop éloignée (max 10 ans)
        max_date = today.replace(year=today.year + 10)
        if value > max_date:
            raise ValidationError(_("La date d'expiration est trop éloignée."))

        return value


class IBANValidator:
    """Validateur d'IBAN (International Bank Account Number)"""

    def __call__(self, value):
        value = value.upper().replace(' ', '')

        # Vérifier la longueur
        if len(value) < 15 or len(value) > 34:
            raise ValidationError(_("IBAN invalide : longueur incorrecte."))

        # Vérifier le format (2 lettres + 2 chiffres + caractères alphanumériques)
        if not re.match(r'^[A-Z]{2}[0-9]{2}[A-Z0-9]{11,30}$', value):
            raise ValidationError(_("Format IBAN invalide."))

        # Vérifier le pays supporté
        supported_countries = ['FR', 'BE', 'DE', 'ES', 'IT', 'LU', 'NL', 'MA', 'TN', 'DZ']
        country_code = value[:2]
        if country_code not in supported_countries:
            raise ValidationError(_(f"IBAN du pays {country_code} non supporté."))

        # Algorithme de vérification IBAN
        def iban_checksum(iban):
            # Déplacer les 4 premiers caractères à la fin
            rearranged = iban[4:] + iban[:4]
            # Convertir les lettres en chiffres (A=10, B=11, ...)
            digits = ''
            for char in rearranged:
                if char.isdigit():
                    digits += char
                else:
                    digits += str(ord(char) - 55)
            # Calculer le modulo 97
            mod = int(digits) % 97
            return mod == 1

        if not iban_checksum(value):
            raise ValidationError(_("IBAN invalide : vérification échouée."))

        return value


class PhoneNumberValidator:
    """Validateur de numéro de téléphone pour mobile money"""

    def __call__(self, value):
        value = re.sub(r'\s+', '', value)

        # Formats internationaux
        patterns = [
            r'^\+[1-9]\d{10,14}$',  # Format international
            r'^0[5-9]\d{8}$',       # Format français
            r'^0[6-7]\d{8}$',       # Format marocain
        ]

        if not any(re.match(p, value) for p in patterns):
            raise ValidationError(_("Numéro de téléphone invalide."))

        return value

# ============================================================================
# FORMULAIRES MANQUANTS POUR COMPATIBILITÉ AVEC VIEWS.PY
# ============================================================================

class InvoiceForm(forms.ModelForm):
    """Formulaire pour créer/modifier une facture"""

    class Meta:
        model = Invoice
        fields = ['billing_name', 'billing_address', 'billing_country',
                 'billing_vat', 'invoice_date', 'due_date', 'notes']
        widgets = {
            'billing_name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Nom complet')
            }),
            'billing_address': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _('Adresse complète')
            }),
            'billing_country': forms.Select(attrs={
                'class': 'form-control'
            }),
            'billing_vat': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Numéro TVA (optionnel)')
            }),
            'invoice_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
            'due_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
            'notes': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _('Notes additionnelles')
            }),
        }

    def __init__(self, *args, **kwargs):
        self.transaction = kwargs.pop('transaction', None)
        super().__init__(*args, **kwargs)

        if self.transaction:
            # Pré-remplir avec les informations de la transaction
            if self.transaction.payer:
                self.fields['billing_name'].initial = self.transaction.payer.get_full_name()

            # Calculer la date d'échéance (30 jours par défaut)
            if not self.instance.due_date:
                self.fields['due_date'].initial = timezone.now().date() + timezone.timedelta(days=30)


class PlanForm(forms.ModelForm):
    """Formulaire pour les plans d'abonnement"""

    class Meta:
        model = Plan
        fields = ['name', 'description', 'price', 'currency', 'interval',
                 'interval_count', 'trial_period_days', 'is_active', 'features']
        widgets = {
            'name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Nom du plan')
            }),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _('Description du plan...')
            }),
            'price': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0'
            }),
            'currency': forms.Select(attrs={
                'class': 'form-control'
            }),
            'interval': forms.Select(attrs={
                'class': 'form-control'
            }),
            'interval_count': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '1'
            }),
            'trial_period_days': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '0'
            }),
            'features': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _('Fonctionnalités (format JSON)')
            }),
        }


class SubscriptionForm(forms.ModelForm):
    """Formulaire pour les abonnements"""

    class Meta:
        model = Subscription
        fields = ['plan', 'status', 'current_period_start', 'current_period_end',
                 'cancel_at_period_end', 'metadata']
        widgets = {
            'plan': forms.Select(attrs={
                'class': 'form-control'
            }),
            'status': forms.Select(attrs={
                'class': 'form-control'
            }),
            'current_period_start': forms.DateTimeInput(attrs={
                'type': 'datetime-local',
                'class': 'form-control'
            }),
            'current_period_end': forms.DateTimeInput(attrs={
                'type': 'datetime-local',
                'class': 'form-control'
            }),
            'metadata': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _('Métadonnées (format JSON)')
            }),
        }


class CouponForm(forms.ModelForm):
    """Formulaire pour les coupons de réduction"""

    class Meta:
        model = Coupon
        fields = ['code', 'discount_type', 'discount_value', 'currency',
                 'valid_from', 'valid_until', 'max_uses', 'is_active']
        widgets = {
            'code': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Code du coupon')
            }),
            'discount_type': forms.Select(attrs={
                'class': 'form-control'
            }),
            'discount_value': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0'
            }),
            'currency': forms.Select(attrs={
                'class': 'form-control'
            }),
            'valid_from': forms.DateTimeInput(attrs={
                'type': 'datetime-local',
                'class': 'form-control'
            }),
            'valid_until': forms.DateTimeInput(attrs={
                'type': 'datetime-local',
                'class': 'form-control'
            }),
            'max_uses': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '1'
            }),
        }


class PaymentSessionForm(forms.ModelForm):
    """Formulaire pour les sessions de paiement"""

    class Meta:
        model = PaymentSession
        fields = ['amount', 'currency', 'payment_method', 'metadata', 'expires_at']
        widgets = {
            'amount': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0.01'
            }),
            'currency': forms.Select(attrs={
                'class': 'form-control'
            }),
            'payment_method': forms.Select(attrs={
                'class': 'form-control'
            }),
            'metadata': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _('Métadonnées (format JSON)')
            }),
            'expires_at': forms.DateTimeInput(attrs={
                'type': 'datetime-local',
                'class': 'form-control'
            }),
        }

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        # Définir la date d'expiration par défaut (30 minutes)
        if not self.instance.expires_at:
            self.fields['expires_at'].initial = timezone.now() + timezone.timedelta(minutes=30)


class CurrencyForm(forms.ModelForm):
    """Formulaire pour les devises"""

    class Meta:
        model = Currency
        fields = ['code', 'name', 'symbol', 'is_active', 'exchange_rate', 'display_order']
        widgets = {
            'code': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('EUR, USD, etc.')
            }),
            'name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Euro, Dollar US, etc.')
            }),
            'symbol': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('€, $, £, etc.')
            }),
            'exchange_rate': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.000001'
            }),
            'display_order': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '0'
            }),
        }


class PaymentCardForm(forms.ModelForm):
    """Formulaire pour les cartes bancaires"""

    class Meta:
        model = PaymentCard
        fields = ['cardholder_name', 'expiry_month', 'expiry_year',
                 'is_default', 'is_active']
        widgets = {
            'cardholder_name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('Nom tel qu\'indiqué sur la carte')
            }),
            'expiry_month': forms.Select(attrs={
                'class': 'form-control',
                'choices': [(str(i).zfill(2), str(i).zfill(2)) for i in range(1, 13)]
            }),
            'expiry_year': forms.Select(attrs={
                'class': 'form-control',
                'choices': [(str(i), str(i)) for i in range(timezone.now().year, timezone.now().year + 11)]
            }),
        }

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        # Définir les valeurs par défaut pour l'expiration
        now = timezone.now()
        self.fields['expiry_month'].initial = str(now.month).zfill(2)
        self.fields['expiry_year'].initial = str(now.year)


# ============================================================================
# FORMULAIRES DE BASE (EXISTANTS)
# ============================================================================

class PaymentForm(forms.Form):
    """Formulaire de base pour les paiements"""

    amount = forms.DecimalField(
        max_digits=12,
        decimal_places=4,
        min_value=Decimal('0.01'),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _('Montant'),
            'step': '0.01'
        }),
        label=_("Montant")
    )

    currency = forms.ChoiceField(
        choices=[
            ('EUR', '€ EUR'),
            ('USD', '$ USD'),
            ('GBP', '£ GBP'),
            ('MAD', 'DH MAD'),
            ('XOF', 'CFA XOF'),
        ],
        initial='EUR',
        widget=forms.Select(attrs={
            'class': 'form-control'
        }),
        label=_("Devise")
    )

    description = forms.CharField(
        required=False,
        max_length=255,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _('Description du paiement')
        }),
        label=_("Description")
    )

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

# ============================================================================
# FORMULAIRES DE PAIEMENT PRINCIPAUX (EXISTANTS)
# ============================================================================

class PaymentCheckoutForm(forms.Form):
    """Formulaire de checkout principal"""

    # Montant et devise
    amount = forms.DecimalField(
        max_digits=12,
        decimal_places=4,
        min_value=Decimal('0.01'),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _('Montant'),
            'step': '0.01'
        }),
        label=_("Montant")
    )

    currency = forms.ChoiceField(
        choices=[
            ('EUR', '€ EUR'),
            ('USD', '$ USD'),
            ('GBP', '£ GBP'),
            ('MAD', 'DH MAD'),
            ('XOF', 'CFA XOF'),
        ],
        initial='EUR',
        widget=forms.Select(attrs={
            'class': 'form-control'
        }),
        label=_("Devise")
    )

    # Méthode de paiement
    payment_method = forms.ChoiceField(
        choices=PaymentTransaction.PaymentMethod.choices,
        initial='CREDIT_CARD',
        widget=forms.RadioSelect(attrs={
            'class': 'payment-method-radio'
        }),
        label=_("Méthode de paiement")
    )

    # Pour les paiements liés à des objets
    object_type = forms.ChoiceField(
        choices=[
            ('', _('Sélectionnez...')),
            ('AD', _('Annonce')),
            ('MISSION', _('Mission')),
            ('WALLET', _('Portefeuille')),
            ('OTHER', _('Autre')),
        ],
        required=False,
        widget=forms.Select(attrs={
            'class': 'form-control',
            'id': 'object-type'
        }),
        label=_("Type d'objet")
    )

    object_id = forms.CharField(
        required=False,
        widget=forms.HiddenInput(),
        label=_("ID de l'objet")
    )

    # Notes optionnelles
    notes = forms.CharField(
        required=False,
        widget=forms.Textarea(attrs={
            'class': 'form-control',
            'rows': 3,
            'placeholder': _('Notes additionnelles...')
        }),
        label=_("Notes")
    )

    # Conditions générales
    accept_terms = forms.BooleanField(
        required=True,
        widget=forms.CheckboxInput(attrs={
            'class': 'form-check-input'
        }),
        label=_("J'accepte les conditions générales et la politique de confidentialité")
    )

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        self.object = kwargs.pop('object', None)
        super().__init__(*args, **kwargs)

        # Pré-remplir si un objet est fourni
        if self.object:
            if isinstance(self.object, Ad):
                self.fields['object_type'].initial = 'AD'
                self.fields['object_id'].initial = self.object.id
                self.fields['amount'].initial = self.object.price
                self.fields['currency'].initial = self.object.currency
            elif isinstance(self.object, Mission):
                self.fields['object_type'].initial = 'MISSION'
                self.fields['object_id'].initial = self.object.id
                # Calculer le montant de la mission
                if hasattr(self.object, 'calculated_price'):
                    self.fields['amount'].initial = self.object.calculated_price
                self.fields['currency'].initial = 'EUR'

        # Filtrer les méthodes de paiement selon l'utilisateur
        if self.user and hasattr(self.user, 'wallet'):
            # Ajouter le portefeuille Ebi3 comme option
            payment_methods = list(PaymentTransaction.PaymentMethod.choices)
            if ('EBI3_WALLET', _('Portefeuille Ebi3')) not in payment_methods:
                payment_methods.append(('EBI3_WALLET', _('Portefeuille Ebi3')))
            self.fields['payment_method'].choices = payment_methods

    def clean(self):
        cleaned_data = super().clean()
        amount = cleaned_data.get('amount')
        payment_method = cleaned_data.get('payment_method')
        accept_terms = cleaned_data.get('accept_terms')

        # Validation du montant minimum selon la méthode
        min_amounts = {
            'CREDIT_CARD': Decimal('1.00'),
            'PAYPAL': Decimal('0.10'),
            'BANK_TRANSFER': Decimal('10.00'),
            'EBI3_WALLET': Decimal('0.01'),
        }

        if payment_method in min_amounts and amount < min_amounts[payment_method]:
            self.add_error('amount',
                _(f"Le montant minimum pour {self.fields['payment_method'].choices_dict[payment_method]} est de {min_amounts[payment_method]}"))

        # Vérification du portefeuille si paiement par Ebi3 Wallet
        if payment_method == 'EBI3_WALLET' and self.user:
            try:
                wallet = self.user.wallet
                if wallet.balance < amount:
                    self.add_error('payment_method',
                        _("Solde insuffisant dans votre portefeuille Ebi3."))
            except Wallet.DoesNotExist:
                self.add_error('payment_method',
                    _("Vous n'avez pas de portefeuille Ebi3. Veuillez en créer un."))

        # Validation des conditions générales
        if not accept_terms:
            self.add_error('accept_terms',
                _("Vous devez accepter les conditions générales."))

        return cleaned_data


class CreditCardPaymentForm(forms.Form):
    """Formulaire pour le paiement par carte de crédit"""

    card_number = forms.CharField(
        max_length=19,
        validators=[CardNumberValidator()],
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': '1234 5678 9012 3456',
            'data-mask': '0000 0000 0000 0000'
        }),
        label=_("Numéro de carte")
    )

    card_holder = forms.CharField(
        max_length=100,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _('Nom tel qu\'indiqué sur la carte')
        }),
        label=_("Titulaire de la carte")
    )

    expiry_month = forms.ChoiceField(
        choices=[(str(i).zfill(2), str(i).zfill(2)) for i in range(1, 13)],
        widget=forms.Select(attrs={
            'class': 'form-control expiry-month'
        }),
        label=_("Mois d'expiration")
    )

    expiry_year = forms.ChoiceField(
        choices=[(str(i), str(i)) for i in range(timezone.now().year, timezone.now().year + 11)],
        widget=forms.Select(attrs={
            'class': 'form-control expiry-year'
        }),
        label=_("Année d'expiration")
    )

    cvv = forms.CharField(
        max_length=4,
        validators=[CVVValidator()],
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': '123',
            'maxlength': '4'
        }),
        label=_("Code de sécurité (CVV)")
    )

    save_card = forms.BooleanField(
        required=False,
        initial=False,
        widget=forms.CheckboxInput(attrs={
            'class': 'form-check-input'
        }),
        label=_("Enregistrer cette carte pour de futurs paiements")
    )

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        # Définir les valeurs par défaut pour l'expiration
        now = timezone.now()
        self.fields['expiry_month'].initial = str(now.month).zfill(2)
        self.fields['expiry_year'].initial = str(now.year)

    def clean(self):
        cleaned_data = super().clean()
        expiry_month = cleaned_data.get('expiry_month')
        expiry_year = cleaned_data.get('expiry_year')

        # Valider la date d'expiration
        if expiry_month and expiry_year:
            expiry_date = timezone.datetime(
                year=int(expiry_year),
                month=int(expiry_month),
                day=1
            ).date()

            # Vérifier que la carte n'est pas expirée
            today = timezone.now().date()
            if expiry_date < today.replace(day=1):
                self.add_error('expiry_month',
                    _("La carte est expirée."))

            # Vérifier que la date n'est pas trop éloignée
            max_date = today.replace(year=today.year + 10, day=1)
            if expiry_date > max_date:
                self.add_error('expiry_year',
                    _("La date d'expiration est trop éloignée."))

        return cleaned_data


class PayPalPaymentForm(forms.Form):
    """Formulaire pour le paiement via PayPal"""

    email = forms.EmailField(
        widget=forms.EmailInput(attrs={
            'class': 'form-control',
            'placeholder': 'paypal@example.com'
        }),
        label=_("Email PayPal")
    )

    remember_me = forms.BooleanField(
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={
            'class': 'form-check-input'
        }),
        label=_("Se souvenir de moi")
    )


class BankTransferForm(forms.Form):
    """Formulaire pour le paiement par virement bancaire"""

    bank_name = forms.CharField(
        max_length=100,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _('Nom de votre banque')
        }),
        label=_("Nom de la banque")
    )

    account_holder = forms.CharField(
        max_length=100,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _('Nom du titulaire du compte')
        }),
        label=_("Titulaire du compte")
    )

    iban = forms.CharField(
        max_length=34,
        validators=[IBANValidator()],
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'FR76 3000 1000 0100 0000 0000 123'
        }),
        label=_("IBAN")
    )

    bic = forms.CharField(
        max_length=11,
        required=False,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'BNPAFRPP'
        }),
        label=_("BIC/SWIFT (optionnel)")
    )

    reference = forms.CharField(
        max_length=50,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _('Référence du virement')
        }),
        label=_("Référence")
    )

    def clean_reference(self):
        reference = self.cleaned_data.get('reference')
        # S'assurer que la référence est unique
        if PaymentTransaction.objects.filter(reference=reference).exists():
            raise ValidationError(_("Cette référence existe déjà. Veuillez en choisir une autre."))
        return reference


class MobileMoneyForm(forms.Form):
    """Formulaire pour le paiement par mobile money"""

    provider = forms.ChoiceField(
        choices=[
            ('ORANGE_MONEY', 'Orange Money'),
            ('MTN_MONEY', 'MTN Money'),
            ('MOOV_MONEY', 'Moov Money'),
            ('WAVE', 'Wave'),
        ],
        widget=forms.Select(attrs={
            'class': 'form-control'
        }),
        label=_("Opérateur")
    )

    phone_number = forms.CharField(
        max_length=20,
        validators=[PhoneNumberValidator()],
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': '+33 6 12 34 56 78'
        }),
        label=_("Numéro de téléphone")
    )

    country = forms.ChoiceField(
        choices=[
            ('FR', 'France'),
            ('SN', 'Sénégal'),
            ('CI', "Côte d'Ivoire"),
            ('CM', 'Cameroun'),
            ('MG', 'Madagascar'),
        ],
        widget=forms.Select(attrs={
            'class': 'form-control'
        }),
        label=_("Pays")
    )


# ============================================================================
# FORMULAIRES DE GESTION (EXISTANTS)
# ============================================================================

class PaymentMethodForm(forms.ModelForm):
    """Formulaire pour ajouter une méthode de paiement"""

    class Meta:
        model = PaymentMethod
        fields = ['method_type', 'is_default']
        widgets = {
            'method_type': forms.Select(attrs={'class': 'form-control'}),
            'is_default': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        # Limiter les types selon l'utilisateur
        if self.user and self.user.country:
            if self.user.country.code in ['FR', 'BE', 'LU']:
                self.fields['method_type'].choices = [
                    ('CARD', _('Carte bancaire')),
                    ('BANK_ACCOUNT', _('Compte bancaire')),
                ]
            elif self.user.country.code in ['SN', 'CI', 'CM']:
                self.fields['method_type'].choices = [
                    ('MOBILE_MONEY', _('Mobile Money')),
                    ('CARD', _('Carte bancaire')),
                ]

    def clean(self):
        cleaned_data = super().clean()

        # Si c'est la méthode par défaut, désactiver les autres
        if cleaned_data.get('is_default') and self.user:
            PaymentMethod.objects.filter(
                user=self.user,
                is_default=True
            ).update(is_default=False)

        return cleaned_data


class RefundRequestForm(forms.ModelForm):
    """Formulaire pour demander un remboursement"""

    class Meta:
        model = Refund
        fields = ['reason', 'description', 'evidence']
        widgets = {
            'reason': forms.Select(attrs={
                'class': 'form-control',
                'id': 'refund-reason'
            }),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _('Décrivez en détail pourquoi vous demandez un remboursement...')
            }),
            'evidence': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*,.pdf,.doc,.docx'
            }),
        }

    def __init__(self, *args, **kwargs):
        self.transaction = kwargs.pop('transaction', None)
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        # Pré-remplir le montant maximum
        if self.transaction:
            max_refund = self.transaction.calculate_refund_amount()
            self.fields['amount'] = forms.DecimalField(
                max_digits=12,
                decimal_places=4,
                max_value=max_refund,
                min_value=Decimal('0.01'),
                initial=max_refund,
                widget=forms.NumberInput(attrs={
                    'class': 'form-control',
                    'step': '0.01'
                }),
                label=_("Montant à rembourser")
            )

            # Afficher le montant maximum
            self.helper_text = _("Montant maximum remboursable : {} {}").format(
                max_refund, self.transaction.currency
            )

    def clean(self):
        cleaned_data = super().clean()
        amount = cleaned_data.get('amount')

        if amount and self.transaction:
            max_refund = self.transaction.calculate_refund_amount()
            if amount > max_refund:
                self.add_error('amount',
                    _(f"Le montant ne peut pas dépasser {max_refund} {self.transaction.currency}"))

        return cleaned_data


class PayoutRequestForm(forms.ModelForm):
    """Formulaire pour demander un versement"""

    class Meta:
        model = Payout
        fields = ['payout_method', 'amount']
        widgets = {
            'payout_method': forms.Select(attrs={
                'class': 'form-control',
                'id': 'payout-method'
            }),
            'amount': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
        }

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        # Récupérer le portefeuille de l'utilisateur
        if self.user:
            try:
                wallet = self.user.wallet
                self.available_balance = wallet.available_balance
                self.currency = wallet.currency

                # Définir le montant maximum
                self.fields['amount'].max_value = self.available_balance
                self.fields['amount'].initial = self.available_balance

                # Ajouter l'information du solde disponible
                self.helper_text = _("Solde disponible : {} {}").format(
                    self.available_balance, self.currency
                )

                # Filtrer les méthodes de versement selon le pays
                if self.user.country:
                    if self.user.country.code in ['FR', 'BE', 'LU']:
                        self.fields['payout_method'].choices = [
                            ('BANK_TRANSFER', _('Virement bancaire')),
                            ('PAYPAL', 'PayPal'),
                            ('EBI3_WALLET', _('Portefeuille Ebi3')),
                        ]
                    elif self.user.country.code in ['SN', 'CI']:
                        self.fields['payout_method'].choices = [
                            ('WESTERN_UNION', 'Western Union'),
                            ('EBI3_WALLET', _('Portefeuille Ebi3')),
                        ]

            except Wallet.DoesNotExist:
                self.available_balance = Decimal('0')
                self.currency = 'EUR'

    def clean(self):
        cleaned_data = super().clean()
        amount = cleaned_data.get('amount')

        if amount and hasattr(self, 'available_balance'):
            if amount > self.available_balance:
                self.add_error('amount',
                    _(f"Le montant ne peut pas dépasser votre solde disponible de {self.available_balance} {self.currency}"))

            # Vérifier le montant minimum selon la méthode
            payout_method = cleaned_data.get('payout_method')
            min_amounts = {
                'BANK_TRANSFER': Decimal('10.00'),
                'PAYPAL': Decimal('1.00'),
                'WESTERN_UNION': Decimal('50.00'),
                'EBI3_WALLET': Decimal('0.01'),
            }

            if payout_method in min_amounts and amount < min_amounts[payout_method]:
                self.add_error('amount',
                    _(f"Le montant minimum pour ce type de versement est de {min_amounts[payout_method]} {self.currency}"))

        return cleaned_data


class WalletRechargeForm(forms.Form):
    """Formulaire pour recharger un portefeuille"""
    # Alias pour WalletTopUpForm pour compatibilité avec views.py

    amount = forms.DecimalField(
        max_digits=12,
        decimal_places=4,
        min_value=Decimal('1.00'),
        max_value=Decimal('10000.00'),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01',
            'placeholder': '50.00'
        }),
        label=_("Montant de recharge")
    )

    currency = forms.ChoiceField(
        choices=[
            ('EUR', '€ EUR'),
            ('USD', '$ USD'),
            ('MAD', 'DH MAD'),
            ('XOF', 'CFA XOF'),
        ],
        widget=forms.Select(attrs={
            'class': 'form-control'
        }),
        label=_("Devise")
    )

    payment_method = forms.ChoiceField(
        choices=[
            ('CREDIT_CARD', _('Carte de crédit')),
            ('PAYPAL', 'PayPal'),
            ('BANK_TRANSFER', _('Virement bancaire')),
            ('MOBILE_MONEY', _('Mobile Money')),
        ],
        widget=forms.RadioSelect(attrs={
            'class': 'topup-method-radio'
        }),
        label=_("Méthode de paiement")
    )

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        if self.user and hasattr(self.user, 'wallet'):
            # Définir la devise par défaut selon le portefeuille
            self.fields['currency'].initial = self.user.wallet.currency

            # Limiter le montant maximum selon le pays
            if self.user.country:
                country_limits = {
                    'FR': Decimal('5000.00'),
                    'MA': Decimal('10000.00'),
                    'SN': Decimal('1000.00'),
                    'CI': Decimal('1000.00'),
                }
                limit = country_limits.get(self.user.country.code, Decimal('5000.00'))
                self.fields['amount'].max_value = limit

    def clean(self):
        cleaned_data = super().clean()
        amount = cleaned_data.get('amount')

        # Vérifier les limites selon la méthode
        payment_method = cleaned_data.get('payment_method')
        if payment_method == 'MOBILE_MONEY' and amount > Decimal('500.00'):
            self.add_error('amount',
                _("Le montant maximum pour Mobile Money est de 500.00"))

        return cleaned_data


# Alias pour compatibilité
WalletTopUpForm = WalletRechargeForm


class WalletWithdrawalForm(forms.Form):
    """Formulaire pour retirer des fonds d'un portefeuille"""
    # Alias pour PayoutRequestForm pour compatibilité avec views.py

    amount = forms.DecimalField(
        max_digits=12,
        decimal_places=4,
        min_value=Decimal('0.01'),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01',
            'id': 'transfer-amount'
        }),
        label=_("Montant")
    )

    payment_method = forms.ChoiceField(
        choices=[
            ('BANK_TRANSFER', _('Virement bancaire')),
            ('PAYPAL', 'PayPal'),
            ('WESTERN_UNION', 'Western Union'),
            ('EBI3_WALLET', _('Portefeuille Ebi3')),
        ],
        widget=forms.Select(attrs={
            'class': 'form-control',
            'id': 'payout-method'
        }),
        label=_("Méthode de retrait")
    )

    account_details = forms.JSONField(
        required=False,
        widget=forms.HiddenInput(),
        label=_("Détails du compte")
    )

    notes = forms.CharField(
        required=False,
        max_length=500,
        widget=forms.Textarea(attrs={
            'class': 'form-control',
            'rows': 3,
            'placeholder': _('Notes optionnelles...')
        }),
        label=_("Notes")
    )

    def __init__(self, *args, **kwargs):
        self.wallet = kwargs.pop('wallet', None)
        super().__init__(*args, **kwargs)

        if self.wallet:
            # Définir le montant maximum
            self.fields['amount'].max_value = self.wallet.available_balance

    def clean(self):
        cleaned_data = super().clean()
        amount = cleaned_data.get('amount')

        if amount and self.wallet:
            if amount > self.wallet.available_balance:
                self.add_error('amount',
                    _("Le montant ne peut pas dépasser votre solde disponible."))

        return cleaned_data


class WalletTransferForm(forms.Form):
    """Formulaire pour transférer des fonds entre portefeuilles"""

    recipient = forms.CharField(
        max_length=150,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Nom d'utilisateur ou email"),
            'id': 'recipient-search'
        }),
        label=_("Destinataire")
    )

    amount = forms.DecimalField(
        max_digits=12,
        decimal_places=4,
        min_value=Decimal('0.01'),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01',
            'id': 'transfer-amount'
        }),
        label=_("Montant")
    )

    message = forms.CharField(
        required=False,
        max_length=200,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Message optionnel...")
        }),
        label=_("Message")
    )

    def __init__(self, *args, **kwargs):
        self.sender = kwargs.pop('sender', None)
        super().__init__(*args, **kwargs)

        if self.sender and hasattr(self.sender, 'wallet'):
            # Définir le montant maximum
            self.fields['amount'].max_value = self.sender.wallet.available_balance

            # Ajouter l'information du solde
            self.helper_text = _("Solde disponible : {} {}").format(
                self.sender.wallet.available_balance,
                self.sender.wallet.currency
            )

    def clean(self):
        cleaned_data = super().clean()
        recipient = cleaned_data.get('recipient')
        amount = cleaned_data.get('amount')

        # Rechercher le destinataire
        if recipient:
            try:
                # Chercher par email ou username
                if '@' in recipient:
                    recipient_user = User.objects.get(email=recipient)
                else:
                    recipient_user = User.objects.get(username=recipient)

                cleaned_data['recipient_user'] = recipient_user

                # Vérifier que le destinataire a un portefeuille
                if not hasattr(recipient_user, 'wallet'):
                    self.add_error('recipient',
                        _("Le destinataire n'a pas de portefeuille Ebi3."))

                # Vérifier qu'on ne se transfère pas à soi-même
                if recipient_user == self.sender:
                    self.add_error('recipient',
                        _("Vous ne pouvez pas vous transférer des fonds à vous-même."))

            except User.DoesNotExist:
                self.add_error('recipient',
                    _("Utilisateur non trouvé. Veuillez vérifier le nom d'utilisateur ou l'email."))

        # Vérifier le solde de l'expéditeur
        if amount and self.sender and hasattr(self.sender, 'wallet'):
            if amount > self.sender.wallet.available_balance:
                self.add_error('amount',
                    _("Solde insuffisant."))

            # Vérifier les limites de transfert
            daily_transfers = WalletTransaction.objects.filter(
                wallet=self.sender.wallet,
                transaction_type='TRANSFER',
                created_at__date=timezone.now().date()
            ).aggregate(total=Sum('amount'))['total'] or Decimal('0')

            if daily_transfers + amount > Decimal('1000.00'):
                self.add_error('amount',
                    _("Vous avez atteint votre limite de transfert quotidienne (1000 €)."))

        return cleaned_data


# ============================================================================
# FORMULAIRES D'ADMINISTRATION (EXISTANTS)
# ============================================================================

class TransactionSearchForm(forms.Form):
    """Formulaire de recherche de transactions"""

    STATUS_CHOICES = [('', _('Tous'))] + list(PaymentTransaction.Status.choices)
    PAYMENT_TYPE_CHOICES = [('', _('Tous'))] + list(PaymentTransaction.PaymentType.choices)

    reference = forms.CharField(
        required=False,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _('Référence...')
        }),
        label=_("Référence")
    )

    payer = forms.CharField(
        required=False,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _('Nom d\'utilisateur ou email...')
        }),
        label=_("Payeur")
    )

    payee = forms.CharField(
        required=False,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _('Nom d\'utilisateur ou email...')
        }),
        label=_("Bénéficiaire")
    )

    status = forms.ChoiceField(
        required=False,
        choices=STATUS_CHOICES,
        widget=forms.Select(attrs={'class': 'form-control'}),
        label=_("Statut")
    )

    payment_type = forms.ChoiceField(
        required=False,
        choices=PAYMENT_TYPE_CHOICES,
        widget=forms.Select(attrs={'class': 'form-control'}),
        label=_("Type de paiement")
    )

    date_from = forms.DateField(
        required=False,
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        }),
        label=_("Du")
    )

    date_to = forms.DateField(
        required=False,
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        }),
        label=_("Au")
    )

    min_amount = forms.DecimalField(
        required=False,
        min_value=0,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01',
            'placeholder': _('Montant minimum')
        }),
        label=_("Montant minimum")
    )

    max_amount = forms.DecimalField(
        required=False,
        min_value=0,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01',
            'placeholder': _('Montant maximum')
        }),
        label=_("Montant maximum")
    )

    currency = forms.ChoiceField(
        required=False,
        choices=[('', _('Toutes'))] + [
            ('EUR', '€ EUR'),
            ('USD', '$ USD'),
            ('MAD', 'DH MAD'),
            ('XOF', 'CFA XOF'),
        ],
        widget=forms.Select(attrs={'class': 'form-control'}),
        label=_("Devise")
    )

    def clean(self):
        cleaned_data = super().clean()
        date_from = cleaned_data.get('date_from')
        date_to = cleaned_data.get('date_to')
        min_amount = cleaned_data.get('min_amount')
        max_amount = cleaned_data.get('max_amount')

        # Validation des dates
        if date_from and date_to and date_from > date_to:
            self.add_error('date_to',
                _("La date 'Au' doit être postérieure à la date 'Du'."))

        # Validation des montants
        if min_amount and max_amount and min_amount > max_amount:
            self.add_error('max_amount',
                _("Le montant maximum doit être supérieur au montant minimum."))

        return cleaned_data


class RefundReviewForm(forms.ModelForm):
    """Formulaire pour examiner une demande de remboursement"""

    class Meta:
        model = Refund
        fields = ['status', 'review_notes', 'rejection_reason']
        widgets = {
            'status': forms.Select(attrs={
                'class': 'form-control',
                'id': 'refund-status'
            }),
            'review_notes': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _('Notes internes...')
            }),
            'rejection_reason': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': _('Raison du rejet (si applicable)...')
            }),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        # Limiter les statuts possibles selon le statut actuel
        if self.instance.status == Refund.Status.REQUESTED:
            self.fields['status'].choices = [
                ('UNDER_REVIEW', _('En revue')),
                ('APPROVED', _('Approuvé')),
                ('REJECTED', _('Rejeté')),
            ]
        elif self.instance.status == Refund.Status.UNDER_REVIEW:
            self.fields['status'].choices = [
                ('APPROVED', _('Approuvé')),
                ('REJECTED', _('Rejeté')),
            ]

    def clean(self):
        cleaned_data = super().clean()
        status = cleaned_data.get('status')
        rejection_reason = cleaned_data.get('rejection_reason')

        # Si le remboursement est rejeté, une raison est requise
        if status == Refund.Status.REJECTED and not rejection_reason:
            self.add_error('rejection_reason',
                _("Une raison de rejet est requise."))

        return cleaned_data


class PayoutProcessForm(forms.ModelForm):
    """Formulaire pour traiter un versement"""

    class Meta:
        model = Payout
        fields = ['status', 'payout_gateway_id']
        widgets = {
            'status': forms.Select(attrs={'class': 'form-control'}),
            'payout_gateway_id': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _('ID de la passerelle de paiement')
            }),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        # Limiter les statuts possibles
        if self.instance.status == Payout.Status.PENDING:
            self.fields['status'].choices = [
                ('PROCESSING', _('En traitement')),
                ('CANCELLED', _('Annulé')),
            ]
        elif self.instance.status == Payout.Status.PROCESSING:
            self.fields['status'].choices = [
                ('COMPLETED', _('Complété')),
                ('FAILED', _('Échoué')),
            ]

    def clean(self):
        cleaned_data = super().clean()
        status = cleaned_data.get('status')
        payout_gateway_id = cleaned_data.get('payout_gateway_id')

        # Si le versement est complété, un ID de passerelle est requis
        if status == Payout.Status.COMPLETED and not payout_gateway_id:
            self.add_error('payout_gateway_id',
                _("L'ID de la passerelle est requis pour les versements complétés."))

        return cleaned_data


# ============================================================================
# FORMULAIRES DE CONFIGURATION (EXISTANTS)
# ============================================================================

class TaxConfigurationForm(forms.ModelForm):
    """Formulaire pour configurer les taxes"""

    class Meta:
        model = Tax
        fields = ['country', 'tax_rate', 'tax_name', 'is_active',
                 'exempt_categories', 'minimum_amount']
        widgets = {
            'country': forms.Select(attrs={'class': 'form-control'}),
            'tax_rate': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
            'tax_name': forms.TextInput(attrs={'class': 'form-control'}),
            'is_active': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
            'minimum_amount': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
        }


class ExchangeRateForm(forms.ModelForm):
    """Formulaire pour configurer les taux de change"""

    class Meta:
        model = ExchangeRate
        fields = ['base_currency', 'target_currency', 'rate', 'source', 'is_active']
        widgets = {
            'base_currency': forms.Select(attrs={'class': 'form-control'}),
            'target_currency': forms.Select(attrs={'class': 'form-control'}),
            'rate': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.000001'
            }),
            'source': forms.TextInput(attrs={'class': 'form-control'}),
            'is_active': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }

    def clean(self):
        cleaned_data = super().clean()
        base_currency = cleaned_data.get('base_currency')
        target_currency = cleaned_data.get('target_currency')

        # Empêcher le même code de devise pour base et target
        if base_currency == target_currency:
            self.add_error('target_currency',
                _("La devise cible ne peut pas être identique à la devise de base."))

        return cleaned_data


class CommissionConfigurationForm(forms.Form):
    """Formulaire pour configurer les commissions"""

    ad_purchase_commission = forms.DecimalField(
        max_digits=5,
        decimal_places=4,
        min_value=Decimal('0'),
        max_value=Decimal('0.5'),
        initial=Decimal('0.10'),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.0001'
        }),
        label=_("Commission achat annonce (ex: 0.10 pour 10%)")
    )

    mission_payment_commission = forms.DecimalField(
        max_digits=5,
        decimal_places=4,
        min_value=Decimal('0'),
        max_value=Decimal('0.2'),
        initial=Decimal('0.05'),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.0001'
        }),
        label=_("Commission paiement mission")
    )

    wallet_transfer_commission = forms.DecimalField(
        max_digits=5,
        decimal_places=4,
        min_value=Decimal('0'),
        max_value=Decimal('0.05'),
        initial=Decimal('0.01'),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.0001'
        }),
        label=_("Commission transfert portefeuille")
    )

    minimum_payout_amount = forms.DecimalField(
        max_digits=10,
        decimal_places=2,
        min_value=Decimal('1'),
        initial=Decimal('50'),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01'
        }),
        label=_("Montant minimum versement (€)")
    )

    def clean(self):
        cleaned_data = super().clean()

        # Validation des taux de commission
        for field in ['ad_purchase_commission', 'mission_payment_commission', 'wallet_transfer_commission']:
            value = cleaned_data.get(field)
            if value and value > Decimal('0.5'):  # 50% max
                self.add_error(field,
                    _("La commission ne peut pas dépasser 50%."))

        return cleaned_data


# ============================================================================
# FORMULAIRES SPÉCIAUX POUR L'INTÉGRATION (EXISTANTS)
# ============================================================================

class AdPaymentForm(forms.Form):
    """Formulaire spécial pour le paiement d'une annonce"""

    ad = forms.ModelChoiceField(
        queryset=Ad.objects.filter(status=Ad.Status.ACTIVE),
        widget=forms.HiddenInput()
    )

    payment_type = forms.ChoiceField(
        choices=[
            ('AD_PURCHASE', _('Achat de l\'annonce')),
            ('AD_FEATURED', _('Mise en vedette (7 jours)')),
            ('AD_RESERVATION', _('Réservation de l\'annonce')),
        ],
        widget=forms.RadioSelect(attrs={
            'class': 'ad-payment-type'
        }),
        label=_("Type de paiement")
    )

    featured_duration = forms.ChoiceField(
        required=False,
        choices=[
            (7, _('7 jours - 10€')),
            (14, _('14 jours - 18€')),
            (30, _('30 jours - 30€')),
        ],
        widget=forms.Select(attrs={
            'class': 'form-control',
            'id': 'featured-duration'
        }),
        label=_("Durée de mise en vedette")
    )

    def __init__(self, *args, **kwargs):
        self.ad = kwargs.pop('ad', None)
        super().__init__(*args, **kwargs)

        if self.ad:
            self.fields['ad'].initial = self.ad
            self.fields['ad'].queryset = Ad.objects.filter(id=self.ad.id)

            # Si l'annonce est déjà en vedette, masquer l'option
            if self.ad.is_featured:
                self.fields['payment_type'].choices = [
                    ('AD_PURCHASE', _('Achat de l\'annonce')),
                    ('AD_RESERVATION', _('Réservation de l\'annonce')),
                ]

    def clean(self):
        cleaned_data = super().clean()
        payment_type = cleaned_data.get('payment_type')
        featured_duration = cleaned_data.get('featured_duration')

        if payment_type == 'AD_FEATURED' and not featured_duration:
            self.add_error('featured_duration',
                _("Veuillez sélectionner une durée pour la mise en vedette."))

        return cleaned_data


class MissionPaymentForm(forms.Form):
    """Formulaire spécial pour le paiement d'une mission"""

    mission = forms.ModelChoiceField(
        queryset=Mission.objects.filter(status__in=['PENDING_PAYMENT', 'CONFIRMED']),
        widget=forms.HiddenInput()
    )

    insurance_required = forms.BooleanField(
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={
            'class': 'form-check-input',
            'id': 'insurance-required'
        }),
        label=_("Ajouter une assurance transport")
    )

    insurance_amount = forms.DecimalField(
        required=False,
        min_value=Decimal('0'),
        max_value=Decimal('10000'),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01',
            'id': 'insurance-amount',
            'readonly': 'readonly'
        }),
        label=_("Montant assuré")
    )

    def __init__(self, *args, **kwargs):
        self.mission = kwargs.pop('mission', None)
        super().__init__(*args, **kwargs)

        if self.mission:
            self.fields['mission'].initial = self.mission
            self.fields['mission'].queryset = Mission.objects.filter(id=self.mission.id)

            # Calculer le montant de l'assurance (1% de la valeur)
            if hasattr(self.mission, 'calculated_price'):
                insurance_amount = self.mission.calculated_price * Decimal('0.01')
                self.fields['insurance_amount'].initial = insurance_amount

    def clean(self):
        cleaned_data = super().clean()
        insurance_required = cleaned_data.get('insurance_required')
        insurance_amount = cleaned_data.get('insurance_amount')

        if insurance_required and not insurance_amount:
            self.add_error('insurance_amount',
                _("Veuillez spécifier un montant d'assurance."))

        if insurance_amount and insurance_amount > Decimal('10000'):
            self.add_error('insurance_amount',
                _("Le montant d'assurance ne peut pas dépasser 10 000 €."))

        return cleaned_data


# ============================================================================
# FORMULAIRES DE RAPPORT (EXISTANTS)
# ============================================================================

class FinancialReportForm(forms.Form):
    """Formulaire pour générer des rapports financiers"""

    REPORT_TYPES = [
        ('DAILY', _('Journalier')),
        ('WEEKLY', _('Hebdomadaire')),
        ('MONTHLY', _('Mensuel')),
        ('QUARTERLY', _('Trimestriel')),
        ('YEARLY', _('Annuel')),
        ('CUSTOM', _('Personnalisé')),
    ]

    report_type = forms.ChoiceField(
        choices=REPORT_TYPES,
        widget=forms.Select(attrs={
            'class': 'form-control',
            'id': 'report-type'
        }),
        label=_("Type de rapport")
    )

    start_date = forms.DateField(
        required=False,
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control',
            'id': 'start-date'
        }),
        label=_("Date de début")
    )

    end_date = forms.DateField(
        required=False,
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control',
            'id': 'end-date'
        }),
        label=_("Date de fin")
    )

    currency = forms.ChoiceField(
        required=False,
        choices=[('', _('Toutes'))] + [
            ('EUR', '€ EUR'),
            ('USD', '$ USD'),
            ('MAD', 'DH MAD'),
        ],
        widget=forms.Select(attrs={'class': 'form-control'}),
        label=_("Devise")
    )

    payment_type = forms.ChoiceField(
        required=False,
        choices=[('', _('Tous'))] + list(PaymentTransaction.PaymentType.choices),
        widget=forms.Select(attrs={'class': 'form-control'}),
        label=_("Type de paiement")
    )

    include_details = forms.BooleanField(
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        label=_("Inclure les détails des transactions")
    )

    def clean(self):
        cleaned_data = super().clean()
        report_type = cleaned_data.get('report_type')
        start_date = cleaned_data.get('start_date')
        end_date = cleaned_data.get('end_date')

        if report_type == 'CUSTOM':
            if not start_date:
                self.add_error('start_date',
                    _("La date de début est requise pour un rapport personnalisé."))
            if not end_date:
                self.add_error('end_date',
                    _("La date de fin est requise pour un rapport personnalisé."))
            if start_date and end_date and start_date > end_date:
                self.add_error('end_date',
                    _("La date de fin doit être postérieure à la date de début."))

        return cleaned_data


# ============================================================================
# FORMULAIRES DE NOTIFICATION (EXISTANTS)
# ============================================================================

class PaymentNotificationForm(forms.Form):
    """Formulaire pour configurer les notifications de paiement"""

    email_payment_received = forms.BooleanField(
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        label=_("Email lors de la réception d'un paiement")
    )

    email_payment_sent = forms.BooleanField(
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        label=_("Email lors de l'envoi d'un paiement")
    )

    email_refund_processed = forms.BooleanField(
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        label=_("Email lors du traitement d'un remboursement")
    )

    email_payout_completed = forms.BooleanField(
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        label=_("Email lors de la complétion d'un versement")
    )

    push_notifications = forms.BooleanField(
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        label=_("Notifications push")
    )

    low_balance_alert = forms.DecimalField(
        required=False,
        min_value=Decimal('0'),
        max_value=Decimal('1000'),
        initial=Decimal('10'),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01'
        }),
        label=_("Alerte solde bas (€)")
    )


# ============================================================================
# FORMULAIRES FACTICES POUR COMPATIBILITÉ (NÉCESSAIRES POUR VIEWS.PY)
# ============================================================================

# Ces classes sont définies dans views.py mais référencées dans les imports
# Nous les définissons ici comme des alias pour éviter les erreurs d'import

# CardPaymentForm est un alias de CreditCardPaymentForm (déjà défini)
CardPaymentForm = CreditCardPaymentForm

# MobileMoneyPaymentForm est un alias de MobileMoneyForm (déjà défini)
MobileMoneyPaymentForm = MobileMoneyForm

# TaxForm est un alias de TaxConfigurationForm (déjà défini)
TaxForm = TaxConfigurationForm

# CommissionForm est un alias de CommissionConfigurationForm (déjà défini)
CommissionForm = CommissionConfigurationForm

# PaymentReportForm est un alias de FinancialReportForm (déjà défini)
PaymentReportForm = FinancialReportForm

# TransactionFilterForm est un alias de TransactionSearchForm (déjà défini)
TransactionFilterForm = TransactionSearchForm


# ============================================================================
# FORMSETS (AJOUTÉS POUR COMPATIBILITÉ)
# ============================================================================

# Formset pour InvoiceItem (si nécessaire dans les vues)
InvoiceItemFormSet = inlineformset_factory(
    Invoice,
    InvoiceItem,
    fields=['description', 'quantity', 'unit_price', 'tax_rate'],
    extra=1,
    can_delete=True,
    widgets={
        'description': forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _('Description de l\'article')
        }),
        'quantity': forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01',
            'min': '0.01'
        }),
        'unit_price': forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01',
            'min': '0'
        }),
        'tax_rate': forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01',
            'min': '0',
            'max': '100'
        }),
    }
)


========== payments/webhooks.py ==========
# ~/ebi3/payments/webhooks.py
"""
Gestion des webhooks pour les paiements
"""

import logging
import json
import hmac
import hashlib
from django.http import HttpResponse, JsonResponse
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_POST
from django.utils.decorators import method_decorator
from django.views import View
from django.conf import settings
from django.utils import timezone
from django.db import transaction

from .exceptions import WebhookVerificationError
from .models import Transaction, Invoice, Refund, Subscription
from .backends import PaymentBackendFactory
from .tasks import (
    notify_transaction_completed,
    generate_invoice_pdf_task,
    send_invoice_email
)

logger = logging.getLogger(__name__)


class WebhookHandler:
    """Gestionnaire de base pour les webhooks"""

    def __init__(self, backend_name):
        self.backend_name = backend_name
        self.backend = PaymentBackendFactory.get_backend(backend_name)

    def verify_signature(self, payload, signature, headers=None):
        """Vérifier la signature du webhook"""
        raise NotImplementedError

    def handle_event(self, event):
        """Traiter un événement de webhook"""
        raise NotImplementedError


class StripeWebhookHandler(WebhookHandler):
    """Gestionnaire de webhooks Stripe"""

    def __init__(self):
        super().__init__('stripe')

    def verify_signature(self, payload, signature, headers=None):
        """Vérifier la signature Stripe"""
        try:
            event = self.backend.verify_webhook(payload, signature)
            return event
        except Exception as e:
            logger.error(f"Stripe webhook signature verification failed: {str(e)}")
            raise WebhookVerificationError(
                message="Signature verification failed",
                signature=signature
            )

    def handle_event(self, event):
        """Traiter un événement Stripe"""
        event_type = event['type']
        event_data = event['data']['object']

        logger.info(f"Processing Stripe webhook: {event_type}")

        handlers = {
            'payment_intent.succeeded': self._handle_payment_intent_succeeded,
            'payment_intent.payment_failed': self._handle_payment_intent_failed,
            'payment_intent.canceled': self._handle_payment_intent_canceled,
            'charge.refunded': self._handle_charge_refunded,
            'charge.dispute.created': self._handle_charge_dispute_created,
            'invoice.payment_succeeded': self._handle_invoice_payment_succeeded,
            'invoice.payment_failed': self._handle_invoice_payment_failed,
            'customer.subscription.created': self._handle_subscription_created,
            'customer.subscription.updated': self._handle_subscription_updated,
            'customer.subscription.deleted': self._handle_subscription_deleted,
        }

        handler = handlers.get(event_type)
        if handler:
            return handler(event_data)

        logger.debug(f"Unhandled Stripe event type: {event_type}")
        return {'status': 'unhandled', 'event_type': event_type}

    def _handle_payment_intent_succeeded(self, payment_intent):
        """Traiter un paiement réussi"""
        try:
            with transaction.atomic():
                # Trouver la transaction
                transaction_obj = Transaction.objects.filter(
                    transaction_id=payment_intent['id']
                ).first()

                if not transaction_obj:
                    logger.warning(f"Transaction not found for payment intent: {payment_intent['id']}")
                    return {'status': 'transaction_not_found'}

                # Mettre à jour la transaction
                transaction_obj.status = 'COMPLETED'
                transaction_obj.processed_at = timezone.now()
                transaction_obj.gateway_response = json.dumps(payment_intent)
                transaction_obj.save()

                # Créer une facture
                invoice = Invoice.objects.create(
                    user=transaction_obj.user,
                    transaction=transaction_obj,
                    amount=transaction_obj.amount,
                    currency=transaction_obj.currency,
                    status='PAID',
                    invoice_number=Invoice.generate_invoice_number(),
                    due_date=timezone.now().date(),
                    paid_at=timezone.now()
                )

                logger.info(f"Payment succeeded: Transaction {transaction_obj.id}, Invoice {invoice.invoice_number}")

                # Tâches asynchrones
                notify_transaction_completed.delay(transaction_obj.id)
                generate_invoice_pdf_task.delay(invoice.id)

                return {
                    'status': 'success',
                    'transaction_id': transaction_obj.id,
                    'invoice_id': invoice.id
                }

        except Exception as e:
            logger.error(f"Error handling payment intent succeeded: {str(e)}")
            raise

    def _handle_payment_intent_failed(self, payment_intent):
        """Traiter un paiement échoué"""
        try:
            transaction_obj = Transaction.objects.filter(
                transaction_id=payment_intent['id']
            ).first()

            if transaction_obj:
                transaction_obj.status = 'FAILED'
                transaction_obj.gateway_response = json.dumps(payment_intent)
                transaction_obj.save()

                logger.info(f"Payment failed: Transaction {transaction_obj.id}")

            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling payment intent failed: {str(e)}")
            raise

    def _handle_payment_intent_canceled(self, payment_intent):
        """Traiter un paiement annulé"""
        try:
            transaction_obj = Transaction.objects.filter(
                transaction_id=payment_intent['id']
            ).first()

            if transaction_obj:
                transaction_obj.status = 'CANCELED'
                transaction_obj.gateway_response = json.dumps(payment_intent)
                transaction_obj.save()

                logger.info(f"Payment canceled: Transaction {transaction_obj.id}")

            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling payment intent canceled: {str(e)}")
            raise

    def _handle_charge_refunded(self, charge):
        """Traiter un remboursement"""
        try:
            with transaction.atomic():
                # Trouver la transaction originale
                transaction_obj = Transaction.objects.filter(
                    transaction_id=charge['payment_intent']
                ).first()

                if not transaction_obj:
                    logger.warning(f"Original transaction not found for refund: {charge['id']}")
                    return {'status': 'transaction_not_found'}

                # Créer un enregistrement de remboursement
                refund_amount = charge['amount_refunded'] / 100

                refund = Refund.objects.create(
                    transaction=transaction_obj,
                    amount=refund_amount,
                    currency=transaction_obj.currency,
                    reason='PROCESSOR_REFUND',
                    status='COMPLETED',
                    gateway_refund_id=charge['id'],
                    processed_at=timezone.now()
                )

                # Mettre à jour la transaction
                transaction_obj.refunded_amount = refund_amount
                transaction_obj.save()

                logger.info(f"Refund processed: Transaction {transaction_obj.id}, Refund {refund.id}")

                return {
                    'status': 'success',
                    'refund_id': refund.id,
                    'amount': refund_amount
                }

        except Exception as e:
            logger.error(f"Error handling charge refunded: {str(e)}")
            raise

    def _handle_charge_dispute_created(self, dispute):
        """Traiter une contestation (chargeback)"""
        try:
            transaction_obj = Transaction.objects.filter(
                transaction_id=dispute['payment_intent']
            ).first()

            if transaction_obj:
                transaction_obj.has_chargeback = True
                transaction_obj.chargeback_reason = dispute.get('reason', 'unknown')
                transaction_obj.save()

                logger.warning(f"Chargeback created: Transaction {transaction_obj.id}")

            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling charge dispute: {str(e)}")
            raise

    def _handle_invoice_payment_succeeded(self, invoice):
        """Traiter une facture payée (abonnement)"""
        try:
            subscription_id = invoice.get('subscription')
            if not subscription_id:
                return {'status': 'no_subscription'}

            # Trouver l'abonnement
            subscription = Subscription.objects.filter(
                gateway_subscription_id=subscription_id
            ).first()

            if subscription:
                # Créer une transaction pour le paiement de l'abonnement
                transaction_obj = Transaction.objects.create(
                    user=subscription.user,
                    amount=invoice['amount_paid'] / 100,
                    currency=invoice['currency'].upper(),
                    payment_method='CREDIT_CARD',
                    purpose='SUBSCRIPTION_PAYMENT',
                    status='COMPLETED',
                    transaction_id=invoice.get('payment_intent'),
                    gateway_response=json.dumps(invoice),
                    processed_at=timezone.now()
                )

                # Mettre à jour l'abonnement
                subscription.last_payment_date = timezone.now().date()
                subscription.next_billing_date = timezone.datetime.fromtimestamp(
                    invoice.get('lines', {}).get('data', [{}])[0].get('period', {}).get('end', 0)
                ).date() if invoice.get('lines') else None
                subscription.save()

                logger.info(f"Subscription payment succeeded: Subscription {subscription.id}, Transaction {transaction_obj.id}")

            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling invoice payment: {str(e)}")
            raise

    def _handle_invoice_payment_failed(self, invoice):
        """Traiter un échec de paiement de facture"""
        try:
            subscription_id = invoice.get('subscription')
            if not subscription_id:
                return {'status': 'no_subscription'}

            subscription = Subscription.objects.filter(
                gateway_subscription_id=subscription_id
            ).first()

            if subscription:
                subscription.status = 'PAST_DUE'
                subscription.save()

                logger.warning(f"Subscription payment failed: Subscription {subscription.id}")

            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling invoice payment failed: {str(e)}")
            raise

    def _handle_subscription_created(self, subscription_data):
        """Traiter la création d'un abonnement"""
        try:
            # Cette logique dépend de votre implémentation d'abonnement
            logger.info(f"Subscription created: {subscription_data['id']}")
            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling subscription created: {str(e)}")
            raise

    def _handle_subscription_updated(self, subscription_data):
        """Traiter la mise à jour d'un abonnement"""
        try:
            subscription = Subscription.objects.filter(
                gateway_subscription_id=subscription_data['id']
            ).first()

            if subscription:
                subscription.status = subscription_data['status'].upper()
                subscription.save()

                logger.info(f"Subscription updated: {subscription.id}")

            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling subscription updated: {str(e)}")
            raise

    def _handle_subscription_deleted(self, subscription_data):
        """Traiter la suppression d'un abonnement"""
        try:
            subscription = Subscription.objects.filter(
                gateway_subscription_id=subscription_data['id']
            ).first()

            if subscription:
                subscription.status = 'CANCELED'
                subscription.canceled_at = timezone.now()
                subscription.save()

                logger.info(f"Subscription canceled: {subscription.id}")

            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling subscription deleted: {str(e)}")
            raise


class PayPalWebhookHandler(WebhookHandler):
    """Gestionnaire de webhooks PayPal"""

    def __init__(self):
        super().__init__('paypal')

    def verify_signature(self, payload, signature, headers=None):
        """Vérifier la signature PayPal"""
        # PayPal utilise un header spécifique pour la transmission ID
        transmission_id = headers.get('PAYPAL-TRANSMISSION-ID') if headers else None

        if not transmission_id:
            raise WebhookVerificationError(message="Missing PayPal transmission ID")

        try:
            event = self.backend.verify_webhook(payload, signature, transmission_id)
            return event
        except Exception as e:
            logger.error(f"PayPal webhook verification failed: {str(e)}")
            raise WebhookVerificationError(
                message="Signature verification failed",
                signature=signature
            )

    def handle_event(self, event):
        """Traiter un événement PayPal"""
        event_type = event.get('event_type')

        logger.info(f"Processing PayPal webhook: {event_type}")

        handlers = {
            'PAYMENT.CAPTURE.COMPLETED': self._handle_payment_capture_completed,
            'PAYMENT.CAPTURE.DENIED': self._handle_payment_capture_denied,
            'PAYMENT.CAPTURE.REFUNDED': self._handle_payment_capture_refunded,
            'PAYMENT.CAPTURE.REVERSED': self._handle_payment_capture_reversed,
            'BILLING.SUBSCRIPTION.ACTIVATED': self._handle_subscription_activated,
            'BILLING.SUBSCRIPTION.CANCELLED': self._handle_subscription_cancelled,
        }

        handler = handlers.get(event_type)
        if handler:
            return handler(event.get('resource', {}))

        logger.debug(f"Unhandled PayPal event type: {event_type}")
        return {'status': 'unhandled', 'event_type': event_type}

    def _handle_payment_capture_completed(self, capture):
        """Traiter un paiement capturé"""
        try:
            with transaction.atomic():
                # Trouver la transaction
                transaction_obj = Transaction.objects.filter(
                    transaction_id=capture.get('id')
                ).first()

                if not transaction_obj:
                    logger.warning(f"Transaction not found for PayPal capture: {capture.get('id')}")
                    return {'status': 'transaction_not_found'}

                # Mettre à jour la transaction
                transaction_obj.status = 'COMPLETED'
                transaction_obj.processed_at = timezone.now()
                transaction_obj.gateway_response = json.dumps(capture)
                transaction_obj.save()

                # Créer une facture
                invoice = Invoice.objects.create(
                    user=transaction_obj.user,
                    transaction=transaction_obj,
                    amount=float(capture.get('amount', {}).get('value', 0)),
                    currency=capture.get('amount', {}).get('currency_code', 'EUR'),
                    status='PAID',
                    invoice_number=Invoice.generate_invoice_number(),
                    due_date=timezone.now().date(),
                    paid_at=timezone.now()
                )

                logger.info(f"PayPal payment completed: Transaction {transaction_obj.id}")

                # Tâches asynchrones
                notify_transaction_completed.delay(transaction_obj.id)
                generate_invoice_pdf_task.delay(invoice.id)

                return {
                    'status': 'success',
                    'transaction_id': transaction_obj.id,
                    'invoice_id': invoice.id
                }

        except Exception as e:
            logger.error(f"Error handling PayPal payment completed: {str(e)}")
            raise

    def _handle_payment_capture_denied(self, capture):
        """Traiter un paiement refusé"""
        try:
            transaction_obj = Transaction.objects.filter(
                transaction_id=capture.get('id')
            ).first()

            if transaction_obj:
                transaction_obj.status = 'FAILED'
                transaction_obj.gateway_response = json.dumps(capture)
                transaction_obj.save()

                logger.info(f"PayPal payment denied: Transaction {transaction_obj.id}")

            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling PayPal payment denied: {str(e)}")
            raise

    def _handle_payment_capture_refunded(self, refund):
        """Traiter un remboursement PayPal"""
        try:
            with transaction.atomic():
                # Trouver la capture originale
                capture_id = refund.get('capture_id')
                transaction_obj = Transaction.objects.filter(
                    transaction_id=capture_id
                ).first()

                if not transaction_obj:
                    logger.warning(f"Original transaction not found for PayPal refund: {capture_id}")
                    return {'status': 'transaction_not_found'}

                # Créer un enregistrement de remboursement
                refund_amount = float(refund.get('amount', {}).get('value', 0))

                refund_obj = Refund.objects.create(
                    transaction=transaction_obj,
                    amount=refund_amount,
                    currency=refund.get('amount', {}).get('currency_code', 'EUR'),
                    reason='PROCESSOR_REFUND',
                    status='COMPLETED',
                    gateway_refund_id=refund.get('id'),
                    processed_at=timezone.now()
                )

                # Mettre à jour la transaction
                transaction_obj.refunded_amount = refund_amount
                transaction_obj.save()

                logger.info(f"PayPal refund processed: Transaction {transaction_obj.id}")

                return {
                    'status': 'success',
                    'refund_id': refund_obj.id,
                    'amount': refund_amount
                }

        except Exception as e:
            logger.error(f"Error handling PayPal refund: {str(e)}")
            raise

    def _handle_payment_capture_reversed(self, capture):
        """Traiter un paiement annulé"""
        try:
            transaction_obj = Transaction.objects.filter(
                transaction_id=capture.get('id')
            ).first()

            if transaction_obj:
                transaction_obj.status = 'REVERSED'
                transaction_obj.gateway_response = json.dumps(capture)
                transaction_obj.save()

                logger.info(f"PayPal payment reversed: Transaction {transaction_obj.id}")

            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling PayPal payment reversed: {str(e)}")
            raise

    def _handle_subscription_activated(self, subscription):
        """Traiter l'activation d'un abonnement"""
        try:
            subscription_id = subscription.get('id')
            subscription_obj = Subscription.objects.filter(
                gateway_subscription_id=subscription_id
            ).first()

            if subscription_obj:
                subscription_obj.status = 'ACTIVE'
                subscription_obj.save()

                logger.info(f"PayPal subscription activated: {subscription_obj.id}")

            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling PayPal subscription activated: {str(e)}")
            raise

    def _handle_subscription_cancelled(self, subscription):
        """Traiter l'annulation d'un abonnement"""
        try:
            subscription_id = subscription.get('id')
            subscription_obj = Subscription.objects.filter(
                gateway_subscription_id=subscription_id
            ).first()

            if subscription_obj:
                subscription_obj.status = 'CANCELED'
                subscription_obj.canceled_at = timezone.now()
                subscription_obj.save()

                logger.info(f"PayPal subscription canceled: {subscription_obj.id}")

            return {'status': 'handled'}

        except Exception as e:
            logger.error(f"Error handling PayPal subscription canceled: {str(e)}")
            raise


class CustomWebhookHandler(WebhookHandler):
    """Gestionnaire de webhooks personnalisés"""

    def verify_signature(self, payload, signature, headers=None):
        """Vérifier la signature avec HMAC"""
        secret = getattr(settings, 'CUSTOM_WEBHOOK_SECRET', '')

        if not secret:
            logger.warning("Custom webhook secret not configured")
            return payload

        # Calculer le HMAC
        expected_signature = hmac.new(
            secret.encode('utf-8'),
            payload.encode('utf-8'),
            hashlib.sha256
        ).hexdigest()

        if not hmac.compare_digest(expected_signature, signature):
            raise WebhookVerificationError(
                message="HMAC signature verification failed",
                signature=signature
            )

        return json.loads(payload)

    def handle_event(self, event):
        """Traiter un événement personnalisé"""
        event_type = event.get('type')

        logger.info(f"Processing custom webhook: {event_type}")

        # Logique de traitement personnalisée
        # À adapter selon vos besoins

        return {'status': 'handled', 'event_type': event_type}


class WebhookView(View):
    """Vue de base pour les webhooks"""

    @method_decorator(csrf_exempt)
    @method_decorator(require_POST)
    def dispatch(self, *args, **kwargs):
        return super().dispatch(*args, **kwargs)

    def get_handler(self):
        """Obtenir le gestionnaire de webhook approprié"""
        raise NotImplementedError

    def post(self, request, *args, **kwargs):
        """Traiter un webhook POST"""
        try:
            # Récupérer les données
            payload = request.body.decode('utf-8')
            signature = request.headers.get('Stripe-Signature') or \
                       request.headers.get('PAYPAL-AUTH-ALGO') or \
                       request.headers.get('X-Signature') or \
                       request.headers.get('Signature', '')

            # Obtenir le gestionnaire
            handler = self.get_handler()

            # Vérifier la signature
            event = handler.verify_signature(payload, signature, request.headers)

            # Traiter l'événement
            result = handler.handle_event(event)

            logger.info(f"Webhook processed successfully: {result}")

            return JsonResponse({'status': 'success', 'result': result})

        except WebhookVerificationError as e:
            logger.error(f"Webhook verification failed: {str(e)}")
            return JsonResponse({'error': 'Invalid signature'}, status=400)
        except Exception as e:
            logger.error(f"Error processing webhook: {str(e)}")
            return JsonResponse({'error': 'Internal server error'}, status=500)


class StripeWebhookView(WebhookView):
    """Vue pour les webhooks Stripe"""

    def get_handler(self):
        return StripeWebhookHandler()


class PayPalWebhookView(WebhookView):
    """Vue pour les webhooks PayPal"""

    def get_handler(self):
        return PayPalWebhookHandler()


class CustomWebhookView(WebhookView):
    """Vue pour les webhooks personnalisés"""

    def get_handler(self):
        return CustomWebhookHandler()


@csrf_exempt
@require_POST
def stripe_webhook(request):
    """Endpoint webhook Stripe"""
    view = StripeWebhookView()
    return view.post(request)


@csrf_exempt
@require_POST
def paypal_webhook(request):
    """Endpoint webhook PayPal"""
    view = PayPalWebhookView()
    return view.post(request)


@csrf_exempt
@require_POST
def custom_webhook(request):
    """Endpoint webhook personnalisé"""
    view = CustomWebhookView()
    return view.post(request)


def test_webhook(request):
    """Endpoint de test pour les webhooks (développement uniquement)"""
    if not settings.DEBUG:
        return JsonResponse({'error': 'Not available in production'}, status=403)

    # Simuler un événement de test
    test_event = {
        'type': 'payment_intent.succeeded',
        'data': {
            'object': {
                'id': 'test_pi_123',
                'amount': 1000,
                'currency': 'eur',
                'status': 'succeeded',
            }
        }
    }

    handler = StripeWebhookHandler()
    result = handler.handle_event(test_event)

    return JsonResponse({
        'status': 'test_completed',
        'result': result
    })


========== payments/exceptions.py ==========
# ~/ebi3/payments/exceptions.py
"""
Exceptions personnalisées pour l'application payments
"""

class PaymentException(Exception):
    """Exception de base pour les paiements"""
    default_message = "Une erreur de paiement est survenue"

    def __init__(self, message=None, **kwargs):
        self.message = message or self.default_message
        self.kwargs = kwargs
        super().__init__(self.message)


class PaymentProcessingError(PaymentException):
    """Erreur lors du traitement d'un paiement"""
    default_message = "Erreur lors du traitement du paiement"


class PaymentValidationError(PaymentException):
    """Erreur de validation des données de paiement"""
    default_message = "Validation des données de paiement échouée"


class PaymentGatewayError(PaymentException):
    """Erreur de la passerelle de paiement"""
    default_message = "Erreur de la passerelle de paiement"

    def __init__(self, gateway=None, **kwargs):
        self.gateway = gateway
        super().__init__(**kwargs)


class StripeError(PaymentGatewayError):
    """Erreur spécifique à Stripe"""
    default_message = "Erreur Stripe"

    def __init__(self, stripe_error=None, **kwargs):
        self.stripe_error = stripe_error
        super().__init__(gateway='stripe', **kwargs)


class PayPalError(PaymentGatewayError):
    """Erreur spécifique à PayPal"""
    default_message = "Erreur PayPal"

    def __init__(self, paypal_error=None, **kwargs):
        self.paypal_error = paypal_error
        super().__init__(gateway='paypal', **kwargs)


class InsufficientFundsError(PaymentException):
    """Fonds insuffisants"""
    default_message = "Fonds insuffisants"


class CardDeclinedError(PaymentException):
    """Carte refusée"""
    default_message = "Carte refusée"

    def __init__(self, decline_code=None, **kwargs):
        self.decline_code = decline_code
        super().__init__(**kwargs)


class ExpiredCardError(CardDeclinedError):
    """Carte expirée"""
    default_message = "Carte expirée"


class InvalidCardError(CardDeclinedError):
    """Carte invalide"""
    default_message = "Carte invalide"


class CVVError(CardDeclinedError):
    """Code CVV incorrect"""
    default_message = "Code de sécurité incorrect"


class TransactionNotFoundError(PaymentException):
    """Transaction non trouvée"""
    default_message = "Transaction non trouvée"


class InvoiceNotFoundError(PaymentException):
    """Facture non trouvée"""
    default_message = "Facture non trouvée"


class RefundNotAllowedError(PaymentException):
    """Remboursement non autorisé"""
    default_message = "Remboursement non autorisé"

    def __init__(self, reason=None, **kwargs):
        self.reason = reason
        super().__init__(**kwargs)


class RefundAmountExceededError(RefundNotAllowedError):
    """Montant de remboursement dépassé"""
    default_message = "Le montant du remboursement dépasse le montant disponible"


class RefundTimeLimitExceededError(RefundNotAllowedError):
    """Délai de remboursement dépassé"""
    default_message = "Le délai de remboursement est dépassé"


class CurrencyMismatchError(PaymentException):
    """Incompatibilité de devises"""
    default_message = "Incompatibilité de devises"

    def __init__(self, expected=None, received=None, **kwargs):
        self.expected = expected
        self.received = received
        super().__init__(**kwargs)


class RateLimitExceededError(PaymentException):
    """Limite de taux dépassée"""
    default_message = "Trop de tentatives. Veuillez réessayer plus tard."

    def __init__(self, retry_after=None, **kwargs):
        self.retry_after = retry_after
        super().__init__(**kwargs)


class WebhookVerificationError(PaymentException):
    """Erreur de vérification du webhook"""
    default_message = "Échec de la vérification du webhook"

    def __init__(self, signature=None, **kwargs):
        self.signature = signature
        super().__init__(**kwargs)


class FraudDetectionError(PaymentException):
    """Détection de fraude"""
    default_message = "Transaction suspecte détectée"

    def __init__(self, risk_level=None, **kwargs):
        self.risk_level = risk_level
        super().__init__(**kwargs)


class SubscriptionError(PaymentException):
    """Erreur d'abonnement"""
    default_message = "Erreur d'abonnement"


class PlanNotFoundError(SubscriptionError):
    """Plan non trouvé"""
    default_message = "Plan d'abonnement non trouvé"


class SubscriptionAlreadyExistsError(SubscriptionError):
    """Abonnement déjà existant"""
    default_message = "Un abonnement actif existe déjà"


class SubscriptionCancelledError(SubscriptionError):
    """Abonnement annulé"""
    default_message = "L'abonnement a été annulé"


class CouponError(PaymentException):
    """Erreur de coupon"""
    default_message = "Erreur de coupon"


class CouponNotFoundError(CouponError):
    """Coupon non trouvé"""
    default_message = "Coupon non trouvé"


class CouponExpiredError(CouponError):
    """Coupon expiré"""
    default_message = "Le coupon a expiré"


class CouponUsageLimitExceededError(CouponError):
    """Limite d'utilisation du coupon dépassée"""
    default_message = "Limite d'utilisation du coupon dépassée"


class TaxCalculationError(PaymentException):
    """Erreur de calcul des taxes"""
    default_message = "Erreur lors du calcul des taxes"


class AddressValidationError(PaymentException):
    """Erreur de validation d'adresse"""
    default_message = "Adresse invalide"


class PaymentSessionExpiredError(PaymentException):
    """Session de paiement expirée"""
    default_message = "La session de paiement a expiré"


class PaymentSessionNotFoundError(PaymentException):
    """Session de paiement non trouvée"""
    default_message = "Session de paiement non trouvée"


class PaymentMethodNotSupportedError(PaymentException):
    """Méthode de paiement non supportée"""
    default_message = "Méthode de paiement non supportée"

    def __init__(self, method=None, **kwargs):
        self.method = method
        super().__init__(**kwargs)


class BankTransferTimeoutError(PaymentException):
    """Timeout du virement bancaire"""
    default_message = "Le virement bancaire a expiré"


class MobilePaymentError(PaymentException):
    """Erreur de paiement mobile"""
    default_message = "Erreur de paiement mobile"


class CryptoPaymentError(PaymentException):
    """Erreur de paiement crypto"""
    default_message = "Erreur de paiement cryptomonnaie"


class PaymentReconciliationError(PaymentException):
    """Erreur de rapprochement de paiement"""
    default_message = "Erreur lors du rapprochement du paiement"


class InvoiceGenerationError(PaymentException):
    """Erreur de génération de facture"""
    default_message = "Erreur lors de la génération de la facture"


class PDFGenerationError(InvoiceGenerationError):
    """Erreur de génération de PDF"""
    default_message = "Erreur lors de la génération du PDF"


class EmailDeliveryError(PaymentException):
    """Erreur d'envoi d'email"""
    default_message = "Erreur lors de l'envoi de l'email"


class DatabaseIntegrityError(PaymentException):
    """Erreur d'intégrité de la base de données"""
    default_message = "Erreur d'intégrité de la base de données"


class PaymentMiddlewareError(PaymentException):
    """Erreur du middleware de paiement"""
    default_message = "Erreur du middleware de paiement"


class PaymentSecurityError(PaymentException):
    """Erreur de sécurité du paiement"""
    default_message = "Erreur de sécurité du paiement"


class PaymentTimeoutError(PaymentException):
    """Timeout du paiement"""
    default_message = "Le paiement a expiré"

    def __init__(self, timeout_seconds=None, **kwargs):
        self.timeout_seconds = timeout_seconds
        super().__init__(**kwargs)


class PartialPaymentError(PaymentException):
    """Erreur de paiement partiel"""
    default_message = "Paiement partiel non autorisé"


class PaymentAlreadyProcessedError(PaymentException):
    """Paiement déjà traité"""
    default_message = "Ce paiement a déjà été traité"


class PaymentCancelledError(PaymentException):
    """Paiement annulé"""
    default_message = "Le paiement a été annulé"


class PaymentRefundedError(PaymentException):
    """Paiement remboursé"""
    default_message = "Le paiement a été remboursé"


class PaymentChargebackError(PaymentException):
    """Contestation de paiement"""
    default_message = "Contestation de paiement reçue"


class PaymentGatewayUnavailableError(PaymentGatewayError):
    """Passerelle de paiement indisponible"""
    default_message = "Passerelle de paiement temporairement indisponible"


class PaymentConfigurationError(PaymentException):
    """Erreur de configuration du paiement"""
    default_message = "Erreur de configuration du paiement"

    def __init__(self, setting=None, **kwargs):
        self.setting = setting
        super().__init__(**kwargs)


class PaymentTestModeError(PaymentException):
    """Erreur en mode test"""
    default_message = "Erreur en mode test - Utilisez des cartes de test"


class PaymentLiveModeRequiredError(PaymentException):
    """Mode live requis"""
    default_message = "Le mode live est requis pour cette opération"


class PaymentTestModeRequiredError(PaymentException):
    """Mode test requis"""
    default_message = "Le mode test est requis pour cette opération"


def handle_payment_exception(exception):
    """
    Gestionnaire centralisé des exceptions de paiement
    """
    from django.contrib import messages
    from django.utils.translation import gettext_lazy as _

    error_messages = {
        'InsufficientFundsError': _("Fonds insuffisants sur votre compte."),
        'CardDeclinedError': _("Votre carte a été refusée. Veuillez contacter votre banque."),
        'ExpiredCardError': _("Votre carte a expiré. Utilisez une autre carte."),
        'InvalidCardError': _("Carte invalide. Vérifiez les informations saisies."),
        'CVVError': _("Code de sécurité incorrect."),
        'PaymentSessionExpiredError': _("Votre session a expiré. Veuillez recommencer."),
        'RateLimitExceededError': _("Trop de tentatives. Réessayez dans quelques minutes."),
        'FraudDetectionError': _("Transaction suspecte détectée. Contactez le support."),
        'PaymentGatewayUnavailableError': _("Service temporairement indisponible. Réessayez plus tard."),
    }

    exception_name = exception.__class__.__name__
    message = error_messages.get(exception_name, str(exception))

    return {
        'error': True,
        'message': message,
        'exception': exception_name,
        'code': getattr(exception, 'code', 'UNKNOWN_ERROR')
    }


class PaymentErrorCodes:
    """Codes d'erreur standardisés pour les paiements"""

    # Erreurs générales
    UNKNOWN_ERROR = 'PAYMENT_UNKNOWN_ERROR'
    VALIDATION_ERROR = 'PAYMENT_VALIDATION_ERROR'
    PROCESSING_ERROR = 'PAYMENT_PROCESSING_ERROR'

    # Erreurs de carte
    CARD_DECLINED = 'CARD_DECLINED'
    EXPIRED_CARD = 'EXPIRED_CARD'
    INVALID_CARD = 'INVALID_CARD'
    INCORRECT_CVV = 'INCORRECT_CVV'
    INSUFFICIENT_FUNDS = 'INSUFFICIENT_FUNDS'

    # Erreurs de sécurité
    FRAUD_DETECTED = 'FRAUD_DETECTED'
    RATE_LIMIT_EXCEEDED = 'RATE_LIMIT_EXCEEDED'
    SECURITY_VIOLATION = 'SECURITY_VIOLATION'

    # Erreurs de session
    SESSION_EXPIRED = 'SESSION_EXPIRED'
    SESSION_INVALID = 'SESSION_INVALID'

    # Erreurs de remboursement
    REFUND_NOT_ALLOWED = 'REFUND_NOT_ALLOWED'
    REFUND_AMOUNT_EXCEEDED = 'REFUND_AMOUNT_EXCEEDED'
    REFUND_TIME_LIMIT_EXCEEDED = 'REFUND_TIME_LIMIT_EXCEEDED'

    # Erreurs d'abonnement
    SUBSCRIPTION_ERROR = 'SUBSCRIPTION_ERROR'
    PLAN_NOT_FOUND = 'PLAN_NOT_FOUND'
    SUBSCRIPTION_EXISTS = 'SUBSCRIPTION_EXISTS'

    # Erreurs de coupon
    COUPON_INVALID = 'COUPON_INVALID'
    COUPON_EXPIRED = 'COUPON_EXPIRED'
    COUPON_LIMIT_EXCEEDED = 'COUPON_LIMIT_EXCEEDED'

    # Erreurs de passerelle
    GATEWAY_ERROR = 'GATEWAY_ERROR'
    GATEWAY_UNAVAILABLE = 'GATEWAY_UNAVAILABLE'
    GATEWAY_TIMEOUT = 'GATEWAY_TIMEOUT'

    # Erreurs de configuration
    CONFIGURATION_ERROR = 'CONFIGURATION_ERROR'
    TEST_MODE_REQUIRED = 'TEST_MODE_REQUIRED'
    LIVE_MODE_REQUIRED = 'LIVE_MODE_REQUIRED'

    # Erreurs de devise
    CURRENCY_MISMATCH = 'CURRENCY_MISMATCH'
    CURRENCY_NOT_SUPPORTED = 'CURRENCY_NOT_SUPPORTED'

    # Erreurs de taxe
    TAX_CALCULATION_ERROR = 'TAX_CALCULATION_ERROR'
    TAX_RATE_INVALID = 'TAX_RATE_INVALID'


========== payments/__init__.py ==========



========== payments/apps.py ==========
from django.apps import AppConfig


class PaymentsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "payments"



========== payments/tasks.py ==========
# ~/ebi3/payments/tasks.py
from celery import shared_task
from django.utils import timezone
from django.core.mail import send_mail
from django.template.loader import render_to_string
from django.conf import settings
from django.utils.translation import gettext_lazy as _
import logging
from datetime import timedelta

from .models import Transaction, Invoice
from .utils import generate_invoice_pdf

logger = logging.getLogger(__name__)

@shared_task
def process_pending_transactions():
    """
    Tâche périodique pour traiter les transactions en attente
    et mettre à jour leur statut si nécessaire.
    """
    try:
        # Transactions en attente depuis plus de 30 minutes
        cutoff_time = timezone.now() - timedelta(minutes=30)
        pending_transactions = Transaction.objects.filter(
            status='PENDING',
            created_at__lt=cutoff_time
        ).exclude(payment_method__in=['CASH', 'BANK_TRANSFER'])

        for transaction in pending_transactions:
            transaction.status = 'EXPIRED'
            transaction.save(update_fields=['status'])

            # Envoyer une notification
            notify_transaction_expired.delay(transaction.id)

        logger.info(f"Processed {pending_transactions.count()} expired transactions")
        return f"Processed {pending_transactions.count()} expired transactions"

    except Exception as e:
        logger.error(f"Error processing pending transactions: {str(e)}")
        raise

@shared_task
def generate_invoice_pdf_task(invoice_id):
    """
    Générer un PDF d'invoice en arrière-plan
    """
    try:
        invoice = Invoice.objects.get(id=invoice_id)
        pdf_path = generate_invoice_pdf(invoice)

        invoice.invoice_pdf = pdf_path
        invoice.save(update_fields=['invoice_pdf'])

        logger.info(f"Invoice PDF generated for invoice {invoice.invoice_number}")
        return pdf_path

    except Invoice.DoesNotExist:
        logger.error(f"Invoice with id {invoice_id} does not exist")
        return None
    except Exception as e:
        logger.error(f"Error generating invoice PDF: {str(e)}")
        raise

@shared_task
def notify_transaction_created(transaction_id):
    """
    Envoyer une notification par email lorsqu'une transaction est créée
    """
    try:
        transaction = Transaction.objects.get(id=transaction_id)

        context = {
            'transaction': transaction,
            'user': transaction.user,
            'site_name': settings.SITE_NAME,
            'site_url': settings.SITE_URL,
        }

        # Email au vendeur
        if transaction.user and transaction.user.email:
            seller_subject = _("Nouvelle transaction créée - {site_name}").format(
                site_name=settings.SITE_NAME
            )
            seller_message = render_to_string(
                'payments/emails/transaction_created_seller.html',
                context
            )

            send_mail(
                subject=seller_subject,
                message=seller_subject,
                html_message=seller_message,
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=[transaction.user.email],
                fail_silently=True
            )

        # Email à l'acheteur (si différent du vendeur)
        if hasattr(transaction, 'ad') and transaction.ad.seller.email:
            if transaction.user != transaction.ad.seller:
                buyer_subject = _("Votre paiement a été initié - {site_name}").format(
                    site_name=settings.SITE_NAME
                )
                buyer_message = render_to_string(
                    'payments/emails/transaction_created_buyer.html',
                    context
                )

                send_mail(
                    subject=buyer_subject,
                    message=buyer_subject,
                    html_message=buyer_message,
                    from_email=settings.DEFAULT_FROM_EMAIL,
                    recipient_list=[transaction.ad.seller.email],
                    fail_silently=True
                )

        logger.info(f"Notification sent for transaction {transaction.id}")
        return True

    except Transaction.DoesNotExist:
        logger.error(f"Transaction with id {transaction_id} does not exist")
        return False
    except Exception as e:
        logger.error(f"Error sending transaction notification: {str(e)}")
        raise

@shared_task
def notify_transaction_completed(transaction_id):
    """
    Envoyer une notification par email lorsqu'une transaction est complétée
    """
    try:
        transaction = Transaction.objects.get(id=transaction_id)

        context = {
            'transaction': transaction,
            'user': transaction.user,
            'site_name': settings.SITE_NAME,
            'site_url': settings.SITE_URL,
        }

        subject = _("Transaction complétée - {site_name}").format(
            site_name=settings.SITE_NAME
        )

        # Email au vendeur
        if transaction.user and transaction.user.email:
            seller_message = render_to_string(
                'payments/emails/transaction_completed_seller.html',
                context
            )

            send_mail(
                subject=subject,
                message=subject,
                html_message=seller_message,
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=[transaction.user.email],
                fail_silently=True
            )

        # Email à l'acheteur (si ad liée)
        if hasattr(transaction, 'ad') and transaction.ad.seller.email:
            buyer_message = render_to_string(
                'payments/emails/transaction_completed_buyer.html',
                context
            )

            send_mail(
                subject=subject,
                message=subject,
                html_message=buyer_message,
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=[transaction.ad.seller.email],
                fail_silently=True
            )

        logger.info(f"Completion notification sent for transaction {transaction.id}")
        return True

    except Transaction.DoesNotExist:
        logger.error(f"Transaction with id {transaction_id} does not exist")
        return False
    except Exception as e:
        logger.error(f"Error sending completion notification: {str(e)}")
        raise

@shared_task
def notify_transaction_expired(transaction_id):
    """
    Envoyer une notification par email lorsqu'une transaction a expiré
    """
    try:
        transaction = Transaction.objects.get(id=transaction_id)

        context = {
            'transaction': transaction,
            'user': transaction.user,
            'site_name': settings.SITE_NAME,
            'site_url': settings.SITE_URL,
        }

        subject = _("Transaction expirée - {site_name}").format(
            site_name=settings.SITE_NAME
        )

        if transaction.user and transaction.user.email:
            message = render_to_string(
                'payments/emails/transaction_expired.html',
                context
            )

            send_mail(
                subject=subject,
                message=subject,
                html_message=message,
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=[transaction.user.email],
                fail_silently=True
            )

        logger.info(f"Expiration notification sent for transaction {transaction.id}")
        return True

    except Transaction.DoesNotExist:
        logger.error(f"Transaction with id {transaction_id} does not exist")
        return False
    except Exception as e:
        logger.error(f"Error sending expiration notification: {str(e)}")
        raise

@shared_task
def send_invoice_email(invoice_id):
    """
    Envoyer une facture par email
    """
    try:
        invoice = Invoice.objects.get(id=invoice_id)

        if not invoice.invoice_pdf:
            # Générer le PDF si pas encore fait
            generate_invoice_pdf_task.delay(invoice_id)
            return "PDF generation queued"

        context = {
            'invoice': invoice,
            'user': invoice.user,
            'site_name': settings.SITE_NAME,
            'site_url': settings.SITE_URL,
        }

        subject = _("Votre facture {invoice_number} - {site_name}").format(
            invoice_number=invoice.invoice_number,
            site_name=settings.SITE_NAME
        )

        message = render_to_string('payments/emails/invoice_sent.html', context)

        # Préparer l'email avec pièce jointe
        from django.core.mail import EmailMessage

        email = EmailMessage(
            subject=subject,
            body=subject,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[invoice.user.email] if invoice.user.email else []
        )

        email.attach_file(invoice.invoice_pdf.path)
        email.content_subtype = "html"
        email.send()

        invoice.sent_at = timezone.now()
        invoice.save(update_fields=['sent_at'])

        logger.info(f"Invoice email sent for invoice {invoice.invoice_number}")
        return True

    except Invoice.DoesNotExist:
        logger.error(f"Invoice with id {invoice_id} does not exist")
        return False
    except Exception as e:
        logger.error(f"Error sending invoice email: {str(e)}")
        raise

@shared_task
def cleanup_old_payment_sessions():
    """
    Nettoyer les anciennes sessions de paiement
    """
    try:
        from .models import PaymentSession
        cutoff_time = timezone.now() - timedelta(hours=24)

        deleted_count, _ = PaymentSession.objects.filter(
            created_at__lt=cutoff_time,
            status__in=['PENDING', 'EXPIRED']
        ).delete()

        logger.info(f"Cleaned up {deleted_count} old payment sessions")
        return f"Cleaned up {deleted_count} old payment sessions"

    except Exception as e:
        logger.error(f"Error cleaning up payment sessions: {str(e)}")
        raise

@shared_task
def process_recurring_payments():
    """
    Traiter les paiements récurrents
    """
    try:
        from .models import Subscription
        today = timezone.now().date()

        # Trouver les abonnements à renouveler
        subscriptions = Subscription.objects.filter(
            status='ACTIVE',
            next_billing_date__lte=today,
            auto_renew=True
        )

        renewed_count = 0
        for subscription in subscriptions:
            try:
                # Créer une nouvelle transaction
                from .models import Transaction

                transaction = Transaction.objects.create(
                    user=subscription.user,
                    amount=subscription.plan.price,
                    currency=subscription.plan.currency,
                    payment_method=subscription.payment_method,
                    purpose='SUBSCRIPTION_RENEWAL',
                    status='PENDING',
                    metadata={
                        'subscription_id': subscription.id,
                        'plan_id': subscription.plan.id,
                        'renewal_period': subscription.current_period_end
                    }
                )

                # Mettre à jour la date de prochain paiement
                subscription.current_period_end = subscription.next_billing_date
                subscription.next_billing_date = subscription.next_billing_date + timedelta(
                    days=subscription.plan.billing_cycle_days
                )
                subscription.save()

                renewed_count += 1
                logger.info(f"Renewed subscription {subscription.id}")

            except Exception as e:
                logger.error(f"Error renewing subscription {subscription.id}: {str(e)}")
                continue

        return f"Processed {renewed_count} recurring payments"

    except Exception as e:
        logger.error(f"Error processing recurring payments: {str(e)}")
        raise

@shared_task(bind=True, max_retries=3)
def retry_failed_payment(self, transaction_id):
    """
    Réessayer un paiement échoué
    """
    try:
        transaction = Transaction.objects.get(id=transaction_id)

        if transaction.status != 'FAILED':
            return "Transaction not in FAILED status"

        # Logique de réessai
        # À adapter selon le backend de paiement

        transaction.status = 'PENDING'
        transaction.retry_count = transaction.retry_count + 1
        transaction.save(update_fields=['status', 'retry_count'])

        logger.info(f"Retried failed payment for transaction {transaction.id}")
        return True

    except Transaction.DoesNotExist:
        logger.error(f"Transaction with id {transaction_id} does not exist")
        return False
    except Exception as exc:
        logger.error(f"Error retrying payment: {str(exc)}")
        self.retry(countdown=60 * (2 ** self.request.retries), exc=exc)
        raise


========== payments/urls.py ==========
# ~/ebi3/payments/urls.py
from django.urls import path
from django.contrib.auth.decorators import login_required
from . import views

app_name = 'payments'

urlpatterns = [
    # ============================================================================
    # VUES PUBLIQUES
    # ============================================================================
    path('', views.PaymentHomeView.as_view(), name='home'),
    path('methods/', views.PaymentMethodsView.as_view(), name='payment_methods'),
    path('error/<str:error_code>/', views.PaymentErrorView.as_view(), name='payment_error'),

    # ============================================================================
    # CHECKOUT & PROCESSUS DE PAIEMENT
    # ============================================================================
    path('checkout/', login_required(views.CheckoutView.as_view()), name='checkout'),
    path('card-payment/<uuid:session_id>/', login_required(views.CardPaymentView.as_view()), name='card_payment'),
    path('success/<int:pk>/', login_required(views.PaymentSuccessView.as_view()), name='payment_success'),
    path('failed/', login_required(views.PaymentFailedView.as_view()), name='payment_failed'),

    # ============================================================================
    # GESTION DU PORTEFEUILLE
    # ============================================================================
    path('wallet/', login_required(views.WalletDashboardView.as_view()), name='wallet_dashboard'),
    path('wallet/recharge/', login_required(views.WalletRechargeView.as_view()), name='wallet_recharge'),
    path('wallet/transactions/', login_required(views.WalletTransactionsView.as_view()), name='wallet_transactions'),
    path('wallet/create/', login_required(views.WalletCreateView.as_view()), name='wallet_create'),

    # ============================================================================
    # FACTURES ET DOCUMENTS
    # ============================================================================
    path('invoices/', login_required(views.InvoiceListView.as_view()), name='invoice_list'),
    path('invoices/<int:pk>/', login_required(views.InvoiceDetailView.as_view()), name='invoice_detail'),

    # ============================================================================
    # REMBOURSEMENTS
    # ============================================================================
    path('refunds/request/', login_required(views.RefundRequestView.as_view()), name='refund_request'),
    path('refunds/', login_required(views.RefundListView.as_view()), name='refund_list'),

    # ============================================================================
    # ADMINISTRATION (STAFF)
    # ============================================================================
    path('admin/dashboard/', views.StaffPaymentDashboardView.as_view(), name='staff_dashboard'),
    path('admin/transactions/', views.StaffTransactionListView.as_view(), name='staff_transaction_list'),

    # ============================================================================
    # VUES UTILITAIRES (API/FONCTIONS)
    # ============================================================================
    path('api/verify-payment/<str:reference>/', login_required(views.verify_payment_status), name='verify_payment_status'),
    path('api/payment-methods/', login_required(views.payment_methods_json), name='payment_methods_json'),
    path('api/currency-rates/', login_required(views.currency_rates_json), name='currency_rates_json'),
    path('redirect/', views.payment_redirect, name='payment_redirect'),

    # ============================================================================
    # ALIAS ET REDIRECTIONS POUR COMPATIBILITÉ
    # ============================================================================
    path('payment-status/<uuid:session_id>/', login_required(views.PaymentFailedView.as_view()), name='payment_status'),
]


# URLs supplémentaires si vous développez d'autres fonctionnalités

# PayPal (si implémenté)
# path('paypal-payment/<uuid:session_id>/', login_required(views.PayPalPaymentView.as_view()), name='paypal_payment'),
# path('paypal/execute/<uuid:session_id>/', login_required(views.PayPalExecuteView.as_view()), name='paypal_execute'),
# path('paypal/cancel/<uuid:session_id>/', login_required(views.PayPalCancelView.as_view()), name='paypal_cancel'),

# Mobile Money (si implémenté)
# path('mobile-money/<uuid:session_id>/', login_required(views.MobileMoneyPaymentView.as_view()), name='mobile_money_payment'),

# Bank Transfer (si implémenté)
# path('bank-transfer/<uuid:session_id>/', login_required(views.BankTransferView.as_view()), name='bank_transfer'),

# Wallet Payment (si implémenté)
# path('wallet-payment/<uuid:session_id>/', login_required(views.WalletPaymentView.as_view()), name='wallet_payment'),

# Crypto (si implémenté)
# path('crypto-payment/<uuid:session_id>/', login_required(views.CryptoPaymentView.as_view()), name='crypto_payment'),

# Webhooks (si implémenté)
# path('webhook/<str:gateway>/', views.PaymentWebhookView.as_view(), name='payment_webhook'),

# API supplémentaires
# path('api/calculate-fees/', login_required(views.CalculateFeesAPIView.as_view()), name='calculate_fees'),


========== payments/models.py ==========
# ~/ebi3/payments/models.py
from django.db import models
from django.utils.translation import gettext_lazy as _
from django.core.validators import MinValueValidator, MaxValueValidator
from django.conf import settings
from django.utils import timezone
from django.utils.text import slugify
from django.urls import reverse
import uuid
import json
from decimal import Decimal
from cryptography.fernet import Fernet
from django.core.exceptions import ValidationError
from django_countries.fields import CountryField
import hashlib
import hmac

# Import des applications liées
from ads.models import Ad
from carriers.models import Carrier
from logistics.models import Mission, TransportProposal
from users.models import User

# Liste commune des devises pour maintenir la cohérence
CURRENCY_CHOICES = [
    ('EUR', '€'),
    ('USD', '$'),
    ('GBP', '£'),
    ('MAD', 'DH'),
    ('XOF', 'CFA'),
    ('XAF', 'FCFA'),
    ('TND', 'DT'),      # Dinar tunisien - AJOUT
    ('DZD', 'DA'),      # Dinar algérien - AJOUT
]

# Validateurs personnalisés
def validate_iban(value):
    """Validation basique d'IBAN"""
    if not value.startswith(('FR', 'BE', 'DE', 'ES', 'IT', 'LU', 'NL')):
        raise ValidationError(_("IBAN non supporté. Seuls les IBAN européens sont acceptés."))
    if len(value) < 15 or len(value) > 34:
        raise ValidationError(_("IBAN invalide."))
    return value

def validate_card_number(value):
    """Validation de numéro de carte (algorithme de Luhn)"""
    def luhn_checksum(card_number):
        def digits_of(n):
            return [int(d) for d in str(n)]
        digits = digits_of(card_number)
        odd_digits = digits[-1::-2]
        even_digits = digits[-2::-2]
        checksum = sum(odd_digits)
        for d in even_digits:
            checksum += sum(digits_of(d * 2))
        return checksum % 10

    if luhn_checksum(value) != 0:
        raise ValidationError(_("Numéro de carte invalide."))
    return value

def validate_expiry_date(value):
    """Validation de date d'expiration"""
    if value < timezone.now().date():
        raise ValidationError(_("La date d'expiration est dépassée."))
    return value

# ============================================================================
# NOUVEAU MODÈLE : PaymentCard (carte bancaire sauvegardée)
# ============================================================================

class PaymentCard(models.Model):
    """Carte bancaire enregistrée par l'utilisateur"""

    class CardType(models.TextChoices):
        VISA = 'VISA', _('Visa')
        MASTERCARD = 'MASTERCARD', _('Mastercard')
        AMEX = 'AMEX', _('American Express')
        DISCOVER = 'DISCOVER', _('Discover')
        DINERS = 'DINERS', _('Diners Club')
        JCB = 'JCB', _('JCB')
        UNKNOWN = 'UNKNOWN', _('Inconnu')

    user = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='payment_cards',
        verbose_name=_("Utilisateur")
    )

    # Informations masquées
    last_four = models.CharField(
        max_length=4,
        verbose_name=_("4 derniers chiffres")
    )
    expiry_month = models.CharField(
        max_length=2,
        verbose_name=_("Mois d'expiration")
    )
    expiry_year = models.CharField(
        max_length=4,
        verbose_name=_("Année d'expiration")
    )
    cardholder_name = models.CharField(
        max_length=100,
        verbose_name=_("Nom du titulaire")
    )
    card_type = models.CharField(
        max_length=20,
        choices=CardType.choices,
        default=CardType.UNKNOWN,
        verbose_name=_("Type de carte")
    )

    # Données sécurisées (chiffrées)
    token = models.CharField(
        max_length=255,
        blank=True,
        verbose_name=_("Token sécurisé")
    )
    provider = models.CharField(
        max_length=50,
        default='STRIPE',
        verbose_name=_("Fournisseur")
    )

    # Métadonnées
    is_default = models.BooleanField(
        default=False,
        verbose_name=_("Carte par défaut")
    )
    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Active")
    )
    is_verified = models.BooleanField(
        default=False,
        verbose_name=_("Vérifiée")
    )

    # Utilisation
    last_used = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Dernière utilisation")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Carte bancaire")
        verbose_name_plural = _("Cartes bancaires")
        ordering = ['-is_default', '-last_used']
        unique_together = ['user', 'token']

    def __str__(self):
        return f"{self.get_card_type_display()} **** {self.last_four}"

    def save(self, *args, **kwargs):
        # Si c'est la carte par défaut, désactiver les autres
        if self.is_default and self.is_active:
            PaymentCard.objects.filter(
                user=self.user,
                is_default=True
            ).exclude(id=self.id).update(is_default=False)
        super().save(*args, **kwargs)

    def mask_display(self):
        """Retourne une version masquée pour l'affichage"""
        return f"{self.get_card_type_display()} **** **** **** {self.last_four}"

    def expiry_date_display(self):
        """Format d'expiration pour l'affichage"""
        return f"{self.expiry_month}/{self.expiry_year[-2:]}"

    def is_expired(self):
        """Vérifie si la carte est expirée"""
        today = timezone.now().date()
        expiry_date = timezone.datetime(
            year=int(self.expiry_year),
            month=int(self.expiry_month),
            day=1
        ).date()
        return expiry_date < today

    @staticmethod
    def detect_card_type(card_number):
        """Détecte le type de carte à partir du numéro"""
        card_number = str(card_number).replace(' ', '')

        if card_number.startswith('4'):
            return PaymentCard.CardType.VISA
        elif card_number.startswith(('51', '52', '53', '54', '55')):
            return PaymentCard.CardType.MASTERCARD
        elif card_number.startswith(('34', '37')):
            return PaymentCard.CardType.AMEX
        elif card_number.startswith(('6011', '65')):
            return PaymentCard.CardType.DISCOVER
        elif card_number.startswith(('300', '301', '302', '303', '304', '305', '36', '38')):
            return PaymentCard.CardType.DINERS
        elif card_number.startswith(('35', '2131', '1800')):
            return PaymentCard.CardType.JCB
        else:
            return PaymentCard.CardType.UNKNOWN


class PaymentTransaction(models.Model):
    """Transaction de paiement principale"""

    class Status(models.TextChoices):
        PENDING = 'PENDING', _('En attente')
        PROCESSING = 'PROCESSING', _('En traitement')
        COMPLETED = 'COMPLETED', _('Complété')
        FAILED = 'FAILED', _('Échoué')
        REFUNDED = 'REFUNDED', _('Remboursé')
        PARTIALLY_REFUNDED = 'PARTIALLY_REFUNDED', _('Partiellement remboursé')
        CANCELLED = 'CANCELLED', _('Annulé')
        EXPIRED = 'EXPIRED', _('Expiré')
        DISPUTED = 'DISPUTED', _('En litige')

    class PaymentType(models.TextChoices):
        AD_PURCHASE = 'AD_PURCHASE', _('Achat annonce')
        AD_FEATURED = 'AD_FEATURED', _('Mise en vedette')
        AD_RESERVATION = 'AD_RESERVATION', _('Réservation annonce')
        MISSION_PAYMENT = 'MISSION_PAYMENT', _('Paiement mission')
        CARRIER_PAYOUT = 'CARRIER_PAYOUT', _('Versement transporteur')
        COMMISSION = 'COMMISSION', _('Commission Ebi3')
        WALLET_TOPUP = 'WALLET_TOPUP', _('Rechargement portefeuille')
        WALLET_TRANSFER = 'WALLET_TRANSFER', _('Transfert portefeuille')
        REFUND = 'REFUND', _('Remboursement')
        SUBSCRIPTION = 'SUBSCRIPTION', _('Abonnement')
        OTHER = 'OTHER', _('Autre')

    class PaymentMethod(models.TextChoices):
        CREDIT_CARD = 'CREDIT_CARD', _('Carte de crédit')
        DEBIT_CARD = 'DEBIT_CARD', _('Carte de débit')
        PAYPAL = 'PAYPAL', _('PayPal')
        STRIPE = 'STRIPE', _('Stripe')
        BANK_TRANSFER = 'BANK_TRANSFER', _('Virement bancaire')
        CASH = 'CASH', _('Espèces')
        EBI3_WALLET = 'EBI3_WALLET', _('Portefeuille Ebi3')
        PAYSTACK = 'PAYSTACK', _('Paystack')
        CINETPAY = 'CINETPAY', _('CinetPay')
        ORANGE_MONEY = 'ORANGE_MONEY', _('Orange Money')
        MTN_MONEY = 'MTN_MONEY', _('MTN Money')

    # Identifiants uniques
    transaction_id = models.UUIDField(
        default=uuid.uuid4,
        editable=False,
        unique=True,
        verbose_name=_("ID transaction")
    )
    reference = models.CharField(
        max_length=50,
        unique=True,
        db_index=True,
        verbose_name=_("Référence transaction")
    )

    # Parties impliquées
    payer = models.ForeignKey(
        User,
        on_delete=models.PROTECT,
        related_name='payment_sent',
        verbose_name=_("Payeur"),
        null=True,
        blank=True  # Pour les paiements système
    )
    payee = models.ForeignKey(
        User,
        on_delete=models.PROTECT,
        related_name='payment_received',
        verbose_name=_("Bénéficiaire"),
        null=True,
        blank=True  # Pour les paiements système
    )

    # Montants
    amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        validators=[MinValueValidator(Decimal('0.01'))],
        verbose_name=_("Montant")
    )
    # MODIFICATION ICI : Utiliser la liste commune
    currency = models.CharField(
        max_length=3,
        default='EUR',
        choices=CURRENCY_CHOICES,  # ← Utilisation de la liste commune
        verbose_name=_("Devise")
    )
    exchange_rate = models.DecimalField(
        max_digits=10,
        decimal_places=6,
        default=1.0,
        verbose_name=_("Taux de change")
    )
    amount_converted = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        editable=False,
        verbose_name=_("Montant converti")
    )

    # Frais et taxes
    fee_amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        default=0,
        verbose_name=_("Frais de transaction")
    )
    tax_amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        default=0,
        verbose_name=_("Montant taxes")
    )
    net_amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        editable=False,
        verbose_name=_("Montant net")
    )

    # Métadonnées
    payment_type = models.CharField(
        max_length=20,
        choices=PaymentType.choices,
        verbose_name=_("Type de paiement")
    )
    payment_method = models.CharField(
        max_length=20,
        choices=PaymentMethod.choices,
        verbose_name=_("Méthode de paiement")
    )
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.PENDING,
        db_index=True,
        verbose_name=_("Statut")
    )

    # Intégration avec autres apps
    ad = models.ForeignKey(
        Ad,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='payments',
        verbose_name=_("Annonce liée")
    )
    mission = models.ForeignKey(
        Mission,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='payments',
        verbose_name=_("Mission liée")
    )
    carrier = models.ForeignKey(
        Carrier,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='payments',
        verbose_name=_("Transporteur lié")
    )
    transport_proposal = models.ForeignKey(
        TransportProposal,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='payments',
        verbose_name=_("Proposition transport liée")
    )

    # Données de paiement sécurisées
    payment_token = models.CharField(
        max_length=255,
        blank=True,
        editable=False,
        verbose_name=_("Token de paiement")
    )
    payment_gateway_id = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("ID passerelle")
    )
    payment_gateway_data = models.JSONField(
        blank=True,
        null=True,
        verbose_name=_("Données passerelle")
    )

    # 3D Secure
    three_d_secure = models.BooleanField(
        default=False,
        verbose_name=_("3D Secure activé")
    )
    three_d_secure_status = models.CharField(
        max_length=20,
        blank=True,
        choices=[
            ('NOT_SUPPORTED', _('Non supporté')),
            ('SUCCESS', _('Succès')),
            ('FAILED', _('Échoué')),
            ('SKIPPED', _('Ignoré')),
        ],
        verbose_name=_("Statut 3D Secure")
    )

    # Fraude et sécurité
    fraud_score = models.DecimalField(
        max_digits=5,
        decimal_places=2,
        default=0,
        verbose_name=_("Score fraude")
    )
    ip_address = models.GenericIPAddressField(
        blank=True,
        null=True,
        verbose_name=_("Adresse IP")
    )
    user_agent = models.TextField(
        blank=True,
        verbose_name=_("User Agent")
    )
    risk_checked = models.BooleanField(
        default=False,
        verbose_name=_("Contrôle risque effectué")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)
    completed_at = models.DateTimeField(null=True, blank=True)
    expires_at = models.DateTimeField(null=True, blank=True)

    # Métadonnées supplémentaires
    metadata = models.JSONField(
        blank=True,
        null=True,
        verbose_name=_("Métadonnées")
    )
    notes = models.TextField(
        blank=True,
        verbose_name=_("Notes internes")
    )

    class Meta:
        verbose_name = _("Transaction de paiement")
        verbose_name_plural = _("Transactions de paiement")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status', 'created_at']),
            models.Index(fields=['payer', 'status']),
            models.Index(fields=['payee', 'status']),
            models.Index(fields=['payment_type', 'status']),
            models.Index(fields=['reference']),
            models.Index(fields=['payment_gateway_id']),
        ]
        permissions = [
            ('can_view_all_transactions', _('Peut voir toutes les transactions')),
            ('can_refund_transactions', _('Peut effectuer des remboursements')),
            ('can_export_financial_data', _('Peut exporter les données financières')),
            ('can_manage_fraud_detection', _('Peut gérer la détection de fraude')),
        ]

    def __str__(self):
        return f"{self.reference} - {self.get_payment_type_display()} - {self.amount} {self.currency}"

    def save(self, *args, **kwargs):
        # Génération automatique de la référence
        if not self.reference:
            prefix = "PAY"
            date_str = timezone.now().strftime("%Y%m%d")
            random_str = uuid.uuid4().hex[:6].upper()
            self.reference = f"{prefix}{date_str}{random_str}"

        # Calcul des montants
        if self.amount and self.exchange_rate:
            self.amount_converted = self.amount * self.exchange_rate

        if self.amount and self.fee_amount and self.tax_amount:
            self.net_amount = self.amount - self.fee_amount - self.tax_amount

        super().save(*args, **kwargs)

    def get_absolute_url(self):
        return reverse('payments:transaction_detail', kwargs={'transaction_id': str(self.transaction_id)})

    def is_refundable(self):
        """Vérifie si la transaction est remboursable"""
        if self.status not in [self.Status.COMPLETED, self.Status.PARTIALLY_REFUNDED]:
            return False
        if self.completed_at and timezone.now() - self.completed_at > timezone.timedelta(days=180):
            return False
        return True

    def calculate_refund_amount(self):
        """Calcule le montant maximum remboursable"""
        if not self.is_refundable():
            return Decimal('0')

        # Calculer le montant déjà remboursé
        from .models import Refund
        total_refunded = self.refunds.filter(
            status__in=[Refund.Status.APPROVED, Refund.Status.COMPLETED]
        ).aggregate(total=models.Sum('amount'))['total'] or Decimal('0')

        return self.amount - total_refunded

    def get_related_object(self):
        """Retourne l'objet lié à la transaction"""
        if self.ad:
            return self.ad
        elif self.mission:
            return self.mission
        elif self.carrier:
            return self.carrier
        elif self.transport_proposal:
            return self.transport_proposal
        return None

    def generate_receipt(self):
        """Génère un reçu numérique signé"""
        # Implémentation sécurisée dans utils.py
        pass


class PaymentMethod(models.Model):
    """Méthode de paiement enregistrée par l'utilisateur"""

    class MethodType(models.TextChoices):
        CARD = 'CARD', _('Carte bancaire')
        BANK_ACCOUNT = 'BANK_ACCOUNT', _('Compte bancaire')
        DIGITAL_WALLET = 'DIGITAL_WALLET', _('Portefeuille numérique')
        MOBILE_MONEY = 'MOBILE_MONEY', _('Mobile Money')

    user = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='payment_methods',
        verbose_name=_("Utilisateur")
    )
    method_type = models.CharField(
        max_length=20,
        choices=MethodType.choices,
        verbose_name=_("Type de méthode")
    )
    is_default = models.BooleanField(
        default=False,
        verbose_name=_("Méthode par défaut")
    )
    is_verified = models.BooleanField(
        default=False,
        verbose_name=_("Vérifiée")
    )

    # Données chiffrées
    encrypted_data = models.TextField(
        verbose_name=_("Données chiffrées"),
        editable=False
    )
    encryption_key_id = models.CharField(
        max_length=100,
        editable=False,
        verbose_name=_("ID clé de chiffrement")
    )

    # Métadonnées
    last_used = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Dernière utilisation")
    )
    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Active")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Méthode de paiement")
        verbose_name_plural = _("Méthodes de paiement")
        ordering = ['-is_default', '-last_used']
        unique_together = ['user', 'encryption_key_id']

    def __str__(self):
        return f"{self.user.username} - {self.get_method_type_display()}"

    def decrypt_data(self):
        """Déchiffre les données sensibles"""
        # Implémentation sécurisée dans utils.py
        pass

    def mask_display(self):
        """Retourne une version masquée pour l'affichage"""
        if self.method_type == self.MethodType.CARD:
            return "**** **** **** XXXX"
        elif self.method_type == self.MethodType.BANK_ACCOUNT:
            return "IBAN **** XXXX"
        return self.get_method_type_display()


class InvoiceItem(models.Model):
    """Élément d'une facture"""

    invoice = models.ForeignKey(
        'Invoice',
        on_delete=models.CASCADE,
        related_name='items',
        verbose_name=_("Facture")
    )

    description = models.CharField(
        max_length=255,
        verbose_name=_("Description")
    )

    quantity = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        default=1,
        verbose_name=_("Quantité")
    )

    unit_price = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Prix unitaire")
    )

    tax_rate = models.DecimalField(
        max_digits=5,
        decimal_places=2,
        default=0,
        verbose_name=_("Taux de taxe (%)")
    )

    created_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name=_("Date de création")
    )

    updated_at = models.DateTimeField(
        auto_now=True,
        verbose_name=_("Date de modification")
    )

    class Meta:
        verbose_name = _("Élément de facture")
        verbose_name_plural = _("Éléments de facture")
        ordering = ['created_at']

    def __str__(self):
        return f"{self.description} - {self.quantity} × {self.unit_price}"

    def subtotal(self):
        """Calcule le sous-total (quantité × prix unitaire)"""
        return self.quantity * self.unit_price

    def tax_amount(self):
        """Calcule le montant de la taxe"""
        return self.subtotal() * (self.tax_rate / 100)

    def total(self):
        """Calcule le total (sous-total + taxe)"""
        return self.subtotal() + self.tax_amount()


class Invoice(models.Model):
    """Facture générée pour chaque transaction"""

    class Status(models.TextChoices):
        DRAFT = 'DRAFT', _('Brouillon')
        SENT = 'SENT', _('Envoyée')
        PAID = 'PAID', _('Payée')
        OVERDUE = 'OVERDUE', _('En retard')
        CANCELLED = 'CANCELLED', _('Annulée')

    invoice_number = models.CharField(
        max_length=50,
        unique=True,
        db_index=True,
        verbose_name=_("Numéro de facture")
    )
    transaction = models.OneToOneField(
        PaymentTransaction,
        on_delete=models.CASCADE,
        related_name='invoice',
        verbose_name=_("Transaction")
    )

    # Détails de facturation
    billing_name = models.CharField(
        max_length=200,
        verbose_name=_("Nom de facturation")
    )
    billing_address = models.TextField(
        verbose_name=_("Adresse de facturation")
    )
    billing_country = CountryField(
        verbose_name=_("Pays de facturation")
    )
    billing_vat = models.CharField(
        max_length=50,
        blank=True,
        verbose_name=_("Numéro TVA")
    )

    # Montants détaillés
    subtotal = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Sous-total")
    )
    tax_rate = models.DecimalField(
        max_digits=5,
        decimal_places=2,
        default=0,
        verbose_name=_("Taux TVA (%)")
    )
    tax_amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Montant TVA")
    )
    total_amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Montant total")
    )

    # Dates
    invoice_date = models.DateField(
        default=timezone.now,
        verbose_name=_("Date de facture")
    )
    due_date = models.DateField(
        verbose_name=_("Date d'échéance")
    )
    paid_date = models.DateField(
        null=True,
        blank=True,
        verbose_name=_("Date de paiement")
    )

    # Statut
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.DRAFT,
        verbose_name=_("Statut")
    )

    # Notes additionnelles
    notes = models.TextField(
        blank=True,
        verbose_name=_("Notes additionnelles")
    )

    # PDF généré
    pdf_file = models.FileField(
        upload_to='invoices/%Y/%m/',
        null=True,
        blank=True,
        verbose_name=_("Fichier PDF")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Facture")
        verbose_name_plural = _("Factures")
        ordering = ['-invoice_date']
        indexes = [
            models.Index(fields=['invoice_number']),
            models.Index(fields=['status', 'due_date']),
        ]

    def __str__(self):
        return f"Facture {self.invoice_number} - {self.total_amount} {self.transaction.currency}"

    def save(self, *args, **kwargs):
        if not self.invoice_number:
            prefix = "INV"
            year = timezone.now().strftime("%Y")
            month = timezone.now().strftime("%m")
            count = Invoice.objects.filter(
                invoice_date__year=year,
                invoice_date__month=month
            ).count() + 1
            self.invoice_number = f"{prefix}{year}{month}{count:04d}"

        super().save(*args, **kwargs)

    def is_overdue(self):
        """Vérifie si la facture est en retard"""
        if self.status == self.Status.PAID:
            return False
        return timezone.now().date() > self.due_date

    def generate_pdf(self):
        """Génère le PDF de la facture"""
        # Implémentation dans utils.py
        pass


class Refund(models.Model):
    """Demande et traitement de remboursement"""

    class Status(models.TextChoices):
        REQUESTED = 'REQUESTED', _('Demandé')
        UNDER_REVIEW = 'UNDER_REVIEW', _('En revue')
        APPROVED = 'APPROVED', _('Approuvé')
        REJECTED = 'REJECTED', _('Rejeté')
        PROCESSING = 'PROCESSING', _('En traitement')
        COMPLETED = 'COMPLETED', _('Complété')
        FAILED = 'FAILED', _('Échoué')

    class Reason(models.TextChoices):
        DUPLICATE_CHARGE = 'DUPLICATE_CHARGE', _('Double facturation')
        UNAUTHORIZED = 'UNAUTHORIZED', _('Non autorisé')
        PRODUCT_DEFECT = 'PRODUCT_DEFECT', _('Défaut produit')
        NOT_RECEIVED = 'NOT_RECEIVED', _('Non reçu')
        WRONG_AMOUNT = 'WRONG_AMOUNT', _('Mauvais montant')
        CANCELLED = 'CANCELLED', _('Annulé par client')
        OTHER = 'OTHER', _('Autre')

    refund_id = models.UUIDField(
        default=uuid.uuid4,
        editable=False,
        unique=True,
        verbose_name=_("ID remboursement")
    )
    transaction = models.ForeignKey(
        PaymentTransaction,
        on_delete=models.PROTECT,
        related_name='refunds',
        verbose_name=_("Transaction originale")
    )

    # Demandeur
    requested_by = models.ForeignKey(
        User,
        on_delete=models.PROTECT,
        related_name='refunds_requested',
        verbose_name=_("Demandé par")
    )

    # Détails du remboursement
    amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        validators=[MinValueValidator(Decimal('0.01'))],
        verbose_name=_("Montant remboursé")
    )
    # MODIFICATION ICI : Utiliser la liste commune
    currency = models.CharField(
        max_length=3,
        choices=CURRENCY_CHOICES,  # ← Utilisation de la liste commune
        verbose_name=_("Devise")
    )
    reason = models.CharField(
        max_length=20,
        choices=Reason.choices,
        verbose_name=_("Raison")
    )
    description = models.TextField(
        verbose_name=_("Description détaillée")
    )
    evidence = models.FileField(
        upload_to='refunds/evidence/',
        null=True,
        blank=True,
        verbose_name=_("Preuve")
    )

    # Traitement
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.REQUESTED,
        verbose_name=_("Statut")
    )
    reviewed_by = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='refunds_reviewed',
        verbose_name=_("Revu par")
    )
    review_notes = models.TextField(
        blank=True,
        verbose_name=_("Notes de revue")
    )
    rejection_reason = models.TextField(
        blank=True,
        verbose_name=_("Raison du rejet")
    )

    # Référence externe
    refund_gateway_id = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("ID remboursement passerelle")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    processed_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        verbose_name = _("Remboursement")
        verbose_name_plural = _("Remboursements")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status', 'created_at']),
            models.Index(fields=['transaction', 'status']),
        ]

    def __str__(self):
        return f"Remboursement {self.refund_id} - {self.amount} {self.currency}"

    def can_be_processed(self):
        """Vérifie si le remboursement peut être traité"""
        return self.status == self.Status.APPROVED

    def process_refund(self):
        """Traite le remboursement"""
        # Implémentation dans views.py
        pass


class Commission(models.Model):
    """Commission perçue par Ebi3 sur chaque transaction"""

    transaction = models.OneToOneField(
        PaymentTransaction,
        on_delete=models.CASCADE,
        related_name='commission',
        verbose_name=_("Transaction")
    )

    # Calcul de commission
    commission_rate = models.DecimalField(
        max_digits=5,
        decimal_places=4,  # 0.1000 pour 10%
        verbose_name=_("Taux de commission")
    )
    commission_amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Montant commission")
    )
    vat_on_commission = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        default=0,
        verbose_name=_("TVA sur commission")
    )
    net_commission = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Commission nette")
    )

    # Paiement de la commission
    is_paid = models.BooleanField(
        default=False,
        verbose_name=_("Commission payée")
    )
    paid_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Payé le")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Commission")
        verbose_name_plural = _("Commissions")
        ordering = ['-created_at']

    def __str__(self):
        return f"Commission {self.net_commission} {self.transaction.currency}"

    def save(self, *args, **kwargs):
        if not self.commission_amount and self.transaction.amount:
            self.commission_amount = self.transaction.amount * self.commission_rate
            self.net_commission = self.commission_amount - self.vat_on_commission
        super().save(*args, **kwargs)


class Payout(models.Model):
    """Versement aux vendeurs/transporteurs"""

    class Status(models.TextChoices):
        PENDING = 'PENDING', _('En attente')
        PROCESSING = 'PROCESSING', _('En traitement')
        COMPLETED = 'COMPLETED', _('Complété')
        FAILED = 'FAILED', _('Échoué')
        CANCELLED = 'CANCELLED', _('Annulé')

    class PayoutMethod(models.TextChoices):
        BANK_TRANSFER = 'BANK_TRANSFER', _('Virement bancaire')
        PAYPAL = 'PAYPAL', _('PayPal')
        STRIPE_CONNECT = 'STRIPE_CONNECT', _('Stripe Connect')
        EBI3_WALLET = 'EBI3_WALLET', _('Portefeuille Ebi3')
        WESTERN_UNION = 'WESTERN_UNION', _('Western Union')
        MONEYGRAM = 'MONEYGRAM', _('MoneyGram')

    payout_id = models.UUIDField(
        default=uuid.uuid4,
        editable=False,
        unique=True,
        verbose_name=_("ID versement")
    )
    user = models.ForeignKey(
        User,
        on_delete=models.PROTECT,
        related_name='payouts',
        verbose_name=_("Bénéficiaire")
    )

    # Montants
    amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        validators=[MinValueValidator(Decimal('0.01'))],
        verbose_name=_("Montant")
    )
    # MODIFICATION ICI : Utiliser la liste commune
    currency = models.CharField(
        max_length=3,
        choices=CURRENCY_CHOICES,  # ← Utilisation de la liste commune
        verbose_name=_("Devise")
    )
    fee_amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        default=0,
        verbose_name=_("Frais de versement")
    )
    net_amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Montant net")
    )

    # Méthode
    payout_method = models.CharField(
        max_length=20,
        choices=PayoutMethod.choices,
        verbose_name=_("Méthode de versement")
    )

    # Détails du bénéficiaire (chiffrés)
    beneficiary_data = models.TextField(
        verbose_name=_("Données bénéficiaire"),
        editable=False
    )

    # Statut
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.PENDING,
        verbose_name=_("Statut")
    )

    # Transactions incluses
    transactions = models.ManyToManyField(
        PaymentTransaction,
        related_name='payouts',
        verbose_name=_("Transactions incluses")
    )

    # Référence externe
    payout_gateway_id = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("ID versement passerelle")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    processed_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        verbose_name = _("Versement")
        verbose_name_plural = _("Versements")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status', 'created_at']),
            models.Index(fields=['user', 'status']),
        ]

    def __str__(self):
        return f"Versement {self.payout_id} - {self.net_amount} {self.currency}"

    def save(self, *args, **kwargs):
        if not self.net_amount and self.amount and self.fee_amount:
            self.net_amount = self.amount - self.fee_amount
        super().save(*args, **kwargs)


class Wallet(models.Model):
    """Portefeuille Ebi3 d'un utilisateur"""

    class WalletStatus(models.TextChoices):
        ACTIVE = 'ACTIVE', _('Actif')
        SUSPENDED = 'SUSPENDED', _('Suspendu')
        LOCKED = 'LOCKED', _('Verrouillé')
        CLOSED = 'CLOSED', _('Fermé')

    user = models.OneToOneField(
        User,
        on_delete=models.CASCADE,
        related_name='wallet',
        verbose_name=_("Utilisateur")
    )

    # Soldes
    balance = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        default=0,
        validators=[MinValueValidator(Decimal('0'))],
        verbose_name=_("Solde")
    )
    # MODIFICATION ICI : Utiliser la liste commune
    currency = models.CharField(
        max_length=3,
        default='EUR',
        choices=CURRENCY_CHOICES,  # ← Utilisation de la liste commune
        verbose_name=_("Devise")
    )
    reserved_balance = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        default=0,
        verbose_name=_("Solde réservé")
    )
    available_balance = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        editable=False,
        verbose_name=_("Solde disponible")
    )

    # Statut
    status = models.CharField(
        max_length=20,
        choices=WalletStatus.choices,
        default=WalletStatus.ACTIVE,
        verbose_name=_("Statut")
    )

    # Limites
    daily_limit = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        default=Decimal('1000'),
        verbose_name=_("Limite quotidienne")
    )
    monthly_limit = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        default=Decimal('5000'),
        verbose_name=_("Limite mensuelle")
    )

    # Sécurité
    pin_hash = models.CharField(
        max_length=255,
        blank=True,
        editable=False,
        verbose_name=_("Hash du PIN")
    )
    is_locked = models.BooleanField(
        default=False,
        verbose_name=_("Verrouillé")
    )
    locked_until = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Verrouillé jusqu'à")
    )

    # Métadonnées
    is_verified = models.BooleanField(
        default=False,
        verbose_name=_("Vérifié")
    )

    # Détection de fraude
    risk_score = models.DecimalField(
        max_digits=5,
        decimal_places=2,
        default=0,
        verbose_name=_("Score de risque")
    )
    blocked_balance = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        default=0,
        verbose_name=_("Solde bloqué")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Portefeuille")
        verbose_name_plural = _("Portefeuilles")

    def __str__(self):
        return f"Portefeuille {self.user.username} - {self.balance} {self.currency}"

    def save(self, *args, **kwargs):
        self.available_balance = self.balance - self.reserved_balance - self.blocked_balance
        super().save(*args, **kwargs)

    def can_withdraw(self, amount):
        """Vérifie si le retrait est possible"""
        if self.is_locked or self.status != self.WalletStatus.ACTIVE:
            return False, _("Portefeuille verrouillé ou inactif")
        if amount > self.available_balance:
            return False, _("Solde insuffisant")
        if amount > self.daily_limit:
            return False, _("Limite quotidienne dépassée")
        return True, ""

    def get_monthly_stats(self):
        """Récupère les statistiques mensuelles"""
        # Implémentation dans utils.py
        pass

    def set_pin(self, pin):
        """Définit le code PIN du portefeuille"""
        from django.contrib.auth.hashers import make_password
        self.pin_hash = make_password(pin)

    def verify_pin(self, pin):
        """Vérifie le code PIN"""
        from django.contrib.auth.hashers import check_password
        return check_password(pin, self.pin_hash)

    def get_current_limits(self):
        """Retourne les limites actuelles"""
        return {
            'daily_limit': self.daily_limit,
            'monthly_limit': self.monthly_limit,
            'available_balance': self.available_balance
        }


class WalletTransaction(models.Model):
    """Transaction dans un portefeuille"""

    class TransactionType(models.TextChoices):
        DEPOSIT = 'DEPOSIT', _('Dépôt')
        WITHDRAWAL = 'WITHDRAWAL', _('Retrait')
        TRANSFER = 'TRANSFER', _('Transfert')
        PAYMENT = 'PAYMENT', _('Paiement')
        REFUND = 'REFUND', _('Remboursement')
        COMMISSION = 'COMMISSION', _('Commission')
        BLOCK = 'BLOCK', _('Blocage')
        CREDIT = 'CREDIT', _('Crédit')
        DEBIT = 'DEBIT', _('Débit')

    class Status(models.TextChoices):
        PENDING = 'PENDING', _('En attente')
        PROCESSING = 'PROCESSING', _('En traitement')
        COMPLETED = 'COMPLETED', _('Complété')
        FAILED = 'FAILED', _('Échoué')
        CANCELLED = 'CANCELLED', _('Annulé')

    wallet = models.ForeignKey(
        Wallet,
        on_delete=models.CASCADE,
        related_name='transactions',
        verbose_name=_("Portefeuille")
    )

    # Montant et type
    amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Montant")
    )
    transaction_type = models.CharField(
        max_length=20,
        choices=TransactionType.choices,
        verbose_name=_("Type de transaction")
    )
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.PENDING,
        verbose_name=_("Statut")
    )

    # Références
    payment_transaction = models.ForeignKey(
        PaymentTransaction,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='wallet_transactions',
        verbose_name=_("Transaction de paiement liée")
    )

    # Métadonnées
    description = models.CharField(
        max_length=255,
        verbose_name=_("Description")
    )
    reference = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Référence")
    )
    metadata = models.JSONField(
        blank=True,
        null=True,
        verbose_name=_("Métadonnées")
    )

    # Soldes avant/après
    balance_before = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Solde avant")
    )
    balance_after = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Solde après")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Transaction portefeuille")
        verbose_name_plural = _("Transactions portefeuille")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['wallet', 'created_at']),
            models.Index(fields=['transaction_type', 'created_at']),
            models.Index(fields=['status', 'created_at']),
        ]

    def __str__(self):
        return f"{self.get_transaction_type_display()} - {self.amount} {self.wallet.currency}"


class Tax(models.Model):
    """Configuration des taxes par pays"""

    country = CountryField(
        unique=True,
        verbose_name=_("Pays")
    )
    tax_rate = models.DecimalField(
        max_digits=5,
        decimal_places=2,
        verbose_name=_("Taux TVA (%)")
    )
    tax_name = models.CharField(
        max_length=100,
        verbose_name=_("Nom de la taxe")
    )
    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Active")
    )

    # Exemptions
    exempt_categories = models.JSONField(
        blank=True,
        null=True,
        verbose_name=_("Catégories exemptées")
    )
    minimum_amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        null=True,
        blank=True,
        verbose_name=_("Montant minimum")
    )

    class Meta:
        verbose_name = _("Taxe")
        verbose_name_plural = _("Taxes")

    def __str__(self):
        return f"{self.country.name} - {self.tax_rate}%"


class ExchangeRate(models.Model):
    """Taux de change pour les devises"""

    # MODIFICATION ICI : Utiliser la liste commune pour base_currency
    base_currency = models.CharField(
        max_length=3,
        choices=CURRENCY_CHOICES,  # ← Utilisation de la liste commune
        verbose_name=_("Devise de base")
    )
    # MODIFICATION ICI : Utiliser la liste commune pour target_currency
    target_currency = models.CharField(
        max_length=3,
        choices=CURRENCY_CHOICES,  # ← Utilisation de la liste commune
        verbose_name=_("Devise cible")
    )
    rate = models.DecimalField(
        max_digits=10,
        decimal_places=6,
        verbose_name=_("Taux")
    )
    last_updated = models.DateTimeField(
        auto_now=True,
        verbose_name=_("Dernière mise à jour")
    )
    source = models.CharField(
        max_length=50,
        verbose_name=_("Source")
    )
    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Actif")
    )

    class Meta:
        verbose_name = _("Taux de change")
        verbose_name_plural = _("Taux de change")
        unique_together = ['base_currency', 'target_currency']

    def __str__(self):
        return f"{self.base_currency}/{self.target_currency}: {self.rate}"


class FraudAlert(models.Model):
    """Alerte de fraude détectée"""

    class Severity(models.TextChoices):
        LOW = 'LOW', _('Faible')
        MEDIUM = 'MEDIUM', _('Moyen')
        HIGH = 'HIGH', _('Élevé')
        CRITICAL = 'CRITICAL', _('Critique')

    transaction = models.ForeignKey(
        PaymentTransaction,
        on_delete=models.CASCADE,
        related_name='fraud_alerts',
        verbose_name=_("Transaction")
    )

    # Détection
    detected_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name=_("Détecté le")
    )
    severity = models.CharField(
        max_length=20,
        choices=Severity.choices,
        verbose_name=_("Sévérité")
    )
    fraud_score = models.DecimalField(
        max_digits=5,
        decimal_places=2,
        verbose_name=_("Score de fraude")
    )

    # Raisons
    reasons = models.JSONField(
        verbose_name=_("Raisons de l'alerte")
    )

    # Actions
    action_taken = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Action prise")
    )
    reviewed_by = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        verbose_name=_("Revu par")
    )
    reviewed_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Revu le")
    )
    review_notes = models.TextField(
        blank=True,
        verbose_name=_("Notes de revue")
    )

    # Résolution
    is_resolved = models.BooleanField(
        default=False,
        verbose_name=_("Résolu")
    )
    resolved_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Résolu le")
    )
    resolution_notes = models.TextField(
        blank=True,
        verbose_name=_("Notes de résolution")
    )

    class Meta:
        verbose_name = _("Alerte de fraude")
        verbose_name_plural = _("Alertes de fraude")
        ordering = ['-detected_at']

    def __str__(self):
        return f"Alerte {self.severity} - Transaction {self.transaction.reference}"


class AuditLog(models.Model):
    """Journal d'audit pour toutes les actions sensibles"""

    class ActionType(models.TextChoices):
        CREATE = 'CREATE', _('Création')
        UPDATE = 'UPDATE', _('Mise à jour')
        DELETE = 'DELETE', _('Suppression')
        APPROVE = 'APPROVE', _('Approbation')
        REJECT = 'REJECT', _('Rejet')
        REFUND = 'REFUND', _('Remboursement')
        PAYOUT = 'PAYOUT', _('Versement')
        LOGIN = 'LOGIN', _('Connexion')
        LOGOUT = 'LOGOUT', _('Déconnexion')
        WALLET_LOGIN = 'WALLET_LOGIN', _('Connexion portefeuille')
        WALLET_PIN_CHANGE = 'WALLET_PIN_CHANGE', _('Changement PIN portefeuille')
        WALLET_SECURITY_CHANGE = 'WALLET_SECURITY_CHANGE', _('Changement sécurité portefeuille')
        WALLET_CREATION = 'WALLET_CREATION', _('Création portefeuille')

    user = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        verbose_name=_("Utilisateur")
    )

    # Action
    action_type = models.CharField(
        max_length=50,
        choices=ActionType.choices,
        verbose_name=_("Type d'action")
    )
    action_description = models.TextField(
        verbose_name=_("Description de l'action")
    )

    # Objet concerné
    object_type = models.CharField(
        max_length=100,
        verbose_name=_("Type d'objet")
    )
    object_id = models.CharField(
        max_length=100,
        verbose_name=_("ID de l'objet")
    )

    # Données
    old_data = models.JSONField(
        null=True,
        blank=True,
        verbose_name=_("Anciennes données")
    )
    new_data = models.JSONField(
        null=True,
        blank=True,
        verbose_name=_("Nouvelles données")
    )

    # Métadonnées
    ip_address = models.GenericIPAddressField(
        null=True,
        blank=True,
        verbose_name=_("Adresse IP")
    )
    user_agent = models.TextField(
        blank=True,
        verbose_name=_("User Agent")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True, db_index=True)

    class Meta:
        verbose_name = _("Journal d'audit")
        verbose_name_plural = _("Journaux d'audit")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['user', 'created_at']),
            models.Index(fields=['object_type', 'object_id']),
        ]

    def __str__(self):
        return f"{self.get_action_type_display()} - {self.object_type} - {self.created_at}"


# ============================================================================
# NOUVEAUX MODÈLES AJOUTÉS
# ============================================================================

class Plan(models.Model):
    """Plan d'abonnement"""

    class Interval(models.TextChoices):
        DAILY = 'DAILY', _('Quotidien')
        WEEKLY = 'WEEKLY', _('Hebdomadaire')
        MONTHLY = 'MONTHLY', _('Mensuel')
        QUARTERLY = 'QUARTERLY', _('Trimestriel')
        SEMI_ANNUAL = 'SEMI_ANNUAL', _('Semestriel')
        ANNUAL = 'ANNUAL', _('Annuel')

    name = models.CharField(max_length=100, verbose_name=_("Nom du plan"))
    description = models.TextField(verbose_name=_("Description"))
    price = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Prix")
    )
    currency = models.CharField(
        max_length=3,
        choices=CURRENCY_CHOICES,
        default='EUR',
        verbose_name=_("Devise")
    )
    interval = models.CharField(
        max_length=20,
        choices=Interval.choices,
        default='MONTHLY',
        verbose_name=_("Intervalle")
    )
    interval_count = models.PositiveIntegerField(
        default=1,
        verbose_name=_("Nombre d'intervalles")
    )
    trial_period_days = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Période d'essai (jours)")
    )
    is_active = models.BooleanField(default=True, verbose_name=_("Actif"))
    features = models.JSONField(
        default=dict,
        verbose_name=_("Fonctionnalités")
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Plan d'abonnement")
        verbose_name_plural = _("Plans d'abonnement")
        ordering = ['price']

    def __str__(self):
        return f"{self.name} - {self.price} {self.currency}/{self.get_interval_display()}"


class Subscription(models.Model):
    """Abonnement utilisateur à un plan"""

    class Status(models.TextChoices):
        PENDING = 'PENDING', _('En attente')
        ACTIVE = 'ACTIVE', _('Actif')
        PAST_DUE = 'PAST_DUE', _('En retard')
        CANCELLED = 'CANCELLED', _('Annulé')
        EXPIRED = 'EXPIRED', _('Expiré')
        SUSPENDED = 'SUSPENDED', _('Suspendu')

    user = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='subscriptions',
        verbose_name=_("Utilisateur")
    )
    plan = models.ForeignKey(
        Plan,
        on_delete=models.PROTECT,
        related_name='subscriptions',
        verbose_name=_("Plan")
    )
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default='PENDING',
        verbose_name=_("Statut")
    )
    current_period_start = models.DateTimeField(
        verbose_name=_("Début de la période actuelle")
    )
    current_period_end = models.DateTimeField(
        verbose_name=_("Fin de la période actuelle")
    )
    cancel_at_period_end = models.BooleanField(
        default=False,
        verbose_name=_("Annuler à la fin de la période")
    )
    canceled_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Annulé le")
    )
    metadata = models.JSONField(
        default=dict,
        blank=True,
        verbose_name=_("Métadonnées")
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Abonnement")
        verbose_name_plural = _("Abonnements")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['user', 'status']),
            models.Index(fields=['current_period_end']),
        ]

    def __str__(self):
        return f"{self.user.username} - {self.plan.name} ({self.get_status_display()})"

    def is_active(self):
        return self.status == self.Status.ACTIVE

    def days_until_expiration(self):
        if self.current_period_end:
            delta = self.current_period_end - timezone.now()
            return max(0, delta.days)
        return 0


class Coupon(models.Model):
    """Coupon de réduction"""

    class DiscountType(models.TextChoices):
        PERCENTAGE = 'PERCENTAGE', _('Pourcentage')
        FIXED_AMOUNT = 'FIXED_AMOUNT', _('Montant fixe')
        FREE_SHIPPING = 'FREE_SHIPPING', _('Livraison gratuite')

    code = models.CharField(
        max_length=50,
        unique=True,
        verbose_name=_("Code")
    )
    discount_type = models.CharField(
        max_length=20,
        choices=DiscountType.choices,
        verbose_name=_("Type de réduction")
    )
    discount_value = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_("Valeur de la réduction")
    )
    currency = models.CharField(
        max_length=3,
        choices=CURRENCY_CHOICES,
        blank=True,
        null=True,
        verbose_name=_("Devise (pour montant fixe)")
    )
    valid_from = models.DateTimeField(verbose_name=_("Valide à partir de"))
    valid_until = models.DateTimeField(verbose_name=_("Valide jusqu'à"))
    max_uses = models.PositiveIntegerField(
        default=1,
        verbose_name=_("Utilisations maximum")
    )
    used_count = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Utilisations")
    )
    is_active = models.BooleanField(default=True, verbose_name=_("Actif"))
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Coupon")
        verbose_name_plural = _("Coupons")
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.code} - {self.get_discount_type_display()}"

    def is_valid(self):
        now = timezone.now()
        return (
            self.is_active and
            self.used_count < self.max_uses and
            self.valid_from <= now <= self.valid_until
        )

    def calculate_discount(self, amount, currency='EUR'):
        if not self.is_valid():
            return Decimal('0')

        if self.discount_type == 'PERCENTAGE':
            return amount * (self.discount_value / 100)
        elif self.discount_type == 'FIXED_AMOUNT':
            if self.currency == currency:
                return min(amount, self.discount_value)
            else:
                # Conversion de devise nécessaire
                return Decimal('0')
        return Decimal('0')


class PaymentSession(models.Model):
    """Session de paiement temporaire"""

    session_id = models.UUIDField(
        default=uuid.uuid4,
        editable=False,
        unique=True,
        verbose_name=_("ID de session")
    )
    user = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='payment_sessions',
        null=True,
        blank=True,
        verbose_name=_("Utilisateur")
    )
    amount = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        verbose_name=_("Montant")
    )
    currency = models.CharField(
        max_length=3,
        choices=CURRENCY_CHOICES,
        default='EUR',
        verbose_name=_("Devise")
    )
    payment_method = models.CharField(
        max_length=20,
        choices=PaymentTransaction.PaymentMethod.choices,
        verbose_name=_("Méthode de paiement")
    )
    status = models.CharField(
        max_length=20,
        choices=PaymentTransaction.Status.choices,
        default='PENDING',
        verbose_name=_("Statut")
    )
    metadata = models.JSONField(
        default=dict,
        blank=True,
        verbose_name=_("Métadonnées")
    )
    expires_at = models.DateTimeField(verbose_name=_("Expire à"))
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Session de paiement")
        verbose_name_plural = _("Sessions de paiement")
        ordering = ['-created_at']

    def __str__(self):
        return f"Session {self.session_id} - {self.amount} {self.currency}"

    def is_expired(self):
        return timezone.now() > self.expires_at

    def extend(self, minutes=30):
        self.expires_at = timezone.now() + timezone.timedelta(minutes=minutes)
        self.save()


# ============================================================================
# NOUVEAU MODÈLE : Currency (pour views.py)
# ============================================================================

class Currency(models.Model):
    """Modèle pour les devises (pour compatibilité avec views.py)"""

    code = models.CharField(
        max_length=3,
        unique=True,
        verbose_name=_("Code devise")
    )
    name = models.CharField(
        max_length=50,
        verbose_name=_("Nom de la devise")
    )
    symbol = models.CharField(
        max_length=5,
        verbose_name=_("Symbole")
    )
    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Active")
    )
    exchange_rate = models.DecimalField(
        max_digits=10,
        decimal_places=6,
        default=1.0,
        verbose_name=_("Taux de change")
    )
    display_order = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Ordre d'affichage")
    )

    class Meta:
        verbose_name = _("Devise")
        verbose_name_plural = _("Devises")
        ordering = ['display_order', 'code']

    def __str__(self):
        return f"{self.code} - {self.name}"


========== payments/views.py ==========
# ~/ebi3/payments/views.py
from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.views.generic import (
    ListView, DetailView, CreateView, UpdateView,
    DeleteView, TemplateView, FormView, View
)
from django.urls import reverse_lazy, reverse
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from django.contrib import messages
from django.db.models import Sum, Count, Avg, Q, F
from django.db import transaction, models
from django.http import JsonResponse, HttpResponse, HttpResponseForbidden, HttpResponseBadRequest
from django.views.decorators.http import require_POST, require_GET, require_http_methods
from django.views.decorators.csrf import csrf_exempt
from django.core.exceptions import PermissionDenied, ValidationError
from django.conf import settings
from django.core.paginator import Paginator
import json
import logging
from datetime import datetime, timedelta
from decimal import Decimal

from .models import (
    PaymentTransaction, PaymentMethod, Invoice, Refund,
    Commission, Payout, Wallet, WalletTransaction, Tax, ExchangeRate,
    FraudAlert, Subscription, Plan, Coupon, PaymentSession, PaymentCard, Currency
)
from .forms import (
    PaymentForm, WalletRechargeForm, WalletWithdrawalForm,
    CreditCardPaymentForm, PayPalPaymentForm, BankTransferForm,
    MobileMoneyForm, InvoiceForm, RefundRequestForm,
    PaymentMethodForm, PayoutRequestForm, TaxConfigurationForm,
    CommissionConfigurationForm, ExchangeRateForm,
    PaymentReportForm, TransactionSearchForm, RefundReviewForm,
    PayoutProcessForm, AdPaymentForm, MissionPaymentForm,
    PaymentCheckoutForm, FinancialReportForm, PaymentNotificationForm,
    WalletTransferForm, CardPaymentForm, MobileMoneyPaymentForm,
    TaxForm, CommissionForm, PlanForm, SubscriptionForm,
    CouponForm, PaymentSessionForm, CurrencyForm, PaymentCardForm
)

logger = logging.getLogger(__name__)

# ============================================================================
# VUES PUBLIQUES
# ============================================================================

class PaymentHomeView(TemplateView):
    """Page d'accueil des paiements"""
    template_name = 'payments/home.html'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Récupérer les méthodes de paiement
        try:
            context['payment_methods'] = PaymentMethod.objects.filter(is_active=True)
        except:
            context['payment_methods'] = []

        # Récupérer les devises
        try:
            context['currencies'] = Currency.objects.filter(is_active=True)
        except Exception:
            context['currencies'] = []

        # Statistiques
        try:
            context['total_transactions'] = PaymentTransaction.objects.filter(status='COMPLETED').count()
            context['total_volume'] = PaymentTransaction.objects.filter(
                status='COMPLETED'
            ).aggregate(total=Sum('amount'))['total'] or 0
        except:
            context['total_transactions'] = 0
            context['total_volume'] = 0

        return context


class PaymentMethodsView(TemplateView):
    """Liste des méthodes de paiement disponibles"""
    template_name = 'payments/payment_methods.html'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Méthodes actives
        try:
            active_methods = PaymentMethod.objects.filter(is_active=True).order_by('created_at')

            # Grouper par type
            context['card_methods'] = active_methods.filter(method_type='CARD')
            context['bank_transfers'] = active_methods.filter(method_type='BANK_ACCOUNT')
            context['digital_wallets'] = active_methods.filter(method_type='DIGITAL_WALLET')
            context['mobile_money'] = active_methods.filter(method_type='MOBILE_MONEY')
        except:
            context['card_methods'] = []
            context['bank_transfers'] = []
            context['digital_wallets'] = []
            context['mobile_money'] = []

        return context


# ============================================================================
# CHECKOUT & PROCESSUS DE PAIEMENT
# ============================================================================

class CheckoutView(LoginRequiredMixin, FormView):
    """Vue de checkout pour un paiement"""
    template_name = 'payments/checkout/checkout.html'
    form_class = PaymentCheckoutForm

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['user'] = self.request.user

        # Récupérer le type d'objet (ad, mission, etc.)
        object_type = self.request.GET.get('object_type')
        object_id = self.request.GET.get('object_id')

        if object_type and object_id:
            if object_type == 'ad':
                from ads.models import Ad
                try:
                    obj = Ad.objects.get(id=object_id)
                    kwargs['object'] = obj
                except Ad.DoesNotExist:
                    pass
            elif object_type == 'mission':
                from logistics.models import Mission
                try:
                    obj = Mission.objects.get(id=object_id)
                    kwargs['object'] = obj
                except Mission.DoesNotExist:
                    pass

        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        user = self.request.user

        # Portefeuille de l'utilisateur
        try:
            context['wallet'] = Wallet.objects.get(user=user)
        except Wallet.DoesNotExist:
            context['wallet'] = None

        # Cartes enregistrées
        try:
            context['saved_cards'] = PaymentCard.objects.filter(user=user, is_active=True)
        except Exception:
            context['saved_cards'] = []

        # Méthodes de paiement disponibles
        try:
            context['payment_methods'] = PaymentMethod.objects.filter(is_active=True)
        except:
            context['payment_methods'] = []

        # Taxes applicables
        try:
            context['taxes'] = Tax.objects.filter(is_active=True)
        except:
            context['taxes'] = []

        return context

    def form_valid(self, form):
        try:
            # Créer la session de paiement
            payment_session = PaymentSession.objects.create(
                user=self.request.user,
                amount=form.cleaned_data['amount'],
                currency=form.cleaned_data['currency'],
                payment_method=form.cleaned_data['payment_method'],
                metadata={
                    'object_type': form.cleaned_data.get('object_type'),
                    'object_id': form.cleaned_data.get('object_id'),
                    'notes': form.cleaned_data.get('notes', '')
                },
                expires_at=timezone.now() + timedelta(minutes=30),
                ip_address=self.request.META.get('REMOTE_ADDR'),
                user_agent=self.request.META.get('HTTP_USER_AGENT', '')
            )

            # Rediriger vers le processus de paiement spécifique
            payment_method_type = form.cleaned_data['payment_method']
            if payment_method_type == 'CREDIT_CARD':
                return redirect('payments:card_payment', session_id=payment_session.id)
            elif payment_method_type == 'PAYPAL':
                return redirect('payments:paypal_payment', session_id=payment_session.id)
            elif payment_method_type == 'MOBILE_MONEY':
                return redirect('payments:mobile_money_payment', session_id=payment_session.id)
            elif payment_method_type == 'BANK_TRANSFER':
                return redirect('payments:bank_transfer', session_id=payment_session.id)
            elif payment_method_type == 'EBI3_WALLET':
                return redirect('payments:wallet_payment', session_id=payment_session.id)
            else:
                return redirect('payments:payment_process', session_id=payment_session.id)

        except Exception as e:
            logger.error(f"Checkout error: {e}")
            messages.error(self.request, _("Une erreur est survenue lors de la création du paiement."))
            return self.form_invalid(form)


class CardPaymentView(LoginRequiredMixin, FormView):
    """Paiement par carte bancaire"""
    template_name = 'payments/checkout/card_payment.html'
    form_class = CardPaymentForm

    def dispatch(self, request, *args, **kwargs):
        try:
            self.session = get_object_or_404(
                PaymentSession,
                id=kwargs['session_id'],
                user=request.user
            )
        except:
            messages.error(request, _("Session de paiement non trouvée."))
            return redirect('payments:checkout')
        return super().dispatch(request, *args, **kwargs)

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['user'] = self.request.user
        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['session'] = self.session

        # Cartes sauvegardées
        try:
            context['saved_cards'] = PaymentCard.objects.filter(
                user=self.request.user,
                is_active=True
            )
        except Exception:
            context['saved_cards'] = []

        context['stripe_publishable_key'] = getattr(settings, 'STRIPE_PUBLISHABLE_KEY', '')

        return context

    def form_valid(self, form):
        try:
            # Traiter le paiement par carte
            # Note: Cette partie nécessite l'intégration avec Stripe ou autre processeur
            # Pour l'instant, créons simplement la transaction

            with transaction.atomic():
                # Créer la transaction
                payment_transaction = PaymentTransaction.objects.create(
                    payer=self.request.user,
                    amount=self.session.amount,
                    currency=self.session.currency,
                    payment_type='OTHER',
                    payment_method='CREDIT_CARD',
                    status='PENDING',
                    metadata={
                        'card_last_four': form.cleaned_data['card_number'][-4:],
                        'card_holder': form.cleaned_data['card_holder'],
                        'session_id': str(self.session.id)
                    }
                )

                # Mettre à jour la session
                self.session.status = 'PROCESSING'
                self.session.save()

                # Sauvegarder la carte si demandé
                if form.cleaned_data.get('save_card'):
                    try:
                        PaymentCard.objects.create(
                            user=self.request.user,
                            last_four=form.cleaned_data['card_number'][-4:],
                            expiry_month=form.cleaned_data['expiry_month'],
                            expiry_year=form.cleaned_data['expiry_year'],
                            cardholder_name=form.cleaned_data['card_holder'],
                            card_type=PaymentCard.detect_card_type(form.cleaned_data['card_number']),
                            is_active=True
                        )
                    except Exception as e:
                        logger.error(f"Error saving card: {e}")

                messages.success(self.request, _("Paiement par carte traité avec succès."))
                return redirect('payments:payment_success', transaction_id=payment_transaction.id)

        except Exception as e:
            logger.error(f"Card payment error: {e}")
            messages.error(self.request, _("Une erreur est survenue lors du traitement de votre carte."))
            return self.form_invalid(form)


class PaymentSuccessView(LoginRequiredMixin, DetailView):
    """Page de succès du paiement"""
    template_name = 'payments/checkout/success.html'
    model = PaymentTransaction
    context_object_name = 'transaction'

    def get_queryset(self):
        return PaymentTransaction.objects.filter(payer=self.request.user)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        transaction = self.object

        # Récupérer la facture
        try:
            context['invoice'] = Invoice.objects.get(transaction=transaction)
        except Invoice.DoesNotExist:
            context['invoice'] = None

        return context


class PaymentFailedView(LoginRequiredMixin, TemplateView):
    """Page d'échec du paiement"""
    template_name = 'payments/checkout/failed.html'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        session_id = self.request.GET.get('session_id')

        if session_id:
            try:
                context['session'] = PaymentSession.objects.get(id=session_id, user=self.request.user)
            except PaymentSession.DoesNotExist:
                context['session'] = None

        return context


# ============================================================================
# GESTION DU PORTEFEUILLE
# ============================================================================

class WalletDashboardView(LoginRequiredMixin, TemplateView):
    """Tableau de bord du portefeuille"""
    template_name = 'payments/wallet/dashboard.html'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        user = self.request.user

        # Récupérer ou créer le portefeuille
        wallet, created = Wallet.objects.get_or_create(user=user)
        context['wallet'] = wallet

        # Transactions récentes
        context['recent_transactions'] = WalletTransaction.objects.filter(
            wallet=wallet
        ).order_by('-created_at')[:10]

        # Statistiques
        try:
            context['stats'] = {
                'total_deposits': WalletTransaction.objects.filter(
                    wallet=wallet, transaction_type='CREDIT'
                ).aggregate(total=Sum('amount'))['total'] or Decimal('0'),
                'total_withdrawals': WalletTransaction.objects.filter(
                    wallet=wallet, transaction_type='DEBIT'
                ).aggregate(total=Sum('amount'))['total'] or Decimal('0'),
                'transaction_count': WalletTransaction.objects.filter(wallet=wallet).count(),
                'last_deposit': WalletTransaction.objects.filter(
                    wallet=wallet, transaction_type='CREDIT'
                ).order_by('-created_at').first(),
            }
        except:
            context['stats'] = {
                'total_deposits': Decimal('0'),
                'total_withdrawals': Decimal('0'),
                'transaction_count': 0,
                'last_deposit': None,
            }

        # Limites
        try:
            context['limits'] = wallet.get_current_limits()
        except Exception:
            context['limits'] = {}

        return context


class WalletRechargeView(LoginRequiredMixin, FormView):
    """Rechargement du portefeuille"""
    template_name = 'payments/wallet/recharge.html'
    form_class = WalletRechargeForm
    success_url = reverse_lazy('payments:wallet_dashboard')

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['user'] = self.request.user
        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        try:
            context['wallet'] = Wallet.objects.get(user=self.request.user)
        except Wallet.DoesNotExist:
            context['wallet'] = None

        try:
            context['payment_methods'] = PaymentMethod.objects.filter(is_active=True)
        except:
            context['payment_methods'] = []

        return context

    def form_valid(self, form):
        try:
            with transaction.atomic():
                # Récupérer le portefeuille
                wallet = Wallet.objects.get(user=self.request.user)

                # Créer une session de paiement pour le rechargement
                session = PaymentSession.objects.create(
                    user=self.request.user,
                    amount=form.cleaned_data['amount'],
                    currency=form.cleaned_data['currency'],
                    payment_method=form.cleaned_data['payment_method'],
                    metadata={'recharge': True},
                    expires_at=timezone.now() + timedelta(minutes=30),
                    ip_address=self.request.META.get('REMOTE_ADDR'),
                    user_agent=self.request.META.get('HTTP_USER_AGENT', '')
                )

                messages.success(self.request, _(
                    "Demande de rechargement créée. "
                    "Veuillez compléter le paiement."
                ))

                # Rediriger vers le paiement
                return redirect('payments:checkout') + f'?session_id={session.id}'

        except Wallet.DoesNotExist:
            messages.error(self.request, _("Vous n'avez pas de portefeuille."))
            return redirect('payments:wallet_create')
        except Exception as e:
            logger.error(f"Wallet recharge error: {e}")
            messages.error(self.request, _("Une erreur est survenue lors de la création du rechargement."))
            return self.form_invalid(form)


class WalletTransactionsView(LoginRequiredMixin, ListView):
    """Historique des transactions du portefeuille"""
    template_name = 'payments/wallet/transactions.html'
    model = WalletTransaction
    context_object_name = 'transactions'
    paginate_by = 20

    def get_queryset(self):
        try:
            wallet = Wallet.objects.get(user=self.request.user)
            return WalletTransaction.objects.filter(wallet=wallet).order_by('-created_at')
        except Wallet.DoesNotExist:
            return WalletTransaction.objects.none()

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        try:
            context['wallet'] = Wallet.objects.get(user=self.request.user)
        except Wallet.DoesNotExist:
            context['wallet'] = None

        # Filtres
        context['filter_form'] = TransactionSearchForm(self.request.GET or None)

        # Statistiques
        if context['wallet']:
            try:
                context['stats'] = {
                    'total_credited': WalletTransaction.objects.filter(
                        wallet=context['wallet'],
                        transaction_type='CREDIT',
                        status='COMPLETED'
                    ).aggregate(total=Sum('amount'))['total'] or Decimal('0'),
                    'total_debited': WalletTransaction.objects.filter(
                        wallet=context['wallet'],
                        transaction_type='DEBIT',
                        status='COMPLETED'
                    ).aggregate(total=Sum('amount'))['total'] or Decimal('0'),
                }
            except:
                context['stats'] = {
                    'total_credited': Decimal('0'),
                    'total_debited': Decimal('0'),
                }

        return context


class WalletCreateView(LoginRequiredMixin, View):
    """Création d'un portefeuille"""

    def get(self, request):
        # Vérifier si l'utilisateur a déjà un portefeuille
        if hasattr(request.user, 'wallet'):
            messages.info(request, _("Vous avez déjà un portefeuille."))
            return redirect('payments:wallet_dashboard')

        return render(request, 'payments/wallet/create.html')

    def post(self, request):
        try:
            with transaction.atomic():
                # Créer le portefeuille
                wallet = Wallet.objects.create(
                    user=request.user,
                    currency='EUR',  # Devise par défaut
                    status='ACTIVE'
                )

                # Créer le code PIN
                pin = request.POST.get('pin')
                confirm_pin = request.POST.get('confirm_pin')

                if not pin or not confirm_pin:
                    messages.error(request, _("Le code PIN est requis."))
                    return render(request, 'payments/wallet/create.html')

                if pin != confirm_pin:
                    messages.error(request, _("Les codes PIN ne correspondent pas."))
                    return render(request, 'payments/wallet/create.html')

                if len(pin) != 4 or not pin.isdigit():
                    messages.error(request, _("Le code PIN doit être composé de 4 chiffres."))
                    return render(request, 'payments/wallet/create.html')

                # Hasher et sauvegarder le PIN
                wallet.set_pin(pin)
                wallet.save()

                messages.success(request, _("Votre portefeuille a été créé avec succès."))
                return redirect('payments:wallet_dashboard')

        except Exception as e:
            logger.error(f"Wallet creation error: {e}")
            messages.error(request, _("Une erreur est survenue lors de la création du portefeuille."))
            return render(request, 'payments/wallet/create.html')


# ============================================================================
# FACTURES ET DOCUMENTS
# ============================================================================

class InvoiceListView(LoginRequiredMixin, ListView):
    """Liste des factures"""
    template_name = 'payments/invoices/list.html'
    model = Invoice
    context_object_name = 'invoices'
    paginate_by = 20

    def get_queryset(self):
        return Invoice.objects.filter(
            transaction__payer=self.request.user
        ).select_related('transaction').order_by('-created_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Statistiques
        try:
            context['stats'] = {
                'total_invoices': self.get_queryset().count(),
                'total_paid': self.get_queryset().filter(
                    status='PAID'
                ).aggregate(total=Sum('total_amount'))['total'] or Decimal('0'),
                'pending_invoices': self.get_queryset().filter(status='DRAFT').count(),
            }
        except:
            context['stats'] = {
                'total_invoices': 0,
                'total_paid': Decimal('0'),
                'pending_invoices': 0,
            }

        return context


class InvoiceDetailView(LoginRequiredMixin, DetailView):
    """Détail d'une facture"""
    template_name = 'payments/invoices/detail.html'
    model = Invoice
    context_object_name = 'invoice'

    def get_queryset(self):
        return Invoice.objects.filter(transaction__payer=self.request.user)


# ============================================================================
# REMBOURSEMENTS
# ============================================================================

class RefundRequestView(LoginRequiredMixin, CreateView):
    """Demande de remboursement"""
    template_name = 'payments/refunds/request.html'
    form_class = RefundRequestForm
    success_url = reverse_lazy('payments:refund_list')

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['user'] = self.request.user
        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Transactions éligibles au remboursement
        try:
            context['eligible_transactions'] = PaymentTransaction.objects.filter(
                payer=self.request.user,
                status='COMPLETED',
                created_at__gte=timezone.now() - timedelta(days=30)  # 30 jours max
            ).exclude(
                refunds__status__in=['REQUESTED', 'APPROVED', 'COMPLETED']
            )
        except:
            context['eligible_transactions'] = []

        return context

    def form_valid(self, form):
        try:
            with transaction.atomic():
                refund = form.save(commit=False)
                refund.requested_by = self.request.user
                refund.status = 'REQUESTED'
                refund.save()

                messages.success(self.request, _(
                    "Votre demande de remboursement a été soumise. "
                    "Elle sera traitée sous 24-48 heures."
                ))

                return super().form_valid(form)

        except Exception as e:
            logger.error(f"Refund request error: {e}")
            messages.error(self.request, _("Une erreur est survenue."))
            return self.form_invalid(form)


class RefundListView(LoginRequiredMixin, ListView):
    """Liste des remboursements"""
    template_name = 'payments/refunds/list.html'
    model = Refund
    context_object_name = 'refunds'
    paginate_by = 20

    def get_queryset(self):
        return Refund.objects.filter(requested_by=self.request.user).order_by('-created_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Statistiques
        try:
            context['stats'] = {
                'total_refunds': self.get_queryset().count(),
                'total_refunded': self.get_queryset().filter(
                    status='COMPLETED'
                ).aggregate(total=Sum('amount'))['total'] or Decimal('0'),
                'pending_refunds': self.get_queryset().filter(status='REQUESTED').count(),
            }
        except:
            context['stats'] = {
                'total_refunds': 0,
                'total_refunded': Decimal('0'),
                'pending_refunds': 0,
            }

        return context


# ============================================================================
# VUES D'ADMINISTRATION (STAFF)
# ============================================================================

class StaffPaymentDashboardView(UserPassesTestMixin, TemplateView):
    """Tableau de bord admin des paiements"""
    template_name = 'payments/admin/dashboard.html'

    def test_func(self):
        return self.request.user.is_staff

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Statistiques générales
        today = timezone.now().date()
        week_ago = today - timedelta(days=7)
        month_ago = today - timedelta(days=30)

        try:
            # Transactions
            context['total_transactions'] = PaymentTransaction.objects.count()
            context['today_transactions'] = PaymentTransaction.objects.filter(
                created_at__date=today
            ).count()
            context['week_transactions'] = PaymentTransaction.objects.filter(
                created_at__date__gte=week_ago
            ).count()

            # Volume
            context['total_volume'] = PaymentTransaction.objects.filter(
                status='COMPLETED'
            ).aggregate(total=Sum('amount'))['total'] or Decimal('0')

            context['today_volume'] = PaymentTransaction.objects.filter(
                status='COMPLETED',
                created_at__date=today
            ).aggregate(total=Sum('amount'))['total'] or Decimal('0')

            context['week_volume'] = PaymentTransaction.objects.filter(
                status='COMPLETED',
                created_at__date__gte=week_ago
            ).aggregate(total=Sum('amount'))['total'] or Decimal('0')

            # Portefeuilles
            context['total_wallets'] = Wallet.objects.count()
            context['active_wallets'] = Wallet.objects.filter(status='ACTIVE').count()
            context['total_wallet_balance'] = Wallet.objects.aggregate(
                total=Sum('balance')
            )['total'] or Decimal('0')

            # Paiements en attente
            context['pending_payouts'] = Payout.objects.filter(status='PENDING').count()
            context['pending_refunds'] = Refund.objects.filter(status='REQUESTED').count()

        except Exception as e:
            logger.error(f"Error getting dashboard stats: {e}")
            # Valeurs par défaut en cas d'erreur
            context['total_transactions'] = 0
            context['total_volume'] = Decimal('0')
            context['total_wallets'] = 0
            context['pending_payouts'] = 0
            context['pending_refunds'] = 0

        # Transactions récentes
        try:
            context['recent_transactions'] = PaymentTransaction.objects.select_related(
                'payer', 'payee'
            ).order_by('-created_at')[:10]
        except:
            context['recent_transactions'] = []

        return context


class StaffTransactionListView(UserPassesTestMixin, ListView):
    """Liste des transactions (admin)"""
    template_name = 'payments/admin/transactions.html'
    model = PaymentTransaction
    context_object_name = 'transactions'
    paginate_by = 50

    def test_func(self):
        return self.request.user.is_staff

    def get_queryset(self):
        queryset = PaymentTransaction.objects.select_related(
            'payer', 'payee'
        ).order_by('-created_at')

        # Filtres
        status = self.request.GET.get('status')
        if status:
            queryset = queryset.filter(status=status)

        date_from = self.request.GET.get('date_from')
        if date_from:
            queryset = queryset.filter(created_at__date__gte=date_from)

        date_to = self.request.GET.get('date_to')
        if date_to:
            queryset = queryset.filter(created_at__date__lte=date_to)

        search = self.request.GET.get('search')
        if search:
            queryset = queryset.filter(
                Q(reference__icontains=search) |
                Q(payer__username__icontains=search) |
                Q(payer__email__icontains=search) |
                Q(payee__username__icontains=search) |
                Q(payee__email__icontains=search)
            )

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Formulaires de filtre
        context['filter_form'] = TransactionSearchForm(self.request.GET or None)

        # Statistiques des filtres
        queryset = self.get_queryset()
        try:
            context['filter_stats'] = {
                'total': queryset.count(),
                'total_amount': queryset.filter(status='COMPLETED').aggregate(
                    total=Sum('amount')
                )['total'] or Decimal('0'),
                'pending': queryset.filter(status='PENDING').count(),
                'completed': queryset.filter(status='COMPLETED').count(),
                'failed': queryset.filter(status='FAILED').count(),
            }
        except:
            context['filter_stats'] = {
                'total': 0,
                'total_amount': Decimal('0'),
                'pending': 0,
                'completed': 0,
                'failed': 0,
            }

        return context


# ============================================================================
# VUES D'ERREUR ET REDIRECTIONS
# ============================================================================

class PaymentErrorView(TemplateView):
    """Page d'erreur générique"""
    template_name = 'payments/error.html'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Récupérer le code d'erreur
        error_code = self.kwargs.get('error_code', 'generic')
        error_messages = {
            'insufficient_funds': _("Fonds insuffisants."),
            'card_declined': _("Carte refusée."),
            'expired_card': _("Carte expirée."),
            'invalid_card': _("Carte invalide."),
            'fraud_detected': _("Paiement détecté comme frauduleux."),
            'timeout': _("Délai d'attente dépassé."),
            'gateway_error': _("Erreur de la passerelle de paiement."),
            'generic': _("Une erreur est survenue lors du paiement."),
        }

        context['error_message'] = error_messages.get(error_code, error_messages['generic'])
        context['error_code'] = error_code

        # Session ID pour réessayer
        session_id = self.request.GET.get('session_id')
        if session_id:
            try:
                context['session'] = PaymentSession.objects.get(id=session_id)
            except PaymentSession.DoesNotExist:
                pass

        return context


# ============================================================================
# VUES UTILITAIRES
# ============================================================================

@login_required
def verify_payment_status(request, reference):
    """Vérifier le statut d'un paiement par référence"""
    try:
        transaction = PaymentTransaction.objects.get(
            Q(reference=reference) | Q(payment_gateway_id=reference),
            payer=request.user
        )

        return JsonResponse({
            'status': transaction.status,
            'status_display': transaction.get_status_display(),
            'amount': str(transaction.amount),
            'currency': transaction.currency,
            'created_at': transaction.created_at.isoformat(),
        })

    except PaymentTransaction.DoesNotExist:
        return JsonResponse({'error': 'Transaction non trouvée'}, status=404)


@login_required
def payment_methods_json(request):
    """Retourner les méthodes de paiement en JSON"""
    try:
        methods = PaymentMethod.objects.filter(is_active=True).values(
            'id', 'method_type', 'is_default', 'is_verified'
        )
        return JsonResponse({'methods': list(methods)})
    except:
        return JsonResponse({'methods': []})


@login_required
def currency_rates_json(request):
    """Retourner les taux de change en JSON"""
    try:
        rates = ExchangeRate.objects.filter(
            is_active=True
        ).values('base_currency', 'target_currency', 'rate', 'last_updated')
        return JsonResponse({'rates': list(rates)})
    except:
        return JsonResponse({'rates': []})


# ============================================================================
# VUE PAR DÉFAUT (REDIRECTION)
# ============================================================================

def payment_redirect(request):
    """Rediriger vers la page de paiement appropriée"""
    # Vérifier s'il y a une session en cours
    session_id = request.GET.get('session_id')
    if session_id:
        try:
            session = PaymentSession.objects.get(id=session_id)
            return redirect('payments:payment_status', session_id=session_id)
        except PaymentSession.DoesNotExist:
            pass

    # Sinon, rediriger vers la page d'accueil des paiements
    return redirect('payments:home')


========== reviews/migrations/__init__.py ==========



========== reviews/tests.py ==========
from django.test import TestCase

# Create your tests here.



========== reviews/admin.py ==========
from django.contrib import admin



========== reviews/__init__.py ==========



========== reviews/apps.py ==========
from django.apps import AppConfig


class ReviewsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "reviews"



========== reviews/urls.py ==========
from django.urls import path

app_name = 'reviews'
urlpatterns = []



========== reviews/models.py ==========
from django.db import models

# Create your models here.



========== reviews/views.py ==========
from django.shortcuts import render

# Create your views here.



========== static/css/rtl.css ==========
/* ~/ebi3/static/css/rtl.css */
/* Styles spécifiques pour les langues RTL (Arabe) */

body[dir="rtl"] {
    font-family: 'Cairo', 'Poppins', sans-serif;
    text-align: right;
}

/* Flips for RTL */
body[dir="rtl"] .me-1 { margin-right: 0 !important; margin-left: 0.25rem !important; }
body[dir="rtl"] .me-2 { margin-right: 0 !important; margin-left: 0.5rem !important; }
body[dir="rtl"] .me-3 { margin-right: 0 !important; margin-left: 1rem !important; }
body[dir="rtl"] .me-4 { margin-right: 0 !important; margin-left: 1.5rem !important; }
body[dir="rtl"] .me-5 { margin-right: 0 !important; margin-left: 3rem !important; }

body[dir="rtl"] .ms-1 { margin-left: 0 !important; margin-right: 0.25rem !important; }
body[dir="rtl"] .ms-2 { margin-left: 0 !important; margin-right: 0.5rem !important; }
body[dir="rtl"] .ms-3 { margin-left: 0 !important; margin-right: 1rem !important; }
body[dir="rtl"] .ms-4 { margin-left: 0 !important; margin-right: 1.5rem !important; }
body[dir="rtl"] .ms-5 { margin-left: 0 !important; margin-right: 3rem !important; }

body[dir="rtl"] .ps-1 { padding-right: 0.25rem !important; padding-left: 0 !important; }
body[dir="rtl"] .ps-2 { padding-right: 0.5rem !important; padding-left: 0 !important; }
body[dir="rtl"] .ps-3 { padding-right: 1rem !important; padding-left: 0 !important; }
body[dir="rtl"] .ps-4 { padding-right: 1.5rem !important; padding-left: 0 !important; }
body[dir="rtl"] .ps-5 { padding-right: 3rem !important; padding-left: 0 !important; }

body[dir="rtl"] .pe-1 { padding-left: 0.25rem !important; padding-right: 0 !important; }
body[dir="rtl"] .pe-2 { padding-left: 0.5rem !important; padding-right: 0 !important; }
body[dir="rtl"] .pe-3 { padding-left: 1rem !important; padding-right: 0 !important; }
body[dir="rtl"] .pe-4 { padding-left: 1.5rem !important; padding-right: 0 !important; }
body[dir="rtl"] .pe-5 { padding-left: 3rem !important; padding-right: 0 !important; }

body[dir="rtl"] .text-start { text-align: right !important; }
body[dir="rtl"] .text-end { text-align: left !important; }

body[dir="rtl"] .float-start { float: right !important; }
body[dir="rtl"] .float-end { float: left !important; }

/* Dropdown alignment */
body[dir="rtl"] .dropdown-menu {
    text-align: right;
    right: auto !important;
    left: 0 !important;
}

body[dir="rtl"] .dropdown-menu-end {
    left: auto !important;
    right: 0 !important;
}

/* Carousel controls */
body[dir="rtl"] .carousel-control-prev {
    right: 0;
    left: auto;
}

body[dir="rtl"] .carousel-control-next {
    left: 0;
    right: auto;
}

/* Breadcrumb */
body[dir="rtl"] .breadcrumb-item + .breadcrumb-item::before {
    float: right;
    padding-left: 0.5rem;
    padding-right: 0;
}

/* Form elements */
body[dir="rtl"] .form-check {
    padding-right: 1.5em;
    padding-left: 0;
}

body[dir="rtl"] .form-check-input {
    float: right;
    margin-right: -1.5em;
    margin-left: 0;
}

body[dir="rtl"] .input-group > .form-control,
body[dir="rtl"] .input-group > .form-select {
    border-radius: 0 0.375rem 0.375rem 0;
}

body[dir="rtl"] .input-group > .form-control:not(:last-child),
body[dir="rtl"] .input-group > .form-select:not(:last-child) {
    border-radius: 0 0.375rem 0.375rem 0;
}

body[dir="rtl"] .input-group > .form-control:not(:first-child),
body[dir="rtl"] .input-group > .form-select:not(:first-child) {
    border-radius: 0.375rem 0 0 0.375rem;
}

/* Modal */
body[dir="rtl"] .modal-header .btn-close {
    margin: -0.5rem auto -0.5rem -0.5rem;
}

/* Navbar brand */
body[dir="rtl"] .navbar-brand {
    margin-right: 0;
    margin-left: 1rem;
}

/* Alert close button */
body[dir="rtl"] .alert-dismissible .btn-close {
    margin-left: 0;
    margin-right: -0.5rem;
}

/* List styles */
body[dir="rtl"] ul {
    padding-right: 20px;
    padding-left: 0;
}

/* Custom Arabic font sizes */
body[dir="rtl"] .display-1,
body[dir="rtl"] .display-2,
body[dir="rtl"] .display-3,
body[dir="rtl"] .display-4,
body[dir="rtl"] .display-5,
body[dir="rtl"] .display-6 {
    line-height: 1.3;
}

/* Fix for Bootstrap icons in RTL */
body[dir="rtl"] .bi-chevron-right::before {
    content: "\f284"; /* Chevron left */
}

body[dir="rtl"] .bi-chevron-left::before {
    content: "\f285"; /* Chevron right */
}

/* Custom RTL spacing utilities */
.rtl-mr-1 { margin-right: 0.25rem !important; }
.rtl-ml-1 { margin-left: 0.25rem !important; }
.rtl-mr-2 { margin-right: 0.5rem !important; }
.rtl-ml-2 { margin-left: 0.5rem !important; }
.rtl-mr-3 { margin-right: 1rem !important; }
.rtl-ml-3 { margin-left: 1rem !important; }


========== static/css/admin-logistics.css ==========
/* ~/ebi3/static/css/admin-logistics.css */

/* Styles pour les barres de progression */
.progress-bar {
    background-color: #f0f0f0;
    border-radius: 3px;
    height: 20px;
    position: relative;
}

.progress-fill {
    border-radius: 3px;
    height: 100%;
    transition: width 0.3s ease;
}

/* Couleurs selon le pourcentage */
.progress-low { background-color: #F44336; }  /* Rouge */
.progress-medium { background-color: #FFC107; } /* Orange */
.progress-high { background-color: #4CAF50; } /* Vert */

/* Styles pour les statuts */
.status-badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
}

.status-pending { background-color: #FFC107; color: #000; }
.status-confirmed { background-color: #2196F3; color: #fff; }
.status-in-transit { background-color: #9C27B0; color: #fff; }
.status-delivered { background-color: #4CAF50; color: #fff; }
.status-cancelled { background-color: #F44336; color: #fff; }

/* Amélioration des tableaux */
#changelist table thead th {
    background-color: #667eea;
    color: white;
}

/* Espacement amélioré */
.field-get_ad_link,
.field-get_buyer_link,
.field-get_carrier_link {
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 10px;
}


========== static/css/style.css ==========
/* ~/ebi3/static/css/style.css */
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --success-color: #28a745;
    --info-color: #17a2b8;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
    --border-radius: 8px;
    --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

/* Base Styles */
body {
    font-family: 'Poppins', 'Cairo', sans-serif;
    line-height: 1.6;
    color: #333;
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
    font-weight: 600;
    margin-bottom: 1rem;
}

.display-1, .display-2, .display-3, .display-4, .display-5, .display-6 {
    font-weight: 700;
}

/* Links */
a {
    color: var(--primary-color);
    text-decoration: none;
    transition: var(--transition);
}

a:hover {
    color: var(--secondary-color);
}

/* Buttons */
.btn {
    border-radius: var(--border-radius);
    padding: 0.5rem 1.5rem;
    font-weight: 500;
    transition: var(--transition);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
}

.btn-outline-primary {
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline-primary:hover {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-color: transparent;
    transform: translateY(-2px);
}

/* Cards */
.card {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    transition: var(--transition);
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.card-header {
    border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
}

/* Forms */
.form-control, .form-select {
    border-radius: var(--border-radius);
    border: 1px solid #ddd;
    padding: 0.75rem 1rem;
    transition: var(--transition);
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

/* Navigation */
.navbar-brand {
    font-weight: 700;
    font-size: 1.5rem;
}

.nav-link {
    font-weight: 500;
    padding: 0.5rem 1rem !important;
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.nav-link:hover, .nav-link.active {
    background-color: rgba(102, 126, 234, 0.1);
    color: var(--primary-color) !important;
}

/* Footer */
footer {
    background: linear-gradient(135deg, #343a40 0%, #212529 100%);
}

footer a:hover {
    color: white !important;
    opacity: 0.8;
}

/* Badges */
.badge {
    border-radius: 20px;
    padding: 0.4em 0.8em;
    font-weight: 500;
}

/* Alerts */
.alert {
    border-radius: var(--border-radius);
    border: none;
}

/* Pagination */
.pagination .page-link {
    border-radius: var(--border-radius);
    margin: 0 2px;
}

.pagination .page-item.active .page-link {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-color: transparent;
}

/* Images */
.img-thumbnail {
    border-radius: var(--border-radius);
}

/* Avatar */
.avatar-circle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-weight: bold;
    color: white;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.5s ease-out;
}

/* Responsive */
@media (max-width: 768px) {
    .display-1 { font-size: 3rem; }
    .display-2 { font-size: 2.5rem; }
    .display-3 { font-size: 2rem; }
    .display-4 { font-size: 1.75rem; }
    .display-5 { font-size: 1.5rem; }
    .display-6 { font-size: 1.25rem; }

    .btn {
        padding: 0.4rem 1rem;
        font-size: 0.9rem;
    }
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 10px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    opacity: 0.8;
}

/* Print Styles */
@media print {
    .no-print {
        display: none !important;
    }
}


========== static/js/main.js ==========
// ~/ebi3/static/js/main.js
// Fonctions utilitaires globales

// Debounce function pour les événements
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Formatage des prix
function formatPrice(price, currency = '€') {
    return new Intl.NumberFormat('fr-FR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(price) + ' ' + currency;
}

// Validation des formulaires
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function validatePhone(phone) {
    const re = /^[\+]?[1-9][\d]{0,15}$/;
    return re.test(phone.replace(/\D/g, ''));
}

// Gestion des toasts
function showToast(message, type = 'success', duration = 5000) {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();

    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: duration });

    toast.show();

    // Nettoyage après fermeture
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}

// Gestion des images
function lazyLoadImages() {
    const images = document.querySelectorAll('img[data-src]');

    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                observer.unobserve(img);
            }
        });
    });

    images.forEach(img => imageObserver.observe(img));
}

// Gestion du multilinguisme
function changeLanguage(langCode) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/i18n/setlang/';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCookie('csrftoken');
    form.appendChild(csrfInput);

    const langInput = document.createElement('input');
    langInput.type = 'hidden';
    langInput.name = 'language';
    langInput.value = langCode;
    form.appendChild(langInput);

    const nextInput = document.createElement('input');
    nextInput.type = 'hidden';
    nextInput.name = 'next';
    nextInput.value = window.location.pathname;
    form.appendChild(nextInput);

    document.body.appendChild(form);
    form.submit();
}

// Helper pour les cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Activer les tooltips Bootstrap
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));

    // Activer les popovers Bootstrap
    const popovers = document.querySelectorAll('[data-bs-toggle="popover"]');
    popovers.forEach(popover => new bootstrap.Popover(popover));

    // Chargement différé des images
    lazyLoadImages();

    // Gestion des formulaires AJAX
    document.querySelectorAll('form[data-ajax]').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const submitBtn = this.querySelector('[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Afficher un indicateur de chargement
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Loading...';
            submitBtn.disabled = true;

            fetch(this.action, {
                method: this.method,
                body: new FormData(this),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast(data.message, 'success');
                    if (data.redirect) {
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 1500);
                    }
                } else {
                    showToast(data.message || 'Une erreur est survenue', 'error');
                }
            })
            .catch(error => {
                showToast('Une erreur est survenue', 'error');
                console.error('Error:', error);
            })
            .finally(() => {
                // Restaurer le bouton
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    });

    // Gestion du scroll pour la navbar
    const navbar = document.querySelector('.navbar');
    if (navbar) {
        window.addEventListener('scroll', debounce(() => {
            if (window.scrollY > 100) {
                navbar.classList.add('navbar-scrolled');
            } else {
                navbar.classList.remove('navbar-scrolled');
            }
        }, 100));
    }

    // Gestion des onglets de contenu
    document.querySelectorAll('.content-tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();

            const targetId = this.getAttribute('href');
            const targetContent = document.querySelector(targetId);

            // Cacher tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Désactiver tous les onglets
            document.querySelectorAll('.content-tab').forEach(t => {
                t.classList.remove('active');
            });

            // Activer l'onglet et le contenu sélectionnés
            this.classList.add('active');
            targetContent.classList.add('active');
        });
    });
});

// Fonction pour partager du contenu
function shareContent(title, text, url) {
    if (navigator.share) {
        navigator.share({
            title: title,
            text: text,
            url: url,
        })
        .then(() => console.log('Partage réussi'))
        .catch(error => console.log('Erreur de partage:', error));
    } else {
        // Fallback pour les navigateurs qui ne supportent pas l'API Web Share
        navigator.clipboard.writeText(url)
            .then(() => showToast('Lien copié dans le presse-papier', 'success'))
            .catch(err => console.error('Erreur de copie:', err));
    }
}

// Fonction pour télécharger des fichiers
function downloadFile(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename || url.split('/').pop();
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Export des fonctions globales
window.Ebi3 = {
    showToast,
    formatPrice,
    validateEmail,
    validatePhone,
    changeLanguage,
    shareContent,
    downloadFile
};


========== static/colis/css/colis.css ==========
/* Fichier CSS colis */


========== static/colis/js/colis.js ==========
// Fichier JS colis


========== staticfiles/mptt/draggable-admin.js ==========
/* global django */

// IE<9 lacks Array.prototype.indexOf
if (!Array.prototype.indexOf) {
  Array.prototype.indexOf = function (needle) {
    for (var i = 0, l = this.length; i < l; ++i) {
      if (this[i] === needle) return i
    }
    return -1
  }
}

// https://github.com/jquery/jquery-ui/blob/master/ui/disable-selection.js
django.jQuery.fn.extend({
  disableSelection: (function () {
    var eventType =
      "onselectstart" in document.createElement("div")
        ? "selectstart"
        : "mousedown"

    return function () {
      return this.on(eventType + ".ui-disableSelection", function (event) {
        event.preventDefault()
      })
    }
  })(),

  enableSelection: function () {
    return this.off(".ui-disableSelection")
  },
})

django.jQuery(function ($) {
  // We are not on a changelist it seems.
  if (!document.getElementById("result_list")) return

  var DraggableMPTTAdmin = null

  function isExpandedNode(id) {
    return DraggableMPTTAdmin.collapsedNodes.indexOf(id) == -1
  }

  function markNodeAsExpanded(id) {
    // remove itemId from array of collapsed nodes
    var idx = DraggableMPTTAdmin.collapsedNodes.indexOf(id)
    if (idx >= 0) DraggableMPTTAdmin.collapsedNodes.splice(idx, 1)
  }

  function markNodeAsCollapsed(id) {
    if (isExpandedNode(id)) DraggableMPTTAdmin.collapsedNodes.push(id)
  }

  function treeNode(pk) {
    return $('.tree-node[data-pk="' + pk + '"]')
  }

  // toggle children
  function doToggle(id, show) {
    var children = DraggableMPTTAdmin.treeStructure[id] || []
    for (var i = 0; i < children.length; ++i) {
      var childId = children[i]
      if (show) {
        treeNode(childId).closest("tr").show()
        // only reveal children if current node is not collapsed
        if (isExpandedNode(childId)) {
          doToggle(childId, show)
        }
      } else {
        treeNode(childId).closest("tr").hide()
        // always recursively hide children
        doToggle(childId, show)
      }
    }
  }

  function rowLevel($row) {
    try {
      return $row.find(".tree-node").data("level") || 0
    } catch (e) {
      return 0
    }
  }

  /*
   * FeinCMS Drag-n-drop tree reordering.
   * Based upon code by bright4 for Radiant CMS, rewritten for
   * FeinCMS by Bjorn Post.
   *
   * September 2010
   */
  $.extend(
    ($.fn.feinTree = function () {
      $.each(DraggableMPTTAdmin.treeStructure, function (key, _value) {
        treeNode(key).addClass("children")
      })

      $("div.drag-handle").bind("mousedown", function (event) {
        var BEFORE = "before"
        var AFTER = "after"
        var CHILD = "child"
        var CHILD_PAD = DraggableMPTTAdmin.levelIndent
        var originalRow = $(event.target).closest("tr")
        var rowHeight = originalRow.height()
        var moveTo = new Object()
        var resultListWidth = $("#result_list").width()

        $("body")
          .addClass("dragging")
          .disableSelection()
          .bind("mousemove", function (event) {
            // Remove focus
            originalRow.blur()

            // attach dragged item to mouse
            var cloned = originalRow.html()
            if ($("#ghost").length == 0) {
              $('<div id="ghost"></div>').appendTo("body")
            }
            $("#ghost")
              .html(cloned)
              .css({
                opacity: 0.8,
                position: "absolute",
                top: event.pageY,
                left: event.pageX - 30,
                width: 600,
              })

            // check on edge of screen
            if (
              event.pageY + 100 >
              $(window).height() + $(window).scrollTop()
            ) {
              $("html,body")
                .stop()
                .animate({ scrollTop: $(window).scrollTop() + 250 }, 500)
            } else if (event.pageY - 50 < $(window).scrollTop()) {
              $("html,body")
                .stop()
                .animate({ scrollTop: $(window).scrollTop() - 250 }, 500)
            }

            // check if drag-line element already exists, else append
            if ($("#drag-line").length < 1) {
              $("body").append('<div id="drag-line"><span></span></div>')
            }

            // loop through all rows
            $("tr", originalRow.parent()).each(function (index, el) {
              var element = $(el),
                top = element.offset().top,
                next

              // check if mouse is over a row
              if (event.pageY >= top && event.pageY < top + rowHeight) {
                var targetRow = null,
                  targetLoc = null,
                  elementLevel = rowLevel(element)

                if (event.pageY >= top && event.pageY < top + rowHeight / 3) {
                  targetRow = element
                  targetLoc = BEFORE
                } else if (
                  event.pageY >= top + rowHeight / 3 &&
                  event.pageY < top + (rowHeight * 2) / 3
                ) {
                  next = element.next()
                  // there's no point in allowing adding children when there are some already
                  // better move the items to the correct place right away
                  if (!next.length || rowLevel(next) <= elementLevel) {
                    targetRow = element
                    targetLoc = CHILD
                  }
                } else if (
                  event.pageY >= top + (rowHeight * 2) / 3 &&
                  event.pageY < top + rowHeight
                ) {
                  next = element.next()
                  if (!next.length || rowLevel(next) <= elementLevel) {
                    targetRow = element
                    targetLoc = AFTER
                  }
                }

                if (targetRow) {
                  // Positioning relative to cell containing the link
                  var offset = targetRow.find("th").offset()
                  var left =
                    offset.left +
                    rowLevel(targetRow) * CHILD_PAD +
                    (targetLoc == CHILD ? CHILD_PAD : 0) +
                    5 // Center of the circle aligns with start of link text (cell padding!)

                  $("#drag-line")
                    .css({
                      width: resultListWidth - left,
                      left: left,
                      top: offset.top + (targetLoc == BEFORE ? 0 : rowHeight),
                    })
                    .find("span")
                    .text(DraggableMPTTAdmin.messages[targetLoc] || "")

                  // Store the found row and options
                  moveTo.hovering = element
                  moveTo.relativeTo = targetRow
                  moveTo.side = targetLoc

                  return true
                }
              }
            })
          })

        $("body").keydown(function (event) {
          if (event.which == "27") {
            $("#drag-line").remove()
            $("#ghost").remove()
            $("body")
              .removeClass("dragging")
              .enableSelection()
              .unbind("mousemove")
              .unbind("mouseup")
            event.preventDefault()
          }
        })

        $("body").bind("mouseup", function () {
          if (moveTo.relativeTo) {
            var cutItem = originalRow.find(".tree-node").data("pk")
            var pastedOn = moveTo.relativeTo.find(".tree-node").data("pk")

            // get out early if items are the same
            if (cutItem != pastedOn) {
              var isParent =
                rowLevel(moveTo.relativeTo.next()) > rowLevel(moveTo.relativeTo)

              var position = ""

              // determine position
              if (moveTo.side == CHILD && !isParent) {
                position = "last-child"
              } else if (moveTo.side == BEFORE) {
                position = "left"
              } else {
                position = "right"
              }

              $.ajax({
                complete: function () {
                  window.location.reload()
                },
                data: {
                  cmd: "move_node",
                  position: position,
                  cut_item: cutItem,
                  pasted_on: pastedOn,
                },
                headers: {
                  "X-CSRFToken": $(
                    "input[type=hidden][name=csrfmiddlewaretoken]",
                  ).val(),
                },
                method: "POST",
              })
            } else {
              $("#drag-line").remove()
              $("#ghost").remove()
            }
            $("body")
              .removeClass("dragging")
              .enableSelection()
              .unbind("mousemove")
              .unbind("mouseup")
          }
        })
      })

      return this
    }),
  )

  /* Every time the user expands or collapses a part of the tree, we remember
       the current state of the tree so we can restore it on a reload. */
  function storeCollapsedNodes(nodes) {
    window.localStorage &&
      window.localStorage.setItem(
        DraggableMPTTAdmin.storageName,
        JSON.stringify(nodes),
      )
  }

  function retrieveCollapsedNodes() {
    try {
      return JSON.parse(
        window.localStorage.getItem(DraggableMPTTAdmin.storageName),
      )
    } catch (e) {
      return null
    }
  }

  function expandOrCollapseNode(item) {
    var show = true

    if (!item.hasClass("children")) return

    var itemId = item.data("pk")

    if (!isExpandedNode(itemId)) {
      item.removeClass("closed")
      markNodeAsExpanded(itemId)
    } else {
      item.addClass("closed")
      show = false
      markNodeAsCollapsed(itemId)
    }

    storeCollapsedNodes(DraggableMPTTAdmin.collapsedNodes)

    doToggle(itemId, show)
  }

  function collapseTree() {
    var rlist = $("#result_list")
    rlist.hide()
    $("tbody tr", rlist).each(function (i, el) {
      var marker = $(".tree-node", el)
      if (marker.hasClass("children")) {
        var itemId = marker.data("pk")
        doToggle(itemId, false)
        marker.addClass("closed")
        markNodeAsCollapsed(itemId)
      }
    })
    storeCollapsedNodes(DraggableMPTTAdmin.collapsedNodes)
    rlist.show()
    return false
  }

  function expandTree() {
    var rlist = $("#result_list")
    rlist.hide()
    $("tbody tr", rlist).each(function (i, el) {
      var marker = $(".tree-node", el)
      if (marker.hasClass("children")) {
        var itemId = $(".tree-node", el).data("pk")
        doToggle(itemId, true)
        marker.removeClass("closed")
        markNodeAsExpanded(itemId)
      }
    })
    storeCollapsedNodes([])
    rlist.show()
    return false
  }

  var changelistTab = function (elem, event, direction) {
    event.preventDefault()
    elem = $(elem)
    var ne =
      direction > 0
        ? elem.nextAll(":visible:first")
        : elem.prevAll(":visible:first")
    if (ne) {
      elem.attr("tabindex", -1)
      ne.attr("tabindex", "0")
      ne.focus()
    }
  }

  function keyboardNavigationHandler(event) {
    // On form element? Ignore.
    if (/textarea|select|input/i.test(event.target.nodeName)) return

    // console.log('keydown', this, event.keyCode);
    switch (event.keyCode) {
      case 40: // down
        changelistTab(this, event, 1)
        break
      case 38: // up
        changelistTab(this, event, -1)
        break
      case 37: // left
      case 39: // right
        expandOrCollapseNode($(this).find(".tree-node"))
        break
      case 13: // return
        document.location = $("a", this).attr("href")
        break
      default:
        break
    }
  }

  function addObjectTool(title, handler) {
    var $a = $("<a href/>")
    $a.click(handler)
    $a.text(title)
    $a.prependTo(".object-tools").wrap("<li>")
  }

  // Some old browsers do not support JSON.parse (the only thing we require)
  var jsonParse =
    JSON.parse ||
    function jsonParse(sJSON) {
      return eval("(" + sJSON + ")")
    }

  DraggableMPTTAdmin = jsonParse(
    document
      .getElementById("draggable-admin-context")
      .getAttribute("data-context"),
  )

  addObjectTool(DraggableMPTTAdmin.messages.collapseTree, collapseTree)
  addObjectTool(DraggableMPTTAdmin.messages.expandTree, expandTree)

  // fire!
  var rlist = $("#result_list"),
    rlist_tbody = rlist.find("tbody")

  if ($("tbody tr", rlist).length > 1) {
    rlist_tbody.feinTree()

    rlist.find(".tree-node").on("click", function (event) {
      event.preventDefault()
      event.stopPropagation()

      expandOrCollapseNode($(this))
    })

    /* Enable focussing, put focus on first result, add handler for keyboard navigation */
    $("tr", rlist).attr("tabindex", -1)
    $("tbody tr:first", rlist).attr("tabindex", 0).focus()
    $("tr", rlist).keydown(keyboardNavigationHandler)

    DraggableMPTTAdmin.collapsedNodes = []
    var storedNodes = retrieveCollapsedNodes()

    if (storedNodes) {
      for (var i = 0; i < storedNodes.length; i++) {
        expandOrCollapseNode(treeNode(storedNodes[i]))
      }
    } else {
      if (!DraggableMPTTAdmin.expandTreeByDefault) {
        collapseTree()
      }
    }
  }
})



========== staticfiles/mptt/draggable-admin.css ==========
.field-tree_actions {
  width: 50px;
  padding: 2px;
}

.field-tree_actions > div {
  display: inline-block;
  vertical-align: middle;
  background-repeat: no-repeat;
  width: 18px;
  height: 18px;
  margin: 7px 2px 0 0;
}

.tree-node {
  cursor: pointer;
}
.tree-node.children {
  background-image: url(disclosure-down-black.png);
}
.tree-node.closed {
  background-image: url(disclosure-right-black.png);
}

.drag-handle {
  background-image: url(arrow-move-black.png);
  cursor: move;
}

/* focus */
#result_list tbody tr:focus {
  background-color: var(--selected-row, #ffc) !important;
  outline: 0px;
}

@media (prefers-color-scheme: dark) {
  html:not([data-theme="light"]) .tree-node.children {
    background-image: url(disclosure-down-white.png);
  }
  html:not([data-theme="light"]) .tree-node.closed {
    background-image: url(disclosure-right-white.png);
  }
  html:not([data-theme="light"]) .drag-handle {
    background-image: url(arrow-move-white.png);
  }

  html:not([data-theme="light"]) #result_list tbody tr:focus {
    background-color: var(--selected-row, #00363a) !important;
    outline: 0px;
  }
}

#drag-line {
  position: absolute;
  height: 3px;
  font-size: 0px;
  background-color: #417690;
}

#drag-line:before {
  content: " ";
  display: block;
  position: absolute;
  height: 10px;
  width: 10px;
  background: #417690;
  margin: -3px 0 0 0;
  border-radius: 9px;
}

#drag-line span {
  display: block;
  position: absolute;
  left: 15px;
  bottom: 0;
  width: 300px;
  height: 18px;
  color: #417690;
  font-size: 12px;
}



========== staticfiles/admin/rosetta/css/rosetta.css ==========
#user-tools p span {
    margin-left: 2em;
}
table {
    width: 100%;
}
td.translation label {
    font-size: 95%;
}
td.translation textarea,
td.original {
    font-size: 110%;
}
td.translation,
td.original {
    width: 30%;
}
td.original .plural-container {
    position: relative;
}
td .context,
td.original .message {
    display: block;
}
td .context {
    margin-top: 1rem;
    color: #999;
}
td.translation textarea {
    width: 98.5%;
    margin: 2px 0;
}
.rtl td.translation textarea {
    direction: rtl;
}
.plural span {
    display: block;
    margin: 2px 0;
    position: absolute;
}
td.location code,
td.location a {
    font-size: 95%;
    display: block;
}
td.location code.hide {
    display: none;
}
.submit-row {
    margin-bottom: 0;
    margin-top: 0.5rem;
}
#changelist .paginator {
    background: var(--darkened-bg);
    border-bottom: none;
}

li.nobubble,
li.nobubble:hover {
    background-image: none;
}
.object-tools li.active,
.object-tools li.active a {
    color: yellow;
}
p.paginator input {
    float: right;
}
p.paginator span.space {
    margin: 0 0.5em;
}
.paginator {
    text-align: left;
    border: none;
    background: transparent;
}
.paginator strong {
    margin-left: 1em;
}
th.r,
td.r {
    text-align: right;
}
th.c,
td.c {
    text-align: center;
}
td.original code {
    font-size: 90%;
    padding: 0 1px;
}
tr.row2 td.original code {
    background-color: #ffb2a5;
    padding: 0 0.3em;
}
tr.row1 td.original code {
    background-color: #ffb2a5;
}
.alert {
    font-weight: bold;
    padding: 4px 5px 4px 25px;
    color: red;
    background: transparent
        url(data:image/svg+xml,%3Csvg%20width%3D%2214%22%20height%3D%2214%22%20viewBox%3D%220%200%201792%201792%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%20%20%3Cpath%20fill%3D%22%23efb80b%22%20d%3D%22M1024%201375v-190q0-14-9.5-23.5t-22.5-9.5h-192q-13%200-22.5%209.5t-9.5%2023.5v190q0%2014%209.5%2023.5t22.5%209.5h192q13%200%2022.5-9.5t9.5-23.5zm-2-374l18-459q0-12-10-19-13-11-24-11h-220q-11%200-24%2011-10%207-10%2021l17%20457q0%2010%2010%2016.5t24%206.5h185q14%200%2023.5-6.5t10.5-16.5zm-14-934l768%201408q35%2063-2%20126-17%2029-46.5%2046t-63.5%2017h-1536q-34%200-63.5-17t-46.5-46q-37-63-2-126l768-1408q17-31%2047-49t65-18%2065%2018%2047%2049z%22%2F%3E%0A%3C%2Fsvg%3E%0A)
        5px 0.3em no-repeat;
}
p.errornote {
    margin-top: 0.4em;
}
#footer {
    clear: both;
    color: #999;
    font-size: 9px;
    margin: 0 6px;
    text-align: left;
}
#changelist table tbody td:first-child,
#changelist table thead th:first-child {
    text-align: left;
}
td.hint {
    color: #777;
}
div.module {
    margin-bottom: 20px;
}
.checkall {
    cursor: pointer;
}
#toolbar {
    height: 20px;
}
#toolbar #translate-all {
    float: right;
}
#toolbar form {
    float: left;
}
#changelist table thead th {
    padding: 2px 5px;
}

#changelist {
    display: block !important;
}

.info-tip::after {
    content: "?";
    color: white;
    background-color: #bbb;
    margin-left: 5px;
    padding: 1px 5px;
    border-radius: 10px;
    font-size: 11px;
}
#action-toggle {
    display: inline;
}
a.suggest {
    display: block;
    margin-bottom: 5px;
}



========== staticfiles/admin/rosetta/js/rosetta.js ==========
"use strict";

const rosetta_settings = JSON.parse(document.getElementById("rosetta-settings-js").textContent);

document.addEventListener("DOMContentLoaded", () => {
    // Get original html that corresponds to a given textarea containing the translation
    function originalForTextarea(textarea) {
        const textareasInCell = textarea.closest("td").querySelectorAll("textarea");
        const nth = Array.from(textareasInCell).indexOf(textarea) + 1;
        return textarea
            .closest("tr")
            .querySelector(".original")
            .querySelector(`.message, .part:nth-of-type(${nth})`).innerHTML;
    }

    // Common code for handling translation suggestions
    function suggest(translate) {
        document.querySelectorAll("a.suggest").forEach((a) => {
            a.addEventListener("click", (event) => {
                event.preventDefault();
                const textarea = a.previousElementSibling;
                const orig = originalForTextarea(textarea);
                a.classList.add("suggesting");
                a.textContent = "...";
                translate(
                    orig,
                    (translation) => {
                        textarea.value = translation;
                        textarea.dispatchEvent(new Event("input"));
                        textarea.dispatchEvent(new Event("change"));
                        textarea.dispatchEvent(new Event("blur"));
                        a.style.visibility = "hidden";
                    },
                    (error) => {
                        console.error("Rosetta translation suggestion error:", error);
                        let errorMsg;
                        if (error?.message) {
                            errorMsg = error.message;
                        } else if (error?.error) {
                            errorMsg = error.error;
                        } else if (typeof error === "object") {
                            errorMsg = JSON.stringify(error);
                        } else {
                            errorMsg = error || "Error loading translation";
                        }
                        a.textContent = String(errorMsg).trim().substring(0, 100);
                        alignPlurals();
                    },
                );
            });
        });
    }

    function jsonp(url, params, callback) {
        var callbackName = "rosetta_jsonp_callback_" + Math.random().toString(36).substr(2, 8);
        window[callbackName] = function (response) {
            callback(response);
            delete window[callbackName];
        };
        params.callback = callbackName;
        var script = document.createElement("script");
        script.src = `${url}?${new URLSearchParams(params).toString()}`;
        document.body.appendChild(script);
        script.onerror = function () {
            callback("Failed to load translation with jsonp request");
            delete window[callbackName];
        };
    }

    // Translation suggestions
    if (rosetta_settings.ENABLE_TRANSLATION_SUGGESTIONS) {
        if (rosetta_settings.server_auth_key) {
            suggest((orig, setTranslation, setError) => {
                const origUnescaped = unescape(orig)
                    .replace(/<br\s?\/?>/g, "\n")
                    .replace(/<code>/g, "")
                    .replace(/<\/code>/g, "")
                    .replace(/&gt;/g, ">")
                    .replace(/&lt;/g, "<");
                const params = new URLSearchParams({
                    from: rosetta_settings.MESSAGES_SOURCE_LANGUAGE_CODE,
                    to: rosetta_settings.rosetta_i18n_lang_code_normalized,
                    text: origUnescaped,
                });
                const url = `${rosetta_settings.translate_text_url}?${params.toString()}`;
                fetch(url)
                    .then((r) => r.json())
                    .then((data) => {
                        if (data.success) {
                            setTranslation(
                                unescape(data.translation)
                                    .replace(/&#39;/g, "'")
                                    .replace(/&quot;/g, '"')
                                    .replace(/%\s+(\([^)]+\))\s*s/g, " %$1s "),
                            );
                        } else {
                            setError(data);
                        }
                    })
                    .catch(setError);
            });
        } else if (rosetta_settings.YANDEX_TRANSLATE_KEY) {
            suggest((orig, setTranslation, setError) => {
                const apiUrl = "https://translate.yandex.net/api/v1.5/tr.json/translate";
                const destLangRoot = rosetta_settings.rosetta_i18n_lang_code.split("-")[0];
                const lang = rosetta_settings.MESSAGES_SOURCE_LANGUAGE_CODE + "-" + destLangRoot;
                const apiData = {
                    error: "onTranslationError",
                    success: "onTranslationComplete",
                    lang: lang,
                    key: rosetta_settings.YANDEX_TRANSLATE_KEY,
                    format: "html",
                    text: orig,
                };
                jsonp(apiUrl, apiData, (response) => {
                    if (response.code === 200) {
                        setTranslation(
                            response.text[0]
                                .replace(/< ?br>/g, "\n")
                                .replace(/< ?\/? ?code>/g, "")
                                .replace(/&lt;/g, "<")
                                .replace(/&gt;/g, ">"),
                        );
                    } else {
                        setError(response);
                    }
                });
            });
        }
    }

    // Make textarea height adapt to the contents
    function autofitTextarea(textarea) {
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
    }

    // If there are multiple textareas for plurals then align the originals vertically with the textareas
    function alignPlurals() {
        document.querySelectorAll(".results td.plural").forEach((td) => {
            const tr = td.closest("tr");
            const trY = tr.getBoundingClientRect().top + window.scrollY;
            tr.querySelectorAll("textarea").forEach((textarea, i) => {
                const part = td.querySelectorAll(".part")[i];
                if (part) {
                    const textareaY = textarea.getBoundingClientRect().top + window.scrollY - trY;
                    part.style.top = textareaY + "px";
                }
            });
        });
    }

    // Show warning if the variables in the original and the translation don't match
    function validateTranslation(textarea) {
        const orig = originalForTextarea(textarea);
        const variablePattern = /%(?:\([^\s)]*\))?[sdf]|\{[^\s}]*\}/g;
        const origVars = orig.match(variablePattern) || [];
        const transVars = textarea.value.match(variablePattern) || [];
        const everyOrigVarUsed = origVars.every((origVar) => transVars.includes(origVar));
        const onlyValidVarsUsed = transVars.every((transVar) => origVars.includes(transVar));
        const valid = everyOrigVarUsed && onlyValidVarsUsed;
        textarea.previousElementSibling.classList.toggle("hidden", valid);
    }

    // Select all the textareas that are used for translations
    const textareas = document.querySelectorAll(".translation textarea");

    // For each translation field textarea
    textareas.forEach((textarea) => {
        // On page load make textarea height adapt to its contents
        autofitTextarea(textarea);

        // On input
        textarea.addEventListener("input", () => {
            // Make textarea height adapt to its contents
            autofitTextarea(textarea);

            // If there are multiple textareas for plurals then align the originals vertically with the textareas
            alignPlurals();

            // Once users start editing the translation untick the fuzzy checkbox automatically
            textarea.closest("tr").querySelector('td.c input[type="checkbox"]').checked = false;
        });

        // On blur show warnings for unmatched variables in translations
        textarea.addEventListener("blur", () => validateTranslation(textarea));
    });

    // On window resize make textarea height adapt to their contents
    window.addEventListener("resize", () => textareas.forEach(autofitTextarea), { passive: true });

    // On page load if there are multiple textareas in a cell for plurals then align the originals vertically with them
    alignPlurals();

    // Reload page when changing ref-language
    document.getElementById("ref-language-selector")?.addEventListener("change", function () {
        window.location.href = this.value;
    });

    // Toggle fuzzy state for all entries on the current page
    document.getElementById("action-toggle")?.addEventListener("change", function () {
        const checkboxes = document.querySelectorAll('tbody td.c input[type="checkbox"]');
        checkboxes.forEach((checkbox) => (checkbox.checked = this.checked));
    });

    // Toggle additional locations that are initially hidden
    document.querySelectorAll(".location a").forEach((link) => {
        link.addEventListener("click", (event) => {
            event.preventDefault();
            const prevText = link.innerText;
            link.innerText = link.dataset.prevText;
            link.dataset.prevText = prevText;
            link.parentElement.querySelectorAll(".hide").forEach((loc) => {
                const hidden = loc.style.display === "none" || loc.style.display === "";
                loc.style.display = hidden ? "block" : "none";
            });
        });
    });

    // Warn about any unsaved changes before navigating away from the page
    const form = document.querySelector("form.results");
    function formToJsonString() {
        const obj = {};
        new FormData(form).forEach((value, key) => (obj[key] = value));
        return JSON.stringify(obj);
    }
    if (form) {
        const initialDataJson = formToJsonString();
        let isSubmitting = false;
        form.addEventListener("submit", () => (isSubmitting = true));
        window.addEventListener("beforeunload", (event) => {
            if (!isSubmitting && initialDataJson !== formToJsonString()) {
                event.preventDefault();
                event.returnValue = "";
            }
        });
    }
});



========== staticfiles/admin/css/dark_mode.css ==========
@media (prefers-color-scheme: dark) {
    :root {
      --primary: #264b5d;
      --primary-fg: #f7f7f7;
  
      --body-fg: #eeeeee;
      --body-bg: #121212;
      --body-quiet-color: #d0d0d0;
      --body-medium-color: #e0e0e0;
      --body-loud-color: #ffffff;
  
      --breadcrumbs-link-fg: #e0e0e0;
      --breadcrumbs-bg: var(--primary);
  
      --link-fg: #81d4fa;
      --link-hover-color: #4ac1f7;
      --link-selected-fg: #6f94c6;
  
      --hairline-color: #272727;
      --border-color: #353535;
  
      --error-fg: #e35f5f;

      --message-debug-bg: #4e4e4e;
      --message-debug-icon: url(../img/icon-debug-dark.svg);
      --message-info-bg: #265895;
      --message-info-icon: url(../img/icon-info-dark.svg);
      --message-success-bg: #006b1b;
      --message-success-icon: url(../img/icon-yes-dark.svg);
      --message-warning-bg: #583305;
      --message-warning-icon: url(../img/icon-alert-dark.svg);
      --message-error-bg: #570808;
      --message-error-icon: url(../img/icon-no-dark.svg);
  
      --darkened-bg: #212121;
      --selected-bg: #1b1b1b;
      --selected-row: #00363a;
  
      --close-button-bg: #333333;
      --close-button-hover-bg: #666666;

      color-scheme: dark;
    }
  }


html[data-theme="dark"] {
    --primary: #264b5d;
    --primary-fg: #f7f7f7;

    --body-fg: #eeeeee;
    --body-bg: #121212;
    --body-quiet-color: #d0d0d0;
    --body-medium-color: #e0e0e0;
    --body-loud-color: #ffffff;

    --breadcrumbs-link-fg: #e0e0e0;
    --breadcrumbs-bg: var(--primary);

    --link-fg: #81d4fa;
    --link-hover-color: #4ac1f7;
    --link-selected-fg: #6f94c6;

    --hairline-color: #272727;
    --border-color: #353535;

    --error-fg: #e35f5f;

    --message-debug-bg: #4e4e4e;
    --message-debug-icon: url(../img/icon-debug-dark.svg);
    --message-info-bg: #265895;
    --message-info-icon: url(../img/icon-info-dark.svg);
    --message-success-bg: #006b1b;
    --message-success-icon: url(../img/icon-yes-dark.svg);
    --message-warning-bg: #583305;
    --message-warning-icon: url(../img/icon-alert-dark.svg);
    --message-error-bg: #570808;
    --message-error-icon: url(../img/icon-no-dark.svg);

    --darkened-bg: #212121;
    --selected-bg: #1b1b1b;
    --selected-row: #00363a;

    --close-button-bg: #333333;
    --close-button-hover-bg: #666666;

    color-scheme: dark;
}

/* THEME SWITCH */
.theme-toggle {
    cursor: pointer;
    border: none;
    padding: 0;
    background: transparent;
    vertical-align: middle;
    margin-inline-start: 5px;
    margin-top: -1px;
}

.theme-toggle svg {
    vertical-align: middle;
    height: 1.5rem;
    width: 1.5rem;
    display: none;
}

/*
Fully hide screen reader text so we only show the one matching the current
theme.
*/
.theme-toggle .visually-hidden {
    display: none;
}

html[data-theme="auto"] .theme-toggle .theme-label-when-auto {
    display: block;
}

html[data-theme="dark"] .theme-toggle .theme-label-when-dark {
    display: block;
}

html[data-theme="light"] .theme-toggle .theme-label-when-light {
    display: block;
}

/* ICONS */
.theme-toggle svg.theme-icon-when-auto,
.theme-toggle svg.theme-icon-when-dark,
.theme-toggle svg.theme-icon-when-light {
    fill: var(--header-link-color);
    color: var(--header-bg);
}

html[data-theme="auto"] .theme-toggle svg.theme-icon-when-auto {
    display: block;
}

html[data-theme="dark"] .theme-toggle svg.theme-icon-when-dark {
    display: block;
}

html[data-theme="light"] .theme-toggle svg.theme-icon-when-light {
    display: block;
}



========== staticfiles/admin/css/changelists.css ==========
/* CHANGELISTS */

#changelist .changelist-form-container {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    width: 100%;
}

#changelist .changelist-form-container > div {
    flex: 1 1 auto;
}

#changelist .changelist-form-container:not(:has(#changelist-filter)) > div {
    width: 100%;
}

#changelist .changelist-form-container:has(#changelist-filter) > div {
    max-width: calc(100% - 270px);
}

#changelist table {
    width: 100%;
}

.change-list .hiddenfields { display:none; }

.change-list .filtered table {
    border-right: none;
}

.change-list .filtered {
    min-height: 400px;
}

.change-list .filtered .results, .filtered #toolbar,
.filtered div.xfull {
    width: auto;
}

.change-list .filtered table tbody th {
    padding-right: 1em;
}

#changelist-form .results {
    overflow-x: auto;
    width: 100%;
}

#changelist .toplinks {
    border-bottom: 1px solid var(--hairline-color);
}

#changelist .changelist-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    border-top: 1px solid var(--hairline-color);
    border-bottom: 1px solid var(--hairline-color);
}

#changelist .changelist-footer .paginator {
    color: var(--body-quiet-color);
    background: var(--body-bg);
    border: none;
    padding: 0;
}

#changelist .paginator {
    color: var(--body-quiet-color);
    border-bottom: 1px solid var(--hairline-color);
    background: var(--body-bg);
}

#changelist .paginator ul {
    padding: 0;
    white-space: nowrap;
}

/* CHANGELIST TABLES */

#changelist table thead th {
    padding: 0;
    white-space: nowrap;
    vertical-align: middle;
}

#changelist table thead th.action-checkbox-column {
    width: 1.5em;
    text-align: center;
}

#changelist table tbody td.action-checkbox {
    text-align: center;
}

#changelist table tfoot {
    color: var(--body-quiet-color);
}

/* TOOLBAR */

#toolbar {
    padding: 8px 10px;
    margin-bottom: 15px;
    border-top: 1px solid var(--hairline-color);
    border-bottom: 1px solid var(--hairline-color);
    background: var(--darkened-bg);
    color: var(--body-quiet-color);
}

#toolbar form input {
    border-radius: 4px;
    font-size: 0.875rem;
    padding: 5px;
    color: var(--body-fg);
}

#toolbar #searchbar {
    height: 1.1875rem;
    border: 1px solid var(--border-color);
    padding: 2px 5px;
    margin: 0;
    vertical-align: top;
    font-size: 0.8125rem;
    max-width: 100%;
}

#toolbar #searchbar:focus {
    border-color: var(--body-quiet-color);
}

#toolbar form input[type="submit"] {
    border: 1px solid var(--border-color);
    font-size: 0.8125rem;
    padding: 4px 8px;
    margin: 0;
    vertical-align: middle;
    background: var(--body-bg);
    box-shadow: 0 -15px 20px -10px rgba(0, 0, 0, 0.15) inset;
    cursor: pointer;
    color: var(--body-fg);
}

#toolbar form input[type="submit"]:focus,
#toolbar form input[type="submit"]:hover {
    border-color: var(--body-quiet-color);
}

#changelist-search img {
    vertical-align: middle;
    margin-right: 4px;
}

#changelist-search .help {
    word-break: break-word;
}

/* FILTER COLUMN */

#changelist-filter {
    flex: 0 0 240px;
    order: 1;
    background: var(--darkened-bg);
    border-left: none;
    margin: 0 0 0 30px;
}

@media (forced-colors: active) {
  #changelist-filter {
      border: 1px solid;
  }
}

#changelist-filter h2 {
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 5px 15px;
    margin-bottom: 12px;
    border-bottom: none;
}

#changelist-filter h3,
#changelist-filter details summary {
    font-weight: 400;
    padding: 0 15px;
    margin-bottom: 10px;
}

#changelist-filter details summary > * {
    display: inline;
}

#changelist-filter details > summary {
    list-style-type: none;
}

#changelist-filter details > summary::-webkit-details-marker {
    display: none;
}

#changelist-filter details > summary::before {
    content: '→';
    font-weight: bold;
    color: var(--link-hover-color);
}

#changelist-filter details[open] > summary::before {
    content: '↓';
}

#changelist-filter ul {
    margin: 5px 0;
    padding: 0 15px 15px;
    border-bottom: 1px solid var(--hairline-color);
}

#changelist-filter ul:last-child {
    border-bottom: none;
}

#changelist-filter li {
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
}

#changelist-filter a {
    display: block;
    color: var(--body-quiet-color);
    word-break: break-word;
}

#changelist-filter li.selected {
    border-left: 5px solid var(--hairline-color);
    padding-left: 10px;
    margin-left: -15px;
}

#changelist-filter li.selected a {
    color: var(--link-selected-fg);
}

#changelist-filter a:focus, #changelist-filter a:hover,
#changelist-filter li.selected a:focus,
#changelist-filter li.selected a:hover {
    color: var(--link-hover-color);
}

#changelist-filter #changelist-filter-extra-actions {
    font-size: 0.8125rem;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--hairline-color);
}

/* DATE DRILLDOWN */

.change-list .toplinks {
    display: flex;
    padding-bottom: 5px;
    flex-wrap: wrap;
    gap: 3px 17px;
    font-weight: bold;
}

.change-list .toplinks a {
    font-size: 0.8125rem;
}

.change-list .toplinks .date-back {
    color: var(--body-quiet-color);
}

.change-list .toplinks .date-back:focus,
.change-list .toplinks .date-back:hover {
    color: var(--link-hover-color);
}

/* ACTIONS */

.filtered .actions {
    border-right: none;
}

#changelist table input {
    margin: 0;
    vertical-align: baseline;
}

/* Once the :has() pseudo-class is supported by all browsers, the tr.selected
   selector and the JS adding the class can be removed. */
#changelist tbody tr.selected {
    background-color: var(--selected-row);
}

#changelist tbody tr:has(.action-select:checked) {
    background-color: var(--selected-row);
}

@media (forced-colors: active) {
    #changelist tbody tr.selected {
        background-color: SelectedItem;
    }
    #changelist tbody tr:has(.action-select:checked) {
        background-color: SelectedItem;
    }
}

#changelist .actions {
    padding: 10px;
    background: var(--body-bg);
    border-top: none;
    border-bottom: none;
    line-height: 1.5rem;
    color: var(--body-quiet-color);
    width: 100%;
}

#changelist .actions span.all,
#changelist .actions span.action-counter,
#changelist .actions span.clear,
#changelist .actions span.question {
    font-size: 0.8125rem;
    margin: 0 0.5em;
}

#changelist .actions:last-child {
    border-bottom: none;
}

#changelist .actions select {
    vertical-align: top;
    height: 1.5rem;
    color: var(--body-fg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.875rem;
    padding: 0 0 0 4px;
    margin: 0;
    margin-left: 10px;
}

#changelist .actions select:focus {
    border-color: var(--body-quiet-color);
}

#changelist .actions label {
    display: inline-block;
    vertical-align: middle;
    font-size: 0.8125rem;
}

#changelist .actions .button {
    font-size: 0.8125rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--body-bg);
    box-shadow: 0 -15px 20px -10px rgba(0, 0, 0, 0.15) inset;
    cursor: pointer;
    height: 1.5rem;
    line-height: 1;
    padding: 4px 8px;
    margin: 0;
    color: var(--body-fg);
}

#changelist .actions .button:focus, #changelist .actions .button:hover {
    border-color: var(--body-quiet-color);
}



========== staticfiles/admin/css/base.css ==========
/*
    DJANGO Admin styles
*/

/* VARIABLE DEFINITIONS */
html[data-theme="light"],
:root {
    --primary: #79aec8;
    --secondary: #417690;
    --accent: #f5dd5d;
    --primary-fg: #fff;

    --body-fg: #333;
    --body-bg: #fff;
    --body-quiet-color: #666;
    --body-medium-color: #444;
    --body-loud-color: #000;

    --header-color: #ffc;
    --header-branding-color: var(--accent);
    --header-bg: var(--secondary);
    --header-link-color: var(--primary-fg);

    --breadcrumbs-fg: #c4dce8;
    --breadcrumbs-link-fg: var(--body-bg);
    --breadcrumbs-bg: #264b5d;

    --link-fg: #417893;
    --link-hover-color: #036;
    --link-selected-fg: var(--secondary);

    --hairline-color: #e8e8e8;
    --border-color: #ccc;

    --error-fg: #ba2121;

    --message-debug-bg: #efefef;
    --message-debug-icon: url(../img/icon-debug.svg);
    --message-info-bg: #ccefff;
    --message-info-icon: url(../img/icon-info.svg);
    --message-success-bg: #dfd;
    --message-success-icon: url(../img/icon-yes.svg);
    --message-warning-bg: #ffc;
    --message-warning-icon: url(../img/icon-alert.svg);
    --message-error-bg: #ffefef;
    --message-error-icon: url(../img/icon-no.svg);

    --darkened-bg: #f8f8f8; /* A bit darker than --body-bg */
    --selected-bg: #e4e4e4; /* E.g. selected table cells */
    --selected-row: #ffc;

    --button-fg: #fff;
    --button-bg: var(--secondary);
    --button-hover-bg: #205067;
    --default-button-bg: #205067;
    --default-button-hover-bg: var(--secondary);
    --close-button-bg: #747474;
    --close-button-hover-bg: #333;
    --delete-button-bg: #ba2121;
    --delete-button-hover-bg: #a41515;

    --object-tools-fg: var(--button-fg);
    --object-tools-bg: var(--close-button-bg);
    --object-tools-hover-bg: var(--close-button-hover-bg);

    --font-family-primary:
        "Segoe UI",
        system-ui,
        Roboto,
        "Helvetica Neue",
        Arial,
        sans-serif,
        "Apple Color Emoji",
        "Segoe UI Emoji",
        "Segoe UI Symbol",
        "Noto Color Emoji";
    --font-family-monospace:
        ui-monospace,
        Menlo,
        Monaco,
        "Cascadia Mono",
        "Segoe UI Mono",
        "Roboto Mono",
        "Oxygen Mono",
        "Ubuntu Monospace",
        "Source Code Pro",
        "Fira Mono",
        "Droid Sans Mono",
        "Courier New",
        monospace,
        "Apple Color Emoji",
        "Segoe UI Emoji",
        "Segoe UI Symbol",
        "Noto Color Emoji";

    color-scheme: light;
}

html, body {
    height: 100%;
}

body {
    margin: 0;
    padding: 0;
    font-size: 0.875rem;
    font-family: var(--font-family-primary);
    color: var(--body-fg);
    background: var(--body-bg);
}

/* LINKS */

a:link, a:visited {
    color: var(--link-fg);
    text-decoration: none;
    transition: color 0.15s, background 0.15s;
}

a:focus, a:hover {
    color: var(--link-hover-color);
}

a:focus {
    text-decoration: underline;
}

a:not(
    [role="button"],
    #header a,
    #nav-sidebar a,
    #content-main.app-list a,
    .object-tools a
) {
    text-decoration: underline;
}

a img {
    border: none;
}

a.section:link, a.section:visited {
    color: var(--header-link-color);
    text-decoration: none;
}

a.section:focus, a.section:hover {
    text-decoration: underline;
}

/* GLOBAL DEFAULTS */

p, ol, ul, dl {
    margin: .2em 0 .8em 0;
}

p {
    padding: 0;
    line-height: 140%;
}

h1,h2,h3,h4,h5 {
    font-weight: bold;
}

h1 {
    margin: 0 0 20px;
    font-weight: 300;
    font-size: 1.25rem;
}

h2 {
    font-size: 1rem;
    margin: 1em 0 .5em 0;
}

h2.subhead {
    font-weight: normal;
    margin-top: 0;
}

h3 {
    font-size: 0.875rem;
    margin: .8em 0 .3em 0;
    color: var(--body-medium-color);
    font-weight: bold;
}

h4 {
    font-size: 0.75rem;
    margin: 1em 0 .8em 0;
    padding-bottom: 3px;
    color: var(--body-medium-color);
}

h5 {
    font-size: 0.625rem;
    margin: 1.5em 0 .5em 0;
    color: var(--body-quiet-color);
    text-transform: uppercase;
    letter-spacing: 1px;
}

ul > li {
    list-style-type: square;
    padding: 1px 0;
}

li ul {
    margin-bottom: 0;
}

li, dt, dd {
    font-size: 0.8125rem;
    line-height: 1.25rem;
}

dt {
    font-weight: bold;
    margin-top: 4px;
}

dd {
    margin-left: 0;
}

form {
    margin: 0;
    padding: 0;
}

fieldset {
    margin: 0;
    min-width: 0;
    padding: 0;
    border: none;
    border-top: 1px solid var(--hairline-color);
}

details summary {
    cursor: pointer;
}

blockquote {
    font-size: 0.6875rem;
    color: var(--body-quiet-color);
    margin-left: 2px;
    padding-left: 10px;
    border-left: 5px solid currentColor;
}

code, pre {
    font-family: var(--font-family-monospace);
    color: var(--body-quiet-color);
    font-size: 0.75rem;
    overflow-x: auto;
}

pre.literal-block {
    margin: 10px;
    background: var(--darkened-bg);
    padding: 6px 8px;
}

code strong {
    color: #930;
}

hr {
    clear: both;
    color: var(--hairline-color);
    background-color: var(--hairline-color);
    height: 1px;
    border: none;
    margin: 0;
    padding: 0;
    line-height: 1px;
}

/* TEXT STYLES & MODIFIERS */

.small {
    font-size: 0.6875rem;
}

.mini {
    font-size: 0.625rem;
}

.help, p.help, form p.help, div.help, form div.help, div.help li {
    font-size: 0.6875rem;
    color: var(--body-quiet-color);
}

div.help ul {
     margin-bottom: 0;
}

.help-tooltip {
    cursor: help;
}

p img, h1 img, h2 img, h3 img, h4 img, td img {
    vertical-align: middle;
}

.quiet, a.quiet:link, a.quiet:visited {
    color: var(--body-quiet-color);
    font-weight: normal;
}

.clear {
    clear: both;
}

.nowrap {
    white-space: nowrap;
}

.hidden {
    display: none !important;
}

/* TABLES */

table {
    border-collapse: collapse;
    border-color: var(--border-color);
}

td, th {
    font-size: 0.8125rem;
    line-height: 1rem;
    border-bottom: 1px solid var(--hairline-color);
    vertical-align: top;
    padding: 8px;
}

th {
    font-weight: 500;
    text-align: left;
}

thead th,
tfoot td {
    color: var(--body-quiet-color);
    padding: 5px 10px;
    font-size: 0.6875rem;
    background: var(--body-bg);
    border: none;
    border-top: 1px solid var(--hairline-color);
    border-bottom: 1px solid var(--hairline-color);
}

tfoot td {
    border-bottom: none;
    border-top: 1px solid var(--hairline-color);
}

thead th.required {
    font-weight: bold;
}

tr.alt {
    background: var(--darkened-bg);
}

tr:nth-child(odd), .row-form-errors {
    background: var(--body-bg);
}

tr:nth-child(even),
tr:nth-child(even) .errorlist,
tr:nth-child(odd) + .row-form-errors,
tr:nth-child(odd) + .row-form-errors .errorlist {
    background: var(--darkened-bg);
}

/* SORTABLE TABLES */

thead th {
    padding: 5px 10px;
    line-height: normal;
    text-transform: uppercase;
    background: var(--darkened-bg);
}

thead th a:link, thead th a:visited {
    color: var(--body-quiet-color);
}

thead th.sorted {
    background: var(--selected-bg);
}

thead th.sorted .text {
    padding-right: 42px;
}

table thead th .text span {
    padding: 8px 10px;
    display: block;
}

table thead th .text a {
    display: block;
    cursor: pointer;
    padding: 8px 10px;
}

table thead th .text a:focus, table thead th .text a:hover {
    background: var(--selected-bg);
}

thead th.sorted a.sortremove {
    visibility: hidden;
}

table thead th.sorted:hover a.sortremove {
    visibility: visible;
}

table thead th.sorted .sortoptions {
    display: block;
    padding: 9px 5px 0 5px;
    float: right;
    text-align: right;
}

table thead th.sorted .sortpriority {
    font-size: .8em;
    min-width: 12px;
    text-align: center;
    vertical-align: 3px;
    margin-left: 2px;
    margin-right: 2px;
}

table thead th.sorted .sortoptions a {
    position: relative;
    width: 14px;
    height: 14px;
    display: inline-block;
    background: url(../img/sorting-icons.svg) 0 0 no-repeat;
    background-size: 14px auto;
}

table thead th.sorted .sortoptions a.sortremove {
    background-position: 0 0;
}

table thead th.sorted .sortoptions a.sortremove:after {
    content: '\\';
    position: absolute;
    top: -6px;
    left: 3px;
    font-weight: 200;
    font-size: 1.125rem;
    color: var(--body-quiet-color);
}

table thead th.sorted .sortoptions a.sortremove:focus:after,
table thead th.sorted .sortoptions a.sortremove:hover:after {
    color: var(--link-fg);
}

table thead th.sorted .sortoptions a.sortremove:focus,
table thead th.sorted .sortoptions a.sortremove:hover {
    background-position: 0 -14px;
}

table thead th.sorted .sortoptions a.ascending {
    background-position: 0 -28px;
}

table thead th.sorted .sortoptions a.ascending:focus,
table thead th.sorted .sortoptions a.ascending:hover {
    background-position: 0 -42px;
}

table thead th.sorted .sortoptions a.descending {
    top: 1px;
    background-position: 0 -56px;
}

table thead th.sorted .sortoptions a.descending:focus,
table thead th.sorted .sortoptions a.descending:hover {
    background-position: 0 -70px;
}

/* FORM DEFAULTS */

input, textarea, select, .form-row p, form .button {
    margin: 2px 0;
    padding: 2px 3px;
    vertical-align: middle;
    font-family: var(--font-family-primary);
    font-weight: normal;
    font-size: 0.8125rem;
}
.form-row div.help {
    padding: 2px 3px;
}

textarea {
    vertical-align: top;
}

/*
Minifiers remove the default (text) "type" attribute from "input" HTML tags.
Add input:not([type]) to make the CSS stylesheet work the same.
*/
input:not([type]), input[type=text], input[type=password], input[type=email],
input[type=url], input[type=number], input[type=tel], textarea, select,
.vTextField {
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 5px 6px;
    margin-top: 0;
    color: var(--body-fg);
    background-color: var(--body-bg);
}

/*
Minifiers remove the default (text) "type" attribute from "input" HTML tags.
Add input:not([type]) to make the CSS stylesheet work the same.
*/
input:not([type]):focus, input[type=text]:focus, input[type=password]:focus,
input[type=email]:focus, input[type=url]:focus, input[type=number]:focus,
input[type=tel]:focus, textarea:focus, select:focus, .vTextField:focus {
    border-color: var(--body-quiet-color);
}

select {
    height: 1.875rem;
}

select[multiple] {
    /* Allow HTML size attribute to override the height in the rule above. */
    height: auto;
    min-height: 150px;
}

/* FORM BUTTONS */

.button, input[type=submit], input[type=button], .submit-row input, a.button {
    background: var(--button-bg);
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    color: var(--button-fg);
    cursor: pointer;
    transition: background 0.15s;
}

a.button {
    padding: 4px 5px;
}

.button:active, input[type=submit]:active, input[type=button]:active,
.button:focus, input[type=submit]:focus, input[type=button]:focus,
.button:hover, input[type=submit]:hover, input[type=button]:hover {
    background: var(--button-hover-bg);
}

.button[disabled], input[type=submit][disabled], input[type=button][disabled] {
    opacity: 0.4;
}

.button.default, input[type=submit].default, .submit-row input.default {
    border: none;
    font-weight: 400;
    background: var(--default-button-bg);
}

.button.default:active, input[type=submit].default:active,
.button.default:focus, input[type=submit].default:focus,
.button.default:hover, input[type=submit].default:hover {
    background: var(--default-button-hover-bg);
}

.button[disabled].default,
input[type=submit][disabled].default,
input[type=button][disabled].default {
    opacity: 0.4;
}


/* MODULES */

.module {
    border: none;
    margin-bottom: 30px;
    background: var(--body-bg);
}

.module p, .module ul, .module h3, .module h4, .module dl, .module pre {
    padding-left: 10px;
    padding-right: 10px;
}

.module blockquote {
    margin-left: 12px;
}

.module ul, .module ol {
    margin-left: 1.5em;
}

.module h3 {
    margin-top: .6em;
}

.module h2, .module caption, .inline-group h2 {
    margin: 0;
    padding: 8px;
    font-weight: 400;
    font-size: 0.8125rem;
    text-align: left;
    background: var(--header-bg);
    color: var(--header-link-color);
}

.module caption,
.inline-group h2 {
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.module table {
    border-collapse: collapse;
}

/* MESSAGES & ERRORS */

ul.messagelist {
    padding: 0;
    margin: 0;
}

ul.messagelist li {
    display: block;
    font-weight: 400;
    font-size: 0.8125rem;
    padding: 10px 10px 10px 65px;
    margin: 0 0 10px 0;
    color: var(--body-fg);
    word-break: break-word;
    background-color: var(--message-info-bg);
    background-image: var(--message-info-icon);
    background-position: 40px 12px;
    background-repeat: no-repeat;
    background-size: 16px auto;
}

ul.messagelist li.debug {
    background-color: var(--message-debug-bg);
    background-image: var(--message-debug-icon);
}

ul.messagelist li.info {
    background-color: var(--message-info-bg);
    background-image: var(--message-info-icon);
}

ul.messagelist li.success {
    background-color: var(--message-success-bg);
    background-image: var(--message-success-icon);
}

ul.messagelist li.warning {
    background-color: var(--message-warning-bg);
    background-image: var(--message-warning-icon);
}

ul.messagelist li.error {
    background-color: var(--message-error-bg);
    background-image: var(--message-error-icon);
}

@media (forced-colors: active) {
  ul.messagelist li {
      border: 1px solid;
  }
}

.errornote {
    font-size: 0.875rem;
    font-weight: 700;
    display: block;
    padding: 10px 12px;
    margin: 0 0 10px 0;
    color: var(--error-fg);
    border: 1px solid var(--error-fg);
    border-radius: 4px;
    background-color: var(--body-bg);
    background-position: 5px 12px;
    overflow-wrap: break-word;
}

ul.errorlist {
    margin: 0 0 4px;
    padding: 0;
    color: var(--error-fg);
    background: var(--body-bg);
}

ul.errorlist li {
    font-size: 0.8125rem;
    display: block;
    margin-bottom: 4px;
    overflow-wrap: break-word;
}

ul.errorlist li:first-child {
    margin-top: 0;
}

ul.errorlist li a {
    color: inherit;
    text-decoration: underline;
}

td ul.errorlist {
    margin: 0;
    padding: 0;
}

td ul.errorlist li {
    margin: 0;
}

.form-row.errors {
    margin: 0;
    border: none;
    border-bottom: 1px solid var(--hairline-color);
    background: none;
}

.form-row.errors ul.errorlist li {
    padding-left: 0;
}

.errors input, .errors select, .errors textarea,
td ul.errorlist + input, td ul.errorlist + select, td ul.errorlist + textarea {
    border: 1px solid var(--error-fg);
}

.description {
    font-size: 0.75rem;
    padding: 5px 0 0 12px;
}

/* BREADCRUMBS */

div.breadcrumbs {
    background: var(--breadcrumbs-bg);
    padding: 10px 40px;
    border: none;
    color: var(--breadcrumbs-fg);
    text-align: left;
}

div.breadcrumbs a {
    color: var(--breadcrumbs-link-fg);
}

div.breadcrumbs a:focus, div.breadcrumbs a:hover {
    color: var(--breadcrumbs-fg);
}

/* ACTION ICONS */

.viewlink, .inlineviewlink {
    padding-left: 16px;
    background: url(../img/icon-viewlink.svg) 0 1px no-repeat;
}

.hidelink {
    padding-left: 16px;
    background: url(../img/icon-hidelink.svg) 0 1px no-repeat;
}

.addlink {
    padding-left: 16px;
    background: url(../img/icon-addlink.svg) 0 1px no-repeat;
}

.changelink, .inlinechangelink {
    padding-left: 16px;
    background: url(../img/icon-changelink.svg) 0 1px no-repeat;
}

.deletelink {
    padding-left: 16px;
    background: url(../img/icon-deletelink.svg) 0 1px no-repeat;
}

a.deletelink:link, a.deletelink:visited {
    color: #CC3434; /* XXX Probably unused? */
}

a.deletelink:focus, a.deletelink:hover {
    color: #993333; /* XXX Probably unused? */
    text-decoration: none;
}

/* OBJECT TOOLS */

.object-tools {
    padding: 0;
    overflow: hidden;
    text-align: right;
    margin: 0 0 15px;
}

.object-tools li {
    display: inline-block;
    height: auto;
}

.object-tools li + li {
    margin-left: 15px;
}

.object-tools a {
    border-radius: 15px;
}

.object-tools a:link, .object-tools a:visited {
    display: block;
    float: left;
    padding: 3px 12px;
    background: var(--object-tools-bg);
    color: var(--object-tools-fg);
    font-weight: 400;
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.object-tools a:focus, .object-tools a:hover {
    background-color: var(--object-tools-hover-bg);
}

.object-tools a:focus{
    text-decoration: none;
}

.object-tools a.viewsitelink, .object-tools a.addlink {
    background-repeat: no-repeat;
    background-position: right 7px center;
    padding-right: 26px;
}

.object-tools a.viewsitelink {
    background-image: url(../img/tooltag-arrowright.svg);
}

.object-tools a.addlink {
    background-image: url(../img/tooltag-add.svg);
}

/* OBJECT HISTORY */

#change-history table {
    width: 100%;
}

#change-history table tbody th {
    width: 16em;
}

#change-history .paginator {
    color: var(--body-quiet-color);
    border-bottom: 1px solid var(--hairline-color);
    background: var(--body-bg);
    overflow: hidden;
}

/* PAGE STRUCTURE */

#container {
    position: relative;
    width: 100%;
    min-width: 980px;
    padding: 0;
    display: flex;
    flex-direction: column;
    height: 100%;
}

#container > .main {
    display: flex;
    flex: 1 0 auto;
}

.main > .content {
    flex:  1 0;
    max-width: 100%;
}

.skip-to-content-link {
    position: absolute;
    top: -999px;
    margin: 5px;
    padding: 5px;
    background: var(--body-bg);
    z-index: 1;
}

.skip-to-content-link:focus {
    left: 0px;
    top: 0px;
}

#content {
    padding: 20px 40px;
}

.dashboard #content {
    width: 600px;
}

#content-main {
    float: left;
    width: 100%;
}

#content-related {
    float: right;
    width: 260px;
    position: relative;
    margin-right: -300px;
}

@media (forced-colors: active) {
  #content-related {
      border: 1px solid;
  }
}

/* COLUMN TYPES */

.colMS {
    margin-right: 300px;
}

.colSM {
    margin-left: 300px;
}

.colSM #content-related {
    float: left;
    margin-right: 0;
    margin-left: -300px;
}

.colSM #content-main {
    float: right;
}

.popup .colM {
    width: auto;
}

/* HEADER */

#header {
    width: auto;
    height: auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 40px;
    background: var(--header-bg);
    color: var(--header-color);
}

#header a:link, #header a:visited, #logout-form button {
    color: var(--header-link-color);
}

#header a:focus , #header a:hover {
    text-decoration: underline;
}

@media (forced-colors: active) {
  #header {
      border-bottom: 1px solid;
  }
}

#branding {
    display: flex;
}

#site-name {
    padding: 0;
    margin: 0;
    margin-inline-end: 20px;
    font-weight: 300;
    font-size: 1.5rem;
    color: var(--header-branding-color);
}

#site-name a:link, #site-name a:visited {
    color: var(--accent);
}

#branding h2 {
    padding: 0 10px;
    font-size: 0.875rem;
    margin: -8px 0 8px 0;
    font-weight: normal;
    color: var(--header-color);
}

#branding a:hover {
    text-decoration: none;
}

#logout-form {
    display: inline;
}

#logout-form button {
    background: none;
    border: 0;
    cursor: pointer;
    font-family: var(--font-family-primary);
}

#user-tools {
    float: right;
    margin: 0 0 0 20px;
    text-align: right;
}

#user-tools, #logout-form button{
    padding: 0;
    font-weight: 300;
    font-size: 0.6875rem;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

#user-tools a, #logout-form button {
    border-bottom: 1px solid rgba(255, 255, 255, 0.25);
}

#user-tools a:focus, #user-tools a:hover,
#logout-form button:active, #logout-form button:hover {
    text-decoration: none;
    border-bottom: 0;
}

#logout-form button:active, #logout-form button:hover {
    margin-bottom: 1px;
}

/* SIDEBAR */

#content-related {
    background: var(--darkened-bg);
}

#content-related .module {
    background: none;
}

#content-related h3 {
    color: var(--body-quiet-color);
    padding: 0 16px;
    margin: 0 0 16px;
}

#content-related h4 {
    font-size: 0.8125rem;
}

#content-related p {
    padding-left: 16px;
    padding-right: 16px;
}

#content-related .actionlist {
    padding: 0;
    margin: 16px;
}

#content-related .actionlist li {
    line-height: 1.2;
    margin-bottom: 10px;
    padding-left: 18px;
}

#content-related .module h2 {
    background: none;
    padding: 16px;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--hairline-color);
    font-size: 1.125rem;
    color: var(--body-fg);
}

.delete-confirmation form input[type="submit"] {
    background: var(--delete-button-bg);
    border-radius: 4px;
    padding: 10px 15px;
    color: var(--button-fg);
}

.delete-confirmation form input[type="submit"]:active,
.delete-confirmation form input[type="submit"]:focus,
.delete-confirmation form input[type="submit"]:hover {
    background: var(--delete-button-hover-bg);
}

.delete-confirmation form .cancel-link {
    display: inline-block;
    vertical-align: middle;
    height: 0.9375rem;
    line-height: 0.9375rem;
    border-radius: 4px;
    padding: 10px 15px;
    color: var(--button-fg);
    background: var(--close-button-bg);
    margin: 0 0 0 10px;
}

.delete-confirmation form .cancel-link:active,
.delete-confirmation form .cancel-link:focus,
.delete-confirmation form .cancel-link:hover {
    background: var(--close-button-hover-bg);
}

/* POPUP */
.popup #content {
    padding: 20px;
}

.popup #container {
    min-width: 0;
}

.popup #header {
    padding: 10px 20px;
}

/* PAGINATOR */

.paginator {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.8125rem;
    padding-top: 10px;
    padding-bottom: 10px;
    line-height: 22px;
    margin: 0;
    border-top: 1px solid var(--hairline-color);
    box-sizing: border-box;
}

.paginator ul {
    margin: 0;
    margin-right: 6px;
}

.paginator ul li {
    display: inline-block;
    line-height: 22px;
    padding: 0;
}

.paginator a {
    display: inline-block;
    padding: 2px 6px;
}

.paginator a:not(.showall) {
    background: var(--button-bg);
    text-decoration: none;
    color: var(--button-fg);
}

.paginator a[aria-current="page"] {
    color: var(--body-quiet-color);
    background: transparent;
    font-weight: bold;
    cursor: default;
}

.paginator a:not([aria-current="page"], .showall):focus,
.paginator a:not([aria-current="page"], .showall):hover {
    color: white;
    background: var(--link-hover-color);
}

.paginator input {
    margin-left: auto;
}

.base-svgs {
    display: none;
}

.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border: 0;
    color: var(--body-fg);
    background-color: var(--body-bg);
}



========== staticfiles/admin/css/login.css ==========
/* LOGIN FORM */

.login {
    background: var(--darkened-bg);
    height: auto;
}

.login #header {
    height: auto;
    padding: 15px 16px;
    justify-content: center;
}

.login #header h1 {
    font-size: 1.125rem;
    margin: 0;
}

.login #header h1 a {
    color: var(--header-link-color);
}

.login #content {
    padding: 20px;
}

.login #container {
    background: var(--body-bg);
    border: 1px solid var(--hairline-color);
    border-radius: 4px;
    overflow: hidden;
    width: 28em;
    min-width: 300px;
    margin: 100px auto;
    height: auto;
}

.login .form-row {
    padding: 4px 0;
}

.login .form-row label {
    display: block;
    line-height: 2em;
}

.login .form-row #id_username, .login .form-row #id_password {
    padding: 8px;
    width: 100%;
    box-sizing: border-box;
}

.login .submit-row {
    padding: 1em 0 0 0;
    margin: 0;
    text-align: center;
}

.login .password-reset-link {
    text-align: center;
}



========== staticfiles/admin/css/rtl.css ==========
/* GLOBAL */

th {
    text-align: right;
}

.module h2, .module caption {
    text-align: right;
}

.module ul, .module ol {
    margin-left: 0;
    margin-right: 1.5em;
}

.viewlink, .addlink, .changelink, .hidelink {
    padding-left: 0;
    padding-right: 16px;
    background-position: 100% 1px;
}

.deletelink {
    padding-left: 0;
    padding-right: 16px;
    background-position: 100% 1px;
}

.object-tools {
    text-align: left;
}

.object-tools li + li {
    margin-right: 15px;
    margin-left: 0;
}

thead th:first-child,
tfoot td:first-child {
    border-left: none;
}

/* LAYOUT */

#user-tools {
    right: auto;
    left: 0;
    text-align: left;
}

div.breadcrumbs {
    text-align: right;
}

#content-main {
    float: right;
}

#content-related {
    float: left;
    margin-left: -300px;
    margin-right: auto;
}

.colMS {
    margin-left: 300px;
    margin-right: 0;
}

/* SORTABLE TABLES */

table thead th.sorted .sortoptions {
   float: left;
}

thead th.sorted .text {
    padding-right: 0;
    padding-left: 42px;
}

/* dashboard styles */

.dashboard .module table td a {
    padding-left: .6em;
    padding-right: 16px;
}

/* changelists styles */

.change-list .filtered table {
    border-left: none;
    border-right: 0px none;
}

#changelist-filter {
    border-left: none;
    border-right: none;
    margin-left: 0;
    margin-right: 30px;
}

#changelist-filter li.selected {
    border-left: none;
    padding-left: 10px;
    margin-left: 0;
    border-right: 5px solid var(--hairline-color);
    padding-right: 10px;
    margin-right: -15px;
}

#changelist table tbody td:first-child, #changelist table tbody th:first-child {
    border-right: none;
    border-left: none;
}

.paginator ul {
    margin-left: 6px;
    margin-right: 0;
}

.paginator input {
    margin-left: 0;
    margin-right: auto;
}

/* FORMS */

.aligned label {
    padding: 0 0 3px 1em;
}

.submit-row a.deletelink {
    margin-left: 0;
    margin-right: auto;
}

.vDateField, .vTimeField {
    margin-left: 2px;
}

.aligned .form-row input {
    margin-left: 5px;
}

form .aligned ul {
    margin-right: 163px;
    padding-right: 10px;
    margin-left: 0;
    padding-left: 0;
}

form ul.inline li {
    float: right;
    padding-right: 0;
    padding-left: 7px;
}

form .aligned p.help,
form .aligned div.help {
    margin-left: 0;
    margin-right: 160px;
    padding-right: 10px;
}

form div.help ul,
form .aligned .checkbox-row + .help,
form .aligned p.date div.help.timezonewarning,
form .aligned p.datetime div.help.timezonewarning,
form .aligned p.time div.help.timezonewarning {
    margin-right: 0;
    padding-right: 0;
}

form .wide p.help,
form .wide ul.errorlist,
form .wide div.help {
    padding-left: 0;
    padding-right: 50px;
}

.submit-row {
    text-align: right;
}

fieldset .fieldBox {
    margin-left: 20px;
    margin-right: 0;
}

.errorlist li {
    background-position: 100% 12px;
    padding: 0;
}

.errornote {
    background-position: 100% 12px;
    padding: 10px 12px;
}

/* WIDGETS */

.calendarnav-previous {
    top: 0;
    left: auto;
    right: 10px;
    background: url(../img/calendar-icons.svg) 0 -15px no-repeat;
}

.calendarnav-next {
    top: 0;
    right: auto;
    left: 10px;
    background: url(../img/calendar-icons.svg) 0 0 no-repeat;
}

.calendar caption, .calendarbox h2 {
    text-align: center;
}

.selector {
    float: right;
}

.selector .selector-filter {
    text-align: right;
}

.selector-add {
    background: url(../img/selector-icons.svg) 0 -96px no-repeat;
    background-size: 24px auto;
}

:enabled.selector-add:focus, :enabled.selector-add:hover {
    background-position: 0 -120px;
}

.selector-remove {
    background: url(../img/selector-icons.svg) 0 -144px no-repeat;
    background-size: 24px auto;
}

:enabled.selector-remove:focus, :enabled.selector-remove:hover {
    background-position: 0 -168px;
}

:enabled.selector-chooseall:focus, :enabled.selector-chooseall:hover {
    background-position: 100% -144px;
}

:enabled.selector-clearall:focus, :enabled.selector-clearall:hover {
    background-position: 0 -176px;
}

.inline-deletelink {
    float: left;
}

form .form-row p.datetime {
    overflow: hidden;
}

.related-widget-wrapper {
    float: right;
}

/* MISC */

.inline-related h2, .inline-group h2 {
    text-align: right
}

.inline-related h3 span.delete {
    padding-right: 20px;
    padding-left: inherit;
    left: 10px;
    right: inherit;
    float:left;
}

.inline-related h3 span.delete label {
    margin-left: inherit;
    margin-right: 2px;
}

.inline-group .tabular td.original p {
    right: 0;
}

.selector .selector-chooser {
    margin: 0;
}

ul.messagelist li {
    padding: 10px 65px 10px 10px;
    background-position-x: calc(100% - 40px);
}



========== staticfiles/admin/css/unusable_password_field.css ==========
/* Hide warnings fields if usable password is selected */
form:has(#id_usable_password input[value="true"]:checked) .messagelist {
    display: none;
}

/* Hide password fields if unusable password is selected */
form:has(#id_usable_password input[value="false"]:checked) .field-password1,
form:has(#id_usable_password input[value="false"]:checked) .field-password2 {
    display: none;
}

/* Select appropriate submit button */
form:has(#id_usable_password input[value="true"]:checked) input[type="submit"].unset-password {
    display: none;
}

form:has(#id_usable_password input[value="false"]:checked) input[type="submit"].set-password {
    display: none;
}



========== staticfiles/admin/css/forms.css ==========
@import url('widgets.css');

/* FORM ROWS */

.form-row {
    overflow: hidden;
    padding: 10px;
    font-size: 0.8125rem;
    border-bottom: 1px solid var(--hairline-color);
}

.form-row img, .form-row input {
    vertical-align: middle;
}

.form-row label input[type="checkbox"] {
    margin-top: 0;
    vertical-align: 0;
}

form .form-row p {
    padding-left: 0;
}

.flex-container {
    display: flex;
}

.form-multiline {
    flex-wrap: wrap;
}

.form-multiline > div {
    padding-bottom: 10px;
}

/* FORM LABELS */

legend, label {
    font-weight: normal;
    color: var(--body-quiet-color);
    font-size: 0.8125rem;
}

.required legend, legend.required,
.required label, label.required {
    font-weight: bold;
}

/* RADIO BUTTONS */

form div.radiolist div {
    padding-right: 7px;
}

form div.radiolist.inline div {
    display: inline-block;
}

form div.radiolist label {
    width: auto;
}

form div.radiolist input[type="radio"] {
    margin: -2px 4px 0 0;
    padding: 0;
}

form ul.inline {
    margin-left: 0;
    padding: 0;
}

form ul.inline li {
    float: left;
    padding-right: 7px;
}

/* FIELDSETS */

fieldset .fieldset-heading,
fieldset .inline-heading,
:not(.inline-related) .collapse summary {
    border: 1px solid var(--header-bg);
    margin: 0;
    padding: 8px;
    font-weight: 400;
    font-size: 0.8125rem;
    background: var(--header-bg);
    color: var(--header-link-color);
}

/* ALIGNED FIELDSETS */

.aligned fieldset {
    width: 100%;
    border-top: none;
}

.aligned fieldset > div {
    width: 100%;
}

.aligned legend {
    float: left;
}

.aligned legend,
.aligned label {
    display: block;
    padding: 4px 10px 0 0;
    min-width: 160px;
    width: 160px;
    word-wrap: break-word;
}

.aligned label:not(.vCheckboxLabel):after {
    content: '';
    display: inline-block;
    vertical-align: middle;
}

.aligned label + p, .aligned .checkbox-row + div.help, .aligned label + div.readonly {
    padding: 6px 0;
    margin-top: 0;
    margin-bottom: 0;
    margin-left: 0;
    overflow-wrap: break-word;
}

.aligned ul label {
    display: inline;
    float: none;
    width: auto;
}

.aligned .form-row input {
    margin-bottom: 0;
}

.colMS .aligned .vLargeTextField, .colMS .aligned .vXMLLargeTextField {
    width: 350px;
}

form .aligned ul {
    margin-left: 160px;
    padding-left: 10px;
}

form .aligned div.radiolist {
    display: inline-block;
    margin: 0;
    padding: 0;
}

form .aligned fieldset div.help {
    margin-left: 0;
}

form .aligned p.help,
form .aligned div.help {
    margin-top: 0;
    margin-left: 160px;
    padding-left: 10px;
}

form .aligned p.date div.help.timezonewarning,
form .aligned p.datetime div.help.timezonewarning,
form .aligned p.time div.help.timezonewarning {
    margin-left: 0;
    padding-left: 0;
    font-weight: normal;
}

form .aligned p.help:last-child,
form .aligned div.help:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
}

form .aligned input + p.help,
form .aligned textarea + p.help,
form .aligned select + p.help,
form .aligned input + div.help,
form .aligned textarea + div.help,
form .aligned select + div.help {
    margin-left: 160px;
    padding-left: 10px;
}

form .aligned select option:checked {
    background-color: var(--selected-row);
}

form .aligned ul li {
    list-style: none;
}

form .aligned table p {
    margin-left: 0;
    padding-left: 0;
}

.aligned .vCheckboxLabel {
    padding: 1px 0 0 5px;
}

.aligned .vCheckboxLabel + p.help,
.aligned .vCheckboxLabel + div.help {
    margin-top: -4px;
}

.colM .aligned .vLargeTextField, .colM .aligned .vXMLLargeTextField {
    width: 610px;
}

fieldset .fieldBox {
    margin-right: 20px;
}

/* WIDE FIELDSETS */

.wide label {
    width: 200px;
}

form .wide p.help,
form .wide ul.errorlist,
form .wide div.help {
    padding-left: 50px;
}

form div.help ul {
    padding-left: 0;
    margin-left: 0;
}

.colM fieldset.wide .vLargeTextField, .colM fieldset.wide .vXMLLargeTextField {
    width: 450px;
}

/* COLLAPSIBLE FIELDSETS */

.collapse summary .fieldset-heading,
.collapse summary .inline-heading {
    background: transparent;
    border: none;
    color: currentColor;
    display: inline;
    margin: 0;
    padding: 0;
}

/* MONOSPACE TEXTAREAS */

fieldset.monospace textarea {
    font-family: var(--font-family-monospace);
}

/* SUBMIT ROW */

.submit-row {
    padding: 12px 14px 12px;
    margin: 0 0 20px;
    background: var(--darkened-bg);
    border: 1px solid var(--hairline-color);
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

body.popup .submit-row {
    overflow: auto;
}

.submit-row input {
    height: 2.1875rem;
    line-height: 0.9375rem;
}

.submit-row input, .submit-row a {
    margin: 0;
}

.submit-row input.default {
    text-transform: uppercase;
}

.submit-row a.deletelink {
    margin-left: auto;
}

.submit-row a.deletelink {
    display: block;
    background: var(--delete-button-bg);
    border-radius: 4px;
    padding: 0.625rem 0.9375rem;
    height: 0.9375rem;
    line-height: 0.9375rem;
    color: var(--button-fg);
}

.submit-row a.closelink {
    display: inline-block;
    background: var(--close-button-bg);
    border-radius: 4px;
    padding: 10px 15px;
    height: 0.9375rem;
    line-height: 0.9375rem;
    color: var(--button-fg);
}

.submit-row a.deletelink:focus,
.submit-row a.deletelink:hover,
.submit-row a.deletelink:active {
    background: var(--delete-button-hover-bg);
    text-decoration: none;
}

.submit-row a.closelink:focus,
.submit-row a.closelink:hover,
.submit-row a.closelink:active {
    background: var(--close-button-hover-bg);
    text-decoration: none;
}

/* CUSTOM FORM FIELDS */

.vSelectMultipleField {
    vertical-align: top;
}

.vCheckboxField {
    border: none;
}

.vDateField, .vTimeField {
    margin-right: 2px;
    margin-bottom: 4px;
}

.vDateField {
    min-width: 6.85em;
}

.vTimeField {
    min-width: 4.7em;
}

.vURLField {
    width: 30em;
}

.vLargeTextField, .vXMLLargeTextField {
    width: 48em;
}

.app-flatpages.model-flatpage #id_content {
    height: 40.2em;
}

.module table .vPositiveSmallIntegerField {
    width: 2.2em;
}

.vIntegerField {
    width: 5em;
}

.vBigIntegerField {
    width: 10em;
}

.vForeignKeyRawIdAdminField {
    width: 5em;
}

.vTextField, .vUUIDField {
    width: 20em;
}

/* INLINES */

.inline-group {
    padding: 0;
    margin: 0 0 30px;
}

.inline-group thead th {
    padding: 8px 10px;
}

.inline-group .aligned label {
    width: 160px;
}

.inline-related {
    position: relative;
}

.inline-related h4,
.inline-related:not(.tabular) .collapse summary {
    margin: 0;
    color: var(--body-medium-color);
    padding: 5px;
    font-size: 0.8125rem;
    background: var(--darkened-bg);
    border: 1px solid var(--hairline-color);
    border-left-color: var(--darkened-bg);
    border-right-color: var(--darkened-bg);
}

.inline-related h3 span.delete {
    float: right;
}

.inline-related h3 span.delete label {
    margin-left: 2px;
    font-size: 0.6875rem;
}

.inline-related fieldset {
    margin: 0;
    background: var(--body-bg);
    border: none;
    width: 100%;
}

.inline-group .tabular fieldset.module {
    border: none;
}

.inline-related.tabular div.wrapper {
    overflow-x: auto;
}

.inline-related.tabular fieldset.module table {
    width: 100%;
}

.last-related fieldset {
    border: none;
}

.inline-group .tabular tr.has_original td {
    padding-top: 2em;
}

.inline-group .tabular tr td.original {
    padding: 2px 0 0 0;
    width: 0;
}

.inline-group .tabular th.original {
    width: 0px;
    padding: 0;
}

.inline-group .tabular td {
    font-size: 1rem;
}

.inline-group .tabular td.original p {
    position: absolute;
    left: 0;
    height: 1.2em;
    padding: 2px 9px;
    overflow: hidden;
    font-size: 0.875rem;
    font-weight: bold;
    color: var(--body-quiet-color);
}

.inline-group div.add-row,
.inline-group .tabular tr.add-row td {
    color: var(--body-quiet-color);
    background: var(--darkened-bg);
    padding: 8px 10px;
    border-bottom: 1px solid var(--hairline-color);
}

.inline-group .tabular tr.add-row td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--hairline-color);
}

.inline-group div.add-row a,
.inline-group .tabular tr.add-row td a {
    font-size: 0.75rem;
}

.empty-form {
    display: none;
}

/* RELATED FIELD ADD ONE / LOOKUP */

.related-lookup {
    margin-left: 5px;
    display: inline-block;
    vertical-align: middle;
    background-repeat: no-repeat;
    background-size: 14px;
}

.related-lookup {
    width: 1rem;
    height: 1rem;
    background-image: url(../img/search.svg);
}

form .related-widget-wrapper ul {
    display: inline-block;
    margin-left: 0;
    padding-left: 0;
}

.clearable-file-input input {
    margin-top: 0;
}



========== staticfiles/admin/css/vendor/select2/select2.css ==========
.select2-container {
  box-sizing: border-box;
  display: inline-block;
  margin: 0;
  position: relative;
  vertical-align: middle; }
  .select2-container .select2-selection--single {
    box-sizing: border-box;
    cursor: pointer;
    display: block;
    height: 28px;
    user-select: none;
    -webkit-user-select: none; }
    .select2-container .select2-selection--single .select2-selection__rendered {
      display: block;
      padding-left: 8px;
      padding-right: 20px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap; }
    .select2-container .select2-selection--single .select2-selection__clear {
      position: relative; }
  .select2-container[dir="rtl"] .select2-selection--single .select2-selection__rendered {
    padding-right: 8px;
    padding-left: 20px; }
  .select2-container .select2-selection--multiple {
    box-sizing: border-box;
    cursor: pointer;
    display: block;
    min-height: 32px;
    user-select: none;
    -webkit-user-select: none; }
    .select2-container .select2-selection--multiple .select2-selection__rendered {
      display: inline-block;
      overflow: hidden;
      padding-left: 8px;
      text-overflow: ellipsis;
      white-space: nowrap; }
  .select2-container .select2-search--inline {
    float: left; }
    .select2-container .select2-search--inline .select2-search__field {
      box-sizing: border-box;
      border: none;
      font-size: 100%;
      margin-top: 5px;
      padding: 0; }
      .select2-container .select2-search--inline .select2-search__field::-webkit-search-cancel-button {
        -webkit-appearance: none; }

.select2-dropdown {
  background-color: white;
  border: 1px solid #aaa;
  border-radius: 4px;
  box-sizing: border-box;
  display: block;
  position: absolute;
  left: -100000px;
  width: 100%;
  z-index: 1051; }

.select2-results {
  display: block; }

.select2-results__options {
  list-style: none;
  margin: 0;
  padding: 0; }

.select2-results__option {
  padding: 6px;
  user-select: none;
  -webkit-user-select: none; }
  .select2-results__option[aria-selected] {
    cursor: pointer; }

.select2-container--open .select2-dropdown {
  left: 0; }

.select2-container--open .select2-dropdown--above {
  border-bottom: none;
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0; }

.select2-container--open .select2-dropdown--below {
  border-top: none;
  border-top-left-radius: 0;
  border-top-right-radius: 0; }

.select2-search--dropdown {
  display: block;
  padding: 4px; }
  .select2-search--dropdown .select2-search__field {
    padding: 4px;
    width: 100%;
    box-sizing: border-box; }
    .select2-search--dropdown .select2-search__field::-webkit-search-cancel-button {
      -webkit-appearance: none; }
  .select2-search--dropdown.select2-search--hide {
    display: none; }

.select2-close-mask {
  border: 0;
  margin: 0;
  padding: 0;
  display: block;
  position: fixed;
  left: 0;
  top: 0;
  min-height: 100%;
  min-width: 100%;
  height: auto;
  width: auto;
  opacity: 0;
  z-index: 99;
  background-color: #fff;
  filter: alpha(opacity=0); }

.select2-hidden-accessible {
  border: 0 !important;
  clip: rect(0 0 0 0) !important;
  -webkit-clip-path: inset(50%) !important;
  clip-path: inset(50%) !important;
  height: 1px !important;
  overflow: hidden !important;
  padding: 0 !important;
  position: absolute !important;
  width: 1px !important;
  white-space: nowrap !important; }

.select2-container--default .select2-selection--single {
  background-color: #fff;
  border: 1px solid #aaa;
  border-radius: 4px; }
  .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #444;
    line-height: 28px; }
  .select2-container--default .select2-selection--single .select2-selection__clear {
    cursor: pointer;
    float: right;
    font-weight: bold; }
  .select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: #999; }
  .select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 26px;
    position: absolute;
    top: 1px;
    right: 1px;
    width: 20px; }
    .select2-container--default .select2-selection--single .select2-selection__arrow b {
      border-color: #888 transparent transparent transparent;
      border-style: solid;
      border-width: 5px 4px 0 4px;
      height: 0;
      left: 50%;
      margin-left: -4px;
      margin-top: -2px;
      position: absolute;
      top: 50%;
      width: 0; }

.select2-container--default[dir="rtl"] .select2-selection--single .select2-selection__clear {
  float: left; }

.select2-container--default[dir="rtl"] .select2-selection--single .select2-selection__arrow {
  left: 1px;
  right: auto; }

.select2-container--default.select2-container--disabled .select2-selection--single {
  background-color: #eee;
  cursor: default; }
  .select2-container--default.select2-container--disabled .select2-selection--single .select2-selection__clear {
    display: none; }

.select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b {
  border-color: transparent transparent #888 transparent;
  border-width: 0 4px 5px 4px; }

.select2-container--default .select2-selection--multiple {
  background-color: white;
  border: 1px solid #aaa;
  border-radius: 4px;
  cursor: text; }
  .select2-container--default .select2-selection--multiple .select2-selection__rendered {
    box-sizing: border-box;
    list-style: none;
    margin: 0;
    padding: 0 5px;
    width: 100%; }
    .select2-container--default .select2-selection--multiple .select2-selection__rendered li {
      list-style: none; }
  .select2-container--default .select2-selection--multiple .select2-selection__clear {
    cursor: pointer;
    float: right;
    font-weight: bold;
    margin-top: 5px;
    margin-right: 10px;
    padding: 1px; }
  .select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: #e4e4e4;
    border: 1px solid #aaa;
    border-radius: 4px;
    cursor: default;
    float: left;
    margin-right: 5px;
    margin-top: 5px;
    padding: 0 5px; }
  .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
    color: #999;
    cursor: pointer;
    display: inline-block;
    font-weight: bold;
    margin-right: 2px; }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
      color: #333; }

.select2-container--default[dir="rtl"] .select2-selection--multiple .select2-selection__choice, .select2-container--default[dir="rtl"] .select2-selection--multiple .select2-search--inline {
  float: right; }

.select2-container--default[dir="rtl"] .select2-selection--multiple .select2-selection__choice {
  margin-left: 5px;
  margin-right: auto; }

.select2-container--default[dir="rtl"] .select2-selection--multiple .select2-selection__choice__remove {
  margin-left: 2px;
  margin-right: auto; }

.select2-container--default.select2-container--focus .select2-selection--multiple {
  border: solid black 1px;
  outline: 0; }

.select2-container--default.select2-container--disabled .select2-selection--multiple {
  background-color: #eee;
  cursor: default; }

.select2-container--default.select2-container--disabled .select2-selection__choice__remove {
  display: none; }

.select2-container--default.select2-container--open.select2-container--above .select2-selection--single, .select2-container--default.select2-container--open.select2-container--above .select2-selection--multiple {
  border-top-left-radius: 0;
  border-top-right-radius: 0; }

.select2-container--default.select2-container--open.select2-container--below .select2-selection--single, .select2-container--default.select2-container--open.select2-container--below .select2-selection--multiple {
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0; }

.select2-container--default .select2-search--dropdown .select2-search__field {
  border: 1px solid #aaa; }

.select2-container--default .select2-search--inline .select2-search__field {
  background: transparent;
  border: none;
  outline: 0;
  box-shadow: none;
  -webkit-appearance: textfield; }

.select2-container--default .select2-results > .select2-results__options {
  max-height: 200px;
  overflow-y: auto; }

.select2-container--default .select2-results__option[role=group] {
  padding: 0; }

.select2-container--default .select2-results__option[aria-disabled=true] {
  color: #999; }

.select2-container--default .select2-results__option[aria-selected=true] {
  background-color: #ddd; }

.select2-container--default .select2-results__option .select2-results__option {
  padding-left: 1em; }
  .select2-container--default .select2-results__option .select2-results__option .select2-results__group {
    padding-left: 0; }
  .select2-container--default .select2-results__option .select2-results__option .select2-results__option {
    margin-left: -1em;
    padding-left: 2em; }
    .select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option {
      margin-left: -2em;
      padding-left: 3em; }
      .select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option {
        margin-left: -3em;
        padding-left: 4em; }
        .select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option {
          margin-left: -4em;
          padding-left: 5em; }
          .select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option {
            margin-left: -5em;
            padding-left: 6em; }

.select2-container--default .select2-results__option--highlighted[aria-selected] {
  background-color: #5897fb;
  color: white; }

.select2-container--default .select2-results__group {
  cursor: default;
  display: block;
  padding: 6px; }

.select2-container--classic .select2-selection--single {
  background-color: #f7f7f7;
  border: 1px solid #aaa;
  border-radius: 4px;
  outline: 0;
  background-image: -webkit-linear-gradient(top, white 50%, #eeeeee 100%);
  background-image: -o-linear-gradient(top, white 50%, #eeeeee 100%);
  background-image: linear-gradient(to bottom, white 50%, #eeeeee 100%);
  background-repeat: repeat-x;
  filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFFFFFFF', endColorstr='#FFEEEEEE', GradientType=0); }
  .select2-container--classic .select2-selection--single:focus {
    border: 1px solid #5897fb; }
  .select2-container--classic .select2-selection--single .select2-selection__rendered {
    color: #444;
    line-height: 28px; }
  .select2-container--classic .select2-selection--single .select2-selection__clear {
    cursor: pointer;
    float: right;
    font-weight: bold;
    margin-right: 10px; }
  .select2-container--classic .select2-selection--single .select2-selection__placeholder {
    color: #999; }
  .select2-container--classic .select2-selection--single .select2-selection__arrow {
    background-color: #ddd;
    border: none;
    border-left: 1px solid #aaa;
    border-top-right-radius: 4px;
    border-bottom-right-radius: 4px;
    height: 26px;
    position: absolute;
    top: 1px;
    right: 1px;
    width: 20px;
    background-image: -webkit-linear-gradient(top, #eeeeee 50%, #cccccc 100%);
    background-image: -o-linear-gradient(top, #eeeeee 50%, #cccccc 100%);
    background-image: linear-gradient(to bottom, #eeeeee 50%, #cccccc 100%);
    background-repeat: repeat-x;
    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFEEEEEE', endColorstr='#FFCCCCCC', GradientType=0); }
    .select2-container--classic .select2-selection--single .select2-selection__arrow b {
      border-color: #888 transparent transparent transparent;
      border-style: solid;
      border-width: 5px 4px 0 4px;
      height: 0;
      left: 50%;
      margin-left: -4px;
      margin-top: -2px;
      position: absolute;
      top: 50%;
      width: 0; }

.select2-container--classic[dir="rtl"] .select2-selection--single .select2-selection__clear {
  float: left; }

.select2-container--classic[dir="rtl"] .select2-selection--single .select2-selection__arrow {
  border: none;
  border-right: 1px solid #aaa;
  border-radius: 0;
  border-top-left-radius: 4px;
  border-bottom-left-radius: 4px;
  left: 1px;
  right: auto; }

.select2-container--classic.select2-container--open .select2-selection--single {
  border: 1px solid #5897fb; }
  .select2-container--classic.select2-container--open .select2-selection--single .select2-selection__arrow {
    background: transparent;
    border: none; }
    .select2-container--classic.select2-container--open .select2-selection--single .select2-selection__arrow b {
      border-color: transparent transparent #888 transparent;
      border-width: 0 4px 5px 4px; }

.select2-container--classic.select2-container--open.select2-container--above .select2-selection--single {
  border-top: none;
  border-top-left-radius: 0;
  border-top-right-radius: 0;
  background-image: -webkit-linear-gradient(top, white 0%, #eeeeee 50%);
  background-image: -o-linear-gradient(top, white 0%, #eeeeee 50%);
  background-image: linear-gradient(to bottom, white 0%, #eeeeee 50%);
  background-repeat: repeat-x;
  filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFFFFFFF', endColorstr='#FFEEEEEE', GradientType=0); }

.select2-container--classic.select2-container--open.select2-container--below .select2-selection--single {
  border-bottom: none;
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
  background-image: -webkit-linear-gradient(top, #eeeeee 50%, white 100%);
  background-image: -o-linear-gradient(top, #eeeeee 50%, white 100%);
  background-image: linear-gradient(to bottom, #eeeeee 50%, white 100%);
  background-repeat: repeat-x;
  filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFEEEEEE', endColorstr='#FFFFFFFF', GradientType=0); }

.select2-container--classic .select2-selection--multiple {
  background-color: white;
  border: 1px solid #aaa;
  border-radius: 4px;
  cursor: text;
  outline: 0; }
  .select2-container--classic .select2-selection--multiple:focus {
    border: 1px solid #5897fb; }
  .select2-container--classic .select2-selection--multiple .select2-selection__rendered {
    list-style: none;
    margin: 0;
    padding: 0 5px; }
  .select2-container--classic .select2-selection--multiple .select2-selection__clear {
    display: none; }
  .select2-container--classic .select2-selection--multiple .select2-selection__choice {
    background-color: #e4e4e4;
    border: 1px solid #aaa;
    border-radius: 4px;
    cursor: default;
    float: left;
    margin-right: 5px;
    margin-top: 5px;
    padding: 0 5px; }
  .select2-container--classic .select2-selection--multiple .select2-selection__choice__remove {
    color: #888;
    cursor: pointer;
    display: inline-block;
    font-weight: bold;
    margin-right: 2px; }
    .select2-container--classic .select2-selection--multiple .select2-selection__choice__remove:hover {
      color: #555; }

.select2-container--classic[dir="rtl"] .select2-selection--multiple .select2-selection__choice {
  float: right;
  margin-left: 5px;
  margin-right: auto; }

.select2-container--classic[dir="rtl"] .select2-selection--multiple .select2-selection__choice__remove {
  margin-left: 2px;
  margin-right: auto; }

.select2-container--classic.select2-container--open .select2-selection--multiple {
  border: 1px solid #5897fb; }

.select2-container--classic.select2-container--open.select2-container--above .select2-selection--multiple {
  border-top: none;
  border-top-left-radius: 0;
  border-top-right-radius: 0; }

.select2-container--classic.select2-container--open.select2-container--below .select2-selection--multiple {
  border-bottom: none;
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0; }

.select2-container--classic .select2-search--dropdown .select2-search__field {
  border: 1px solid #aaa;
  outline: 0; }

.select2-container--classic .select2-search--inline .select2-search__field {
  outline: 0;
  box-shadow: none; }

.select2-container--classic .select2-dropdown {
  background-color: white;
  border: 1px solid transparent; }

.select2-container--classic .select2-dropdown--above {
  border-bottom: none; }

.select2-container--classic .select2-dropdown--below {
  border-top: none; }

.select2-container--classic .select2-results > .select2-results__options {
  max-height: 200px;
  overflow-y: auto; }

.select2-container--classic .select2-results__option[role=group] {
  padding: 0; }

.select2-container--classic .select2-results__option[aria-disabled=true] {
  color: grey; }

.select2-container--classic .select2-results__option--highlighted[aria-selected] {
  background-color: #3875d7;
  color: white; }

.select2-container--classic .select2-results__group {
  cursor: default;
  display: block;
  padding: 6px; }

.select2-container--classic.select2-container--open .select2-dropdown {
  border-color: #5897fb; }



========== staticfiles/admin/css/vendor/select2/select2.min.css ==========
.select2-container{box-sizing:border-box;display:inline-block;margin:0;position:relative;vertical-align:middle}.select2-container .select2-selection--single{box-sizing:border-box;cursor:pointer;display:block;height:28px;user-select:none;-webkit-user-select:none}.select2-container .select2-selection--single .select2-selection__rendered{display:block;padding-left:8px;padding-right:20px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.select2-container .select2-selection--single .select2-selection__clear{position:relative}.select2-container[dir="rtl"] .select2-selection--single .select2-selection__rendered{padding-right:8px;padding-left:20px}.select2-container .select2-selection--multiple{box-sizing:border-box;cursor:pointer;display:block;min-height:32px;user-select:none;-webkit-user-select:none}.select2-container .select2-selection--multiple .select2-selection__rendered{display:inline-block;overflow:hidden;padding-left:8px;text-overflow:ellipsis;white-space:nowrap}.select2-container .select2-search--inline{float:left}.select2-container .select2-search--inline .select2-search__field{box-sizing:border-box;border:none;font-size:100%;margin-top:5px;padding:0}.select2-container .select2-search--inline .select2-search__field::-webkit-search-cancel-button{-webkit-appearance:none}.select2-dropdown{background-color:white;border:1px solid #aaa;border-radius:4px;box-sizing:border-box;display:block;position:absolute;left:-100000px;width:100%;z-index:1051}.select2-results{display:block}.select2-results__options{list-style:none;margin:0;padding:0}.select2-results__option{padding:6px;user-select:none;-webkit-user-select:none}.select2-results__option[aria-selected]{cursor:pointer}.select2-container--open .select2-dropdown{left:0}.select2-container--open .select2-dropdown--above{border-bottom:none;border-bottom-left-radius:0;border-bottom-right-radius:0}.select2-container--open .select2-dropdown--below{border-top:none;border-top-left-radius:0;border-top-right-radius:0}.select2-search--dropdown{display:block;padding:4px}.select2-search--dropdown .select2-search__field{padding:4px;width:100%;box-sizing:border-box}.select2-search--dropdown .select2-search__field::-webkit-search-cancel-button{-webkit-appearance:none}.select2-search--dropdown.select2-search--hide{display:none}.select2-close-mask{border:0;margin:0;padding:0;display:block;position:fixed;left:0;top:0;min-height:100%;min-width:100%;height:auto;width:auto;opacity:0;z-index:99;background-color:#fff;filter:alpha(opacity=0)}.select2-hidden-accessible{border:0 !important;clip:rect(0 0 0 0) !important;-webkit-clip-path:inset(50%) !important;clip-path:inset(50%) !important;height:1px !important;overflow:hidden !important;padding:0 !important;position:absolute !important;width:1px !important;white-space:nowrap !important}.select2-container--default .select2-selection--single{background-color:#fff;border:1px solid #aaa;border-radius:4px}.select2-container--default .select2-selection--single .select2-selection__rendered{color:#444;line-height:28px}.select2-container--default .select2-selection--single .select2-selection__clear{cursor:pointer;float:right;font-weight:bold}.select2-container--default .select2-selection--single .select2-selection__placeholder{color:#999}.select2-container--default .select2-selection--single .select2-selection__arrow{height:26px;position:absolute;top:1px;right:1px;width:20px}.select2-container--default .select2-selection--single .select2-selection__arrow b{border-color:#888 transparent transparent transparent;border-style:solid;border-width:5px 4px 0 4px;height:0;left:50%;margin-left:-4px;margin-top:-2px;position:absolute;top:50%;width:0}.select2-container--default[dir="rtl"] .select2-selection--single .select2-selection__clear{float:left}.select2-container--default[dir="rtl"] .select2-selection--single .select2-selection__arrow{left:1px;right:auto}.select2-container--default.select2-container--disabled .select2-selection--single{background-color:#eee;cursor:default}.select2-container--default.select2-container--disabled .select2-selection--single .select2-selection__clear{display:none}.select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b{border-color:transparent transparent #888 transparent;border-width:0 4px 5px 4px}.select2-container--default .select2-selection--multiple{background-color:white;border:1px solid #aaa;border-radius:4px;cursor:text}.select2-container--default .select2-selection--multiple .select2-selection__rendered{box-sizing:border-box;list-style:none;margin:0;padding:0 5px;width:100%}.select2-container--default .select2-selection--multiple .select2-selection__rendered li{list-style:none}.select2-container--default .select2-selection--multiple .select2-selection__clear{cursor:pointer;float:right;font-weight:bold;margin-top:5px;margin-right:10px;padding:1px}.select2-container--default .select2-selection--multiple .select2-selection__choice{background-color:#e4e4e4;border:1px solid #aaa;border-radius:4px;cursor:default;float:left;margin-right:5px;margin-top:5px;padding:0 5px}.select2-container--default .select2-selection--multiple .select2-selection__choice__remove{color:#999;cursor:pointer;display:inline-block;font-weight:bold;margin-right:2px}.select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover{color:#333}.select2-container--default[dir="rtl"] .select2-selection--multiple .select2-selection__choice,.select2-container--default[dir="rtl"] .select2-selection--multiple .select2-search--inline{float:right}.select2-container--default[dir="rtl"] .select2-selection--multiple .select2-selection__choice{margin-left:5px;margin-right:auto}.select2-container--default[dir="rtl"] .select2-selection--multiple .select2-selection__choice__remove{margin-left:2px;margin-right:auto}.select2-container--default.select2-container--focus .select2-selection--multiple{border:solid black 1px;outline:0}.select2-container--default.select2-container--disabled .select2-selection--multiple{background-color:#eee;cursor:default}.select2-container--default.select2-container--disabled .select2-selection__choice__remove{display:none}.select2-container--default.select2-container--open.select2-container--above .select2-selection--single,.select2-container--default.select2-container--open.select2-container--above .select2-selection--multiple{border-top-left-radius:0;border-top-right-radius:0}.select2-container--default.select2-container--open.select2-container--below .select2-selection--single,.select2-container--default.select2-container--open.select2-container--below .select2-selection--multiple{border-bottom-left-radius:0;border-bottom-right-radius:0}.select2-container--default .select2-search--dropdown .select2-search__field{border:1px solid #aaa}.select2-container--default .select2-search--inline .select2-search__field{background:transparent;border:none;outline:0;box-shadow:none;-webkit-appearance:textfield}.select2-container--default .select2-results>.select2-results__options{max-height:200px;overflow-y:auto}.select2-container--default .select2-results__option[role=group]{padding:0}.select2-container--default .select2-results__option[aria-disabled=true]{color:#999}.select2-container--default .select2-results__option[aria-selected=true]{background-color:#ddd}.select2-container--default .select2-results__option .select2-results__option{padding-left:1em}.select2-container--default .select2-results__option .select2-results__option .select2-results__group{padding-left:0}.select2-container--default .select2-results__option .select2-results__option .select2-results__option{margin-left:-1em;padding-left:2em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-2em;padding-left:3em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-3em;padding-left:4em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-4em;padding-left:5em}.select2-container--default .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option{margin-left:-5em;padding-left:6em}.select2-container--default .select2-results__option--highlighted[aria-selected]{background-color:#5897fb;color:white}.select2-container--default .select2-results__group{cursor:default;display:block;padding:6px}.select2-container--classic .select2-selection--single{background-color:#f7f7f7;border:1px solid #aaa;border-radius:4px;outline:0;background-image:-webkit-linear-gradient(top, #fff 50%, #eee 100%);background-image:-o-linear-gradient(top, #fff 50%, #eee 100%);background-image:linear-gradient(to bottom, #fff 50%, #eee 100%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFFFFFFF', endColorstr='#FFEEEEEE', GradientType=0)}.select2-container--classic .select2-selection--single:focus{border:1px solid #5897fb}.select2-container--classic .select2-selection--single .select2-selection__rendered{color:#444;line-height:28px}.select2-container--classic .select2-selection--single .select2-selection__clear{cursor:pointer;float:right;font-weight:bold;margin-right:10px}.select2-container--classic .select2-selection--single .select2-selection__placeholder{color:#999}.select2-container--classic .select2-selection--single .select2-selection__arrow{background-color:#ddd;border:none;border-left:1px solid #aaa;border-top-right-radius:4px;border-bottom-right-radius:4px;height:26px;position:absolute;top:1px;right:1px;width:20px;background-image:-webkit-linear-gradient(top, #eee 50%, #ccc 100%);background-image:-o-linear-gradient(top, #eee 50%, #ccc 100%);background-image:linear-gradient(to bottom, #eee 50%, #ccc 100%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFEEEEEE', endColorstr='#FFCCCCCC', GradientType=0)}.select2-container--classic .select2-selection--single .select2-selection__arrow b{border-color:#888 transparent transparent transparent;border-style:solid;border-width:5px 4px 0 4px;height:0;left:50%;margin-left:-4px;margin-top:-2px;position:absolute;top:50%;width:0}.select2-container--classic[dir="rtl"] .select2-selection--single .select2-selection__clear{float:left}.select2-container--classic[dir="rtl"] .select2-selection--single .select2-selection__arrow{border:none;border-right:1px solid #aaa;border-radius:0;border-top-left-radius:4px;border-bottom-left-radius:4px;left:1px;right:auto}.select2-container--classic.select2-container--open .select2-selection--single{border:1px solid #5897fb}.select2-container--classic.select2-container--open .select2-selection--single .select2-selection__arrow{background:transparent;border:none}.select2-container--classic.select2-container--open .select2-selection--single .select2-selection__arrow b{border-color:transparent transparent #888 transparent;border-width:0 4px 5px 4px}.select2-container--classic.select2-container--open.select2-container--above .select2-selection--single{border-top:none;border-top-left-radius:0;border-top-right-radius:0;background-image:-webkit-linear-gradient(top, #fff 0%, #eee 50%);background-image:-o-linear-gradient(top, #fff 0%, #eee 50%);background-image:linear-gradient(to bottom, #fff 0%, #eee 50%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFFFFFFF', endColorstr='#FFEEEEEE', GradientType=0)}.select2-container--classic.select2-container--open.select2-container--below .select2-selection--single{border-bottom:none;border-bottom-left-radius:0;border-bottom-right-radius:0;background-image:-webkit-linear-gradient(top, #eee 50%, #fff 100%);background-image:-o-linear-gradient(top, #eee 50%, #fff 100%);background-image:linear-gradient(to bottom, #eee 50%, #fff 100%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFEEEEEE', endColorstr='#FFFFFFFF', GradientType=0)}.select2-container--classic .select2-selection--multiple{background-color:white;border:1px solid #aaa;border-radius:4px;cursor:text;outline:0}.select2-container--classic .select2-selection--multiple:focus{border:1px solid #5897fb}.select2-container--classic .select2-selection--multiple .select2-selection__rendered{list-style:none;margin:0;padding:0 5px}.select2-container--classic .select2-selection--multiple .select2-selection__clear{display:none}.select2-container--classic .select2-selection--multiple .select2-selection__choice{background-color:#e4e4e4;border:1px solid #aaa;border-radius:4px;cursor:default;float:left;margin-right:5px;margin-top:5px;padding:0 5px}.select2-container--classic .select2-selection--multiple .select2-selection__choice__remove{color:#888;cursor:pointer;display:inline-block;font-weight:bold;margin-right:2px}.select2-container--classic .select2-selection--multiple .select2-selection__choice__remove:hover{color:#555}.select2-container--classic[dir="rtl"] .select2-selection--multiple .select2-selection__choice{float:right;margin-left:5px;margin-right:auto}.select2-container--classic[dir="rtl"] .select2-selection--multiple .select2-selection__choice__remove{margin-left:2px;margin-right:auto}.select2-container--classic.select2-container--open .select2-selection--multiple{border:1px solid #5897fb}.select2-container--classic.select2-container--open.select2-container--above .select2-selection--multiple{border-top:none;border-top-left-radius:0;border-top-right-radius:0}.select2-container--classic.select2-container--open.select2-container--below .select2-selection--multiple{border-bottom:none;border-bottom-left-radius:0;border-bottom-right-radius:0}.select2-container--classic .select2-search--dropdown .select2-search__field{border:1px solid #aaa;outline:0}.select2-container--classic .select2-search--inline .select2-search__field{outline:0;box-shadow:none}.select2-container--classic .select2-dropdown{background-color:#fff;border:1px solid transparent}.select2-container--classic .select2-dropdown--above{border-bottom:none}.select2-container--classic .select2-dropdown--below{border-top:none}.select2-container--classic .select2-results>.select2-results__options{max-height:200px;overflow-y:auto}.select2-container--classic .select2-results__option[role=group]{padding:0}.select2-container--classic .select2-results__option[aria-disabled=true]{color:grey}.select2-container--classic .select2-results__option--highlighted[aria-selected]{background-color:#3875d7;color:#fff}.select2-container--classic .select2-results__group{cursor:default;display:block;padding:6px}.select2-container--classic.select2-container--open .select2-dropdown{border-color:#5897fb}



========== staticfiles/admin/css/dashboard.css ==========
/* DASHBOARD */
.dashboard td, .dashboard th {
    word-break: break-word;
}

.dashboard .module table th {
    width: 100%;
}

.dashboard .module table td {
    white-space: nowrap;
}

.dashboard .module table td a {
    display: block;
    padding-right: .6em;
}

/* RECENT ACTIONS MODULE */

.module ul.actionlist {
    margin-left: 0;
}

ul.actionlist li {
    list-style-type: none;
    overflow: hidden;
    text-overflow: ellipsis;
}



========== staticfiles/admin/css/widgets.css ==========
/* SELECTOR (FILTER INTERFACE) */

.selector {
    display: flex;
    flex: 1;
    gap: 0 10px;
}

.selector select {
    height: 17.2em;
    flex: 1 0 auto;
    overflow: scroll;
    width: 100%;
}

.selector-available, .selector-chosen {
    display: flex;
    flex-direction: column;
    flex: 1 1;
}

.selector-available-title, .selector-chosen-title {
    border: 1px solid var(--border-color);
    border-radius: 4px 4px 0 0;
}

.selector .helptext {
    font-size: 0.6875rem;
}

.selector-chosen .list-footer-display {
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 4px 4px;
    margin: 0 0 10px;
    padding: 8px;
    text-align: center;
    background: var(--primary);
    color: var(--header-link-color);
    cursor: pointer;
}
.selector-chosen .list-footer-display__clear {
    color: var(--breadcrumbs-fg);
}

.selector-chosen-title {
    background: var(--secondary);
    color: var(--header-link-color);
    padding: 8px;
}

.selector-chosen-title label {
    color: var(--header-link-color);
    width: 100%;
}

.selector-available-title {
    background: var(--darkened-bg);
    color: var(--body-quiet-color);
    padding: 8px;
}

.selector-available-title label {
    width: 100%;
}

.selector .selector-filter {
    border: 1px solid var(--border-color);
    border-width: 0 1px;
    padding: 8px;
    color: var(--body-quiet-color);
    font-size: 0.625rem;
    margin: 0;
    text-align: left;
    display: flex;
    gap: 8px;
}

.selector .selector-filter label,
.inline-group .aligned .selector .selector-filter label {
    float: left;
    margin: 7px 0 0;
    width: 18px;
    height: 18px;
    padding: 0;
    overflow: hidden;
    line-height: 1;
    min-width: auto;
}

.selector-filter input {
    flex-grow: 1;
}

.selector ul.selector-chooser {
    align-self: center;
    width: 30px;
    background-color: var(--selected-bg);
    border-radius: 10px;
    margin: 0;
    padding: 0;
    transform: translateY(-17px);
}

.selector-chooser li {
    margin: 0;
    padding: 3px;
    list-style-type: none;
}

.selector select {
    padding: 0 10px;
    margin: 0 0 10px;
    border-radius: 0 0 4px 4px;
}
.selector .selector-chosen--with-filtered select {
    margin: 0;
    border-radius: 0;
    height: 14em;
}

.selector .selector-chosen:not(.selector-chosen--with-filtered) .list-footer-display {
    display: none;
}

.selector-add, .selector-remove {
    width: 24px;
    height: 24px;
    display: block;
    text-indent: -3000px;
    overflow: hidden;
    cursor: default;
    opacity: 0.55;
    border: none;
}

:enabled.selector-add, :enabled.selector-remove {
    opacity: 1;
}

:enabled.selector-add:hover, :enabled.selector-remove:hover {
    cursor: pointer;
}

.selector-add {
    background: url(../img/selector-icons.svg) 0 -144px no-repeat;
    background-size: 24px auto;
}

:enabled.selector-add:focus, :enabled.selector-add:hover {
    background-position: 0 -168px;
}

.selector-remove {
    background: url(../img/selector-icons.svg) 0 -96px no-repeat;
    background-size: 24px auto;
}

:enabled.selector-remove:focus, :enabled.selector-remove:hover {
    background-position: 0 -120px;
}

.selector-chooseall, .selector-clearall {
    display: inline-block;
    text-align: left;
    padding: 4px 5px;
    margin: 0 auto;
    overflow: hidden;
    color: var(--button-fg);
    background-color: var(--button-bg);
    text-decoration: none;
    opacity: 0.55;
    border: none;
    border-radius: 4px;
}

:enabled.selector-chooseall:focus, :enabled.selector-clearall:focus,
:enabled.selector-chooseall:hover, :enabled.selector-clearall:hover {
    background-color: var(--button-hover-bg);
}

:enabled.selector-chooseall, :enabled.selector-clearall {
    opacity: 1;
}

:enabled.selector-chooseall:hover, :enabled.selector-clearall:hover {
    cursor: pointer;
}

:enabled.selector-chooseall:focus, :enabled.selector-chooseall:hover {
    background-position: 100% -176px;
}

:enabled.selector-clearall:focus, :enabled.selector-clearall:hover {
    background-position: 0 -144px;
}

/* STACKED SELECTORS */

.stacked {
    float: left;
    width: 490px;
    display: block;
}

.stacked select {
    width: 480px;
    height: 10.1em;
}

.stacked .selector-available, .stacked .selector-chosen {
    width: 480px;
}

.stacked .selector-available {
    margin-bottom: 0;
}

.stacked .selector-available input {
    width: 422px;
}

.stacked ul.selector-chooser {
    display: flex;
    height: 30px;
    width: 64px;
    margin: 0 0 10px 40%;
    background-color: #eee;
    border-radius: 10px;
    transform: none;
}

.stacked .selector-chooser li {
    float: left;
    padding: 3px 3px 3px 5px;
}

.stacked .selector-chooseall, .stacked .selector-clearall {
    display: none;
}

.stacked .selector-add {
    background: url(../img/selector-icons.svg) 0 -48px no-repeat;
    background-size: 24px auto;
    cursor: default;
}

.stacked :enabled.selector-add {
    background-position: 0 -48px;
    cursor: pointer;
}

.stacked :enabled.selector-add:focus, .stacked :enabled.selector-add:hover {
    background-position: 0 -72px;
    cursor: pointer;
}

.stacked .selector-remove {
    background: url(../img/selector-icons.svg) 0 0 no-repeat;
    background-size: 24px auto;
    cursor: default;
}

.stacked :enabled.selector-remove {
    background-position: 0 0px;
    cursor: pointer;
}

.stacked :enabled.selector-remove:focus, .stacked :enabled.selector-remove:hover {
    background-position: 0 -24px;
    cursor: pointer;
}

.selector .help-icon {
    background: url(../img/icon-unknown.svg) 0 0 no-repeat;
    display: inline-block;
    vertical-align: middle;
    margin: -2px 0 0 2px;
    width: 13px;
    height: 13px;
}

.selector .selector-chosen .help-icon {
    background: url(../img/icon-unknown-alt.svg) 0 0 no-repeat;
}

.selector .search-label-icon {
    background: url(../img/search.svg) 0 0 no-repeat;
    display: inline-block;
    height: 1.125rem;
    width: 1.125rem;
}

/* DATE AND TIME */

p.datetime {
    line-height: 20px;
    margin: 0;
    padding: 0;
    color: var(--body-quiet-color);
    font-weight: bold;
}

p.datetime label {
    display: inline;
}

.datetime span {
    white-space: nowrap;
    font-weight: normal;
    font-size: 0.6875rem;
    color: var(--body-quiet-color);
}

.datetime input, .form-row .datetime input.vDateField, .form-row .datetime input.vTimeField {
    margin-left: 5px;
    margin-bottom: 4px;
}

table p.datetime {
    font-size: 0.6875rem;
    margin-left: 0;
    padding-left: 0;
}

.datetimeshortcuts .clock-icon, .datetimeshortcuts .date-icon {
    position: relative;
    display: inline-block;
    vertical-align: middle;
    height: 24px;
    width: 24px;
    overflow: hidden;
}

.datetimeshortcuts .clock-icon {
    background: url(../img/icon-clock.svg) 0 0 no-repeat;
    background-size: 24px auto;
}

.datetimeshortcuts a:focus .clock-icon,
.datetimeshortcuts a:hover .clock-icon {
    background-position: 0 -24px;
}

.datetimeshortcuts .date-icon {
    background: url(../img/icon-calendar.svg) 0 0 no-repeat;
    background-size: 24px auto;
    top: -1px;
}

.datetimeshortcuts a:focus .date-icon,
.datetimeshortcuts a:hover .date-icon {
    background-position: 0 -24px;
}

.timezonewarning {
    font-size: 0.6875rem;
    color: var(--body-quiet-color);
}

/* URL */

p.url {
    line-height: 20px;
    margin: 0;
    padding: 0;
    color: var(--body-quiet-color);
    font-size: 0.6875rem;
    font-weight: bold;
}

.url a {
    font-weight: normal;
}

/* FILE UPLOADS */

p.file-upload {
    line-height: 20px;
    margin: 0;
    padding: 0;
    color: var(--body-quiet-color);
    font-size: 0.6875rem;
    font-weight: bold;
}

.file-upload a {
    font-weight: normal;
}

.file-upload .deletelink {
    margin-left: 5px;
}

span.clearable-file-input label {
    color: var(--body-fg);
    font-size: 0.6875rem;
    display: inline;
    float: none;
}

/* CALENDARS & CLOCKS */

.calendarbox, .clockbox {
    margin: 5px auto;
    font-size: 0.75rem;
    width: 19em;
    text-align: center;
    background: var(--body-bg);
    color: var(--body-fg);
    border: 1px solid var(--hairline-color);
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    position: relative;
}

.clockbox {
    width: auto;
}

.calendar {
    margin: 0;
    padding: 0;
}

.calendar table {
    margin: 0;
    padding: 0;
    border-collapse: collapse;
    background: white;
    width: 100%;
}

.calendar caption, .calendarbox h2 {
    margin: 0;
    text-align: center;
    border-top: none;
    font-weight: 700;
    font-size: 0.75rem;
    color: #333;
    background: var(--accent);
}

.calendar th {
    padding: 8px 5px;
    background: var(--darkened-bg);
    border-bottom: 1px solid var(--border-color);
    font-weight: 400;
    font-size: 0.75rem;
    text-align: center;
    color: var(--body-quiet-color);
}

.calendar td {
    font-weight: 400;
    font-size: 0.75rem;
    text-align: center;
    padding: 0;
    border-top: 1px solid var(--hairline-color);
    border-bottom: none;
}

.calendar td.selected a {
    background: var(--secondary);
    color: var(--button-fg);
}

.calendar td.nonday {
    background: var(--darkened-bg);
}

.calendar td.today a {
    font-weight: 700;
}

.calendar td a, .timelist a {
    display: block;
    font-weight: 400;
    padding: 6px;
    text-decoration: none;
    color: var(--body-quiet-color);
}

.calendar td a:focus, .timelist a:focus,
.calendar td a:hover, .timelist a:hover {
    background: var(--primary);
    color: white;
}

.calendar td a:active, .timelist a:active {
    background: var(--header-bg);
    color: white;
}

.calendarnav {
    font-size: 0.625rem;
    text-align: center;
    color: #ccc;
    margin: 0;
    padding: 1px 3px;
}

.calendarnav a:link, #calendarnav a:visited,
#calendarnav a:focus, #calendarnav a:hover {
    color: var(--body-quiet-color);
}

.calendar-shortcuts {
    background: var(--body-bg);
    color: var(--body-quiet-color);
    font-size: 0.6875rem;
    line-height: 0.6875rem;
    border-top: 1px solid var(--hairline-color);
    padding: 8px 0;
}

.calendarbox .calendarnav-previous, .calendarbox .calendarnav-next {
    display: block;
    position: absolute;
    top: 8px;
    width: 15px;
    height: 15px;
    text-indent: -9999px;
    padding: 0;
}

.calendarnav-previous {
    left: 10px;
    background: url(../img/calendar-icons.svg) 0 0 no-repeat;
}

.calendarnav-next {
    right: 10px;
    background: url(../img/calendar-icons.svg) 0 -15px no-repeat;
}

.calendar-cancel {
    margin: 0;
    padding: 4px 0;
    font-size: 0.75rem;
    background: var(--close-button-bg);
    border-top: 1px solid var(--border-color);
    color: var(--button-fg);
}

.calendar-cancel:focus, .calendar-cancel:hover {
    background: var(--close-button-hover-bg);
}

.calendar-cancel a {
    color: var(--button-fg);
    display: block;
}

ul.timelist, .timelist li {
    list-style-type: none;
    margin: 0;
    padding: 0;
}

.timelist a {
    padding: 2px;
}

/* EDIT INLINE */

.inline-deletelink {
    float: right;
    text-indent: -9999px;
    background: url(../img/inline-delete.svg) center center no-repeat;
    background-size: contain;
    width: 1.5rem;
    height: 1.5rem;
    border: 0px none;
    margin-bottom: .25rem;
}

.inline-deletelink:focus, .inline-deletelink:hover {
    cursor: pointer;
}

/* RELATED WIDGET WRAPPER */
.related-widget-wrapper {
    display: flex;
    gap: 0 10px;
    flex-grow: 1;
    flex-wrap: wrap;
    margin-bottom: 5px;
}

.related-widget-wrapper-link {
    opacity: .6;
    filter: grayscale(1);
}

.related-widget-wrapper-link:link {
    opacity: 1;
    filter: grayscale(0);
}

/* GIS MAPS */
.dj_map {
    width: 600px;
    height: 400px;
}



========== staticfiles/admin/css/responsive.css ==========
/* Tablets */

input[type="submit"], button {
    -webkit-appearance: none;
    appearance: none;
}

@media (max-width: 1024px) {
    /* Basic */

    html {
        -webkit-text-size-adjust: 100%;
    }

    td, th {
        padding: 10px;
        font-size: 0.875rem;
    }

    .small {
        font-size: 0.75rem;
    }

    /* Layout */

    #container {
        min-width: 0;
    }

    #content {
        padding: 15px 20px 20px;
    }

    div.breadcrumbs {
        padding: 10px 30px;
    }

    /* Header */

    #header {
        flex-direction: column;
        padding: 15px 30px;
        justify-content: flex-start;
    }

    #site-name {
        margin: 0 0 8px;
        line-height: 1.2;
    }

    #user-tools {
        margin: 0;
        font-weight: 400;
        line-height: 1.85;
        text-align: left;
    }

    #user-tools a {
        display: inline-block;
        line-height: 1.4;
    }

    /* Dashboard */

    .dashboard #content {
        width: auto;
    }

    #content-related {
        margin-right: -290px;
    }

    .colSM #content-related {
        margin-left: -290px;
    }

    .colMS {
        margin-right: 290px;
    }

    .colSM {
        margin-left: 290px;
    }

    .dashboard .module table td a {
        padding-right: 0;
    }

    td .changelink, td .addlink {
        font-size: 0.8125rem;
    }

    /* Changelist */

    #toolbar {
        border: none;
        padding: 15px;
    }

    #changelist-search > div {
        display: flex;
        flex-wrap: nowrap;
        max-width: 480px;
    }

    #changelist-search label {
        line-height: 1.375rem;
    }

    #toolbar form #searchbar {
        flex: 1 0 auto;
        width: 0;
        height: 1.375rem;
        margin: 0 10px 0 6px;
    }

    #toolbar form input[type=submit] {
        flex: 0 1 auto;
    }

    #changelist-search .quiet {
        width: 0;
        flex: 1 0 auto;
        margin: 5px 0 0 25px;
    }

    #changelist .actions {
        display: flex;
        flex-wrap: wrap;
        padding: 15px 0;
    }

    #changelist .actions label {
        display: flex;
    }

    #changelist .actions select {
        background: var(--body-bg);
    }

    #changelist .actions .button {
        min-width: 48px;
        margin: 0 10px;
    }

    #changelist .actions span.all,
    #changelist .actions span.clear,
    #changelist .actions span.question,
    #changelist .actions span.action-counter {
        font-size: 0.6875rem;
        margin: 0 10px 0 0;
    }

    #changelist-filter {
        flex-basis: 200px;
    }

    .change-list .filtered .results,
    .change-list .filtered .paginator,
    .filtered #toolbar,
    .filtered .actions,

    #changelist .paginator {
        border-top-color: var(--hairline-color); /* XXX Is this used at all? */
    }

    #changelist .results + .paginator {
        border-top: none;
    }

    /* Forms */

    legend,
    label {
        font-size: 1rem;
    }

    /*
    Minifiers remove the default (text) "type" attribute from "input" HTML
    tags. Add input:not([type]) to make the CSS stylesheet work the same.
    */
    .form-row input:not([type]),
    .form-row input[type=text],
    .form-row input[type=password],
    .form-row input[type=email],
    .form-row input[type=url],
    .form-row input[type=tel],
    .form-row input[type=number],
    .form-row textarea,
    .form-row select,
    .form-row .vTextField {
        box-sizing: border-box;
        margin: 0;
        padding: 6px 8px;
        min-height: 2.25rem;
        font-size: 1rem;
    }

    .form-row select {
        height: 2.25rem;
    }

    .form-row select[multiple] {
        height: auto;
        min-height: 0;
    }

    fieldset .fieldBox + .fieldBox {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--hairline-color);
    }

    textarea {
        max-width: 100%;
        max-height: 120px;
    }

    .aligned label {
        padding-top: 6px;
    }

    .aligned .related-lookup,
    .aligned .datetimeshortcuts,
    .aligned .related-lookup + strong {
        align-self: center;
        margin-left: 15px;
    }

    form .aligned div.radiolist {
        margin-left: 2px;
    }

    .submit-row {
        padding: 8px;
    }

    .submit-row a.deletelink {
        padding: 10px 7px;
    }

    .button, input[type=submit], input[type=button], .submit-row input, a.button {
        padding: 7px;
    }

    /* Selector */

    .selector {
        display: flex;
        width: 100%;
    }

    .selector .selector-filter {
        display: flex;
        align-items: center;
    }

    .selector .selector-filter input {
        width: 100%;
        min-height: 0;
        flex: 1 1;
    }

    .selector-available, .selector-chosen {
        width: auto;
        flex: 1 1;
        display: flex;
        flex-direction: column;
    }

    .selector select {
        width: 100%;
        flex: 1 0 auto;
        margin-bottom: 5px;
    }

    .selector-chooseall, .selector-clearall {
        align-self: center;
    }

    .stacked {
        flex-direction: column;
        max-width: 480px;
    }

    .stacked > * {
        flex: 0 1 auto;
    }

    .stacked select {
        margin-bottom: 0;
    }

    .stacked .selector-available, .stacked .selector-chosen {
        width: auto;
    }

    .stacked ul.selector-chooser {
        padding: 0 2px;
        transform: none;
    }

    .stacked .selector-chooser li {
        padding: 3px;
    }

    .help-tooltip, .selector .help-icon {
        display: none;
    }

    .datetime input {
        width: 50%;
        max-width: 120px;
    }

    .datetime span {
        font-size: 0.8125rem;
    }

    .datetime .timezonewarning {
        display: block;
        font-size: 0.6875rem;
        color: var(--body-quiet-color);
    }

    .datetimeshortcuts {
        color: var(--border-color); /* XXX Redundant, .datetime span also sets #ccc */
    }

    .form-row .datetime input.vDateField, .form-row .datetime input.vTimeField {
        width: 75%;
    }

    .inline-group {
        overflow: auto;
    }

    /* Messages */

    ul.messagelist li {
        padding: 10px 10px 10px 55px;
        background-position-x: 30px;
    }

    /* Login */

    .login #header {
        padding: 15px 20px;
    }

    .login #site-name {
        margin: 0;
    }

    /* GIS */

    div.olMap {
        max-width: calc(100vw - 30px);
        max-height: 300px;
    }

    .olMap + .clear_features {
        display: block;
        margin-top: 10px;
    }

    /* Docs */

    .module table.xfull {
        width: 100%;
    }

    pre.literal-block {
        overflow: auto;
    }
}

/* Mobile */

@media (max-width: 767px) {
    /* Layout */

    #header, #content {
        padding: 15px;
    }

    div.breadcrumbs {
        padding: 10px 15px;
    }

    /* Dashboard */

    .colMS, .colSM {
        margin: 0;
    }

    #content-related, .colSM #content-related {
        width: 100%;
        margin: 0;
    }

    #content-related .module {
        margin-bottom: 0;
    }

    #content-related .module h2 {
        padding: 10px 15px;
        font-size: 1rem;
    }

    /* Changelist */

    #changelist .changelist-form-container {
        flex-direction: column;
    }

    #changelist .changelist-form-container:has(#changelist-filter) > div {
        max-width: 100%;
        width: 100%;
    }

    #toolbar {
        padding: 10px;
    }

    #changelist-filter {
        margin-left: 0;
    }

    #changelist .actions label {
        flex: 1 1;
    }

    #changelist .actions select {
        flex: 1 0;
        width: 100%;
    }

    #changelist .actions span {
        flex: 1 0 100%;
    }

    #changelist-filter {
        width: 100%;
        margin-top: 30px;
    }

    .object-tools {
        text-align: left;
    }

    /* Forms */

    .form-row {
        padding: 15px 0;
    }

    .aligned .form-row,
    .aligned .form-row > div {
        max-width: 100vw;
    }

    .aligned .form-row > div {
        width: calc(100vw - 30px);
    }

    .flex-container {
        flex-flow: column;
    }

    .flex-container.checkbox-row {
        flex-flow: row;
    }

    textarea {
        max-width: none;
    }

    .vURLField {
        width: auto;
    }

    fieldset .fieldBox + .fieldBox {
        margin-top: 15px;
        padding-top: 15px;
    }

    .aligned legend,
    .aligned label {
        width: 100%;
        min-width: auto;
        padding: 0 0 10px;
    }

    .aligned label:after {
        max-height: 0;
    }

    .aligned .form-row input,
    .aligned .form-row select,
    .aligned .form-row textarea {
        flex: 1 1 auto;
        max-width: 100%;
    }

    .aligned .checkbox-row input {
        flex: 0 1 auto;
        margin: 0;
    }

    .aligned .vCheckboxLabel {
        flex: 1 0;
        padding: 1px 0 0 5px;
    }

    .aligned label + p,
    .aligned label + div.help,
    .aligned label + div.readonly {
        padding: 0;
        margin-left: 0;
    }

    .aligned p.file-upload {
        font-size: 0.8125rem;
    }

    span.clearable-file-input {
        margin-left: 15px;
    }

    span.clearable-file-input label {
        font-size: 0.8125rem;
        padding-bottom: 0;
    }

    .aligned .timezonewarning {
        flex: 1 0 100%;
        margin-top: 5px;
    }

    form .aligned .form-row div.help {
        width: 100%;
        margin: 5px 0 0;
        padding: 0;
    }

    form .aligned ul,
    form .aligned ul.errorlist {
        margin-left: 0;
        padding-left: 0;
    }

    form .aligned div.radiolist {
        margin-top: 5px;
        margin-right: 15px;
        margin-bottom: -3px;
    }

    form .aligned div.radiolist:not(.inline) div + div {
        margin-top: 5px;
    }

    /* Related widget */

    .related-widget-wrapper {
        width: 100%;
        display: flex;
        align-items: flex-start;
    }

    .related-widget-wrapper .selector {
        order: 1;
        flex: 1 0 auto;
    }

    .related-widget-wrapper > a {
        order: 2;
    }

    .related-widget-wrapper .radiolist ~ a {
        align-self: flex-end;
    }

    .related-widget-wrapper > select ~ a {
        align-self: center;
    }

    /* Selector */

    .selector {
        flex-direction: column;
        gap: 10px 0;
    }

    .selector-available, .selector-chosen {
        flex: 1 1 auto;
    }

    .selector select {
        max-height: 96px;
    }

    .selector ul.selector-chooser {
        display: flex;
        width: 60px;
        height: 30px;
        padding: 0 2px;
        transform: none;
    }

    .selector ul.selector-chooser li {
        float: left;
    }

    .selector-remove {
        background-position: 0 0;
    }

    :enabled.selector-remove:focus, :enabled.selector-remove:hover {
        background-position: 0 -24px;
    }

    .selector-add  {
        background-position: 0 -48px;
    }

    :enabled.selector-add:focus, :enabled.selector-add:hover {
        background-position: 0 -72px;
    }

    /* Inlines */

    .inline-group[data-inline-type="stacked"] .inline-related {
        border: 1px solid var(--hairline-color);
        border-radius: 4px;
        margin-top: 15px;
        overflow: auto;
    }

    .inline-group[data-inline-type="stacked"] .inline-related > * {
        box-sizing: border-box;
    }

    .inline-group[data-inline-type="stacked"] .inline-related .module {
        padding: 0 10px;
    }

    .inline-group[data-inline-type="stacked"] .inline-related .module .form-row {
        border-top: 1px solid var(--hairline-color);
        border-bottom: none;
    }

    .inline-group[data-inline-type="stacked"] .inline-related .module .form-row:first-child {
        border-top: none;
    }

    .inline-group[data-inline-type="stacked"] .inline-related h3 {
        padding: 10px;
        border-top-width: 0;
        border-bottom-width: 2px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
    }

    .inline-group[data-inline-type="stacked"] .inline-related h3 .inline_label {
        margin-right: auto;
    }

    .inline-group[data-inline-type="stacked"] .inline-related h3 span.delete {
        float: none;
        flex: 1 1 100%;
        margin-top: 5px;
    }

    .inline-group[data-inline-type="stacked"] .aligned .form-row > div:not([class]) {
        width: 100%;
    }

    .inline-group[data-inline-type="stacked"] .aligned label {
        width: 100%;
    }

    .inline-group[data-inline-type="stacked"] div.add-row {
        margin-top: 15px;
        border: 1px solid var(--hairline-color);
        border-radius: 4px;
    }

    .inline-group div.add-row,
    .inline-group .tabular tr.add-row td {
        padding: 0;
    }

    .inline-group div.add-row a,
    .inline-group .tabular tr.add-row td a {
        display: block;
        padding: 8px 10px 8px 26px;
        background-position: 8px 9px;
    }

    /* Submit row */

    .submit-row {
        padding: 10px;
        margin: 0 0 15px;
        flex-direction: column;
        gap: 8px;
    }

    .submit-row input, .submit-row input.default, .submit-row a {
        text-align: center;
    }

    .submit-row a.closelink {
        padding: 10px 0;
        text-align: center;
    }

    .submit-row a.deletelink {
        margin: 0;
    }

    /* Messages */

    ul.messagelist li {
        padding: 10px 10px 10px 40px;
        background-position-x: 15px;
    }

    /* Paginator */

    .paginator .this-page, .paginator a:link, .paginator a:visited {
        padding: 4px 10px;
    }

    /* Login */

    body.login {
        padding: 0 15px;
    }

    .login #container {
        width: auto;
        max-width: 480px;
        margin: 50px auto;
    }

    .login #header,
    .login #content {
        padding: 15px;
    }

    .login #content-main {
        float: none;
    }

    .login .form-row {
        padding: 0;
    }

    .login .form-row + .form-row {
        margin-top: 15px;
    }

    .login .form-row label {
        margin: 0 0 5px;
        line-height: 1.2;
    }

    .login .submit-row {
        padding: 15px 0 0;
    }

    .login br {
        display: none;
    }

    .login .submit-row input {
        margin: 0;
        text-transform: uppercase;
    }

    .errornote {
        margin: 0 0 20px;
        padding: 8px 12px;
        font-size: 0.8125rem;
    }

    /* Calendar and clock */

    .calendarbox, .clockbox {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%);
        margin: 0;
        border: none;
        overflow: visible;
    }

    .calendarbox:before, .clockbox:before {
        content: '';
        position: fixed;
        top: 50%;
        left: 50%;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.75);
        transform: translate(-50%, -50%);
    }

    .calendarbox > *, .clockbox > * {
        position: relative;
        z-index: 1;
    }

    .calendarbox > div:first-child {
        z-index: 2;
    }

    .calendarbox .calendar, .clockbox h2 {
        border-radius: 4px 4px 0 0;
        overflow: hidden;
    }

    .calendarbox .calendar-cancel, .clockbox .calendar-cancel {
        border-radius: 0 0 4px 4px;
        overflow: hidden;
    }

    .calendar-shortcuts {
        padding: 10px 0;
        font-size: 0.75rem;
        line-height: 0.75rem;
    }

    .calendar-shortcuts a {
        margin: 0 4px;
    }

    .timelist a {
        background: var(--body-bg);
        padding: 4px;
    }

    .calendar-cancel {
        padding: 8px 10px;
    }

    .clockbox h2 {
        padding: 8px 15px;
    }

    .calendar caption {
        padding: 10px;
    }

    .calendarbox .calendarnav-previous, .calendarbox .calendarnav-next {
        z-index: 1;
        top: 10px;
    }

    /* History */

    table#change-history tbody th, table#change-history tbody td {
        font-size: 0.8125rem;
        word-break: break-word;
    }

    table#change-history tbody th {
        width: auto;
    }

    /* Docs */

    table.model tbody th, table.model tbody td {
        font-size: 0.8125rem;
        word-break: break-word;
    }
}



========== staticfiles/admin/css/responsive_rtl.css ==========
/* TABLETS */

@media (max-width: 1024px) {
    [dir="rtl"] .colMS {
        margin-right: 0;
    }

    [dir="rtl"] #user-tools {
        text-align: right;
    }

    [dir="rtl"] #changelist .actions label {
        padding-left: 10px;
        padding-right: 0;
    }

    [dir="rtl"] #changelist .actions select {
        margin-left: 0;
        margin-right: 15px;
    }

    [dir="rtl"] .change-list .filtered .results,
    [dir="rtl"] .change-list .filtered .paginator,
    [dir="rtl"] .filtered #toolbar,
    [dir="rtl"] .filtered div.xfull,
    [dir="rtl"] .filtered .actions,
    [dir="rtl"] #changelist-filter {
        margin-left: 0;
    }

    [dir="rtl"] .inline-group div.add-row a,
    [dir="rtl"] .inline-group .tabular tr.add-row td a {
        padding: 8px 26px 8px 10px;
        background-position: calc(100% - 8px) 9px;
    }

    [dir="rtl"] .dashboard .module table td a {
        padding-left: 0;
        padding-right: 16px;
    }

    [dir="rtl"] ul.messagelist li {
        padding: 10px 55px 10px 10px;
        background-position-x: calc(100% - 30px);
    }
}

/* MOBILE */

@media (max-width: 767px) {
    [dir="rtl"] .aligned .related-lookup,
    [dir="rtl"] .aligned .datetimeshortcuts {
        margin-left: 0;
        margin-right: 15px;
    }

    [dir="rtl"] .aligned ul,
    [dir="rtl"] form .aligned ul.errorlist {
        margin-right: 0;
    }

    [dir="rtl"] #changelist-filter {
        margin-left: 0;
        margin-right: 0;
    }

    [dir="rtl"] .object-tools {
        text-align: right;
    }

    [dir="rtl"] .aligned .vCheckboxLabel {
        padding: 1px 5px 0 0;
    }

    [dir="rtl"] .selector-remove {
        background-position: 0 0;
    }

    [dir="rtl"] :enabled.selector-remove:focus, :enabled.selector-remove:hover {
        background-position: 0 -24px;
    }

    [dir="rtl"] .selector-add  {
        background-position: 0 -48px;
    }

    [dir="rtl"] :enabled.selector-add:focus, :enabled.selector-add:hover {
        background-position: 0 -72px;
    }

    [dir="rtl"] ul.messagelist li {
        padding: 10px 40px 10px 10px;
        background-position-x: calc(100% - 15px);
    }
}



========== staticfiles/admin/css/nav_sidebar.css ==========
.sticky {
    position: sticky;
    top: 0;
    max-height: 100vh;
}

.toggle-nav-sidebar {
    z-index: 20;
    left: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 0 0 23px;
    width: 23px;
    border: 0;
    border-right: 1px solid var(--hairline-color);
    background-color: var(--body-bg);
    cursor: pointer;
    font-size: 1.25rem;
    color: var(--link-fg);
    padding: 0;
}

[dir="rtl"] .toggle-nav-sidebar {
    border-left: 1px solid var(--hairline-color);
    border-right: 0;
}

.toggle-nav-sidebar:hover,
.toggle-nav-sidebar:focus {
    background-color: var(--darkened-bg);
}

#nav-sidebar {
    z-index: 15;
    flex: 0 0 275px;
    left: -276px;
    margin-left: -276px;
    border-top: 1px solid transparent;
    border-right: 1px solid var(--hairline-color);
    background-color: var(--body-bg);
    overflow: auto;
}

[dir="rtl"] #nav-sidebar {
    border-left: 1px solid var(--hairline-color);
    border-right: 0;
    left: 0;
    margin-left: 0;
    right: -276px;
    margin-right: -276px;
}

.toggle-nav-sidebar::before {
    content: '\00BB';
}

.main.shifted .toggle-nav-sidebar::before {
    content: '\00AB';
}

.main > #nav-sidebar {
    visibility: hidden;
}

.main.shifted > #nav-sidebar {
    margin-left: 0;
    visibility: visible;
}

[dir="rtl"] .main.shifted > #nav-sidebar {
    margin-right: 0;
}

#nav-sidebar .module th {
    width: 100%;
    overflow-wrap: anywhere;
}

#nav-sidebar .module th,
#nav-sidebar .module caption {
    padding-left: 16px;
}

#nav-sidebar .module td {
    white-space: nowrap;
}

[dir="rtl"] #nav-sidebar .module th,
[dir="rtl"] #nav-sidebar .module caption {
    padding-left: 8px;
    padding-right: 16px;
}

#nav-sidebar .current-app .section:link,
#nav-sidebar .current-app .section:visited {
    color: var(--header-color);
    font-weight: bold;
}

#nav-sidebar .current-model {
    background: var(--selected-row);
}

@media (forced-colors: active) {
    #nav-sidebar .current-model {
        background-color: SelectedItem;
    }
}

.main > #nav-sidebar + .content {
    max-width: calc(100% - 23px);
}

.main.shifted > #nav-sidebar + .content {
    max-width: calc(100% - 299px);
}

@media (max-width: 767px) {
    #nav-sidebar, #toggle-nav-sidebar {
        display: none;
    }

    .main > #nav-sidebar + .content,
    .main.shifted > #nav-sidebar + .content {
        max-width: 100%;
    }
}

#nav-filter {
    width: 100%;
    box-sizing: border-box;
    padding: 2px 5px;
    margin: 5px 0;
    border: 1px solid var(--border-color);
    background-color: var(--darkened-bg);
    color: var(--body-fg);
}

#nav-filter:focus {
    border-color: var(--body-quiet-color);
}

#nav-filter.no-results {
    background: var(--message-error-bg);
}

#nav-sidebar table {
    width: 100%;
}



========== staticfiles/admin/css/autocomplete.css ==========
select.admin-autocomplete {
    width: 20em;
}

.select2-container--admin-autocomplete.select2-container {
    min-height: 30px;
}

.select2-container--admin-autocomplete .select2-selection--single,
.select2-container--admin-autocomplete .select2-selection--multiple {
    min-height: 30px;
    padding: 0;
}

.select2-container--admin-autocomplete.select2-container--focus .select2-selection,
.select2-container--admin-autocomplete.select2-container--open .select2-selection {
    border-color: var(--body-quiet-color);
    min-height: 30px;
}

.select2-container--admin-autocomplete.select2-container--focus .select2-selection.select2-selection--single,
.select2-container--admin-autocomplete.select2-container--open .select2-selection.select2-selection--single {
    padding: 0;
}

.select2-container--admin-autocomplete.select2-container--focus .select2-selection.select2-selection--multiple,
.select2-container--admin-autocomplete.select2-container--open .select2-selection.select2-selection--multiple {
    padding: 0;
}

.select2-container--admin-autocomplete .select2-selection--single {
    background-color: var(--body-bg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
}

.select2-container--admin-autocomplete .select2-selection--single .select2-selection__rendered {
    color: var(--body-fg);
    line-height: 30px;
}

.select2-container--admin-autocomplete .select2-selection--single .select2-selection__clear {
    cursor: pointer;
    float: right;
    font-weight: bold;
}

.select2-container--admin-autocomplete .select2-selection--single .select2-selection__placeholder {
    color: var(--body-quiet-color);
}

.select2-container--admin-autocomplete .select2-selection--single .select2-selection__arrow {
    height: 26px;
    position: absolute;
    top: 1px;
    right: 1px;
    width: 20px;
}

.select2-container--admin-autocomplete .select2-selection--single .select2-selection__arrow b {
    border-color: #888 transparent transparent transparent;
    border-style: solid;
    border-width: 5px 4px 0 4px;
    height: 0;
    left: 50%;
    margin-left: -4px;
    margin-top: -2px;
    position: absolute;
    top: 50%;
    width: 0;
}

.select2-container--admin-autocomplete[dir="rtl"] .select2-selection--single .select2-selection__clear {
    float: left;
}

.select2-container--admin-autocomplete[dir="rtl"] .select2-selection--single .select2-selection__arrow {
    left: 1px;
    right: auto;
}

.select2-container--admin-autocomplete.select2-container--disabled .select2-selection--single {
    background-color: var(--darkened-bg);
    cursor: default;
}

.select2-container--admin-autocomplete.select2-container--disabled .select2-selection--single .select2-selection__clear {
    display: none;
}

.select2-container--admin-autocomplete.select2-container--open .select2-selection--single .select2-selection__arrow b {
    border-color: transparent transparent #888 transparent;
    border-width: 0 4px 5px 4px;
}

.select2-container--admin-autocomplete .select2-selection--multiple {
    background-color: var(--body-bg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: text;
}

.select2-container--admin-autocomplete .select2-selection--multiple .select2-selection__rendered {
    box-sizing: border-box;
    list-style: none;
    margin: 0;
    padding: 0 10px 5px 5px;
    width: 100%;
    display: flex;
    flex-wrap: wrap;
}

.select2-container--admin-autocomplete .select2-selection--multiple .select2-selection__rendered li {
    list-style: none;
}

.select2-container--admin-autocomplete .select2-selection--multiple .select2-selection__placeholder {
    color: var(--body-quiet-color);
    margin-top: 5px;
    float: left;
}

.select2-container--admin-autocomplete .select2-selection--multiple .select2-selection__clear {
    cursor: pointer;
    float: right;
    font-weight: bold;
    margin: 5px;
    position: absolute;
    right: 0;
}

.select2-container--admin-autocomplete .select2-selection--multiple .select2-selection__choice {
    background-color: var(--darkened-bg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: default;
    float: left;
    margin-right: 5px;
    margin-top: 5px;
    padding: 0 5px;
}

.select2-container--admin-autocomplete .select2-selection--multiple .select2-selection__choice__remove {
    color: var(--body-quiet-color);
    cursor: pointer;
    display: inline-block;
    font-weight: bold;
    margin-right: 2px;
}

.select2-container--admin-autocomplete .select2-selection--multiple .select2-selection__choice__remove:hover {
    color: var(--body-fg);
}

.select2-container--admin-autocomplete[dir="rtl"] .select2-selection--multiple .select2-selection__choice, .select2-container--admin-autocomplete[dir="rtl"] .select2-selection--multiple .select2-selection__placeholder, .select2-container--admin-autocomplete[dir="rtl"] .select2-selection--multiple .select2-search--inline {
    float: right;
}

.select2-container--admin-autocomplete[dir="rtl"] .select2-selection--multiple .select2-selection__choice {
    margin-left: 5px;
    margin-right: auto;
}

.select2-container--admin-autocomplete[dir="rtl"] .select2-selection--multiple .select2-selection__choice__remove {
    margin-left: 2px;
    margin-right: auto;
}

.select2-container--admin-autocomplete.select2-container--focus .select2-selection--multiple {
    border: solid var(--body-quiet-color) 1px;
    outline: 0;
}

.select2-container--admin-autocomplete.select2-container--disabled .select2-selection--multiple {
    background-color: var(--darkened-bg);
    cursor: default;
}

.select2-container--admin-autocomplete.select2-container--disabled .select2-selection__choice__remove {
    display: none;
}

.select2-container--admin-autocomplete.select2-container--open.select2-container--above .select2-selection--single, .select2-container--admin-autocomplete.select2-container--open.select2-container--above .select2-selection--multiple {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}

.select2-container--admin-autocomplete.select2-container--open.select2-container--below .select2-selection--single, .select2-container--admin-autocomplete.select2-container--open.select2-container--below .select2-selection--multiple {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
}

.select2-container--admin-autocomplete .select2-search--dropdown {
    background: var(--darkened-bg);
}

.select2-container--admin-autocomplete .select2-search--dropdown .select2-search__field {
    background: var(--body-bg);
    color: var(--body-fg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
}

.select2-container--admin-autocomplete .select2-search--inline .select2-search__field {
    background: transparent;
    color: var(--body-fg);
    border: none;
    outline: 0;
    box-shadow: none;
    -webkit-appearance: textfield;
}

.select2-container--admin-autocomplete .select2-results > .select2-results__options {
    max-height: 200px;
    overflow-y: auto;
    color: var(--body-fg);
    background: var(--body-bg);
}

.select2-container--admin-autocomplete .select2-results__option[role=group] {
    padding: 0;
}

.select2-container--admin-autocomplete .select2-results__option[aria-disabled=true] {
    color: var(--body-quiet-color);
}

.select2-container--admin-autocomplete .select2-results__option[aria-selected=true] {
    background-color: var(--selected-bg);
    color: var(--body-fg);
}

.select2-container--admin-autocomplete .select2-results__option .select2-results__option {
    padding-left: 1em;
}

.select2-container--admin-autocomplete .select2-results__option .select2-results__option .select2-results__group {
    padding-left: 0;
}

.select2-container--admin-autocomplete .select2-results__option .select2-results__option .select2-results__option {
    margin-left: -1em;
    padding-left: 2em;
}

.select2-container--admin-autocomplete .select2-results__option .select2-results__option .select2-results__option .select2-results__option {
    margin-left: -2em;
    padding-left: 3em;
}

.select2-container--admin-autocomplete .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option {
    margin-left: -3em;
    padding-left: 4em;
}

.select2-container--admin-autocomplete .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option {
    margin-left: -4em;
    padding-left: 5em;
}

.select2-container--admin-autocomplete .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option .select2-results__option {
    margin-left: -5em;
    padding-left: 6em;
}

.select2-container--admin-autocomplete .select2-results__option--highlighted[aria-selected] {
    background-color: var(--primary);
    color: var(--primary-fg);
}

.select2-container--admin-autocomplete .select2-results__group {
    cursor: default;
    display: block;
    padding: 6px;
}

.errors .select2-selection {
    border: 1px solid var(--error-fg);
}



========== staticfiles/admin/js/nav_sidebar.js ==========
'use strict';
{
    const toggleNavSidebar = document.getElementById('toggle-nav-sidebar');
    if (toggleNavSidebar !== null) {
        const navSidebar = document.getElementById('nav-sidebar');
        const main = document.getElementById('main');
        let navSidebarIsOpen = localStorage.getItem('django.admin.navSidebarIsOpen');
        if (navSidebarIsOpen === null) {
            navSidebarIsOpen = 'true';
        }
        main.classList.toggle('shifted', navSidebarIsOpen === 'true');
        navSidebar.setAttribute('aria-expanded', navSidebarIsOpen);

        toggleNavSidebar.addEventListener('click', function() {
            if (navSidebarIsOpen === 'true') {
                navSidebarIsOpen = 'false';
            } else {
                navSidebarIsOpen = 'true';
            }
            localStorage.setItem('django.admin.navSidebarIsOpen', navSidebarIsOpen);
            main.classList.toggle('shifted');
            navSidebar.setAttribute('aria-expanded', navSidebarIsOpen);
        });
    }

    function initSidebarQuickFilter() {
        const options = [];
        const navSidebar = document.getElementById('nav-sidebar');
        if (!navSidebar) {
            return;
        }
        navSidebar.querySelectorAll('th[scope=row] a').forEach((container) => {
            options.push({title: container.innerHTML, node: container});
        });

        function checkValue(event) {
            let filterValue = event.target.value;
            if (filterValue) {
                filterValue = filterValue.toLowerCase();
            }
            if (event.key === 'Escape') {
                filterValue = '';
                event.target.value = ''; // clear input
            }
            let matches = false;
            for (const o of options) {
                let displayValue = '';
                if (filterValue) {
                    if (o.title.toLowerCase().indexOf(filterValue) === -1) {
                        displayValue = 'none';
                    } else {
                        matches = true;
                    }
                }
                // show/hide parent <TR>
                o.node.parentNode.parentNode.style.display = displayValue;
            }
            if (!filterValue || matches) {
                event.target.classList.remove('no-results');
            } else {
                event.target.classList.add('no-results');
            }
            sessionStorage.setItem('django.admin.navSidebarFilterValue', filterValue);
        }

        const nav = document.getElementById('nav-filter');
        nav.addEventListener('change', checkValue, false);
        nav.addEventListener('input', checkValue, false);
        nav.addEventListener('keyup', checkValue, false);

        const storedValue = sessionStorage.getItem('django.admin.navSidebarFilterValue');
        if (storedValue) {
            nav.value = storedValue;
            checkValue({target: nav, key: ''});
        }
    }
    window.initSidebarQuickFilter = initSidebarQuickFilter;
    initSidebarQuickFilter();
}



========== staticfiles/admin/js/inlines.js ==========
/*global DateTimeShortcuts, SelectFilter*/
/**
 * Django admin inlines
 *
 * Based on jQuery Formset 1.1
 * @author Stanislaus Madueke (stan DOT madueke AT gmail DOT com)
 * @requires jQuery 1.2.6 or later
 *
 * Copyright (c) 2009, Stanislaus Madueke
 * All rights reserved.
 *
 * Spiced up with Code from Zain Memon's GSoC project 2009
 * and modified for Django by Jannis Leidel, Travis Swicegood and Julien Phalip.
 *
 * Licensed under the New BSD License
 * See: https://opensource.org/licenses/bsd-license.php
 */
'use strict';
{
    const $ = django.jQuery;
    $.fn.formset = function(opts) {
        const options = $.extend({}, $.fn.formset.defaults, opts);
        const $this = $(this);
        const $parent = $this.parent();
        const updateElementIndex = function(el, prefix, ndx) {
            const id_regex = new RegExp("(" + prefix + "-(\\d+|__prefix__))");
            const replacement = prefix + "-" + ndx;
            if ($(el).prop("for")) {
                $(el).prop("for", $(el).prop("for").replace(id_regex, replacement));
            }
            if (el.id) {
                el.id = el.id.replace(id_regex, replacement);
            }
            if (el.name) {
                el.name = el.name.replace(id_regex, replacement);
            }
        };
        const totalForms = $("#id_" + options.prefix + "-TOTAL_FORMS").prop("autocomplete", "off");
        let nextIndex = parseInt(totalForms.val(), 10);
        const maxForms = $("#id_" + options.prefix + "-MAX_NUM_FORMS").prop("autocomplete", "off");
        const minForms = $("#id_" + options.prefix + "-MIN_NUM_FORMS").prop("autocomplete", "off");
        let addButton;

        /**
         * The "Add another MyModel" button below the inline forms.
         */
        const addInlineAddButton = function() {
            if (addButton === null) {
                if ($this.prop("tagName") === "TR") {
                    // If forms are laid out as table rows, insert the
                    // "add" button in a new table row:
                    const numCols = $this.eq(-1).children().length;
                    $parent.append('<tr class="' + options.addCssClass + '"><td colspan="' + numCols + '"><a role="button" class="addlink" href="#">' + options.addText + "</a></tr>");
                    addButton = $parent.find("tr:last a");
                } else {
                    // Otherwise, insert it immediately after the last form:
                    $this.filter(":last").after('<div class="' + options.addCssClass + '"><a role="button" class="addlink" href="#">' + options.addText + "</a></div>");
                    addButton = $this.filter(":last").next().find("a");
                }
            }
            addButton.on('click', addInlineClickHandler);
        };

        const addInlineClickHandler = function(e) {
            e.preventDefault();
            const template = $("#" + options.prefix + "-empty");
            const row = template.clone(true);
            row.removeClass(options.emptyCssClass)
                .addClass(options.formCssClass)
                .attr("id", options.prefix + "-" + nextIndex);
            addInlineDeleteButton(row);
            row.find("*").each(function() {
                updateElementIndex(this, options.prefix, totalForms.val());
            });
            // Insert the new form when it has been fully edited.
            row.insertBefore($(template));
            // Update number of total forms.
            $(totalForms).val(parseInt(totalForms.val(), 10) + 1);
            nextIndex += 1;
            // Hide the add button if there's a limit and it's been reached.
            if ((maxForms.val() !== '') && (maxForms.val() - totalForms.val()) <= 0) {
                addButton.parent().hide();
            }
            // Show the remove buttons if there are more than min_num.
            toggleDeleteButtonVisibility(row.closest('.inline-group'));

            // Pass the new form to the post-add callback, if provided.
            if (options.added) {
                options.added(row);
            }
            row.get(0).dispatchEvent(new CustomEvent("formset:added", {
                bubbles: true,
                detail: {
                    formsetName: options.prefix
                }
            }));
        };

        /**
         * The "X" button that is part of every unsaved inline.
         * (When saved, it is replaced with a "Delete" checkbox.)
         */
        const addInlineDeleteButton = function(row) {
            if (row.is("tr")) {
                // If the forms are laid out in table rows, insert
                // the remove button into the last table cell:
                row.children(":last").append('<div><a role="button" class="' + options.deleteCssClass + '" href="#">' + options.deleteText + "</a></div>");
            } else if (row.is("ul") || row.is("ol")) {
                // If they're laid out as an ordered/unordered list,
                // insert an <li> after the last list item:
                row.append('<li><a role="button" class="' + options.deleteCssClass + '" href="#">' + options.deleteText + "</a></li>");
            } else {
                // Otherwise, just insert the remove button as the
                // last child element of the form's container:
                row.children(":first").append('<span><a role="button" class="' + options.deleteCssClass + '" href="#">' + options.deleteText + "</a></span>");
            }
            // Add delete handler for each row.
            row.find("a." + options.deleteCssClass).on('click', inlineDeleteHandler.bind(this));
        };

        const inlineDeleteHandler = function(e1) {
            e1.preventDefault();
            const deleteButton = $(e1.target);
            const row = deleteButton.closest('.' + options.formCssClass);
            const inlineGroup = row.closest('.inline-group');
            // Remove the parent form containing this button,
            // and also remove the relevant row with non-field errors:
            const prevRow = row.prev();
            if (prevRow.length && prevRow.hasClass('row-form-errors')) {
                prevRow.remove();
            }
            row.remove();
            nextIndex -= 1;
            // Pass the deleted form to the post-delete callback, if provided.
            if (options.removed) {
                options.removed(row);
            }
            document.dispatchEvent(new CustomEvent("formset:removed", {
                detail: {
                    formsetName: options.prefix
                }
            }));
            // Update the TOTAL_FORMS form count.
            const forms = $("." + options.formCssClass);
            $("#id_" + options.prefix + "-TOTAL_FORMS").val(forms.length);
            // Show add button again once below maximum number.
            if ((maxForms.val() === '') || (maxForms.val() - forms.length) > 0) {
                addButton.parent().show();
            }
            // Hide the remove buttons if at min_num.
            toggleDeleteButtonVisibility(inlineGroup);
            // Also, update names and ids for all remaining form controls so
            // they remain in sequence:
            let i, formCount;
            const updateElementCallback = function() {
                updateElementIndex(this, options.prefix, i);
            };
            for (i = 0, formCount = forms.length; i < formCount; i++) {
                updateElementIndex($(forms).get(i), options.prefix, i);
                $(forms.get(i)).find("*").each(updateElementCallback);
            }
        };

        const toggleDeleteButtonVisibility = function(inlineGroup) {
            if ((minForms.val() !== '') && (minForms.val() - totalForms.val()) >= 0) {
                inlineGroup.find('.inline-deletelink').hide();
            } else {
                inlineGroup.find('.inline-deletelink').show();
            }
        };

        $this.each(function(i) {
            $(this).not("." + options.emptyCssClass).addClass(options.formCssClass);
        });

        // Create the delete buttons for all unsaved inlines:
        $this.filter('.' + options.formCssClass + ':not(.has_original):not(.' + options.emptyCssClass + ')').each(function() {
            addInlineDeleteButton($(this));
        });
        toggleDeleteButtonVisibility($this);

        // Create the add button, initially hidden.
        addButton = options.addButton;
        addInlineAddButton();

        // Show the add button if allowed to add more items.
        // Note that max_num = None translates to a blank string.
        const showAddButton = maxForms.val() === '' || (maxForms.val() - totalForms.val()) > 0;
        if ($this.length && showAddButton) {
            addButton.parent().show();
        } else {
            addButton.parent().hide();
        }

        return this;
    };

    /* Setup plugin defaults */
    $.fn.formset.defaults = {
        prefix: "form", // The form prefix for your django formset
        addText: "add another", // Text for the add link
        deleteText: "remove", // Text for the delete link
        addCssClass: "add-row", // CSS class applied to the add link
        deleteCssClass: "delete-row", // CSS class applied to the delete link
        emptyCssClass: "empty-row", // CSS class applied to the empty row
        formCssClass: "dynamic-form", // CSS class applied to each form in a formset
        added: null, // Function called each time a new form is added
        removed: null, // Function called each time a form is deleted
        addButton: null // Existing add button to use
    };


    // Tabular inlines ---------------------------------------------------------
    $.fn.tabularFormset = function(selector, options) {
        const $rows = $(this);

        const reinitDateTimeShortCuts = function() {
            // Reinitialize the calendar and clock widgets by force
            if (typeof DateTimeShortcuts !== "undefined") {
                $(".datetimeshortcuts").remove();
                DateTimeShortcuts.init();
            }
        };

        const updateSelectFilter = function() {
            // If any SelectFilter widgets are a part of the new form,
            // instantiate a new SelectFilter instance for it.
            if (typeof SelectFilter !== 'undefined') {
                $('.selectfilter').each(function(index, value) {
                    SelectFilter.init(value.id, this.dataset.fieldName, false);
                });
                $('.selectfilterstacked').each(function(index, value) {
                    SelectFilter.init(value.id, this.dataset.fieldName, true);
                });
            }
        };

        const initPrepopulatedFields = function(row) {
            row.find('.prepopulated_field').each(function() {
                const field = $(this),
                    input = field.find('input, select, textarea'),
                    dependency_list = input.data('dependency_list') || [],
                    dependencies = [];
                $.each(dependency_list, function(i, field_name) {
                    dependencies.push('#' + row.find('.field-' + field_name).find('input, select, textarea').attr('id'));
                });
                if (dependencies.length) {
                    input.prepopulate(dependencies, input.attr('maxlength'));
                }
            });
        };

        $rows.formset({
            prefix: options.prefix,
            addText: options.addText,
            formCssClass: "dynamic-" + options.prefix,
            deleteCssClass: "inline-deletelink",
            deleteText: options.deleteText,
            emptyCssClass: "empty-form",
            added: function(row) {
                initPrepopulatedFields(row);
                reinitDateTimeShortCuts();
                updateSelectFilter();
            },
            addButton: options.addButton
        });

        return $rows;
    };

    // Stacked inlines ---------------------------------------------------------
    $.fn.stackedFormset = function(selector, options) {
        const $rows = $(this);
        const updateInlineLabel = function(row) {
            $(selector).find(".inline_label").each(function(i) {
                const count = i + 1;
                $(this).html($(this).html().replace(/(#\d+)/g, "#" + count));
            });
        };

        const reinitDateTimeShortCuts = function() {
            // Reinitialize the calendar and clock widgets by force, yuck.
            if (typeof DateTimeShortcuts !== "undefined") {
                $(".datetimeshortcuts").remove();
                DateTimeShortcuts.init();
            }
        };

        const updateSelectFilter = function() {
            // If any SelectFilter widgets were added, instantiate a new instance.
            if (typeof SelectFilter !== "undefined") {
                $(".selectfilter").each(function(index, value) {
                    SelectFilter.init(value.id, this.dataset.fieldName, false);
                });
                $(".selectfilterstacked").each(function(index, value) {
                    SelectFilter.init(value.id, this.dataset.fieldName, true);
                });
            }
        };

        const initPrepopulatedFields = function(row) {
            row.find('.prepopulated_field').each(function() {
                const field = $(this),
                    input = field.find('input, select, textarea'),
                    dependency_list = input.data('dependency_list') || [],
                    dependencies = [];
                $.each(dependency_list, function(i, field_name) {
                    // Dependency in a fieldset.
                    let field_element = row.find('.form-row .field-' + field_name);
                    // Dependency without a fieldset.
                    if (!field_element.length) {
                        field_element = row.find('.form-row.field-' + field_name);
                    }
                    dependencies.push('#' + field_element.find('input, select, textarea').attr('id'));
                });
                if (dependencies.length) {
                    input.prepopulate(dependencies, input.attr('maxlength'));
                }
            });
        };

        $rows.formset({
            prefix: options.prefix,
            addText: options.addText,
            formCssClass: "dynamic-" + options.prefix,
            deleteCssClass: "inline-deletelink",
            deleteText: options.deleteText,
            emptyCssClass: "empty-form",
            removed: updateInlineLabel,
            added: function(row) {
                initPrepopulatedFields(row);
                reinitDateTimeShortCuts();
                updateSelectFilter();
                updateInlineLabel(row);
            },
            addButton: options.addButton
        });

        return $rows;
    };

    $(document).ready(function() {
        $(".js-inline-admin-formset").each(function() {
            const data = $(this).data(),
                inlineOptions = data.inlineFormset;
            let selector;
            switch(data.inlineType) {
            case "stacked":
                selector = inlineOptions.name + "-group .inline-related";
                $(selector).stackedFormset(selector, inlineOptions.options);
                break;
            case "tabular":
                selector = inlineOptions.name + "-group .tabular.inline-related tbody:first > tr.form-row";
                $(selector).tabularFormset(selector, inlineOptions.options);
                break;
            }
        });
    });
}



========== staticfiles/admin/js/prepopulate_init.js ==========
'use strict';
{
    const $ = django.jQuery;
    const fields = $('#django-admin-prepopulated-fields-constants').data('prepopulatedFields');
    $.each(fields, function(index, field) {
        $(
            '.empty-form .form-row .field-' + field.name +
            ', .empty-form.form-row .field-' + field.name +
            ', .empty-form .form-row.field-' + field.name
        ).addClass('prepopulated_field');
        $(field.id).data('dependency_list', field.dependency_list).prepopulate(
            field.dependency_ids, field.maxLength, field.allowUnicode
        );
    });
}



========== staticfiles/admin/js/autocomplete.js ==========
'use strict';
{
    const $ = django.jQuery;

    $.fn.djangoAdminSelect2 = function() {
        $.each(this, function(i, element) {
            $(element).select2({
                ajax: {
                    data: (params) => {
                        return {
                            term: params.term,
                            page: params.page,
                            app_label: element.dataset.appLabel,
                            model_name: element.dataset.modelName,
                            field_name: element.dataset.fieldName
                        };
                    }
                }
            });
        });
        return this;
    };

    $(function() {
        // Initialize all autocomplete widgets except the one in the template
        // form used when a new formset is added.
        $('.admin-autocomplete').not('[name*=__prefix__]').djangoAdminSelect2();
    });

    document.addEventListener('formset:added', (event) => {
        $(event.target).find('.admin-autocomplete').djangoAdminSelect2();
    });
}



========== staticfiles/admin/js/change_form.js ==========
'use strict';
{
    const inputTags = ['BUTTON', 'INPUT', 'SELECT', 'TEXTAREA'];
    const modelName = document.getElementById('django-admin-form-add-constants').dataset.modelName;
    if (modelName) {
        const form = document.getElementById(modelName + '_form');
        for (const element of form.elements) {
            // HTMLElement.offsetParent returns null when the element is not
            // rendered.
            if (inputTags.includes(element.tagName) && !element.disabled && element.offsetParent) {
                element.focus();
                break;
            }
        }
    }
}



========== staticfiles/admin/js/SelectFilter2.js ==========
/*global SelectBox, gettext, ngettext, interpolate, quickElement, SelectFilter*/
/*
SelectFilter2 - Turns a multiple-select box into a filter interface.

Requires core.js and SelectBox.js.
*/
'use strict';
{
    window.SelectFilter = {
        init: function(field_id, field_name, is_stacked) {
            if (field_id.match(/__prefix__/)) {
                // Don't initialize on empty forms.
                return;
            }
            const from_box = document.getElementById(field_id);
            from_box.id += '_from'; // change its ID
            from_box.className = 'filtered';
            from_box.setAttribute('aria-labelledby', field_id + '_from_label');
            from_box.setAttribute('aria-describedby', `${field_id}_helptext ${field_id}_choose_helptext`);

            for (const p of from_box.parentNode.getElementsByTagName('p')) {
                if (p.classList.contains("info")) {
                    // Remove <p class="info">, because it just gets in the way.
                    from_box.parentNode.removeChild(p);
                } else if (p.classList.contains("help")) {
                    // Move help text up to the top so it isn't below the select
                    // boxes or wrapped off on the side to the right of the add
                    // button:
                    from_box.parentNode.insertBefore(p, from_box.parentNode.firstChild);
                }
            }

            // <div class="selector"> or <div class="selector stacked">
            const selector_div = quickElement('div', from_box.parentNode);
            // Make sure the selector div is at the beginning so that the
            // add link would be displayed to the right of the widget.
            from_box.parentNode.prepend(selector_div);
            selector_div.className = is_stacked ? 'selector stacked' : 'selector';

            // <div class="selector-available">
            const selector_available = quickElement('div', selector_div);
            selector_available.className = 'selector-available';
            const selector_available_title = quickElement('div', selector_available);
            selector_available_title.id = field_id + '_from_title';
            selector_available_title.className = 'selector-available-title';
            quickElement(
                'label',
                selector_available_title,
                interpolate(gettext('Available %s') + ' ', [field_name]),
                'id',
                field_id + '_from_label',
                'for',
                field_id + '_from'
            );
            quickElement(
                'p',
                selector_available_title,
                interpolate(gettext('Choose %s by selecting them and then select the "Choose" arrow button.'), [field_name]),
                'id', `${field_id}_choose_helptext`, 'class', 'helptext'
            );

            const filter_p = quickElement('p', selector_available, '', 'id', field_id + '_filter');
            filter_p.className = 'selector-filter';

            const search_filter_label = quickElement('label', filter_p, '', 'for', field_id + '_input');

            quickElement(
                'span', search_filter_label, '',
                'class', 'help-tooltip search-label-icon',
                'aria-label', interpolate(gettext("Type into this box to filter down the list of available %s."), [field_name])
            );

            filter_p.appendChild(document.createTextNode(' '));

            const filter_input = quickElement('input', filter_p, '', 'type', 'text', 'placeholder', gettext("Filter"));
            filter_input.id = field_id + '_input';

            selector_available.appendChild(from_box);
            const choose_all = quickElement(
                'button',
                selector_available,
                interpolate(gettext('Choose all %s'), [field_name]),
                'id', field_id + '_add_all',
                'class', 'selector-chooseall',
                'type', 'button'
            );

            // <ul class="selector-chooser">
            const selector_chooser = quickElement('ul', selector_div);
            selector_chooser.className = 'selector-chooser';
            const add_button = quickElement(
                'button',
                quickElement('li', selector_chooser),
                interpolate(gettext('Choose selected %s'), [field_name]),
                'id', field_id + '_add',
                'class', 'selector-add',
                'type', 'button'
            );
            const remove_button = quickElement(
                'button',
                quickElement('li', selector_chooser),
                interpolate(gettext('Remove selected %s'), [field_name]),
                'id', field_id + '_remove',
                'class', 'selector-remove',
                'type', 'button'
            );

            // <div class="selector-chosen">
            const selector_chosen = quickElement('div', selector_div, '', 'id', field_id + '_selector_chosen');
            selector_chosen.className = 'selector-chosen';
            const selector_chosen_title = quickElement('div', selector_chosen);
            selector_chosen_title.className = 'selector-chosen-title';
            selector_chosen_title.id = field_id + '_to_title';
            quickElement(
                'label',
                selector_chosen_title,
                interpolate(gettext('Chosen %s') + ' ', [field_name]),
                'id',
                field_id + '_to_label',
                'for',
                field_id + '_to'
            );
            quickElement(
                'p',
                selector_chosen_title,
                interpolate(gettext('Remove %s by selecting them and then select the "Remove" arrow button.'), [field_name]),
                'id', `${field_id}_remove_helptext`, 'class', 'helptext'
            );
            
            const filter_selected_p = quickElement('p', selector_chosen, '', 'id', field_id + '_filter_selected');
            filter_selected_p.className = 'selector-filter';

            const search_filter_selected_label = quickElement('label', filter_selected_p, '', 'for', field_id + '_selected_input');

            quickElement(
                'span', search_filter_selected_label, '',
                'class', 'help-tooltip search-label-icon',
                'aria-label', interpolate(gettext("Type into this box to filter down the list of selected %s."), [field_name])
            );

            filter_selected_p.appendChild(document.createTextNode(' '));

            const filter_selected_input = quickElement('input', filter_selected_p, '', 'type', 'text', 'placeholder', gettext("Filter"));
            filter_selected_input.id = field_id + '_selected_input';

            quickElement(
                'select',
                selector_chosen,
                '',
                'id', field_id + '_to',
                'multiple', '',
                'size', from_box.size,
                'name', from_box.name,
                'aria-labelledby', field_id + '_to_label',
                'aria-describedby', `${field_id}_helptext ${field_id}_remove_helptext`,
                'class', 'filtered'
            );
            const warning_footer = quickElement('div', selector_chosen, '', 'class', 'list-footer-display');
            quickElement('span', warning_footer, '', 'id', field_id + '_list-footer-display-text');
            quickElement('span', warning_footer, ' ' + gettext('(click to clear)'), 'class', 'list-footer-display__clear');
            const clear_all = quickElement(
                'button',
                selector_chosen,
                interpolate(gettext('Remove all %s'), [field_name]),
                'id', field_id + '_remove_all',
                'class', 'selector-clearall',
                'type', 'button'
            );

            from_box.name = from_box.name + '_old';

            // Set up the JavaScript event handlers for the select box filter interface
            const move_selection = function(e, elem, move_func, from, to) {
                if (!elem.hasAttribute('disabled')) {
                    move_func(from, to);
                    SelectFilter.refresh_icons(field_id);
                    SelectFilter.refresh_filtered_selects(field_id);
                    SelectFilter.refresh_filtered_warning(field_id);
                }
                e.preventDefault();
            };
            choose_all.addEventListener('click', function(e) {
                move_selection(e, this, SelectBox.move_all, field_id + '_from', field_id + '_to');
            });
            add_button.addEventListener('click', function(e) {
                move_selection(e, this, SelectBox.move, field_id + '_from', field_id + '_to');
            });
            remove_button.addEventListener('click', function(e) {
                move_selection(e, this, SelectBox.move, field_id + '_to', field_id + '_from');
            });
            clear_all.addEventListener('click', function(e) {
                move_selection(e, this, SelectBox.move_all, field_id + '_to', field_id + '_from');
            });
            warning_footer.addEventListener('click', function(e) {
                filter_selected_input.value = '';
                SelectBox.filter(field_id + '_to', '');
                SelectFilter.refresh_filtered_warning(field_id);
                SelectFilter.refresh_icons(field_id);
            });
            filter_input.addEventListener('keypress', function(e) {
                SelectFilter.filter_key_press(e, field_id, '_from', '_to');
            });
            filter_input.addEventListener('keyup', function(e) {
                SelectFilter.filter_key_up(e, field_id, '_from');
            });
            filter_input.addEventListener('keydown', function(e) {
                SelectFilter.filter_key_down(e, field_id, '_from', '_to');
            });
            filter_selected_input.addEventListener('keypress', function(e) {
                SelectFilter.filter_key_press(e, field_id, '_to', '_from');
            });
            filter_selected_input.addEventListener('keyup', function(e) {
                SelectFilter.filter_key_up(e, field_id, '_to', '_selected_input');
            });
            filter_selected_input.addEventListener('keydown', function(e) {
                SelectFilter.filter_key_down(e, field_id, '_to', '_from');
            });
            selector_div.addEventListener('change', function(e) {
                if (e.target.tagName === 'SELECT') {
                    SelectFilter.refresh_icons(field_id);
                }
            });
            selector_div.addEventListener('dblclick', function(e) {
                if (e.target.tagName === 'OPTION') {
                    if (e.target.closest('select').id === field_id + '_to') {
                        SelectBox.move(field_id + '_to', field_id + '_from');
                    } else {
                        SelectBox.move(field_id + '_from', field_id + '_to');
                    }
                    SelectFilter.refresh_icons(field_id);
                }
            });
            from_box.closest('form').addEventListener('submit', function() {
                SelectBox.filter(field_id + '_to', '');
                SelectBox.select_all(field_id + '_to');
            });
            SelectBox.init(field_id + '_from');
            SelectBox.init(field_id + '_to');
            // Move selected from_box options to to_box
            SelectBox.move(field_id + '_from', field_id + '_to');

            // Initial icon refresh
            SelectFilter.refresh_icons(field_id);
        },
        any_selected: function(field) {
            // Temporarily add the required attribute and check validity.
            field.required = true;
            const any_selected = field.checkValidity();
            field.required = false;
            return any_selected;
        },
        refresh_filtered_warning: function(field_id) {
            const count = SelectBox.get_hidden_node_count(field_id + '_to');
            const selector = document.getElementById(field_id + '_selector_chosen');
            const warning = document.getElementById(field_id + '_list-footer-display-text');
            selector.className = selector.className.replace('selector-chosen--with-filtered', '');
            warning.textContent = interpolate(ngettext(
                '%s selected option not visible',
                '%s selected options not visible',
                count
            ), [count]);
            if(count > 0) {
                selector.className += ' selector-chosen--with-filtered';
            }
        },
        refresh_filtered_selects: function(field_id) {
            SelectBox.filter(field_id + '_from', document.getElementById(field_id + "_input").value);
            SelectBox.filter(field_id + '_to', document.getElementById(field_id + "_selected_input").value);
        },
        refresh_icons: function(field_id) {
            const from = document.getElementById(field_id + '_from');
            const to = document.getElementById(field_id + '_to');
            // Disabled if no items are selected.
            document.getElementById(field_id + '_add').disabled = !SelectFilter.any_selected(from);
            document.getElementById(field_id + '_remove').disabled = !SelectFilter.any_selected(to);
            // Disabled if the corresponding box is empty.
            document.getElementById(field_id + '_add_all').disabled = !from.querySelector('option');
            document.getElementById(field_id + '_remove_all').disabled = !to.querySelector('option');
        },
        filter_key_press: function(event, field_id, source, target) {
            const source_box = document.getElementById(field_id + source);
            // don't submit form if user pressed Enter
            if ((event.which && event.which === 13) || (event.keyCode && event.keyCode === 13)) {
                source_box.selectedIndex = 0;
                SelectBox.move(field_id + source, field_id + target);
                source_box.selectedIndex = 0;
                event.preventDefault();
            }
        },
        filter_key_up: function(event, field_id, source, filter_input) {
            const input = filter_input || '_input';
            const source_box = document.getElementById(field_id + source);
            const temp = source_box.selectedIndex;
            SelectBox.filter(field_id + source, document.getElementById(field_id + input).value);
            source_box.selectedIndex = temp;
            SelectFilter.refresh_filtered_warning(field_id);
            SelectFilter.refresh_icons(field_id);
        },
        filter_key_down: function(event, field_id, source, target) {
            const source_box = document.getElementById(field_id + source);
            // right key (39) or left key (37)
            const direction = source === '_from' ? 39 : 37;
            // right arrow -- move across
            if ((event.which && event.which === direction) || (event.keyCode && event.keyCode === direction)) {
                const old_index = source_box.selectedIndex;
                SelectBox.move(field_id + source, field_id + target);
                SelectFilter.refresh_filtered_selects(field_id);
                SelectFilter.refresh_filtered_warning(field_id);
                source_box.selectedIndex = (old_index === source_box.length) ? source_box.length - 1 : old_index;
                return;
            }
            // down arrow -- wrap around
            if ((event.which && event.which === 40) || (event.keyCode && event.keyCode === 40)) {
                source_box.selectedIndex = (source_box.length === source_box.selectedIndex + 1) ? 0 : source_box.selectedIndex + 1;
            }
            // up arrow -- wrap around
            if ((event.which && event.which === 38) || (event.keyCode && event.keyCode === 38)) {
                source_box.selectedIndex = (source_box.selectedIndex === 0) ? source_box.length - 1 : source_box.selectedIndex - 1;
            }
        }
    };

    window.addEventListener('load', function(e) {
        document.querySelectorAll('select.selectfilter, select.selectfilterstacked').forEach(function(el) {
            const data = el.dataset;
            SelectFilter.init(el.id, data.fieldName, parseInt(data.isStacked, 10));
        });
    });
}



========== staticfiles/admin/js/filters.js ==========
/**
 * Persist changelist filters state (collapsed/expanded).
 */
'use strict';
{
    // Init filters.
    let filters = JSON.parse(sessionStorage.getItem('django.admin.filtersState'));

    if (!filters) {
        filters = {};
    }

    Object.entries(filters).forEach(([key, value]) => {
        const detailElement = document.querySelector(`[data-filter-title='${CSS.escape(key)}']`);

        // Check if the filter is present, it could be from other view.
        if (detailElement) {
            value ? detailElement.setAttribute('open', '') : detailElement.removeAttribute('open');
        }
    });

    // Save filter state when clicks.
    const details = document.querySelectorAll('details');
    details.forEach(detail => {
        detail.addEventListener('toggle', event => {
            filters[`${event.target.dataset.filterTitle}`] = detail.open;
            sessionStorage.setItem('django.admin.filtersState', JSON.stringify(filters));
        });
    });
}



========== staticfiles/admin/js/admin/DateTimeShortcuts.js ==========
/*global Calendar, findPosX, findPosY, get_format, gettext, gettext_noop, interpolate, ngettext, quickElement*/
// Inserts shortcut buttons after all of the following:
//     <input type="text" class="vDateField">
//     <input type="text" class="vTimeField">
'use strict';
{
    const DateTimeShortcuts = {
        calendars: [],
        calendarInputs: [],
        clockInputs: [],
        clockHours: {
            default_: [
                [gettext_noop('Now'), -1],
                [gettext_noop('Midnight'), 0],
                [gettext_noop('6 a.m.'), 6],
                [gettext_noop('Noon'), 12],
                [gettext_noop('6 p.m.'), 18]
            ]
        },
        dismissClockFunc: [],
        dismissCalendarFunc: [],
        calendarDivName1: 'calendarbox', // name of calendar <div> that gets toggled
        calendarDivName2: 'calendarin', // name of <div> that contains calendar
        calendarLinkName: 'calendarlink', // name of the link that is used to toggle
        clockDivName: 'clockbox', // name of clock <div> that gets toggled
        clockLinkName: 'clocklink', // name of the link that is used to toggle
        shortCutsClass: 'datetimeshortcuts', // class of the clock and cal shortcuts
        timezoneWarningClass: 'timezonewarning', // class of the warning for timezone mismatch
        timezoneOffset: 0,
        init: function() {
            const serverOffset = document.body.dataset.adminUtcOffset;
            if (serverOffset) {
                const localOffset = new Date().getTimezoneOffset() * -60;
                DateTimeShortcuts.timezoneOffset = localOffset - serverOffset;
            }

            for (const inp of document.getElementsByTagName('input')) {
                if (inp.type === 'text' && inp.classList.contains('vTimeField')) {
                    DateTimeShortcuts.addClock(inp);
                    DateTimeShortcuts.addTimezoneWarning(inp);
                }
                else if (inp.type === 'text' && inp.classList.contains('vDateField')) {
                    DateTimeShortcuts.addCalendar(inp);
                    DateTimeShortcuts.addTimezoneWarning(inp);
                }
            }
        },
        // Return the current time while accounting for the server timezone.
        now: function() {
            const serverOffset = document.body.dataset.adminUtcOffset;
            if (serverOffset) {
                const localNow = new Date();
                const localOffset = localNow.getTimezoneOffset() * -60;
                localNow.setTime(localNow.getTime() + 1000 * (serverOffset - localOffset));
                return localNow;
            } else {
                return new Date();
            }
        },
        // Add a warning when the time zone in the browser and backend do not match.
        addTimezoneWarning: function(inp) {
            const warningClass = DateTimeShortcuts.timezoneWarningClass;
            let timezoneOffset = DateTimeShortcuts.timezoneOffset / 3600;

            // Only warn if there is a time zone mismatch.
            if (!timezoneOffset) {
                return;
            }

            // Check if warning is already there.
            if (inp.parentNode.querySelectorAll('.' + warningClass).length) {
                return;
            }

            let message;
            if (timezoneOffset > 0) {
                message = ngettext(
                    'Note: You are %s hour ahead of server time.',
                    'Note: You are %s hours ahead of server time.',
                    timezoneOffset
                );
            }
            else {
                timezoneOffset *= -1;
                message = ngettext(
                    'Note: You are %s hour behind server time.',
                    'Note: You are %s hours behind server time.',
                    timezoneOffset
                );
            }
            message = interpolate(message, [timezoneOffset]);

            const warning = document.createElement('div');
            const id = inp.id;
            const field_id = inp.closest('p.datetime') ? id.slice(0, id.lastIndexOf("_")) : id;
            warning.classList.add('help', warningClass);
            warning.id = `${field_id}_timezone_warning_helptext`;
            warning.textContent = message;
            inp.parentNode.appendChild(warning);
        },
        // Add clock widget to a given field
        addClock: function(inp) {
            const num = DateTimeShortcuts.clockInputs.length;
            DateTimeShortcuts.clockInputs[num] = inp;
            DateTimeShortcuts.dismissClockFunc[num] = function() { DateTimeShortcuts.dismissClock(num); return true; };

            // Shortcut links (clock icon and "Now" link)
            const shortcuts_span = document.createElement('span');
            shortcuts_span.className = DateTimeShortcuts.shortCutsClass;
            inp.parentNode.insertBefore(shortcuts_span, inp.nextSibling);
            const now_link = document.createElement('a');
            now_link.href = "#";
            now_link.textContent = gettext('Now');
            now_link.role = 'button';
            now_link.addEventListener('click', function(e) {
                e.preventDefault();
                DateTimeShortcuts.handleClockQuicklink(num, -1);
            });
            const clock_link = document.createElement('a');
            clock_link.href = '#';
            clock_link.id = DateTimeShortcuts.clockLinkName + num;
            clock_link.addEventListener('click', function(e) {
                e.preventDefault();
                // avoid triggering the document click handler to dismiss the clock
                e.stopPropagation();
                DateTimeShortcuts.openClock(num);
            });

            quickElement(
                'span', clock_link, '',
                'class', 'clock-icon',
                'title', gettext('Choose a Time')
            );
            shortcuts_span.appendChild(document.createTextNode('\u00A0'));
            shortcuts_span.appendChild(now_link);
            shortcuts_span.appendChild(document.createTextNode('\u00A0|\u00A0'));
            shortcuts_span.appendChild(clock_link);

            // Create clock link div
            //
            // Markup looks like:
            // <div id="clockbox1" class="clockbox module">
            //     <h2>Choose a time</h2>
            //     <ul class="timelist">
            //         <li><a href="#">Now</a></li>
            //         <li><a href="#">Midnight</a></li>
            //         <li><a href="#">6 a.m.</a></li>
            //         <li><a href="#">Noon</a></li>
            //         <li><a href="#">6 p.m.</a></li>
            //     </ul>
            //     <p class="calendar-cancel"><a href="#">Cancel</a></p>
            // </div>

            const clock_box = document.createElement('div');
            clock_box.style.display = 'none';
            clock_box.style.position = 'absolute';
            clock_box.className = 'clockbox module';
            clock_box.id = DateTimeShortcuts.clockDivName + num;
            document.body.appendChild(clock_box);
            clock_box.addEventListener('click', function(e) { e.stopPropagation(); });

            quickElement('h2', clock_box, gettext('Choose a time'));
            const time_list = quickElement('ul', clock_box);
            time_list.className = 'timelist';
            // The list of choices can be overridden in JavaScript like this:
            // DateTimeShortcuts.clockHours.name = [['3 a.m.', 3]];
            // where name is the name attribute of the <input>.
            const name = typeof DateTimeShortcuts.clockHours[inp.name] === 'undefined' ? 'default_' : inp.name;
            DateTimeShortcuts.clockHours[name].forEach(function(element) {
                const time_link = quickElement('a', quickElement('li', time_list), gettext(element[0]), 'role', 'button', 'href', '#');
                time_link.addEventListener('click', function(e) {
                    e.preventDefault();
                    DateTimeShortcuts.handleClockQuicklink(num, element[1]);
                });
            });

            const cancel_p = quickElement('p', clock_box);
            cancel_p.className = 'calendar-cancel';
            const cancel_link = quickElement('a', cancel_p, gettext('Cancel'), 'role', 'button', 'href', '#');
            cancel_link.addEventListener('click', function(e) {
                e.preventDefault();
                DateTimeShortcuts.dismissClock(num);
            });

            document.addEventListener('keyup', function(event) {
                if (event.which === 27) {
                    // ESC key closes popup
                    DateTimeShortcuts.dismissClock(num);
                    event.preventDefault();
                }
            });
        },
        openClock: function(num) {
            const clock_box = document.getElementById(DateTimeShortcuts.clockDivName + num);
            const clock_link = document.getElementById(DateTimeShortcuts.clockLinkName + num);

            // Recalculate the clockbox position
            // is it left-to-right or right-to-left layout ?
            if (window.getComputedStyle(document.body).direction !== 'rtl') {
                clock_box.style.left = findPosX(clock_link) + 17 + 'px';
            }
            else {
                // since style's width is in em, it'd be tough to calculate
                // px value of it. let's use an estimated px for now
                clock_box.style.left = findPosX(clock_link) - 110 + 'px';
            }
            clock_box.style.top = Math.max(0, findPosY(clock_link) - 30) + 'px';

            // Show the clock box
            clock_box.style.display = 'block';
            document.addEventListener('click', DateTimeShortcuts.dismissClockFunc[num]);
        },
        dismissClock: function(num) {
            document.getElementById(DateTimeShortcuts.clockDivName + num).style.display = 'none';
            document.removeEventListener('click', DateTimeShortcuts.dismissClockFunc[num]);
        },
        handleClockQuicklink: function(num, val) {
            let d;
            if (val === -1) {
                d = DateTimeShortcuts.now();
            }
            else {
                d = new Date(1970, 1, 1, val, 0, 0, 0);
            }
            DateTimeShortcuts.clockInputs[num].value = d.strftime(get_format('TIME_INPUT_FORMATS')[0]);
            DateTimeShortcuts.clockInputs[num].focus();
            DateTimeShortcuts.dismissClock(num);
        },
        // Add calendar widget to a given field.
        addCalendar: function(inp) {
            const num = DateTimeShortcuts.calendars.length;

            DateTimeShortcuts.calendarInputs[num] = inp;
            DateTimeShortcuts.dismissCalendarFunc[num] = function() { DateTimeShortcuts.dismissCalendar(num); return true; };

            // Shortcut links (calendar icon and "Today" link)
            const shortcuts_span = document.createElement('span');
            shortcuts_span.className = DateTimeShortcuts.shortCutsClass;
            inp.parentNode.insertBefore(shortcuts_span, inp.nextSibling);
            const today_link = document.createElement('a');
            today_link.href = '#';
            today_link.role = 'button';
            today_link.appendChild(document.createTextNode(gettext('Today')));
            today_link.addEventListener('click', function(e) {
                e.preventDefault();
                DateTimeShortcuts.handleCalendarQuickLink(num, 0);
            });
            const cal_link = document.createElement('a');
            cal_link.href = '#';
            cal_link.id = DateTimeShortcuts.calendarLinkName + num;
            cal_link.addEventListener('click', function(e) {
                e.preventDefault();
                // avoid triggering the document click handler to dismiss the calendar
                e.stopPropagation();
                DateTimeShortcuts.openCalendar(num);
            });
            quickElement(
                'span', cal_link, '',
                'class', 'date-icon',
                'title', gettext('Choose a Date')
            );
            shortcuts_span.appendChild(document.createTextNode('\u00A0'));
            shortcuts_span.appendChild(today_link);
            shortcuts_span.appendChild(document.createTextNode('\u00A0|\u00A0'));
            shortcuts_span.appendChild(cal_link);

            // Create calendarbox div.
            //
            // Markup looks like:
            //
            // <div id="calendarbox3" class="calendarbox module">
            //     <h2>
            //           <a href="#" class="link-previous">&lsaquo;</a>
            //           <a href="#" class="link-next">&rsaquo;</a> February 2003
            //     </h2>
            //     <div class="calendar" id="calendarin3">
            //         <!-- (cal) -->
            //     </div>
            //     <div class="calendar-shortcuts">
            //          <a href="#">Yesterday</a> | <a href="#">Today</a> | <a href="#">Tomorrow</a>
            //     </div>
            //     <p class="calendar-cancel"><a href="#">Cancel</a></p>
            // </div>
            const cal_box = document.createElement('div');
            cal_box.style.display = 'none';
            cal_box.style.position = 'absolute';
            cal_box.className = 'calendarbox module';
            cal_box.id = DateTimeShortcuts.calendarDivName1 + num;
            document.body.appendChild(cal_box);
            cal_box.addEventListener('click', function(e) { e.stopPropagation(); });

            // next-prev links
            const cal_nav = quickElement('div', cal_box);
            const cal_nav_prev = quickElement('a', cal_nav, '<', 'href', '#');
            cal_nav_prev.className = 'calendarnav-previous';
            cal_nav_prev.addEventListener('click', function(e) {
                e.preventDefault();
                DateTimeShortcuts.drawPrev(num);
            });

            const cal_nav_next = quickElement('a', cal_nav, '>', 'href', '#');
            cal_nav_next.className = 'calendarnav-next';
            cal_nav_next.addEventListener('click', function(e) {
                e.preventDefault();
                DateTimeShortcuts.drawNext(num);
            });

            // main box
            const cal_main = quickElement('div', cal_box, '', 'id', DateTimeShortcuts.calendarDivName2 + num);
            cal_main.className = 'calendar';
            DateTimeShortcuts.calendars[num] = new Calendar(DateTimeShortcuts.calendarDivName2 + num, DateTimeShortcuts.handleCalendarCallback(num));
            DateTimeShortcuts.calendars[num].drawCurrent();

            // calendar shortcuts
            const shortcuts = quickElement('div', cal_box);
            shortcuts.className = 'calendar-shortcuts';
            let day_link = quickElement('a', shortcuts, gettext('Yesterday'), 'role', 'button', 'href', '#');
            day_link.addEventListener('click', function(e) {
                e.preventDefault();
                DateTimeShortcuts.handleCalendarQuickLink(num, -1);
            });
            shortcuts.appendChild(document.createTextNode('\u00A0|\u00A0'));
            day_link = quickElement('a', shortcuts, gettext('Today'), 'role', 'button', 'href', '#');
            day_link.addEventListener('click', function(e) {
                e.preventDefault();
                DateTimeShortcuts.handleCalendarQuickLink(num, 0);
            });
            shortcuts.appendChild(document.createTextNode('\u00A0|\u00A0'));
            day_link = quickElement('a', shortcuts, gettext('Tomorrow'), 'role', 'button', 'href', '#');
            day_link.addEventListener('click', function(e) {
                e.preventDefault();
                DateTimeShortcuts.handleCalendarQuickLink(num, +1);
            });

            // cancel bar
            const cancel_p = quickElement('p', cal_box);
            cancel_p.className = 'calendar-cancel';
            const cancel_link = quickElement('a', cancel_p, gettext('Cancel'), 'role', 'button', 'href', '#');
            cancel_link.addEventListener('click', function(e) {
                e.preventDefault();
                DateTimeShortcuts.dismissCalendar(num);
            });
            document.addEventListener('keyup', function(event) {
                if (event.which === 27) {
                    // ESC key closes popup
                    DateTimeShortcuts.dismissCalendar(num);
                    event.preventDefault();
                }
            });
        },
        openCalendar: function(num) {
            const cal_box = document.getElementById(DateTimeShortcuts.calendarDivName1 + num);
            const cal_link = document.getElementById(DateTimeShortcuts.calendarLinkName + num);
            const inp = DateTimeShortcuts.calendarInputs[num];

            // Determine if the current value in the input has a valid date.
            // If so, draw the calendar with that date's year and month.
            if (inp.value) {
                const format = get_format('DATE_INPUT_FORMATS')[0];
                const selected = inp.value.strptime(format);
                const year = selected.getUTCFullYear();
                const month = selected.getUTCMonth() + 1;
                const re = /\d{4}/;
                if (re.test(year.toString()) && month >= 1 && month <= 12) {
                    DateTimeShortcuts.calendars[num].drawDate(month, year, selected);
                }
            }

            // Recalculate the clockbox position
            // is it left-to-right or right-to-left layout ?
            if (window.getComputedStyle(document.body).direction !== 'rtl') {
                cal_box.style.left = findPosX(cal_link) + 17 + 'px';
            }
            else {
                // since style's width is in em, it'd be tough to calculate
                // px value of it. let's use an estimated px for now
                cal_box.style.left = findPosX(cal_link) - 180 + 'px';
            }
            cal_box.style.top = Math.max(0, findPosY(cal_link) - 75) + 'px';

            cal_box.style.display = 'block';
            document.addEventListener('click', DateTimeShortcuts.dismissCalendarFunc[num]);
        },
        dismissCalendar: function(num) {
            document.getElementById(DateTimeShortcuts.calendarDivName1 + num).style.display = 'none';
            document.removeEventListener('click', DateTimeShortcuts.dismissCalendarFunc[num]);
        },
        drawPrev: function(num) {
            DateTimeShortcuts.calendars[num].drawPreviousMonth();
        },
        drawNext: function(num) {
            DateTimeShortcuts.calendars[num].drawNextMonth();
        },
        handleCalendarCallback: function(num) {
            const format = get_format('DATE_INPUT_FORMATS')[0];
            return function(y, m, d) {
                DateTimeShortcuts.calendarInputs[num].value = new Date(y, m - 1, d).strftime(format);
                DateTimeShortcuts.calendarInputs[num].focus();
                document.getElementById(DateTimeShortcuts.calendarDivName1 + num).style.display = 'none';
            };
        },
        handleCalendarQuickLink: function(num, offset) {
            const d = DateTimeShortcuts.now();
            d.setDate(d.getDate() + offset);
            DateTimeShortcuts.calendarInputs[num].value = d.strftime(get_format('DATE_INPUT_FORMATS')[0]);
            DateTimeShortcuts.calendarInputs[num].focus();
            DateTimeShortcuts.dismissCalendar(num);
        }
    };

    window.addEventListener('load', DateTimeShortcuts.init);
    window.DateTimeShortcuts = DateTimeShortcuts;
}



========== staticfiles/admin/js/admin/RelatedObjectLookups.js ==========
/*global SelectBox, interpolate*/
// Handles related-objects functionality: lookup link for raw_id_fields
// and Add Another links.
'use strict';
{
    const $ = django.jQuery;
    let popupIndex = 0;
    const relatedWindows = [];

    function dismissChildPopups() {
        relatedWindows.forEach(function(win) {
            if(!win.closed) {
                win.dismissChildPopups();
                win.close();    
            }
        });
    }

    function setPopupIndex() {
        if(document.getElementsByName("_popup").length > 0) {
            const index = window.name.lastIndexOf("__") + 2;
            popupIndex = parseInt(window.name.substring(index));   
        } else {
            popupIndex = 0;
        }
    }

    function addPopupIndex(name) {
        return name + "__" + (popupIndex + 1);
    }

    function removePopupIndex(name) {
        return name.replace(new RegExp("__" + (popupIndex + 1) + "$"), '');
    }

    function showAdminPopup(triggeringLink, name_regexp, add_popup) {
        const name = addPopupIndex(triggeringLink.id.replace(name_regexp, ''));
        const href = new URL(triggeringLink.href);
        if (add_popup) {
            href.searchParams.set('_popup', 1);
        }
        const win = window.open(href, name, 'height=500,width=800,resizable=yes,scrollbars=yes');
        relatedWindows.push(win);
        win.focus();
        return false;
    }

    function showRelatedObjectLookupPopup(triggeringLink) {
        return showAdminPopup(triggeringLink, /^lookup_/, true);
    }

    function dismissRelatedLookupPopup(win, chosenId) {
        const name = removePopupIndex(win.name);
        const elem = document.getElementById(name);
        if (elem.classList.contains('vManyToManyRawIdAdminField') && elem.value) {
            elem.value += ',' + chosenId;
        } else {
            elem.value = chosenId;
        }
        $(elem).trigger('change');
        const index = relatedWindows.indexOf(win);
        if (index > -1) {
            relatedWindows.splice(index, 1);
        }
        win.close();
    }

    function showRelatedObjectPopup(triggeringLink) {
        return showAdminPopup(triggeringLink, /^(change|add|delete)_/, false);
    }

    function updateRelatedObjectLinks(triggeringLink) {
        const $this = $(triggeringLink);
        const siblings = $this.nextAll('.view-related, .change-related, .delete-related');
        if (!siblings.length) {
            return;
        }
        const value = $this.val();
        if (value) {
            siblings.each(function() {
                const elm = $(this);
                elm.attr('href', elm.attr('data-href-template').replace('__fk__', value));
                elm.removeAttr('aria-disabled');
            });
        } else {
            siblings.removeAttr('href');
            siblings.attr('aria-disabled', true);
        }
    }

    function updateRelatedSelectsOptions(currentSelect, win, objId, newRepr, newId, skipIds = []) {
        // After create/edit a model from the options next to the current
        // select (+ or :pencil:) update ForeignKey PK of the rest of selects
        // in the page.

        const path = win.location.pathname;
        // Extract the model from the popup url '.../<model>/add/' or
        // '.../<model>/<id>/change/' depending the action (add or change).
        const modelName = path.split('/')[path.split('/').length - (objId ? 4 : 3)];
        // Select elements with a specific model reference and context of "available-source".
        const selectsRelated = document.querySelectorAll(`[data-model-ref="${modelName}"] [data-context="available-source"]`);

        selectsRelated.forEach(function(select) {
            if (currentSelect === select || skipIds && skipIds.includes(select.id)) {
                return;
            }

            let option = select.querySelector(`option[value="${objId}"]`);

            if (!option) {
                option = new Option(newRepr, newId);
                select.options.add(option);
                // Update SelectBox cache for related fields.
                if (window.SelectBox !== undefined && !SelectBox.cache[currentSelect.id]) {
                    SelectBox.add_to_cache(select.id, option);
                    SelectBox.redisplay(select.id);
                }
                return;
            }

            option.textContent = newRepr;
            option.value = newId;
        });
    }

    function dismissAddRelatedObjectPopup(win, newId, newRepr) {
        const name = removePopupIndex(win.name);
        const elem = document.getElementById(name);
        if (elem) {
            const elemName = elem.nodeName.toUpperCase();
            if (elemName === 'SELECT') {
                elem.options[elem.options.length] = new Option(newRepr, newId, true, true);
                updateRelatedSelectsOptions(elem, win, null, newRepr, newId);
            } else if (elemName === 'INPUT') {
                if (elem.classList.contains('vManyToManyRawIdAdminField') && elem.value) {
                    elem.value += ',' + newId;
                } else {
                    elem.value = newId;
                }
            }
            // Trigger a change event to update related links if required.
            $(elem).trigger('change');
        } else {
            const toId = name + "_to";
            const toElem = document.getElementById(toId);
            const o = new Option(newRepr, newId);
            SelectBox.add_to_cache(toId, o);
            SelectBox.redisplay(toId);
            if (toElem && toElem.nodeName.toUpperCase() === 'SELECT') {
                const skipIds = [name + "_from"];
                updateRelatedSelectsOptions(toElem, win, null, newRepr, newId, skipIds);
            }
        }
        const index = relatedWindows.indexOf(win);
        if (index > -1) {
            relatedWindows.splice(index, 1);
        }
        win.close();
    }

    function dismissChangeRelatedObjectPopup(win, objId, newRepr, newId) {
        const id = removePopupIndex(win.name.replace(/^edit_/, ''));
        const selectsSelector = interpolate('#%s, #%s_from, #%s_to', [id, id, id]);
        const selects = $(selectsSelector);
        selects.find('option').each(function() {
            if (this.value === objId) {
                this.textContent = newRepr;
                this.value = newId;
            }
        }).trigger('change');
        updateRelatedSelectsOptions(selects[0], win, objId, newRepr, newId);
        selects.next().find('.select2-selection__rendered').each(function() {
            // The element can have a clear button as a child.
            // Use the lastChild to modify only the displayed value.
            this.lastChild.textContent = newRepr;
            this.title = newRepr;
        });
        const index = relatedWindows.indexOf(win);
        if (index > -1) {
            relatedWindows.splice(index, 1);
        }
        win.close();
    }

    function dismissDeleteRelatedObjectPopup(win, objId) {
        const id = removePopupIndex(win.name.replace(/^delete_/, ''));
        const selectsSelector = interpolate('#%s, #%s_from, #%s_to', [id, id, id]);
        const selects = $(selectsSelector);
        selects.find('option').each(function() {
            if (this.value === objId) {
                $(this).remove();
            }
        }).trigger('change');
        const index = relatedWindows.indexOf(win);
        if (index > -1) {
            relatedWindows.splice(index, 1);
        }
        win.close();
    }

    window.showRelatedObjectLookupPopup = showRelatedObjectLookupPopup;
    window.dismissRelatedLookupPopup = dismissRelatedLookupPopup;
    window.showRelatedObjectPopup = showRelatedObjectPopup;
    window.updateRelatedObjectLinks = updateRelatedObjectLinks;
    window.dismissAddRelatedObjectPopup = dismissAddRelatedObjectPopup;
    window.dismissChangeRelatedObjectPopup = dismissChangeRelatedObjectPopup;
    window.dismissDeleteRelatedObjectPopup = dismissDeleteRelatedObjectPopup;
    window.dismissChildPopups = dismissChildPopups;
    window.relatedWindows = relatedWindows;

    // Kept for backward compatibility
    window.showAddAnotherPopup = showRelatedObjectPopup;
    window.dismissAddAnotherPopup = dismissAddRelatedObjectPopup;

    window.addEventListener('unload', function(evt) {
        window.dismissChildPopups();
    });

    $(document).ready(function() {
        setPopupIndex();
        $("a[data-popup-opener]").on('click', function(event) {
            event.preventDefault();
            opener.dismissRelatedLookupPopup(window, $(this).data("popup-opener"));
        });
        $('body').on('click', '.related-widget-wrapper-link[data-popup="yes"]', function(e) {
            e.preventDefault();
            if (this.href) {
                const event = $.Event('django:show-related', {href: this.href});
                $(this).trigger(event);
                if (!event.isDefaultPrevented()) {
                    showRelatedObjectPopup(this);
                }
            }
        });
        $('body').on('change', '.related-widget-wrapper select', function(e) {
            const event = $.Event('django:update-related');
            $(this).trigger(event);
            if (!event.isDefaultPrevented()) {
                updateRelatedObjectLinks(this);
            }
        });
        $('.related-widget-wrapper select').trigger('change');
        $('body').on('click', '.related-lookup', function(e) {
            e.preventDefault();
            const event = $.Event('django:lookup-related');
            $(this).trigger(event);
            if (!event.isDefaultPrevented()) {
                showRelatedObjectLookupPopup(this);
            }
        });
    });
}



========== staticfiles/admin/js/core.js ==========
// Core JavaScript helper functions
'use strict';

// quickElement(tagType, parentReference [, textInChildNode, attribute, attributeValue ...]);
function quickElement() {
    const obj = document.createElement(arguments[0]);
    if (arguments[2]) {
        const textNode = document.createTextNode(arguments[2]);
        obj.appendChild(textNode);
    }
    const len = arguments.length;
    for (let i = 3; i < len; i += 2) {
        obj.setAttribute(arguments[i], arguments[i + 1]);
    }
    arguments[1].appendChild(obj);
    return obj;
}

// "a" is reference to an object
function removeChildren(a) {
    while (a.hasChildNodes()) {
        a.removeChild(a.lastChild);
    }
}

// ----------------------------------------------------------------------------
// Find-position functions by PPK
// See https://www.quirksmode.org/js/findpos.html
// ----------------------------------------------------------------------------
function findPosX(obj) {
    let curleft = 0;
    if (obj.offsetParent) {
        while (obj.offsetParent) {
            curleft += obj.offsetLeft - obj.scrollLeft;
            obj = obj.offsetParent;
        }
    } else if (obj.x) {
        curleft += obj.x;
    }
    return curleft;
}

function findPosY(obj) {
    let curtop = 0;
    if (obj.offsetParent) {
        while (obj.offsetParent) {
            curtop += obj.offsetTop - obj.scrollTop;
            obj = obj.offsetParent;
        }
    } else if (obj.y) {
        curtop += obj.y;
    }
    return curtop;
}

//-----------------------------------------------------------------------------
// Date object extensions
// ----------------------------------------------------------------------------
{
    Date.prototype.getTwelveHours = function() {
        return this.getHours() % 12 || 12;
    };

    Date.prototype.getTwoDigitMonth = function() {
        return (this.getMonth() < 9) ? '0' + (this.getMonth() + 1) : (this.getMonth() + 1);
    };

    Date.prototype.getTwoDigitDate = function() {
        return (this.getDate() < 10) ? '0' + this.getDate() : this.getDate();
    };

    Date.prototype.getTwoDigitTwelveHour = function() {
        return (this.getTwelveHours() < 10) ? '0' + this.getTwelveHours() : this.getTwelveHours();
    };

    Date.prototype.getTwoDigitHour = function() {
        return (this.getHours() < 10) ? '0' + this.getHours() : this.getHours();
    };

    Date.prototype.getTwoDigitMinute = function() {
        return (this.getMinutes() < 10) ? '0' + this.getMinutes() : this.getMinutes();
    };

    Date.prototype.getTwoDigitSecond = function() {
        return (this.getSeconds() < 10) ? '0' + this.getSeconds() : this.getSeconds();
    };

    Date.prototype.getAbbrevDayName = function() {
        return typeof window.CalendarNamespace === "undefined"
            ? '0' + this.getDay()
            : window.CalendarNamespace.daysOfWeekAbbrev[this.getDay()];
    };

    Date.prototype.getFullDayName = function() {
        return typeof window.CalendarNamespace === "undefined"
            ? '0' + this.getDay()
            : window.CalendarNamespace.daysOfWeek[this.getDay()];
    };

    Date.prototype.getAbbrevMonthName = function() {
        return typeof window.CalendarNamespace === "undefined"
            ? this.getTwoDigitMonth()
            : window.CalendarNamespace.monthsOfYearAbbrev[this.getMonth()];
    };

    Date.prototype.getFullMonthName = function() {
        return typeof window.CalendarNamespace === "undefined"
            ? this.getTwoDigitMonth()
            : window.CalendarNamespace.monthsOfYear[this.getMonth()];
    };

    Date.prototype.strftime = function(format) {
        const fields = {
            a: this.getAbbrevDayName(),
            A: this.getFullDayName(),
            b: this.getAbbrevMonthName(),
            B: this.getFullMonthName(),
            c: this.toString(),
            d: this.getTwoDigitDate(),
            H: this.getTwoDigitHour(),
            I: this.getTwoDigitTwelveHour(),
            m: this.getTwoDigitMonth(),
            M: this.getTwoDigitMinute(),
            p: (this.getHours() >= 12) ? 'PM' : 'AM',
            S: this.getTwoDigitSecond(),
            w: '0' + this.getDay(),
            x: this.toLocaleDateString(),
            X: this.toLocaleTimeString(),
            y: ('' + this.getFullYear()).substr(2, 4),
            Y: '' + this.getFullYear(),
            '%': '%'
        };
        let result = '', i = 0;
        while (i < format.length) {
            if (format.charAt(i) === '%') {
                result += fields[format.charAt(i + 1)];
                ++i;
            }
            else {
                result += format.charAt(i);
            }
            ++i;
        }
        return result;
    };

    // ----------------------------------------------------------------------------
    // String object extensions
    // ----------------------------------------------------------------------------
    String.prototype.strptime = function(format) {
        const split_format = format.split(/[.\-/]/);
        const date = this.split(/[.\-/]/);
        let i = 0;
        let day, month, year;
        while (i < split_format.length) {
            switch (split_format[i]) {
            case "%d":
                day = date[i];
                break;
            case "%m":
                month = date[i] - 1;
                break;
            case "%Y":
                year = date[i];
                break;
            case "%y":
                // A %y value in the range of [00, 68] is in the current
                // century, while [69, 99] is in the previous century,
                // according to the Open Group Specification.
                if (parseInt(date[i], 10) >= 69) {
                    year = date[i];
                } else {
                    year = (new Date(Date.UTC(date[i], 0))).getUTCFullYear() + 100;
                }
                break;
            }
            ++i;
        }
        // Create Date object from UTC since the parsed value is supposed to be
        // in UTC, not local time. Also, the calendar uses UTC functions for
        // date extraction.
        return new Date(Date.UTC(year, month, day));
    };
}



========== staticfiles/admin/js/theme.js ==========
'use strict';
{
    function setTheme(mode) {
        if (mode !== "light" && mode !== "dark" && mode !== "auto") {
            console.error(`Got invalid theme mode: ${mode}. Resetting to auto.`);
            mode = "auto";
        }
        document.documentElement.dataset.theme = mode;
        localStorage.setItem("theme", mode);
    }

    function cycleTheme() {
        const currentTheme = localStorage.getItem("theme") || "auto";
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

        if (prefersDark) {
            // Auto (dark) -> Light -> Dark
            if (currentTheme === "auto") {
                setTheme("light");
            } else if (currentTheme === "light") {
                setTheme("dark");
            } else {
                setTheme("auto");
            }
        } else {
            // Auto (light) -> Dark -> Light
            if (currentTheme === "auto") {
                setTheme("dark");
            } else if (currentTheme === "dark") {
                setTheme("light");
            } else {
                setTheme("auto");
            }
        }
    }

    function initTheme() {
        // set theme defined in localStorage if there is one, or fallback to auto mode
        const currentTheme = localStorage.getItem("theme");
        currentTheme ? setTheme(currentTheme) : setTheme("auto");
    }

    window.addEventListener('load', function(_) {
        const buttons = document.getElementsByClassName("theme-toggle");
        Array.from(buttons).forEach((btn) => {
            btn.addEventListener("click", cycleTheme);
        });
    });

    initTheme();
}



========== staticfiles/admin/js/actions.js ==========
/*global gettext, interpolate, ngettext, Actions*/
'use strict';
{
    function show(selector) {
        document.querySelectorAll(selector).forEach(function(el) {
            el.classList.remove('hidden');
        });
    }

    function hide(selector) {
        document.querySelectorAll(selector).forEach(function(el) {
            el.classList.add('hidden');
        });
    }

    function showQuestion(options) {
        hide(options.acrossClears);
        show(options.acrossQuestions);
        hide(options.allContainer);
    }

    function showClear(options) {
        show(options.acrossClears);
        hide(options.acrossQuestions);
        document.querySelector(options.actionContainer).classList.remove(options.selectedClass);
        show(options.allContainer);
        hide(options.counterContainer);
    }

    function reset(options) {
        hide(options.acrossClears);
        hide(options.acrossQuestions);
        hide(options.allContainer);
        show(options.counterContainer);
    }

    function clearAcross(options) {
        reset(options);
        const acrossInputs = document.querySelectorAll(options.acrossInput);
        acrossInputs.forEach(function(acrossInput) {
            acrossInput.value = 0;
        });
        document.querySelector(options.actionContainer).classList.remove(options.selectedClass);
    }

    function checker(actionCheckboxes, options, checked) {
        if (checked) {
            showQuestion(options);
        } else {
            reset(options);
        }
        actionCheckboxes.forEach(function(el) {
            el.checked = checked;
            el.closest('tr').classList.toggle(options.selectedClass, checked);
        });
    }

    function updateCounter(actionCheckboxes, options) {
        const sel = Array.from(actionCheckboxes).filter(function(el) {
            return el.checked;
        }).length;
        const counter = document.querySelector(options.counterContainer);
        // data-actions-icnt is defined in the generated HTML
        // and contains the total amount of objects in the queryset
        const actions_icnt = Number(counter.dataset.actionsIcnt);
        counter.textContent = interpolate(
            ngettext('%(sel)s of %(cnt)s selected', '%(sel)s of %(cnt)s selected', sel), {
                sel: sel,
                cnt: actions_icnt
            }, true);
        const allToggle = document.getElementById(options.allToggleId);
        allToggle.checked = sel === actionCheckboxes.length;
        if (allToggle.checked) {
            showQuestion(options);
        } else {
            clearAcross(options);
        }
    }

    const defaults = {
        actionContainer: "div.actions",
        counterContainer: "span.action-counter",
        allContainer: "div.actions span.all",
        acrossInput: "div.actions input.select-across",
        acrossQuestions: "div.actions span.question",
        acrossClears: "div.actions span.clear",
        allToggleId: "action-toggle",
        selectedClass: "selected"
    };

    window.Actions = function(actionCheckboxes, options) {
        options = Object.assign({}, defaults, options);
        let list_editable_changed = false;
        let lastChecked = null;
        let shiftPressed = false;

        document.addEventListener('keydown', (event) => {
            shiftPressed = event.shiftKey;
        });

        document.addEventListener('keyup', (event) => {
            shiftPressed = event.shiftKey;
        });

        document.getElementById(options.allToggleId).addEventListener('click', function(event) {
            checker(actionCheckboxes, options, this.checked);
            updateCounter(actionCheckboxes, options);
        });

        document.querySelectorAll(options.acrossQuestions + " a").forEach(function(el) {
            el.addEventListener('click', function(event) {
                event.preventDefault();
                const acrossInputs = document.querySelectorAll(options.acrossInput);
                acrossInputs.forEach(function(acrossInput) {
                    acrossInput.value = 1;
                });
                showClear(options);
            });
        });

        document.querySelectorAll(options.acrossClears + " a").forEach(function(el) {
            el.addEventListener('click', function(event) {
                event.preventDefault();
                document.getElementById(options.allToggleId).checked = false;
                clearAcross(options);
                checker(actionCheckboxes, options, false);
                updateCounter(actionCheckboxes, options);
            });
        });

        function affectedCheckboxes(target, withModifier) {
            const multiSelect = (lastChecked && withModifier && lastChecked !== target);
            if (!multiSelect) {
                return [target];
            }
            const checkboxes = Array.from(actionCheckboxes);
            const targetIndex = checkboxes.findIndex(el => el === target);
            const lastCheckedIndex = checkboxes.findIndex(el => el === lastChecked);
            const startIndex = Math.min(targetIndex, lastCheckedIndex);
            const endIndex = Math.max(targetIndex, lastCheckedIndex);
            const filtered = checkboxes.filter((el, index) => (startIndex <= index) && (index <= endIndex));
            return filtered;
        };

        Array.from(document.getElementById('result_list').tBodies).forEach(function(el) {
            el.addEventListener('change', function(event) {
                const target = event.target;
                if (target.classList.contains('action-select')) {
                    const checkboxes = affectedCheckboxes(target, shiftPressed);
                    checker(checkboxes, options, target.checked);
                    updateCounter(actionCheckboxes, options);
                    lastChecked = target;
                } else {
                    list_editable_changed = true;
                }
            });
        });

        document.querySelector('#changelist-form button[name=index]').addEventListener('click', function(event) {
            if (list_editable_changed) {
                const confirmed = confirm(gettext("You have unsaved changes on individual editable fields. If you run an action, your unsaved changes will be lost."));
                if (!confirmed) {
                    event.preventDefault();
                }
            }
        });

        const el = document.querySelector('#changelist-form input[name=_save]');
        // The button does not exist if no fields are editable.
        if (el) {
            el.addEventListener('click', function(event) {
                if (document.querySelector('[name=action]').value) {
                    const text = list_editable_changed
                        ? gettext("You have selected an action, but you haven’t saved your changes to individual fields yet. Please click OK to save. You’ll need to re-run the action.")
                        : gettext("You have selected an action, and you haven’t made any changes on individual fields. You’re probably looking for the Go button rather than the Save button.");
                    if (!confirm(text)) {
                        event.preventDefault();
                    }
                }
            });
        }
        // Sync counter when navigating to the page, such as through the back
        // button.
        window.addEventListener('pageshow', (event) => updateCounter(actionCheckboxes, options));
    };

    // Call function fn when the DOM is loaded and ready. If it is already
    // loaded, call the function now.
    // http://youmightnotneedjquery.com/#ready
    function ready(fn) {
        if (document.readyState !== 'loading') {
            fn();
        } else {
            document.addEventListener('DOMContentLoaded', fn);
        }
    }

    ready(function() {
        const actionsEls = document.querySelectorAll('tr input.action-select');
        if (actionsEls.length > 0) {
            Actions(actionsEls);
        }
    });
}



========== staticfiles/admin/js/calendar.js ==========
/*global gettext, pgettext, get_format, quickElement, removeChildren*/
/*
calendar.js - Calendar functions by Adrian Holovaty
depends on core.js for utility functions like removeChildren or quickElement
*/
'use strict';
{
    // CalendarNamespace -- Provides a collection of HTML calendar-related helper functions
    const CalendarNamespace = {
        monthsOfYear: [
            gettext('January'),
            gettext('February'),
            gettext('March'),
            gettext('April'),
            gettext('May'),
            gettext('June'),
            gettext('July'),
            gettext('August'),
            gettext('September'),
            gettext('October'),
            gettext('November'),
            gettext('December')
        ],
        monthsOfYearAbbrev: [
            pgettext('abbrev. month January', 'Jan'),
            pgettext('abbrev. month February', 'Feb'),
            pgettext('abbrev. month March', 'Mar'),
            pgettext('abbrev. month April', 'Apr'),
            pgettext('abbrev. month May', 'May'),
            pgettext('abbrev. month June', 'Jun'),
            pgettext('abbrev. month July', 'Jul'),
            pgettext('abbrev. month August', 'Aug'),
            pgettext('abbrev. month September', 'Sep'),
            pgettext('abbrev. month October', 'Oct'),
            pgettext('abbrev. month November', 'Nov'),
            pgettext('abbrev. month December', 'Dec')
        ],
        daysOfWeek: [
            gettext('Sunday'),
            gettext('Monday'),
            gettext('Tuesday'),
            gettext('Wednesday'),
            gettext('Thursday'),
            gettext('Friday'),
            gettext('Saturday')
        ],
        daysOfWeekAbbrev: [
            pgettext('abbrev. day Sunday', 'Sun'),
            pgettext('abbrev. day Monday', 'Mon'),
            pgettext('abbrev. day Tuesday', 'Tue'),
            pgettext('abbrev. day Wednesday', 'Wed'),
            pgettext('abbrev. day Thursday', 'Thur'),
            pgettext('abbrev. day Friday', 'Fri'),
            pgettext('abbrev. day Saturday', 'Sat')
        ],
        daysOfWeekInitial: [
            pgettext('one letter Sunday', 'S'),
            pgettext('one letter Monday', 'M'),
            pgettext('one letter Tuesday', 'T'),
            pgettext('one letter Wednesday', 'W'),
            pgettext('one letter Thursday', 'T'),
            pgettext('one letter Friday', 'F'),
            pgettext('one letter Saturday', 'S')
        ],
        firstDayOfWeek: parseInt(get_format('FIRST_DAY_OF_WEEK')),
        isLeapYear: function(year) {
            return (((year % 4) === 0) && ((year % 100) !== 0 ) || ((year % 400) === 0));
        },
        getDaysInMonth: function(month, year) {
            let days;
            if (month === 1 || month === 3 || month === 5 || month === 7 || month === 8 || month === 10 || month === 12) {
                days = 31;
            }
            else if (month === 4 || month === 6 || month === 9 || month === 11) {
                days = 30;
            }
            else if (month === 2 && CalendarNamespace.isLeapYear(year)) {
                days = 29;
            }
            else {
                days = 28;
            }
            return days;
        },
        draw: function(month, year, div_id, callback, selected) { // month = 1-12, year = 1-9999
            const today = new Date();
            const todayDay = today.getDate();
            const todayMonth = today.getMonth() + 1;
            const todayYear = today.getFullYear();
            let todayClass = '';

            // Use UTC functions here because the date field does not contain time
            // and using the UTC function variants prevent the local time offset
            // from altering the date, specifically the day field.  For example:
            //
            // ```
            // var x = new Date('2013-10-02');
            // var day = x.getDate();
            // ```
            //
            // The day variable above will be 1 instead of 2 in, say, US Pacific time
            // zone.
            let isSelectedMonth = false;
            if (typeof selected !== 'undefined') {
                isSelectedMonth = (selected.getUTCFullYear() === year && (selected.getUTCMonth() + 1) === month);
            }

            month = parseInt(month);
            year = parseInt(year);
            const calDiv = document.getElementById(div_id);
            removeChildren(calDiv);
            const calTable = document.createElement('table');
            quickElement('caption', calTable, CalendarNamespace.monthsOfYear[month - 1] + ' ' + year);
            const tableBody = quickElement('tbody', calTable);

            // Draw days-of-week header
            let tableRow = quickElement('tr', tableBody);
            for (let i = 0; i < 7; i++) {
                quickElement('th', tableRow, CalendarNamespace.daysOfWeekInitial[(i + CalendarNamespace.firstDayOfWeek) % 7]);
            }

            const startingPos = new Date(year, month - 1, 1 - CalendarNamespace.firstDayOfWeek).getDay();
            const days = CalendarNamespace.getDaysInMonth(month, year);

            let nonDayCell;

            // Draw blanks before first of month
            tableRow = quickElement('tr', tableBody);
            for (let i = 0; i < startingPos; i++) {
                nonDayCell = quickElement('td', tableRow, ' ');
                nonDayCell.className = "nonday";
            }

            function calendarMonth(y, m) {
                function onClick(e) {
                    e.preventDefault();
                    callback(y, m, this.textContent);
                }
                return onClick;
            }

            // Draw days of month
            let currentDay = 1;
            for (let i = startingPos; currentDay <= days; i++) {
                if (i % 7 === 0 && currentDay !== 1) {
                    tableRow = quickElement('tr', tableBody);
                }
                if ((currentDay === todayDay) && (month === todayMonth) && (year === todayYear)) {
                    todayClass = 'today';
                } else {
                    todayClass = '';
                }

                // use UTC function; see above for explanation.
                if (isSelectedMonth && currentDay === selected.getUTCDate()) {
                    if (todayClass !== '') {
                        todayClass += " ";
                    }
                    todayClass += "selected";
                }

                const cell = quickElement('td', tableRow, '', 'class', todayClass);
                const link = quickElement('a', cell, currentDay, 'role', 'button', 'href', '#');
                link.addEventListener('click', calendarMonth(year, month));
                currentDay++;
            }

            // Draw blanks after end of month (optional, but makes for valid code)
            while (tableRow.childNodes.length < 7) {
                nonDayCell = quickElement('td', tableRow, ' ');
                nonDayCell.className = "nonday";
            }

            calDiv.appendChild(calTable);
        }
    };

    // Calendar -- A calendar instance
    function Calendar(div_id, callback, selected) {
        // div_id (string) is the ID of the element in which the calendar will
        //     be displayed
        // callback (string) is the name of a JavaScript function that will be
        //     called with the parameters (year, month, day) when a day in the
        //     calendar is clicked
        this.div_id = div_id;
        this.callback = callback;
        this.today = new Date();
        this.currentMonth = this.today.getMonth() + 1;
        this.currentYear = this.today.getFullYear();
        if (typeof selected !== 'undefined') {
            this.selected = selected;
        }
    }
    Calendar.prototype = {
        drawCurrent: function() {
            CalendarNamespace.draw(this.currentMonth, this.currentYear, this.div_id, this.callback, this.selected);
        },
        drawDate: function(month, year, selected) {
            this.currentMonth = month;
            this.currentYear = year;

            if(selected) {
                this.selected = selected;
            }

            this.drawCurrent();
        },
        drawPreviousMonth: function() {
            if (this.currentMonth === 1) {
                this.currentMonth = 12;
                this.currentYear--;
            }
            else {
                this.currentMonth--;
            }
            this.drawCurrent();
        },
        drawNextMonth: function() {
            if (this.currentMonth === 12) {
                this.currentMonth = 1;
                this.currentYear++;
            }
            else {
                this.currentMonth++;
            }
            this.drawCurrent();
        },
        drawPreviousYear: function() {
            this.currentYear--;
            this.drawCurrent();
        },
        drawNextYear: function() {
            this.currentYear++;
            this.drawCurrent();
        }
    };
    window.Calendar = Calendar;
    window.CalendarNamespace = CalendarNamespace;
}



========== staticfiles/admin/js/vendor/select2/select2.full.js ==========
/*!
 * Select2 4.0.13
 * https://select2.github.io
 *
 * Released under the MIT license
 * https://github.com/select2/select2/blob/master/LICENSE.md
 */
;(function (factory) {
  if (typeof define === 'function' && define.amd) {
    // AMD. Register as an anonymous module.
    define(['jquery'], factory);
  } else if (typeof module === 'object' && module.exports) {
    // Node/CommonJS
    module.exports = function (root, jQuery) {
      if (jQuery === undefined) {
        // require('jQuery') returns a factory that requires window to
        // build a jQuery instance, we normalize how we use modules
        // that require this pattern but the window provided is a noop
        // if it's defined (how jquery works)
        if (typeof window !== 'undefined') {
          jQuery = require('jquery');
        }
        else {
          jQuery = require('jquery')(root);
        }
      }
      factory(jQuery);
      return jQuery;
    };
  } else {
    // Browser globals
    factory(jQuery);
  }
} (function (jQuery) {
  // This is needed so we can catch the AMD loader configuration and use it
  // The inner file should be wrapped (by `banner.start.js`) in a function that
  // returns the AMD loader references.
  var S2 =(function () {
  // Restore the Select2 AMD loader so it can be used
  // Needed mostly in the language files, where the loader is not inserted
  if (jQuery && jQuery.fn && jQuery.fn.select2 && jQuery.fn.select2.amd) {
    var S2 = jQuery.fn.select2.amd;
  }
var S2;(function () { if (!S2 || !S2.requirejs) {
if (!S2) { S2 = {}; } else { require = S2; }
/**
 * @license almond 0.3.3 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, http://github.com/requirejs/almond/LICENSE
 */
//Going sloppy to avoid 'use strict' string cost, but strict practices should
//be followed.
/*global setTimeout: false */

var requirejs, require, define;
(function (undef) {
    var main, req, makeMap, handlers,
        defined = {},
        waiting = {},
        config = {},
        defining = {},
        hasOwn = Object.prototype.hasOwnProperty,
        aps = [].slice,
        jsSuffixRegExp = /\.js$/;

    function hasProp(obj, prop) {
        return hasOwn.call(obj, prop);
    }

    /**
     * Given a relative module name, like ./something, normalize it to
     * a real name that can be mapped to a path.
     * @param {String} name the relative name
     * @param {String} baseName a real name that the name arg is relative
     * to.
     * @returns {String} normalized name
     */
    function normalize(name, baseName) {
        var nameParts, nameSegment, mapValue, foundMap, lastIndex,
            foundI, foundStarMap, starI, i, j, part, normalizedBaseParts,
            baseParts = baseName && baseName.split("/"),
            map = config.map,
            starMap = (map && map['*']) || {};

        //Adjust any relative paths.
        if (name) {
            name = name.split('/');
            lastIndex = name.length - 1;

            // If wanting node ID compatibility, strip .js from end
            // of IDs. Have to do this here, and not in nameToUrl
            // because node allows either .js or non .js to map
            // to same file.
            if (config.nodeIdCompat && jsSuffixRegExp.test(name[lastIndex])) {
                name[lastIndex] = name[lastIndex].replace(jsSuffixRegExp, '');
            }

            // Starts with a '.' so need the baseName
            if (name[0].charAt(0) === '.' && baseParts) {
                //Convert baseName to array, and lop off the last part,
                //so that . matches that 'directory' and not name of the baseName's
                //module. For instance, baseName of 'one/two/three', maps to
                //'one/two/three.js', but we want the directory, 'one/two' for
                //this normalization.
                normalizedBaseParts = baseParts.slice(0, baseParts.length - 1);
                name = normalizedBaseParts.concat(name);
            }

            //start trimDots
            for (i = 0; i < name.length; i++) {
                part = name[i];
                if (part === '.') {
                    name.splice(i, 1);
                    i -= 1;
                } else if (part === '..') {
                    // If at the start, or previous value is still ..,
                    // keep them so that when converted to a path it may
                    // still work when converted to a path, even though
                    // as an ID it is less than ideal. In larger point
                    // releases, may be better to just kick out an error.
                    if (i === 0 || (i === 1 && name[2] === '..') || name[i - 1] === '..') {
                        continue;
                    } else if (i > 0) {
                        name.splice(i - 1, 2);
                        i -= 2;
                    }
                }
            }
            //end trimDots

            name = name.join('/');
        }

        //Apply map config if available.
        if ((baseParts || starMap) && map) {
            nameParts = name.split('/');

            for (i = nameParts.length; i > 0; i -= 1) {
                nameSegment = nameParts.slice(0, i).join("/");

                if (baseParts) {
                    //Find the longest baseName segment match in the config.
                    //So, do joins on the biggest to smallest lengths of baseParts.
                    for (j = baseParts.length; j > 0; j -= 1) {
                        mapValue = map[baseParts.slice(0, j).join('/')];

                        //baseName segment has  config, find if it has one for
                        //this name.
                        if (mapValue) {
                            mapValue = mapValue[nameSegment];
                            if (mapValue) {
                                //Match, update name to the new value.
                                foundMap = mapValue;
                                foundI = i;
                                break;
                            }
                        }
                    }
                }

                if (foundMap) {
                    break;
                }

                //Check for a star map match, but just hold on to it,
                //if there is a shorter segment match later in a matching
                //config, then favor over this star map.
                if (!foundStarMap && starMap && starMap[nameSegment]) {
                    foundStarMap = starMap[nameSegment];
                    starI = i;
                }
            }

            if (!foundMap && foundStarMap) {
                foundMap = foundStarMap;
                foundI = starI;
            }

            if (foundMap) {
                nameParts.splice(0, foundI, foundMap);
                name = nameParts.join('/');
            }
        }

        return name;
    }

    function makeRequire(relName, forceSync) {
        return function () {
            //A version of a require function that passes a moduleName
            //value for items that may need to
            //look up paths relative to the moduleName
            var args = aps.call(arguments, 0);

            //If first arg is not require('string'), and there is only
            //one arg, it is the array form without a callback. Insert
            //a null so that the following concat is correct.
            if (typeof args[0] !== 'string' && args.length === 1) {
                args.push(null);
            }
            return req.apply(undef, args.concat([relName, forceSync]));
        };
    }

    function makeNormalize(relName) {
        return function (name) {
            return normalize(name, relName);
        };
    }

    function makeLoad(depName) {
        return function (value) {
            defined[depName] = value;
        };
    }

    function callDep(name) {
        if (hasProp(waiting, name)) {
            var args = waiting[name];
            delete waiting[name];
            defining[name] = true;
            main.apply(undef, args);
        }

        if (!hasProp(defined, name) && !hasProp(defining, name)) {
            throw new Error('No ' + name);
        }
        return defined[name];
    }

    //Turns a plugin!resource to [plugin, resource]
    //with the plugin being undefined if the name
    //did not have a plugin prefix.
    function splitPrefix(name) {
        var prefix,
            index = name ? name.indexOf('!') : -1;
        if (index > -1) {
            prefix = name.substring(0, index);
            name = name.substring(index + 1, name.length);
        }
        return [prefix, name];
    }

    //Creates a parts array for a relName where first part is plugin ID,
    //second part is resource ID. Assumes relName has already been normalized.
    function makeRelParts(relName) {
        return relName ? splitPrefix(relName) : [];
    }

    /**
     * Makes a name map, normalizing the name, and using a plugin
     * for normalization if necessary. Grabs a ref to plugin
     * too, as an optimization.
     */
    makeMap = function (name, relParts) {
        var plugin,
            parts = splitPrefix(name),
            prefix = parts[0],
            relResourceName = relParts[1];

        name = parts[1];

        if (prefix) {
            prefix = normalize(prefix, relResourceName);
            plugin = callDep(prefix);
        }

        //Normalize according
        if (prefix) {
            if (plugin && plugin.normalize) {
                name = plugin.normalize(name, makeNormalize(relResourceName));
            } else {
                name = normalize(name, relResourceName);
            }
        } else {
            name = normalize(name, relResourceName);
            parts = splitPrefix(name);
            prefix = parts[0];
            name = parts[1];
            if (prefix) {
                plugin = callDep(prefix);
            }
        }

        //Using ridiculous property names for space reasons
        return {
            f: prefix ? prefix + '!' + name : name, //fullName
            n: name,
            pr: prefix,
            p: plugin
        };
    };

    function makeConfig(name) {
        return function () {
            return (config && config.config && config.config[name]) || {};
        };
    }

    handlers = {
        require: function (name) {
            return makeRequire(name);
        },
        exports: function (name) {
            var e = defined[name];
            if (typeof e !== 'undefined') {
                return e;
            } else {
                return (defined[name] = {});
            }
        },
        module: function (name) {
            return {
                id: name,
                uri: '',
                exports: defined[name],
                config: makeConfig(name)
            };
        }
    };

    main = function (name, deps, callback, relName) {
        var cjsModule, depName, ret, map, i, relParts,
            args = [],
            callbackType = typeof callback,
            usingExports;

        //Use name if no relName
        relName = relName || name;
        relParts = makeRelParts(relName);

        //Call the callback to define the module, if necessary.
        if (callbackType === 'undefined' || callbackType === 'function') {
            //Pull out the defined dependencies and pass the ordered
            //values to the callback.
            //Default to [require, exports, module] if no deps
            deps = !deps.length && callback.length ? ['require', 'exports', 'module'] : deps;
            for (i = 0; i < deps.length; i += 1) {
                map = makeMap(deps[i], relParts);
                depName = map.f;

                //Fast path CommonJS standard dependencies.
                if (depName === "require") {
                    args[i] = handlers.require(name);
                } else if (depName === "exports") {
                    //CommonJS module spec 1.1
                    args[i] = handlers.exports(name);
                    usingExports = true;
                } else if (depName === "module") {
                    //CommonJS module spec 1.1
                    cjsModule = args[i] = handlers.module(name);
                } else if (hasProp(defined, depName) ||
                           hasProp(waiting, depName) ||
                           hasProp(defining, depName)) {
                    args[i] = callDep(depName);
                } else if (map.p) {
                    map.p.load(map.n, makeRequire(relName, true), makeLoad(depName), {});
                    args[i] = defined[depName];
                } else {
                    throw new Error(name + ' missing ' + depName);
                }
            }

            ret = callback ? callback.apply(defined[name], args) : undefined;

            if (name) {
                //If setting exports via "module" is in play,
                //favor that over return value and exports. After that,
                //favor a non-undefined return value over exports use.
                if (cjsModule && cjsModule.exports !== undef &&
                        cjsModule.exports !== defined[name]) {
                    defined[name] = cjsModule.exports;
                } else if (ret !== undef || !usingExports) {
                    //Use the return value from the function.
                    defined[name] = ret;
                }
            }
        } else if (name) {
            //May just be an object definition for the module. Only
            //worry about defining if have a module name.
            defined[name] = callback;
        }
    };

    requirejs = require = req = function (deps, callback, relName, forceSync, alt) {
        if (typeof deps === "string") {
            if (handlers[deps]) {
                //callback in this case is really relName
                return handlers[deps](callback);
            }
            //Just return the module wanted. In this scenario, the
            //deps arg is the module name, and second arg (if passed)
            //is just the relName.
            //Normalize module name, if it contains . or ..
            return callDep(makeMap(deps, makeRelParts(callback)).f);
        } else if (!deps.splice) {
            //deps is a config object, not an array.
            config = deps;
            if (config.deps) {
                req(config.deps, config.callback);
            }
            if (!callback) {
                return;
            }

            if (callback.splice) {
                //callback is an array, which means it is a dependency list.
                //Adjust args if there are dependencies
                deps = callback;
                callback = relName;
                relName = null;
            } else {
                deps = undef;
            }
        }

        //Support require(['a'])
        callback = callback || function () {};

        //If relName is a function, it is an errback handler,
        //so remove it.
        if (typeof relName === 'function') {
            relName = forceSync;
            forceSync = alt;
        }

        //Simulate async callback;
        if (forceSync) {
            main(undef, deps, callback, relName);
        } else {
            //Using a non-zero value because of concern for what old browsers
            //do, and latest browsers "upgrade" to 4 if lower value is used:
            //http://www.whatwg.org/specs/web-apps/current-work/multipage/timers.html#dom-windowtimers-settimeout:
            //If want a value immediately, use require('id') instead -- something
            //that works in almond on the global level, but not guaranteed and
            //unlikely to work in other AMD implementations.
            setTimeout(function () {
                main(undef, deps, callback, relName);
            }, 4);
        }

        return req;
    };

    /**
     * Just drops the config on the floor, but returns req in case
     * the config return value is used.
     */
    req.config = function (cfg) {
        return req(cfg);
    };

    /**
     * Expose module registry for debugging and tooling
     */
    requirejs._defined = defined;

    define = function (name, deps, callback) {
        if (typeof name !== 'string') {
            throw new Error('See almond README: incorrect module build, no module name');
        }

        //This module may not have dependencies
        if (!deps.splice) {
            //deps is not an array, so probably means
            //an object literal or factory function for
            //the value. Adjust args.
            callback = deps;
            deps = [];
        }

        if (!hasProp(defined, name) && !hasProp(waiting, name)) {
            waiting[name] = [name, deps, callback];
        }
    };

    define.amd = {
        jQuery: true
    };
}());

S2.requirejs = requirejs;S2.require = require;S2.define = define;
}
}());
S2.define("almond", function(){});

/* global jQuery:false, $:false */
S2.define('jquery',[],function () {
  var _$ = jQuery || $;

  if (_$ == null && console && console.error) {
    console.error(
      'Select2: An instance of jQuery or a jQuery-compatible library was not ' +
      'found. Make sure that you are including jQuery before Select2 on your ' +
      'web page.'
    );
  }

  return _$;
});

S2.define('select2/utils',[
  'jquery'
], function ($) {
  var Utils = {};

  Utils.Extend = function (ChildClass, SuperClass) {
    var __hasProp = {}.hasOwnProperty;

    function BaseConstructor () {
      this.constructor = ChildClass;
    }

    for (var key in SuperClass) {
      if (__hasProp.call(SuperClass, key)) {
        ChildClass[key] = SuperClass[key];
      }
    }

    BaseConstructor.prototype = SuperClass.prototype;
    ChildClass.prototype = new BaseConstructor();
    ChildClass.__super__ = SuperClass.prototype;

    return ChildClass;
  };

  function getMethods (theClass) {
    var proto = theClass.prototype;

    var methods = [];

    for (var methodName in proto) {
      var m = proto[methodName];

      if (typeof m !== 'function') {
        continue;
      }

      if (methodName === 'constructor') {
        continue;
      }

      methods.push(methodName);
    }

    return methods;
  }

  Utils.Decorate = function (SuperClass, DecoratorClass) {
    var decoratedMethods = getMethods(DecoratorClass);
    var superMethods = getMethods(SuperClass);

    function DecoratedClass () {
      var unshift = Array.prototype.unshift;

      var argCount = DecoratorClass.prototype.constructor.length;

      var calledConstructor = SuperClass.prototype.constructor;

      if (argCount > 0) {
        unshift.call(arguments, SuperClass.prototype.constructor);

        calledConstructor = DecoratorClass.prototype.constructor;
      }

      calledConstructor.apply(this, arguments);
    }

    DecoratorClass.displayName = SuperClass.displayName;

    function ctr () {
      this.constructor = DecoratedClass;
    }

    DecoratedClass.prototype = new ctr();

    for (var m = 0; m < superMethods.length; m++) {
      var superMethod = superMethods[m];

      DecoratedClass.prototype[superMethod] =
        SuperClass.prototype[superMethod];
    }

    var calledMethod = function (methodName) {
      // Stub out the original method if it's not decorating an actual method
      var originalMethod = function () {};

      if (methodName in DecoratedClass.prototype) {
        originalMethod = DecoratedClass.prototype[methodName];
      }

      var decoratedMethod = DecoratorClass.prototype[methodName];

      return function () {
        var unshift = Array.prototype.unshift;

        unshift.call(arguments, originalMethod);

        return decoratedMethod.apply(this, arguments);
      };
    };

    for (var d = 0; d < decoratedMethods.length; d++) {
      var decoratedMethod = decoratedMethods[d];

      DecoratedClass.prototype[decoratedMethod] = calledMethod(decoratedMethod);
    }

    return DecoratedClass;
  };

  var Observable = function () {
    this.listeners = {};
  };

  Observable.prototype.on = function (event, callback) {
    this.listeners = this.listeners || {};

    if (event in this.listeners) {
      this.listeners[event].push(callback);
    } else {
      this.listeners[event] = [callback];
    }
  };

  Observable.prototype.trigger = function (event) {
    var slice = Array.prototype.slice;
    var params = slice.call(arguments, 1);

    this.listeners = this.listeners || {};

    // Params should always come in as an array
    if (params == null) {
      params = [];
    }

    // If there are no arguments to the event, use a temporary object
    if (params.length === 0) {
      params.push({});
    }

    // Set the `_type` of the first object to the event
    params[0]._type = event;

    if (event in this.listeners) {
      this.invoke(this.listeners[event], slice.call(arguments, 1));
    }

    if ('*' in this.listeners) {
      this.invoke(this.listeners['*'], arguments);
    }
  };

  Observable.prototype.invoke = function (listeners, params) {
    for (var i = 0, len = listeners.length; i < len; i++) {
      listeners[i].apply(this, params);
    }
  };

  Utils.Observable = Observable;

  Utils.generateChars = function (length) {
    var chars = '';

    for (var i = 0; i < length; i++) {
      var randomChar = Math.floor(Math.random() * 36);
      chars += randomChar.toString(36);
    }

    return chars;
  };

  Utils.bind = function (func, context) {
    return function () {
      func.apply(context, arguments);
    };
  };

  Utils._convertData = function (data) {
    for (var originalKey in data) {
      var keys = originalKey.split('-');

      var dataLevel = data;

      if (keys.length === 1) {
        continue;
      }

      for (var k = 0; k < keys.length; k++) {
        var key = keys[k];

        // Lowercase the first letter
        // By default, dash-separated becomes camelCase
        key = key.substring(0, 1).toLowerCase() + key.substring(1);

        if (!(key in dataLevel)) {
          dataLevel[key] = {};
        }

        if (k == keys.length - 1) {
          dataLevel[key] = data[originalKey];
        }

        dataLevel = dataLevel[key];
      }

      delete data[originalKey];
    }

    return data;
  };

  Utils.hasScroll = function (index, el) {
    // Adapted from the function created by @ShadowScripter
    // and adapted by @BillBarry on the Stack Exchange Code Review website.
    // The original code can be found at
    // http://codereview.stackexchange.com/q/13338
    // and was designed to be used with the Sizzle selector engine.

    var $el = $(el);
    var overflowX = el.style.overflowX;
    var overflowY = el.style.overflowY;

    //Check both x and y declarations
    if (overflowX === overflowY &&
        (overflowY === 'hidden' || overflowY === 'visible')) {
      return false;
    }

    if (overflowX === 'scroll' || overflowY === 'scroll') {
      return true;
    }

    return ($el.innerHeight() < el.scrollHeight ||
      $el.innerWidth() < el.scrollWidth);
  };

  Utils.escapeMarkup = function (markup) {
    var replaceMap = {
      '\\': '&#92;',
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      '\'': '&#39;',
      '/': '&#47;'
    };

    // Do not try to escape the markup if it's not a string
    if (typeof markup !== 'string') {
      return markup;
    }

    return String(markup).replace(/[&<>"'\/\\]/g, function (match) {
      return replaceMap[match];
    });
  };

  // Append an array of jQuery nodes to a given element.
  Utils.appendMany = function ($element, $nodes) {
    // jQuery 1.7.x does not support $.fn.append() with an array
    // Fall back to a jQuery object collection using $.fn.add()
    if ($.fn.jquery.substr(0, 3) === '1.7') {
      var $jqNodes = $();

      $.map($nodes, function (node) {
        $jqNodes = $jqNodes.add(node);
      });

      $nodes = $jqNodes;
    }

    $element.append($nodes);
  };

  // Cache objects in Utils.__cache instead of $.data (see #4346)
  Utils.__cache = {};

  var id = 0;
  Utils.GetUniqueElementId = function (element) {
    // Get a unique element Id. If element has no id,
    // creates a new unique number, stores it in the id
    // attribute and returns the new id.
    // If an id already exists, it simply returns it.

    var select2Id = element.getAttribute('data-select2-id');
    if (select2Id == null) {
      // If element has id, use it.
      if (element.id) {
        select2Id = element.id;
        element.setAttribute('data-select2-id', select2Id);
      } else {
        element.setAttribute('data-select2-id', ++id);
        select2Id = id.toString();
      }
    }
    return select2Id;
  };

  Utils.StoreData = function (element, name, value) {
    // Stores an item in the cache for a specified element.
    // name is the cache key.
    var id = Utils.GetUniqueElementId(element);
    if (!Utils.__cache[id]) {
      Utils.__cache[id] = {};
    }

    Utils.__cache[id][name] = value;
  };

  Utils.GetData = function (element, name) {
    // Retrieves a value from the cache by its key (name)
    // name is optional. If no name specified, return
    // all cache items for the specified element.
    // and for a specified element.
    var id = Utils.GetUniqueElementId(element);
    if (name) {
      if (Utils.__cache[id]) {
        if (Utils.__cache[id][name] != null) {
          return Utils.__cache[id][name];
        }
        return $(element).data(name); // Fallback to HTML5 data attribs.
      }
      return $(element).data(name); // Fallback to HTML5 data attribs.
    } else {
      return Utils.__cache[id];
    }
  };

  Utils.RemoveData = function (element) {
    // Removes all cached items for a specified element.
    var id = Utils.GetUniqueElementId(element);
    if (Utils.__cache[id] != null) {
      delete Utils.__cache[id];
    }

    element.removeAttribute('data-select2-id');
  };

  return Utils;
});

S2.define('select2/results',[
  'jquery',
  './utils'
], function ($, Utils) {
  function Results ($element, options, dataAdapter) {
    this.$element = $element;
    this.data = dataAdapter;
    this.options = options;

    Results.__super__.constructor.call(this);
  }

  Utils.Extend(Results, Utils.Observable);

  Results.prototype.render = function () {
    var $results = $(
      '<ul class="select2-results__options" role="listbox"></ul>'
    );

    if (this.options.get('multiple')) {
      $results.attr('aria-multiselectable', 'true');
    }

    this.$results = $results;

    return $results;
  };

  Results.prototype.clear = function () {
    this.$results.empty();
  };

  Results.prototype.displayMessage = function (params) {
    var escapeMarkup = this.options.get('escapeMarkup');

    this.clear();
    this.hideLoading();

    var $message = $(
      '<li role="alert" aria-live="assertive"' +
      ' class="select2-results__option"></li>'
    );

    var message = this.options.get('translations').get(params.message);

    $message.append(
      escapeMarkup(
        message(params.args)
      )
    );

    $message[0].className += ' select2-results__message';

    this.$results.append($message);
  };

  Results.prototype.hideMessages = function () {
    this.$results.find('.select2-results__message').remove();
  };

  Results.prototype.append = function (data) {
    this.hideLoading();

    var $options = [];

    if (data.results == null || data.results.length === 0) {
      if (this.$results.children().length === 0) {
        this.trigger('results:message', {
          message: 'noResults'
        });
      }

      return;
    }

    data.results = this.sort(data.results);

    for (var d = 0; d < data.results.length; d++) {
      var item = data.results[d];

      var $option = this.option(item);

      $options.push($option);
    }

    this.$results.append($options);
  };

  Results.prototype.position = function ($results, $dropdown) {
    var $resultsContainer = $dropdown.find('.select2-results');
    $resultsContainer.append($results);
  };

  Results.prototype.sort = function (data) {
    var sorter = this.options.get('sorter');

    return sorter(data);
  };

  Results.prototype.highlightFirstItem = function () {
    var $options = this.$results
      .find('.select2-results__option[aria-selected]');

    var $selected = $options.filter('[aria-selected=true]');

    // Check if there are any selected options
    if ($selected.length > 0) {
      // If there are selected options, highlight the first
      $selected.first().trigger('mouseenter');
    } else {
      // If there are no selected options, highlight the first option
      // in the dropdown
      $options.first().trigger('mouseenter');
    }

    this.ensureHighlightVisible();
  };

  Results.prototype.setClasses = function () {
    var self = this;

    this.data.current(function (selected) {
      var selectedIds = $.map(selected, function (s) {
        return s.id.toString();
      });

      var $options = self.$results
        .find('.select2-results__option[aria-selected]');

      $options.each(function () {
        var $option = $(this);

        var item = Utils.GetData(this, 'data');

        // id needs to be converted to a string when comparing
        var id = '' + item.id;

        if ((item.element != null && item.element.selected) ||
            (item.element == null && $.inArray(id, selectedIds) > -1)) {
          $option.attr('aria-selected', 'true');
        } else {
          $option.attr('aria-selected', 'false');
        }
      });

    });
  };

  Results.prototype.showLoading = function (params) {
    this.hideLoading();

    var loadingMore = this.options.get('translations').get('searching');

    var loading = {
      disabled: true,
      loading: true,
      text: loadingMore(params)
    };
    var $loading = this.option(loading);
    $loading.className += ' loading-results';

    this.$results.prepend($loading);
  };

  Results.prototype.hideLoading = function () {
    this.$results.find('.loading-results').remove();
  };

  Results.prototype.option = function (data) {
    var option = document.createElement('li');
    option.className = 'select2-results__option';

    var attrs = {
      'role': 'option',
      'aria-selected': 'false'
    };

    var matches = window.Element.prototype.matches ||
      window.Element.prototype.msMatchesSelector ||
      window.Element.prototype.webkitMatchesSelector;

    if ((data.element != null && matches.call(data.element, ':disabled')) ||
        (data.element == null && data.disabled)) {
      delete attrs['aria-selected'];
      attrs['aria-disabled'] = 'true';
    }

    if (data.id == null) {
      delete attrs['aria-selected'];
    }

    if (data._resultId != null) {
      option.id = data._resultId;
    }

    if (data.title) {
      option.title = data.title;
    }

    if (data.children) {
      attrs.role = 'group';
      attrs['aria-label'] = data.text;
      delete attrs['aria-selected'];
    }

    for (var attr in attrs) {
      var val = attrs[attr];

      option.setAttribute(attr, val);
    }

    if (data.children) {
      var $option = $(option);

      var label = document.createElement('strong');
      label.className = 'select2-results__group';

      var $label = $(label);
      this.template(data, label);

      var $children = [];

      for (var c = 0; c < data.children.length; c++) {
        var child = data.children[c];

        var $child = this.option(child);

        $children.push($child);
      }

      var $childrenContainer = $('<ul></ul>', {
        'class': 'select2-results__options select2-results__options--nested'
      });

      $childrenContainer.append($children);

      $option.append(label);
      $option.append($childrenContainer);
    } else {
      this.template(data, option);
    }

    Utils.StoreData(option, 'data', data);

    return option;
  };

  Results.prototype.bind = function (container, $container) {
    var self = this;

    var id = container.id + '-results';

    this.$results.attr('id', id);

    container.on('results:all', function (params) {
      self.clear();
      self.append(params.data);

      if (container.isOpen()) {
        self.setClasses();
        self.highlightFirstItem();
      }
    });

    container.on('results:append', function (params) {
      self.append(params.data);

      if (container.isOpen()) {
        self.setClasses();
      }
    });

    container.on('query', function (params) {
      self.hideMessages();
      self.showLoading(params);
    });

    container.on('select', function () {
      if (!container.isOpen()) {
        return;
      }

      self.setClasses();

      if (self.options.get('scrollAfterSelect')) {
        self.highlightFirstItem();
      }
    });

    container.on('unselect', function () {
      if (!container.isOpen()) {
        return;
      }

      self.setClasses();

      if (self.options.get('scrollAfterSelect')) {
        self.highlightFirstItem();
      }
    });

    container.on('open', function () {
      // When the dropdown is open, aria-expended="true"
      self.$results.attr('aria-expanded', 'true');
      self.$results.attr('aria-hidden', 'false');

      self.setClasses();
      self.ensureHighlightVisible();
    });

    container.on('close', function () {
      // When the dropdown is closed, aria-expended="false"
      self.$results.attr('aria-expanded', 'false');
      self.$results.attr('aria-hidden', 'true');
      self.$results.removeAttr('aria-activedescendant');
    });

    container.on('results:toggle', function () {
      var $highlighted = self.getHighlightedResults();

      if ($highlighted.length === 0) {
        return;
      }

      $highlighted.trigger('mouseup');
    });

    container.on('results:select', function () {
      var $highlighted = self.getHighlightedResults();

      if ($highlighted.length === 0) {
        return;
      }

      var data = Utils.GetData($highlighted[0], 'data');

      if ($highlighted.attr('aria-selected') == 'true') {
        self.trigger('close', {});
      } else {
        self.trigger('select', {
          data: data
        });
      }
    });

    container.on('results:previous', function () {
      var $highlighted = self.getHighlightedResults();

      var $options = self.$results.find('[aria-selected]');

      var currentIndex = $options.index($highlighted);

      // If we are already at the top, don't move further
      // If no options, currentIndex will be -1
      if (currentIndex <= 0) {
        return;
      }

      var nextIndex = currentIndex - 1;

      // If none are highlighted, highlight the first
      if ($highlighted.length === 0) {
        nextIndex = 0;
      }

      var $next = $options.eq(nextIndex);

      $next.trigger('mouseenter');

      var currentOffset = self.$results.offset().top;
      var nextTop = $next.offset().top;
      var nextOffset = self.$results.scrollTop() + (nextTop - currentOffset);

      if (nextIndex === 0) {
        self.$results.scrollTop(0);
      } else if (nextTop - currentOffset < 0) {
        self.$results.scrollTop(nextOffset);
      }
    });

    container.on('results:next', function () {
      var $highlighted = self.getHighlightedResults();

      var $options = self.$results.find('[aria-selected]');

      var currentIndex = $options.index($highlighted);

      var nextIndex = currentIndex + 1;

      // If we are at the last option, stay there
      if (nextIndex >= $options.length) {
        return;
      }

      var $next = $options.eq(nextIndex);

      $next.trigger('mouseenter');

      var currentOffset = self.$results.offset().top +
        self.$results.outerHeight(false);
      var nextBottom = $next.offset().top + $next.outerHeight(false);
      var nextOffset = self.$results.scrollTop() + nextBottom - currentOffset;

      if (nextIndex === 0) {
        self.$results.scrollTop(0);
      } else if (nextBottom > currentOffset) {
        self.$results.scrollTop(nextOffset);
      }
    });

    container.on('results:focus', function (params) {
      params.element.addClass('select2-results__option--highlighted');
    });

    container.on('results:message', function (params) {
      self.displayMessage(params);
    });

    if ($.fn.mousewheel) {
      this.$results.on('mousewheel', function (e) {
        var top = self.$results.scrollTop();

        var bottom = self.$results.get(0).scrollHeight - top + e.deltaY;

        var isAtTop = e.deltaY > 0 && top - e.deltaY <= 0;
        var isAtBottom = e.deltaY < 0 && bottom <= self.$results.height();

        if (isAtTop) {
          self.$results.scrollTop(0);

          e.preventDefault();
          e.stopPropagation();
        } else if (isAtBottom) {
          self.$results.scrollTop(
            self.$results.get(0).scrollHeight - self.$results.height()
          );

          e.preventDefault();
          e.stopPropagation();
        }
      });
    }

    this.$results.on('mouseup', '.select2-results__option[aria-selected]',
      function (evt) {
      var $this = $(this);

      var data = Utils.GetData(this, 'data');

      if ($this.attr('aria-selected') === 'true') {
        if (self.options.get('multiple')) {
          self.trigger('unselect', {
            originalEvent: evt,
            data: data
          });
        } else {
          self.trigger('close', {});
        }

        return;
      }

      self.trigger('select', {
        originalEvent: evt,
        data: data
      });
    });

    this.$results.on('mouseenter', '.select2-results__option[aria-selected]',
      function (evt) {
      var data = Utils.GetData(this, 'data');

      self.getHighlightedResults()
          .removeClass('select2-results__option--highlighted');

      self.trigger('results:focus', {
        data: data,
        element: $(this)
      });
    });
  };

  Results.prototype.getHighlightedResults = function () {
    var $highlighted = this.$results
    .find('.select2-results__option--highlighted');

    return $highlighted;
  };

  Results.prototype.destroy = function () {
    this.$results.remove();
  };

  Results.prototype.ensureHighlightVisible = function () {
    var $highlighted = this.getHighlightedResults();

    if ($highlighted.length === 0) {
      return;
    }

    var $options = this.$results.find('[aria-selected]');

    var currentIndex = $options.index($highlighted);

    var currentOffset = this.$results.offset().top;
    var nextTop = $highlighted.offset().top;
    var nextOffset = this.$results.scrollTop() + (nextTop - currentOffset);

    var offsetDelta = nextTop - currentOffset;
    nextOffset -= $highlighted.outerHeight(false) * 2;

    if (currentIndex <= 2) {
      this.$results.scrollTop(0);
    } else if (offsetDelta > this.$results.outerHeight() || offsetDelta < 0) {
      this.$results.scrollTop(nextOffset);
    }
  };

  Results.prototype.template = function (result, container) {
    var template = this.options.get('templateResult');
    var escapeMarkup = this.options.get('escapeMarkup');

    var content = template(result, container);

    if (content == null) {
      container.style.display = 'none';
    } else if (typeof content === 'string') {
      container.innerHTML = escapeMarkup(content);
    } else {
      $(container).append(content);
    }
  };

  return Results;
});

S2.define('select2/keys',[

], function () {
  var KEYS = {
    BACKSPACE: 8,
    TAB: 9,
    ENTER: 13,
    SHIFT: 16,
    CTRL: 17,
    ALT: 18,
    ESC: 27,
    SPACE: 32,
    PAGE_UP: 33,
    PAGE_DOWN: 34,
    END: 35,
    HOME: 36,
    LEFT: 37,
    UP: 38,
    RIGHT: 39,
    DOWN: 40,
    DELETE: 46
  };

  return KEYS;
});

S2.define('select2/selection/base',[
  'jquery',
  '../utils',
  '../keys'
], function ($, Utils, KEYS) {
  function BaseSelection ($element, options) {
    this.$element = $element;
    this.options = options;

    BaseSelection.__super__.constructor.call(this);
  }

  Utils.Extend(BaseSelection, Utils.Observable);

  BaseSelection.prototype.render = function () {
    var $selection = $(
      '<span class="select2-selection" role="combobox" ' +
      ' aria-haspopup="true" aria-expanded="false">' +
      '</span>'
    );

    this._tabindex = 0;

    if (Utils.GetData(this.$element[0], 'old-tabindex') != null) {
      this._tabindex = Utils.GetData(this.$element[0], 'old-tabindex');
    } else if (this.$element.attr('tabindex') != null) {
      this._tabindex = this.$element.attr('tabindex');
    }

    $selection.attr('title', this.$element.attr('title'));
    $selection.attr('tabindex', this._tabindex);
    $selection.attr('aria-disabled', 'false');

    this.$selection = $selection;

    return $selection;
  };

  BaseSelection.prototype.bind = function (container, $container) {
    var self = this;

    var resultsId = container.id + '-results';

    this.container = container;

    this.$selection.on('focus', function (evt) {
      self.trigger('focus', evt);
    });

    this.$selection.on('blur', function (evt) {
      self._handleBlur(evt);
    });

    this.$selection.on('keydown', function (evt) {
      self.trigger('keypress', evt);

      if (evt.which === KEYS.SPACE) {
        evt.preventDefault();
      }
    });

    container.on('results:focus', function (params) {
      self.$selection.attr('aria-activedescendant', params.data._resultId);
    });

    container.on('selection:update', function (params) {
      self.update(params.data);
    });

    container.on('open', function () {
      // When the dropdown is open, aria-expanded="true"
      self.$selection.attr('aria-expanded', 'true');
      self.$selection.attr('aria-owns', resultsId);

      self._attachCloseHandler(container);
    });

    container.on('close', function () {
      // When the dropdown is closed, aria-expanded="false"
      self.$selection.attr('aria-expanded', 'false');
      self.$selection.removeAttr('aria-activedescendant');
      self.$selection.removeAttr('aria-owns');

      self.$selection.trigger('focus');

      self._detachCloseHandler(container);
    });

    container.on('enable', function () {
      self.$selection.attr('tabindex', self._tabindex);
      self.$selection.attr('aria-disabled', 'false');
    });

    container.on('disable', function () {
      self.$selection.attr('tabindex', '-1');
      self.$selection.attr('aria-disabled', 'true');
    });
  };

  BaseSelection.prototype._handleBlur = function (evt) {
    var self = this;

    // This needs to be delayed as the active element is the body when the tab
    // key is pressed, possibly along with others.
    window.setTimeout(function () {
      // Don't trigger `blur` if the focus is still in the selection
      if (
        (document.activeElement == self.$selection[0]) ||
        ($.contains(self.$selection[0], document.activeElement))
      ) {
        return;
      }

      self.trigger('blur', evt);
    }, 1);
  };

  BaseSelection.prototype._attachCloseHandler = function (container) {

    $(document.body).on('mousedown.select2.' + container.id, function (e) {
      var $target = $(e.target);

      var $select = $target.closest('.select2');

      var $all = $('.select2.select2-container--open');

      $all.each(function () {
        if (this == $select[0]) {
          return;
        }

        var $element = Utils.GetData(this, 'element');

        $element.select2('close');
      });
    });
  };

  BaseSelection.prototype._detachCloseHandler = function (container) {
    $(document.body).off('mousedown.select2.' + container.id);
  };

  BaseSelection.prototype.position = function ($selection, $container) {
    var $selectionContainer = $container.find('.selection');
    $selectionContainer.append($selection);
  };

  BaseSelection.prototype.destroy = function () {
    this._detachCloseHandler(this.container);
  };

  BaseSelection.prototype.update = function (data) {
    throw new Error('The `update` method must be defined in child classes.');
  };

  /**
   * Helper method to abstract the "enabled" (not "disabled") state of this
   * object.
   *
   * @return {true} if the instance is not disabled.
   * @return {false} if the instance is disabled.
   */
  BaseSelection.prototype.isEnabled = function () {
    return !this.isDisabled();
  };

  /**
   * Helper method to abstract the "disabled" state of this object.
   *
   * @return {true} if the disabled option is true.
   * @return {false} if the disabled option is false.
   */
  BaseSelection.prototype.isDisabled = function () {
    return this.options.get('disabled');
  };

  return BaseSelection;
});

S2.define('select2/selection/single',[
  'jquery',
  './base',
  '../utils',
  '../keys'
], function ($, BaseSelection, Utils, KEYS) {
  function SingleSelection () {
    SingleSelection.__super__.constructor.apply(this, arguments);
  }

  Utils.Extend(SingleSelection, BaseSelection);

  SingleSelection.prototype.render = function () {
    var $selection = SingleSelection.__super__.render.call(this);

    $selection.addClass('select2-selection--single');

    $selection.html(
      '<span class="select2-selection__rendered"></span>' +
      '<span class="select2-selection__arrow" role="presentation">' +
        '<b role="presentation"></b>' +
      '</span>'
    );

    return $selection;
  };

  SingleSelection.prototype.bind = function (container, $container) {
    var self = this;

    SingleSelection.__super__.bind.apply(this, arguments);

    var id = container.id + '-container';

    this.$selection.find('.select2-selection__rendered')
      .attr('id', id)
      .attr('role', 'textbox')
      .attr('aria-readonly', 'true');
    this.$selection.attr('aria-labelledby', id);

    this.$selection.on('mousedown', function (evt) {
      // Only respond to left clicks
      if (evt.which !== 1) {
        return;
      }

      self.trigger('toggle', {
        originalEvent: evt
      });
    });

    this.$selection.on('focus', function (evt) {
      // User focuses on the container
    });

    this.$selection.on('blur', function (evt) {
      // User exits the container
    });

    container.on('focus', function (evt) {
      if (!container.isOpen()) {
        self.$selection.trigger('focus');
      }
    });
  };

  SingleSelection.prototype.clear = function () {
    var $rendered = this.$selection.find('.select2-selection__rendered');
    $rendered.empty();
    $rendered.removeAttr('title'); // clear tooltip on empty
  };

  SingleSelection.prototype.display = function (data, container) {
    var template = this.options.get('templateSelection');
    var escapeMarkup = this.options.get('escapeMarkup');

    return escapeMarkup(template(data, container));
  };

  SingleSelection.prototype.selectionContainer = function () {
    return $('<span></span>');
  };

  SingleSelection.prototype.update = function (data) {
    if (data.length === 0) {
      this.clear();
      return;
    }

    var selection = data[0];

    var $rendered = this.$selection.find('.select2-selection__rendered');
    var formatted = this.display(selection, $rendered);

    $rendered.empty().append(formatted);

    var title = selection.title || selection.text;

    if (title) {
      $rendered.attr('title', title);
    } else {
      $rendered.removeAttr('title');
    }
  };

  return SingleSelection;
});

S2.define('select2/selection/multiple',[
  'jquery',
  './base',
  '../utils'
], function ($, BaseSelection, Utils) {
  function MultipleSelection ($element, options) {
    MultipleSelection.__super__.constructor.apply(this, arguments);
  }

  Utils.Extend(MultipleSelection, BaseSelection);

  MultipleSelection.prototype.render = function () {
    var $selection = MultipleSelection.__super__.render.call(this);

    $selection.addClass('select2-selection--multiple');

    $selection.html(
      '<ul class="select2-selection__rendered"></ul>'
    );

    return $selection;
  };

  MultipleSelection.prototype.bind = function (container, $container) {
    var self = this;

    MultipleSelection.__super__.bind.apply(this, arguments);

    this.$selection.on('click', function (evt) {
      self.trigger('toggle', {
        originalEvent: evt
      });
    });

    this.$selection.on(
      'click',
      '.select2-selection__choice__remove',
      function (evt) {
        // Ignore the event if it is disabled
        if (self.isDisabled()) {
          return;
        }

        var $remove = $(this);
        var $selection = $remove.parent();

        var data = Utils.GetData($selection[0], 'data');

        self.trigger('unselect', {
          originalEvent: evt,
          data: data
        });
      }
    );
  };

  MultipleSelection.prototype.clear = function () {
    var $rendered = this.$selection.find('.select2-selection__rendered');
    $rendered.empty();
    $rendered.removeAttr('title');
  };

  MultipleSelection.prototype.display = function (data, container) {
    var template = this.options.get('templateSelection');
    var escapeMarkup = this.options.get('escapeMarkup');

    return escapeMarkup(template(data, container));
  };

  MultipleSelection.prototype.selectionContainer = function () {
    var $container = $(
      '<li class="select2-selection__choice">' +
        '<span class="select2-selection__choice__remove" role="presentation">' +
          '&times;' +
        '</span>' +
      '</li>'
    );

    return $container;
  };

  MultipleSelection.prototype.update = function (data) {
    this.clear();

    if (data.length === 0) {
      return;
    }

    var $selections = [];

    for (var d = 0; d < data.length; d++) {
      var selection = data[d];

      var $selection = this.selectionContainer();
      var formatted = this.display(selection, $selection);

      $selection.append(formatted);

      var title = selection.title || selection.text;

      if (title) {
        $selection.attr('title', title);
      }

      Utils.StoreData($selection[0], 'data', selection);

      $selections.push($selection);
    }

    var $rendered = this.$selection.find('.select2-selection__rendered');

    Utils.appendMany($rendered, $selections);
  };

  return MultipleSelection;
});

S2.define('select2/selection/placeholder',[
  '../utils'
], function (Utils) {
  function Placeholder (decorated, $element, options) {
    this.placeholder = this.normalizePlaceholder(options.get('placeholder'));

    decorated.call(this, $element, options);
  }

  Placeholder.prototype.normalizePlaceholder = function (_, placeholder) {
    if (typeof placeholder === 'string') {
      placeholder = {
        id: '',
        text: placeholder
      };
    }

    return placeholder;
  };

  Placeholder.prototype.createPlaceholder = function (decorated, placeholder) {
    var $placeholder = this.selectionContainer();

    $placeholder.html(this.display(placeholder));
    $placeholder.addClass('select2-selection__placeholder')
                .removeClass('select2-selection__choice');

    return $placeholder;
  };

  Placeholder.prototype.update = function (decorated, data) {
    var singlePlaceholder = (
      data.length == 1 && data[0].id != this.placeholder.id
    );
    var multipleSelections = data.length > 1;

    if (multipleSelections || singlePlaceholder) {
      return decorated.call(this, data);
    }

    this.clear();

    var $placeholder = this.createPlaceholder(this.placeholder);

    this.$selection.find('.select2-selection__rendered').append($placeholder);
  };

  return Placeholder;
});

S2.define('select2/selection/allowClear',[
  'jquery',
  '../keys',
  '../utils'
], function ($, KEYS, Utils) {
  function AllowClear () { }

  AllowClear.prototype.bind = function (decorated, container, $container) {
    var self = this;

    decorated.call(this, container, $container);

    if (this.placeholder == null) {
      if (this.options.get('debug') && window.console && console.error) {
        console.error(
          'Select2: The `allowClear` option should be used in combination ' +
          'with the `placeholder` option.'
        );
      }
    }

    this.$selection.on('mousedown', '.select2-selection__clear',
      function (evt) {
        self._handleClear(evt);
    });

    container.on('keypress', function (evt) {
      self._handleKeyboardClear(evt, container);
    });
  };

  AllowClear.prototype._handleClear = function (_, evt) {
    // Ignore the event if it is disabled
    if (this.isDisabled()) {
      return;
    }

    var $clear = this.$selection.find('.select2-selection__clear');

    // Ignore the event if nothing has been selected
    if ($clear.length === 0) {
      return;
    }

    evt.stopPropagation();

    var data = Utils.GetData($clear[0], 'data');

    var previousVal = this.$element.val();
    this.$element.val(this.placeholder.id);

    var unselectData = {
      data: data
    };
    this.trigger('clear', unselectData);
    if (unselectData.prevented) {
      this.$element.val(previousVal);
      return;
    }

    for (var d = 0; d < data.length; d++) {
      unselectData = {
        data: data[d]
      };

      // Trigger the `unselect` event, so people can prevent it from being
      // cleared.
      this.trigger('unselect', unselectData);

      // If the event was prevented, don't clear it out.
      if (unselectData.prevented) {
        this.$element.val(previousVal);
        return;
      }
    }

    this.$element.trigger('input').trigger('change');

    this.trigger('toggle', {});
  };

  AllowClear.prototype._handleKeyboardClear = function (_, evt, container) {
    if (container.isOpen()) {
      return;
    }

    if (evt.which == KEYS.DELETE || evt.which == KEYS.BACKSPACE) {
      this._handleClear(evt);
    }
  };

  AllowClear.prototype.update = function (decorated, data) {
    decorated.call(this, data);

    if (this.$selection.find('.select2-selection__placeholder').length > 0 ||
        data.length === 0) {
      return;
    }

    var removeAll = this.options.get('translations').get('removeAllItems');

    var $remove = $(
      '<span class="select2-selection__clear" title="' + removeAll() +'">' +
        '&times;' +
      '</span>'
    );
    Utils.StoreData($remove[0], 'data', data);

    this.$selection.find('.select2-selection__rendered').prepend($remove);
  };

  return AllowClear;
});

S2.define('select2/selection/search',[
  'jquery',
  '../utils',
  '../keys'
], function ($, Utils, KEYS) {
  function Search (decorated, $element, options) {
    decorated.call(this, $element, options);
  }

  Search.prototype.render = function (decorated) {
    var $search = $(
      '<li class="select2-search select2-search--inline">' +
        '<input class="select2-search__field" type="search" tabindex="-1"' +
        ' autocomplete="off" autocorrect="off" autocapitalize="none"' +
        ' spellcheck="false" role="searchbox" aria-autocomplete="list" />' +
      '</li>'
    );

    this.$searchContainer = $search;
    this.$search = $search.find('input');

    var $rendered = decorated.call(this);

    this._transferTabIndex();

    return $rendered;
  };

  Search.prototype.bind = function (decorated, container, $container) {
    var self = this;

    var resultsId = container.id + '-results';

    decorated.call(this, container, $container);

    container.on('open', function () {
      self.$search.attr('aria-controls', resultsId);
      self.$search.trigger('focus');
    });

    container.on('close', function () {
      self.$search.val('');
      self.$search.removeAttr('aria-controls');
      self.$search.removeAttr('aria-activedescendant');
      self.$search.trigger('focus');
    });

    container.on('enable', function () {
      self.$search.prop('disabled', false);

      self._transferTabIndex();
    });

    container.on('disable', function () {
      self.$search.prop('disabled', true);
    });

    container.on('focus', function (evt) {
      self.$search.trigger('focus');
    });

    container.on('results:focus', function (params) {
      if (params.data._resultId) {
        self.$search.attr('aria-activedescendant', params.data._resultId);
      } else {
        self.$search.removeAttr('aria-activedescendant');
      }
    });

    this.$selection.on('focusin', '.select2-search--inline', function (evt) {
      self.trigger('focus', evt);
    });

    this.$selection.on('focusout', '.select2-search--inline', function (evt) {
      self._handleBlur(evt);
    });

    this.$selection.on('keydown', '.select2-search--inline', function (evt) {
      evt.stopPropagation();

      self.trigger('keypress', evt);

      self._keyUpPrevented = evt.isDefaultPrevented();

      var key = evt.which;

      if (key === KEYS.BACKSPACE && self.$search.val() === '') {
        var $previousChoice = self.$searchContainer
          .prev('.select2-selection__choice');

        if ($previousChoice.length > 0) {
          var item = Utils.GetData($previousChoice[0], 'data');

          self.searchRemoveChoice(item);

          evt.preventDefault();
        }
      }
    });

    this.$selection.on('click', '.select2-search--inline', function (evt) {
      if (self.$search.val()) {
        evt.stopPropagation();
      }
    });

    // Try to detect the IE version should the `documentMode` property that
    // is stored on the document. This is only implemented in IE and is
    // slightly cleaner than doing a user agent check.
    // This property is not available in Edge, but Edge also doesn't have
    // this bug.
    var msie = document.documentMode;
    var disableInputEvents = msie && msie <= 11;

    // Workaround for browsers which do not support the `input` event
    // This will prevent double-triggering of events for browsers which support
    // both the `keyup` and `input` events.
    this.$selection.on(
      'input.searchcheck',
      '.select2-search--inline',
      function (evt) {
        // IE will trigger the `input` event when a placeholder is used on a
        // search box. To get around this issue, we are forced to ignore all
        // `input` events in IE and keep using `keyup`.
        if (disableInputEvents) {
          self.$selection.off('input.search input.searchcheck');
          return;
        }

        // Unbind the duplicated `keyup` event
        self.$selection.off('keyup.search');
      }
    );

    this.$selection.on(
      'keyup.search input.search',
      '.select2-search--inline',
      function (evt) {
        // IE will trigger the `input` event when a placeholder is used on a
        // search box. To get around this issue, we are forced to ignore all
        // `input` events in IE and keep using `keyup`.
        if (disableInputEvents && evt.type === 'input') {
          self.$selection.off('input.search input.searchcheck');
          return;
        }

        var key = evt.which;

        // We can freely ignore events from modifier keys
        if (key == KEYS.SHIFT || key == KEYS.CTRL || key == KEYS.ALT) {
          return;
        }

        // Tabbing will be handled during the `keydown` phase
        if (key == KEYS.TAB) {
          return;
        }

        self.handleSearch(evt);
      }
    );
  };

  /**
   * This method will transfer the tabindex attribute from the rendered
   * selection to the search box. This allows for the search box to be used as
   * the primary focus instead of the selection container.
   *
   * @private
   */
  Search.prototype._transferTabIndex = function (decorated) {
    this.$search.attr('tabindex', this.$selection.attr('tabindex'));
    this.$selection.attr('tabindex', '-1');
  };

  Search.prototype.createPlaceholder = function (decorated, placeholder) {
    this.$search.attr('placeholder', placeholder.text);
  };

  Search.prototype.update = function (decorated, data) {
    var searchHadFocus = this.$search[0] == document.activeElement;

    this.$search.attr('placeholder', '');

    decorated.call(this, data);

    this.$selection.find('.select2-selection__rendered')
                   .append(this.$searchContainer);

    this.resizeSearch();
    if (searchHadFocus) {
      this.$search.trigger('focus');
    }
  };

  Search.prototype.handleSearch = function () {
    this.resizeSearch();

    if (!this._keyUpPrevented) {
      var input = this.$search.val();

      this.trigger('query', {
        term: input
      });
    }

    this._keyUpPrevented = false;
  };

  Search.prototype.searchRemoveChoice = function (decorated, item) {
    this.trigger('unselect', {
      data: item
    });

    this.$search.val(item.text);
    this.handleSearch();
  };

  Search.prototype.resizeSearch = function () {
    this.$search.css('width', '25px');

    var width = '';

    if (this.$search.attr('placeholder') !== '') {
      width = this.$selection.find('.select2-selection__rendered').width();
    } else {
      var minimumWidth = this.$search.val().length + 1;

      width = (minimumWidth * 0.75) + 'em';
    }

    this.$search.css('width', width);
  };

  return Search;
});

S2.define('select2/selection/eventRelay',[
  'jquery'
], function ($) {
  function EventRelay () { }

  EventRelay.prototype.bind = function (decorated, container, $container) {
    var self = this;
    var relayEvents = [
      'open', 'opening',
      'close', 'closing',
      'select', 'selecting',
      'unselect', 'unselecting',
      'clear', 'clearing'
    ];

    var preventableEvents = [
      'opening', 'closing', 'selecting', 'unselecting', 'clearing'
    ];

    decorated.call(this, container, $container);

    container.on('*', function (name, params) {
      // Ignore events that should not be relayed
      if ($.inArray(name, relayEvents) === -1) {
        return;
      }

      // The parameters should always be an object
      params = params || {};

      // Generate the jQuery event for the Select2 event
      var evt = $.Event('select2:' + name, {
        params: params
      });

      self.$element.trigger(evt);

      // Only handle preventable events if it was one
      if ($.inArray(name, preventableEvents) === -1) {
        return;
      }

      params.prevented = evt.isDefaultPrevented();
    });
  };

  return EventRelay;
});

S2.define('select2/translation',[
  'jquery',
  'require'
], function ($, require) {
  function Translation (dict) {
    this.dict = dict || {};
  }

  Translation.prototype.all = function () {
    return this.dict;
  };

  Translation.prototype.get = function (key) {
    return this.dict[key];
  };

  Translation.prototype.extend = function (translation) {
    this.dict = $.extend({}, translation.all(), this.dict);
  };

  // Static functions

  Translation._cache = {};

  Translation.loadPath = function (path) {
    if (!(path in Translation._cache)) {
      var translations = require(path);

      Translation._cache[path] = translations;
    }

    return new Translation(Translation._cache[path]);
  };

  return Translation;
});

S2.define('select2/diacritics',[

], function () {
  var diacritics = {
    '\u24B6': 'A',
    '\uFF21': 'A',
    '\u00C0': 'A',
    '\u00C1': 'A',
    '\u00C2': 'A',
    '\u1EA6': 'A',
    '\u1EA4': 'A',
    '\u1EAA': 'A',
    '\u1EA8': 'A',
    '\u00C3': 'A',
    '\u0100': 'A',
    '\u0102': 'A',
    '\u1EB0': 'A',
    '\u1EAE': 'A',
    '\u1EB4': 'A',
    '\u1EB2': 'A',
    '\u0226': 'A',
    '\u01E0': 'A',
    '\u00C4': 'A',
    '\u01DE': 'A',
    '\u1EA2': 'A',
    '\u00C5': 'A',
    '\u01FA': 'A',
    '\u01CD': 'A',
    '\u0200': 'A',
    '\u0202': 'A',
    '\u1EA0': 'A',
    '\u1EAC': 'A',
    '\u1EB6': 'A',
    '\u1E00': 'A',
    '\u0104': 'A',
    '\u023A': 'A',
    '\u2C6F': 'A',
    '\uA732': 'AA',
    '\u00C6': 'AE',
    '\u01FC': 'AE',
    '\u01E2': 'AE',
    '\uA734': 'AO',
    '\uA736': 'AU',
    '\uA738': 'AV',
    '\uA73A': 'AV',
    '\uA73C': 'AY',
    '\u24B7': 'B',
    '\uFF22': 'B',
    '\u1E02': 'B',
    '\u1E04': 'B',
    '\u1E06': 'B',
    '\u0243': 'B',
    '\u0182': 'B',
    '\u0181': 'B',
    '\u24B8': 'C',
    '\uFF23': 'C',
    '\u0106': 'C',
    '\u0108': 'C',
    '\u010A': 'C',
    '\u010C': 'C',
    '\u00C7': 'C',
    '\u1E08': 'C',
    '\u0187': 'C',
    '\u023B': 'C',
    '\uA73E': 'C',
    '\u24B9': 'D',
    '\uFF24': 'D',
    '\u1E0A': 'D',
    '\u010E': 'D',
    '\u1E0C': 'D',
    '\u1E10': 'D',
    '\u1E12': 'D',
    '\u1E0E': 'D',
    '\u0110': 'D',
    '\u018B': 'D',
    '\u018A': 'D',
    '\u0189': 'D',
    '\uA779': 'D',
    '\u01F1': 'DZ',
    '\u01C4': 'DZ',
    '\u01F2': 'Dz',
    '\u01C5': 'Dz',
    '\u24BA': 'E',
    '\uFF25': 'E',
    '\u00C8': 'E',
    '\u00C9': 'E',
    '\u00CA': 'E',
    '\u1EC0': 'E',
    '\u1EBE': 'E',
    '\u1EC4': 'E',
    '\u1EC2': 'E',
    '\u1EBC': 'E',
    '\u0112': 'E',
    '\u1E14': 'E',
    '\u1E16': 'E',
    '\u0114': 'E',
    '\u0116': 'E',
    '\u00CB': 'E',
    '\u1EBA': 'E',
    '\u011A': 'E',
    '\u0204': 'E',
    '\u0206': 'E',
    '\u1EB8': 'E',
    '\u1EC6': 'E',
    '\u0228': 'E',
    '\u1E1C': 'E',
    '\u0118': 'E',
    '\u1E18': 'E',
    '\u1E1A': 'E',
    '\u0190': 'E',
    '\u018E': 'E',
    '\u24BB': 'F',
    '\uFF26': 'F',
    '\u1E1E': 'F',
    '\u0191': 'F',
    '\uA77B': 'F',
    '\u24BC': 'G',
    '\uFF27': 'G',
    '\u01F4': 'G',
    '\u011C': 'G',
    '\u1E20': 'G',
    '\u011E': 'G',
    '\u0120': 'G',
    '\u01E6': 'G',
    '\u0122': 'G',
    '\u01E4': 'G',
    '\u0193': 'G',
    '\uA7A0': 'G',
    '\uA77D': 'G',
    '\uA77E': 'G',
    '\u24BD': 'H',
    '\uFF28': 'H',
    '\u0124': 'H',
    '\u1E22': 'H',
    '\u1E26': 'H',
    '\u021E': 'H',
    '\u1E24': 'H',
    '\u1E28': 'H',
    '\u1E2A': 'H',
    '\u0126': 'H',
    '\u2C67': 'H',
    '\u2C75': 'H',
    '\uA78D': 'H',
    '\u24BE': 'I',
    '\uFF29': 'I',
    '\u00CC': 'I',
    '\u00CD': 'I',
    '\u00CE': 'I',
    '\u0128': 'I',
    '\u012A': 'I',
    '\u012C': 'I',
    '\u0130': 'I',
    '\u00CF': 'I',
    '\u1E2E': 'I',
    '\u1EC8': 'I',
    '\u01CF': 'I',
    '\u0208': 'I',
    '\u020A': 'I',
    '\u1ECA': 'I',
    '\u012E': 'I',
    '\u1E2C': 'I',
    '\u0197': 'I',
    '\u24BF': 'J',
    '\uFF2A': 'J',
    '\u0134': 'J',
    '\u0248': 'J',
    '\u24C0': 'K',
    '\uFF2B': 'K',
    '\u1E30': 'K',
    '\u01E8': 'K',
    '\u1E32': 'K',
    '\u0136': 'K',
    '\u1E34': 'K',
    '\u0198': 'K',
    '\u2C69': 'K',
    '\uA740': 'K',
    '\uA742': 'K',
    '\uA744': 'K',
    '\uA7A2': 'K',
    '\u24C1': 'L',
    '\uFF2C': 'L',
    '\u013F': 'L',
    '\u0139': 'L',
    '\u013D': 'L',
    '\u1E36': 'L',
    '\u1E38': 'L',
    '\u013B': 'L',
    '\u1E3C': 'L',
    '\u1E3A': 'L',
    '\u0141': 'L',
    '\u023D': 'L',
    '\u2C62': 'L',
    '\u2C60': 'L',
    '\uA748': 'L',
    '\uA746': 'L',
    '\uA780': 'L',
    '\u01C7': 'LJ',
    '\u01C8': 'Lj',
    '\u24C2': 'M',
    '\uFF2D': 'M',
    '\u1E3E': 'M',
    '\u1E40': 'M',
    '\u1E42': 'M',
    '\u2C6E': 'M',
    '\u019C': 'M',
    '\u24C3': 'N',
    '\uFF2E': 'N',
    '\u01F8': 'N',
    '\u0143': 'N',
    '\u00D1': 'N',
    '\u1E44': 'N',
    '\u0147': 'N',
    '\u1E46': 'N',
    '\u0145': 'N',
    '\u1E4A': 'N',
    '\u1E48': 'N',
    '\u0220': 'N',
    '\u019D': 'N',
    '\uA790': 'N',
    '\uA7A4': 'N',
    '\u01CA': 'NJ',
    '\u01CB': 'Nj',
    '\u24C4': 'O',
    '\uFF2F': 'O',
    '\u00D2': 'O',
    '\u00D3': 'O',
    '\u00D4': 'O',
    '\u1ED2': 'O',
    '\u1ED0': 'O',
    '\u1ED6': 'O',
    '\u1ED4': 'O',
    '\u00D5': 'O',
    '\u1E4C': 'O',
    '\u022C': 'O',
    '\u1E4E': 'O',
    '\u014C': 'O',
    '\u1E50': 'O',
    '\u1E52': 'O',
    '\u014E': 'O',
    '\u022E': 'O',
    '\u0230': 'O',
    '\u00D6': 'O',
    '\u022A': 'O',
    '\u1ECE': 'O',
    '\u0150': 'O',
    '\u01D1': 'O',
    '\u020C': 'O',
    '\u020E': 'O',
    '\u01A0': 'O',
    '\u1EDC': 'O',
    '\u1EDA': 'O',
    '\u1EE0': 'O',
    '\u1EDE': 'O',
    '\u1EE2': 'O',
    '\u1ECC': 'O',
    '\u1ED8': 'O',
    '\u01EA': 'O',
    '\u01EC': 'O',
    '\u00D8': 'O',
    '\u01FE': 'O',
    '\u0186': 'O',
    '\u019F': 'O',
    '\uA74A': 'O',
    '\uA74C': 'O',
    '\u0152': 'OE',
    '\u01A2': 'OI',
    '\uA74E': 'OO',
    '\u0222': 'OU',
    '\u24C5': 'P',
    '\uFF30': 'P',
    '\u1E54': 'P',
    '\u1E56': 'P',
    '\u01A4': 'P',
    '\u2C63': 'P',
    '\uA750': 'P',
    '\uA752': 'P',
    '\uA754': 'P',
    '\u24C6': 'Q',
    '\uFF31': 'Q',
    '\uA756': 'Q',
    '\uA758': 'Q',
    '\u024A': 'Q',
    '\u24C7': 'R',
    '\uFF32': 'R',
    '\u0154': 'R',
    '\u1E58': 'R',
    '\u0158': 'R',
    '\u0210': 'R',
    '\u0212': 'R',
    '\u1E5A': 'R',
    '\u1E5C': 'R',
    '\u0156': 'R',
    '\u1E5E': 'R',
    '\u024C': 'R',
    '\u2C64': 'R',
    '\uA75A': 'R',
    '\uA7A6': 'R',
    '\uA782': 'R',
    '\u24C8': 'S',
    '\uFF33': 'S',
    '\u1E9E': 'S',
    '\u015A': 'S',
    '\u1E64': 'S',
    '\u015C': 'S',
    '\u1E60': 'S',
    '\u0160': 'S',
    '\u1E66': 'S',
    '\u1E62': 'S',
    '\u1E68': 'S',
    '\u0218': 'S',
    '\u015E': 'S',
    '\u2C7E': 'S',
    '\uA7A8': 'S',
    '\uA784': 'S',
    '\u24C9': 'T',
    '\uFF34': 'T',
    '\u1E6A': 'T',
    '\u0164': 'T',
    '\u1E6C': 'T',
    '\u021A': 'T',
    '\u0162': 'T',
    '\u1E70': 'T',
    '\u1E6E': 'T',
    '\u0166': 'T',
    '\u01AC': 'T',
    '\u01AE': 'T',
    '\u023E': 'T',
    '\uA786': 'T',
    '\uA728': 'TZ',
    '\u24CA': 'U',
    '\uFF35': 'U',
    '\u00D9': 'U',
    '\u00DA': 'U',
    '\u00DB': 'U',
    '\u0168': 'U',
    '\u1E78': 'U',
    '\u016A': 'U',
    '\u1E7A': 'U',
    '\u016C': 'U',
    '\u00DC': 'U',
    '\u01DB': 'U',
    '\u01D7': 'U',
    '\u01D5': 'U',
    '\u01D9': 'U',
    '\u1EE6': 'U',
    '\u016E': 'U',
    '\u0170': 'U',
    '\u01D3': 'U',
    '\u0214': 'U',
    '\u0216': 'U',
    '\u01AF': 'U',
    '\u1EEA': 'U',
    '\u1EE8': 'U',
    '\u1EEE': 'U',
    '\u1EEC': 'U',
    '\u1EF0': 'U',
    '\u1EE4': 'U',
    '\u1E72': 'U',
    '\u0172': 'U',
    '\u1E76': 'U',
    '\u1E74': 'U',
    '\u0244': 'U',
    '\u24CB': 'V',
    '\uFF36': 'V',
    '\u1E7C': 'V',
    '\u1E7E': 'V',
    '\u01B2': 'V',
    '\uA75E': 'V',
    '\u0245': 'V',
    '\uA760': 'VY',
    '\u24CC': 'W',
    '\uFF37': 'W',
    '\u1E80': 'W',
    '\u1E82': 'W',
    '\u0174': 'W',
    '\u1E86': 'W',
    '\u1E84': 'W',
    '\u1E88': 'W',
    '\u2C72': 'W',
    '\u24CD': 'X',
    '\uFF38': 'X',
    '\u1E8A': 'X',
    '\u1E8C': 'X',
    '\u24CE': 'Y',
    '\uFF39': 'Y',
    '\u1EF2': 'Y',
    '\u00DD': 'Y',
    '\u0176': 'Y',
    '\u1EF8': 'Y',
    '\u0232': 'Y',
    '\u1E8E': 'Y',
    '\u0178': 'Y',
    '\u1EF6': 'Y',
    '\u1EF4': 'Y',
    '\u01B3': 'Y',
    '\u024E': 'Y',
    '\u1EFE': 'Y',
    '\u24CF': 'Z',
    '\uFF3A': 'Z',
    '\u0179': 'Z',
    '\u1E90': 'Z',
    '\u017B': 'Z',
    '\u017D': 'Z',
    '\u1E92': 'Z',
    '\u1E94': 'Z',
    '\u01B5': 'Z',
    '\u0224': 'Z',
    '\u2C7F': 'Z',
    '\u2C6B': 'Z',
    '\uA762': 'Z',
    '\u24D0': 'a',
    '\uFF41': 'a',
    '\u1E9A': 'a',
    '\u00E0': 'a',
    '\u00E1': 'a',
    '\u00E2': 'a',
    '\u1EA7': 'a',
    '\u1EA5': 'a',
    '\u1EAB': 'a',
    '\u1EA9': 'a',
    '\u00E3': 'a',
    '\u0101': 'a',
    '\u0103': 'a',
    '\u1EB1': 'a',
    '\u1EAF': 'a',
    '\u1EB5': 'a',
    '\u1EB3': 'a',
    '\u0227': 'a',
    '\u01E1': 'a',
    '\u00E4': 'a',
    '\u01DF': 'a',
    '\u1EA3': 'a',
    '\u00E5': 'a',
    '\u01FB': 'a',
    '\u01CE': 'a',
    '\u0201': 'a',
    '\u0203': 'a',
    '\u1EA1': 'a',
    '\u1EAD': 'a',
    '\u1EB7': 'a',
    '\u1E01': 'a',
    '\u0105': 'a',
    '\u2C65': 'a',
    '\u0250': 'a',
    '\uA733': 'aa',
    '\u00E6': 'ae',
    '\u01FD': 'ae',
    '\u01E3': 'ae',
    '\uA735': 'ao',
    '\uA737': 'au',
    '\uA739': 'av',
    '\uA73B': 'av',
    '\uA73D': 'ay',
    '\u24D1': 'b',
    '\uFF42': 'b',
    '\u1E03': 'b',
    '\u1E05': 'b',
    '\u1E07': 'b',
    '\u0180': 'b',
    '\u0183': 'b',
    '\u0253': 'b',
    '\u24D2': 'c',
    '\uFF43': 'c',
    '\u0107': 'c',
    '\u0109': 'c',
    '\u010B': 'c',
    '\u010D': 'c',
    '\u00E7': 'c',
    '\u1E09': 'c',
    '\u0188': 'c',
    '\u023C': 'c',
    '\uA73F': 'c',
    '\u2184': 'c',
    '\u24D3': 'd',
    '\uFF44': 'd',
    '\u1E0B': 'd',
    '\u010F': 'd',
    '\u1E0D': 'd',
    '\u1E11': 'd',
    '\u1E13': 'd',
    '\u1E0F': 'd',
    '\u0111': 'd',
    '\u018C': 'd',
    '\u0256': 'd',
    '\u0257': 'd',
    '\uA77A': 'd',
    '\u01F3': 'dz',
    '\u01C6': 'dz',
    '\u24D4': 'e',
    '\uFF45': 'e',
    '\u00E8': 'e',
    '\u00E9': 'e',
    '\u00EA': 'e',
    '\u1EC1': 'e',
    '\u1EBF': 'e',
    '\u1EC5': 'e',
    '\u1EC3': 'e',
    '\u1EBD': 'e',
    '\u0113': 'e',
    '\u1E15': 'e',
    '\u1E17': 'e',
    '\u0115': 'e',
    '\u0117': 'e',
    '\u00EB': 'e',
    '\u1EBB': 'e',
    '\u011B': 'e',
    '\u0205': 'e',
    '\u0207': 'e',
    '\u1EB9': 'e',
    '\u1EC7': 'e',
    '\u0229': 'e',
    '\u1E1D': 'e',
    '\u0119': 'e',
    '\u1E19': 'e',
    '\u1E1B': 'e',
    '\u0247': 'e',
    '\u025B': 'e',
    '\u01DD': 'e',
    '\u24D5': 'f',
    '\uFF46': 'f',
    '\u1E1F': 'f',
    '\u0192': 'f',
    '\uA77C': 'f',
    '\u24D6': 'g',
    '\uFF47': 'g',
    '\u01F5': 'g',
    '\u011D': 'g',
    '\u1E21': 'g',
    '\u011F': 'g',
    '\u0121': 'g',
    '\u01E7': 'g',
    '\u0123': 'g',
    '\u01E5': 'g',
    '\u0260': 'g',
    '\uA7A1': 'g',
    '\u1D79': 'g',
    '\uA77F': 'g',
    '\u24D7': 'h',
    '\uFF48': 'h',
    '\u0125': 'h',
    '\u1E23': 'h',
    '\u1E27': 'h',
    '\u021F': 'h',
    '\u1E25': 'h',
    '\u1E29': 'h',
    '\u1E2B': 'h',
    '\u1E96': 'h',
    '\u0127': 'h',
    '\u2C68': 'h',
    '\u2C76': 'h',
    '\u0265': 'h',
    '\u0195': 'hv',
    '\u24D8': 'i',
    '\uFF49': 'i',
    '\u00EC': 'i',
    '\u00ED': 'i',
    '\u00EE': 'i',
    '\u0129': 'i',
    '\u012B': 'i',
    '\u012D': 'i',
    '\u00EF': 'i',
    '\u1E2F': 'i',
    '\u1EC9': 'i',
    '\u01D0': 'i',
    '\u0209': 'i',
    '\u020B': 'i',
    '\u1ECB': 'i',
    '\u012F': 'i',
    '\u1E2D': 'i',
    '\u0268': 'i',
    '\u0131': 'i',
    '\u24D9': 'j',
    '\uFF4A': 'j',
    '\u0135': 'j',
    '\u01F0': 'j',
    '\u0249': 'j',
    '\u24DA': 'k',
    '\uFF4B': 'k',
    '\u1E31': 'k',
    '\u01E9': 'k',
    '\u1E33': 'k',
    '\u0137': 'k',
    '\u1E35': 'k',
    '\u0199': 'k',
    '\u2C6A': 'k',
    '\uA741': 'k',
    '\uA743': 'k',
    '\uA745': 'k',
    '\uA7A3': 'k',
    '\u24DB': 'l',
    '\uFF4C': 'l',
    '\u0140': 'l',
    '\u013A': 'l',
    '\u013E': 'l',
    '\u1E37': 'l',
    '\u1E39': 'l',
    '\u013C': 'l',
    '\u1E3D': 'l',
    '\u1E3B': 'l',
    '\u017F': 'l',
    '\u0142': 'l',
    '\u019A': 'l',
    '\u026B': 'l',
    '\u2C61': 'l',
    '\uA749': 'l',
    '\uA781': 'l',
    '\uA747': 'l',
    '\u01C9': 'lj',
    '\u24DC': 'm',
    '\uFF4D': 'm',
    '\u1E3F': 'm',
    '\u1E41': 'm',
    '\u1E43': 'm',
    '\u0271': 'm',
    '\u026F': 'm',
    '\u24DD': 'n',
    '\uFF4E': 'n',
    '\u01F9': 'n',
    '\u0144': 'n',
    '\u00F1': 'n',
    '\u1E45': 'n',
    '\u0148': 'n',
    '\u1E47': 'n',
    '\u0146': 'n',
    '\u1E4B': 'n',
    '\u1E49': 'n',
    '\u019E': 'n',
    '\u0272': 'n',
    '\u0149': 'n',
    '\uA791': 'n',
    '\uA7A5': 'n',
    '\u01CC': 'nj',
    '\u24DE': 'o',
    '\uFF4F': 'o',
    '\u00F2': 'o',
    '\u00F3': 'o',
    '\u00F4': 'o',
    '\u1ED3': 'o',
    '\u1ED1': 'o',
    '\u1ED7': 'o',
    '\u1ED5': 'o',
    '\u00F5': 'o',
    '\u1E4D': 'o',
    '\u022D': 'o',
    '\u1E4F': 'o',
    '\u014D': 'o',
    '\u1E51': 'o',
    '\u1E53': 'o',
    '\u014F': 'o',
    '\u022F': 'o',
    '\u0231': 'o',
    '\u00F6': 'o',
    '\u022B': 'o',
    '\u1ECF': 'o',
    '\u0151': 'o',
    '\u01D2': 'o',
    '\u020D': 'o',
    '\u020F': 'o',
    '\u01A1': 'o',
    '\u1EDD': 'o',
    '\u1EDB': 'o',
    '\u1EE1': 'o',
    '\u1EDF': 'o',
    '\u1EE3': 'o',
    '\u1ECD': 'o',
    '\u1ED9': 'o',
    '\u01EB': 'o',
    '\u01ED': 'o',
    '\u00F8': 'o',
    '\u01FF': 'o',
    '\u0254': 'o',
    '\uA74B': 'o',
    '\uA74D': 'o',
    '\u0275': 'o',
    '\u0153': 'oe',
    '\u01A3': 'oi',
    '\u0223': 'ou',
    '\uA74F': 'oo',
    '\u24DF': 'p',
    '\uFF50': 'p',
    '\u1E55': 'p',
    '\u1E57': 'p',
    '\u01A5': 'p',
    '\u1D7D': 'p',
    '\uA751': 'p',
    '\uA753': 'p',
    '\uA755': 'p',
    '\u24E0': 'q',
    '\uFF51': 'q',
    '\u024B': 'q',
    '\uA757': 'q',
    '\uA759': 'q',
    '\u24E1': 'r',
    '\uFF52': 'r',
    '\u0155': 'r',
    '\u1E59': 'r',
    '\u0159': 'r',
    '\u0211': 'r',
    '\u0213': 'r',
    '\u1E5B': 'r',
    '\u1E5D': 'r',
    '\u0157': 'r',
    '\u1E5F': 'r',
    '\u024D': 'r',
    '\u027D': 'r',
    '\uA75B': 'r',
    '\uA7A7': 'r',
    '\uA783': 'r',
    '\u24E2': 's',
    '\uFF53': 's',
    '\u00DF': 's',
    '\u015B': 's',
    '\u1E65': 's',
    '\u015D': 's',
    '\u1E61': 's',
    '\u0161': 's',
    '\u1E67': 's',
    '\u1E63': 's',
    '\u1E69': 's',
    '\u0219': 's',
    '\u015F': 's',
    '\u023F': 's',
    '\uA7A9': 's',
    '\uA785': 's',
    '\u1E9B': 's',
    '\u24E3': 't',
    '\uFF54': 't',
    '\u1E6B': 't',
    '\u1E97': 't',
    '\u0165': 't',
    '\u1E6D': 't',
    '\u021B': 't',
    '\u0163': 't',
    '\u1E71': 't',
    '\u1E6F': 't',
    '\u0167': 't',
    '\u01AD': 't',
    '\u0288': 't',
    '\u2C66': 't',
    '\uA787': 't',
    '\uA729': 'tz',
    '\u24E4': 'u',
    '\uFF55': 'u',
    '\u00F9': 'u',
    '\u00FA': 'u',
    '\u00FB': 'u',
    '\u0169': 'u',
    '\u1E79': 'u',
    '\u016B': 'u',
    '\u1E7B': 'u',
    '\u016D': 'u',
    '\u00FC': 'u',
    '\u01DC': 'u',
    '\u01D8': 'u',
    '\u01D6': 'u',
    '\u01DA': 'u',
    '\u1EE7': 'u',
    '\u016F': 'u',
    '\u0171': 'u',
    '\u01D4': 'u',
    '\u0215': 'u',
    '\u0217': 'u',
    '\u01B0': 'u',
    '\u1EEB': 'u',
    '\u1EE9': 'u',
    '\u1EEF': 'u',
    '\u1EED': 'u',
    '\u1EF1': 'u',
    '\u1EE5': 'u',
    '\u1E73': 'u',
    '\u0173': 'u',
    '\u1E77': 'u',
    '\u1E75': 'u',
    '\u0289': 'u',
    '\u24E5': 'v',
    '\uFF56': 'v',
    '\u1E7D': 'v',
    '\u1E7F': 'v',
    '\u028B': 'v',
    '\uA75F': 'v',
    '\u028C': 'v',
    '\uA761': 'vy',
    '\u24E6': 'w',
    '\uFF57': 'w',
    '\u1E81': 'w',
    '\u1E83': 'w',
    '\u0175': 'w',
    '\u1E87': 'w',
    '\u1E85': 'w',
    '\u1E98': 'w',
    '\u1E89': 'w',
    '\u2C73': 'w',
    '\u24E7': 'x',
    '\uFF58': 'x',
    '\u1E8B': 'x',
    '\u1E8D': 'x',
    '\u24E8': 'y',
    '\uFF59': 'y',
    '\u1EF3': 'y',
    '\u00FD': 'y',
    '\u0177': 'y',
    '\u1EF9': 'y',
    '\u0233': 'y',
    '\u1E8F': 'y',
    '\u00FF': 'y',
    '\u1EF7': 'y',
    '\u1E99': 'y',
    '\u1EF5': 'y',
    '\u01B4': 'y',
    '\u024F': 'y',
    '\u1EFF': 'y',
    '\u24E9': 'z',
    '\uFF5A': 'z',
    '\u017A': 'z',
    '\u1E91': 'z',
    '\u017C': 'z',
    '\u017E': 'z',
    '\u1E93': 'z',
    '\u1E95': 'z',
    '\u01B6': 'z',
    '\u0225': 'z',
    '\u0240': 'z',
    '\u2C6C': 'z',
    '\uA763': 'z',
    '\u0386': '\u0391',
    '\u0388': '\u0395',
    '\u0389': '\u0397',
    '\u038A': '\u0399',
    '\u03AA': '\u0399',
    '\u038C': '\u039F',
    '\u038E': '\u03A5',
    '\u03AB': '\u03A5',
    '\u038F': '\u03A9',
    '\u03AC': '\u03B1',
    '\u03AD': '\u03B5',
    '\u03AE': '\u03B7',
    '\u03AF': '\u03B9',
    '\u03CA': '\u03B9',
    '\u0390': '\u03B9',
    '\u03CC': '\u03BF',
    '\u03CD': '\u03C5',
    '\u03CB': '\u03C5',
    '\u03B0': '\u03C5',
    '\u03CE': '\u03C9',
    '\u03C2': '\u03C3',
    '\u2019': '\''
  };

  return diacritics;
});

S2.define('select2/data/base',[
  '../utils'
], function (Utils) {
  function BaseAdapter ($element, options) {
    BaseAdapter.__super__.constructor.call(this);
  }

  Utils.Extend(BaseAdapter, Utils.Observable);

  BaseAdapter.prototype.current = function (callback) {
    throw new Error('The `current` method must be defined in child classes.');
  };

  BaseAdapter.prototype.query = function (params, callback) {
    throw new Error('The `query` method must be defined in child classes.');
  };

  BaseAdapter.prototype.bind = function (container, $container) {
    // Can be implemented in subclasses
  };

  BaseAdapter.prototype.destroy = function () {
    // Can be implemented in subclasses
  };

  BaseAdapter.prototype.generateResultId = function (container, data) {
    var id = container.id + '-result-';

    id += Utils.generateChars(4);

    if (data.id != null) {
      id += '-' + data.id.toString();
    } else {
      id += '-' + Utils.generateChars(4);
    }
    return id;
  };

  return BaseAdapter;
});

S2.define('select2/data/select',[
  './base',
  '../utils',
  'jquery'
], function (BaseAdapter, Utils, $) {
  function SelectAdapter ($element, options) {
    this.$element = $element;
    this.options = options;

    SelectAdapter.__super__.constructor.call(this);
  }

  Utils.Extend(SelectAdapter, BaseAdapter);

  SelectAdapter.prototype.current = function (callback) {
    var data = [];
    var self = this;

    this.$element.find(':selected').each(function () {
      var $option = $(this);

      var option = self.item($option);

      data.push(option);
    });

    callback(data);
  };

  SelectAdapter.prototype.select = function (data) {
    var self = this;

    data.selected = true;

    // If data.element is a DOM node, use it instead
    if ($(data.element).is('option')) {
      data.element.selected = true;

      this.$element.trigger('input').trigger('change');

      return;
    }

    if (this.$element.prop('multiple')) {
      this.current(function (currentData) {
        var val = [];

        data = [data];
        data.push.apply(data, currentData);

        for (var d = 0; d < data.length; d++) {
          var id = data[d].id;

          if ($.inArray(id, val) === -1) {
            val.push(id);
          }
        }

        self.$element.val(val);
        self.$element.trigger('input').trigger('change');
      });
    } else {
      var val = data.id;

      this.$element.val(val);
      this.$element.trigger('input').trigger('change');
    }
  };

  SelectAdapter.prototype.unselect = function (data) {
    var self = this;

    if (!this.$element.prop('multiple')) {
      return;
    }

    data.selected = false;

    if ($(data.element).is('option')) {
      data.element.selected = false;

      this.$element.trigger('input').trigger('change');

      return;
    }

    this.current(function (currentData) {
      var val = [];

      for (var d = 0; d < currentData.length; d++) {
        var id = currentData[d].id;

        if (id !== data.id && $.inArray(id, val) === -1) {
          val.push(id);
        }
      }

      self.$element.val(val);

      self.$element.trigger('input').trigger('change');
    });
  };

  SelectAdapter.prototype.bind = function (container, $container) {
    var self = this;

    this.container = container;

    container.on('select', function (params) {
      self.select(params.data);
    });

    container.on('unselect', function (params) {
      self.unselect(params.data);
    });
  };

  SelectAdapter.prototype.destroy = function () {
    // Remove anything added to child elements
    this.$element.find('*').each(function () {
      // Remove any custom data set by Select2
      Utils.RemoveData(this);
    });
  };

  SelectAdapter.prototype.query = function (params, callback) {
    var data = [];
    var self = this;

    var $options = this.$element.children();

    $options.each(function () {
      var $option = $(this);

      if (!$option.is('option') && !$option.is('optgroup')) {
        return;
      }

      var option = self.item($option);

      var matches = self.matches(params, option);

      if (matches !== null) {
        data.push(matches);
      }
    });

    callback({
      results: data
    });
  };

  SelectAdapter.prototype.addOptions = function ($options) {
    Utils.appendMany(this.$element, $options);
  };

  SelectAdapter.prototype.option = function (data) {
    var option;

    if (data.children) {
      option = document.createElement('optgroup');
      option.label = data.text;
    } else {
      option = document.createElement('option');

      if (option.textContent !== undefined) {
        option.textContent = data.text;
      } else {
        option.innerText = data.text;
      }
    }

    if (data.id !== undefined) {
      option.value = data.id;
    }

    if (data.disabled) {
      option.disabled = true;
    }

    if (data.selected) {
      option.selected = true;
    }

    if (data.title) {
      option.title = data.title;
    }

    var $option = $(option);

    var normalizedData = this._normalizeItem(data);
    normalizedData.element = option;

    // Override the option's data with the combined data
    Utils.StoreData(option, 'data', normalizedData);

    return $option;
  };

  SelectAdapter.prototype.item = function ($option) {
    var data = {};

    data = Utils.GetData($option[0], 'data');

    if (data != null) {
      return data;
    }

    if ($option.is('option')) {
      data = {
        id: $option.val(),
        text: $option.text(),
        disabled: $option.prop('disabled'),
        selected: $option.prop('selected'),
        title: $option.prop('title')
      };
    } else if ($option.is('optgroup')) {
      data = {
        text: $option.prop('label'),
        children: [],
        title: $option.prop('title')
      };

      var $children = $option.children('option');
      var children = [];

      for (var c = 0; c < $children.length; c++) {
        var $child = $($children[c]);

        var child = this.item($child);

        children.push(child);
      }

      data.children = children;
    }

    data = this._normalizeItem(data);
    data.element = $option[0];

    Utils.StoreData($option[0], 'data', data);

    return data;
  };

  SelectAdapter.prototype._normalizeItem = function (item) {
    if (item !== Object(item)) {
      item = {
        id: item,
        text: item
      };
    }

    item = $.extend({}, {
      text: ''
    }, item);

    var defaults = {
      selected: false,
      disabled: false
    };

    if (item.id != null) {
      item.id = item.id.toString();
    }

    if (item.text != null) {
      item.text = item.text.toString();
    }

    if (item._resultId == null && item.id && this.container != null) {
      item._resultId = this.generateResultId(this.container, item);
    }

    return $.extend({}, defaults, item);
  };

  SelectAdapter.prototype.matches = function (params, data) {
    var matcher = this.options.get('matcher');

    return matcher(params, data);
  };

  return SelectAdapter;
});

S2.define('select2/data/array',[
  './select',
  '../utils',
  'jquery'
], function (SelectAdapter, Utils, $) {
  function ArrayAdapter ($element, options) {
    this._dataToConvert = options.get('data') || [];

    ArrayAdapter.__super__.constructor.call(this, $element, options);
  }

  Utils.Extend(ArrayAdapter, SelectAdapter);

  ArrayAdapter.prototype.bind = function (container, $container) {
    ArrayAdapter.__super__.bind.call(this, container, $container);

    this.addOptions(this.convertToOptions(this._dataToConvert));
  };

  ArrayAdapter.prototype.select = function (data) {
    var $option = this.$element.find('option').filter(function (i, elm) {
      return elm.value == data.id.toString();
    });

    if ($option.length === 0) {
      $option = this.option(data);

      this.addOptions($option);
    }

    ArrayAdapter.__super__.select.call(this, data);
  };

  ArrayAdapter.prototype.convertToOptions = function (data) {
    var self = this;

    var $existing = this.$element.find('option');
    var existingIds = $existing.map(function () {
      return self.item($(this)).id;
    }).get();

    var $options = [];

    // Filter out all items except for the one passed in the argument
    function onlyItem (item) {
      return function () {
        return $(this).val() == item.id;
      };
    }

    for (var d = 0; d < data.length; d++) {
      var item = this._normalizeItem(data[d]);

      // Skip items which were pre-loaded, only merge the data
      if ($.inArray(item.id, existingIds) >= 0) {
        var $existingOption = $existing.filter(onlyItem(item));

        var existingData = this.item($existingOption);
        var newData = $.extend(true, {}, item, existingData);

        var $newOption = this.option(newData);

        $existingOption.replaceWith($newOption);

        continue;
      }

      var $option = this.option(item);

      if (item.children) {
        var $children = this.convertToOptions(item.children);

        Utils.appendMany($option, $children);
      }

      $options.push($option);
    }

    return $options;
  };

  return ArrayAdapter;
});

S2.define('select2/data/ajax',[
  './array',
  '../utils',
  'jquery'
], function (ArrayAdapter, Utils, $) {
  function AjaxAdapter ($element, options) {
    this.ajaxOptions = this._applyDefaults(options.get('ajax'));

    if (this.ajaxOptions.processResults != null) {
      this.processResults = this.ajaxOptions.processResults;
    }

    AjaxAdapter.__super__.constructor.call(this, $element, options);
  }

  Utils.Extend(AjaxAdapter, ArrayAdapter);

  AjaxAdapter.prototype._applyDefaults = function (options) {
    var defaults = {
      data: function (params) {
        return $.extend({}, params, {
          q: params.term
        });
      },
      transport: function (params, success, failure) {
        var $request = $.ajax(params);

        $request.then(success);
        $request.fail(failure);

        return $request;
      }
    };

    return $.extend({}, defaults, options, true);
  };

  AjaxAdapter.prototype.processResults = function (results) {
    return results;
  };

  AjaxAdapter.prototype.query = function (params, callback) {
    var matches = [];
    var self = this;

    if (this._request != null) {
      // JSONP requests cannot always be aborted
      if ($.isFunction(this._request.abort)) {
        this._request.abort();
      }

      this._request = null;
    }

    var options = $.extend({
      type: 'GET'
    }, this.ajaxOptions);

    if (typeof options.url === 'function') {
      options.url = options.url.call(this.$element, params);
    }

    if (typeof options.data === 'function') {
      options.data = options.data.call(this.$element, params);
    }

    function request () {
      var $request = options.transport(options, function (data) {
        var results = self.processResults(data, params);

        if (self.options.get('debug') && window.console && console.error) {
          // Check to make sure that the response included a `results` key.
          if (!results || !results.results || !$.isArray(results.results)) {
            console.error(
              'Select2: The AJAX results did not return an array in the ' +
              '`results` key of the response.'
            );
          }
        }

        callback(results);
      }, function () {
        // Attempt to detect if a request was aborted
        // Only works if the transport exposes a status property
        if ('status' in $request &&
            ($request.status === 0 || $request.status === '0')) {
          return;
        }

        self.trigger('results:message', {
          message: 'errorLoading'
        });
      });

      self._request = $request;
    }

    if (this.ajaxOptions.delay && params.term != null) {
      if (this._queryTimeout) {
        window.clearTimeout(this._queryTimeout);
      }

      this._queryTimeout = window.setTimeout(request, this.ajaxOptions.delay);
    } else {
      request();
    }
  };

  return AjaxAdapter;
});

S2.define('select2/data/tags',[
  'jquery'
], function ($) {
  function Tags (decorated, $element, options) {
    var tags = options.get('tags');

    var createTag = options.get('createTag');

    if (createTag !== undefined) {
      this.createTag = createTag;
    }

    var insertTag = options.get('insertTag');

    if (insertTag !== undefined) {
        this.insertTag = insertTag;
    }

    decorated.call(this, $element, options);

    if ($.isArray(tags)) {
      for (var t = 0; t < tags.length; t++) {
        var tag = tags[t];
        var item = this._normalizeItem(tag);

        var $option = this.option(item);

        this.$element.append($option);
      }
    }
  }

  Tags.prototype.query = function (decorated, params, callback) {
    var self = this;

    this._removeOldTags();

    if (params.term == null || params.page != null) {
      decorated.call(this, params, callback);
      return;
    }

    function wrapper (obj, child) {
      var data = obj.results;

      for (var i = 0; i < data.length; i++) {
        var option = data[i];

        var checkChildren = (
          option.children != null &&
          !wrapper({
            results: option.children
          }, true)
        );

        var optionText = (option.text || '').toUpperCase();
        var paramsTerm = (params.term || '').toUpperCase();

        var checkText = optionText === paramsTerm;

        if (checkText || checkChildren) {
          if (child) {
            return false;
          }

          obj.data = data;
          callback(obj);

          return;
        }
      }

      if (child) {
        return true;
      }

      var tag = self.createTag(params);

      if (tag != null) {
        var $option = self.option(tag);
        $option.attr('data-select2-tag', true);

        self.addOptions([$option]);

        self.insertTag(data, tag);
      }

      obj.results = data;

      callback(obj);
    }

    decorated.call(this, params, wrapper);
  };

  Tags.prototype.createTag = function (decorated, params) {
    var term = $.trim(params.term);

    if (term === '') {
      return null;
    }

    return {
      id: term,
      text: term
    };
  };

  Tags.prototype.insertTag = function (_, data, tag) {
    data.unshift(tag);
  };

  Tags.prototype._removeOldTags = function (_) {
    var $options = this.$element.find('option[data-select2-tag]');

    $options.each(function () {
      if (this.selected) {
        return;
      }

      $(this).remove();
    });
  };

  return Tags;
});

S2.define('select2/data/tokenizer',[
  'jquery'
], function ($) {
  function Tokenizer (decorated, $element, options) {
    var tokenizer = options.get('tokenizer');

    if (tokenizer !== undefined) {
      this.tokenizer = tokenizer;
    }

    decorated.call(this, $element, options);
  }

  Tokenizer.prototype.bind = function (decorated, container, $container) {
    decorated.call(this, container, $container);

    this.$search =  container.dropdown.$search || container.selection.$search ||
      $container.find('.select2-search__field');
  };

  Tokenizer.prototype.query = function (decorated, params, callback) {
    var self = this;

    function createAndSelect (data) {
      // Normalize the data object so we can use it for checks
      var item = self._normalizeItem(data);

      // Check if the data object already exists as a tag
      // Select it if it doesn't
      var $existingOptions = self.$element.find('option').filter(function () {
        return $(this).val() === item.id;
      });

      // If an existing option wasn't found for it, create the option
      if (!$existingOptions.length) {
        var $option = self.option(item);
        $option.attr('data-select2-tag', true);

        self._removeOldTags();
        self.addOptions([$option]);
      }

      // Select the item, now that we know there is an option for it
      select(item);
    }

    function select (data) {
      self.trigger('select', {
        data: data
      });
    }

    params.term = params.term || '';

    var tokenData = this.tokenizer(params, this.options, createAndSelect);

    if (tokenData.term !== params.term) {
      // Replace the search term if we have the search box
      if (this.$search.length) {
        this.$search.val(tokenData.term);
        this.$search.trigger('focus');
      }

      params.term = tokenData.term;
    }

    decorated.call(this, params, callback);
  };

  Tokenizer.prototype.tokenizer = function (_, params, options, callback) {
    var separators = options.get('tokenSeparators') || [];
    var term = params.term;
    var i = 0;

    var createTag = this.createTag || function (params) {
      return {
        id: params.term,
        text: params.term
      };
    };

    while (i < term.length) {
      var termChar = term[i];

      if ($.inArray(termChar, separators) === -1) {
        i++;

        continue;
      }

      var part = term.substr(0, i);
      var partParams = $.extend({}, params, {
        term: part
      });

      var data = createTag(partParams);

      if (data == null) {
        i++;
        continue;
      }

      callback(data);

      // Reset the term to not include the tokenized portion
      term = term.substr(i + 1) || '';
      i = 0;
    }

    return {
      term: term
    };
  };

  return Tokenizer;
});

S2.define('select2/data/minimumInputLength',[

], function () {
  function MinimumInputLength (decorated, $e, options) {
    this.minimumInputLength = options.get('minimumInputLength');

    decorated.call(this, $e, options);
  }

  MinimumInputLength.prototype.query = function (decorated, params, callback) {
    params.term = params.term || '';

    if (params.term.length < this.minimumInputLength) {
      this.trigger('results:message', {
        message: 'inputTooShort',
        args: {
          minimum: this.minimumInputLength,
          input: params.term,
          params: params
        }
      });

      return;
    }

    decorated.call(this, params, callback);
  };

  return MinimumInputLength;
});

S2.define('select2/data/maximumInputLength',[

], function () {
  function MaximumInputLength (decorated, $e, options) {
    this.maximumInputLength = options.get('maximumInputLength');

    decorated.call(this, $e, options);
  }

  MaximumInputLength.prototype.query = function (decorated, params, callback) {
    params.term = params.term || '';

    if (this.maximumInputLength > 0 &&
        params.term.length > this.maximumInputLength) {
      this.trigger('results:message', {
        message: 'inputTooLong',
        args: {
          maximum: this.maximumInputLength,
          input: params.term,
          params: params
        }
      });

      return;
    }

    decorated.call(this, params, callback);
  };

  return MaximumInputLength;
});

S2.define('select2/data/maximumSelectionLength',[

], function (){
  function MaximumSelectionLength (decorated, $e, options) {
    this.maximumSelectionLength = options.get('maximumSelectionLength');

    decorated.call(this, $e, options);
  }

  MaximumSelectionLength.prototype.bind =
    function (decorated, container, $container) {
      var self = this;

      decorated.call(this, container, $container);

      container.on('select', function () {
        self._checkIfMaximumSelected();
      });
  };

  MaximumSelectionLength.prototype.query =
    function (decorated, params, callback) {
      var self = this;

      this._checkIfMaximumSelected(function () {
        decorated.call(self, params, callback);
      });
  };

  MaximumSelectionLength.prototype._checkIfMaximumSelected =
    function (_, successCallback) {
      var self = this;

      this.current(function (currentData) {
        var count = currentData != null ? currentData.length : 0;
        if (self.maximumSelectionLength > 0 &&
          count >= self.maximumSelectionLength) {
          self.trigger('results:message', {
            message: 'maximumSelected',
            args: {
              maximum: self.maximumSelectionLength
            }
          });
          return;
        }

        if (successCallback) {
          successCallback();
        }
      });
  };

  return MaximumSelectionLength;
});

S2.define('select2/dropdown',[
  'jquery',
  './utils'
], function ($, Utils) {
  function Dropdown ($element, options) {
    this.$element = $element;
    this.options = options;

    Dropdown.__super__.constructor.call(this);
  }

  Utils.Extend(Dropdown, Utils.Observable);

  Dropdown.prototype.render = function () {
    var $dropdown = $(
      '<span class="select2-dropdown">' +
        '<span class="select2-results"></span>' +
      '</span>'
    );

    $dropdown.attr('dir', this.options.get('dir'));

    this.$dropdown = $dropdown;

    return $dropdown;
  };

  Dropdown.prototype.bind = function () {
    // Should be implemented in subclasses
  };

  Dropdown.prototype.position = function ($dropdown, $container) {
    // Should be implemented in subclasses
  };

  Dropdown.prototype.destroy = function () {
    // Remove the dropdown from the DOM
    this.$dropdown.remove();
  };

  return Dropdown;
});

S2.define('select2/dropdown/search',[
  'jquery',
  '../utils'
], function ($, Utils) {
  function Search () { }

  Search.prototype.render = function (decorated) {
    var $rendered = decorated.call(this);

    var $search = $(
      '<span class="select2-search select2-search--dropdown">' +
        '<input class="select2-search__field" type="search" tabindex="-1"' +
        ' autocomplete="off" autocorrect="off" autocapitalize="none"' +
        ' spellcheck="false" role="searchbox" aria-autocomplete="list" />' +
      '</span>'
    );

    this.$searchContainer = $search;
    this.$search = $search.find('input');

    $rendered.prepend($search);

    return $rendered;
  };

  Search.prototype.bind = function (decorated, container, $container) {
    var self = this;

    var resultsId = container.id + '-results';

    decorated.call(this, container, $container);

    this.$search.on('keydown', function (evt) {
      self.trigger('keypress', evt);

      self._keyUpPrevented = evt.isDefaultPrevented();
    });

    // Workaround for browsers which do not support the `input` event
    // This will prevent double-triggering of events for browsers which support
    // both the `keyup` and `input` events.
    this.$search.on('input', function (evt) {
      // Unbind the duplicated `keyup` event
      $(this).off('keyup');
    });

    this.$search.on('keyup input', function (evt) {
      self.handleSearch(evt);
    });

    container.on('open', function () {
      self.$search.attr('tabindex', 0);
      self.$search.attr('aria-controls', resultsId);

      self.$search.trigger('focus');

      window.setTimeout(function () {
        self.$search.trigger('focus');
      }, 0);
    });

    container.on('close', function () {
      self.$search.attr('tabindex', -1);
      self.$search.removeAttr('aria-controls');
      self.$search.removeAttr('aria-activedescendant');

      self.$search.val('');
      self.$search.trigger('blur');
    });

    container.on('focus', function () {
      if (!container.isOpen()) {
        self.$search.trigger('focus');
      }
    });

    container.on('results:all', function (params) {
      if (params.query.term == null || params.query.term === '') {
        var showSearch = self.showSearch(params);

        if (showSearch) {
          self.$searchContainer.removeClass('select2-search--hide');
        } else {
          self.$searchContainer.addClass('select2-search--hide');
        }
      }
    });

    container.on('results:focus', function (params) {
      if (params.data._resultId) {
        self.$search.attr('aria-activedescendant', params.data._resultId);
      } else {
        self.$search.removeAttr('aria-activedescendant');
      }
    });
  };

  Search.prototype.handleSearch = function (evt) {
    if (!this._keyUpPrevented) {
      var input = this.$search.val();

      this.trigger('query', {
        term: input
      });
    }

    this._keyUpPrevented = false;
  };

  Search.prototype.showSearch = function (_, params) {
    return true;
  };

  return Search;
});

S2.define('select2/dropdown/hidePlaceholder',[

], function () {
  function HidePlaceholder (decorated, $element, options, dataAdapter) {
    this.placeholder = this.normalizePlaceholder(options.get('placeholder'));

    decorated.call(this, $element, options, dataAdapter);
  }

  HidePlaceholder.prototype.append = function (decorated, data) {
    data.results = this.removePlaceholder(data.results);

    decorated.call(this, data);
  };

  HidePlaceholder.prototype.normalizePlaceholder = function (_, placeholder) {
    if (typeof placeholder === 'string') {
      placeholder = {
        id: '',
        text: placeholder
      };
    }

    return placeholder;
  };

  HidePlaceholder.prototype.removePlaceholder = function (_, data) {
    var modifiedData = data.slice(0);

    for (var d = data.length - 1; d >= 0; d--) {
      var item = data[d];

      if (this.placeholder.id === item.id) {
        modifiedData.splice(d, 1);
      }
    }

    return modifiedData;
  };

  return HidePlaceholder;
});

S2.define('select2/dropdown/infiniteScroll',[
  'jquery'
], function ($) {
  function InfiniteScroll (decorated, $element, options, dataAdapter) {
    this.lastParams = {};

    decorated.call(this, $element, options, dataAdapter);

    this.$loadingMore = this.createLoadingMore();
    this.loading = false;
  }

  InfiniteScroll.prototype.append = function (decorated, data) {
    this.$loadingMore.remove();
    this.loading = false;

    decorated.call(this, data);

    if (this.showLoadingMore(data)) {
      this.$results.append(this.$loadingMore);
      this.loadMoreIfNeeded();
    }
  };

  InfiniteScroll.prototype.bind = function (decorated, container, $container) {
    var self = this;

    decorated.call(this, container, $container);

    container.on('query', function (params) {
      self.lastParams = params;
      self.loading = true;
    });

    container.on('query:append', function (params) {
      self.lastParams = params;
      self.loading = true;
    });

    this.$results.on('scroll', this.loadMoreIfNeeded.bind(this));
  };

  InfiniteScroll.prototype.loadMoreIfNeeded = function () {
    var isLoadMoreVisible = $.contains(
      document.documentElement,
      this.$loadingMore[0]
    );

    if (this.loading || !isLoadMoreVisible) {
      return;
    }

    var currentOffset = this.$results.offset().top +
      this.$results.outerHeight(false);
    var loadingMoreOffset = this.$loadingMore.offset().top +
      this.$loadingMore.outerHeight(false);

    if (currentOffset + 50 >= loadingMoreOffset) {
      this.loadMore();
    }
  };

  InfiniteScroll.prototype.loadMore = function () {
    this.loading = true;

    var params = $.extend({}, {page: 1}, this.lastParams);

    params.page++;

    this.trigger('query:append', params);
  };

  InfiniteScroll.prototype.showLoadingMore = function (_, data) {
    return data.pagination && data.pagination.more;
  };

  InfiniteScroll.prototype.createLoadingMore = function () {
    var $option = $(
      '<li ' +
      'class="select2-results__option select2-results__option--load-more"' +
      'role="option" aria-disabled="true"></li>'
    );

    var message = this.options.get('translations').get('loadingMore');

    $option.html(message(this.lastParams));

    return $option;
  };

  return InfiniteScroll;
});

S2.define('select2/dropdown/attachBody',[
  'jquery',
  '../utils'
], function ($, Utils) {
  function AttachBody (decorated, $element, options) {
    this.$dropdownParent = $(options.get('dropdownParent') || document.body);

    decorated.call(this, $element, options);
  }

  AttachBody.prototype.bind = function (decorated, container, $container) {
    var self = this;

    decorated.call(this, container, $container);

    container.on('open', function () {
      self._showDropdown();
      self._attachPositioningHandler(container);

      // Must bind after the results handlers to ensure correct sizing
      self._bindContainerResultHandlers(container);
    });

    container.on('close', function () {
      self._hideDropdown();
      self._detachPositioningHandler(container);
    });

    this.$dropdownContainer.on('mousedown', function (evt) {
      evt.stopPropagation();
    });
  };

  AttachBody.prototype.destroy = function (decorated) {
    decorated.call(this);

    this.$dropdownContainer.remove();
  };

  AttachBody.prototype.position = function (decorated, $dropdown, $container) {
    // Clone all of the container classes
    $dropdown.attr('class', $container.attr('class'));

    $dropdown.removeClass('select2');
    $dropdown.addClass('select2-container--open');

    $dropdown.css({
      position: 'absolute',
      top: -999999
    });

    this.$container = $container;
  };

  AttachBody.prototype.render = function (decorated) {
    var $container = $('<span></span>');

    var $dropdown = decorated.call(this);
    $container.append($dropdown);

    this.$dropdownContainer = $container;

    return $container;
  };

  AttachBody.prototype._hideDropdown = function (decorated) {
    this.$dropdownContainer.detach();
  };

  AttachBody.prototype._bindContainerResultHandlers =
      function (decorated, container) {

    // These should only be bound once
    if (this._containerResultsHandlersBound) {
      return;
    }

    var self = this;

    container.on('results:all', function () {
      self._positionDropdown();
      self._resizeDropdown();
    });

    container.on('results:append', function () {
      self._positionDropdown();
      self._resizeDropdown();
    });

    container.on('results:message', function () {
      self._positionDropdown();
      self._resizeDropdown();
    });

    container.on('select', function () {
      self._positionDropdown();
      self._resizeDropdown();
    });

    container.on('unselect', function () {
      self._positionDropdown();
      self._resizeDropdown();
    });

    this._containerResultsHandlersBound = true;
  };

  AttachBody.prototype._attachPositioningHandler =
      function (decorated, container) {
    var self = this;

    var scrollEvent = 'scroll.select2.' + container.id;
    var resizeEvent = 'resize.select2.' + container.id;
    var orientationEvent = 'orientationchange.select2.' + container.id;

    var $watchers = this.$container.parents().filter(Utils.hasScroll);
    $watchers.each(function () {
      Utils.StoreData(this, 'select2-scroll-position', {
        x: $(this).scrollLeft(),
        y: $(this).scrollTop()
      });
    });

    $watchers.on(scrollEvent, function (ev) {
      var position = Utils.GetData(this, 'select2-scroll-position');
      $(this).scrollTop(position.y);
    });

    $(window).on(scrollEvent + ' ' + resizeEvent + ' ' + orientationEvent,
      function (e) {
      self._positionDropdown();
      self._resizeDropdown();
    });
  };

  AttachBody.prototype._detachPositioningHandler =
      function (decorated, container) {
    var scrollEvent = 'scroll.select2.' + container.id;
    var resizeEvent = 'resize.select2.' + container.id;
    var orientationEvent = 'orientationchange.select2.' + container.id;

    var $watchers = this.$container.parents().filter(Utils.hasScroll);
    $watchers.off(scrollEvent);

    $(window).off(scrollEvent + ' ' + resizeEvent + ' ' + orientationEvent);
  };

  AttachBody.prototype._positionDropdown = function () {
    var $window = $(window);

    var isCurrentlyAbove = this.$dropdown.hasClass('select2-dropdown--above');
    var isCurrentlyBelow = this.$dropdown.hasClass('select2-dropdown--below');

    var newDirection = null;

    var offset = this.$container.offset();

    offset.bottom = offset.top + this.$container.outerHeight(false);

    var container = {
      height: this.$container.outerHeight(false)
    };

    container.top = offset.top;
    container.bottom = offset.top + container.height;

    var dropdown = {
      height: this.$dropdown.outerHeight(false)
    };

    var viewport = {
      top: $window.scrollTop(),
      bottom: $window.scrollTop() + $window.height()
    };

    var enoughRoomAbove = viewport.top < (offset.top - dropdown.height);
    var enoughRoomBelow = viewport.bottom > (offset.bottom + dropdown.height);

    var css = {
      left: offset.left,
      top: container.bottom
    };

    // Determine what the parent element is to use for calculating the offset
    var $offsetParent = this.$dropdownParent;

    // For statically positioned elements, we need to get the element
    // that is determining the offset
    if ($offsetParent.css('position') === 'static') {
      $offsetParent = $offsetParent.offsetParent();
    }

    var parentOffset = {
      top: 0,
      left: 0
    };

    if (
      $.contains(document.body, $offsetParent[0]) ||
      $offsetParent[0].isConnected
      ) {
      parentOffset = $offsetParent.offset();
    }

    css.top -= parentOffset.top;
    css.left -= parentOffset.left;

    if (!isCurrentlyAbove && !isCurrentlyBelow) {
      newDirection = 'below';
    }

    if (!enoughRoomBelow && enoughRoomAbove && !isCurrentlyAbove) {
      newDirection = 'above';
    } else if (!enoughRoomAbove && enoughRoomBelow && isCurrentlyAbove) {
      newDirection = 'below';
    }

    if (newDirection == 'above' ||
      (isCurrentlyAbove && newDirection !== 'below')) {
      css.top = container.top - parentOffset.top - dropdown.height;
    }

    if (newDirection != null) {
      this.$dropdown
        .removeClass('select2-dropdown--below select2-dropdown--above')
        .addClass('select2-dropdown--' + newDirection);
      this.$container
        .removeClass('select2-container--below select2-container--above')
        .addClass('select2-container--' + newDirection);
    }

    this.$dropdownContainer.css(css);
  };

  AttachBody.prototype._resizeDropdown = function () {
    var css = {
      width: this.$container.outerWidth(false) + 'px'
    };

    if (this.options.get('dropdownAutoWidth')) {
      css.minWidth = css.width;
      css.position = 'relative';
      css.width = 'auto';
    }

    this.$dropdown.css(css);
  };

  AttachBody.prototype._showDropdown = function (decorated) {
    this.$dropdownContainer.appendTo(this.$dropdownParent);

    this._positionDropdown();
    this._resizeDropdown();
  };

  return AttachBody;
});

S2.define('select2/dropdown/minimumResultsForSearch',[

], function () {
  function countResults (data) {
    var count = 0;

    for (var d = 0; d < data.length; d++) {
      var item = data[d];

      if (item.children) {
        count += countResults(item.children);
      } else {
        count++;
      }
    }

    return count;
  }

  function MinimumResultsForSearch (decorated, $element, options, dataAdapter) {
    this.minimumResultsForSearch = options.get('minimumResultsForSearch');

    if (this.minimumResultsForSearch < 0) {
      this.minimumResultsForSearch = Infinity;
    }

    decorated.call(this, $element, options, dataAdapter);
  }

  MinimumResultsForSearch.prototype.showSearch = function (decorated, params) {
    if (countResults(params.data.results) < this.minimumResultsForSearch) {
      return false;
    }

    return decorated.call(this, params);
  };

  return MinimumResultsForSearch;
});

S2.define('select2/dropdown/selectOnClose',[
  '../utils'
], function (Utils) {
  function SelectOnClose () { }

  SelectOnClose.prototype.bind = function (decorated, container, $container) {
    var self = this;

    decorated.call(this, container, $container);

    container.on('close', function (params) {
      self._handleSelectOnClose(params);
    });
  };

  SelectOnClose.prototype._handleSelectOnClose = function (_, params) {
    if (params && params.originalSelect2Event != null) {
      var event = params.originalSelect2Event;

      // Don't select an item if the close event was triggered from a select or
      // unselect event
      if (event._type === 'select' || event._type === 'unselect') {
        return;
      }
    }

    var $highlightedResults = this.getHighlightedResults();

    // Only select highlighted results
    if ($highlightedResults.length < 1) {
      return;
    }

    var data = Utils.GetData($highlightedResults[0], 'data');

    // Don't re-select already selected resulte
    if (
      (data.element != null && data.element.selected) ||
      (data.element == null && data.selected)
    ) {
      return;
    }

    this.trigger('select', {
        data: data
    });
  };

  return SelectOnClose;
});

S2.define('select2/dropdown/closeOnSelect',[

], function () {
  function CloseOnSelect () { }

  CloseOnSelect.prototype.bind = function (decorated, container, $container) {
    var self = this;

    decorated.call(this, container, $container);

    container.on('select', function (evt) {
      self._selectTriggered(evt);
    });

    container.on('unselect', function (evt) {
      self._selectTriggered(evt);
    });
  };

  CloseOnSelect.prototype._selectTriggered = function (_, evt) {
    var originalEvent = evt.originalEvent;

    // Don't close if the control key is being held
    if (originalEvent && (originalEvent.ctrlKey || originalEvent.metaKey)) {
      return;
    }

    this.trigger('close', {
      originalEvent: originalEvent,
      originalSelect2Event: evt
    });
  };

  return CloseOnSelect;
});

S2.define('select2/i18n/en',[],function () {
  // English
  return {
    errorLoading: function () {
      return 'The results could not be loaded.';
    },
    inputTooLong: function (args) {
      var overChars = args.input.length - args.maximum;

      var message = 'Please delete ' + overChars + ' character';

      if (overChars != 1) {
        message += 's';
      }

      return message;
    },
    inputTooShort: function (args) {
      var remainingChars = args.minimum - args.input.length;

      var message = 'Please enter ' + remainingChars + ' or more characters';

      return message;
    },
    loadingMore: function () {
      return 'Loading more results…';
    },
    maximumSelected: function (args) {
      var message = 'You can only select ' + args.maximum + ' item';

      if (args.maximum != 1) {
        message += 's';
      }

      return message;
    },
    noResults: function () {
      return 'No results found';
    },
    searching: function () {
      return 'Searching…';
    },
    removeAllItems: function () {
      return 'Remove all items';
    }
  };
});

S2.define('select2/defaults',[
  'jquery',
  'require',

  './results',

  './selection/single',
  './selection/multiple',
  './selection/placeholder',
  './selection/allowClear',
  './selection/search',
  './selection/eventRelay',

  './utils',
  './translation',
  './diacritics',

  './data/select',
  './data/array',
  './data/ajax',
  './data/tags',
  './data/tokenizer',
  './data/minimumInputLength',
  './data/maximumInputLength',
  './data/maximumSelectionLength',

  './dropdown',
  './dropdown/search',
  './dropdown/hidePlaceholder',
  './dropdown/infiniteScroll',
  './dropdown/attachBody',
  './dropdown/minimumResultsForSearch',
  './dropdown/selectOnClose',
  './dropdown/closeOnSelect',

  './i18n/en'
], function ($, require,

             ResultsList,

             SingleSelection, MultipleSelection, Placeholder, AllowClear,
             SelectionSearch, EventRelay,

             Utils, Translation, DIACRITICS,

             SelectData, ArrayData, AjaxData, Tags, Tokenizer,
             MinimumInputLength, MaximumInputLength, MaximumSelectionLength,

             Dropdown, DropdownSearch, HidePlaceholder, InfiniteScroll,
             AttachBody, MinimumResultsForSearch, SelectOnClose, CloseOnSelect,

             EnglishTranslation) {
  function Defaults () {
    this.reset();
  }

  Defaults.prototype.apply = function (options) {
    options = $.extend(true, {}, this.defaults, options);

    if (options.dataAdapter == null) {
      if (options.ajax != null) {
        options.dataAdapter = AjaxData;
      } else if (options.data != null) {
        options.dataAdapter = ArrayData;
      } else {
        options.dataAdapter = SelectData;
      }

      if (options.minimumInputLength > 0) {
        options.dataAdapter = Utils.Decorate(
          options.dataAdapter,
          MinimumInputLength
        );
      }

      if (options.maximumInputLength > 0) {
        options.dataAdapter = Utils.Decorate(
          options.dataAdapter,
          MaximumInputLength
        );
      }

      if (options.maximumSelectionLength > 0) {
        options.dataAdapter = Utils.Decorate(
          options.dataAdapter,
          MaximumSelectionLength
        );
      }

      if (options.tags) {
        options.dataAdapter = Utils.Decorate(options.dataAdapter, Tags);
      }

      if (options.tokenSeparators != null || options.tokenizer != null) {
        options.dataAdapter = Utils.Decorate(
          options.dataAdapter,
          Tokenizer
        );
      }

      if (options.query != null) {
        var Query = require(options.amdBase + 'compat/query');

        options.dataAdapter = Utils.Decorate(
          options.dataAdapter,
          Query
        );
      }

      if (options.initSelection != null) {
        var InitSelection = require(options.amdBase + 'compat/initSelection');

        options.dataAdapter = Utils.Decorate(
          options.dataAdapter,
          InitSelection
        );
      }
    }

    if (options.resultsAdapter == null) {
      options.resultsAdapter = ResultsList;

      if (options.ajax != null) {
        options.resultsAdapter = Utils.Decorate(
          options.resultsAdapter,
          InfiniteScroll
        );
      }

      if (options.placeholder != null) {
        options.resultsAdapter = Utils.Decorate(
          options.resultsAdapter,
          HidePlaceholder
        );
      }

      if (options.selectOnClose) {
        options.resultsAdapter = Utils.Decorate(
          options.resultsAdapter,
          SelectOnClose
        );
      }
    }

    if (options.dropdownAdapter == null) {
      if (options.multiple) {
        options.dropdownAdapter = Dropdown;
      } else {
        var SearchableDropdown = Utils.Decorate(Dropdown, DropdownSearch);

        options.dropdownAdapter = SearchableDropdown;
      }

      if (options.minimumResultsForSearch !== 0) {
        options.dropdownAdapter = Utils.Decorate(
          options.dropdownAdapter,
          MinimumResultsForSearch
        );
      }

      if (options.closeOnSelect) {
        options.dropdownAdapter = Utils.Decorate(
          options.dropdownAdapter,
          CloseOnSelect
        );
      }

      if (
        options.dropdownCssClass != null ||
        options.dropdownCss != null ||
        options.adaptDropdownCssClass != null
      ) {
        var DropdownCSS = require(options.amdBase + 'compat/dropdownCss');

        options.dropdownAdapter = Utils.Decorate(
          options.dropdownAdapter,
          DropdownCSS
        );
      }

      options.dropdownAdapter = Utils.Decorate(
        options.dropdownAdapter,
        AttachBody
      );
    }

    if (options.selectionAdapter == null) {
      if (options.multiple) {
        options.selectionAdapter = MultipleSelection;
      } else {
        options.selectionAdapter = SingleSelection;
      }

      // Add the placeholder mixin if a placeholder was specified
      if (options.placeholder != null) {
        options.selectionAdapter = Utils.Decorate(
          options.selectionAdapter,
          Placeholder
        );
      }

      if (options.allowClear) {
        options.selectionAdapter = Utils.Decorate(
          options.selectionAdapter,
          AllowClear
        );
      }

      if (options.multiple) {
        options.selectionAdapter = Utils.Decorate(
          options.selectionAdapter,
          SelectionSearch
        );
      }

      if (
        options.containerCssClass != null ||
        options.containerCss != null ||
        options.adaptContainerCssClass != null
      ) {
        var ContainerCSS = require(options.amdBase + 'compat/containerCss');

        options.selectionAdapter = Utils.Decorate(
          options.selectionAdapter,
          ContainerCSS
        );
      }

      options.selectionAdapter = Utils.Decorate(
        options.selectionAdapter,
        EventRelay
      );
    }

    // If the defaults were not previously applied from an element, it is
    // possible for the language option to have not been resolved
    options.language = this._resolveLanguage(options.language);

    // Always fall back to English since it will always be complete
    options.language.push('en');

    var uniqueLanguages = [];

    for (var l = 0; l < options.language.length; l++) {
      var language = options.language[l];

      if (uniqueLanguages.indexOf(language) === -1) {
        uniqueLanguages.push(language);
      }
    }

    options.language = uniqueLanguages;

    options.translations = this._processTranslations(
      options.language,
      options.debug
    );

    return options;
  };

  Defaults.prototype.reset = function () {
    function stripDiacritics (text) {
      // Used 'uni range + named function' from http://jsperf.com/diacritics/18
      function match(a) {
        return DIACRITICS[a] || a;
      }

      return text.replace(/[^\u0000-\u007E]/g, match);
    }

    function matcher (params, data) {
      // Always return the object if there is nothing to compare
      if ($.trim(params.term) === '') {
        return data;
      }

      // Do a recursive check for options with children
      if (data.children && data.children.length > 0) {
        // Clone the data object if there are children
        // This is required as we modify the object to remove any non-matches
        var match = $.extend(true, {}, data);

        // Check each child of the option
        for (var c = data.children.length - 1; c >= 0; c--) {
          var child = data.children[c];

          var matches = matcher(params, child);

          // If there wasn't a match, remove the object in the array
          if (matches == null) {
            match.children.splice(c, 1);
          }
        }

        // If any children matched, return the new object
        if (match.children.length > 0) {
          return match;
        }

        // If there were no matching children, check just the plain object
        return matcher(params, match);
      }

      var original = stripDiacritics(data.text).toUpperCase();
      var term = stripDiacritics(params.term).toUpperCase();

      // Check if the text contains the term
      if (original.indexOf(term) > -1) {
        return data;
      }

      // If it doesn't contain the term, don't return anything
      return null;
    }

    this.defaults = {
      amdBase: './',
      amdLanguageBase: './i18n/',
      closeOnSelect: true,
      debug: false,
      dropdownAutoWidth: false,
      escapeMarkup: Utils.escapeMarkup,
      language: {},
      matcher: matcher,
      minimumInputLength: 0,
      maximumInputLength: 0,
      maximumSelectionLength: 0,
      minimumResultsForSearch: 0,
      selectOnClose: false,
      scrollAfterSelect: false,
      sorter: function (data) {
        return data;
      },
      templateResult: function (result) {
        return result.text;
      },
      templateSelection: function (selection) {
        return selection.text;
      },
      theme: 'default',
      width: 'resolve'
    };
  };

  Defaults.prototype.applyFromElement = function (options, $element) {
    var optionLanguage = options.language;
    var defaultLanguage = this.defaults.language;
    var elementLanguage = $element.prop('lang');
    var parentLanguage = $element.closest('[lang]').prop('lang');

    var languages = Array.prototype.concat.call(
      this._resolveLanguage(elementLanguage),
      this._resolveLanguage(optionLanguage),
      this._resolveLanguage(defaultLanguage),
      this._resolveLanguage(parentLanguage)
    );

    options.language = languages;

    return options;
  };

  Defaults.prototype._resolveLanguage = function (language) {
    if (!language) {
      return [];
    }

    if ($.isEmptyObject(language)) {
      return [];
    }

    if ($.isPlainObject(language)) {
      return [language];
    }

    var languages;

    if (!$.isArray(language)) {
      languages = [language];
    } else {
      languages = language;
    }

    var resolvedLanguages = [];

    for (var l = 0; l < languages.length; l++) {
      resolvedLanguages.push(languages[l]);

      if (typeof languages[l] === 'string' && languages[l].indexOf('-') > 0) {
        // Extract the region information if it is included
        var languageParts = languages[l].split('-');
        var baseLanguage = languageParts[0];

        resolvedLanguages.push(baseLanguage);
      }
    }

    return resolvedLanguages;
  };

  Defaults.prototype._processTranslations = function (languages, debug) {
    var translations = new Translation();

    for (var l = 0; l < languages.length; l++) {
      var languageData = new Translation();

      var language = languages[l];

      if (typeof language === 'string') {
        try {
          // Try to load it with the original name
          languageData = Translation.loadPath(language);
        } catch (e) {
          try {
            // If we couldn't load it, check if it wasn't the full path
            language = this.defaults.amdLanguageBase + language;
            languageData = Translation.loadPath(language);
          } catch (ex) {
            // The translation could not be loaded at all. Sometimes this is
            // because of a configuration problem, other times this can be
            // because of how Select2 helps load all possible translation files
            if (debug && window.console && console.warn) {
              console.warn(
                'Select2: The language file for "' + language + '" could ' +
                'not be automatically loaded. A fallback will be used instead.'
              );
            }
          }
        }
      } else if ($.isPlainObject(language)) {
        languageData = new Translation(language);
      } else {
        languageData = language;
      }

      translations.extend(languageData);
    }

    return translations;
  };

  Defaults.prototype.set = function (key, value) {
    var camelKey = $.camelCase(key);

    var data = {};
    data[camelKey] = value;

    var convertedData = Utils._convertData(data);

    $.extend(true, this.defaults, convertedData);
  };

  var defaults = new Defaults();

  return defaults;
});

S2.define('select2/options',[
  'require',
  'jquery',
  './defaults',
  './utils'
], function (require, $, Defaults, Utils) {
  function Options (options, $element) {
    this.options = options;

    if ($element != null) {
      this.fromElement($element);
    }

    if ($element != null) {
      this.options = Defaults.applyFromElement(this.options, $element);
    }

    this.options = Defaults.apply(this.options);

    if ($element && $element.is('input')) {
      var InputCompat = require(this.get('amdBase') + 'compat/inputData');

      this.options.dataAdapter = Utils.Decorate(
        this.options.dataAdapter,
        InputCompat
      );
    }
  }

  Options.prototype.fromElement = function ($e) {
    var excludedData = ['select2'];

    if (this.options.multiple == null) {
      this.options.multiple = $e.prop('multiple');
    }

    if (this.options.disabled == null) {
      this.options.disabled = $e.prop('disabled');
    }

    if (this.options.dir == null) {
      if ($e.prop('dir')) {
        this.options.dir = $e.prop('dir');
      } else if ($e.closest('[dir]').prop('dir')) {
        this.options.dir = $e.closest('[dir]').prop('dir');
      } else {
        this.options.dir = 'ltr';
      }
    }

    $e.prop('disabled', this.options.disabled);
    $e.prop('multiple', this.options.multiple);

    if (Utils.GetData($e[0], 'select2Tags')) {
      if (this.options.debug && window.console && console.warn) {
        console.warn(
          'Select2: The `data-select2-tags` attribute has been changed to ' +
          'use the `data-data` and `data-tags="true"` attributes and will be ' +
          'removed in future versions of Select2.'
        );
      }

      Utils.StoreData($e[0], 'data', Utils.GetData($e[0], 'select2Tags'));
      Utils.StoreData($e[0], 'tags', true);
    }

    if (Utils.GetData($e[0], 'ajaxUrl')) {
      if (this.options.debug && window.console && console.warn) {
        console.warn(
          'Select2: The `data-ajax-url` attribute has been changed to ' +
          '`data-ajax--url` and support for the old attribute will be removed' +
          ' in future versions of Select2.'
        );
      }

      $e.attr('ajax--url', Utils.GetData($e[0], 'ajaxUrl'));
      Utils.StoreData($e[0], 'ajax-Url', Utils.GetData($e[0], 'ajaxUrl'));
    }

    var dataset = {};

    function upperCaseLetter(_, letter) {
      return letter.toUpperCase();
    }

    // Pre-load all of the attributes which are prefixed with `data-`
    for (var attr = 0; attr < $e[0].attributes.length; attr++) {
      var attributeName = $e[0].attributes[attr].name;
      var prefix = 'data-';

      if (attributeName.substr(0, prefix.length) == prefix) {
        // Get the contents of the attribute after `data-`
        var dataName = attributeName.substring(prefix.length);

        // Get the data contents from the consistent source
        // This is more than likely the jQuery data helper
        var dataValue = Utils.GetData($e[0], dataName);

        // camelCase the attribute name to match the spec
        var camelDataName = dataName.replace(/-([a-z])/g, upperCaseLetter);

        // Store the data attribute contents into the dataset since
        dataset[camelDataName] = dataValue;
      }
    }

    // Prefer the element's `dataset` attribute if it exists
    // jQuery 1.x does not correctly handle data attributes with multiple dashes
    if ($.fn.jquery && $.fn.jquery.substr(0, 2) == '1.' && $e[0].dataset) {
      dataset = $.extend(true, {}, $e[0].dataset, dataset);
    }

    // Prefer our internal data cache if it exists
    var data = $.extend(true, {}, Utils.GetData($e[0]), dataset);

    data = Utils._convertData(data);

    for (var key in data) {
      if ($.inArray(key, excludedData) > -1) {
        continue;
      }

      if ($.isPlainObject(this.options[key])) {
        $.extend(this.options[key], data[key]);
      } else {
        this.options[key] = data[key];
      }
    }

    return this;
  };

  Options.prototype.get = function (key) {
    return this.options[key];
  };

  Options.prototype.set = function (key, val) {
    this.options[key] = val;
  };

  return Options;
});

S2.define('select2/core',[
  'jquery',
  './options',
  './utils',
  './keys'
], function ($, Options, Utils, KEYS) {
  var Select2 = function ($element, options) {
    if (Utils.GetData($element[0], 'select2') != null) {
      Utils.GetData($element[0], 'select2').destroy();
    }

    this.$element = $element;

    this.id = this._generateId($element);

    options = options || {};

    this.options = new Options(options, $element);

    Select2.__super__.constructor.call(this);

    // Set up the tabindex

    var tabindex = $element.attr('tabindex') || 0;
    Utils.StoreData($element[0], 'old-tabindex', tabindex);
    $element.attr('tabindex', '-1');

    // Set up containers and adapters

    var DataAdapter = this.options.get('dataAdapter');
    this.dataAdapter = new DataAdapter($element, this.options);

    var $container = this.render();

    this._placeContainer($container);

    var SelectionAdapter = this.options.get('selectionAdapter');
    this.selection = new SelectionAdapter($element, this.options);
    this.$selection = this.selection.render();

    this.selection.position(this.$selection, $container);

    var DropdownAdapter = this.options.get('dropdownAdapter');
    this.dropdown = new DropdownAdapter($element, this.options);
    this.$dropdown = this.dropdown.render();

    this.dropdown.position(this.$dropdown, $container);

    var ResultsAdapter = this.options.get('resultsAdapter');
    this.results = new ResultsAdapter($element, this.options, this.dataAdapter);
    this.$results = this.results.render();

    this.results.position(this.$results, this.$dropdown);

    // Bind events

    var self = this;

    // Bind the container to all of the adapters
    this._bindAdapters();

    // Register any DOM event handlers
    this._registerDomEvents();

    // Register any internal event handlers
    this._registerDataEvents();
    this._registerSelectionEvents();
    this._registerDropdownEvents();
    this._registerResultsEvents();
    this._registerEvents();

    // Set the initial state
    this.dataAdapter.current(function (initialData) {
      self.trigger('selection:update', {
        data: initialData
      });
    });

    // Hide the original select
    $element.addClass('select2-hidden-accessible');
    $element.attr('aria-hidden', 'true');

    // Synchronize any monitored attributes
    this._syncAttributes();

    Utils.StoreData($element[0], 'select2', this);

    // Ensure backwards compatibility with $element.data('select2').
    $element.data('select2', this);
  };

  Utils.Extend(Select2, Utils.Observable);

  Select2.prototype._generateId = function ($element) {
    var id = '';

    if ($element.attr('id') != null) {
      id = $element.attr('id');
    } else if ($element.attr('name') != null) {
      id = $element.attr('name') + '-' + Utils.generateChars(2);
    } else {
      id = Utils.generateChars(4);
    }

    id = id.replace(/(:|\.|\[|\]|,)/g, '');
    id = 'select2-' + id;

    return id;
  };

  Select2.prototype._placeContainer = function ($container) {
    $container.insertAfter(this.$element);

    var width = this._resolveWidth(this.$element, this.options.get('width'));

    if (width != null) {
      $container.css('width', width);
    }
  };

  Select2.prototype._resolveWidth = function ($element, method) {
    var WIDTH = /^width:(([-+]?([0-9]*\.)?[0-9]+)(px|em|ex|%|in|cm|mm|pt|pc))/i;

    if (method == 'resolve') {
      var styleWidth = this._resolveWidth($element, 'style');

      if (styleWidth != null) {
        return styleWidth;
      }

      return this._resolveWidth($element, 'element');
    }

    if (method == 'element') {
      var elementWidth = $element.outerWidth(false);

      if (elementWidth <= 0) {
        return 'auto';
      }

      return elementWidth + 'px';
    }

    if (method == 'style') {
      var style = $element.attr('style');

      if (typeof(style) !== 'string') {
        return null;
      }

      var attrs = style.split(';');

      for (var i = 0, l = attrs.length; i < l; i = i + 1) {
        var attr = attrs[i].replace(/\s/g, '');
        var matches = attr.match(WIDTH);

        if (matches !== null && matches.length >= 1) {
          return matches[1];
        }
      }

      return null;
    }

    if (method == 'computedstyle') {
      var computedStyle = window.getComputedStyle($element[0]);

      return computedStyle.width;
    }

    return method;
  };

  Select2.prototype._bindAdapters = function () {
    this.dataAdapter.bind(this, this.$container);
    this.selection.bind(this, this.$container);

    this.dropdown.bind(this, this.$container);
    this.results.bind(this, this.$container);
  };

  Select2.prototype._registerDomEvents = function () {
    var self = this;

    this.$element.on('change.select2', function () {
      self.dataAdapter.current(function (data) {
        self.trigger('selection:update', {
          data: data
        });
      });
    });

    this.$element.on('focus.select2', function (evt) {
      self.trigger('focus', evt);
    });

    this._syncA = Utils.bind(this._syncAttributes, this);
    this._syncS = Utils.bind(this._syncSubtree, this);

    if (this.$element[0].attachEvent) {
      this.$element[0].attachEvent('onpropertychange', this._syncA);
    }

    var observer = window.MutationObserver ||
      window.WebKitMutationObserver ||
      window.MozMutationObserver
    ;

    if (observer != null) {
      this._observer = new observer(function (mutations) {
        self._syncA();
        self._syncS(null, mutations);
      });
      this._observer.observe(this.$element[0], {
        attributes: true,
        childList: true,
        subtree: false
      });
    } else if (this.$element[0].addEventListener) {
      this.$element[0].addEventListener(
        'DOMAttrModified',
        self._syncA,
        false
      );
      this.$element[0].addEventListener(
        'DOMNodeInserted',
        self._syncS,
        false
      );
      this.$element[0].addEventListener(
        'DOMNodeRemoved',
        self._syncS,
        false
      );
    }
  };

  Select2.prototype._registerDataEvents = function () {
    var self = this;

    this.dataAdapter.on('*', function (name, params) {
      self.trigger(name, params);
    });
  };

  Select2.prototype._registerSelectionEvents = function () {
    var self = this;
    var nonRelayEvents = ['toggle', 'focus'];

    this.selection.on('toggle', function () {
      self.toggleDropdown();
    });

    this.selection.on('focus', function (params) {
      self.focus(params);
    });

    this.selection.on('*', function (name, params) {
      if ($.inArray(name, nonRelayEvents) !== -1) {
        return;
      }

      self.trigger(name, params);
    });
  };

  Select2.prototype._registerDropdownEvents = function () {
    var self = this;

    this.dropdown.on('*', function (name, params) {
      self.trigger(name, params);
    });
  };

  Select2.prototype._registerResultsEvents = function () {
    var self = this;

    this.results.on('*', function (name, params) {
      self.trigger(name, params);
    });
  };

  Select2.prototype._registerEvents = function () {
    var self = this;

    this.on('open', function () {
      self.$container.addClass('select2-container--open');
    });

    this.on('close', function () {
      self.$container.removeClass('select2-container--open');
    });

    this.on('enable', function () {
      self.$container.removeClass('select2-container--disabled');
    });

    this.on('disable', function () {
      self.$container.addClass('select2-container--disabled');
    });

    this.on('blur', function () {
      self.$container.removeClass('select2-container--focus');
    });

    this.on('query', function (params) {
      if (!self.isOpen()) {
        self.trigger('open', {});
      }

      this.dataAdapter.query(params, function (data) {
        self.trigger('results:all', {
          data: data,
          query: params
        });
      });
    });

    this.on('query:append', function (params) {
      this.dataAdapter.query(params, function (data) {
        self.trigger('results:append', {
          data: data,
          query: params
        });
      });
    });

    this.on('keypress', function (evt) {
      var key = evt.which;

      if (self.isOpen()) {
        if (key === KEYS.ESC || key === KEYS.TAB ||
            (key === KEYS.UP && evt.altKey)) {
          self.close(evt);

          evt.preventDefault();
        } else if (key === KEYS.ENTER) {
          self.trigger('results:select', {});

          evt.preventDefault();
        } else if ((key === KEYS.SPACE && evt.ctrlKey)) {
          self.trigger('results:toggle', {});

          evt.preventDefault();
        } else if (key === KEYS.UP) {
          self.trigger('results:previous', {});

          evt.preventDefault();
        } else if (key === KEYS.DOWN) {
          self.trigger('results:next', {});

          evt.preventDefault();
        }
      } else {
        if (key === KEYS.ENTER || key === KEYS.SPACE ||
            (key === KEYS.DOWN && evt.altKey)) {
          self.open();

          evt.preventDefault();
        }
      }
    });
  };

  Select2.prototype._syncAttributes = function () {
    this.options.set('disabled', this.$element.prop('disabled'));

    if (this.isDisabled()) {
      if (this.isOpen()) {
        this.close();
      }

      this.trigger('disable', {});
    } else {
      this.trigger('enable', {});
    }
  };

  Select2.prototype._isChangeMutation = function (evt, mutations) {
    var changed = false;
    var self = this;

    // Ignore any mutation events raised for elements that aren't options or
    // optgroups. This handles the case when the select element is destroyed
    if (
      evt && evt.target && (
        evt.target.nodeName !== 'OPTION' && evt.target.nodeName !== 'OPTGROUP'
      )
    ) {
      return;
    }

    if (!mutations) {
      // If mutation events aren't supported, then we can only assume that the
      // change affected the selections
      changed = true;
    } else if (mutations.addedNodes && mutations.addedNodes.length > 0) {
      for (var n = 0; n < mutations.addedNodes.length; n++) {
        var node = mutations.addedNodes[n];

        if (node.selected) {
          changed = true;
        }
      }
    } else if (mutations.removedNodes && mutations.removedNodes.length > 0) {
      changed = true;
    } else if ($.isArray(mutations)) {
      $.each(mutations, function(evt, mutation) {
        if (self._isChangeMutation(evt, mutation)) {
          // We've found a change mutation.
          // Let's escape from the loop and continue
          changed = true;
          return false;
        }
      });
    }
    return changed;
  };

  Select2.prototype._syncSubtree = function (evt, mutations) {
    var changed = this._isChangeMutation(evt, mutations);
    var self = this;

    // Only re-pull the data if we think there is a change
    if (changed) {
      this.dataAdapter.current(function (currentData) {
        self.trigger('selection:update', {
          data: currentData
        });
      });
    }
  };

  /**
   * Override the trigger method to automatically trigger pre-events when
   * there are events that can be prevented.
   */
  Select2.prototype.trigger = function (name, args) {
    var actualTrigger = Select2.__super__.trigger;
    var preTriggerMap = {
      'open': 'opening',
      'close': 'closing',
      'select': 'selecting',
      'unselect': 'unselecting',
      'clear': 'clearing'
    };

    if (args === undefined) {
      args = {};
    }

    if (name in preTriggerMap) {
      var preTriggerName = preTriggerMap[name];
      var preTriggerArgs = {
        prevented: false,
        name: name,
        args: args
      };

      actualTrigger.call(this, preTriggerName, preTriggerArgs);

      if (preTriggerArgs.prevented) {
        args.prevented = true;

        return;
      }
    }

    actualTrigger.call(this, name, args);
  };

  Select2.prototype.toggleDropdown = function () {
    if (this.isDisabled()) {
      return;
    }

    if (this.isOpen()) {
      this.close();
    } else {
      this.open();
    }
  };

  Select2.prototype.open = function () {
    if (this.isOpen()) {
      return;
    }

    if (this.isDisabled()) {
      return;
    }

    this.trigger('query', {});
  };

  Select2.prototype.close = function (evt) {
    if (!this.isOpen()) {
      return;
    }

    this.trigger('close', { originalEvent : evt });
  };

  /**
   * Helper method to abstract the "enabled" (not "disabled") state of this
   * object.
   *
   * @return {true} if the instance is not disabled.
   * @return {false} if the instance is disabled.
   */
  Select2.prototype.isEnabled = function () {
    return !this.isDisabled();
  };

  /**
   * Helper method to abstract the "disabled" state of this object.
   *
   * @return {true} if the disabled option is true.
   * @return {false} if the disabled option is false.
   */
  Select2.prototype.isDisabled = function () {
    return this.options.get('disabled');
  };

  Select2.prototype.isOpen = function () {
    return this.$container.hasClass('select2-container--open');
  };

  Select2.prototype.hasFocus = function () {
    return this.$container.hasClass('select2-container--focus');
  };

  Select2.prototype.focus = function (data) {
    // No need to re-trigger focus events if we are already focused
    if (this.hasFocus()) {
      return;
    }

    this.$container.addClass('select2-container--focus');
    this.trigger('focus', {});
  };

  Select2.prototype.enable = function (args) {
    if (this.options.get('debug') && window.console && console.warn) {
      console.warn(
        'Select2: The `select2("enable")` method has been deprecated and will' +
        ' be removed in later Select2 versions. Use $element.prop("disabled")' +
        ' instead.'
      );
    }

    if (args == null || args.length === 0) {
      args = [true];
    }

    var disabled = !args[0];

    this.$element.prop('disabled', disabled);
  };

  Select2.prototype.data = function () {
    if (this.options.get('debug') &&
        arguments.length > 0 && window.console && console.warn) {
      console.warn(
        'Select2: Data can no longer be set using `select2("data")`. You ' +
        'should consider setting the value instead using `$element.val()`.'
      );
    }

    var data = [];

    this.dataAdapter.current(function (currentData) {
      data = currentData;
    });

    return data;
  };

  Select2.prototype.val = function (args) {
    if (this.options.get('debug') && window.console && console.warn) {
      console.warn(
        'Select2: The `select2("val")` method has been deprecated and will be' +
        ' removed in later Select2 versions. Use $element.val() instead.'
      );
    }

    if (args == null || args.length === 0) {
      return this.$element.val();
    }

    var newVal = args[0];

    if ($.isArray(newVal)) {
      newVal = $.map(newVal, function (obj) {
        return obj.toString();
      });
    }

    this.$element.val(newVal).trigger('input').trigger('change');
  };

  Select2.prototype.destroy = function () {
    this.$container.remove();

    if (this.$element[0].detachEvent) {
      this.$element[0].detachEvent('onpropertychange', this._syncA);
    }

    if (this._observer != null) {
      this._observer.disconnect();
      this._observer = null;
    } else if (this.$element[0].removeEventListener) {
      this.$element[0]
        .removeEventListener('DOMAttrModified', this._syncA, false);
      this.$element[0]
        .removeEventListener('DOMNodeInserted', this._syncS, false);
      this.$element[0]
        .removeEventListener('DOMNodeRemoved', this._syncS, false);
    }

    this._syncA = null;
    this._syncS = null;

    this.$element.off('.select2');
    this.$element.attr('tabindex',
    Utils.GetData(this.$element[0], 'old-tabindex'));

    this.$element.removeClass('select2-hidden-accessible');
    this.$element.attr('aria-hidden', 'false');
    Utils.RemoveData(this.$element[0]);
    this.$element.removeData('select2');

    this.dataAdapter.destroy();
    this.selection.destroy();
    this.dropdown.destroy();
    this.results.destroy();

    this.dataAdapter = null;
    this.selection = null;
    this.dropdown = null;
    this.results = null;
  };

  Select2.prototype.render = function () {
    var $container = $(
      '<span class="select2 select2-container">' +
        '<span class="selection"></span>' +
        '<span class="dropdown-wrapper" aria-hidden="true"></span>' +
      '</span>'
    );

    $container.attr('dir', this.options.get('dir'));

    this.$container = $container;

    this.$container.addClass('select2-container--' + this.options.get('theme'));

    Utils.StoreData($container[0], 'element', this.$element);

    return $container;
  };

  return Select2;
});

S2.define('select2/compat/utils',[
  'jquery'
], function ($) {
  function syncCssClasses ($dest, $src, adapter) {
    var classes, replacements = [], adapted;

    classes = $.trim($dest.attr('class'));

    if (classes) {
      classes = '' + classes; // for IE which returns object

      $(classes.split(/\s+/)).each(function () {
        // Save all Select2 classes
        if (this.indexOf('select2-') === 0) {
          replacements.push(this);
        }
      });
    }

    classes = $.trim($src.attr('class'));

    if (classes) {
      classes = '' + classes; // for IE which returns object

      $(classes.split(/\s+/)).each(function () {
        // Only adapt non-Select2 classes
        if (this.indexOf('select2-') !== 0) {
          adapted = adapter(this);

          if (adapted != null) {
            replacements.push(adapted);
          }
        }
      });
    }

    $dest.attr('class', replacements.join(' '));
  }

  return {
    syncCssClasses: syncCssClasses
  };
});

S2.define('select2/compat/containerCss',[
  'jquery',
  './utils'
], function ($, CompatUtils) {
  // No-op CSS adapter that discards all classes by default
  function _containerAdapter (clazz) {
    return null;
  }

  function ContainerCSS () { }

  ContainerCSS.prototype.render = function (decorated) {
    var $container = decorated.call(this);

    var containerCssClass = this.options.get('containerCssClass') || '';

    if ($.isFunction(containerCssClass)) {
      containerCssClass = containerCssClass(this.$element);
    }

    var containerCssAdapter = this.options.get('adaptContainerCssClass');
    containerCssAdapter = containerCssAdapter || _containerAdapter;

    if (containerCssClass.indexOf(':all:') !== -1) {
      containerCssClass = containerCssClass.replace(':all:', '');

      var _cssAdapter = containerCssAdapter;

      containerCssAdapter = function (clazz) {
        var adapted = _cssAdapter(clazz);

        if (adapted != null) {
          // Append the old one along with the adapted one
          return adapted + ' ' + clazz;
        }

        return clazz;
      };
    }

    var containerCss = this.options.get('containerCss') || {};

    if ($.isFunction(containerCss)) {
      containerCss = containerCss(this.$element);
    }

    CompatUtils.syncCssClasses($container, this.$element, containerCssAdapter);

    $container.css(containerCss);
    $container.addClass(containerCssClass);

    return $container;
  };

  return ContainerCSS;
});

S2.define('select2/compat/dropdownCss',[
  'jquery',
  './utils'
], function ($, CompatUtils) {
  // No-op CSS adapter that discards all classes by default
  function _dropdownAdapter (clazz) {
    return null;
  }

  function DropdownCSS () { }

  DropdownCSS.prototype.render = function (decorated) {
    var $dropdown = decorated.call(this);

    var dropdownCssClass = this.options.get('dropdownCssClass') || '';

    if ($.isFunction(dropdownCssClass)) {
      dropdownCssClass = dropdownCssClass(this.$element);
    }

    var dropdownCssAdapter = this.options.get('adaptDropdownCssClass');
    dropdownCssAdapter = dropdownCssAdapter || _dropdownAdapter;

    if (dropdownCssClass.indexOf(':all:') !== -1) {
      dropdownCssClass = dropdownCssClass.replace(':all:', '');

      var _cssAdapter = dropdownCssAdapter;

      dropdownCssAdapter = function (clazz) {
        var adapted = _cssAdapter(clazz);

        if (adapted != null) {
          // Append the old one along with the adapted one
          return adapted + ' ' + clazz;
        }

        return clazz;
      };
    }

    var dropdownCss = this.options.get('dropdownCss') || {};

    if ($.isFunction(dropdownCss)) {
      dropdownCss = dropdownCss(this.$element);
    }

    CompatUtils.syncCssClasses($dropdown, this.$element, dropdownCssAdapter);

    $dropdown.css(dropdownCss);
    $dropdown.addClass(dropdownCssClass);

    return $dropdown;
  };

  return DropdownCSS;
});

S2.define('select2/compat/initSelection',[
  'jquery'
], function ($) {
  function InitSelection (decorated, $element, options) {
    if (options.get('debug') && window.console && console.warn) {
      console.warn(
        'Select2: The `initSelection` option has been deprecated in favor' +
        ' of a custom data adapter that overrides the `current` method. ' +
        'This method is now called multiple times instead of a single ' +
        'time when the instance is initialized. Support will be removed ' +
        'for the `initSelection` option in future versions of Select2'
      );
    }

    this.initSelection = options.get('initSelection');
    this._isInitialized = false;

    decorated.call(this, $element, options);
  }

  InitSelection.prototype.current = function (decorated, callback) {
    var self = this;

    if (this._isInitialized) {
      decorated.call(this, callback);

      return;
    }

    this.initSelection.call(null, this.$element, function (data) {
      self._isInitialized = true;

      if (!$.isArray(data)) {
        data = [data];
      }

      callback(data);
    });
  };

  return InitSelection;
});

S2.define('select2/compat/inputData',[
  'jquery',
  '../utils'
], function ($, Utils) {
  function InputData (decorated, $element, options) {
    this._currentData = [];
    this._valueSeparator = options.get('valueSeparator') || ',';

    if ($element.prop('type') === 'hidden') {
      if (options.get('debug') && console && console.warn) {
        console.warn(
          'Select2: Using a hidden input with Select2 is no longer ' +
          'supported and may stop working in the future. It is recommended ' +
          'to use a `<select>` element instead.'
        );
      }
    }

    decorated.call(this, $element, options);
  }

  InputData.prototype.current = function (_, callback) {
    function getSelected (data, selectedIds) {
      var selected = [];

      if (data.selected || $.inArray(data.id, selectedIds) !== -1) {
        data.selected = true;
        selected.push(data);
      } else {
        data.selected = false;
      }

      if (data.children) {
        selected.push.apply(selected, getSelected(data.children, selectedIds));
      }

      return selected;
    }

    var selected = [];

    for (var d = 0; d < this._currentData.length; d++) {
      var data = this._currentData[d];

      selected.push.apply(
        selected,
        getSelected(
          data,
          this.$element.val().split(
            this._valueSeparator
          )
        )
      );
    }

    callback(selected);
  };

  InputData.prototype.select = function (_, data) {
    if (!this.options.get('multiple')) {
      this.current(function (allData) {
        $.map(allData, function (data) {
          data.selected = false;
        });
      });

      this.$element.val(data.id);
      this.$element.trigger('input').trigger('change');
    } else {
      var value = this.$element.val();
      value += this._valueSeparator + data.id;

      this.$element.val(value);
      this.$element.trigger('input').trigger('change');
    }
  };

  InputData.prototype.unselect = function (_, data) {
    var self = this;

    data.selected = false;

    this.current(function (allData) {
      var values = [];

      for (var d = 0; d < allData.length; d++) {
        var item = allData[d];

        if (data.id == item.id) {
          continue;
        }

        values.push(item.id);
      }

      self.$element.val(values.join(self._valueSeparator));
      self.$element.trigger('input').trigger('change');
    });
  };

  InputData.prototype.query = function (_, params, callback) {
    var results = [];

    for (var d = 0; d < this._currentData.length; d++) {
      var data = this._currentData[d];

      var matches = this.matches(params, data);

      if (matches !== null) {
        results.push(matches);
      }
    }

    callback({
      results: results
    });
  };

  InputData.prototype.addOptions = function (_, $options) {
    var options = $.map($options, function ($option) {
      return Utils.GetData($option[0], 'data');
    });

    this._currentData.push.apply(this._currentData, options);
  };

  return InputData;
});

S2.define('select2/compat/matcher',[
  'jquery'
], function ($) {
  function oldMatcher (matcher) {
    function wrappedMatcher (params, data) {
      var match = $.extend(true, {}, data);

      if (params.term == null || $.trim(params.term) === '') {
        return match;
      }

      if (data.children) {
        for (var c = data.children.length - 1; c >= 0; c--) {
          var child = data.children[c];

          // Check if the child object matches
          // The old matcher returned a boolean true or false
          var doesMatch = matcher(params.term, child.text, child);

          // If the child didn't match, pop it off
          if (!doesMatch) {
            match.children.splice(c, 1);
          }
        }

        if (match.children.length > 0) {
          return match;
        }
      }

      if (matcher(params.term, data.text, data)) {
        return match;
      }

      return null;
    }

    return wrappedMatcher;
  }

  return oldMatcher;
});

S2.define('select2/compat/query',[

], function () {
  function Query (decorated, $element, options) {
    if (options.get('debug') && window.console && console.warn) {
      console.warn(
        'Select2: The `query` option has been deprecated in favor of a ' +
        'custom data adapter that overrides the `query` method. Support ' +
        'will be removed for the `query` option in future versions of ' +
        'Select2.'
      );
    }

    decorated.call(this, $element, options);
  }

  Query.prototype.query = function (_, params, callback) {
    params.callback = callback;

    var query = this.options.get('query');

    query.call(null, params);
  };

  return Query;
});

S2.define('select2/dropdown/attachContainer',[

], function () {
  function AttachContainer (decorated, $element, options) {
    decorated.call(this, $element, options);
  }

  AttachContainer.prototype.position =
    function (decorated, $dropdown, $container) {
    var $dropdownContainer = $container.find('.dropdown-wrapper');
    $dropdownContainer.append($dropdown);

    $dropdown.addClass('select2-dropdown--below');
    $container.addClass('select2-container--below');
  };

  return AttachContainer;
});

S2.define('select2/dropdown/stopPropagation',[

], function () {
  function StopPropagation () { }

  StopPropagation.prototype.bind = function (decorated, container, $container) {
    decorated.call(this, container, $container);

    var stoppedEvents = [
    'blur',
    'change',
    'click',
    'dblclick',
    'focus',
    'focusin',
    'focusout',
    'input',
    'keydown',
    'keyup',
    'keypress',
    'mousedown',
    'mouseenter',
    'mouseleave',
    'mousemove',
    'mouseover',
    'mouseup',
    'search',
    'touchend',
    'touchstart'
    ];

    this.$dropdown.on(stoppedEvents.join(' '), function (evt) {
      evt.stopPropagation();
    });
  };

  return StopPropagation;
});

S2.define('select2/selection/stopPropagation',[

], function () {
  function StopPropagation () { }

  StopPropagation.prototype.bind = function (decorated, container, $container) {
    decorated.call(this, container, $container);

    var stoppedEvents = [
      'blur',
      'change',
      'click',
      'dblclick',
      'focus',
      'focusin',
      'focusout',
      'input',
      'keydown',
      'keyup',
      'keypress',
      'mousedown',
      'mouseenter',
      'mouseleave',
      'mousemove',
      'mouseover',
      'mouseup',
      'search',
      'touchend',
      'touchstart'
    ];

    this.$selection.on(stoppedEvents.join(' '), function (evt) {
      evt.stopPropagation();
    });
  };

  return StopPropagation;
});

/*!
 * jQuery Mousewheel 3.1.13
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 */

(function (factory) {
    if ( typeof S2.define === 'function' && S2.define.amd ) {
        // AMD. Register as an anonymous module.
        S2.define('jquery-mousewheel',['jquery'], factory);
    } else if (typeof exports === 'object') {
        // Node/CommonJS style for Browserify
        module.exports = factory;
    } else {
        // Browser globals
        factory(jQuery);
    }
}(function ($) {

    var toFix  = ['wheel', 'mousewheel', 'DOMMouseScroll', 'MozMousePixelScroll'],
        toBind = ( 'onwheel' in document || document.documentMode >= 9 ) ?
                    ['wheel'] : ['mousewheel', 'DomMouseScroll', 'MozMousePixelScroll'],
        slice  = Array.prototype.slice,
        nullLowestDeltaTimeout, lowestDelta;

    if ( $.event.fixHooks ) {
        for ( var i = toFix.length; i; ) {
            $.event.fixHooks[ toFix[--i] ] = $.event.mouseHooks;
        }
    }

    var special = $.event.special.mousewheel = {
        version: '3.1.12',

        setup: function() {
            if ( this.addEventListener ) {
                for ( var i = toBind.length; i; ) {
                    this.addEventListener( toBind[--i], handler, false );
                }
            } else {
                this.onmousewheel = handler;
            }
            // Store the line height and page height for this particular element
            $.data(this, 'mousewheel-line-height', special.getLineHeight(this));
            $.data(this, 'mousewheel-page-height', special.getPageHeight(this));
        },

        teardown: function() {
            if ( this.removeEventListener ) {
                for ( var i = toBind.length; i; ) {
                    this.removeEventListener( toBind[--i], handler, false );
                }
            } else {
                this.onmousewheel = null;
            }
            // Clean up the data we added to the element
            $.removeData(this, 'mousewheel-line-height');
            $.removeData(this, 'mousewheel-page-height');
        },

        getLineHeight: function(elem) {
            var $elem = $(elem),
                $parent = $elem['offsetParent' in $.fn ? 'offsetParent' : 'parent']();
            if (!$parent.length) {
                $parent = $('body');
            }
            return parseInt($parent.css('fontSize'), 10) || parseInt($elem.css('fontSize'), 10) || 16;
        },

        getPageHeight: function(elem) {
            return $(elem).height();
        },

        settings: {
            adjustOldDeltas: true, // see shouldAdjustOldDeltas() below
            normalizeOffset: true  // calls getBoundingClientRect for each event
        }
    };

    $.fn.extend({
        mousewheel: function(fn) {
            return fn ? this.bind('mousewheel', fn) : this.trigger('mousewheel');
        },

        unmousewheel: function(fn) {
            return this.unbind('mousewheel', fn);
        }
    });


    function handler(event) {
        var orgEvent   = event || window.event,
            args       = slice.call(arguments, 1),
            delta      = 0,
            deltaX     = 0,
            deltaY     = 0,
            absDelta   = 0,
            offsetX    = 0,
            offsetY    = 0;
        event = $.event.fix(orgEvent);
        event.type = 'mousewheel';

        // Old school scrollwheel delta
        if ( 'detail'      in orgEvent ) { deltaY = orgEvent.detail * -1;      }
        if ( 'wheelDelta'  in orgEvent ) { deltaY = orgEvent.wheelDelta;       }
        if ( 'wheelDeltaY' in orgEvent ) { deltaY = orgEvent.wheelDeltaY;      }
        if ( 'wheelDeltaX' in orgEvent ) { deltaX = orgEvent.wheelDeltaX * -1; }

        // Firefox < 17 horizontal scrolling related to DOMMouseScroll event
        if ( 'axis' in orgEvent && orgEvent.axis === orgEvent.HORIZONTAL_AXIS ) {
            deltaX = deltaY * -1;
            deltaY = 0;
        }

        // Set delta to be deltaY or deltaX if deltaY is 0 for backwards compatabilitiy
        delta = deltaY === 0 ? deltaX : deltaY;

        // New school wheel delta (wheel event)
        if ( 'deltaY' in orgEvent ) {
            deltaY = orgEvent.deltaY * -1;
            delta  = deltaY;
        }
        if ( 'deltaX' in orgEvent ) {
            deltaX = orgEvent.deltaX;
            if ( deltaY === 0 ) { delta  = deltaX * -1; }
        }

        // No change actually happened, no reason to go any further
        if ( deltaY === 0 && deltaX === 0 ) { return; }

        // Need to convert lines and pages to pixels if we aren't already in pixels
        // There are three delta modes:
        //   * deltaMode 0 is by pixels, nothing to do
        //   * deltaMode 1 is by lines
        //   * deltaMode 2 is by pages
        if ( orgEvent.deltaMode === 1 ) {
            var lineHeight = $.data(this, 'mousewheel-line-height');
            delta  *= lineHeight;
            deltaY *= lineHeight;
            deltaX *= lineHeight;
        } else if ( orgEvent.deltaMode === 2 ) {
            var pageHeight = $.data(this, 'mousewheel-page-height');
            delta  *= pageHeight;
            deltaY *= pageHeight;
            deltaX *= pageHeight;
        }

        // Store lowest absolute delta to normalize the delta values
        absDelta = Math.max( Math.abs(deltaY), Math.abs(deltaX) );

        if ( !lowestDelta || absDelta < lowestDelta ) {
            lowestDelta = absDelta;

            // Adjust older deltas if necessary
            if ( shouldAdjustOldDeltas(orgEvent, absDelta) ) {
                lowestDelta /= 40;
            }
        }

        // Adjust older deltas if necessary
        if ( shouldAdjustOldDeltas(orgEvent, absDelta) ) {
            // Divide all the things by 40!
            delta  /= 40;
            deltaX /= 40;
            deltaY /= 40;
        }

        // Get a whole, normalized value for the deltas
        delta  = Math[ delta  >= 1 ? 'floor' : 'ceil' ](delta  / lowestDelta);
        deltaX = Math[ deltaX >= 1 ? 'floor' : 'ceil' ](deltaX / lowestDelta);
        deltaY = Math[ deltaY >= 1 ? 'floor' : 'ceil' ](deltaY / lowestDelta);

        // Normalise offsetX and offsetY properties
        if ( special.settings.normalizeOffset && this.getBoundingClientRect ) {
            var boundingRect = this.getBoundingClientRect();
            offsetX = event.clientX - boundingRect.left;
            offsetY = event.clientY - boundingRect.top;
        }

        // Add information to the event object
        event.deltaX = deltaX;
        event.deltaY = deltaY;
        event.deltaFactor = lowestDelta;
        event.offsetX = offsetX;
        event.offsetY = offsetY;
        // Go ahead and set deltaMode to 0 since we converted to pixels
        // Although this is a little odd since we overwrite the deltaX/Y
        // properties with normalized deltas.
        event.deltaMode = 0;

        // Add event and delta to the front of the arguments
        args.unshift(event, delta, deltaX, deltaY);

        // Clearout lowestDelta after sometime to better
        // handle multiple device types that give different
        // a different lowestDelta
        // Ex: trackpad = 3 and mouse wheel = 120
        if (nullLowestDeltaTimeout) { clearTimeout(nullLowestDeltaTimeout); }
        nullLowestDeltaTimeout = setTimeout(nullLowestDelta, 200);

        return ($.event.dispatch || $.event.handle).apply(this, args);
    }

    function nullLowestDelta() {
        lowestDelta = null;
    }

    function shouldAdjustOldDeltas(orgEvent, absDelta) {
        // If this is an older event and the delta is divisable by 120,
        // then we are assuming that the browser is treating this as an
        // older mouse wheel event and that we should divide the deltas
        // by 40 to try and get a more usable deltaFactor.
        // Side note, this actually impacts the reported scroll distance
        // in older browsers and can cause scrolling to be slower than native.
        // Turn this off by setting $.event.special.mousewheel.settings.adjustOldDeltas to false.
        return special.settings.adjustOldDeltas && orgEvent.type === 'mousewheel' && absDelta % 120 === 0;
    }

}));

S2.define('jquery.select2',[
  'jquery',
  'jquery-mousewheel',

  './select2/core',
  './select2/defaults',
  './select2/utils'
], function ($, _, Select2, Defaults, Utils) {
  if ($.fn.select2 == null) {
    // All methods that should return the element
    var thisMethods = ['open', 'close', 'destroy'];

    $.fn.select2 = function (options) {
      options = options || {};

      if (typeof options === 'object') {
        this.each(function () {
          var instanceOptions = $.extend(true, {}, options);

          var instance = new Select2($(this), instanceOptions);
        });

        return this;
      } else if (typeof options === 'string') {
        var ret;
        var args = Array.prototype.slice.call(arguments, 1);

        this.each(function () {
          var instance = Utils.GetData(this, 'select2');

          if (instance == null && window.console && console.error) {
            console.error(
              'The select2(\'' + options + '\') method was called on an ' +
              'element that is not using Select2.'
            );
          }

          ret = instance[options].apply(instance, args);
        });

        // Check if we should be returning `this`
        if ($.inArray(options, thisMethods) > -1) {
          return this;
        }

        return ret;
      } else {
        throw new Error('Invalid arguments for Select2: ' + options);
      }
    };
  }

  if ($.fn.select2.defaults == null) {
    $.fn.select2.defaults = Defaults;
  }

  return Select2;
});

  // Return the AMD loader configuration so it can be used outside of this file
  return {
    define: S2.define,
    require: S2.require
  };
}());

  // Autoload the jQuery bindings
  // We know that all of the modules exist above this, so we're safe
  var select2 = S2.require('jquery.select2');

  // Hold the AMD module references on the jQuery function that was just loaded
  // This allows Select2 to use the internal loader outside of this file, such
  // as in the language files.
  jQuery.fn.select2.amd = S2;

  // Return the Select2 instance for anyone who is importing it.
  return select2;
}));



========== staticfiles/admin/js/vendor/select2/select2.full.min.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */
!function(n){"function"==typeof define&&define.amd?define(["jquery"],n):"object"==typeof module&&module.exports?module.exports=function(e,t){return void 0===t&&(t="undefined"!=typeof window?require("jquery"):require("jquery")(e)),n(t),t}:n(jQuery)}(function(d){var e=function(){if(d&&d.fn&&d.fn.select2&&d.fn.select2.amd)var e=d.fn.select2.amd;var t,n,i,h,o,s,f,g,m,v,y,_,r,a,w,l;function b(e,t){return r.call(e,t)}function c(e,t){var n,i,r,o,s,a,l,c,u,d,p,h=t&&t.split("/"),f=y.map,g=f&&f["*"]||{};if(e){for(s=(e=e.split("/")).length-1,y.nodeIdCompat&&w.test(e[s])&&(e[s]=e[s].replace(w,"")),"."===e[0].charAt(0)&&h&&(e=h.slice(0,h.length-1).concat(e)),u=0;u<e.length;u++)if("."===(p=e[u]))e.splice(u,1),u-=1;else if(".."===p){if(0===u||1===u&&".."===e[2]||".."===e[u-1])continue;0<u&&(e.splice(u-1,2),u-=2)}e=e.join("/")}if((h||g)&&f){for(u=(n=e.split("/")).length;0<u;u-=1){if(i=n.slice(0,u).join("/"),h)for(d=h.length;0<d;d-=1)if(r=(r=f[h.slice(0,d).join("/")])&&r[i]){o=r,a=u;break}if(o)break;!l&&g&&g[i]&&(l=g[i],c=u)}!o&&l&&(o=l,a=c),o&&(n.splice(0,a,o),e=n.join("/"))}return e}function A(t,n){return function(){var e=a.call(arguments,0);return"string"!=typeof e[0]&&1===e.length&&e.push(null),s.apply(h,e.concat([t,n]))}}function x(t){return function(e){m[t]=e}}function D(e){if(b(v,e)){var t=v[e];delete v[e],_[e]=!0,o.apply(h,t)}if(!b(m,e)&&!b(_,e))throw new Error("No "+e);return m[e]}function u(e){var t,n=e?e.indexOf("!"):-1;return-1<n&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function S(e){return e?u(e):[]}return e&&e.requirejs||(e?n=e:e={},m={},v={},y={},_={},r=Object.prototype.hasOwnProperty,a=[].slice,w=/\.js$/,f=function(e,t){var n,i=u(e),r=i[0],o=t[1];return e=i[1],r&&(n=D(r=c(r,o))),r?e=n&&n.normalize?n.normalize(e,function(t){return function(e){return c(e,t)}}(o)):c(e,o):(r=(i=u(e=c(e,o)))[0],e=i[1],r&&(n=D(r))),{f:r?r+"!"+e:e,n:e,pr:r,p:n}},g={require:function(e){return A(e)},exports:function(e){var t=m[e];return void 0!==t?t:m[e]={}},module:function(e){return{id:e,uri:"",exports:m[e],config:function(e){return function(){return y&&y.config&&y.config[e]||{}}}(e)}}},o=function(e,t,n,i){var r,o,s,a,l,c,u,d=[],p=typeof n;if(c=S(i=i||e),"undefined"==p||"function"==p){for(t=!t.length&&n.length?["require","exports","module"]:t,l=0;l<t.length;l+=1)if("require"===(o=(a=f(t[l],c)).f))d[l]=g.require(e);else if("exports"===o)d[l]=g.exports(e),u=!0;else if("module"===o)r=d[l]=g.module(e);else if(b(m,o)||b(v,o)||b(_,o))d[l]=D(o);else{if(!a.p)throw new Error(e+" missing "+o);a.p.load(a.n,A(i,!0),x(o),{}),d[l]=m[o]}s=n?n.apply(m[e],d):void 0,e&&(r&&r.exports!==h&&r.exports!==m[e]?m[e]=r.exports:s===h&&u||(m[e]=s))}else e&&(m[e]=n)},t=n=s=function(e,t,n,i,r){if("string"==typeof e)return g[e]?g[e](t):D(f(e,S(t)).f);if(!e.splice){if((y=e).deps&&s(y.deps,y.callback),!t)return;t.splice?(e=t,t=n,n=null):e=h}return t=t||function(){},"function"==typeof n&&(n=i,i=r),i?o(h,e,t,n):setTimeout(function(){o(h,e,t,n)},4),s},s.config=function(e){return s(e)},t._defined=m,(i=function(e,t,n){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");t.splice||(n=t,t=[]),b(m,e)||b(v,e)||(v[e]=[e,t,n])}).amd={jQuery:!0},e.requirejs=t,e.require=n,e.define=i),e.define("almond",function(){}),e.define("jquery",[],function(){var e=d||$;return null==e&&console&&console.error&&console.error("Select2: An instance of jQuery or a jQuery-compatible library was not found. Make sure that you are including jQuery before Select2 on your web page."),e}),e.define("select2/utils",["jquery"],function(o){var r={};function u(e){var t=e.prototype,n=[];for(var i in t){"function"==typeof t[i]&&"constructor"!==i&&n.push(i)}return n}r.Extend=function(e,t){var n={}.hasOwnProperty;function i(){this.constructor=e}for(var r in t)n.call(t,r)&&(e[r]=t[r]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},r.Decorate=function(i,r){var e=u(r),t=u(i);function o(){var e=Array.prototype.unshift,t=r.prototype.constructor.length,n=i.prototype.constructor;0<t&&(e.call(arguments,i.prototype.constructor),n=r.prototype.constructor),n.apply(this,arguments)}r.displayName=i.displayName,o.prototype=new function(){this.constructor=o};for(var n=0;n<t.length;n++){var s=t[n];o.prototype[s]=i.prototype[s]}function a(e){var t=function(){};e in o.prototype&&(t=o.prototype[e]);var n=r.prototype[e];return function(){return Array.prototype.unshift.call(arguments,t),n.apply(this,arguments)}}for(var l=0;l<e.length;l++){var c=e[l];o.prototype[c]=a(c)}return o};function e(){this.listeners={}}e.prototype.on=function(e,t){this.listeners=this.listeners||{},e in this.listeners?this.listeners[e].push(t):this.listeners[e]=[t]},e.prototype.trigger=function(e){var t=Array.prototype.slice,n=t.call(arguments,1);this.listeners=this.listeners||{},null==n&&(n=[]),0===n.length&&n.push({}),(n[0]._type=e)in this.listeners&&this.invoke(this.listeners[e],t.call(arguments,1)),"*"in this.listeners&&this.invoke(this.listeners["*"],arguments)},e.prototype.invoke=function(e,t){for(var n=0,i=e.length;n<i;n++)e[n].apply(this,t)},r.Observable=e,r.generateChars=function(e){for(var t="",n=0;n<e;n++){t+=Math.floor(36*Math.random()).toString(36)}return t},r.bind=function(e,t){return function(){e.apply(t,arguments)}},r._convertData=function(e){for(var t in e){var n=t.split("-"),i=e;if(1!==n.length){for(var r=0;r<n.length;r++){var o=n[r];(o=o.substring(0,1).toLowerCase()+o.substring(1))in i||(i[o]={}),r==n.length-1&&(i[o]=e[t]),i=i[o]}delete e[t]}}return e},r.hasScroll=function(e,t){var n=o(t),i=t.style.overflowX,r=t.style.overflowY;return(i!==r||"hidden"!==r&&"visible"!==r)&&("scroll"===i||"scroll"===r||(n.innerHeight()<t.scrollHeight||n.innerWidth()<t.scrollWidth))},r.escapeMarkup=function(e){var t={"\\":"&#92;","&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#47;"};return"string"!=typeof e?e:String(e).replace(/[&<>"'\/\\]/g,function(e){return t[e]})},r.appendMany=function(e,t){if("1.7"===o.fn.jquery.substr(0,3)){var n=o();o.map(t,function(e){n=n.add(e)}),t=n}e.append(t)},r.__cache={};var n=0;return r.GetUniqueElementId=function(e){var t=e.getAttribute("data-select2-id");return null==t&&(e.id?(t=e.id,e.setAttribute("data-select2-id",t)):(e.setAttribute("data-select2-id",++n),t=n.toString())),t},r.StoreData=function(e,t,n){var i=r.GetUniqueElementId(e);r.__cache[i]||(r.__cache[i]={}),r.__cache[i][t]=n},r.GetData=function(e,t){var n=r.GetUniqueElementId(e);return t?r.__cache[n]&&null!=r.__cache[n][t]?r.__cache[n][t]:o(e).data(t):r.__cache[n]},r.RemoveData=function(e){var t=r.GetUniqueElementId(e);null!=r.__cache[t]&&delete r.__cache[t],e.removeAttribute("data-select2-id")},r}),e.define("select2/results",["jquery","./utils"],function(h,f){function i(e,t,n){this.$element=e,this.data=n,this.options=t,i.__super__.constructor.call(this)}return f.Extend(i,f.Observable),i.prototype.render=function(){var e=h('<ul class="select2-results__options" role="listbox"></ul>');return this.options.get("multiple")&&e.attr("aria-multiselectable","true"),this.$results=e},i.prototype.clear=function(){this.$results.empty()},i.prototype.displayMessage=function(e){var t=this.options.get("escapeMarkup");this.clear(),this.hideLoading();var n=h('<li role="alert" aria-live="assertive" class="select2-results__option"></li>'),i=this.options.get("translations").get(e.message);n.append(t(i(e.args))),n[0].className+=" select2-results__message",this.$results.append(n)},i.prototype.hideMessages=function(){this.$results.find(".select2-results__message").remove()},i.prototype.append=function(e){this.hideLoading();var t=[];if(null!=e.results&&0!==e.results.length){e.results=this.sort(e.results);for(var n=0;n<e.results.length;n++){var i=e.results[n],r=this.option(i);t.push(r)}this.$results.append(t)}else 0===this.$results.children().length&&this.trigger("results:message",{message:"noResults"})},i.prototype.position=function(e,t){t.find(".select2-results").append(e)},i.prototype.sort=function(e){return this.options.get("sorter")(e)},i.prototype.highlightFirstItem=function(){var e=this.$results.find(".select2-results__option[aria-selected]"),t=e.filter("[aria-selected=true]");0<t.length?t.first().trigger("mouseenter"):e.first().trigger("mouseenter"),this.ensureHighlightVisible()},i.prototype.setClasses=function(){var t=this;this.data.current(function(e){var i=h.map(e,function(e){return e.id.toString()});t.$results.find(".select2-results__option[aria-selected]").each(function(){var e=h(this),t=f.GetData(this,"data"),n=""+t.id;null!=t.element&&t.element.selected||null==t.element&&-1<h.inArray(n,i)?e.attr("aria-selected","true"):e.attr("aria-selected","false")})})},i.prototype.showLoading=function(e){this.hideLoading();var t={disabled:!0,loading:!0,text:this.options.get("translations").get("searching")(e)},n=this.option(t);n.className+=" loading-results",this.$results.prepend(n)},i.prototype.hideLoading=function(){this.$results.find(".loading-results").remove()},i.prototype.option=function(e){var t=document.createElement("li");t.className="select2-results__option";var n={role:"option","aria-selected":"false"},i=window.Element.prototype.matches||window.Element.prototype.msMatchesSelector||window.Element.prototype.webkitMatchesSelector;for(var r in(null!=e.element&&i.call(e.element,":disabled")||null==e.element&&e.disabled)&&(delete n["aria-selected"],n["aria-disabled"]="true"),null==e.id&&delete n["aria-selected"],null!=e._resultId&&(t.id=e._resultId),e.title&&(t.title=e.title),e.children&&(n.role="group",n["aria-label"]=e.text,delete n["aria-selected"]),n){var o=n[r];t.setAttribute(r,o)}if(e.children){var s=h(t),a=document.createElement("strong");a.className="select2-results__group";h(a);this.template(e,a);for(var l=[],c=0;c<e.children.length;c++){var u=e.children[c],d=this.option(u);l.push(d)}var p=h("<ul></ul>",{class:"select2-results__options select2-results__options--nested"});p.append(l),s.append(a),s.append(p)}else this.template(e,t);return f.StoreData(t,"data",e),t},i.prototype.bind=function(t,e){var l=this,n=t.id+"-results";this.$results.attr("id",n),t.on("results:all",function(e){l.clear(),l.append(e.data),t.isOpen()&&(l.setClasses(),l.highlightFirstItem())}),t.on("results:append",function(e){l.append(e.data),t.isOpen()&&l.setClasses()}),t.on("query",function(e){l.hideMessages(),l.showLoading(e)}),t.on("select",function(){t.isOpen()&&(l.setClasses(),l.options.get("scrollAfterSelect")&&l.highlightFirstItem())}),t.on("unselect",function(){t.isOpen()&&(l.setClasses(),l.options.get("scrollAfterSelect")&&l.highlightFirstItem())}),t.on("open",function(){l.$results.attr("aria-expanded","true"),l.$results.attr("aria-hidden","false"),l.setClasses(),l.ensureHighlightVisible()}),t.on("close",function(){l.$results.attr("aria-expanded","false"),l.$results.attr("aria-hidden","true"),l.$results.removeAttr("aria-activedescendant")}),t.on("results:toggle",function(){var e=l.getHighlightedResults();0!==e.length&&e.trigger("mouseup")}),t.on("results:select",function(){var e=l.getHighlightedResults();if(0!==e.length){var t=f.GetData(e[0],"data");"true"==e.attr("aria-selected")?l.trigger("close",{}):l.trigger("select",{data:t})}}),t.on("results:previous",function(){var e=l.getHighlightedResults(),t=l.$results.find("[aria-selected]"),n=t.index(e);if(!(n<=0)){var i=n-1;0===e.length&&(i=0);var r=t.eq(i);r.trigger("mouseenter");var o=l.$results.offset().top,s=r.offset().top,a=l.$results.scrollTop()+(s-o);0===i?l.$results.scrollTop(0):s-o<0&&l.$results.scrollTop(a)}}),t.on("results:next",function(){var e=l.getHighlightedResults(),t=l.$results.find("[aria-selected]"),n=t.index(e)+1;if(!(n>=t.length)){var i=t.eq(n);i.trigger("mouseenter");var r=l.$results.offset().top+l.$results.outerHeight(!1),o=i.offset().top+i.outerHeight(!1),s=l.$results.scrollTop()+o-r;0===n?l.$results.scrollTop(0):r<o&&l.$results.scrollTop(s)}}),t.on("results:focus",function(e){e.element.addClass("select2-results__option--highlighted")}),t.on("results:message",function(e){l.displayMessage(e)}),h.fn.mousewheel&&this.$results.on("mousewheel",function(e){var t=l.$results.scrollTop(),n=l.$results.get(0).scrollHeight-t+e.deltaY,i=0<e.deltaY&&t-e.deltaY<=0,r=e.deltaY<0&&n<=l.$results.height();i?(l.$results.scrollTop(0),e.preventDefault(),e.stopPropagation()):r&&(l.$results.scrollTop(l.$results.get(0).scrollHeight-l.$results.height()),e.preventDefault(),e.stopPropagation())}),this.$results.on("mouseup",".select2-results__option[aria-selected]",function(e){var t=h(this),n=f.GetData(this,"data");"true"!==t.attr("aria-selected")?l.trigger("select",{originalEvent:e,data:n}):l.options.get("multiple")?l.trigger("unselect",{originalEvent:e,data:n}):l.trigger("close",{})}),this.$results.on("mouseenter",".select2-results__option[aria-selected]",function(e){var t=f.GetData(this,"data");l.getHighlightedResults().removeClass("select2-results__option--highlighted"),l.trigger("results:focus",{data:t,element:h(this)})})},i.prototype.getHighlightedResults=function(){return this.$results.find(".select2-results__option--highlighted")},i.prototype.destroy=function(){this.$results.remove()},i.prototype.ensureHighlightVisible=function(){var e=this.getHighlightedResults();if(0!==e.length){var t=this.$results.find("[aria-selected]").index(e),n=this.$results.offset().top,i=e.offset().top,r=this.$results.scrollTop()+(i-n),o=i-n;r-=2*e.outerHeight(!1),t<=2?this.$results.scrollTop(0):(o>this.$results.outerHeight()||o<0)&&this.$results.scrollTop(r)}},i.prototype.template=function(e,t){var n=this.options.get("templateResult"),i=this.options.get("escapeMarkup"),r=n(e,t);null==r?t.style.display="none":"string"==typeof r?t.innerHTML=i(r):h(t).append(r)},i}),e.define("select2/keys",[],function(){return{BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46}}),e.define("select2/selection/base",["jquery","../utils","../keys"],function(n,i,r){function o(e,t){this.$element=e,this.options=t,o.__super__.constructor.call(this)}return i.Extend(o,i.Observable),o.prototype.render=function(){var e=n('<span class="select2-selection" role="combobox"  aria-haspopup="true" aria-expanded="false"></span>');return this._tabindex=0,null!=i.GetData(this.$element[0],"old-tabindex")?this._tabindex=i.GetData(this.$element[0],"old-tabindex"):null!=this.$element.attr("tabindex")&&(this._tabindex=this.$element.attr("tabindex")),e.attr("title",this.$element.attr("title")),e.attr("tabindex",this._tabindex),e.attr("aria-disabled","false"),this.$selection=e},o.prototype.bind=function(e,t){var n=this,i=e.id+"-results";this.container=e,this.$selection.on("focus",function(e){n.trigger("focus",e)}),this.$selection.on("blur",function(e){n._handleBlur(e)}),this.$selection.on("keydown",function(e){n.trigger("keypress",e),e.which===r.SPACE&&e.preventDefault()}),e.on("results:focus",function(e){n.$selection.attr("aria-activedescendant",e.data._resultId)}),e.on("selection:update",function(e){n.update(e.data)}),e.on("open",function(){n.$selection.attr("aria-expanded","true"),n.$selection.attr("aria-owns",i),n._attachCloseHandler(e)}),e.on("close",function(){n.$selection.attr("aria-expanded","false"),n.$selection.removeAttr("aria-activedescendant"),n.$selection.removeAttr("aria-owns"),n.$selection.trigger("focus"),n._detachCloseHandler(e)}),e.on("enable",function(){n.$selection.attr("tabindex",n._tabindex),n.$selection.attr("aria-disabled","false")}),e.on("disable",function(){n.$selection.attr("tabindex","-1"),n.$selection.attr("aria-disabled","true")})},o.prototype._handleBlur=function(e){var t=this;window.setTimeout(function(){document.activeElement==t.$selection[0]||n.contains(t.$selection[0],document.activeElement)||t.trigger("blur",e)},1)},o.prototype._attachCloseHandler=function(e){n(document.body).on("mousedown.select2."+e.id,function(e){var t=n(e.target).closest(".select2");n(".select2.select2-container--open").each(function(){this!=t[0]&&i.GetData(this,"element").select2("close")})})},o.prototype._detachCloseHandler=function(e){n(document.body).off("mousedown.select2."+e.id)},o.prototype.position=function(e,t){t.find(".selection").append(e)},o.prototype.destroy=function(){this._detachCloseHandler(this.container)},o.prototype.update=function(e){throw new Error("The `update` method must be defined in child classes.")},o.prototype.isEnabled=function(){return!this.isDisabled()},o.prototype.isDisabled=function(){return this.options.get("disabled")},o}),e.define("select2/selection/single",["jquery","./base","../utils","../keys"],function(e,t,n,i){function r(){r.__super__.constructor.apply(this,arguments)}return n.Extend(r,t),r.prototype.render=function(){var e=r.__super__.render.call(this);return e.addClass("select2-selection--single"),e.html('<span class="select2-selection__rendered"></span><span class="select2-selection__arrow" role="presentation"><b role="presentation"></b></span>'),e},r.prototype.bind=function(t,e){var n=this;r.__super__.bind.apply(this,arguments);var i=t.id+"-container";this.$selection.find(".select2-selection__rendered").attr("id",i).attr("role","textbox").attr("aria-readonly","true"),this.$selection.attr("aria-labelledby",i),this.$selection.on("mousedown",function(e){1===e.which&&n.trigger("toggle",{originalEvent:e})}),this.$selection.on("focus",function(e){}),this.$selection.on("blur",function(e){}),t.on("focus",function(e){t.isOpen()||n.$selection.trigger("focus")})},r.prototype.clear=function(){var e=this.$selection.find(".select2-selection__rendered");e.empty(),e.removeAttr("title")},r.prototype.display=function(e,t){var n=this.options.get("templateSelection");return this.options.get("escapeMarkup")(n(e,t))},r.prototype.selectionContainer=function(){return e("<span></span>")},r.prototype.update=function(e){if(0!==e.length){var t=e[0],n=this.$selection.find(".select2-selection__rendered"),i=this.display(t,n);n.empty().append(i);var r=t.title||t.text;r?n.attr("title",r):n.removeAttr("title")}else this.clear()},r}),e.define("select2/selection/multiple",["jquery","./base","../utils"],function(r,e,l){function n(e,t){n.__super__.constructor.apply(this,arguments)}return l.Extend(n,e),n.prototype.render=function(){var e=n.__super__.render.call(this);return e.addClass("select2-selection--multiple"),e.html('<ul class="select2-selection__rendered"></ul>'),e},n.prototype.bind=function(e,t){var i=this;n.__super__.bind.apply(this,arguments),this.$selection.on("click",function(e){i.trigger("toggle",{originalEvent:e})}),this.$selection.on("click",".select2-selection__choice__remove",function(e){if(!i.isDisabled()){var t=r(this).parent(),n=l.GetData(t[0],"data");i.trigger("unselect",{originalEvent:e,data:n})}})},n.prototype.clear=function(){var e=this.$selection.find(".select2-selection__rendered");e.empty(),e.removeAttr("title")},n.prototype.display=function(e,t){var n=this.options.get("templateSelection");return this.options.get("escapeMarkup")(n(e,t))},n.prototype.selectionContainer=function(){return r('<li class="select2-selection__choice"><span class="select2-selection__choice__remove" role="presentation">&times;</span></li>')},n.prototype.update=function(e){if(this.clear(),0!==e.length){for(var t=[],n=0;n<e.length;n++){var i=e[n],r=this.selectionContainer(),o=this.display(i,r);r.append(o);var s=i.title||i.text;s&&r.attr("title",s),l.StoreData(r[0],"data",i),t.push(r)}var a=this.$selection.find(".select2-selection__rendered");l.appendMany(a,t)}},n}),e.define("select2/selection/placeholder",["../utils"],function(e){function t(e,t,n){this.placeholder=this.normalizePlaceholder(n.get("placeholder")),e.call(this,t,n)}return t.prototype.normalizePlaceholder=function(e,t){return"string"==typeof t&&(t={id:"",text:t}),t},t.prototype.createPlaceholder=function(e,t){var n=this.selectionContainer();return n.html(this.display(t)),n.addClass("select2-selection__placeholder").removeClass("select2-selection__choice"),n},t.prototype.update=function(e,t){var n=1==t.length&&t[0].id!=this.placeholder.id;if(1<t.length||n)return e.call(this,t);this.clear();var i=this.createPlaceholder(this.placeholder);this.$selection.find(".select2-selection__rendered").append(i)},t}),e.define("select2/selection/allowClear",["jquery","../keys","../utils"],function(r,i,a){function e(){}return e.prototype.bind=function(e,t,n){var i=this;e.call(this,t,n),null==this.placeholder&&this.options.get("debug")&&window.console&&console.error&&console.error("Select2: The `allowClear` option should be used in combination with the `placeholder` option."),this.$selection.on("mousedown",".select2-selection__clear",function(e){i._handleClear(e)}),t.on("keypress",function(e){i._handleKeyboardClear(e,t)})},e.prototype._handleClear=function(e,t){if(!this.isDisabled()){var n=this.$selection.find(".select2-selection__clear");if(0!==n.length){t.stopPropagation();var i=a.GetData(n[0],"data"),r=this.$element.val();this.$element.val(this.placeholder.id);var o={data:i};if(this.trigger("clear",o),o.prevented)this.$element.val(r);else{for(var s=0;s<i.length;s++)if(o={data:i[s]},this.trigger("unselect",o),o.prevented)return void this.$element.val(r);this.$element.trigger("input").trigger("change"),this.trigger("toggle",{})}}}},e.prototype._handleKeyboardClear=function(e,t,n){n.isOpen()||t.which!=i.DELETE&&t.which!=i.BACKSPACE||this._handleClear(t)},e.prototype.update=function(e,t){if(e.call(this,t),!(0<this.$selection.find(".select2-selection__placeholder").length||0===t.length)){var n=this.options.get("translations").get("removeAllItems"),i=r('<span class="select2-selection__clear" title="'+n()+'">&times;</span>');a.StoreData(i[0],"data",t),this.$selection.find(".select2-selection__rendered").prepend(i)}},e}),e.define("select2/selection/search",["jquery","../utils","../keys"],function(i,a,l){function e(e,t,n){e.call(this,t,n)}return e.prototype.render=function(e){var t=i('<li class="select2-search select2-search--inline"><input class="select2-search__field" type="search" tabindex="-1" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" role="searchbox" aria-autocomplete="list" /></li>');this.$searchContainer=t,this.$search=t.find("input");var n=e.call(this);return this._transferTabIndex(),n},e.prototype.bind=function(e,t,n){var i=this,r=t.id+"-results";e.call(this,t,n),t.on("open",function(){i.$search.attr("aria-controls",r),i.$search.trigger("focus")}),t.on("close",function(){i.$search.val(""),i.$search.removeAttr("aria-controls"),i.$search.removeAttr("aria-activedescendant"),i.$search.trigger("focus")}),t.on("enable",function(){i.$search.prop("disabled",!1),i._transferTabIndex()}),t.on("disable",function(){i.$search.prop("disabled",!0)}),t.on("focus",function(e){i.$search.trigger("focus")}),t.on("results:focus",function(e){e.data._resultId?i.$search.attr("aria-activedescendant",e.data._resultId):i.$search.removeAttr("aria-activedescendant")}),this.$selection.on("focusin",".select2-search--inline",function(e){i.trigger("focus",e)}),this.$selection.on("focusout",".select2-search--inline",function(e){i._handleBlur(e)}),this.$selection.on("keydown",".select2-search--inline",function(e){if(e.stopPropagation(),i.trigger("keypress",e),i._keyUpPrevented=e.isDefaultPrevented(),e.which===l.BACKSPACE&&""===i.$search.val()){var t=i.$searchContainer.prev(".select2-selection__choice");if(0<t.length){var n=a.GetData(t[0],"data");i.searchRemoveChoice(n),e.preventDefault()}}}),this.$selection.on("click",".select2-search--inline",function(e){i.$search.val()&&e.stopPropagation()});var o=document.documentMode,s=o&&o<=11;this.$selection.on("input.searchcheck",".select2-search--inline",function(e){s?i.$selection.off("input.search input.searchcheck"):i.$selection.off("keyup.search")}),this.$selection.on("keyup.search input.search",".select2-search--inline",function(e){if(s&&"input"===e.type)i.$selection.off("input.search input.searchcheck");else{var t=e.which;t!=l.SHIFT&&t!=l.CTRL&&t!=l.ALT&&t!=l.TAB&&i.handleSearch(e)}})},e.prototype._transferTabIndex=function(e){this.$search.attr("tabindex",this.$selection.attr("tabindex")),this.$selection.attr("tabindex","-1")},e.prototype.createPlaceholder=function(e,t){this.$search.attr("placeholder",t.text)},e.prototype.update=function(e,t){var n=this.$search[0]==document.activeElement;this.$search.attr("placeholder",""),e.call(this,t),this.$selection.find(".select2-selection__rendered").append(this.$searchContainer),this.resizeSearch(),n&&this.$search.trigger("focus")},e.prototype.handleSearch=function(){if(this.resizeSearch(),!this._keyUpPrevented){var e=this.$search.val();this.trigger("query",{term:e})}this._keyUpPrevented=!1},e.prototype.searchRemoveChoice=function(e,t){this.trigger("unselect",{data:t}),this.$search.val(t.text),this.handleSearch()},e.prototype.resizeSearch=function(){this.$search.css("width","25px");var e="";""!==this.$search.attr("placeholder")?e=this.$selection.find(".select2-selection__rendered").width():e=.75*(this.$search.val().length+1)+"em";this.$search.css("width",e)},e}),e.define("select2/selection/eventRelay",["jquery"],function(s){function e(){}return e.prototype.bind=function(e,t,n){var i=this,r=["open","opening","close","closing","select","selecting","unselect","unselecting","clear","clearing"],o=["opening","closing","selecting","unselecting","clearing"];e.call(this,t,n),t.on("*",function(e,t){if(-1!==s.inArray(e,r)){t=t||{};var n=s.Event("select2:"+e,{params:t});i.$element.trigger(n),-1!==s.inArray(e,o)&&(t.prevented=n.isDefaultPrevented())}})},e}),e.define("select2/translation",["jquery","require"],function(t,n){function i(e){this.dict=e||{}}return i.prototype.all=function(){return this.dict},i.prototype.get=function(e){return this.dict[e]},i.prototype.extend=function(e){this.dict=t.extend({},e.all(),this.dict)},i._cache={},i.loadPath=function(e){if(!(e in i._cache)){var t=n(e);i._cache[e]=t}return new i(i._cache[e])},i}),e.define("select2/diacritics",[],function(){return{"Ⓐ":"A","Ａ":"A","À":"A","Á":"A","Â":"A","Ầ":"A","Ấ":"A","Ẫ":"A","Ẩ":"A","Ã":"A","Ā":"A","Ă":"A","Ằ":"A","Ắ":"A","Ẵ":"A","Ẳ":"A","Ȧ":"A","Ǡ":"A","Ä":"A","Ǟ":"A","Ả":"A","Å":"A","Ǻ":"A","Ǎ":"A","Ȁ":"A","Ȃ":"A","Ạ":"A","Ậ":"A","Ặ":"A","Ḁ":"A","Ą":"A","Ⱥ":"A","Ɐ":"A","Ꜳ":"AA","Æ":"AE","Ǽ":"AE","Ǣ":"AE","Ꜵ":"AO","Ꜷ":"AU","Ꜹ":"AV","Ꜻ":"AV","Ꜽ":"AY","Ⓑ":"B","Ｂ":"B","Ḃ":"B","Ḅ":"B","Ḇ":"B","Ƀ":"B","Ƃ":"B","Ɓ":"B","Ⓒ":"C","Ｃ":"C","Ć":"C","Ĉ":"C","Ċ":"C","Č":"C","Ç":"C","Ḉ":"C","Ƈ":"C","Ȼ":"C","Ꜿ":"C","Ⓓ":"D","Ｄ":"D","Ḋ":"D","Ď":"D","Ḍ":"D","Ḑ":"D","Ḓ":"D","Ḏ":"D","Đ":"D","Ƌ":"D","Ɗ":"D","Ɖ":"D","Ꝺ":"D","Ǳ":"DZ","Ǆ":"DZ","ǲ":"Dz","ǅ":"Dz","Ⓔ":"E","Ｅ":"E","È":"E","É":"E","Ê":"E","Ề":"E","Ế":"E","Ễ":"E","Ể":"E","Ẽ":"E","Ē":"E","Ḕ":"E","Ḗ":"E","Ĕ":"E","Ė":"E","Ë":"E","Ẻ":"E","Ě":"E","Ȅ":"E","Ȇ":"E","Ẹ":"E","Ệ":"E","Ȩ":"E","Ḝ":"E","Ę":"E","Ḙ":"E","Ḛ":"E","Ɛ":"E","Ǝ":"E","Ⓕ":"F","Ｆ":"F","Ḟ":"F","Ƒ":"F","Ꝼ":"F","Ⓖ":"G","Ｇ":"G","Ǵ":"G","Ĝ":"G","Ḡ":"G","Ğ":"G","Ġ":"G","Ǧ":"G","Ģ":"G","Ǥ":"G","Ɠ":"G","Ꞡ":"G","Ᵹ":"G","Ꝿ":"G","Ⓗ":"H","Ｈ":"H","Ĥ":"H","Ḣ":"H","Ḧ":"H","Ȟ":"H","Ḥ":"H","Ḩ":"H","Ḫ":"H","Ħ":"H","Ⱨ":"H","Ⱶ":"H","Ɥ":"H","Ⓘ":"I","Ｉ":"I","Ì":"I","Í":"I","Î":"I","Ĩ":"I","Ī":"I","Ĭ":"I","İ":"I","Ï":"I","Ḯ":"I","Ỉ":"I","Ǐ":"I","Ȉ":"I","Ȋ":"I","Ị":"I","Į":"I","Ḭ":"I","Ɨ":"I","Ⓙ":"J","Ｊ":"J","Ĵ":"J","Ɉ":"J","Ⓚ":"K","Ｋ":"K","Ḱ":"K","Ǩ":"K","Ḳ":"K","Ķ":"K","Ḵ":"K","Ƙ":"K","Ⱪ":"K","Ꝁ":"K","Ꝃ":"K","Ꝅ":"K","Ꞣ":"K","Ⓛ":"L","Ｌ":"L","Ŀ":"L","Ĺ":"L","Ľ":"L","Ḷ":"L","Ḹ":"L","Ļ":"L","Ḽ":"L","Ḻ":"L","Ł":"L","Ƚ":"L","Ɫ":"L","Ⱡ":"L","Ꝉ":"L","Ꝇ":"L","Ꞁ":"L","Ǉ":"LJ","ǈ":"Lj","Ⓜ":"M","Ｍ":"M","Ḿ":"M","Ṁ":"M","Ṃ":"M","Ɱ":"M","Ɯ":"M","Ⓝ":"N","Ｎ":"N","Ǹ":"N","Ń":"N","Ñ":"N","Ṅ":"N","Ň":"N","Ṇ":"N","Ņ":"N","Ṋ":"N","Ṉ":"N","Ƞ":"N","Ɲ":"N","Ꞑ":"N","Ꞥ":"N","Ǌ":"NJ","ǋ":"Nj","Ⓞ":"O","Ｏ":"O","Ò":"O","Ó":"O","Ô":"O","Ồ":"O","Ố":"O","Ỗ":"O","Ổ":"O","Õ":"O","Ṍ":"O","Ȭ":"O","Ṏ":"O","Ō":"O","Ṑ":"O","Ṓ":"O","Ŏ":"O","Ȯ":"O","Ȱ":"O","Ö":"O","Ȫ":"O","Ỏ":"O","Ő":"O","Ǒ":"O","Ȍ":"O","Ȏ":"O","Ơ":"O","Ờ":"O","Ớ":"O","Ỡ":"O","Ở":"O","Ợ":"O","Ọ":"O","Ộ":"O","Ǫ":"O","Ǭ":"O","Ø":"O","Ǿ":"O","Ɔ":"O","Ɵ":"O","Ꝋ":"O","Ꝍ":"O","Œ":"OE","Ƣ":"OI","Ꝏ":"OO","Ȣ":"OU","Ⓟ":"P","Ｐ":"P","Ṕ":"P","Ṗ":"P","Ƥ":"P","Ᵽ":"P","Ꝑ":"P","Ꝓ":"P","Ꝕ":"P","Ⓠ":"Q","Ｑ":"Q","Ꝗ":"Q","Ꝙ":"Q","Ɋ":"Q","Ⓡ":"R","Ｒ":"R","Ŕ":"R","Ṙ":"R","Ř":"R","Ȑ":"R","Ȓ":"R","Ṛ":"R","Ṝ":"R","Ŗ":"R","Ṟ":"R","Ɍ":"R","Ɽ":"R","Ꝛ":"R","Ꞧ":"R","Ꞃ":"R","Ⓢ":"S","Ｓ":"S","ẞ":"S","Ś":"S","Ṥ":"S","Ŝ":"S","Ṡ":"S","Š":"S","Ṧ":"S","Ṣ":"S","Ṩ":"S","Ș":"S","Ş":"S","Ȿ":"S","Ꞩ":"S","Ꞅ":"S","Ⓣ":"T","Ｔ":"T","Ṫ":"T","Ť":"T","Ṭ":"T","Ț":"T","Ţ":"T","Ṱ":"T","Ṯ":"T","Ŧ":"T","Ƭ":"T","Ʈ":"T","Ⱦ":"T","Ꞇ":"T","Ꜩ":"TZ","Ⓤ":"U","Ｕ":"U","Ù":"U","Ú":"U","Û":"U","Ũ":"U","Ṹ":"U","Ū":"U","Ṻ":"U","Ŭ":"U","Ü":"U","Ǜ":"U","Ǘ":"U","Ǖ":"U","Ǚ":"U","Ủ":"U","Ů":"U","Ű":"U","Ǔ":"U","Ȕ":"U","Ȗ":"U","Ư":"U","Ừ":"U","Ứ":"U","Ữ":"U","Ử":"U","Ự":"U","Ụ":"U","Ṳ":"U","Ų":"U","Ṷ":"U","Ṵ":"U","Ʉ":"U","Ⓥ":"V","Ｖ":"V","Ṽ":"V","Ṿ":"V","Ʋ":"V","Ꝟ":"V","Ʌ":"V","Ꝡ":"VY","Ⓦ":"W","Ｗ":"W","Ẁ":"W","Ẃ":"W","Ŵ":"W","Ẇ":"W","Ẅ":"W","Ẉ":"W","Ⱳ":"W","Ⓧ":"X","Ｘ":"X","Ẋ":"X","Ẍ":"X","Ⓨ":"Y","Ｙ":"Y","Ỳ":"Y","Ý":"Y","Ŷ":"Y","Ỹ":"Y","Ȳ":"Y","Ẏ":"Y","Ÿ":"Y","Ỷ":"Y","Ỵ":"Y","Ƴ":"Y","Ɏ":"Y","Ỿ":"Y","Ⓩ":"Z","Ｚ":"Z","Ź":"Z","Ẑ":"Z","Ż":"Z","Ž":"Z","Ẓ":"Z","Ẕ":"Z","Ƶ":"Z","Ȥ":"Z","Ɀ":"Z","Ⱬ":"Z","Ꝣ":"Z","ⓐ":"a","ａ":"a","ẚ":"a","à":"a","á":"a","â":"a","ầ":"a","ấ":"a","ẫ":"a","ẩ":"a","ã":"a","ā":"a","ă":"a","ằ":"a","ắ":"a","ẵ":"a","ẳ":"a","ȧ":"a","ǡ":"a","ä":"a","ǟ":"a","ả":"a","å":"a","ǻ":"a","ǎ":"a","ȁ":"a","ȃ":"a","ạ":"a","ậ":"a","ặ":"a","ḁ":"a","ą":"a","ⱥ":"a","ɐ":"a","ꜳ":"aa","æ":"ae","ǽ":"ae","ǣ":"ae","ꜵ":"ao","ꜷ":"au","ꜹ":"av","ꜻ":"av","ꜽ":"ay","ⓑ":"b","ｂ":"b","ḃ":"b","ḅ":"b","ḇ":"b","ƀ":"b","ƃ":"b","ɓ":"b","ⓒ":"c","ｃ":"c","ć":"c","ĉ":"c","ċ":"c","č":"c","ç":"c","ḉ":"c","ƈ":"c","ȼ":"c","ꜿ":"c","ↄ":"c","ⓓ":"d","ｄ":"d","ḋ":"d","ď":"d","ḍ":"d","ḑ":"d","ḓ":"d","ḏ":"d","đ":"d","ƌ":"d","ɖ":"d","ɗ":"d","ꝺ":"d","ǳ":"dz","ǆ":"dz","ⓔ":"e","ｅ":"e","è":"e","é":"e","ê":"e","ề":"e","ế":"e","ễ":"e","ể":"e","ẽ":"e","ē":"e","ḕ":"e","ḗ":"e","ĕ":"e","ė":"e","ë":"e","ẻ":"e","ě":"e","ȅ":"e","ȇ":"e","ẹ":"e","ệ":"e","ȩ":"e","ḝ":"e","ę":"e","ḙ":"e","ḛ":"e","ɇ":"e","ɛ":"e","ǝ":"e","ⓕ":"f","ｆ":"f","ḟ":"f","ƒ":"f","ꝼ":"f","ⓖ":"g","ｇ":"g","ǵ":"g","ĝ":"g","ḡ":"g","ğ":"g","ġ":"g","ǧ":"g","ģ":"g","ǥ":"g","ɠ":"g","ꞡ":"g","ᵹ":"g","ꝿ":"g","ⓗ":"h","ｈ":"h","ĥ":"h","ḣ":"h","ḧ":"h","ȟ":"h","ḥ":"h","ḩ":"h","ḫ":"h","ẖ":"h","ħ":"h","ⱨ":"h","ⱶ":"h","ɥ":"h","ƕ":"hv","ⓘ":"i","ｉ":"i","ì":"i","í":"i","î":"i","ĩ":"i","ī":"i","ĭ":"i","ï":"i","ḯ":"i","ỉ":"i","ǐ":"i","ȉ":"i","ȋ":"i","ị":"i","į":"i","ḭ":"i","ɨ":"i","ı":"i","ⓙ":"j","ｊ":"j","ĵ":"j","ǰ":"j","ɉ":"j","ⓚ":"k","ｋ":"k","ḱ":"k","ǩ":"k","ḳ":"k","ķ":"k","ḵ":"k","ƙ":"k","ⱪ":"k","ꝁ":"k","ꝃ":"k","ꝅ":"k","ꞣ":"k","ⓛ":"l","ｌ":"l","ŀ":"l","ĺ":"l","ľ":"l","ḷ":"l","ḹ":"l","ļ":"l","ḽ":"l","ḻ":"l","ſ":"l","ł":"l","ƚ":"l","ɫ":"l","ⱡ":"l","ꝉ":"l","ꞁ":"l","ꝇ":"l","ǉ":"lj","ⓜ":"m","ｍ":"m","ḿ":"m","ṁ":"m","ṃ":"m","ɱ":"m","ɯ":"m","ⓝ":"n","ｎ":"n","ǹ":"n","ń":"n","ñ":"n","ṅ":"n","ň":"n","ṇ":"n","ņ":"n","ṋ":"n","ṉ":"n","ƞ":"n","ɲ":"n","ŉ":"n","ꞑ":"n","ꞥ":"n","ǌ":"nj","ⓞ":"o","ｏ":"o","ò":"o","ó":"o","ô":"o","ồ":"o","ố":"o","ỗ":"o","ổ":"o","õ":"o","ṍ":"o","ȭ":"o","ṏ":"o","ō":"o","ṑ":"o","ṓ":"o","ŏ":"o","ȯ":"o","ȱ":"o","ö":"o","ȫ":"o","ỏ":"o","ő":"o","ǒ":"o","ȍ":"o","ȏ":"o","ơ":"o","ờ":"o","ớ":"o","ỡ":"o","ở":"o","ợ":"o","ọ":"o","ộ":"o","ǫ":"o","ǭ":"o","ø":"o","ǿ":"o","ɔ":"o","ꝋ":"o","ꝍ":"o","ɵ":"o","œ":"oe","ƣ":"oi","ȣ":"ou","ꝏ":"oo","ⓟ":"p","ｐ":"p","ṕ":"p","ṗ":"p","ƥ":"p","ᵽ":"p","ꝑ":"p","ꝓ":"p","ꝕ":"p","ⓠ":"q","ｑ":"q","ɋ":"q","ꝗ":"q","ꝙ":"q","ⓡ":"r","ｒ":"r","ŕ":"r","ṙ":"r","ř":"r","ȑ":"r","ȓ":"r","ṛ":"r","ṝ":"r","ŗ":"r","ṟ":"r","ɍ":"r","ɽ":"r","ꝛ":"r","ꞧ":"r","ꞃ":"r","ⓢ":"s","ｓ":"s","ß":"s","ś":"s","ṥ":"s","ŝ":"s","ṡ":"s","š":"s","ṧ":"s","ṣ":"s","ṩ":"s","ș":"s","ş":"s","ȿ":"s","ꞩ":"s","ꞅ":"s","ẛ":"s","ⓣ":"t","ｔ":"t","ṫ":"t","ẗ":"t","ť":"t","ṭ":"t","ț":"t","ţ":"t","ṱ":"t","ṯ":"t","ŧ":"t","ƭ":"t","ʈ":"t","ⱦ":"t","ꞇ":"t","ꜩ":"tz","ⓤ":"u","ｕ":"u","ù":"u","ú":"u","û":"u","ũ":"u","ṹ":"u","ū":"u","ṻ":"u","ŭ":"u","ü":"u","ǜ":"u","ǘ":"u","ǖ":"u","ǚ":"u","ủ":"u","ů":"u","ű":"u","ǔ":"u","ȕ":"u","ȗ":"u","ư":"u","ừ":"u","ứ":"u","ữ":"u","ử":"u","ự":"u","ụ":"u","ṳ":"u","ų":"u","ṷ":"u","ṵ":"u","ʉ":"u","ⓥ":"v","ｖ":"v","ṽ":"v","ṿ":"v","ʋ":"v","ꝟ":"v","ʌ":"v","ꝡ":"vy","ⓦ":"w","ｗ":"w","ẁ":"w","ẃ":"w","ŵ":"w","ẇ":"w","ẅ":"w","ẘ":"w","ẉ":"w","ⱳ":"w","ⓧ":"x","ｘ":"x","ẋ":"x","ẍ":"x","ⓨ":"y","ｙ":"y","ỳ":"y","ý":"y","ŷ":"y","ỹ":"y","ȳ":"y","ẏ":"y","ÿ":"y","ỷ":"y","ẙ":"y","ỵ":"y","ƴ":"y","ɏ":"y","ỿ":"y","ⓩ":"z","ｚ":"z","ź":"z","ẑ":"z","ż":"z","ž":"z","ẓ":"z","ẕ":"z","ƶ":"z","ȥ":"z","ɀ":"z","ⱬ":"z","ꝣ":"z","Ά":"Α","Έ":"Ε","Ή":"Η","Ί":"Ι","Ϊ":"Ι","Ό":"Ο","Ύ":"Υ","Ϋ":"Υ","Ώ":"Ω","ά":"α","έ":"ε","ή":"η","ί":"ι","ϊ":"ι","ΐ":"ι","ό":"ο","ύ":"υ","ϋ":"υ","ΰ":"υ","ώ":"ω","ς":"σ","’":"'"}}),e.define("select2/data/base",["../utils"],function(i){function n(e,t){n.__super__.constructor.call(this)}return i.Extend(n,i.Observable),n.prototype.current=function(e){throw new Error("The `current` method must be defined in child classes.")},n.prototype.query=function(e,t){throw new Error("The `query` method must be defined in child classes.")},n.prototype.bind=function(e,t){},n.prototype.destroy=function(){},n.prototype.generateResultId=function(e,t){var n=e.id+"-result-";return n+=i.generateChars(4),null!=t.id?n+="-"+t.id.toString():n+="-"+i.generateChars(4),n},n}),e.define("select2/data/select",["./base","../utils","jquery"],function(e,a,l){function n(e,t){this.$element=e,this.options=t,n.__super__.constructor.call(this)}return a.Extend(n,e),n.prototype.current=function(e){var n=[],i=this;this.$element.find(":selected").each(function(){var e=l(this),t=i.item(e);n.push(t)}),e(n)},n.prototype.select=function(r){var o=this;if(r.selected=!0,l(r.element).is("option"))return r.element.selected=!0,void this.$element.trigger("input").trigger("change");if(this.$element.prop("multiple"))this.current(function(e){var t=[];(r=[r]).push.apply(r,e);for(var n=0;n<r.length;n++){var i=r[n].id;-1===l.inArray(i,t)&&t.push(i)}o.$element.val(t),o.$element.trigger("input").trigger("change")});else{var e=r.id;this.$element.val(e),this.$element.trigger("input").trigger("change")}},n.prototype.unselect=function(r){var o=this;if(this.$element.prop("multiple")){if(r.selected=!1,l(r.element).is("option"))return r.element.selected=!1,void this.$element.trigger("input").trigger("change");this.current(function(e){for(var t=[],n=0;n<e.length;n++){var i=e[n].id;i!==r.id&&-1===l.inArray(i,t)&&t.push(i)}o.$element.val(t),o.$element.trigger("input").trigger("change")})}},n.prototype.bind=function(e,t){var n=this;(this.container=e).on("select",function(e){n.select(e.data)}),e.on("unselect",function(e){n.unselect(e.data)})},n.prototype.destroy=function(){this.$element.find("*").each(function(){a.RemoveData(this)})},n.prototype.query=function(i,e){var r=[],o=this;this.$element.children().each(function(){var e=l(this);if(e.is("option")||e.is("optgroup")){var t=o.item(e),n=o.matches(i,t);null!==n&&r.push(n)}}),e({results:r})},n.prototype.addOptions=function(e){a.appendMany(this.$element,e)},n.prototype.option=function(e){var t;e.children?(t=document.createElement("optgroup")).label=e.text:void 0!==(t=document.createElement("option")).textContent?t.textContent=e.text:t.innerText=e.text,void 0!==e.id&&(t.value=e.id),e.disabled&&(t.disabled=!0),e.selected&&(t.selected=!0),e.title&&(t.title=e.title);var n=l(t),i=this._normalizeItem(e);return i.element=t,a.StoreData(t,"data",i),n},n.prototype.item=function(e){var t={};if(null!=(t=a.GetData(e[0],"data")))return t;if(e.is("option"))t={id:e.val(),text:e.text(),disabled:e.prop("disabled"),selected:e.prop("selected"),title:e.prop("title")};else if(e.is("optgroup")){t={text:e.prop("label"),children:[],title:e.prop("title")};for(var n=e.children("option"),i=[],r=0;r<n.length;r++){var o=l(n[r]),s=this.item(o);i.push(s)}t.children=i}return(t=this._normalizeItem(t)).element=e[0],a.StoreData(e[0],"data",t),t},n.prototype._normalizeItem=function(e){e!==Object(e)&&(e={id:e,text:e});return null!=(e=l.extend({},{text:""},e)).id&&(e.id=e.id.toString()),null!=e.text&&(e.text=e.text.toString()),null==e._resultId&&e.id&&null!=this.container&&(e._resultId=this.generateResultId(this.container,e)),l.extend({},{selected:!1,disabled:!1},e)},n.prototype.matches=function(e,t){return this.options.get("matcher")(e,t)},n}),e.define("select2/data/array",["./select","../utils","jquery"],function(e,f,g){function i(e,t){this._dataToConvert=t.get("data")||[],i.__super__.constructor.call(this,e,t)}return f.Extend(i,e),i.prototype.bind=function(e,t){i.__super__.bind.call(this,e,t),this.addOptions(this.convertToOptions(this._dataToConvert))},i.prototype.select=function(n){var e=this.$element.find("option").filter(function(e,t){return t.value==n.id.toString()});0===e.length&&(e=this.option(n),this.addOptions(e)),i.__super__.select.call(this,n)},i.prototype.convertToOptions=function(e){var t=this,n=this.$element.find("option"),i=n.map(function(){return t.item(g(this)).id}).get(),r=[];function o(e){return function(){return g(this).val()==e.id}}for(var s=0;s<e.length;s++){var a=this._normalizeItem(e[s]);if(0<=g.inArray(a.id,i)){var l=n.filter(o(a)),c=this.item(l),u=g.extend(!0,{},a,c),d=this.option(u);l.replaceWith(d)}else{var p=this.option(a);if(a.children){var h=this.convertToOptions(a.children);f.appendMany(p,h)}r.push(p)}}return r},i}),e.define("select2/data/ajax",["./array","../utils","jquery"],function(e,t,o){function n(e,t){this.ajaxOptions=this._applyDefaults(t.get("ajax")),null!=this.ajaxOptions.processResults&&(this.processResults=this.ajaxOptions.processResults),n.__super__.constructor.call(this,e,t)}return t.Extend(n,e),n.prototype._applyDefaults=function(e){var t={data:function(e){return o.extend({},e,{q:e.term})},transport:function(e,t,n){var i=o.ajax(e);return i.then(t),i.fail(n),i}};return o.extend({},t,e,!0)},n.prototype.processResults=function(e){return e},n.prototype.query=function(n,i){var r=this;null!=this._request&&(o.isFunction(this._request.abort)&&this._request.abort(),this._request=null);var t=o.extend({type:"GET"},this.ajaxOptions);function e(){var e=t.transport(t,function(e){var t=r.processResults(e,n);r.options.get("debug")&&window.console&&console.error&&(t&&t.results&&o.isArray(t.results)||console.error("Select2: The AJAX results did not return an array in the `results` key of the response.")),i(t)},function(){"status"in e&&(0===e.status||"0"===e.status)||r.trigger("results:message",{message:"errorLoading"})});r._request=e}"function"==typeof t.url&&(t.url=t.url.call(this.$element,n)),"function"==typeof t.data&&(t.data=t.data.call(this.$element,n)),this.ajaxOptions.delay&&null!=n.term?(this._queryTimeout&&window.clearTimeout(this._queryTimeout),this._queryTimeout=window.setTimeout(e,this.ajaxOptions.delay)):e()},n}),e.define("select2/data/tags",["jquery"],function(u){function e(e,t,n){var i=n.get("tags"),r=n.get("createTag");void 0!==r&&(this.createTag=r);var o=n.get("insertTag");if(void 0!==o&&(this.insertTag=o),e.call(this,t,n),u.isArray(i))for(var s=0;s<i.length;s++){var a=i[s],l=this._normalizeItem(a),c=this.option(l);this.$element.append(c)}}return e.prototype.query=function(e,c,u){var d=this;this._removeOldTags(),null!=c.term&&null==c.page?e.call(this,c,function e(t,n){for(var i=t.results,r=0;r<i.length;r++){var o=i[r],s=null!=o.children&&!e({results:o.children},!0);if((o.text||"").toUpperCase()===(c.term||"").toUpperCase()||s)return!n&&(t.data=i,void u(t))}if(n)return!0;var a=d.createTag(c);if(null!=a){var l=d.option(a);l.attr("data-select2-tag",!0),d.addOptions([l]),d.insertTag(i,a)}t.results=i,u(t)}):e.call(this,c,u)},e.prototype.createTag=function(e,t){var n=u.trim(t.term);return""===n?null:{id:n,text:n}},e.prototype.insertTag=function(e,t,n){t.unshift(n)},e.prototype._removeOldTags=function(e){this.$element.find("option[data-select2-tag]").each(function(){this.selected||u(this).remove()})},e}),e.define("select2/data/tokenizer",["jquery"],function(d){function e(e,t,n){var i=n.get("tokenizer");void 0!==i&&(this.tokenizer=i),e.call(this,t,n)}return e.prototype.bind=function(e,t,n){e.call(this,t,n),this.$search=t.dropdown.$search||t.selection.$search||n.find(".select2-search__field")},e.prototype.query=function(e,t,n){var i=this;t.term=t.term||"";var r=this.tokenizer(t,this.options,function(e){var t=i._normalizeItem(e);if(!i.$element.find("option").filter(function(){return d(this).val()===t.id}).length){var n=i.option(t);n.attr("data-select2-tag",!0),i._removeOldTags(),i.addOptions([n])}!function(e){i.trigger("select",{data:e})}(t)});r.term!==t.term&&(this.$search.length&&(this.$search.val(r.term),this.$search.trigger("focus")),t.term=r.term),e.call(this,t,n)},e.prototype.tokenizer=function(e,t,n,i){for(var r=n.get("tokenSeparators")||[],o=t.term,s=0,a=this.createTag||function(e){return{id:e.term,text:e.term}};s<o.length;){var l=o[s];if(-1!==d.inArray(l,r)){var c=o.substr(0,s),u=a(d.extend({},t,{term:c}));null!=u?(i(u),o=o.substr(s+1)||"",s=0):s++}else s++}return{term:o}},e}),e.define("select2/data/minimumInputLength",[],function(){function e(e,t,n){this.minimumInputLength=n.get("minimumInputLength"),e.call(this,t,n)}return e.prototype.query=function(e,t,n){t.term=t.term||"",t.term.length<this.minimumInputLength?this.trigger("results:message",{message:"inputTooShort",args:{minimum:this.minimumInputLength,input:t.term,params:t}}):e.call(this,t,n)},e}),e.define("select2/data/maximumInputLength",[],function(){function e(e,t,n){this.maximumInputLength=n.get("maximumInputLength"),e.call(this,t,n)}return e.prototype.query=function(e,t,n){t.term=t.term||"",0<this.maximumInputLength&&t.term.length>this.maximumInputLength?this.trigger("results:message",{message:"inputTooLong",args:{maximum:this.maximumInputLength,input:t.term,params:t}}):e.call(this,t,n)},e}),e.define("select2/data/maximumSelectionLength",[],function(){function e(e,t,n){this.maximumSelectionLength=n.get("maximumSelectionLength"),e.call(this,t,n)}return e.prototype.bind=function(e,t,n){var i=this;e.call(this,t,n),t.on("select",function(){i._checkIfMaximumSelected()})},e.prototype.query=function(e,t,n){var i=this;this._checkIfMaximumSelected(function(){e.call(i,t,n)})},e.prototype._checkIfMaximumSelected=function(e,n){var i=this;this.current(function(e){var t=null!=e?e.length:0;0<i.maximumSelectionLength&&t>=i.maximumSelectionLength?i.trigger("results:message",{message:"maximumSelected",args:{maximum:i.maximumSelectionLength}}):n&&n()})},e}),e.define("select2/dropdown",["jquery","./utils"],function(t,e){function n(e,t){this.$element=e,this.options=t,n.__super__.constructor.call(this)}return e.Extend(n,e.Observable),n.prototype.render=function(){var e=t('<span class="select2-dropdown"><span class="select2-results"></span></span>');return e.attr("dir",this.options.get("dir")),this.$dropdown=e},n.prototype.bind=function(){},n.prototype.position=function(e,t){},n.prototype.destroy=function(){this.$dropdown.remove()},n}),e.define("select2/dropdown/search",["jquery","../utils"],function(o,e){function t(){}return t.prototype.render=function(e){var t=e.call(this),n=o('<span class="select2-search select2-search--dropdown"><input class="select2-search__field" type="search" tabindex="-1" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" role="searchbox" aria-autocomplete="list" /></span>');return this.$searchContainer=n,this.$search=n.find("input"),t.prepend(n),t},t.prototype.bind=function(e,t,n){var i=this,r=t.id+"-results";e.call(this,t,n),this.$search.on("keydown",function(e){i.trigger("keypress",e),i._keyUpPrevented=e.isDefaultPrevented()}),this.$search.on("input",function(e){o(this).off("keyup")}),this.$search.on("keyup input",function(e){i.handleSearch(e)}),t.on("open",function(){i.$search.attr("tabindex",0),i.$search.attr("aria-controls",r),i.$search.trigger("focus"),window.setTimeout(function(){i.$search.trigger("focus")},0)}),t.on("close",function(){i.$search.attr("tabindex",-1),i.$search.removeAttr("aria-controls"),i.$search.removeAttr("aria-activedescendant"),i.$search.val(""),i.$search.trigger("blur")}),t.on("focus",function(){t.isOpen()||i.$search.trigger("focus")}),t.on("results:all",function(e){null!=e.query.term&&""!==e.query.term||(i.showSearch(e)?i.$searchContainer.removeClass("select2-search--hide"):i.$searchContainer.addClass("select2-search--hide"))}),t.on("results:focus",function(e){e.data._resultId?i.$search.attr("aria-activedescendant",e.data._resultId):i.$search.removeAttr("aria-activedescendant")})},t.prototype.handleSearch=function(e){if(!this._keyUpPrevented){var t=this.$search.val();this.trigger("query",{term:t})}this._keyUpPrevented=!1},t.prototype.showSearch=function(e,t){return!0},t}),e.define("select2/dropdown/hidePlaceholder",[],function(){function e(e,t,n,i){this.placeholder=this.normalizePlaceholder(n.get("placeholder")),e.call(this,t,n,i)}return e.prototype.append=function(e,t){t.results=this.removePlaceholder(t.results),e.call(this,t)},e.prototype.normalizePlaceholder=function(e,t){return"string"==typeof t&&(t={id:"",text:t}),t},e.prototype.removePlaceholder=function(e,t){for(var n=t.slice(0),i=t.length-1;0<=i;i--){var r=t[i];this.placeholder.id===r.id&&n.splice(i,1)}return n},e}),e.define("select2/dropdown/infiniteScroll",["jquery"],function(n){function e(e,t,n,i){this.lastParams={},e.call(this,t,n,i),this.$loadingMore=this.createLoadingMore(),this.loading=!1}return e.prototype.append=function(e,t){this.$loadingMore.remove(),this.loading=!1,e.call(this,t),this.showLoadingMore(t)&&(this.$results.append(this.$loadingMore),this.loadMoreIfNeeded())},e.prototype.bind=function(e,t,n){var i=this;e.call(this,t,n),t.on("query",function(e){i.lastParams=e,i.loading=!0}),t.on("query:append",function(e){i.lastParams=e,i.loading=!0}),this.$results.on("scroll",this.loadMoreIfNeeded.bind(this))},e.prototype.loadMoreIfNeeded=function(){var e=n.contains(document.documentElement,this.$loadingMore[0]);if(!this.loading&&e){var t=this.$results.offset().top+this.$results.outerHeight(!1);this.$loadingMore.offset().top+this.$loadingMore.outerHeight(!1)<=t+50&&this.loadMore()}},e.prototype.loadMore=function(){this.loading=!0;var e=n.extend({},{page:1},this.lastParams);e.page++,this.trigger("query:append",e)},e.prototype.showLoadingMore=function(e,t){return t.pagination&&t.pagination.more},e.prototype.createLoadingMore=function(){var e=n('<li class="select2-results__option select2-results__option--load-more"role="option" aria-disabled="true"></li>'),t=this.options.get("translations").get("loadingMore");return e.html(t(this.lastParams)),e},e}),e.define("select2/dropdown/attachBody",["jquery","../utils"],function(f,a){function e(e,t,n){this.$dropdownParent=f(n.get("dropdownParent")||document.body),e.call(this,t,n)}return e.prototype.bind=function(e,t,n){var i=this;e.call(this,t,n),t.on("open",function(){i._showDropdown(),i._attachPositioningHandler(t),i._bindContainerResultHandlers(t)}),t.on("close",function(){i._hideDropdown(),i._detachPositioningHandler(t)}),this.$dropdownContainer.on("mousedown",function(e){e.stopPropagation()})},e.prototype.destroy=function(e){e.call(this),this.$dropdownContainer.remove()},e.prototype.position=function(e,t,n){t.attr("class",n.attr("class")),t.removeClass("select2"),t.addClass("select2-container--open"),t.css({position:"absolute",top:-999999}),this.$container=n},e.prototype.render=function(e){var t=f("<span></span>"),n=e.call(this);return t.append(n),this.$dropdownContainer=t},e.prototype._hideDropdown=function(e){this.$dropdownContainer.detach()},e.prototype._bindContainerResultHandlers=function(e,t){if(!this._containerResultsHandlersBound){var n=this;t.on("results:all",function(){n._positionDropdown(),n._resizeDropdown()}),t.on("results:append",function(){n._positionDropdown(),n._resizeDropdown()}),t.on("results:message",function(){n._positionDropdown(),n._resizeDropdown()}),t.on("select",function(){n._positionDropdown(),n._resizeDropdown()}),t.on("unselect",function(){n._positionDropdown(),n._resizeDropdown()}),this._containerResultsHandlersBound=!0}},e.prototype._attachPositioningHandler=function(e,t){var n=this,i="scroll.select2."+t.id,r="resize.select2."+t.id,o="orientationchange.select2."+t.id,s=this.$container.parents().filter(a.hasScroll);s.each(function(){a.StoreData(this,"select2-scroll-position",{x:f(this).scrollLeft(),y:f(this).scrollTop()})}),s.on(i,function(e){var t=a.GetData(this,"select2-scroll-position");f(this).scrollTop(t.y)}),f(window).on(i+" "+r+" "+o,function(e){n._positionDropdown(),n._resizeDropdown()})},e.prototype._detachPositioningHandler=function(e,t){var n="scroll.select2."+t.id,i="resize.select2."+t.id,r="orientationchange.select2."+t.id;this.$container.parents().filter(a.hasScroll).off(n),f(window).off(n+" "+i+" "+r)},e.prototype._positionDropdown=function(){var e=f(window),t=this.$dropdown.hasClass("select2-dropdown--above"),n=this.$dropdown.hasClass("select2-dropdown--below"),i=null,r=this.$container.offset();r.bottom=r.top+this.$container.outerHeight(!1);var o={height:this.$container.outerHeight(!1)};o.top=r.top,o.bottom=r.top+o.height;var s=this.$dropdown.outerHeight(!1),a=e.scrollTop(),l=e.scrollTop()+e.height(),c=a<r.top-s,u=l>r.bottom+s,d={left:r.left,top:o.bottom},p=this.$dropdownParent;"static"===p.css("position")&&(p=p.offsetParent());var h={top:0,left:0};(f.contains(document.body,p[0])||p[0].isConnected)&&(h=p.offset()),d.top-=h.top,d.left-=h.left,t||n||(i="below"),u||!c||t?!c&&u&&t&&(i="below"):i="above",("above"==i||t&&"below"!==i)&&(d.top=o.top-h.top-s),null!=i&&(this.$dropdown.removeClass("select2-dropdown--below select2-dropdown--above").addClass("select2-dropdown--"+i),this.$container.removeClass("select2-container--below select2-container--above").addClass("select2-container--"+i)),this.$dropdownContainer.css(d)},e.prototype._resizeDropdown=function(){var e={width:this.$container.outerWidth(!1)+"px"};this.options.get("dropdownAutoWidth")&&(e.minWidth=e.width,e.position="relative",e.width="auto"),this.$dropdown.css(e)},e.prototype._showDropdown=function(e){this.$dropdownContainer.appendTo(this.$dropdownParent),this._positionDropdown(),this._resizeDropdown()},e}),e.define("select2/dropdown/minimumResultsForSearch",[],function(){function e(e,t,n,i){this.minimumResultsForSearch=n.get("minimumResultsForSearch"),this.minimumResultsForSearch<0&&(this.minimumResultsForSearch=1/0),e.call(this,t,n,i)}return e.prototype.showSearch=function(e,t){return!(function e(t){for(var n=0,i=0;i<t.length;i++){var r=t[i];r.children?n+=e(r.children):n++}return n}(t.data.results)<this.minimumResultsForSearch)&&e.call(this,t)},e}),e.define("select2/dropdown/selectOnClose",["../utils"],function(o){function e(){}return e.prototype.bind=function(e,t,n){var i=this;e.call(this,t,n),t.on("close",function(e){i._handleSelectOnClose(e)})},e.prototype._handleSelectOnClose=function(e,t){if(t&&null!=t.originalSelect2Event){var n=t.originalSelect2Event;if("select"===n._type||"unselect"===n._type)return}var i=this.getHighlightedResults();if(!(i.length<1)){var r=o.GetData(i[0],"data");null!=r.element&&r.element.selected||null==r.element&&r.selected||this.trigger("select",{data:r})}},e}),e.define("select2/dropdown/closeOnSelect",[],function(){function e(){}return e.prototype.bind=function(e,t,n){var i=this;e.call(this,t,n),t.on("select",function(e){i._selectTriggered(e)}),t.on("unselect",function(e){i._selectTriggered(e)})},e.prototype._selectTriggered=function(e,t){var n=t.originalEvent;n&&(n.ctrlKey||n.metaKey)||this.trigger("close",{originalEvent:n,originalSelect2Event:t})},e}),e.define("select2/i18n/en",[],function(){return{errorLoading:function(){return"The results could not be loaded."},inputTooLong:function(e){var t=e.input.length-e.maximum,n="Please delete "+t+" character";return 1!=t&&(n+="s"),n},inputTooShort:function(e){return"Please enter "+(e.minimum-e.input.length)+" or more characters"},loadingMore:function(){return"Loading more results…"},maximumSelected:function(e){var t="You can only select "+e.maximum+" item";return 1!=e.maximum&&(t+="s"),t},noResults:function(){return"No results found"},searching:function(){return"Searching…"},removeAllItems:function(){return"Remove all items"}}}),e.define("select2/defaults",["jquery","require","./results","./selection/single","./selection/multiple","./selection/placeholder","./selection/allowClear","./selection/search","./selection/eventRelay","./utils","./translation","./diacritics","./data/select","./data/array","./data/ajax","./data/tags","./data/tokenizer","./data/minimumInputLength","./data/maximumInputLength","./data/maximumSelectionLength","./dropdown","./dropdown/search","./dropdown/hidePlaceholder","./dropdown/infiniteScroll","./dropdown/attachBody","./dropdown/minimumResultsForSearch","./dropdown/selectOnClose","./dropdown/closeOnSelect","./i18n/en"],function(c,u,d,p,h,f,g,m,v,y,s,t,_,w,$,b,A,x,D,S,C,E,O,T,q,j,L,I,e){function n(){this.reset()}return n.prototype.apply=function(e){if(null==(e=c.extend(!0,{},this.defaults,e)).dataAdapter){if(null!=e.ajax?e.dataAdapter=$:null!=e.data?e.dataAdapter=w:e.dataAdapter=_,0<e.minimumInputLength&&(e.dataAdapter=y.Decorate(e.dataAdapter,x)),0<e.maximumInputLength&&(e.dataAdapter=y.Decorate(e.dataAdapter,D)),0<e.maximumSelectionLength&&(e.dataAdapter=y.Decorate(e.dataAdapter,S)),e.tags&&(e.dataAdapter=y.Decorate(e.dataAdapter,b)),null==e.tokenSeparators&&null==e.tokenizer||(e.dataAdapter=y.Decorate(e.dataAdapter,A)),null!=e.query){var t=u(e.amdBase+"compat/query");e.dataAdapter=y.Decorate(e.dataAdapter,t)}if(null!=e.initSelection){var n=u(e.amdBase+"compat/initSelection");e.dataAdapter=y.Decorate(e.dataAdapter,n)}}if(null==e.resultsAdapter&&(e.resultsAdapter=d,null!=e.ajax&&(e.resultsAdapter=y.Decorate(e.resultsAdapter,T)),null!=e.placeholder&&(e.resultsAdapter=y.Decorate(e.resultsAdapter,O)),e.selectOnClose&&(e.resultsAdapter=y.Decorate(e.resultsAdapter,L))),null==e.dropdownAdapter){if(e.multiple)e.dropdownAdapter=C;else{var i=y.Decorate(C,E);e.dropdownAdapter=i}if(0!==e.minimumResultsForSearch&&(e.dropdownAdapter=y.Decorate(e.dropdownAdapter,j)),e.closeOnSelect&&(e.dropdownAdapter=y.Decorate(e.dropdownAdapter,I)),null!=e.dropdownCssClass||null!=e.dropdownCss||null!=e.adaptDropdownCssClass){var r=u(e.amdBase+"compat/dropdownCss");e.dropdownAdapter=y.Decorate(e.dropdownAdapter,r)}e.dropdownAdapter=y.Decorate(e.dropdownAdapter,q)}if(null==e.selectionAdapter){if(e.multiple?e.selectionAdapter=h:e.selectionAdapter=p,null!=e.placeholder&&(e.selectionAdapter=y.Decorate(e.selectionAdapter,f)),e.allowClear&&(e.selectionAdapter=y.Decorate(e.selectionAdapter,g)),e.multiple&&(e.selectionAdapter=y.Decorate(e.selectionAdapter,m)),null!=e.containerCssClass||null!=e.containerCss||null!=e.adaptContainerCssClass){var o=u(e.amdBase+"compat/containerCss");e.selectionAdapter=y.Decorate(e.selectionAdapter,o)}e.selectionAdapter=y.Decorate(e.selectionAdapter,v)}e.language=this._resolveLanguage(e.language),e.language.push("en");for(var s=[],a=0;a<e.language.length;a++){var l=e.language[a];-1===s.indexOf(l)&&s.push(l)}return e.language=s,e.translations=this._processTranslations(e.language,e.debug),e},n.prototype.reset=function(){function a(e){return e.replace(/[^\u0000-\u007E]/g,function(e){return t[e]||e})}this.defaults={amdBase:"./",amdLanguageBase:"./i18n/",closeOnSelect:!0,debug:!1,dropdownAutoWidth:!1,escapeMarkup:y.escapeMarkup,language:{},matcher:function e(t,n){if(""===c.trim(t.term))return n;if(n.children&&0<n.children.length){for(var i=c.extend(!0,{},n),r=n.children.length-1;0<=r;r--)null==e(t,n.children[r])&&i.children.splice(r,1);return 0<i.children.length?i:e(t,i)}var o=a(n.text).toUpperCase(),s=a(t.term).toUpperCase();return-1<o.indexOf(s)?n:null},minimumInputLength:0,maximumInputLength:0,maximumSelectionLength:0,minimumResultsForSearch:0,selectOnClose:!1,scrollAfterSelect:!1,sorter:function(e){return e},templateResult:function(e){return e.text},templateSelection:function(e){return e.text},theme:"default",width:"resolve"}},n.prototype.applyFromElement=function(e,t){var n=e.language,i=this.defaults.language,r=t.prop("lang"),o=t.closest("[lang]").prop("lang"),s=Array.prototype.concat.call(this._resolveLanguage(r),this._resolveLanguage(n),this._resolveLanguage(i),this._resolveLanguage(o));return e.language=s,e},n.prototype._resolveLanguage=function(e){if(!e)return[];if(c.isEmptyObject(e))return[];if(c.isPlainObject(e))return[e];var t;t=c.isArray(e)?e:[e];for(var n=[],i=0;i<t.length;i++)if(n.push(t[i]),"string"==typeof t[i]&&0<t[i].indexOf("-")){var r=t[i].split("-")[0];n.push(r)}return n},n.prototype._processTranslations=function(e,t){for(var n=new s,i=0;i<e.length;i++){var r=new s,o=e[i];if("string"==typeof o)try{r=s.loadPath(o)}catch(e){try{o=this.defaults.amdLanguageBase+o,r=s.loadPath(o)}catch(e){t&&window.console&&console.warn&&console.warn('Select2: The language file for "'+o+'" could not be automatically loaded. A fallback will be used instead.')}}else r=c.isPlainObject(o)?new s(o):o;n.extend(r)}return n},n.prototype.set=function(e,t){var n={};n[c.camelCase(e)]=t;var i=y._convertData(n);c.extend(!0,this.defaults,i)},new n}),e.define("select2/options",["require","jquery","./defaults","./utils"],function(i,d,r,p){function e(e,t){if(this.options=e,null!=t&&this.fromElement(t),null!=t&&(this.options=r.applyFromElement(this.options,t)),this.options=r.apply(this.options),t&&t.is("input")){var n=i(this.get("amdBase")+"compat/inputData");this.options.dataAdapter=p.Decorate(this.options.dataAdapter,n)}}return e.prototype.fromElement=function(e){var t=["select2"];null==this.options.multiple&&(this.options.multiple=e.prop("multiple")),null==this.options.disabled&&(this.options.disabled=e.prop("disabled")),null==this.options.dir&&(e.prop("dir")?this.options.dir=e.prop("dir"):e.closest("[dir]").prop("dir")?this.options.dir=e.closest("[dir]").prop("dir"):this.options.dir="ltr"),e.prop("disabled",this.options.disabled),e.prop("multiple",this.options.multiple),p.GetData(e[0],"select2Tags")&&(this.options.debug&&window.console&&console.warn&&console.warn('Select2: The `data-select2-tags` attribute has been changed to use the `data-data` and `data-tags="true"` attributes and will be removed in future versions of Select2.'),p.StoreData(e[0],"data",p.GetData(e[0],"select2Tags")),p.StoreData(e[0],"tags",!0)),p.GetData(e[0],"ajaxUrl")&&(this.options.debug&&window.console&&console.warn&&console.warn("Select2: The `data-ajax-url` attribute has been changed to `data-ajax--url` and support for the old attribute will be removed in future versions of Select2."),e.attr("ajax--url",p.GetData(e[0],"ajaxUrl")),p.StoreData(e[0],"ajax-Url",p.GetData(e[0],"ajaxUrl")));var n={};function i(e,t){return t.toUpperCase()}for(var r=0;r<e[0].attributes.length;r++){var o=e[0].attributes[r].name,s="data-";if(o.substr(0,s.length)==s){var a=o.substring(s.length),l=p.GetData(e[0],a);n[a.replace(/-([a-z])/g,i)]=l}}d.fn.jquery&&"1."==d.fn.jquery.substr(0,2)&&e[0].dataset&&(n=d.extend(!0,{},e[0].dataset,n));var c=d.extend(!0,{},p.GetData(e[0]),n);for(var u in c=p._convertData(c))-1<d.inArray(u,t)||(d.isPlainObject(this.options[u])?d.extend(this.options[u],c[u]):this.options[u]=c[u]);return this},e.prototype.get=function(e){return this.options[e]},e.prototype.set=function(e,t){this.options[e]=t},e}),e.define("select2/core",["jquery","./options","./utils","./keys"],function(o,c,u,i){var d=function(e,t){null!=u.GetData(e[0],"select2")&&u.GetData(e[0],"select2").destroy(),this.$element=e,this.id=this._generateId(e),t=t||{},this.options=new c(t,e),d.__super__.constructor.call(this);var n=e.attr("tabindex")||0;u.StoreData(e[0],"old-tabindex",n),e.attr("tabindex","-1");var i=this.options.get("dataAdapter");this.dataAdapter=new i(e,this.options);var r=this.render();this._placeContainer(r);var o=this.options.get("selectionAdapter");this.selection=new o(e,this.options),this.$selection=this.selection.render(),this.selection.position(this.$selection,r);var s=this.options.get("dropdownAdapter");this.dropdown=new s(e,this.options),this.$dropdown=this.dropdown.render(),this.dropdown.position(this.$dropdown,r);var a=this.options.get("resultsAdapter");this.results=new a(e,this.options,this.dataAdapter),this.$results=this.results.render(),this.results.position(this.$results,this.$dropdown);var l=this;this._bindAdapters(),this._registerDomEvents(),this._registerDataEvents(),this._registerSelectionEvents(),this._registerDropdownEvents(),this._registerResultsEvents(),this._registerEvents(),this.dataAdapter.current(function(e){l.trigger("selection:update",{data:e})}),e.addClass("select2-hidden-accessible"),e.attr("aria-hidden","true"),this._syncAttributes(),u.StoreData(e[0],"select2",this),e.data("select2",this)};return u.Extend(d,u.Observable),d.prototype._generateId=function(e){return"select2-"+(null!=e.attr("id")?e.attr("id"):null!=e.attr("name")?e.attr("name")+"-"+u.generateChars(2):u.generateChars(4)).replace(/(:|\.|\[|\]|,)/g,"")},d.prototype._placeContainer=function(e){e.insertAfter(this.$element);var t=this._resolveWidth(this.$element,this.options.get("width"));null!=t&&e.css("width",t)},d.prototype._resolveWidth=function(e,t){var n=/^width:(([-+]?([0-9]*\.)?[0-9]+)(px|em|ex|%|in|cm|mm|pt|pc))/i;if("resolve"==t){var i=this._resolveWidth(e,"style");return null!=i?i:this._resolveWidth(e,"element")}if("element"==t){var r=e.outerWidth(!1);return r<=0?"auto":r+"px"}if("style"!=t)return"computedstyle"!=t?t:window.getComputedStyle(e[0]).width;var o=e.attr("style");if("string"!=typeof o)return null;for(var s=o.split(";"),a=0,l=s.length;a<l;a+=1){var c=s[a].replace(/\s/g,"").match(n);if(null!==c&&1<=c.length)return c[1]}return null},d.prototype._bindAdapters=function(){this.dataAdapter.bind(this,this.$container),this.selection.bind(this,this.$container),this.dropdown.bind(this,this.$container),this.results.bind(this,this.$container)},d.prototype._registerDomEvents=function(){var t=this;this.$element.on("change.select2",function(){t.dataAdapter.current(function(e){t.trigger("selection:update",{data:e})})}),this.$element.on("focus.select2",function(e){t.trigger("focus",e)}),this._syncA=u.bind(this._syncAttributes,this),this._syncS=u.bind(this._syncSubtree,this),this.$element[0].attachEvent&&this.$element[0].attachEvent("onpropertychange",this._syncA);var e=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;null!=e?(this._observer=new e(function(e){t._syncA(),t._syncS(null,e)}),this._observer.observe(this.$element[0],{attributes:!0,childList:!0,subtree:!1})):this.$element[0].addEventListener&&(this.$element[0].addEventListener("DOMAttrModified",t._syncA,!1),this.$element[0].addEventListener("DOMNodeInserted",t._syncS,!1),this.$element[0].addEventListener("DOMNodeRemoved",t._syncS,!1))},d.prototype._registerDataEvents=function(){var n=this;this.dataAdapter.on("*",function(e,t){n.trigger(e,t)})},d.prototype._registerSelectionEvents=function(){var n=this,i=["toggle","focus"];this.selection.on("toggle",function(){n.toggleDropdown()}),this.selection.on("focus",function(e){n.focus(e)}),this.selection.on("*",function(e,t){-1===o.inArray(e,i)&&n.trigger(e,t)})},d.prototype._registerDropdownEvents=function(){var n=this;this.dropdown.on("*",function(e,t){n.trigger(e,t)})},d.prototype._registerResultsEvents=function(){var n=this;this.results.on("*",function(e,t){n.trigger(e,t)})},d.prototype._registerEvents=function(){var n=this;this.on("open",function(){n.$container.addClass("select2-container--open")}),this.on("close",function(){n.$container.removeClass("select2-container--open")}),this.on("enable",function(){n.$container.removeClass("select2-container--disabled")}),this.on("disable",function(){n.$container.addClass("select2-container--disabled")}),this.on("blur",function(){n.$container.removeClass("select2-container--focus")}),this.on("query",function(t){n.isOpen()||n.trigger("open",{}),this.dataAdapter.query(t,function(e){n.trigger("results:all",{data:e,query:t})})}),this.on("query:append",function(t){this.dataAdapter.query(t,function(e){n.trigger("results:append",{data:e,query:t})})}),this.on("keypress",function(e){var t=e.which;n.isOpen()?t===i.ESC||t===i.TAB||t===i.UP&&e.altKey?(n.close(e),e.preventDefault()):t===i.ENTER?(n.trigger("results:select",{}),e.preventDefault()):t===i.SPACE&&e.ctrlKey?(n.trigger("results:toggle",{}),e.preventDefault()):t===i.UP?(n.trigger("results:previous",{}),e.preventDefault()):t===i.DOWN&&(n.trigger("results:next",{}),e.preventDefault()):(t===i.ENTER||t===i.SPACE||t===i.DOWN&&e.altKey)&&(n.open(),e.preventDefault())})},d.prototype._syncAttributes=function(){this.options.set("disabled",this.$element.prop("disabled")),this.isDisabled()?(this.isOpen()&&this.close(),this.trigger("disable",{})):this.trigger("enable",{})},d.prototype._isChangeMutation=function(e,t){var n=!1,i=this;if(!e||!e.target||"OPTION"===e.target.nodeName||"OPTGROUP"===e.target.nodeName){if(t)if(t.addedNodes&&0<t.addedNodes.length)for(var r=0;r<t.addedNodes.length;r++){t.addedNodes[r].selected&&(n=!0)}else t.removedNodes&&0<t.removedNodes.length?n=!0:o.isArray(t)&&o.each(t,function(e,t){if(i._isChangeMutation(e,t))return!(n=!0)});else n=!0;return n}},d.prototype._syncSubtree=function(e,t){var n=this._isChangeMutation(e,t),i=this;n&&this.dataAdapter.current(function(e){i.trigger("selection:update",{data:e})})},d.prototype.trigger=function(e,t){var n=d.__super__.trigger,i={open:"opening",close:"closing",select:"selecting",unselect:"unselecting",clear:"clearing"};if(void 0===t&&(t={}),e in i){var r=i[e],o={prevented:!1,name:e,args:t};if(n.call(this,r,o),o.prevented)return void(t.prevented=!0)}n.call(this,e,t)},d.prototype.toggleDropdown=function(){this.isDisabled()||(this.isOpen()?this.close():this.open())},d.prototype.open=function(){this.isOpen()||this.isDisabled()||this.trigger("query",{})},d.prototype.close=function(e){this.isOpen()&&this.trigger("close",{originalEvent:e})},d.prototype.isEnabled=function(){return!this.isDisabled()},d.prototype.isDisabled=function(){return this.options.get("disabled")},d.prototype.isOpen=function(){return this.$container.hasClass("select2-container--open")},d.prototype.hasFocus=function(){return this.$container.hasClass("select2-container--focus")},d.prototype.focus=function(e){this.hasFocus()||(this.$container.addClass("select2-container--focus"),this.trigger("focus",{}))},d.prototype.enable=function(e){this.options.get("debug")&&window.console&&console.warn&&console.warn('Select2: The `select2("enable")` method has been deprecated and will be removed in later Select2 versions. Use $element.prop("disabled") instead.'),null!=e&&0!==e.length||(e=[!0]);var t=!e[0];this.$element.prop("disabled",t)},d.prototype.data=function(){this.options.get("debug")&&0<arguments.length&&window.console&&console.warn&&console.warn('Select2: Data can no longer be set using `select2("data")`. You should consider setting the value instead using `$element.val()`.');var t=[];return this.dataAdapter.current(function(e){t=e}),t},d.prototype.val=function(e){if(this.options.get("debug")&&window.console&&console.warn&&console.warn('Select2: The `select2("val")` method has been deprecated and will be removed in later Select2 versions. Use $element.val() instead.'),null==e||0===e.length)return this.$element.val();var t=e[0];o.isArray(t)&&(t=o.map(t,function(e){return e.toString()})),this.$element.val(t).trigger("input").trigger("change")},d.prototype.destroy=function(){this.$container.remove(),this.$element[0].detachEvent&&this.$element[0].detachEvent("onpropertychange",this._syncA),null!=this._observer?(this._observer.disconnect(),this._observer=null):this.$element[0].removeEventListener&&(this.$element[0].removeEventListener("DOMAttrModified",this._syncA,!1),this.$element[0].removeEventListener("DOMNodeInserted",this._syncS,!1),this.$element[0].removeEventListener("DOMNodeRemoved",this._syncS,!1)),this._syncA=null,this._syncS=null,this.$element.off(".select2"),this.$element.attr("tabindex",u.GetData(this.$element[0],"old-tabindex")),this.$element.removeClass("select2-hidden-accessible"),this.$element.attr("aria-hidden","false"),u.RemoveData(this.$element[0]),this.$element.removeData("select2"),this.dataAdapter.destroy(),this.selection.destroy(),this.dropdown.destroy(),this.results.destroy(),this.dataAdapter=null,this.selection=null,this.dropdown=null,this.results=null},d.prototype.render=function(){var e=o('<span class="select2 select2-container"><span class="selection"></span><span class="dropdown-wrapper" aria-hidden="true"></span></span>');return e.attr("dir",this.options.get("dir")),this.$container=e,this.$container.addClass("select2-container--"+this.options.get("theme")),u.StoreData(e[0],"element",this.$element),e},d}),e.define("select2/compat/utils",["jquery"],function(s){return{syncCssClasses:function(e,t,n){var i,r,o=[];(i=s.trim(e.attr("class")))&&s((i=""+i).split(/\s+/)).each(function(){0===this.indexOf("select2-")&&o.push(this)}),(i=s.trim(t.attr("class")))&&s((i=""+i).split(/\s+/)).each(function(){0!==this.indexOf("select2-")&&null!=(r=n(this))&&o.push(r)}),e.attr("class",o.join(" "))}}}),e.define("select2/compat/containerCss",["jquery","./utils"],function(s,a){function l(e){return null}function e(){}return e.prototype.render=function(e){var t=e.call(this),n=this.options.get("containerCssClass")||"";s.isFunction(n)&&(n=n(this.$element));var i=this.options.get("adaptContainerCssClass");if(i=i||l,-1!==n.indexOf(":all:")){n=n.replace(":all:","");var r=i;i=function(e){var t=r(e);return null!=t?t+" "+e:e}}var o=this.options.get("containerCss")||{};return s.isFunction(o)&&(o=o(this.$element)),a.syncCssClasses(t,this.$element,i),t.css(o),t.addClass(n),t},e}),e.define("select2/compat/dropdownCss",["jquery","./utils"],function(s,a){function l(e){return null}function e(){}return e.prototype.render=function(e){var t=e.call(this),n=this.options.get("dropdownCssClass")||"";s.isFunction(n)&&(n=n(this.$element));var i=this.options.get("adaptDropdownCssClass");if(i=i||l,-1!==n.indexOf(":all:")){n=n.replace(":all:","");var r=i;i=function(e){var t=r(e);return null!=t?t+" "+e:e}}var o=this.options.get("dropdownCss")||{};return s.isFunction(o)&&(o=o(this.$element)),a.syncCssClasses(t,this.$element,i),t.css(o),t.addClass(n),t},e}),e.define("select2/compat/initSelection",["jquery"],function(i){function e(e,t,n){n.get("debug")&&window.console&&console.warn&&console.warn("Select2: The `initSelection` option has been deprecated in favor of a custom data adapter that overrides the `current` method. This method is now called multiple times instead of a single time when the instance is initialized. Support will be removed for the `initSelection` option in future versions of Select2"),this.initSelection=n.get("initSelection"),this._isInitialized=!1,e.call(this,t,n)}return e.prototype.current=function(e,t){var n=this;this._isInitialized?e.call(this,t):this.initSelection.call(null,this.$element,function(e){n._isInitialized=!0,i.isArray(e)||(e=[e]),t(e)})},e}),e.define("select2/compat/inputData",["jquery","../utils"],function(s,i){function e(e,t,n){this._currentData=[],this._valueSeparator=n.get("valueSeparator")||",","hidden"===t.prop("type")&&n.get("debug")&&console&&console.warn&&console.warn("Select2: Using a hidden input with Select2 is no longer supported and may stop working in the future. It is recommended to use a `<select>` element instead."),e.call(this,t,n)}return e.prototype.current=function(e,t){function i(e,t){var n=[];return e.selected||-1!==s.inArray(e.id,t)?(e.selected=!0,n.push(e)):e.selected=!1,e.children&&n.push.apply(n,i(e.children,t)),n}for(var n=[],r=0;r<this._currentData.length;r++){var o=this._currentData[r];n.push.apply(n,i(o,this.$element.val().split(this._valueSeparator)))}t(n)},e.prototype.select=function(e,t){if(this.options.get("multiple")){var n=this.$element.val();n+=this._valueSeparator+t.id,this.$element.val(n),this.$element.trigger("input").trigger("change")}else this.current(function(e){s.map(e,function(e){e.selected=!1})}),this.$element.val(t.id),this.$element.trigger("input").trigger("change")},e.prototype.unselect=function(e,r){var o=this;r.selected=!1,this.current(function(e){for(var t=[],n=0;n<e.length;n++){var i=e[n];r.id!=i.id&&t.push(i.id)}o.$element.val(t.join(o._valueSeparator)),o.$element.trigger("input").trigger("change")})},e.prototype.query=function(e,t,n){for(var i=[],r=0;r<this._currentData.length;r++){var o=this._currentData[r],s=this.matches(t,o);null!==s&&i.push(s)}n({results:i})},e.prototype.addOptions=function(e,t){var n=s.map(t,function(e){return i.GetData(e[0],"data")});this._currentData.push.apply(this._currentData,n)},e}),e.define("select2/compat/matcher",["jquery"],function(s){return function(o){return function(e,t){var n=s.extend(!0,{},t);if(null==e.term||""===s.trim(e.term))return n;if(t.children){for(var i=t.children.length-1;0<=i;i--){var r=t.children[i];o(e.term,r.text,r)||n.children.splice(i,1)}if(0<n.children.length)return n}return o(e.term,t.text,t)?n:null}}}),e.define("select2/compat/query",[],function(){function e(e,t,n){n.get("debug")&&window.console&&console.warn&&console.warn("Select2: The `query` option has been deprecated in favor of a custom data adapter that overrides the `query` method. Support will be removed for the `query` option in future versions of Select2."),e.call(this,t,n)}return e.prototype.query=function(e,t,n){t.callback=n,this.options.get("query").call(null,t)},e}),e.define("select2/dropdown/attachContainer",[],function(){function e(e,t,n){e.call(this,t,n)}return e.prototype.position=function(e,t,n){n.find(".dropdown-wrapper").append(t),t.addClass("select2-dropdown--below"),n.addClass("select2-container--below")},e}),e.define("select2/dropdown/stopPropagation",[],function(){function e(){}return e.prototype.bind=function(e,t,n){e.call(this,t,n);this.$dropdown.on(["blur","change","click","dblclick","focus","focusin","focusout","input","keydown","keyup","keypress","mousedown","mouseenter","mouseleave","mousemove","mouseover","mouseup","search","touchend","touchstart"].join(" "),function(e){e.stopPropagation()})},e}),e.define("select2/selection/stopPropagation",[],function(){function e(){}return e.prototype.bind=function(e,t,n){e.call(this,t,n);this.$selection.on(["blur","change","click","dblclick","focus","focusin","focusout","input","keydown","keyup","keypress","mousedown","mouseenter","mouseleave","mousemove","mouseover","mouseup","search","touchend","touchstart"].join(" "),function(e){e.stopPropagation()})},e}),l=function(p){var h,f,e=["wheel","mousewheel","DOMMouseScroll","MozMousePixelScroll"],t="onwheel"in document||9<=document.documentMode?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"],g=Array.prototype.slice;if(p.event.fixHooks)for(var n=e.length;n;)p.event.fixHooks[e[--n]]=p.event.mouseHooks;var m=p.event.special.mousewheel={version:"3.1.12",setup:function(){if(this.addEventListener)for(var e=t.length;e;)this.addEventListener(t[--e],i,!1);else this.onmousewheel=i;p.data(this,"mousewheel-line-height",m.getLineHeight(this)),p.data(this,"mousewheel-page-height",m.getPageHeight(this))},teardown:function(){if(this.removeEventListener)for(var e=t.length;e;)this.removeEventListener(t[--e],i,!1);else this.onmousewheel=null;p.removeData(this,"mousewheel-line-height"),p.removeData(this,"mousewheel-page-height")},getLineHeight:function(e){var t=p(e),n=t["offsetParent"in p.fn?"offsetParent":"parent"]();return n.length||(n=p("body")),parseInt(n.css("fontSize"),10)||parseInt(t.css("fontSize"),10)||16},getPageHeight:function(e){return p(e).height()},settings:{adjustOldDeltas:!0,normalizeOffset:!0}};function i(e){var t,n=e||window.event,i=g.call(arguments,1),r=0,o=0,s=0,a=0,l=0;if((e=p.event.fix(n)).type="mousewheel","detail"in n&&(s=-1*n.detail),"wheelDelta"in n&&(s=n.wheelDelta),"wheelDeltaY"in n&&(s=n.wheelDeltaY),"wheelDeltaX"in n&&(o=-1*n.wheelDeltaX),"axis"in n&&n.axis===n.HORIZONTAL_AXIS&&(o=-1*s,s=0),r=0===s?o:s,"deltaY"in n&&(r=s=-1*n.deltaY),"deltaX"in n&&(o=n.deltaX,0===s&&(r=-1*o)),0!==s||0!==o){if(1===n.deltaMode){var c=p.data(this,"mousewheel-line-height");r*=c,s*=c,o*=c}else if(2===n.deltaMode){var u=p.data(this,"mousewheel-page-height");r*=u,s*=u,o*=u}if(t=Math.max(Math.abs(s),Math.abs(o)),(!f||t<f)&&y(n,f=t)&&(f/=40),y(n,t)&&(r/=40,o/=40,s/=40),r=Math[1<=r?"floor":"ceil"](r/f),o=Math[1<=o?"floor":"ceil"](o/f),s=Math[1<=s?"floor":"ceil"](s/f),m.settings.normalizeOffset&&this.getBoundingClientRect){var d=this.getBoundingClientRect();a=e.clientX-d.left,l=e.clientY-d.top}return e.deltaX=o,e.deltaY=s,e.deltaFactor=f,e.offsetX=a,e.offsetY=l,e.deltaMode=0,i.unshift(e,r,o,s),h&&clearTimeout(h),h=setTimeout(v,200),(p.event.dispatch||p.event.handle).apply(this,i)}}function v(){f=null}function y(e,t){return m.settings.adjustOldDeltas&&"mousewheel"===e.type&&t%120==0}p.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})},"function"==typeof e.define&&e.define.amd?e.define("jquery-mousewheel",["jquery"],l):"object"==typeof exports?module.exports=l:l(d),e.define("jquery.select2",["jquery","jquery-mousewheel","./select2/core","./select2/defaults","./select2/utils"],function(r,e,o,t,s){if(null==r.fn.select2){var a=["open","close","destroy"];r.fn.select2=function(t){if("object"==typeof(t=t||{}))return this.each(function(){var e=r.extend(!0,{},t);new o(r(this),e)}),this;if("string"!=typeof t)throw new Error("Invalid arguments for Select2: "+t);var n,i=Array.prototype.slice.call(arguments,1);return this.each(function(){var e=s.GetData(this,"select2");null==e&&window.console&&console.error&&console.error("The select2('"+t+"') method was called on an element that is not using Select2."),n=e[t].apply(e,i)}),-1<r.inArray(t,a)?this:n}}return null==r.fn.select2.defaults&&(r.fn.select2.defaults=t),o}),{define:e.define,require:e.require}}(),t=e.require("jquery.select2");return d.fn.select2.amd=e,t});


========== staticfiles/admin/js/vendor/select2/i18n/id.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/id",[],function(){return{errorLoading:function(){return"Data tidak boleh diambil."},inputTooLong:function(n){return"Hapuskan "+(n.input.length-n.maximum)+" huruf"},inputTooShort:function(n){return"Masukkan "+(n.minimum-n.input.length)+" huruf lagi"},loadingMore:function(){return"Mengambil data…"},maximumSelected:function(n){return"Anda hanya dapat memilih "+n.maximum+" pilihan"},noResults:function(){return"Tidak ada data yang sesuai"},searching:function(){return"Mencari…"},removeAllItems:function(){return"Hapus semua item"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/dsb.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/dsb",[],function(){var n=["znamuško","znamušce","znamuška","znamuškow"],e=["zapisk","zapiska","zapiski","zapiskow"],u=function(n,e){return 1===n?e[0]:2===n?e[1]:n>2&&n<=4?e[2]:n>=5?e[3]:void 0};return{errorLoading:function(){return"Wuslědki njejsu se dali zacytaś."},inputTooLong:function(e){var a=e.input.length-e.maximum;return"Pšosym lašuj "+a+" "+u(a,n)},inputTooShort:function(e){var a=e.minimum-e.input.length;return"Pšosym zapódaj nanejmjenjej "+a+" "+u(a,n)},loadingMore:function(){return"Dalšne wuslědki se zacytaju…"},maximumSelected:function(n){return"Móžoš jano "+n.maximum+" "+u(n.maximum,e)+"wubraś."},noResults:function(){return"Žedne wuslědki namakane"},searching:function(){return"Pyta se…"},removeAllItems:function(){return"Remove all items"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/sl.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/sl",[],function(){return{errorLoading:function(){return"Zadetkov iskanja ni bilo mogoče naložiti."},inputTooLong:function(e){var n=e.input.length-e.maximum,t="Prosim zbrišite "+n+" znak";return 2==n?t+="a":1!=n&&(t+="e"),t},inputTooShort:function(e){var n=e.minimum-e.input.length,t="Prosim vpišite še "+n+" znak";return 2==n?t+="a":1!=n&&(t+="e"),t},loadingMore:function(){return"Nalagam več zadetkov…"},maximumSelected:function(e){var n="Označite lahko največ "+e.maximum+" predmet";return 2==e.maximum?n+="a":1!=e.maximum&&(n+="e"),n},noResults:function(){return"Ni zadetkov."},searching:function(){return"Iščem…"},removeAllItems:function(){return"Odstranite vse elemente"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/uk.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/uk",[],function(){function n(n,e,u,r){return n%100>10&&n%100<15?r:n%10==1?e:n%10>1&&n%10<5?u:r}return{errorLoading:function(){return"Неможливо завантажити результати"},inputTooLong:function(e){return"Будь ласка, видаліть "+(e.input.length-e.maximum)+" "+n(e.maximum,"літеру","літери","літер")},inputTooShort:function(n){return"Будь ласка, введіть "+(n.minimum-n.input.length)+" або більше літер"},loadingMore:function(){return"Завантаження інших результатів…"},maximumSelected:function(e){return"Ви можете вибрати лише "+e.maximum+" "+n(e.maximum,"пункт","пункти","пунктів")},noResults:function(){return"Нічого не знайдено"},searching:function(){return"Пошук…"},removeAllItems:function(){return"Видалити всі елементи"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/bg.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/bg",[],function(){return{inputTooLong:function(n){var e=n.input.length-n.maximum,u="Моля въведете с "+e+" по-малко символ";return e>1&&(u+="a"),u},inputTooShort:function(n){var e=n.minimum-n.input.length,u="Моля въведете още "+e+" символ";return e>1&&(u+="a"),u},loadingMore:function(){return"Зареждат се още…"},maximumSelected:function(n){var e="Можете да направите до "+n.maximum+" ";return n.maximum>1?e+="избора":e+="избор",e},noResults:function(){return"Няма намерени съвпадения"},searching:function(){return"Търсене…"},removeAllItems:function(){return"Премахнете всички елементи"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/sv.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/sv",[],function(){return{errorLoading:function(){return"Resultat kunde inte laddas."},inputTooLong:function(n){return"Vänligen sudda ut "+(n.input.length-n.maximum)+" tecken"},inputTooShort:function(n){return"Vänligen skriv in "+(n.minimum-n.input.length)+" eller fler tecken"},loadingMore:function(){return"Laddar fler resultat…"},maximumSelected:function(n){return"Du kan max välja "+n.maximum+" element"},noResults:function(){return"Inga träffar"},searching:function(){return"Söker…"},removeAllItems:function(){return"Ta bort alla objekt"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/is.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/is",[],function(){return{inputTooLong:function(n){var t=n.input.length-n.maximum,e="Vinsamlegast styttið texta um "+t+" staf";return t<=1?e:e+"i"},inputTooShort:function(n){var t=n.minimum-n.input.length,e="Vinsamlegast skrifið "+t+" staf";return t>1&&(e+="i"),e+=" í viðbót"},loadingMore:function(){return"Sæki fleiri niðurstöður…"},maximumSelected:function(n){return"Þú getur aðeins valið "+n.maximum+" atriði"},noResults:function(){return"Ekkert fannst"},searching:function(){return"Leita…"},removeAllItems:function(){return"Fjarlægðu öll atriði"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/sq.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/sq",[],function(){return{errorLoading:function(){return"Rezultatet nuk mund të ngarkoheshin."},inputTooLong:function(e){var n=e.input.length-e.maximum,t="Të lutem fshi "+n+" karakter";return 1!=n&&(t+="e"),t},inputTooShort:function(e){return"Të lutem shkruaj "+(e.minimum-e.input.length)+" ose më shumë karaktere"},loadingMore:function(){return"Duke ngarkuar më shumë rezultate…"},maximumSelected:function(e){var n="Mund të zgjedhësh vetëm "+e.maximum+" element";return 1!=e.maximum&&(n+="e"),n},noResults:function(){return"Nuk u gjet asnjë rezultat"},searching:function(){return"Duke kërkuar…"},removeAllItems:function(){return"Hiq të gjitha sendet"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/ar.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/ar",[],function(){return{errorLoading:function(){return"لا يمكن تحميل النتائج"},inputTooLong:function(n){return"الرجاء حذف "+(n.input.length-n.maximum)+" عناصر"},inputTooShort:function(n){return"الرجاء إضافة "+(n.minimum-n.input.length)+" عناصر"},loadingMore:function(){return"جاري تحميل نتائج إضافية..."},maximumSelected:function(n){return"تستطيع إختيار "+n.maximum+" بنود فقط"},noResults:function(){return"لم يتم العثور على أي نتائج"},searching:function(){return"جاري البحث…"},removeAllItems:function(){return"قم بإزالة كل العناصر"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/ca.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/ca",[],function(){return{errorLoading:function(){return"La càrrega ha fallat"},inputTooLong:function(e){var n=e.input.length-e.maximum,r="Si us plau, elimina "+n+" car";return r+=1==n?"àcter":"àcters"},inputTooShort:function(e){var n=e.minimum-e.input.length,r="Si us plau, introdueix "+n+" car";return r+=1==n?"àcter":"àcters"},loadingMore:function(){return"Carregant més resultats…"},maximumSelected:function(e){var n="Només es pot seleccionar "+e.maximum+" element";return 1!=e.maximum&&(n+="s"),n},noResults:function(){return"No s'han trobat resultats"},searching:function(){return"Cercant…"},removeAllItems:function(){return"Treu tots els elements"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/ru.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/ru",[],function(){function n(n,e,r,u){return n%10<5&&n%10>0&&n%100<5||n%100>20?n%10>1?r:e:u}return{errorLoading:function(){return"Невозможно загрузить результаты"},inputTooLong:function(e){var r=e.input.length-e.maximum,u="Пожалуйста, введите на "+r+" символ";return u+=n(r,"","a","ов"),u+=" меньше"},inputTooShort:function(e){var r=e.minimum-e.input.length,u="Пожалуйста, введите ещё хотя бы "+r+" символ";return u+=n(r,"","a","ов")},loadingMore:function(){return"Загрузка данных…"},maximumSelected:function(e){var r="Вы можете выбрать не более "+e.maximum+" элемент";return r+=n(e.maximum,"","a","ов")},noResults:function(){return"Совпадений не найдено"},searching:function(){return"Поиск…"},removeAllItems:function(){return"Удалить все элементы"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/cs.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/cs",[],function(){function e(e,n){switch(e){case 2:return n?"dva":"dvě";case 3:return"tři";case 4:return"čtyři"}return""}return{errorLoading:function(){return"Výsledky nemohly být načteny."},inputTooLong:function(n){var t=n.input.length-n.maximum;return 1==t?"Prosím, zadejte o jeden znak méně.":t<=4?"Prosím, zadejte o "+e(t,!0)+" znaky méně.":"Prosím, zadejte o "+t+" znaků méně."},inputTooShort:function(n){var t=n.minimum-n.input.length;return 1==t?"Prosím, zadejte ještě jeden znak.":t<=4?"Prosím, zadejte ještě další "+e(t,!0)+" znaky.":"Prosím, zadejte ještě dalších "+t+" znaků."},loadingMore:function(){return"Načítají se další výsledky…"},maximumSelected:function(n){var t=n.maximum;return 1==t?"Můžete zvolit jen jednu položku.":t<=4?"Můžete zvolit maximálně "+e(t,!1)+" položky.":"Můžete zvolit maximálně "+t+" položek."},noResults:function(){return"Nenalezeny žádné položky."},searching:function(){return"Vyhledávání…"},removeAllItems:function(){return"Odstraňte všechny položky"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/hu.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/hu",[],function(){return{errorLoading:function(){return"Az eredmények betöltése nem sikerült."},inputTooLong:function(e){return"Túl hosszú. "+(e.input.length-e.maximum)+" karakterrel több, mint kellene."},inputTooShort:function(e){return"Túl rövid. Még "+(e.minimum-e.input.length)+" karakter hiányzik."},loadingMore:function(){return"Töltés…"},maximumSelected:function(e){return"Csak "+e.maximum+" elemet lehet kiválasztani."},noResults:function(){return"Nincs találat."},searching:function(){return"Keresés…"},removeAllItems:function(){return"Távolítson el minden elemet"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/bn.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/bn",[],function(){return{errorLoading:function(){return"ফলাফলগুলি লোড করা যায়নি।"},inputTooLong:function(n){var e=n.input.length-n.maximum,u="অনুগ্রহ করে "+e+" টি অক্ষর মুছে দিন।";return 1!=e&&(u="অনুগ্রহ করে "+e+" টি অক্ষর মুছে দিন।"),u},inputTooShort:function(n){return n.minimum-n.input.length+" টি অক্ষর অথবা অধিক অক্ষর লিখুন।"},loadingMore:function(){return"আরো ফলাফল লোড হচ্ছে ..."},maximumSelected:function(n){var e=n.maximum+" টি আইটেম নির্বাচন করতে পারবেন।";return 1!=n.maximum&&(e=n.maximum+" টি আইটেম নির্বাচন করতে পারবেন।"),e},noResults:function(){return"কোন ফলাফল পাওয়া যায়নি।"},searching:function(){return"অনুসন্ধান করা হচ্ছে ..."}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/pt-BR.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/pt-BR",[],function(){return{errorLoading:function(){return"Os resultados não puderam ser carregados."},inputTooLong:function(e){var n=e.input.length-e.maximum,r="Apague "+n+" caracter";return 1!=n&&(r+="es"),r},inputTooShort:function(e){return"Digite "+(e.minimum-e.input.length)+" ou mais caracteres"},loadingMore:function(){return"Carregando mais resultados…"},maximumSelected:function(e){var n="Você só pode selecionar "+e.maximum+" ite";return 1==e.maximum?n+="m":n+="ns",n},noResults:function(){return"Nenhum resultado encontrado"},searching:function(){return"Buscando…"},removeAllItems:function(){return"Remover todos os itens"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/he.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/he",[],function(){return{errorLoading:function(){return"שגיאה בטעינת התוצאות"},inputTooLong:function(n){var e=n.input.length-n.maximum,r="נא למחוק ";return r+=1===e?"תו אחד":e+" תווים"},inputTooShort:function(n){var e=n.minimum-n.input.length,r="נא להכניס ";return r+=1===e?"תו אחד":e+" תווים",r+=" או יותר"},loadingMore:function(){return"טוען תוצאות נוספות…"},maximumSelected:function(n){var e="באפשרותך לבחור עד ";return 1===n.maximum?e+="פריט אחד":e+=n.maximum+" פריטים",e},noResults:function(){return"לא נמצאו תוצאות"},searching:function(){return"מחפש…"},removeAllItems:function(){return"הסר את כל הפריטים"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/ro.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/ro",[],function(){return{errorLoading:function(){return"Rezultatele nu au putut fi incărcate."},inputTooLong:function(e){var t=e.input.length-e.maximum,n="Vă rugăm să ștergeți"+t+" caracter";return 1!==t&&(n+="e"),n},inputTooShort:function(e){return"Vă rugăm să introduceți "+(e.minimum-e.input.length)+" sau mai multe caractere"},loadingMore:function(){return"Se încarcă mai multe rezultate…"},maximumSelected:function(e){var t="Aveți voie să selectați cel mult "+e.maximum;return t+=" element",1!==e.maximum&&(t+="e"),t},noResults:function(){return"Nu au fost găsite rezultate"},searching:function(){return"Căutare…"},removeAllItems:function(){return"Eliminați toate elementele"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/lv.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/lv",[],function(){function e(e,n,u,i){return 11===e?n:e%10==1?u:i}return{inputTooLong:function(n){var u=n.input.length-n.maximum,i="Lūdzu ievadiet par  "+u;return(i+=" simbol"+e(u,"iem","u","iem"))+" mazāk"},inputTooShort:function(n){var u=n.minimum-n.input.length,i="Lūdzu ievadiet vēl "+u;return i+=" simbol"+e(u,"us","u","us")},loadingMore:function(){return"Datu ielāde…"},maximumSelected:function(n){var u="Jūs varat izvēlēties ne vairāk kā "+n.maximum;return u+=" element"+e(n.maximum,"us","u","us")},noResults:function(){return"Sakritību nav"},searching:function(){return"Meklēšana…"},removeAllItems:function(){return"Noņemt visus vienumus"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/da.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/da",[],function(){return{errorLoading:function(){return"Resultaterne kunne ikke indlæses."},inputTooLong:function(e){return"Angiv venligst "+(e.input.length-e.maximum)+" tegn mindre"},inputTooShort:function(e){return"Angiv venligst "+(e.minimum-e.input.length)+" tegn mere"},loadingMore:function(){return"Indlæser flere resultater…"},maximumSelected:function(e){var n="Du kan kun vælge "+e.maximum+" emne";return 1!=e.maximum&&(n+="r"),n},noResults:function(){return"Ingen resultater fundet"},searching:function(){return"Søger…"},removeAllItems:function(){return"Fjern alle elementer"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/eu.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/eu",[],function(){return{inputTooLong:function(e){var t=e.input.length-e.maximum,n="Idatzi ";return n+=1==t?"karaktere bat":t+" karaktere",n+=" gutxiago"},inputTooShort:function(e){var t=e.minimum-e.input.length,n="Idatzi ";return n+=1==t?"karaktere bat":t+" karaktere",n+=" gehiago"},loadingMore:function(){return"Emaitza gehiago kargatzen…"},maximumSelected:function(e){return 1===e.maximum?"Elementu bakarra hauta dezakezu":e.maximum+" elementu hauta ditzakezu soilik"},noResults:function(){return"Ez da bat datorrenik aurkitu"},searching:function(){return"Bilatzen…"},removeAllItems:function(){return"Kendu elementu guztiak"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/nb.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/nb",[],function(){return{errorLoading:function(){return"Kunne ikke hente resultater."},inputTooLong:function(e){return"Vennligst fjern "+(e.input.length-e.maximum)+" tegn"},inputTooShort:function(e){return"Vennligst skriv inn "+(e.minimum-e.input.length)+" tegn til"},loadingMore:function(){return"Laster flere resultater…"},maximumSelected:function(e){return"Du kan velge maks "+e.maximum+" elementer"},noResults:function(){return"Ingen treff"},searching:function(){return"Søker…"},removeAllItems:function(){return"Fjern alle elementer"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/sr.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/sr",[],function(){function n(n,e,r,t){return n%10==1&&n%100!=11?e:n%10>=2&&n%10<=4&&(n%100<12||n%100>14)?r:t}return{errorLoading:function(){return"Preuzimanje nije uspelo."},inputTooLong:function(e){var r=e.input.length-e.maximum,t="Obrišite "+r+" simbol";return t+=n(r,"","a","a")},inputTooShort:function(e){var r=e.minimum-e.input.length,t="Ukucajte bar još "+r+" simbol";return t+=n(r,"","a","a")},loadingMore:function(){return"Preuzimanje još rezultata…"},maximumSelected:function(e){var r="Možete izabrati samo "+e.maximum+" stavk";return r+=n(e.maximum,"u","e","i")},noResults:function(){return"Ništa nije pronađeno"},searching:function(){return"Pretraga…"},removeAllItems:function(){return"Уклоните све ставке"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/pl.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/pl",[],function(){var n=["znak","znaki","znaków"],e=["element","elementy","elementów"],r=function(n,e){return 1===n?e[0]:n>1&&n<=4?e[1]:n>=5?e[2]:void 0};return{errorLoading:function(){return"Nie można załadować wyników."},inputTooLong:function(e){var t=e.input.length-e.maximum;return"Usuń "+t+" "+r(t,n)},inputTooShort:function(e){var t=e.minimum-e.input.length;return"Podaj przynajmniej "+t+" "+r(t,n)},loadingMore:function(){return"Trwa ładowanie…"},maximumSelected:function(n){return"Możesz zaznaczyć tylko "+n.maximum+" "+r(n.maximum,e)},noResults:function(){return"Brak wyników"},searching:function(){return"Trwa wyszukiwanie…"},removeAllItems:function(){return"Usuń wszystkie przedmioty"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/mk.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/mk",[],function(){return{inputTooLong:function(n){var e=(n.input.length,n.maximum,"Ве молиме внесете "+n.maximum+" помалку карактер");return 1!==n.maximum&&(e+="и"),e},inputTooShort:function(n){var e=(n.minimum,n.input.length,"Ве молиме внесете уште "+n.maximum+" карактер");return 1!==n.maximum&&(e+="и"),e},loadingMore:function(){return"Вчитување резултати…"},maximumSelected:function(n){var e="Можете да изберете само "+n.maximum+" ставк";return 1===n.maximum?e+="а":e+="и",e},noResults:function(){return"Нема пронајдено совпаѓања"},searching:function(){return"Пребарување…"},removeAllItems:function(){return"Отстрани ги сите предмети"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/zh-CN.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/zh-CN",[],function(){return{errorLoading:function(){return"无法载入结果。"},inputTooLong:function(n){return"请删除"+(n.input.length-n.maximum)+"个字符"},inputTooShort:function(n){return"请再输入至少"+(n.minimum-n.input.length)+"个字符"},loadingMore:function(){return"载入更多结果…"},maximumSelected:function(n){return"最多只能选择"+n.maximum+"个项目"},noResults:function(){return"未找到结果"},searching:function(){return"搜索中…"},removeAllItems:function(){return"删除所有项目"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/tk.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/tk",[],function(){return{errorLoading:function(){return"Netije ýüklenmedi."},inputTooLong:function(e){return e.input.length-e.maximum+" harp bozuň."},inputTooShort:function(e){return"Ýene-de iň az "+(e.minimum-e.input.length)+" harp ýazyň."},loadingMore:function(){return"Köpräk netije görkezilýär…"},maximumSelected:function(e){return"Diňe "+e.maximum+" sanysyny saýlaň."},noResults:function(){return"Netije tapylmady."},searching:function(){return"Gözlenýär…"},removeAllItems:function(){return"Remove all items"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/hi.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/hi",[],function(){return{errorLoading:function(){return"परिणामों को लोड नहीं किया जा सका।"},inputTooLong:function(n){var e=n.input.length-n.maximum,r=e+" अक्षर को हटा दें";return e>1&&(r=e+" अक्षरों को हटा दें "),r},inputTooShort:function(n){return"कृपया "+(n.minimum-n.input.length)+" या अधिक अक्षर दर्ज करें"},loadingMore:function(){return"अधिक परिणाम लोड हो रहे है..."},maximumSelected:function(n){return"आप केवल "+n.maximum+" आइटम का चयन कर सकते हैं"},noResults:function(){return"कोई परिणाम नहीं मिला"},searching:function(){return"खोज रहा है..."},removeAllItems:function(){return"सभी वस्तुओं को हटा दें"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/af.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/af",[],function(){return{errorLoading:function(){return"Die resultate kon nie gelaai word nie."},inputTooLong:function(e){var n=e.input.length-e.maximum,r="Verwyders asseblief "+n+" character";return 1!=n&&(r+="s"),r},inputTooShort:function(e){return"Voer asseblief "+(e.minimum-e.input.length)+" of meer karakters"},loadingMore:function(){return"Meer resultate word gelaai…"},maximumSelected:function(e){var n="Kies asseblief net "+e.maximum+" item";return 1!=e.maximum&&(n+="s"),n},noResults:function(){return"Geen resultate gevind"},searching:function(){return"Besig…"},removeAllItems:function(){return"Verwyder alle items"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/az.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/az",[],function(){return{inputTooLong:function(n){return n.input.length-n.maximum+" simvol silin"},inputTooShort:function(n){return n.minimum-n.input.length+" simvol daxil edin"},loadingMore:function(){return"Daha çox nəticə yüklənir…"},maximumSelected:function(n){return"Sadəcə "+n.maximum+" element seçə bilərsiniz"},noResults:function(){return"Nəticə tapılmadı"},searching:function(){return"Axtarılır…"},removeAllItems:function(){return"Bütün elementləri sil"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/el.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/el",[],function(){return{errorLoading:function(){return"Τα αποτελέσματα δεν μπόρεσαν να φορτώσουν."},inputTooLong:function(n){var e=n.input.length-n.maximum,u="Παρακαλώ διαγράψτε "+e+" χαρακτήρ";return 1==e&&(u+="α"),1!=e&&(u+="ες"),u},inputTooShort:function(n){return"Παρακαλώ συμπληρώστε "+(n.minimum-n.input.length)+" ή περισσότερους χαρακτήρες"},loadingMore:function(){return"Φόρτωση περισσότερων αποτελεσμάτων…"},maximumSelected:function(n){var e="Μπορείτε να επιλέξετε μόνο "+n.maximum+" επιλογ";return 1==n.maximum&&(e+="ή"),1!=n.maximum&&(e+="ές"),e},noResults:function(){return"Δεν βρέθηκαν αποτελέσματα"},searching:function(){return"Αναζήτηση…"},removeAllItems:function(){return"Καταργήστε όλα τα στοιχεία"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/nl.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/nl",[],function(){return{errorLoading:function(){return"De resultaten konden niet worden geladen."},inputTooLong:function(e){return"Gelieve "+(e.input.length-e.maximum)+" karakters te verwijderen"},inputTooShort:function(e){return"Gelieve "+(e.minimum-e.input.length)+" of meer karakters in te voeren"},loadingMore:function(){return"Meer resultaten laden…"},maximumSelected:function(e){var n=1==e.maximum?"kan":"kunnen",r="Er "+n+" maar "+e.maximum+" item";return 1!=e.maximum&&(r+="s"),r+=" worden geselecteerd"},noResults:function(){return"Geen resultaten gevonden…"},searching:function(){return"Zoeken…"},removeAllItems:function(){return"Verwijder alle items"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/fa.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/fa",[],function(){return{errorLoading:function(){return"امکان بارگذاری نتایج وجود ندارد."},inputTooLong:function(n){return"لطفاً "+(n.input.length-n.maximum)+" کاراکتر را حذف نمایید"},inputTooShort:function(n){return"لطفاً تعداد "+(n.minimum-n.input.length)+" کاراکتر یا بیشتر وارد نمایید"},loadingMore:function(){return"در حال بارگذاری نتایج بیشتر..."},maximumSelected:function(n){return"شما تنها می‌توانید "+n.maximum+" آیتم را انتخاب نمایید"},noResults:function(){return"هیچ نتیجه‌ای یافت نشد"},searching:function(){return"در حال جستجو..."},removeAllItems:function(){return"همه موارد را حذف کنید"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/hy.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/hy",[],function(){return{errorLoading:function(){return"Արդյունքները հնարավոր չէ բեռնել։"},inputTooLong:function(n){return"Խնդրում ենք հեռացնել "+(n.input.length-n.maximum)+" նշան"},inputTooShort:function(n){return"Խնդրում ենք մուտքագրել "+(n.minimum-n.input.length)+" կամ ավել նշաններ"},loadingMore:function(){return"Բեռնվում են նոր արդյունքներ․․․"},maximumSelected:function(n){return"Դուք կարող եք ընտրել առավելագույնը "+n.maximum+" կետ"},noResults:function(){return"Արդյունքներ չեն գտնվել"},searching:function(){return"Որոնում․․․"},removeAllItems:function(){return"Հեռացնել բոլոր տարրերը"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/bs.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/bs",[],function(){function e(e,n,r,t){return e%10==1&&e%100!=11?n:e%10>=2&&e%10<=4&&(e%100<12||e%100>14)?r:t}return{errorLoading:function(){return"Preuzimanje nije uspijelo."},inputTooLong:function(n){var r=n.input.length-n.maximum,t="Obrišite "+r+" simbol";return t+=e(r,"","a","a")},inputTooShort:function(n){var r=n.minimum-n.input.length,t="Ukucajte bar još "+r+" simbol";return t+=e(r,"","a","a")},loadingMore:function(){return"Preuzimanje još rezultata…"},maximumSelected:function(n){var r="Možete izabrati samo "+n.maximum+" stavk";return r+=e(n.maximum,"u","e","i")},noResults:function(){return"Ništa nije pronađeno"},searching:function(){return"Pretraga…"},removeAllItems:function(){return"Uklonite sve stavke"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/pt.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/pt",[],function(){return{errorLoading:function(){return"Os resultados não puderam ser carregados."},inputTooLong:function(e){var r=e.input.length-e.maximum,n="Por favor apague "+r+" ";return n+=1!=r?"caracteres":"caractere"},inputTooShort:function(e){return"Introduza "+(e.minimum-e.input.length)+" ou mais caracteres"},loadingMore:function(){return"A carregar mais resultados…"},maximumSelected:function(e){var r="Apenas pode seleccionar "+e.maximum+" ";return r+=1!=e.maximum?"itens":"item"},noResults:function(){return"Sem resultados"},searching:function(){return"A procurar…"},removeAllItems:function(){return"Remover todos os itens"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/fr.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/fr",[],function(){return{errorLoading:function(){return"Les résultats ne peuvent pas être chargés."},inputTooLong:function(e){var n=e.input.length-e.maximum;return"Supprimez "+n+" caractère"+(n>1?"s":"")},inputTooShort:function(e){var n=e.minimum-e.input.length;return"Saisissez au moins "+n+" caractère"+(n>1?"s":"")},loadingMore:function(){return"Chargement de résultats supplémentaires…"},maximumSelected:function(e){return"Vous pouvez seulement sélectionner "+e.maximum+" élément"+(e.maximum>1?"s":"")},noResults:function(){return"Aucun résultat trouvé"},searching:function(){return"Recherche en cours…"},removeAllItems:function(){return"Supprimer tous les éléments"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/gl.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/gl",[],function(){return{errorLoading:function(){return"Non foi posíbel cargar os resultados."},inputTooLong:function(e){var n=e.input.length-e.maximum;return 1===n?"Elimine un carácter":"Elimine "+n+" caracteres"},inputTooShort:function(e){var n=e.minimum-e.input.length;return 1===n?"Engada un carácter":"Engada "+n+" caracteres"},loadingMore:function(){return"Cargando máis resultados…"},maximumSelected:function(e){return 1===e.maximum?"Só pode seleccionar un elemento":"Só pode seleccionar "+e.maximum+" elementos"},noResults:function(){return"Non se atoparon resultados"},searching:function(){return"Buscando…"},removeAllItems:function(){return"Elimina todos os elementos"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/hsb.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/hsb",[],function(){var n=["znamješko","znamješce","znamješka","znamješkow"],e=["zapisk","zapiskaj","zapiski","zapiskow"],u=function(n,e){return 1===n?e[0]:2===n?e[1]:n>2&&n<=4?e[2]:n>=5?e[3]:void 0};return{errorLoading:function(){return"Wuslědki njedachu so začitać."},inputTooLong:function(e){var a=e.input.length-e.maximum;return"Prošu zhašej "+a+" "+u(a,n)},inputTooShort:function(e){var a=e.minimum-e.input.length;return"Prošu zapodaj znajmjeńša "+a+" "+u(a,n)},loadingMore:function(){return"Dalše wuslědki so začitaja…"},maximumSelected:function(n){return"Móžeš jenož "+n.maximum+" "+u(n.maximum,e)+"wubrać"},noResults:function(){return"Žane wuslědki namakane"},searching:function(){return"Pyta so…"},removeAllItems:function(){return"Remove all items"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/en.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/en",[],function(){return{errorLoading:function(){return"The results could not be loaded."},inputTooLong:function(e){var n=e.input.length-e.maximum,r="Please delete "+n+" character";return 1!=n&&(r+="s"),r},inputTooShort:function(e){return"Please enter "+(e.minimum-e.input.length)+" or more characters"},loadingMore:function(){return"Loading more results…"},maximumSelected:function(e){var n="You can only select "+e.maximum+" item";return 1!=e.maximum&&(n+="s"),n},noResults:function(){return"No results found"},searching:function(){return"Searching…"},removeAllItems:function(){return"Remove all items"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/lt.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/lt",[],function(){function n(n,e,i,t){return n%10==1&&(n%100<11||n%100>19)?e:n%10>=2&&n%10<=9&&(n%100<11||n%100>19)?i:t}return{inputTooLong:function(e){var i=e.input.length-e.maximum,t="Pašalinkite "+i+" simbol";return t+=n(i,"į","ius","ių")},inputTooShort:function(e){var i=e.minimum-e.input.length,t="Įrašykite dar "+i+" simbol";return t+=n(i,"į","ius","ių")},loadingMore:function(){return"Kraunama daugiau rezultatų…"},maximumSelected:function(e){var i="Jūs galite pasirinkti tik "+e.maximum+" element";return i+=n(e.maximum,"ą","us","ų")},noResults:function(){return"Atitikmenų nerasta"},searching:function(){return"Ieškoma…"},removeAllItems:function(){return"Pašalinti visus elementus"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/ne.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/ne",[],function(){return{errorLoading:function(){return"नतिजाहरु देखाउन सकिएन।"},inputTooLong:function(n){var e=n.input.length-n.maximum,u="कृपया "+e+" अक्षर मेटाउनुहोस्।";return 1!=e&&(u+="कृपया "+e+" अक्षरहरु मेटाउनुहोस्।"),u},inputTooShort:function(n){return"कृपया बाँकी रहेका "+(n.minimum-n.input.length)+" वा अरु धेरै अक्षरहरु भर्नुहोस्।"},loadingMore:function(){return"अरु नतिजाहरु भरिँदैछन् …"},maximumSelected:function(n){var e="तँपाई "+n.maximum+" वस्तु मात्र छान्न पाउँनुहुन्छ।";return 1!=n.maximum&&(e="तँपाई "+n.maximum+" वस्तुहरु मात्र छान्न पाउँनुहुन्छ।"),e},noResults:function(){return"कुनै पनि नतिजा भेटिएन।"},searching:function(){return"खोजि हुँदैछ…"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/sr-Cyrl.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/sr-Cyrl",[],function(){function n(n,e,r,u){return n%10==1&&n%100!=11?e:n%10>=2&&n%10<=4&&(n%100<12||n%100>14)?r:u}return{errorLoading:function(){return"Преузимање није успело."},inputTooLong:function(e){var r=e.input.length-e.maximum,u="Обришите "+r+" симбол";return u+=n(r,"","а","а")},inputTooShort:function(e){var r=e.minimum-e.input.length,u="Укуцајте бар још "+r+" симбол";return u+=n(r,"","а","а")},loadingMore:function(){return"Преузимање још резултата…"},maximumSelected:function(e){var r="Можете изабрати само "+e.maximum+" ставк";return r+=n(e.maximum,"у","е","и")},noResults:function(){return"Ништа није пронађено"},searching:function(){return"Претрага…"},removeAllItems:function(){return"Уклоните све ставке"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/et.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/et",[],function(){return{inputTooLong:function(e){var n=e.input.length-e.maximum,t="Sisesta "+n+" täht";return 1!=n&&(t+="e"),t+=" vähem"},inputTooShort:function(e){var n=e.minimum-e.input.length,t="Sisesta "+n+" täht";return 1!=n&&(t+="e"),t+=" rohkem"},loadingMore:function(){return"Laen tulemusi…"},maximumSelected:function(e){var n="Saad vaid "+e.maximum+" tulemus";return 1==e.maximum?n+="e":n+="t",n+=" valida"},noResults:function(){return"Tulemused puuduvad"},searching:function(){return"Otsin…"},removeAllItems:function(){return"Eemalda kõik esemed"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/km.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/km",[],function(){return{errorLoading:function(){return"មិនអាចទាញយកទិន្នន័យ"},inputTooLong:function(n){return"សូមលុបចេញ  "+(n.input.length-n.maximum)+" អក្សរ"},inputTooShort:function(n){return"សូមបញ្ចូល"+(n.minimum-n.input.length)+" អក្សរ រឺ ច្រើនជាងនេះ"},loadingMore:function(){return"កំពុងទាញយកទិន្នន័យបន្ថែម..."},maximumSelected:function(n){return"អ្នកអាចជ្រើសរើសបានតែ "+n.maximum+" ជម្រើសប៉ុណ្ណោះ"},noResults:function(){return"មិនមានលទ្ធផល"},searching:function(){return"កំពុងស្វែងរក..."},removeAllItems:function(){return"លុបធាតុទាំងអស់"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/ka.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/ka",[],function(){return{errorLoading:function(){return"მონაცემების ჩატვირთვა შეუძლებელია."},inputTooLong:function(n){return"გთხოვთ აკრიფეთ "+(n.input.length-n.maximum)+" სიმბოლოთი ნაკლები"},inputTooShort:function(n){return"გთხოვთ აკრიფეთ "+(n.minimum-n.input.length)+" სიმბოლო ან მეტი"},loadingMore:function(){return"მონაცემების ჩატვირთვა…"},maximumSelected:function(n){return"თქვენ შეგიძლიათ აირჩიოთ არაუმეტეს "+n.maximum+" ელემენტი"},noResults:function(){return"რეზულტატი არ მოიძებნა"},searching:function(){return"ძიება…"},removeAllItems:function(){return"ამოიღე ყველა ელემენტი"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/ms.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/ms",[],function(){return{errorLoading:function(){return"Keputusan tidak berjaya dimuatkan."},inputTooLong:function(n){return"Sila hapuskan "+(n.input.length-n.maximum)+" aksara"},inputTooShort:function(n){return"Sila masukkan "+(n.minimum-n.input.length)+" atau lebih aksara"},loadingMore:function(){return"Sedang memuatkan keputusan…"},maximumSelected:function(n){return"Anda hanya boleh memilih "+n.maximum+" pilihan"},noResults:function(){return"Tiada padanan yang ditemui"},searching:function(){return"Mencari…"},removeAllItems:function(){return"Keluarkan semua item"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/vi.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/vi",[],function(){return{inputTooLong:function(n){return"Vui lòng xóa bớt "+(n.input.length-n.maximum)+" ký tự"},inputTooShort:function(n){return"Vui lòng nhập thêm từ "+(n.minimum-n.input.length)+" ký tự trở lên"},loadingMore:function(){return"Đang lấy thêm kết quả…"},maximumSelected:function(n){return"Chỉ có thể chọn được "+n.maximum+" lựa chọn"},noResults:function(){return"Không tìm thấy kết quả"},searching:function(){return"Đang tìm…"},removeAllItems:function(){return"Xóa tất cả các mục"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/de.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/de",[],function(){return{errorLoading:function(){return"Die Ergebnisse konnten nicht geladen werden."},inputTooLong:function(e){return"Bitte "+(e.input.length-e.maximum)+" Zeichen weniger eingeben"},inputTooShort:function(e){return"Bitte "+(e.minimum-e.input.length)+" Zeichen mehr eingeben"},loadingMore:function(){return"Lade mehr Ergebnisse…"},maximumSelected:function(e){var n="Sie können nur "+e.maximum+" Element";return 1!=e.maximum&&(n+="e"),n+=" auswählen"},noResults:function(){return"Keine Übereinstimmungen gefunden"},searching:function(){return"Suche…"},removeAllItems:function(){return"Entferne alle Elemente"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/ja.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/ja",[],function(){return{errorLoading:function(){return"結果が読み込まれませんでした"},inputTooLong:function(n){return n.input.length-n.maximum+" 文字を削除してください"},inputTooShort:function(n){return"少なくとも "+(n.minimum-n.input.length)+" 文字を入力してください"},loadingMore:function(){return"読み込み中…"},maximumSelected:function(n){return n.maximum+" 件しか選択できません"},noResults:function(){return"対象が見つかりません"},searching:function(){return"検索しています…"},removeAllItems:function(){return"すべてのアイテムを削除"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/sk.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/sk",[],function(){var e={2:function(e){return e?"dva":"dve"},3:function(){return"tri"},4:function(){return"štyri"}};return{errorLoading:function(){return"Výsledky sa nepodarilo načítať."},inputTooLong:function(n){var t=n.input.length-n.maximum;return 1==t?"Prosím, zadajte o jeden znak menej":t>=2&&t<=4?"Prosím, zadajte o "+e[t](!0)+" znaky menej":"Prosím, zadajte o "+t+" znakov menej"},inputTooShort:function(n){var t=n.minimum-n.input.length;return 1==t?"Prosím, zadajte ešte jeden znak":t<=4?"Prosím, zadajte ešte ďalšie "+e[t](!0)+" znaky":"Prosím, zadajte ešte ďalších "+t+" znakov"},loadingMore:function(){return"Načítanie ďalších výsledkov…"},maximumSelected:function(n){return 1==n.maximum?"Môžete zvoliť len jednu položku":n.maximum>=2&&n.maximum<=4?"Môžete zvoliť najviac "+e[n.maximum](!1)+" položky":"Môžete zvoliť najviac "+n.maximum+" položiek"},noResults:function(){return"Nenašli sa žiadne položky"},searching:function(){return"Vyhľadávanie…"},removeAllItems:function(){return"Odstráňte všetky položky"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/ko.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/ko",[],function(){return{errorLoading:function(){return"결과를 불러올 수 없습니다."},inputTooLong:function(n){return"너무 깁니다. "+(n.input.length-n.maximum)+" 글자 지워주세요."},inputTooShort:function(n){return"너무 짧습니다. "+(n.minimum-n.input.length)+" 글자 더 입력해주세요."},loadingMore:function(){return"불러오는 중…"},maximumSelected:function(n){return"최대 "+n.maximum+"개까지만 선택 가능합니다."},noResults:function(){return"결과가 없습니다."},searching:function(){return"검색 중…"},removeAllItems:function(){return"모든 항목 삭제"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/it.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/it",[],function(){return{errorLoading:function(){return"I risultati non possono essere caricati."},inputTooLong:function(e){var n=e.input.length-e.maximum,t="Per favore cancella "+n+" caratter";return t+=1!==n?"i":"e"},inputTooShort:function(e){return"Per favore inserisci "+(e.minimum-e.input.length)+" o più caratteri"},loadingMore:function(){return"Caricando più risultati…"},maximumSelected:function(e){var n="Puoi selezionare solo "+e.maximum+" element";return 1!==e.maximum?n+="i":n+="o",n},noResults:function(){return"Nessun risultato trovato"},searching:function(){return"Sto cercando…"},removeAllItems:function(){return"Rimuovi tutti gli oggetti"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/fi.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/fi",[],function(){return{errorLoading:function(){return"Tuloksia ei saatu ladattua."},inputTooLong:function(n){return"Ole hyvä ja anna "+(n.input.length-n.maximum)+" merkkiä vähemmän"},inputTooShort:function(n){return"Ole hyvä ja anna "+(n.minimum-n.input.length)+" merkkiä lisää"},loadingMore:function(){return"Ladataan lisää tuloksia…"},maximumSelected:function(n){return"Voit valita ainoastaan "+n.maximum+" kpl"},noResults:function(){return"Ei tuloksia"},searching:function(){return"Haetaan…"},removeAllItems:function(){return"Poista kaikki kohteet"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/hr.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/hr",[],function(){function n(n){var e=" "+n+" znak";return n%10<5&&n%10>0&&(n%100<5||n%100>19)?n%10>1&&(e+="a"):e+="ova",e}return{errorLoading:function(){return"Preuzimanje nije uspjelo."},inputTooLong:function(e){return"Unesite "+n(e.input.length-e.maximum)},inputTooShort:function(e){return"Unesite još "+n(e.minimum-e.input.length)},loadingMore:function(){return"Učitavanje rezultata…"},maximumSelected:function(n){return"Maksimalan broj odabranih stavki je "+n.maximum},noResults:function(){return"Nema rezultata"},searching:function(){return"Pretraga…"},removeAllItems:function(){return"Ukloni sve stavke"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/es.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var e=jQuery.fn.select2.amd;e.define("select2/i18n/es",[],function(){return{errorLoading:function(){return"No se pudieron cargar los resultados"},inputTooLong:function(e){var n=e.input.length-e.maximum,r="Por favor, elimine "+n+" car";return r+=1==n?"ácter":"acteres"},inputTooShort:function(e){var n=e.minimum-e.input.length,r="Por favor, introduzca "+n+" car";return r+=1==n?"ácter":"acteres"},loadingMore:function(){return"Cargando más resultados…"},maximumSelected:function(e){var n="Sólo puede seleccionar "+e.maximum+" elemento";return 1!=e.maximum&&(n+="s"),n},noResults:function(){return"No se encontraron resultados"},searching:function(){return"Buscando…"},removeAllItems:function(){return"Eliminar todos los elementos"}}}),e.define,e.require}();


========== staticfiles/admin/js/vendor/select2/i18n/zh-TW.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/zh-TW",[],function(){return{inputTooLong:function(n){return"請刪掉"+(n.input.length-n.maximum)+"個字元"},inputTooShort:function(n){return"請再輸入"+(n.minimum-n.input.length)+"個字元"},loadingMore:function(){return"載入中…"},maximumSelected:function(n){return"你只能選擇最多"+n.maximum+"項"},noResults:function(){return"沒有找到相符的項目"},searching:function(){return"搜尋中…"},removeAllItems:function(){return"刪除所有項目"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/th.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/th",[],function(){return{errorLoading:function(){return"ไม่สามารถค้นข้อมูลได้"},inputTooLong:function(n){return"โปรดลบออก "+(n.input.length-n.maximum)+" ตัวอักษร"},inputTooShort:function(n){return"โปรดพิมพ์เพิ่มอีก "+(n.minimum-n.input.length)+" ตัวอักษร"},loadingMore:function(){return"กำลังค้นข้อมูลเพิ่ม…"},maximumSelected:function(n){return"คุณสามารถเลือกได้ไม่เกิน "+n.maximum+" รายการ"},noResults:function(){return"ไม่พบข้อมูล"},searching:function(){return"กำลังค้นข้อมูล…"},removeAllItems:function(){return"ลบรายการทั้งหมด"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/tr.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/tr",[],function(){return{errorLoading:function(){return"Sonuç yüklenemedi"},inputTooLong:function(n){return n.input.length-n.maximum+" karakter daha girmelisiniz"},inputTooShort:function(n){return"En az "+(n.minimum-n.input.length)+" karakter daha girmelisiniz"},loadingMore:function(){return"Daha fazla…"},maximumSelected:function(n){return"Sadece "+n.maximum+" seçim yapabilirsiniz"},noResults:function(){return"Sonuç bulunamadı"},searching:function(){return"Aranıyor…"},removeAllItems:function(){return"Tüm öğeleri kaldır"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/select2/i18n/ps.js ==========
/*! Select2 4.0.13 | https://github.com/select2/select2/blob/master/LICENSE.md */

!function(){if(jQuery&&jQuery.fn&&jQuery.fn.select2&&jQuery.fn.select2.amd)var n=jQuery.fn.select2.amd;n.define("select2/i18n/ps",[],function(){return{errorLoading:function(){return"پايلي نه سي ترلاسه کېدای"},inputTooLong:function(n){var e=n.input.length-n.maximum,r="د مهربانۍ لمخي "+e+" توری ړنګ کړئ";return 1!=e&&(r=r.replace("توری","توري")),r},inputTooShort:function(n){return"لږ تر لږه "+(n.minimum-n.input.length)+" يا ډېر توري وليکئ"},loadingMore:function(){return"نوري پايلي ترلاسه کيږي..."},maximumSelected:function(n){var e="تاسو يوازي "+n.maximum+" قلم په نښه کولای سی";return 1!=n.maximum&&(e=e.replace("قلم","قلمونه")),e},noResults:function(){return"پايلي و نه موندل سوې"},searching:function(){return"لټول کيږي..."},removeAllItems:function(){return"ټول توکي لرې کړئ"}}}),n.define,n.require}();


========== staticfiles/admin/js/vendor/xregexp/xregexp.min.js ==========
!function(u){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=u();else if("function"==typeof define&&define.amd)define([],u);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).XRegExp=u()}}((function(){return function r(u,d,t){function o(c,i){if(!d[c]){if(!u[c]){var l="function"==typeof require&&require;if(!i&&l)return l(c,!0);if(a)return a(c,!0);var D=new Error("Cannot find module '"+c+"'");throw D.code="MODULE_NOT_FOUND",D}var p=d[c]={exports:{}};u[c][0].call(p.exports,(function(d){return o(u[c][1][d]||d)}),p,p.exports,r,u,d,t)}return d[c].exports}for(var a="function"==typeof require&&require,c=0;c<t.length;c++)o(t[c]);return o}({1:[function(u,d,t){"use strict";var a=u("@babel/runtime-corejs3/core-js-stable/instance/slice"),c=u("@babel/runtime-corejs3/core-js-stable/array/from"),i=u("@babel/runtime-corejs3/core-js-stable/symbol"),l=u("@babel/runtime-corejs3/core-js/get-iterator-method"),D=u("@babel/runtime-corejs3/core-js-stable/array/is-array"),p=u("@babel/runtime-corejs3/core-js-stable/object/define-property"),b=u("@babel/runtime-corejs3/helpers/interopRequireDefault");p(t,"__esModule",{value:!0}),t.default=void 0;var y=b(u("@babel/runtime-corejs3/helpers/slicedToArray")),m=b(u("@babel/runtime-corejs3/core-js-stable/instance/for-each")),A=b(u("@babel/runtime-corejs3/core-js-stable/instance/concat")),E=b(u("@babel/runtime-corejs3/core-js-stable/instance/index-of"));function _createForOfIteratorHelper(u,d){var t=void 0!==i&&l(u)||u["@@iterator"];if(!t){if(D(u)||(t=function _unsupportedIterableToArray(u,d){var t;if(!u)return;if("string"==typeof u)return _arrayLikeToArray(u,d);var i=a(t=Object.prototype.toString.call(u)).call(t,8,-1);"Object"===i&&u.constructor&&(i=u.constructor.name);if("Map"===i||"Set"===i)return c(u);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return _arrayLikeToArray(u,d)}(u))||d&&u&&"number"==typeof u.length){t&&(u=t);var p=0,b=function F(){};return{s:b,n:function n(){return p>=u.length?{done:!0}:{done:!1,value:u[p++]}},e:function e(u){throw u},f:b}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var y,m=!0,A=!1;return{s:function s(){t=t.call(u)},n:function n(){var u=t.next();return m=u.done,u},e:function e(u){A=!0,y=u},f:function f(){try{m||null==t.return||t.return()}finally{if(A)throw y}}}}function _arrayLikeToArray(u,d){(null==d||d>u.length)&&(d=u.length);for(var t=0,a=new Array(d);t<d;t++)a[t]=u[t];return a}
/*!
 * XRegExp Unicode Base 5.1.1
 * <xregexp.com>
 * Steven Levithan (c) 2008-present MIT License
 */t.default=function _default(u){var d={},t={},a=u._dec,c=u._hex,i=u._pad4;function normalize(u){return u.replace(/[- _]+/g,"").toLowerCase()}function charCode(u){var d=/^\\[xu](.+)/.exec(u);return d?a(d[1]):u.charCodeAt("\\"===u[0]?1:0)}function cacheInvertedBmp(t){return d[t]["b!"]||(d[t]["b!"]=function invertBmp(d){var t="",a=-1;return(0,m.default)(u).call(u,d,/(\\x..|\\u....|\\?[\s\S])(?:-(\\x..|\\u....|\\?[\s\S]))?/,(function(u){var d=charCode(u[1]);d>a+1&&(t+="\\u".concat(i(c(a+1))),d>a+2&&(t+="-\\u".concat(i(c(d-1))))),a=charCode(u[2]||u[1])})),a<65535&&(t+="\\u".concat(i(c(a+1))),a<65534&&(t+="-\\uFFFF")),t}(d[t].bmp))}function cacheAstral(u,t){var a=t?"a!":"a=";return d[u][a]||(d[u][a]=function buildAstral(u,t){var a,c,i=d[u],l="";return i.bmp&&!i.isBmpLast&&(l=(0,A.default)(a="[".concat(i.bmp,"]")).call(a,i.astral?"|":"")),i.astral&&(l+=i.astral),i.isBmpLast&&i.bmp&&(l+=(0,A.default)(c="".concat(i.astral?"|":"","[")).call(c,i.bmp,"]")),t?"(?:(?!".concat(l,")(?:[\ud800-\udbff][\udc00-\udfff]|[\0-￿]))"):"(?:".concat(l,")")}(u,t))}u.addToken(/\\([pP])(?:{(\^?)(?:(\w+)=)?([^}]*)}|([A-Za-z]))/,(function(u,a,c){var i="Unknown Unicode token ",l=(0,y.default)(u,6),D=l[0],p=l[1],b=l[2],m=l[3],C=l[4],g=l[5],h="P"===p||!!b,x=-1!==(0,E.default)(c).call(c,"A"),v=normalize(g||C),B=d[v];if("P"===p&&b)throw new SyntaxError("Invalid double negation "+D);if(!d.hasOwnProperty(v))throw new SyntaxError(i+D);if(m&&(!t[m]||!t[m][v]))throw new SyntaxError(i+D);if(B.inverseOf){var w;if(v=normalize(B.inverseOf),!d.hasOwnProperty(v))throw new ReferenceError((0,A.default)(w="".concat("Unicode token missing data "+D," -> ")).call(w,B.inverseOf));B=d[v],h=!h}if(!B.bmp&&!x)throw new SyntaxError("Astral mode required for Unicode token "+D);if(x){if("class"===a)throw new SyntaxError("Astral mode does not support Unicode tokens within character classes");return cacheAstral(v,h)}return"class"===a?h?cacheInvertedBmp(v):B.bmp:"".concat((h?"[^":"[")+B.bmp,"]")}),{scope:"all",optionalFlags:"A",leadChar:"\\"}),u.addUnicodeData=function(a,c){c&&(t[c]={});var i,l=_createForOfIteratorHelper(a);try{for(l.s();!(i=l.n()).done;){var D=i.value;if(!D.name)throw new Error("Unicode token requires name");if(!(D.inverseOf||D.bmp||D.astral))throw new Error("Unicode token has no character data "+D.name);var p=normalize(D.name);if(d[p]=D,c&&(t[c][p]=!0),D.alias){var b=normalize(D.alias);d[b]=D,c&&(t[c][b]=!0)}}}catch(u){l.e(u)}finally{l.f()}u.cache.flush("patterns")},u._getUnicodeProperty=function(u){var t=normalize(u);return d[t]}},d.exports=t.default},{"@babel/runtime-corejs3/core-js-stable/array/from":5,"@babel/runtime-corejs3/core-js-stable/array/is-array":6,"@babel/runtime-corejs3/core-js-stable/instance/concat":7,"@babel/runtime-corejs3/core-js-stable/instance/for-each":9,"@babel/runtime-corejs3/core-js-stable/instance/index-of":10,"@babel/runtime-corejs3/core-js-stable/instance/slice":11,"@babel/runtime-corejs3/core-js-stable/object/define-property":14,"@babel/runtime-corejs3/core-js-stable/symbol":16,"@babel/runtime-corejs3/core-js/get-iterator-method":19,"@babel/runtime-corejs3/helpers/interopRequireDefault":24,"@babel/runtime-corejs3/helpers/slicedToArray":27}],2:[function(u,d,t){"use strict";var a=u("@babel/runtime-corejs3/core-js-stable/object/define-property"),c=u("@babel/runtime-corejs3/helpers/interopRequireDefault");a(t,"__esModule",{value:!0}),t.default=void 0;var i=c(u("../../tools/output/categories"));
/*!
 * XRegExp Unicode Categories 5.1.1
 * <xregexp.com>
 * Steven Levithan (c) 2010-present MIT License
 * Unicode data by Mathias Bynens <mathiasbynens.be>
 */t.default=function _default(u){if(!u.addUnicodeData)throw new ReferenceError("Unicode Base must be loaded before Unicode Categories");u.addUnicodeData(i.default)},d.exports=t.default},{"../../tools/output/categories":222,"@babel/runtime-corejs3/core-js-stable/object/define-property":14,"@babel/runtime-corejs3/helpers/interopRequireDefault":24}],3:[function(u,d,t){"use strict";var a=u("@babel/runtime-corejs3/core-js-stable/object/define-property"),c=u("@babel/runtime-corejs3/helpers/interopRequireDefault");a(t,"__esModule",{value:!0}),t.default=void 0;var i=c(u("./xregexp")),l=c(u("./addons/unicode-base")),D=c(u("./addons/unicode-categories"));(0,l.default)(i.default),(0,D.default)(i.default);var p=i.default;t.default=p,d.exports=t.default},{"./addons/unicode-base":1,"./addons/unicode-categories":2,"./xregexp":4,"@babel/runtime-corejs3/core-js-stable/object/define-property":14,"@babel/runtime-corejs3/helpers/interopRequireDefault":24}],4:[function(u,d,t){"use strict";var a=u("@babel/runtime-corejs3/core-js-stable/instance/slice"),c=u("@babel/runtime-corejs3/core-js-stable/array/from"),i=u("@babel/runtime-corejs3/core-js-stable/symbol"),l=u("@babel/runtime-corejs3/core-js/get-iterator-method"),D=u("@babel/runtime-corejs3/core-js-stable/array/is-array"),p=u("@babel/runtime-corejs3/core-js-stable/object/define-property"),b=u("@babel/runtime-corejs3/helpers/interopRequireDefault");p(t,"__esModule",{value:!0}),t.default=void 0;var y=b(u("@babel/runtime-corejs3/helpers/slicedToArray")),m=b(u("@babel/runtime-corejs3/core-js-stable/instance/flags")),A=b(u("@babel/runtime-corejs3/core-js-stable/instance/sort")),E=b(u("@babel/runtime-corejs3/core-js-stable/instance/slice")),C=b(u("@babel/runtime-corejs3/core-js-stable/parse-int")),g=b(u("@babel/runtime-corejs3/core-js-stable/instance/index-of")),h=b(u("@babel/runtime-corejs3/core-js-stable/instance/for-each")),x=b(u("@babel/runtime-corejs3/core-js-stable/object/create")),v=b(u("@babel/runtime-corejs3/core-js-stable/instance/concat"));function _createForOfIteratorHelper(u,d){var t=void 0!==i&&l(u)||u["@@iterator"];if(!t){if(D(u)||(t=function _unsupportedIterableToArray(u,d){var t;if(!u)return;if("string"==typeof u)return _arrayLikeToArray(u,d);var i=a(t=Object.prototype.toString.call(u)).call(t,8,-1);"Object"===i&&u.constructor&&(i=u.constructor.name);if("Map"===i||"Set"===i)return c(u);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return _arrayLikeToArray(u,d)}(u))||d&&u&&"number"==typeof u.length){t&&(u=t);var p=0,b=function F(){};return{s:b,n:function n(){return p>=u.length?{done:!0}:{done:!1,value:u[p++]}},e:function e(u){throw u},f:b}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var y,m=!0,A=!1;return{s:function s(){t=t.call(u)},n:function n(){var u=t.next();return m=u.done,u},e:function e(u){A=!0,y=u},f:function f(){try{m||null==t.return||t.return()}finally{if(A)throw y}}}}function _arrayLikeToArray(u,d){(null==d||d>u.length)&&(d=u.length);for(var t=0,a=new Array(d);t<d;t++)a[t]=u[t];return a}
/*!
 * XRegExp 5.1.1
 * <xregexp.com>
 * Steven Levithan (c) 2007-present MIT License
 */var B={astral:!1,namespacing:!0},w={},j={},k={},S=[],O="default",R="class",_={default:/\\(?:0(?:[0-3][0-7]{0,2}|[4-7][0-7]?)?|[1-9]\d*|x[\dA-Fa-f]{2}|u(?:[\dA-Fa-f]{4}|{[\dA-Fa-f]+})|c[A-Za-z]|[\s\S])|\(\?(?:[:=!]|<[=!])|[?*+]\?|{\d+(?:,\d*)?}\??|[\s\S]/,class:/\\(?:[0-3][0-7]{0,2}|[4-7][0-7]?|x[\dA-Fa-f]{2}|u(?:[\dA-Fa-f]{4}|{[\dA-Fa-f]+})|c[A-Za-z]|[\s\S])|[\s\S]/},T=/\$(?:\{([^\}]+)\}|<([^>]+)>|(\d\d?|[\s\S]?))/g,I=void 0===/()??/.exec("")[1],P=void 0!==(0,m.default)(/x/);function hasNativeFlag(u){var d=!0;try{if(new RegExp("",u),"y"===u){".."===".a".replace(new RegExp("a","gy"),".")&&(d=!1)}}catch(u){d=!1}return d}var X=hasNativeFlag("d"),L=hasNativeFlag("s"),N=hasNativeFlag("u"),M=hasNativeFlag("y"),U={d:X,g:!0,i:!0,m:!0,s:L,u:N,y:M},G=L?/[^dgimsuy]+/g:/[^dgimuy]+/g;function augment(u,d,t,a,c){var i;if(u.xregexp={captureNames:d},c)return u;if(u.__proto__)u.__proto__=XRegExp.prototype;else for(var l in XRegExp.prototype)u[l]=XRegExp.prototype[l];return u.xregexp.source=t,u.xregexp.flags=a?(0,A.default)(i=a.split("")).call(i).join(""):a,u}function clipDuplicates(u){return u.replace(/([\s\S])(?=[\s\S]*\1)/g,"")}function copyRegex(u,d){var t;if(!XRegExp.isRegExp(u))throw new TypeError("Type RegExp expected");var a=u.xregexp||{},c=function getNativeFlags(u){return P?(0,m.default)(u):/\/([a-z]*)$/i.exec(RegExp.prototype.toString.call(u))[1]}(u),i="",l="",D=null,p=null;return(d=d||{}).removeG&&(l+="g"),d.removeY&&(l+="y"),l&&(c=c.replace(new RegExp("[".concat(l,"]+"),"g"),"")),d.addG&&(i+="g"),d.addY&&(i+="y"),i&&(c=clipDuplicates(c+i)),d.isInternalOnly||(void 0!==a.source&&(D=a.source),null!=(0,m.default)(a)&&(p=i?clipDuplicates((0,m.default)(a)+i):(0,m.default)(a))),u=augment(new RegExp(d.source||u.source,c),function hasNamedCapture(u){return!(!u.xregexp||!u.xregexp.captureNames)}(u)?(0,E.default)(t=a.captureNames).call(t,0):null,D,p,d.isInternalOnly)}function dec(u){return(0,C.default)(u,16)}function getContextualTokenSeparator(u,d,t){var a=u.index+u[0].length,c=u.input[u.index-1],i=u.input[a];return/^[()|]$/.test(c)||/^[()|]$/.test(i)||0===u.index||a===u.input.length||/\(\?(?:[:=!]|<[=!])$/.test(u.input.substring(u.index-4,u.index))||function isQuantifierNext(u,d,t){return(-1!==(0,g.default)(t).call(t,"x")?/^(?:\s|#[^#\n]*|\(\?#[^)]*\))*(?:[?*+]|{\d+(?:,\d*)?})/:/^(?:\(\?#[^)]*\))*(?:[?*+]|{\d+(?:,\d*)?})/).test((0,E.default)(u).call(u,d))}(u.input,a,t)?"":"(?:)"}function hex(u){return(0,C.default)(u,10).toString(16)}function isType(u,d){return Object.prototype.toString.call(u)==="[object ".concat(d,"]")}function nullThrows(u){if(null==u)throw new TypeError("Cannot convert null or undefined to object");return u}function pad4(u){for(;u.length<4;)u="0".concat(u);return u}function prepareOptions(u){var d={};return isType(u,"String")?((0,h.default)(XRegExp).call(XRegExp,u,/[^\s,]+/,(function(u){d[u]=!0})),d):u}function registerFlag(u){if(!/^[\w$]$/.test(u))throw new Error("Flag must be a single character A-Za-z0-9_$");U[u]=!0}function runTokens(u,d,t,a,c){for(var i,l,D=S.length,p=u[t],b=null;D--;)if(!((l=S[D]).leadChar&&l.leadChar!==p||l.scope!==a&&"all"!==l.scope||l.flag&&-1===(0,g.default)(d).call(d,l.flag))&&(i=XRegExp.exec(u,l.regex,t,"sticky"))){b={matchLength:i[0].length,output:l.handler.call(c,i,a,d),reparse:l.reparse};break}return b}function setAstral(u){B.astral=u}function setNamespacing(u){B.namespacing=u}function XRegExp(u,d){if(XRegExp.isRegExp(u)){if(void 0!==d)throw new TypeError("Cannot supply flags when copying a RegExp");return copyRegex(u)}if(u=void 0===u?"":String(u),d=void 0===d?"":String(d),XRegExp.isInstalled("astral")&&-1===(0,g.default)(d).call(d,"A")&&(d+="A"),k[u]||(k[u]={}),!k[u][d]){for(var t,a={hasNamedCapture:!1,captureNames:[]},c=O,i="",l=0,D=function prepareFlags(u,d){if(clipDuplicates(d)!==d)throw new SyntaxError("Invalid duplicate regex flag ".concat(d));u=u.replace(/^\(\?([\w$]+)\)/,(function(u,t){if(/[dgy]/.test(t))throw new SyntaxError("Cannot use flags dgy in mode modifier ".concat(u));return d=clipDuplicates(d+t),""}));var t,a=_createForOfIteratorHelper(d);try{for(a.s();!(t=a.n()).done;){var c=t.value;if(!U[c])throw new SyntaxError("Unknown regex flag ".concat(c))}}catch(u){a.e(u)}finally{a.f()}return{pattern:u,flags:d}}(u,d),p=D.pattern,b=(0,m.default)(D);l<p.length;){do{(t=runTokens(p,b,l,c,a))&&t.reparse&&(p=(0,E.default)(p).call(p,0,l)+t.output+(0,E.default)(p).call(p,l+t.matchLength))}while(t&&t.reparse);if(t)i+=t.output,l+=t.matchLength||1;else{var A=XRegExp.exec(p,_[c],l,"sticky"),C=(0,y.default)(A,1)[0];i+=C,l+=C.length,"["===C&&c===O?c=R:"]"===C&&c===R&&(c=O)}}k[u][d]={pattern:i.replace(/(?:\(\?:\))+/g,"(?:)"),flags:b.replace(G,""),captures:a.hasNamedCapture?a.captureNames:null}}var h=k[u][d];return augment(new RegExp(h.pattern,(0,m.default)(h)),h.captures,u,d)}XRegExp.prototype=/(?:)/,XRegExp.version="5.1.1",XRegExp._clipDuplicates=clipDuplicates,XRegExp._hasNativeFlag=hasNativeFlag,XRegExp._dec=dec,XRegExp._hex=hex,XRegExp._pad4=pad4,XRegExp.addToken=function(u,d,t){var a=(t=t||{}).optionalFlags;if(t.flag&&registerFlag(t.flag),a){var c,i=_createForOfIteratorHelper(a=a.split(""));try{for(i.s();!(c=i.n()).done;){registerFlag(c.value)}}catch(u){i.e(u)}finally{i.f()}}S.push({regex:copyRegex(u,{addG:!0,addY:M,isInternalOnly:!0}),handler:d,scope:t.scope||O,flag:t.flag,reparse:t.reparse,leadChar:t.leadChar}),XRegExp.cache.flush("patterns")},XRegExp.cache=function(u,d){return j[u]||(j[u]={}),j[u][d]||(j[u][d]=XRegExp(u,d))},XRegExp.cache.flush=function(u){"patterns"===u?k={}:j={}},XRegExp.escape=function(u){return String(nullThrows(u)).replace(/[\\\[\]{}()*+?.^$|]/g,"\\$&").replace(/[\s#\-,]/g,(function(u){return"\\u".concat(pad4(hex(u.charCodeAt(0))))}))},XRegExp.exec=function(u,d,t,a){var c,i,l="g",D=!1;(c=M&&!!(a||d.sticky&&!1!==a))?l+="y":a&&(D=!0,l+="FakeY"),d.xregexp=d.xregexp||{};var p=d.xregexp[l]||(d.xregexp[l]=copyRegex(d,{addG:!0,addY:c,source:D?"".concat(d.source,"|()"):void 0,removeY:!1===a,isInternalOnly:!0}));return t=t||0,p.lastIndex=t,i=w.exec.call(p,u),D&&i&&""===i.pop()&&(i=null),d.global&&(d.lastIndex=i?p.lastIndex:0),i},XRegExp.forEach=function(u,d,t){for(var a,c=0,i=-1;a=XRegExp.exec(u,d,c);)t(a,++i,u,d),c=a.index+(a[0].length||1)},XRegExp.globalize=function(u){return copyRegex(u,{addG:!0})},XRegExp.install=function(u){u=prepareOptions(u),!B.astral&&u.astral&&setAstral(!0),!B.namespacing&&u.namespacing&&setNamespacing(!0)},XRegExp.isInstalled=function(u){return!!B[u]},XRegExp.isRegExp=function(u){return"[object RegExp]"===Object.prototype.toString.call(u)},XRegExp.match=function(u,d,t){var a=d.global&&"one"!==t||"all"===t,c=(a?"g":"")+(d.sticky?"y":"")||"noGY";d.xregexp=d.xregexp||{};var i=d.xregexp[c]||(d.xregexp[c]=copyRegex(d,{addG:!!a,removeG:"one"===t,isInternalOnly:!0})),l=String(nullThrows(u)).match(i);return d.global&&(d.lastIndex="one"===t&&l?l.index+l[0].length:0),a?l||[]:l&&l[0]},XRegExp.matchChain=function(u,d){return function recurseChain(u,t){var a=d[t].regex?d[t]:{regex:d[t]},c=[];function addMatch(u){if(a.backref){var d="Backreference to undefined group: ".concat(a.backref),t=isNaN(a.backref);if(t&&XRegExp.isInstalled("namespacing")){if(!u.groups||!(a.backref in u.groups))throw new ReferenceError(d)}else if(!u.hasOwnProperty(a.backref))throw new ReferenceError(d);var i=t&&XRegExp.isInstalled("namespacing")?u.groups[a.backref]:u[a.backref];c.push(i||"")}else c.push(u[0])}var i,l=_createForOfIteratorHelper(u);try{for(l.s();!(i=l.n()).done;){var D=i.value;(0,h.default)(XRegExp).call(XRegExp,D,a.regex,addMatch)}}catch(u){l.e(u)}finally{l.f()}return t!==d.length-1&&c.length?recurseChain(c,t+1):c}([u],0)},XRegExp.replace=function(u,d,t,a){var c=XRegExp.isRegExp(d),i=d.global&&"one"!==a||"all"===a,l=(i?"g":"")+(d.sticky?"y":"")||"noGY",D=d;c?(d.xregexp=d.xregexp||{},D=d.xregexp[l]||(d.xregexp[l]=copyRegex(d,{addG:!!i,removeG:"one"===a,isInternalOnly:!0}))):i&&(D=new RegExp(XRegExp.escape(String(d)),"g"));var p=w.replace.call(nullThrows(u),D,t);return c&&d.global&&(d.lastIndex=0),p},XRegExp.replaceEach=function(u,d){var t,a=_createForOfIteratorHelper(d);try{for(a.s();!(t=a.n()).done;){var c=t.value;u=XRegExp.replace(u,c[0],c[1],c[2])}}catch(u){a.e(u)}finally{a.f()}return u},XRegExp.split=function(u,d,t){return w.split.call(nullThrows(u),d,t)},XRegExp.test=function(u,d,t,a){return!!XRegExp.exec(u,d,t,a)},XRegExp.uninstall=function(u){u=prepareOptions(u),B.astral&&u.astral&&setAstral(!1),B.namespacing&&u.namespacing&&setNamespacing(!1)},XRegExp.union=function(u,d,t){var a,c,i=(t=t||{}).conjunction||"or",l=0;function rewrite(u,d,t){var i=c[l-a];if(d){if(++l,i)return"(?<".concat(i,">")}else if(t)return"\\".concat(+t+a);return u}if(!isType(u,"Array")||!u.length)throw new TypeError("Must provide a nonempty array of patterns to merge");var D,p=/(\()(?!\?)|\\([1-9]\d*)|\\[\s\S]|\[(?:[^\\\]]|\\[\s\S])*\]/g,b=[],y=_createForOfIteratorHelper(u);try{for(y.s();!(D=y.n()).done;){var m=D.value;XRegExp.isRegExp(m)?(a=l,c=m.xregexp&&m.xregexp.captureNames||[],b.push(XRegExp(m.source).source.replace(p,rewrite))):b.push(XRegExp.escape(m))}}catch(u){y.e(u)}finally{y.f()}var A="none"===i?"":"|";return XRegExp(b.join(A),d)},w.exec=function(u){var d=this.lastIndex,t=RegExp.prototype.exec.apply(this,arguments);if(t){if(!I&&t.length>1&&-1!==(0,g.default)(t).call(t,"")){var a,c=copyRegex(this,{removeG:!0,isInternalOnly:!0});(0,E.default)(a=String(u)).call(a,t.index).replace(c,(function(){for(var u=arguments.length,d=1;d<u-2;++d)void 0===(d<0||arguments.length<=d?void 0:arguments[d])&&(t[d]=void 0)}))}if(this.xregexp&&this.xregexp.captureNames){var i=t;XRegExp.isInstalled("namespacing")&&(t.groups=(0,x.default)(null),i=t.groups);for(var l=1;l<t.length;++l){var D=this.xregexp.captureNames[l-1];D&&(i[D]=t[l])}}else!t.groups&&XRegExp.isInstalled("namespacing")&&(t.groups=void 0);this.global&&!t[0].length&&this.lastIndex>t.index&&(this.lastIndex=t.index)}return this.global||(this.lastIndex=d),t},w.test=function(u){return!!w.exec.call(this,u)},w.match=function(u){if(XRegExp.isRegExp(u)){if(u.global){var d=String.prototype.match.apply(this,arguments);return u.lastIndex=0,d}}else u=new RegExp(u);return w.exec.call(u,nullThrows(this))},w.replace=function(u,d){var t,a,c,i=XRegExp.isRegExp(u);return i?(u.xregexp&&(a=u.xregexp.captureNames),t=u.lastIndex):u+="",c=isType(d,"Function")?String(this).replace(u,(function(){for(var u=arguments.length,t=new Array(u),c=0;c<u;c++)t[c]=arguments[c];if(a){var i;XRegExp.isInstalled("namespacing")?(i=(0,x.default)(null),t.push(i)):(t[0]=new String(t[0]),i=t[0]);for(var l=0;l<a.length;++l)a[l]&&(i[a[l]]=t[l+1])}return d.apply(void 0,t)})):String(nullThrows(this)).replace(u,(function(){for(var u=arguments.length,t=new Array(u),c=0;c<u;c++)t[c]=arguments[c];return String(d).replace(T,replacer);function replacer(u,d,c,i){d=d||c;var l,D,p=isType(t[t.length-1],"Object")?4:3,b=t.length-p;if(d){if(/^\d+$/.test(d)){var y=+d;if(y<=b)return t[y]||""}var m=a?(0,g.default)(a).call(a,d):-1;if(m<0)throw new SyntaxError("Backreference to undefined group ".concat(u));return t[m+1]||""}if(""===i||" "===i)throw new SyntaxError("Invalid token ".concat(u));if("&"===i||0==+i)return t[0];if("$"===i)return"$";if("`"===i)return(0,E.default)(l=t[t.length-1]).call(l,0,t[t.length-2]);if("'"===i)return(0,E.default)(D=t[t.length-1]).call(D,t[t.length-2]+t[0].length);if(i=+i,!isNaN(i)){if(i>b)throw new SyntaxError("Backreference to undefined group ".concat(u));return t[i]||""}throw new SyntaxError("Invalid token ".concat(u))}})),i&&(u.global?u.lastIndex=0:u.lastIndex=t),c},w.split=function(u,d){if(!XRegExp.isRegExp(u))return String.prototype.split.apply(this,arguments);var t,a=String(this),c=[],i=u.lastIndex,l=0;return d=(void 0===d?-1:d)>>>0,(0,h.default)(XRegExp).call(XRegExp,a,u,(function(u){u.index+u[0].length>l&&(c.push((0,E.default)(a).call(a,l,u.index)),u.length>1&&u.index<a.length&&Array.prototype.push.apply(c,(0,E.default)(u).call(u,1)),t=u[0].length,l=u.index+t)})),l===a.length?u.test("")&&!t||c.push(""):c.push((0,E.default)(a).call(a,l)),u.lastIndex=i,c.length>d?(0,E.default)(c).call(c,0,d):c},XRegExp.addToken(/\\([ABCE-RTUVXYZaeg-mopqyz]|c(?![A-Za-z])|u(?![\dA-Fa-f]{4}|{[\dA-Fa-f]+})|x(?![\dA-Fa-f]{2}))/,(function(u,d){if("B"===u[1]&&d===O)return u[0];throw new SyntaxError("Invalid escape ".concat(u[0]))}),{scope:"all",leadChar:"\\"}),XRegExp.addToken(/\\u{([\dA-Fa-f]+)}/,(function(u,d,t){var a=dec(u[1]);if(a>1114111)throw new SyntaxError("Invalid Unicode code point ".concat(u[0]));if(a<=65535)return"\\u".concat(pad4(hex(a)));if(N&&-1!==(0,g.default)(t).call(t,"u"))return u[0];throw new SyntaxError("Cannot use Unicode code point above \\u{FFFF} without flag u")}),{scope:"all",leadChar:"\\"}),XRegExp.addToken(/\(\?#[^)]*\)/,getContextualTokenSeparator,{leadChar:"("}),XRegExp.addToken(/\s+|#[^\n]*\n?/,getContextualTokenSeparator,{flag:"x"}),L||XRegExp.addToken(/\./,(function(){return"[\\s\\S]"}),{flag:"s",leadChar:"."}),XRegExp.addToken(/\\k<([^>]+)>/,(function(u){var d,t,a=isNaN(u[1])?(0,g.default)(d=this.captureNames).call(d,u[1])+1:+u[1],c=u.index+u[0].length;if(!a||a>this.captureNames.length)throw new SyntaxError("Backreference to undefined group ".concat(u[0]));return(0,v.default)(t="\\".concat(a)).call(t,c===u.input.length||isNaN(u.input[c])?"":"(?:)")}),{leadChar:"\\"}),XRegExp.addToken(/\\(\d+)/,(function(u,d){if(!(d===O&&/^[1-9]/.test(u[1])&&+u[1]<=this.captureNames.length)&&"0"!==u[1])throw new SyntaxError("Cannot use octal escape or backreference to undefined group ".concat(u[0]));return u[0]}),{scope:"all",leadChar:"\\"}),XRegExp.addToken(/\(\?P?<((?:[\$A-Z_a-z\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u05D0-\u05EA\u05EF-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u0860-\u086A\u0870-\u0887\u0889-\u088E\u08A0-\u08C9\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u09FC\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0AF9\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58-\u0C5A\u0C5D\u0C60\u0C61\u0C80\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D04-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D54-\u0D56\u0D5F-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u1711\u171F-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1878\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4C\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CE9-\u1CEC\u1CEE-\u1CF3\u1CF5\u1CF6\u1CFA\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303C\u3041-\u3096\u309B-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u31BF\u31F0-\u31FF\u3400-\u4DBF\u4E00-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6EF\uA717-\uA71F\uA722-\uA788\uA78B-\uA7CA\uA7D0\uA7D1\uA7D3\uA7D5-\uA7D9\uA7F2-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA8FD\uA8FE\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uA9E0-\uA9E4\uA9E6-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB69\uAB70-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD40-\uDD74\uDE80-\uDE9C\uDEA0-\uDED0\uDF00-\uDF1F\uDF2D-\uDF4A\uDF50-\uDF75\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD00-\uDD27\uDD30-\uDD63\uDD70-\uDD7A\uDD7C-\uDD8A\uDD8C-\uDD92\uDD94\uDD95\uDD97-\uDDA1\uDDA3-\uDDB1\uDDB3-\uDDB9\uDDBB\uDDBC\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67\uDF80-\uDF85\uDF87-\uDFB0\uDFB2-\uDFBA]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDCE0-\uDCF2\uDCF4\uDCF5\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00\uDE10-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE4\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48\uDC80-\uDCB2\uDCC0-\uDCF2\uDD00-\uDD23\uDE80-\uDEA9\uDEB0\uDEB1\uDF00-\uDF1C\uDF27\uDF30-\uDF45\uDF70-\uDF81\uDFB0-\uDFC4\uDFE0-\uDFF6]|\uD804[\uDC03-\uDC37\uDC71\uDC72\uDC75\uDC83-\uDCAF\uDCD0-\uDCE8\uDD03-\uDD26\uDD44\uDD47\uDD50-\uDD72\uDD76\uDD83-\uDDB2\uDDC1-\uDDC4\uDDDA\uDDDC\uDE00-\uDE11\uDE13-\uDE2B\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEDE\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3D\uDF50\uDF5D-\uDF61]|\uD805[\uDC00-\uDC34\uDC47-\uDC4A\uDC5F-\uDC61\uDC80-\uDCAF\uDCC4\uDCC5\uDCC7\uDD80-\uDDAE\uDDD8-\uDDDB\uDE00-\uDE2F\uDE44\uDE80-\uDEAA\uDEB8\uDF00-\uDF1A\uDF40-\uDF46]|\uD806[\uDC00-\uDC2B\uDCA0-\uDCDF\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD2F\uDD3F\uDD41\uDDA0-\uDDA7\uDDAA-\uDDD0\uDDE1\uDDE3\uDE00\uDE0B-\uDE32\uDE3A\uDE50\uDE5C-\uDE89\uDE9D\uDEB0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC2E\uDC40\uDC72-\uDC8F\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD30\uDD46\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD89\uDD98\uDEE0-\uDEF2\uDFB0]|\uD808[\uDC00-\uDF99]|\uD809[\uDC00-\uDC6E\uDC80-\uDD43]|\uD80B[\uDF90-\uDFF0]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE70-\uDEBE\uDED0-\uDEED\uDF00-\uDF2F\uDF40-\uDF43\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDE40-\uDE7F\uDF00-\uDF4A\uDF50\uDF93-\uDF9F\uDFE0\uDFE1\uDFE3]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD82C[\uDC00-\uDD22\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB]|\uD837[\uDF00-\uDF1E]|\uD838[\uDD00-\uDD2C\uDD37-\uDD3D\uDD4E\uDE90-\uDEAD\uDEC0-\uDEEB]|\uD839[\uDFE0-\uDFE6\uDFE8-\uDFEB\uDFED\uDFEE\uDFF0-\uDFFE]|\uD83A[\uDC00-\uDCC4\uDD00-\uDD43\uDD4B]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF38\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A])(?:[\$0-9A-Z_a-z\xAA\xB5\xB7\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0300-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u0483-\u0487\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u05D0-\u05EA\u05EF-\u05F2\u0610-\u061A\u0620-\u0669\u066E-\u06D3\u06D5-\u06DC\u06DF-\u06E8\u06EA-\u06FC\u06FF\u0710-\u074A\u074D-\u07B1\u07C0-\u07F5\u07FA\u07FD\u0800-\u082D\u0840-\u085B\u0860-\u086A\u0870-\u0887\u0889-\u088E\u0898-\u08E1\u08E3-\u0963\u0966-\u096F\u0971-\u0983\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC-\u09C4\u09C7\u09C8\u09CB-\u09CE\u09D7\u09DC\u09DD\u09DF-\u09E3\u09E6-\u09F1\u09FC\u09FE\u0A01-\u0A03\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A59-\u0A5C\u0A5E\u0A66-\u0A75\u0A81-\u0A83\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AD0\u0AE0-\u0AE3\u0AE6-\u0AEF\u0AF9-\u0AFF\u0B01-\u0B03\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B55-\u0B57\u0B5C\u0B5D\u0B5F-\u0B63\u0B66-\u0B6F\u0B71\u0B82\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD0\u0BD7\u0BE6-\u0BEF\u0C00-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3C-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C58-\u0C5A\u0C5D\u0C60-\u0C63\u0C66-\u0C6F\u0C80-\u0C83\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CDD\u0CDE\u0CE0-\u0CE3\u0CE6-\u0CEF\u0CF1\u0CF2\u0D00-\u0D0C\u0D0E-\u0D10\u0D12-\u0D44\u0D46-\u0D48\u0D4A-\u0D4E\u0D54-\u0D57\u0D5F-\u0D63\u0D66-\u0D6F\u0D7A-\u0D7F\u0D81-\u0D83\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DE6-\u0DEF\u0DF2\u0DF3\u0E01-\u0E3A\u0E40-\u0E4E\u0E50-\u0E59\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECD\u0ED0-\u0ED9\u0EDC-\u0EDF\u0F00\u0F18\u0F19\u0F20-\u0F29\u0F35\u0F37\u0F39\u0F3E-\u0F47\u0F49-\u0F6C\u0F71-\u0F84\u0F86-\u0F97\u0F99-\u0FBC\u0FC6\u1000-\u1049\u1050-\u109D\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u135F\u1369-\u1371\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u1715\u171F-\u1734\u1740-\u1753\u1760-\u176C\u176E-\u1770\u1772\u1773\u1780-\u17D3\u17D7\u17DC\u17DD\u17E0-\u17E9\u180B-\u180D\u180F-\u1819\u1820-\u1878\u1880-\u18AA\u18B0-\u18F5\u1900-\u191E\u1920-\u192B\u1930-\u193B\u1946-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u19D0-\u19DA\u1A00-\u1A1B\u1A20-\u1A5E\u1A60-\u1A7C\u1A7F-\u1A89\u1A90-\u1A99\u1AA7\u1AB0-\u1ABD\u1ABF-\u1ACE\u1B00-\u1B4C\u1B50-\u1B59\u1B6B-\u1B73\u1B80-\u1BF3\u1C00-\u1C37\u1C40-\u1C49\u1C4D-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CD0-\u1CD2\u1CD4-\u1CFA\u1D00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u200C\u200D\u203F\u2040\u2054\u2071\u207F\u2090-\u209C\u20D0-\u20DC\u20E1\u20E5-\u20F0\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2CE4\u2CEB-\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D7F-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2DE0-\u2DFF\u3005-\u3007\u3021-\u302F\u3031-\u3035\u3038-\u303C\u3041-\u3096\u3099-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u31BF\u31F0-\u31FF\u3400-\u4DBF\u4E00-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA62B\uA640-\uA66F\uA674-\uA67D\uA67F-\uA6F1\uA717-\uA71F\uA722-\uA788\uA78B-\uA7CA\uA7D0\uA7D1\uA7D3\uA7D5-\uA7D9\uA7F2-\uA827\uA82C\uA840-\uA873\uA880-\uA8C5\uA8D0-\uA8D9\uA8E0-\uA8F7\uA8FB\uA8FD-\uA92D\uA930-\uA953\uA960-\uA97C\uA980-\uA9C0\uA9CF-\uA9D9\uA9E0-\uA9FE\uAA00-\uAA36\uAA40-\uAA4D\uAA50-\uAA59\uAA60-\uAA76\uAA7A-\uAAC2\uAADB-\uAADD\uAAE0-\uAAEF\uAAF2-\uAAF6\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB69\uAB70-\uABEA\uABEC\uABED\uABF0-\uABF9\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE00-\uFE0F\uFE20-\uFE2F\uFE33\uFE34\uFE4D-\uFE4F\uFE70-\uFE74\uFE76-\uFEFC\uFF10-\uFF19\uFF21-\uFF3A\uFF3F\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD40-\uDD74\uDDFD\uDE80-\uDE9C\uDEA0-\uDED0\uDEE0\uDF00-\uDF1F\uDF2D-\uDF4A\uDF50-\uDF7A\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCA0-\uDCA9\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD00-\uDD27\uDD30-\uDD63\uDD70-\uDD7A\uDD7C-\uDD8A\uDD8C-\uDD92\uDD94\uDD95\uDD97-\uDDA1\uDDA3-\uDDB1\uDDB3-\uDDB9\uDDBB\uDDBC\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67\uDF80-\uDF85\uDF87-\uDFB0\uDFB2-\uDFBA]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDCE0-\uDCF2\uDCF4\uDCF5\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00-\uDE03\uDE05\uDE06\uDE0C-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE38-\uDE3A\uDE3F\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE6\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48\uDC80-\uDCB2\uDCC0-\uDCF2\uDD00-\uDD27\uDD30-\uDD39\uDE80-\uDEA9\uDEAB\uDEAC\uDEB0\uDEB1\uDF00-\uDF1C\uDF27\uDF30-\uDF50\uDF70-\uDF85\uDFB0-\uDFC4\uDFE0-\uDFF6]|\uD804[\uDC00-\uDC46\uDC66-\uDC75\uDC7F-\uDCBA\uDCC2\uDCD0-\uDCE8\uDCF0-\uDCF9\uDD00-\uDD34\uDD36-\uDD3F\uDD44-\uDD47\uDD50-\uDD73\uDD76\uDD80-\uDDC4\uDDC9-\uDDCC\uDDCE-\uDDDA\uDDDC\uDE00-\uDE11\uDE13-\uDE37\uDE3E\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEEA\uDEF0-\uDEF9\uDF00-\uDF03\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3B-\uDF44\uDF47\uDF48\uDF4B-\uDF4D\uDF50\uDF57\uDF5D-\uDF63\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC00-\uDC4A\uDC50-\uDC59\uDC5E-\uDC61\uDC80-\uDCC5\uDCC7\uDCD0-\uDCD9\uDD80-\uDDB5\uDDB8-\uDDC0\uDDD8-\uDDDD\uDE00-\uDE40\uDE44\uDE50-\uDE59\uDE80-\uDEB8\uDEC0-\uDEC9\uDF00-\uDF1A\uDF1D-\uDF2B\uDF30-\uDF39\uDF40-\uDF46]|\uD806[\uDC00-\uDC3A\uDCA0-\uDCE9\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD35\uDD37\uDD38\uDD3B-\uDD43\uDD50-\uDD59\uDDA0-\uDDA7\uDDAA-\uDDD7\uDDDA-\uDDE1\uDDE3\uDDE4\uDE00-\uDE3E\uDE47\uDE50-\uDE99\uDE9D\uDEB0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC36\uDC38-\uDC40\uDC50-\uDC59\uDC72-\uDC8F\uDC92-\uDCA7\uDCA9-\uDCB6\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD36\uDD3A\uDD3C\uDD3D\uDD3F-\uDD47\uDD50-\uDD59\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD8E\uDD90\uDD91\uDD93-\uDD98\uDDA0-\uDDA9\uDEE0-\uDEF6\uDFB0]|\uD808[\uDC00-\uDF99]|\uD809[\uDC00-\uDC6E\uDC80-\uDD43]|\uD80B[\uDF90-\uDFF0]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE60-\uDE69\uDE70-\uDEBE\uDEC0-\uDEC9\uDED0-\uDEED\uDEF0-\uDEF4\uDF00-\uDF36\uDF40-\uDF43\uDF50-\uDF59\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDE40-\uDE7F\uDF00-\uDF4A\uDF4F-\uDF87\uDF8F-\uDF9F\uDFE0\uDFE1\uDFE3\uDFE4\uDFF0\uDFF1]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD82C[\uDC00-\uDD22\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99\uDC9D\uDC9E]|\uD833[\uDF00-\uDF2D\uDF30-\uDF46]|\uD834[\uDD65-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD\uDE42-\uDE44]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB\uDFCE-\uDFFF]|\uD836[\uDE00-\uDE36\uDE3B-\uDE6C\uDE75\uDE84\uDE9B-\uDE9F\uDEA1-\uDEAF]|\uD837[\uDF00-\uDF1E]|\uD838[\uDC00-\uDC06\uDC08-\uDC18\uDC1B-\uDC21\uDC23\uDC24\uDC26-\uDC2A\uDD00-\uDD2C\uDD30-\uDD3D\uDD40-\uDD49\uDD4E\uDE90-\uDEAE\uDEC0-\uDEF9]|\uD839[\uDFE0-\uDFE6\uDFE8-\uDFEB\uDFED\uDFEE\uDFF0-\uDFFE]|\uD83A[\uDC00-\uDCC4\uDCD0-\uDCD6\uDD00-\uDD4B\uDD50-\uDD59]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD83E[\uDFF0-\uDFF9]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF38\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A]|\uDB40[\uDD00-\uDDEF])*)>/,(function(u){var d;if(!XRegExp.isInstalled("namespacing")&&("length"===u[1]||"__proto__"===u[1]))throw new SyntaxError("Cannot use reserved word as capture name ".concat(u[0]));if(-1!==(0,g.default)(d=this.captureNames).call(d,u[1]))throw new SyntaxError("Cannot use same name for multiple groups ".concat(u[0]));return this.captureNames.push(u[1]),this.hasNamedCapture=!0,"("}),{leadChar:"("}),XRegExp.addToken(/\((?!\?)/,(function(u,d,t){return-1!==(0,g.default)(t).call(t,"n")?"(?:":(this.captureNames.push(null),"(")}),{optionalFlags:"n",leadChar:"("});var q=XRegExp;t.default=q,d.exports=t.default},{"@babel/runtime-corejs3/core-js-stable/array/from":5,"@babel/runtime-corejs3/core-js-stable/array/is-array":6,"@babel/runtime-corejs3/core-js-stable/instance/concat":7,"@babel/runtime-corejs3/core-js-stable/instance/flags":8,"@babel/runtime-corejs3/core-js-stable/instance/for-each":9,"@babel/runtime-corejs3/core-js-stable/instance/index-of":10,"@babel/runtime-corejs3/core-js-stable/instance/slice":11,"@babel/runtime-corejs3/core-js-stable/instance/sort":12,"@babel/runtime-corejs3/core-js-stable/object/create":13,"@babel/runtime-corejs3/core-js-stable/object/define-property":14,"@babel/runtime-corejs3/core-js-stable/parse-int":15,"@babel/runtime-corejs3/core-js-stable/symbol":16,"@babel/runtime-corejs3/core-js/get-iterator-method":19,"@babel/runtime-corejs3/helpers/interopRequireDefault":24,"@babel/runtime-corejs3/helpers/slicedToArray":27}],5:[function(u,d,t){d.exports=u("core-js-pure/stable/array/from")},{"core-js-pure/stable/array/from":208}],6:[function(u,d,t){d.exports=u("core-js-pure/stable/array/is-array")},{"core-js-pure/stable/array/is-array":209}],7:[function(u,d,t){d.exports=u("core-js-pure/stable/instance/concat")},{"core-js-pure/stable/instance/concat":212}],8:[function(u,d,t){d.exports=u("core-js-pure/stable/instance/flags")},{"core-js-pure/stable/instance/flags":213}],9:[function(u,d,t){d.exports=u("core-js-pure/stable/instance/for-each")},{"core-js-pure/stable/instance/for-each":214}],10:[function(u,d,t){d.exports=u("core-js-pure/stable/instance/index-of")},{"core-js-pure/stable/instance/index-of":215}],11:[function(u,d,t){d.exports=u("core-js-pure/stable/instance/slice")},{"core-js-pure/stable/instance/slice":216}],12:[function(u,d,t){d.exports=u("core-js-pure/stable/instance/sort")},{"core-js-pure/stable/instance/sort":217}],13:[function(u,d,t){d.exports=u("core-js-pure/stable/object/create")},{"core-js-pure/stable/object/create":218}],14:[function(u,d,t){d.exports=u("core-js-pure/stable/object/define-property")},{"core-js-pure/stable/object/define-property":219}],15:[function(u,d,t){d.exports=u("core-js-pure/stable/parse-int")},{"core-js-pure/stable/parse-int":220}],16:[function(u,d,t){d.exports=u("core-js-pure/stable/symbol")},{"core-js-pure/stable/symbol":221}],17:[function(u,d,t){d.exports=u("core-js-pure/features/array/from")},{"core-js-pure/features/array/from":52}],18:[function(u,d,t){d.exports=u("core-js-pure/features/array/is-array")},{"core-js-pure/features/array/is-array":53}],19:[function(u,d,t){d.exports=u("core-js-pure/features/get-iterator-method")},{"core-js-pure/features/get-iterator-method":54}],20:[function(u,d,t){d.exports=u("core-js-pure/features/instance/slice")},{"core-js-pure/features/instance/slice":55}],21:[function(u,d,t){d.exports=u("core-js-pure/features/symbol")},{"core-js-pure/features/symbol":56}],22:[function(u,d,t){d.exports=function _arrayLikeToArray(u,d){(null==d||d>u.length)&&(d=u.length);for(var t=0,a=new Array(d);t<d;t++)a[t]=u[t];return a},d.exports.__esModule=!0,d.exports.default=d.exports},{}],23:[function(u,d,t){var a=u("@babel/runtime-corejs3/core-js/array/is-array");d.exports=function _arrayWithHoles(u){if(a(u))return u},d.exports.__esModule=!0,d.exports.default=d.exports},{"@babel/runtime-corejs3/core-js/array/is-array":18}],24:[function(u,d,t){d.exports=function _interopRequireDefault(u){return u&&u.__esModule?u:{default:u}},d.exports.__esModule=!0,d.exports.default=d.exports},{}],25:[function(u,d,t){var a=u("@babel/runtime-corejs3/core-js/symbol"),c=u("@babel/runtime-corejs3/core-js/get-iterator-method");d.exports=function _iterableToArrayLimit(u,d){var t=null==u?null:void 0!==a&&c(u)||u["@@iterator"];if(null!=t){var i,l,D=[],p=!0,b=!1;try{for(t=t.call(u);!(p=(i=t.next()).done)&&(D.push(i.value),!d||D.length!==d);p=!0);}catch(u){b=!0,l=u}finally{try{p||null==t.return||t.return()}finally{if(b)throw l}}return D}},d.exports.__esModule=!0,d.exports.default=d.exports},{"@babel/runtime-corejs3/core-js/get-iterator-method":19,"@babel/runtime-corejs3/core-js/symbol":21}],26:[function(u,d,t){d.exports=function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},d.exports.__esModule=!0,d.exports.default=d.exports},{}],27:[function(u,d,t){var a=u("./arrayWithHoles.js"),c=u("./iterableToArrayLimit.js"),i=u("./unsupportedIterableToArray.js"),l=u("./nonIterableRest.js");d.exports=function _slicedToArray(u,d){return a(u)||c(u,d)||i(u,d)||l()},d.exports.__esModule=!0,d.exports.default=d.exports},{"./arrayWithHoles.js":23,"./iterableToArrayLimit.js":25,"./nonIterableRest.js":26,"./unsupportedIterableToArray.js":28}],28:[function(u,d,t){var a=u("@babel/runtime-corejs3/core-js/instance/slice"),c=u("@babel/runtime-corejs3/core-js/array/from"),i=u("./arrayLikeToArray.js");d.exports=function _unsupportedIterableToArray(u,d){var t;if(u){if("string"==typeof u)return i(u,d);var l=a(t=Object.prototype.toString.call(u)).call(t,8,-1);return"Object"===l&&u.constructor&&(l=u.constructor.name),"Map"===l||"Set"===l?c(u):"Arguments"===l||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l)?i(u,d):void 0}},d.exports.__esModule=!0,d.exports.default=d.exports},{"./arrayLikeToArray.js":22,"@babel/runtime-corejs3/core-js/array/from":17,"@babel/runtime-corejs3/core-js/instance/slice":20}],29:[function(u,d,t){var a=u("../../stable/array/from");d.exports=a},{"../../stable/array/from":208}],30:[function(u,d,t){var a=u("../../stable/array/is-array");d.exports=a},{"../../stable/array/is-array":209}],31:[function(u,d,t){var a=u("../stable/get-iterator-method");d.exports=a},{"../stable/get-iterator-method":211}],32:[function(u,d,t){var a=u("../../stable/instance/slice");d.exports=a},{"../../stable/instance/slice":216}],33:[function(u,d,t){var a=u("../../stable/symbol");d.exports=a},{"../../stable/symbol":221}],34:[function(u,d,t){u("../../modules/es.string.iterator"),u("../../modules/es.array.from");var a=u("../../internals/path");d.exports=a.Array.from},{"../../internals/path":142,"../../modules/es.array.from":170,"../../modules/es.string.iterator":184}],35:[function(u,d,t){u("../../modules/es.array.is-array");var a=u("../../internals/path");d.exports=a.Array.isArray},{"../../internals/path":142,"../../modules/es.array.is-array":172}],36:[function(u,d,t){u("../../../modules/es.array.concat");var a=u("../../../internals/entry-virtual");d.exports=a("Array").concat},{"../../../internals/entry-virtual":91,"../../../modules/es.array.concat":168}],37:[function(u,d,t){u("../../../modules/es.array.for-each");var a=u("../../../internals/entry-virtual");d.exports=a("Array").forEach},{"../../../internals/entry-virtual":91,"../../../modules/es.array.for-each":169}],38:[function(u,d,t){u("../../../modules/es.array.index-of");var a=u("../../../internals/entry-virtual");d.exports=a("Array").indexOf},{"../../../internals/entry-virtual":91,"../../../modules/es.array.index-of":171}],39:[function(u,d,t){u("../../../modules/es.array.slice");var a=u("../../../internals/entry-virtual");d.exports=a("Array").slice},{"../../../internals/entry-virtual":91,"../../../modules/es.array.slice":174}],40:[function(u,d,t){u("../../../modules/es.array.sort");var a=u("../../../internals/entry-virtual");d.exports=a("Array").sort},{"../../../internals/entry-virtual":91,"../../../modules/es.array.sort":175}],41:[function(u,d,t){u("../modules/es.array.iterator"),u("../modules/es.string.iterator");var a=u("../internals/get-iterator-method");d.exports=a},{"../internals/get-iterator-method":101,"../modules/es.array.iterator":173,"../modules/es.string.iterator":184}],42:[function(u,d,t){var a=u("../../internals/object-is-prototype-of"),c=u("../array/virtual/concat"),i=Array.prototype;d.exports=function(u){var d=u.concat;return u===i||a(i,u)&&d===i.concat?c:d}},{"../../internals/object-is-prototype-of":135,"../array/virtual/concat":36}],43:[function(u,d,t){var a=u("../../internals/object-is-prototype-of"),c=u("../regexp/flags"),i=RegExp.prototype;d.exports=function(u){return u===i||a(i,u)?c(u):u.flags}},{"../../internals/object-is-prototype-of":135,"../regexp/flags":50}],44:[function(u,d,t){var a=u("../../internals/object-is-prototype-of"),c=u("../array/virtual/index-of"),i=Array.prototype;d.exports=function(u){var d=u.indexOf;return u===i||a(i,u)&&d===i.indexOf?c:d}},{"../../internals/object-is-prototype-of":135,"../array/virtual/index-of":38}],45:[function(u,d,t){var a=u("../../internals/object-is-prototype-of"),c=u("../array/virtual/slice"),i=Array.prototype;d.exports=function(u){var d=u.slice;return u===i||a(i,u)&&d===i.slice?c:d}},{"../../internals/object-is-prototype-of":135,"../array/virtual/slice":39}],46:[function(u,d,t){var a=u("../../internals/object-is-prototype-of"),c=u("../array/virtual/sort"),i=Array.prototype;d.exports=function(u){var d=u.sort;return u===i||a(i,u)&&d===i.sort?c:d}},{"../../internals/object-is-prototype-of":135,"../array/virtual/sort":40}],47:[function(u,d,t){u("../../modules/es.object.create");var a=u("../../internals/path").Object;d.exports=function create(u,d){return a.create(u,d)}},{"../../internals/path":142,"../../modules/es.object.create":178}],48:[function(u,d,t){u("../../modules/es.object.define-property");var a=u("../../internals/path").Object,c=d.exports=function defineProperty(u,d,t){return a.defineProperty(u,d,t)};a.defineProperty.sham&&(c.sham=!0)},{"../../internals/path":142,"../../modules/es.object.define-property":179}],49:[function(u,d,t){u("../modules/es.parse-int");var a=u("../internals/path");d.exports=a.parseInt},{"../internals/path":142,"../modules/es.parse-int":181}],50:[function(u,d,t){u("../../modules/es.regexp.flags");var a=u("../../internals/function-uncurry-this"),c=u("../../internals/regexp-flags");d.exports=a(c)},{"../../internals/function-uncurry-this":99,"../../internals/regexp-flags":144,"../../modules/es.regexp.flags":183}],51:[function(u,d,t){u("../../modules/es.array.concat"),u("../../modules/es.object.to-string"),u("../../modules/es.symbol"),u("../../modules/es.symbol.async-iterator"),u("../../modules/es.symbol.description"),u("../../modules/es.symbol.has-instance"),u("../../modules/es.symbol.is-concat-spreadable"),u("../../modules/es.symbol.iterator"),u("../../modules/es.symbol.match"),u("../../modules/es.symbol.match-all"),u("../../modules/es.symbol.replace"),u("../../modules/es.symbol.search"),u("../../modules/es.symbol.species"),u("../../modules/es.symbol.split"),u("../../modules/es.symbol.to-primitive"),u("../../modules/es.symbol.to-string-tag"),u("../../modules/es.symbol.unscopables"),u("../../modules/es.json.to-string-tag"),u("../../modules/es.math.to-string-tag"),u("../../modules/es.reflect.to-string-tag");var a=u("../../internals/path");d.exports=a.Symbol},{"../../internals/path":142,"../../modules/es.array.concat":168,"../../modules/es.json.to-string-tag":176,"../../modules/es.math.to-string-tag":177,"../../modules/es.object.to-string":180,"../../modules/es.reflect.to-string-tag":182,"../../modules/es.symbol":190,"../../modules/es.symbol.async-iterator":185,"../../modules/es.symbol.description":186,"../../modules/es.symbol.has-instance":187,"../../modules/es.symbol.is-concat-spreadable":188,"../../modules/es.symbol.iterator":189,"../../modules/es.symbol.match":192,"../../modules/es.symbol.match-all":191,"../../modules/es.symbol.replace":193,"../../modules/es.symbol.search":194,"../../modules/es.symbol.species":195,"../../modules/es.symbol.split":196,"../../modules/es.symbol.to-primitive":197,"../../modules/es.symbol.to-string-tag":198,"../../modules/es.symbol.unscopables":199}],52:[function(u,d,t){var a=u("../../actual/array/from");d.exports=a},{"../../actual/array/from":29}],53:[function(u,d,t){var a=u("../../actual/array/is-array");d.exports=a},{"../../actual/array/is-array":30}],54:[function(u,d,t){var a=u("../actual/get-iterator-method");d.exports=a},{"../actual/get-iterator-method":31}],55:[function(u,d,t){var a=u("../../actual/instance/slice");d.exports=a},{"../../actual/instance/slice":32}],56:[function(u,d,t){var a=u("../../actual/symbol");u("../../modules/esnext.symbol.async-dispose"),u("../../modules/esnext.symbol.dispose"),u("../../modules/esnext.symbol.matcher"),u("../../modules/esnext.symbol.metadata"),u("../../modules/esnext.symbol.observable"),u("../../modules/esnext.symbol.pattern-match"),u("../../modules/esnext.symbol.replace-all"),d.exports=a},{"../../actual/symbol":33,"../../modules/esnext.symbol.async-dispose":200,"../../modules/esnext.symbol.dispose":201,"../../modules/esnext.symbol.matcher":202,"../../modules/esnext.symbol.metadata":203,"../../modules/esnext.symbol.observable":204,"../../modules/esnext.symbol.pattern-match":205,"../../modules/esnext.symbol.replace-all":206}],57:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/is-callable"),i=u("../internals/try-to-string"),l=a.TypeError;d.exports=function(u){if(c(u))return u;throw l(i(u)+" is not a function")}},{"../internals/global":104,"../internals/is-callable":114,"../internals/try-to-string":162}],58:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/is-callable"),i=a.String,l=a.TypeError;d.exports=function(u){if("object"==typeof u||c(u))return u;throw l("Can't set "+i(u)+" as a prototype")}},{"../internals/global":104,"../internals/is-callable":114}],59:[function(u,d,t){d.exports=function(){}},{}],60:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/is-object"),i=a.String,l=a.TypeError;d.exports=function(u){if(c(u))return u;throw l(i(u)+" is not an object")}},{"../internals/global":104,"../internals/is-object":117}],61:[function(u,d,t){"use strict";var a=u("../internals/array-iteration").forEach,c=u("../internals/array-method-is-strict")("forEach");d.exports=c?[].forEach:function forEach(u){return a(this,u,arguments.length>1?arguments[1]:void 0)}},{"../internals/array-iteration":64,"../internals/array-method-is-strict":66}],62:[function(u,d,t){"use strict";var a=u("../internals/global"),c=u("../internals/function-bind-context"),i=u("../internals/function-call"),l=u("../internals/to-object"),D=u("../internals/call-with-safe-iteration-closing"),p=u("../internals/is-array-iterator-method"),b=u("../internals/is-constructor"),y=u("../internals/length-of-array-like"),m=u("../internals/create-property"),A=u("../internals/get-iterator"),E=u("../internals/get-iterator-method"),C=a.Array;d.exports=function from(u){var d=l(u),t=b(this),a=arguments.length,g=a>1?arguments[1]:void 0,h=void 0!==g;h&&(g=c(g,a>2?arguments[2]:void 0));var x,v,B,w,j,k,S=E(d),O=0;if(!S||this==C&&p(S))for(x=y(d),v=t?new this(x):C(x);x>O;O++)k=h?g(d[O],O):d[O],m(v,O,k);else for(j=(w=A(d,S)).next,v=t?new this:[];!(B=i(j,w)).done;O++)k=h?D(w,g,[B.value,O],!0):B.value,m(v,O,k);return v.length=O,v}},{"../internals/call-with-safe-iteration-closing":72,"../internals/create-property":80,"../internals/function-bind-context":96,"../internals/function-call":97,"../internals/get-iterator":102,"../internals/get-iterator-method":101,"../internals/global":104,"../internals/is-array-iterator-method":112,"../internals/is-constructor":115,"../internals/length-of-array-like":123,"../internals/to-object":157}],63:[function(u,d,t){var a=u("../internals/to-indexed-object"),c=u("../internals/to-absolute-index"),i=u("../internals/length-of-array-like"),createMethod=function(u){return function(d,t,l){var D,p=a(d),b=i(p),y=c(l,b);if(u&&t!=t){for(;b>y;)if((D=p[y++])!=D)return!0}else for(;b>y;y++)if((u||y in p)&&p[y]===t)return u||y||0;return!u&&-1}};d.exports={includes:createMethod(!0),indexOf:createMethod(!1)}},{"../internals/length-of-array-like":123,"../internals/to-absolute-index":153,"../internals/to-indexed-object":154}],64:[function(u,d,t){var a=u("../internals/function-bind-context"),c=u("../internals/function-uncurry-this"),i=u("../internals/indexed-object"),l=u("../internals/to-object"),D=u("../internals/length-of-array-like"),p=u("../internals/array-species-create"),b=c([].push),createMethod=function(u){var d=1==u,t=2==u,c=3==u,y=4==u,m=6==u,A=7==u,E=5==u||m;return function(C,g,h,x){for(var v,B,w=l(C),j=i(w),k=a(g,h),S=D(j),O=0,R=x||p,_=d?R(C,S):t||A?R(C,0):void 0;S>O;O++)if((E||O in j)&&(B=k(v=j[O],O,w),u))if(d)_[O]=B;else if(B)switch(u){case 3:return!0;case 5:return v;case 6:return O;case 2:b(_,v)}else switch(u){case 4:return!1;case 7:b(_,v)}return m?-1:c||y?y:_}};d.exports={forEach:createMethod(0),map:createMethod(1),filter:createMethod(2),some:createMethod(3),every:createMethod(4),find:createMethod(5),findIndex:createMethod(6),filterReject:createMethod(7)}},{"../internals/array-species-create":71,"../internals/function-bind-context":96,"../internals/function-uncurry-this":99,"../internals/indexed-object":109,"../internals/length-of-array-like":123,"../internals/to-object":157}],65:[function(u,d,t){var a=u("../internals/fails"),c=u("../internals/well-known-symbol"),i=u("../internals/engine-v8-version"),l=c("species");d.exports=function(u){return i>=51||!a((function(){var d=[];return(d.constructor={})[l]=function(){return{foo:1}},1!==d[u](Boolean).foo}))}},{"../internals/engine-v8-version":89,"../internals/fails":94,"../internals/well-known-symbol":166}],66:[function(u,d,t){"use strict";var a=u("../internals/fails");d.exports=function(u,d){var t=[][u];return!!t&&a((function(){t.call(null,d||function(){throw 1},1)}))}},{"../internals/fails":94}],67:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/to-absolute-index"),i=u("../internals/length-of-array-like"),l=u("../internals/create-property"),D=a.Array,p=Math.max;d.exports=function(u,d,t){for(var a=i(u),b=c(d,a),y=c(void 0===t?a:t,a),m=D(p(y-b,0)),A=0;b<y;b++,A++)l(m,A,u[b]);return m.length=A,m}},{"../internals/create-property":80,"../internals/global":104,"../internals/length-of-array-like":123,"../internals/to-absolute-index":153}],68:[function(u,d,t){var a=u("../internals/function-uncurry-this");d.exports=a([].slice)},{"../internals/function-uncurry-this":99}],69:[function(u,d,t){var a=u("../internals/array-slice-simple"),c=Math.floor,mergeSort=function(u,d){var t=u.length,i=c(t/2);return t<8?insertionSort(u,d):merge(u,mergeSort(a(u,0,i),d),mergeSort(a(u,i),d),d)},insertionSort=function(u,d){for(var t,a,c=u.length,i=1;i<c;){for(a=i,t=u[i];a&&d(u[a-1],t)>0;)u[a]=u[--a];a!==i++&&(u[a]=t)}return u},merge=function(u,d,t,a){for(var c=d.length,i=t.length,l=0,D=0;l<c||D<i;)u[l+D]=l<c&&D<i?a(d[l],t[D])<=0?d[l++]:t[D++]:l<c?d[l++]:t[D++];return u};d.exports=mergeSort},{"../internals/array-slice-simple":67}],70:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/is-array"),i=u("../internals/is-constructor"),l=u("../internals/is-object"),D=u("../internals/well-known-symbol")("species"),p=a.Array;d.exports=function(u){var d;return c(u)&&(d=u.constructor,(i(d)&&(d===p||c(d.prototype))||l(d)&&null===(d=d[D]))&&(d=void 0)),void 0===d?p:d}},{"../internals/global":104,"../internals/is-array":113,"../internals/is-constructor":115,"../internals/is-object":117,"../internals/well-known-symbol":166}],71:[function(u,d,t){var a=u("../internals/array-species-constructor");d.exports=function(u,d){return new(a(u))(0===d?0:d)}},{"../internals/array-species-constructor":70}],72:[function(u,d,t){var a=u("../internals/an-object"),c=u("../internals/iterator-close");d.exports=function(u,d,t,i){try{return i?d(a(t)[0],t[1]):d(t)}catch(d){c(u,"throw",d)}}},{"../internals/an-object":60,"../internals/iterator-close":120}],73:[function(u,d,t){var a=u("../internals/well-known-symbol")("iterator"),c=!1;try{var i=0,l={next:function(){return{done:!!i++}},return:function(){c=!0}};l[a]=function(){return this},Array.from(l,(function(){throw 2}))}catch(u){}d.exports=function(u,d){if(!d&&!c)return!1;var t=!1;try{var i={};i[a]=function(){return{next:function(){return{done:t=!0}}}},u(i)}catch(u){}return t}},{"../internals/well-known-symbol":166}],74:[function(u,d,t){var a=u("../internals/function-uncurry-this"),c=a({}.toString),i=a("".slice);d.exports=function(u){return i(c(u),8,-1)}},{"../internals/function-uncurry-this":99}],75:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/to-string-tag-support"),i=u("../internals/is-callable"),l=u("../internals/classof-raw"),D=u("../internals/well-known-symbol")("toStringTag"),p=a.Object,b="Arguments"==l(function(){return arguments}());d.exports=c?l:function(u){var d,t,a;return void 0===u?"Undefined":null===u?"Null":"string"==typeof(t=function(u,d){try{return u[d]}catch(u){}}(d=p(u),D))?t:b?l(d):"Object"==(a=l(d))&&i(d.callee)?"Arguments":a}},{"../internals/classof-raw":74,"../internals/global":104,"../internals/is-callable":114,"../internals/to-string-tag-support":160,"../internals/well-known-symbol":166}],76:[function(u,d,t){var a=u("../internals/fails");d.exports=!a((function(){function F(){}return F.prototype.constructor=null,Object.getPrototypeOf(new F)!==F.prototype}))},{"../internals/fails":94}],77:[function(u,d,t){"use strict";var a=u("../internals/iterators-core").IteratorPrototype,c=u("../internals/object-create"),i=u("../internals/create-property-descriptor"),l=u("../internals/set-to-string-tag"),D=u("../internals/iterators"),returnThis=function(){return this};d.exports=function(u,d,t,p){var b=d+" Iterator";return u.prototype=c(a,{next:i(+!p,t)}),l(u,b,!1,!0),D[b]=returnThis,u}},{"../internals/create-property-descriptor":79,"../internals/iterators":122,"../internals/iterators-core":121,"../internals/object-create":127,"../internals/set-to-string-tag":147}],78:[function(u,d,t){var a=u("../internals/descriptors"),c=u("../internals/object-define-property"),i=u("../internals/create-property-descriptor");d.exports=a?function(u,d,t){return c.f(u,d,i(1,t))}:function(u,d,t){return u[d]=t,u}},{"../internals/create-property-descriptor":79,"../internals/descriptors":83,"../internals/object-define-property":129}],79:[function(u,d,t){d.exports=function(u,d){return{enumerable:!(1&u),configurable:!(2&u),writable:!(4&u),value:d}}},{}],80:[function(u,d,t){"use strict";var a=u("../internals/to-property-key"),c=u("../internals/object-define-property"),i=u("../internals/create-property-descriptor");d.exports=function(u,d,t){var l=a(d);l in u?c.f(u,l,i(0,t)):u[l]=t}},{"../internals/create-property-descriptor":79,"../internals/object-define-property":129,"../internals/to-property-key":159}],81:[function(u,d,t){"use strict";var a=u("../internals/export"),c=u("../internals/function-call"),i=u("../internals/is-pure"),l=u("../internals/function-name"),D=u("../internals/is-callable"),p=u("../internals/create-iterator-constructor"),b=u("../internals/object-get-prototype-of"),y=u("../internals/object-set-prototype-of"),m=u("../internals/set-to-string-tag"),A=u("../internals/create-non-enumerable-property"),E=u("../internals/redefine"),C=u("../internals/well-known-symbol"),g=u("../internals/iterators"),h=u("../internals/iterators-core"),x=l.PROPER,v=l.CONFIGURABLE,B=h.IteratorPrototype,w=h.BUGGY_SAFARI_ITERATORS,j=C("iterator"),k="keys",S="values",O="entries",returnThis=function(){return this};d.exports=function(u,d,t,l,C,h,R){p(t,d,l);var _,T,I,getIterationMethod=function(u){if(u===C&&M)return M;if(!w&&u in L)return L[u];switch(u){case k:return function keys(){return new t(this,u)};case S:return function values(){return new t(this,u)};case O:return function entries(){return new t(this,u)}}return function(){return new t(this)}},P=d+" Iterator",X=!1,L=u.prototype,N=L[j]||L["@@iterator"]||C&&L[C],M=!w&&N||getIterationMethod(C),U="Array"==d&&L.entries||N;if(U&&(_=b(U.call(new u)))!==Object.prototype&&_.next&&(i||b(_)===B||(y?y(_,B):D(_[j])||E(_,j,returnThis)),m(_,P,!0,!0),i&&(g[P]=returnThis)),x&&C==S&&N&&N.name!==S&&(!i&&v?A(L,"name",S):(X=!0,M=function values(){return c(N,this)})),C)if(T={values:getIterationMethod(S),keys:h?M:getIterationMethod(k),entries:getIterationMethod(O)},R)for(I in T)(w||X||!(I in L))&&E(L,I,T[I]);else a({target:d,proto:!0,forced:w||X},T);return i&&!R||L[j]===M||E(L,j,M,{name:C}),g[d]=M,T}},{"../internals/create-iterator-constructor":77,"../internals/create-non-enumerable-property":78,"../internals/export":93,"../internals/function-call":97,"../internals/function-name":98,"../internals/is-callable":114,"../internals/is-pure":118,"../internals/iterators":122,"../internals/iterators-core":121,"../internals/object-get-prototype-of":134,"../internals/object-set-prototype-of":139,"../internals/redefine":143,"../internals/set-to-string-tag":147,"../internals/well-known-symbol":166}],82:[function(u,d,t){var a=u("../internals/path"),c=u("../internals/has-own-property"),i=u("../internals/well-known-symbol-wrapped"),l=u("../internals/object-define-property").f;d.exports=function(u){var d=a.Symbol||(a.Symbol={});c(d,u)||l(d,u,{value:i.f(u)})}},{"../internals/has-own-property":105,"../internals/object-define-property":129,"../internals/path":142,"../internals/well-known-symbol-wrapped":165}],83:[function(u,d,t){var a=u("../internals/fails");d.exports=!a((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]}))},{"../internals/fails":94}],84:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/is-object"),i=a.document,l=c(i)&&c(i.createElement);d.exports=function(u){return l?i.createElement(u):{}}},{"../internals/global":104,"../internals/is-object":117}],85:[function(u,d,t){d.exports={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0}},{}],86:[function(u,d,t){var a=u("../internals/engine-user-agent").match(/firefox\/(\d+)/i);d.exports=!!a&&+a[1]},{"../internals/engine-user-agent":88}],87:[function(u,d,t){var a=u("../internals/engine-user-agent");d.exports=/MSIE|Trident/.test(a)},{"../internals/engine-user-agent":88}],88:[function(u,d,t){var a=u("../internals/get-built-in");d.exports=a("navigator","userAgent")||""},{"../internals/get-built-in":100}],89:[function(u,d,t){var a,c,i=u("../internals/global"),l=u("../internals/engine-user-agent"),D=i.process,p=i.Deno,b=D&&D.versions||p&&p.version,y=b&&b.v8;y&&(c=(a=y.split("."))[0]>0&&a[0]<4?1:+(a[0]+a[1])),!c&&l&&(!(a=l.match(/Edge\/(\d+)/))||a[1]>=74)&&(a=l.match(/Chrome\/(\d+)/))&&(c=+a[1]),d.exports=c},{"../internals/engine-user-agent":88,"../internals/global":104}],90:[function(u,d,t){var a=u("../internals/engine-user-agent").match(/AppleWebKit\/(\d+)\./);d.exports=!!a&&+a[1]},{"../internals/engine-user-agent":88}],91:[function(u,d,t){var a=u("../internals/path");d.exports=function(u){return a[u+"Prototype"]}},{"../internals/path":142}],92:[function(u,d,t){d.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]},{}],93:[function(u,d,t){"use strict";var a=u("../internals/global"),c=u("../internals/function-apply"),i=u("../internals/function-uncurry-this"),l=u("../internals/is-callable"),D=u("../internals/object-get-own-property-descriptor").f,p=u("../internals/is-forced"),b=u("../internals/path"),y=u("../internals/function-bind-context"),m=u("../internals/create-non-enumerable-property"),A=u("../internals/has-own-property"),wrapConstructor=function(u){var Wrapper=function(d,t,a){if(this instanceof Wrapper){switch(arguments.length){case 0:return new u;case 1:return new u(d);case 2:return new u(d,t)}return new u(d,t,a)}return c(u,this,arguments)};return Wrapper.prototype=u.prototype,Wrapper};d.exports=function(u,d){var t,c,E,C,g,h,x,v,B=u.target,w=u.global,j=u.stat,k=u.proto,S=w?a:j?a[B]:(a[B]||{}).prototype,O=w?b:b[B]||m(b,B,{})[B],R=O.prototype;for(E in d)t=!p(w?E:B+(j?".":"#")+E,u.forced)&&S&&A(S,E),g=O[E],t&&(h=u.noTargetGet?(v=D(S,E))&&v.value:S[E]),C=t&&h?h:d[E],t&&typeof g==typeof C||(x=u.bind&&t?y(C,a):u.wrap&&t?wrapConstructor(C):k&&l(C)?i(C):C,(u.sham||C&&C.sham||g&&g.sham)&&m(x,"sham",!0),m(O,E,x),k&&(A(b,c=B+"Prototype")||m(b,c,{}),m(b[c],E,C),u.real&&R&&!R[E]&&m(R,E,C)))}},{"../internals/create-non-enumerable-property":78,"../internals/function-apply":95,"../internals/function-bind-context":96,"../internals/function-uncurry-this":99,"../internals/global":104,"../internals/has-own-property":105,"../internals/is-callable":114,"../internals/is-forced":116,"../internals/object-get-own-property-descriptor":130,"../internals/path":142}],94:[function(u,d,t){d.exports=function(u){try{return!!u()}catch(u){return!0}}},{}],95:[function(u,d,t){var a=Function.prototype,c=a.apply,i=a.bind,l=a.call;d.exports="object"==typeof Reflect&&Reflect.apply||(i?l.bind(c):function(){return l.apply(c,arguments)})},{}],96:[function(u,d,t){var a=u("../internals/function-uncurry-this"),c=u("../internals/a-callable"),i=a(a.bind);d.exports=function(u,d){return c(u),void 0===d?u:i?i(u,d):function(){return u.apply(d,arguments)}}},{"../internals/a-callable":57,"../internals/function-uncurry-this":99}],97:[function(u,d,t){var a=Function.prototype.call;d.exports=a.bind?a.bind(a):function(){return a.apply(a,arguments)}},{}],98:[function(u,d,t){var a=u("../internals/descriptors"),c=u("../internals/has-own-property"),i=Function.prototype,l=a&&Object.getOwnPropertyDescriptor,D=c(i,"name"),p=D&&"something"===function something(){}.name,b=D&&(!a||a&&l(i,"name").configurable);d.exports={EXISTS:D,PROPER:p,CONFIGURABLE:b}},{"../internals/descriptors":83,"../internals/has-own-property":105}],99:[function(u,d,t){var a=Function.prototype,c=a.bind,i=a.call,l=c&&c.bind(i);d.exports=c?function(u){return u&&l(i,u)}:function(u){return u&&function(){return i.apply(u,arguments)}}},{}],100:[function(u,d,t){var a=u("../internals/path"),c=u("../internals/global"),i=u("../internals/is-callable"),aFunction=function(u){return i(u)?u:void 0};d.exports=function(u,d){return arguments.length<2?aFunction(a[u])||aFunction(c[u]):a[u]&&a[u][d]||c[u]&&c[u][d]}},{"../internals/global":104,"../internals/is-callable":114,"../internals/path":142}],101:[function(u,d,t){var a=u("../internals/classof"),c=u("../internals/get-method"),i=u("../internals/iterators"),l=u("../internals/well-known-symbol")("iterator");d.exports=function(u){if(null!=u)return c(u,l)||c(u,"@@iterator")||i[a(u)]}},{"../internals/classof":75,"../internals/get-method":103,"../internals/iterators":122,"../internals/well-known-symbol":166}],102:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/function-call"),i=u("../internals/a-callable"),l=u("../internals/an-object"),D=u("../internals/try-to-string"),p=u("../internals/get-iterator-method"),b=a.TypeError;d.exports=function(u,d){var t=arguments.length<2?p(u):d;if(i(t))return l(c(t,u));throw b(D(u)+" is not iterable")}},{"../internals/a-callable":57,"../internals/an-object":60,"../internals/function-call":97,"../internals/get-iterator-method":101,"../internals/global":104,"../internals/try-to-string":162}],103:[function(u,d,t){var a=u("../internals/a-callable");d.exports=function(u,d){var t=u[d];return null==t?void 0:a(t)}},{"../internals/a-callable":57}],104:[function(u,d,t){(function(u){(function(){var check=function(u){return u&&u.Math==Math&&u};d.exports=check("object"==typeof globalThis&&globalThis)||check("object"==typeof window&&window)||check("object"==typeof self&&self)||check("object"==typeof u&&u)||function(){return this}()||Function("return this")()}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],105:[function(u,d,t){var a=u("../internals/function-uncurry-this"),c=u("../internals/to-object"),i=a({}.hasOwnProperty);d.exports=Object.hasOwn||function hasOwn(u,d){return i(c(u),d)}},{"../internals/function-uncurry-this":99,"../internals/to-object":157}],106:[function(u,d,t){d.exports={}},{}],107:[function(u,d,t){var a=u("../internals/get-built-in");d.exports=a("document","documentElement")},{"../internals/get-built-in":100}],108:[function(u,d,t){var a=u("../internals/descriptors"),c=u("../internals/fails"),i=u("../internals/document-create-element");d.exports=!a&&!c((function(){return 7!=Object.defineProperty(i("div"),"a",{get:function(){return 7}}).a}))},{"../internals/descriptors":83,"../internals/document-create-element":84,"../internals/fails":94}],109:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/function-uncurry-this"),i=u("../internals/fails"),l=u("../internals/classof-raw"),D=a.Object,p=c("".split);d.exports=i((function(){return!D("z").propertyIsEnumerable(0)}))?function(u){return"String"==l(u)?p(u,""):D(u)}:D},{"../internals/classof-raw":74,"../internals/fails":94,"../internals/function-uncurry-this":99,"../internals/global":104}],110:[function(u,d,t){var a=u("../internals/function-uncurry-this"),c=u("../internals/is-callable"),i=u("../internals/shared-store"),l=a(Function.toString);c(i.inspectSource)||(i.inspectSource=function(u){return l(u)}),d.exports=i.inspectSource},{"../internals/function-uncurry-this":99,"../internals/is-callable":114,"../internals/shared-store":149}],111:[function(u,d,t){var a,c,i,l=u("../internals/native-weak-map"),D=u("../internals/global"),p=u("../internals/function-uncurry-this"),b=u("../internals/is-object"),y=u("../internals/create-non-enumerable-property"),m=u("../internals/has-own-property"),A=u("../internals/shared-store"),E=u("../internals/shared-key"),C=u("../internals/hidden-keys"),g="Object already initialized",h=D.TypeError,x=D.WeakMap;if(l||A.state){var v=A.state||(A.state=new x),B=p(v.get),w=p(v.has),j=p(v.set);a=function(u,d){if(w(v,u))throw new h(g);return d.facade=u,j(v,u,d),d},c=function(u){return B(v,u)||{}},i=function(u){return w(v,u)}}else{var k=E("state");C[k]=!0,a=function(u,d){if(m(u,k))throw new h(g);return d.facade=u,y(u,k,d),d},c=function(u){return m(u,k)?u[k]:{}},i=function(u){return m(u,k)}}d.exports={set:a,get:c,has:i,enforce:function(u){return i(u)?c(u):a(u,{})},getterFor:function(u){return function(d){var t;if(!b(d)||(t=c(d)).type!==u)throw h("Incompatible receiver, "+u+" required");return t}}}},{"../internals/create-non-enumerable-property":78,"../internals/function-uncurry-this":99,"../internals/global":104,"../internals/has-own-property":105,"../internals/hidden-keys":106,"../internals/is-object":117,"../internals/native-weak-map":125,"../internals/shared-key":148,"../internals/shared-store":149}],112:[function(u,d,t){var a=u("../internals/well-known-symbol"),c=u("../internals/iterators"),i=a("iterator"),l=Array.prototype;d.exports=function(u){return void 0!==u&&(c.Array===u||l[i]===u)}},{"../internals/iterators":122,"../internals/well-known-symbol":166}],113:[function(u,d,t){var a=u("../internals/classof-raw");d.exports=Array.isArray||function isArray(u){return"Array"==a(u)}},{"../internals/classof-raw":74}],114:[function(u,d,t){d.exports=function(u){return"function"==typeof u}},{}],115:[function(u,d,t){var a=u("../internals/function-uncurry-this"),c=u("../internals/fails"),i=u("../internals/is-callable"),l=u("../internals/classof"),D=u("../internals/get-built-in"),p=u("../internals/inspect-source"),noop=function(){},b=[],y=D("Reflect","construct"),m=/^\s*(?:class|function)\b/,A=a(m.exec),E=!m.exec(noop),C=function isConstructor(u){if(!i(u))return!1;try{return y(noop,b,u),!0}catch(u){return!1}},g=function isConstructor(u){if(!i(u))return!1;switch(l(u)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return E||!!A(m,p(u))}catch(u){return!0}};g.sham=!0,d.exports=!y||c((function(){var u;return C(C.call)||!C(Object)||!C((function(){u=!0}))||u}))?g:C},{"../internals/classof":75,"../internals/fails":94,"../internals/function-uncurry-this":99,"../internals/get-built-in":100,"../internals/inspect-source":110,"../internals/is-callable":114}],116:[function(u,d,t){var a=u("../internals/fails"),c=u("../internals/is-callable"),i=/#|\.prototype\./,isForced=function(u,d){var t=D[l(u)];return t==b||t!=p&&(c(d)?a(d):!!d)},l=isForced.normalize=function(u){return String(u).replace(i,".").toLowerCase()},D=isForced.data={},p=isForced.NATIVE="N",b=isForced.POLYFILL="P";d.exports=isForced},{"../internals/fails":94,"../internals/is-callable":114}],117:[function(u,d,t){var a=u("../internals/is-callable");d.exports=function(u){return"object"==typeof u?null!==u:a(u)}},{"../internals/is-callable":114}],118:[function(u,d,t){d.exports=!0},{}],119:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/get-built-in"),i=u("../internals/is-callable"),l=u("../internals/object-is-prototype-of"),D=u("../internals/use-symbol-as-uid"),p=a.Object;d.exports=D?function(u){return"symbol"==typeof u}:function(u){var d=c("Symbol");return i(d)&&l(d.prototype,p(u))}},{"../internals/get-built-in":100,"../internals/global":104,"../internals/is-callable":114,"../internals/object-is-prototype-of":135,"../internals/use-symbol-as-uid":164}],120:[function(u,d,t){var a=u("../internals/function-call"),c=u("../internals/an-object"),i=u("../internals/get-method");d.exports=function(u,d,t){var l,D;c(u);try{if(!(l=i(u,"return"))){if("throw"===d)throw t;return t}l=a(l,u)}catch(u){D=!0,l=u}if("throw"===d)throw t;if(D)throw l;return c(l),t}},{"../internals/an-object":60,"../internals/function-call":97,"../internals/get-method":103}],121:[function(u,d,t){"use strict";var a,c,i,l=u("../internals/fails"),D=u("../internals/is-callable"),p=u("../internals/object-create"),b=u("../internals/object-get-prototype-of"),y=u("../internals/redefine"),m=u("../internals/well-known-symbol"),A=u("../internals/is-pure"),E=m("iterator"),C=!1;[].keys&&("next"in(i=[].keys())?(c=b(b(i)))!==Object.prototype&&(a=c):C=!0),null==a||l((function(){var u={};return a[E].call(u)!==u}))?a={}:A&&(a=p(a)),D(a[E])||y(a,E,(function(){return this})),d.exports={IteratorPrototype:a,BUGGY_SAFARI_ITERATORS:C}},{"../internals/fails":94,"../internals/is-callable":114,"../internals/is-pure":118,"../internals/object-create":127,"../internals/object-get-prototype-of":134,"../internals/redefine":143,"../internals/well-known-symbol":166}],122:[function(u,d,t){arguments[4][106][0].apply(t,arguments)},{dup:106}],123:[function(u,d,t){var a=u("../internals/to-length");d.exports=function(u){return a(u.length)}},{"../internals/to-length":156}],124:[function(u,d,t){var a=u("../internals/engine-v8-version"),c=u("../internals/fails");d.exports=!!Object.getOwnPropertySymbols&&!c((function(){var u=Symbol();return!String(u)||!(Object(u)instanceof Symbol)||!Symbol.sham&&a&&a<41}))},{"../internals/engine-v8-version":89,"../internals/fails":94}],125:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/is-callable"),i=u("../internals/inspect-source"),l=a.WeakMap;d.exports=c(l)&&/native code/.test(i(l))},{"../internals/global":104,"../internals/inspect-source":110,"../internals/is-callable":114}],126:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/fails"),i=u("../internals/function-uncurry-this"),l=u("../internals/to-string"),D=u("../internals/string-trim").trim,p=u("../internals/whitespaces"),b=a.parseInt,y=a.Symbol,m=y&&y.iterator,A=/^[+-]?0x/i,E=i(A.exec),C=8!==b(p+"08")||22!==b(p+"0x16")||m&&!c((function(){b(Object(m))}));d.exports=C?function parseInt(u,d){var t=D(l(u));return b(t,d>>>0||(E(A,t)?16:10))}:b},{"../internals/fails":94,"../internals/function-uncurry-this":99,"../internals/global":104,"../internals/string-trim":152,"../internals/to-string":161,"../internals/whitespaces":167}],127:[function(u,d,t){var a,c=u("../internals/an-object"),i=u("../internals/object-define-properties"),l=u("../internals/enum-bug-keys"),D=u("../internals/hidden-keys"),p=u("../internals/html"),b=u("../internals/document-create-element"),y=u("../internals/shared-key"),m=y("IE_PROTO"),EmptyConstructor=function(){},scriptTag=function(u){return"<script>"+u+"</"+"script>"},NullProtoObjectViaActiveX=function(u){u.write(scriptTag("")),u.close();var d=u.parentWindow.Object;return u=null,d},NullProtoObject=function(){try{a=new ActiveXObject("htmlfile")}catch(u){}var u,d;NullProtoObject="undefined"!=typeof document?document.domain&&a?NullProtoObjectViaActiveX(a):((d=b("iframe")).style.display="none",p.appendChild(d),d.src=String("javascript:"),(u=d.contentWindow.document).open(),u.write(scriptTag("document.F=Object")),u.close(),u.F):NullProtoObjectViaActiveX(a);for(var t=l.length;t--;)delete NullProtoObject.prototype[l[t]];return NullProtoObject()};D[m]=!0,d.exports=Object.create||function create(u,d){var t;return null!==u?(EmptyConstructor.prototype=c(u),t=new EmptyConstructor,EmptyConstructor.prototype=null,t[m]=u):t=NullProtoObject(),void 0===d?t:i(t,d)}},{"../internals/an-object":60,"../internals/document-create-element":84,"../internals/enum-bug-keys":92,"../internals/hidden-keys":106,"../internals/html":107,"../internals/object-define-properties":128,"../internals/shared-key":148}],128:[function(u,d,t){var a=u("../internals/descriptors"),c=u("../internals/object-define-property"),i=u("../internals/an-object"),l=u("../internals/to-indexed-object"),D=u("../internals/object-keys");d.exports=a?Object.defineProperties:function defineProperties(u,d){i(u);for(var t,a=l(d),p=D(d),b=p.length,y=0;b>y;)c.f(u,t=p[y++],a[t]);return u}},{"../internals/an-object":60,"../internals/descriptors":83,"../internals/object-define-property":129,"../internals/object-keys":137,"../internals/to-indexed-object":154}],129:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/descriptors"),i=u("../internals/ie8-dom-define"),l=u("../internals/an-object"),D=u("../internals/to-property-key"),p=a.TypeError,b=Object.defineProperty;t.f=c?b:function defineProperty(u,d,t){if(l(u),d=D(d),l(t),i)try{return b(u,d,t)}catch(u){}if("get"in t||"set"in t)throw p("Accessors not supported");return"value"in t&&(u[d]=t.value),u}},{"../internals/an-object":60,"../internals/descriptors":83,"../internals/global":104,"../internals/ie8-dom-define":108,"../internals/to-property-key":159}],130:[function(u,d,t){var a=u("../internals/descriptors"),c=u("../internals/function-call"),i=u("../internals/object-property-is-enumerable"),l=u("../internals/create-property-descriptor"),D=u("../internals/to-indexed-object"),p=u("../internals/to-property-key"),b=u("../internals/has-own-property"),y=u("../internals/ie8-dom-define"),m=Object.getOwnPropertyDescriptor;t.f=a?m:function getOwnPropertyDescriptor(u,d){if(u=D(u),d=p(d),y)try{return m(u,d)}catch(u){}if(b(u,d))return l(!c(i.f,u,d),u[d])}},{"../internals/create-property-descriptor":79,"../internals/descriptors":83,"../internals/function-call":97,"../internals/has-own-property":105,"../internals/ie8-dom-define":108,"../internals/object-property-is-enumerable":138,"../internals/to-indexed-object":154,"../internals/to-property-key":159}],131:[function(u,d,t){var a=u("../internals/classof-raw"),c=u("../internals/to-indexed-object"),i=u("../internals/object-get-own-property-names").f,l=u("../internals/array-slice-simple"),D="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];d.exports.f=function getOwnPropertyNames(u){return D&&"Window"==a(u)?function(u){try{return i(u)}catch(u){return l(D)}}(u):i(c(u))}},{"../internals/array-slice-simple":67,"../internals/classof-raw":74,"../internals/object-get-own-property-names":132,"../internals/to-indexed-object":154}],132:[function(u,d,t){var a=u("../internals/object-keys-internal"),c=u("../internals/enum-bug-keys").concat("length","prototype");t.f=Object.getOwnPropertyNames||function getOwnPropertyNames(u){return a(u,c)}},{"../internals/enum-bug-keys":92,"../internals/object-keys-internal":136}],133:[function(u,d,t){t.f=Object.getOwnPropertySymbols},{}],134:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/has-own-property"),i=u("../internals/is-callable"),l=u("../internals/to-object"),D=u("../internals/shared-key"),p=u("../internals/correct-prototype-getter"),b=D("IE_PROTO"),y=a.Object,m=y.prototype;d.exports=p?y.getPrototypeOf:function(u){var d=l(u);if(c(d,b))return d[b];var t=d.constructor;return i(t)&&d instanceof t?t.prototype:d instanceof y?m:null}},{"../internals/correct-prototype-getter":76,"../internals/global":104,"../internals/has-own-property":105,"../internals/is-callable":114,"../internals/shared-key":148,"../internals/to-object":157}],135:[function(u,d,t){var a=u("../internals/function-uncurry-this");d.exports=a({}.isPrototypeOf)},{"../internals/function-uncurry-this":99}],136:[function(u,d,t){var a=u("../internals/function-uncurry-this"),c=u("../internals/has-own-property"),i=u("../internals/to-indexed-object"),l=u("../internals/array-includes").indexOf,D=u("../internals/hidden-keys"),p=a([].push);d.exports=function(u,d){var t,a=i(u),b=0,y=[];for(t in a)!c(D,t)&&c(a,t)&&p(y,t);for(;d.length>b;)c(a,t=d[b++])&&(~l(y,t)||p(y,t));return y}},{"../internals/array-includes":63,"../internals/function-uncurry-this":99,"../internals/has-own-property":105,"../internals/hidden-keys":106,"../internals/to-indexed-object":154}],137:[function(u,d,t){var a=u("../internals/object-keys-internal"),c=u("../internals/enum-bug-keys");d.exports=Object.keys||function keys(u){return a(u,c)}},{"../internals/enum-bug-keys":92,"../internals/object-keys-internal":136}],138:[function(u,d,t){"use strict";var a={}.propertyIsEnumerable,c=Object.getOwnPropertyDescriptor,i=c&&!a.call({1:2},1);t.f=i?function propertyIsEnumerable(u){var d=c(this,u);return!!d&&d.enumerable}:a},{}],139:[function(u,d,t){var a=u("../internals/function-uncurry-this"),c=u("../internals/an-object"),i=u("../internals/a-possible-prototype");d.exports=Object.setPrototypeOf||("__proto__"in{}?function(){var u,d=!1,t={};try{(u=a(Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set))(t,[]),d=t instanceof Array}catch(u){}return function setPrototypeOf(t,a){return c(t),i(a),d?u(t,a):t.__proto__=a,t}}():void 0)},{"../internals/a-possible-prototype":58,"../internals/an-object":60,"../internals/function-uncurry-this":99}],140:[function(u,d,t){"use strict";var a=u("../internals/to-string-tag-support"),c=u("../internals/classof");d.exports=a?{}.toString:function toString(){return"[object "+c(this)+"]"}},{"../internals/classof":75,"../internals/to-string-tag-support":160}],141:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/function-call"),i=u("../internals/is-callable"),l=u("../internals/is-object"),D=a.TypeError;d.exports=function(u,d){var t,a;if("string"===d&&i(t=u.toString)&&!l(a=c(t,u)))return a;if(i(t=u.valueOf)&&!l(a=c(t,u)))return a;if("string"!==d&&i(t=u.toString)&&!l(a=c(t,u)))return a;throw D("Can't convert object to primitive value")}},{"../internals/function-call":97,"../internals/global":104,"../internals/is-callable":114,"../internals/is-object":117}],142:[function(u,d,t){arguments[4][106][0].apply(t,arguments)},{dup:106}],143:[function(u,d,t){var a=u("../internals/create-non-enumerable-property");d.exports=function(u,d,t,c){c&&c.enumerable?u[d]=t:a(u,d,t)}},{"../internals/create-non-enumerable-property":78}],144:[function(u,d,t){"use strict";var a=u("../internals/an-object");d.exports=function(){var u=a(this),d="";return u.global&&(d+="g"),u.ignoreCase&&(d+="i"),u.multiline&&(d+="m"),u.dotAll&&(d+="s"),u.unicode&&(d+="u"),u.sticky&&(d+="y"),d}},{"../internals/an-object":60}],145:[function(u,d,t){var a=u("../internals/global").TypeError;d.exports=function(u){if(null==u)throw a("Can't call method on "+u);return u}},{"../internals/global":104}],146:[function(u,d,t){var a=u("../internals/global"),c=Object.defineProperty;d.exports=function(u,d){try{c(a,u,{value:d,configurable:!0,writable:!0})}catch(t){a[u]=d}return d}},{"../internals/global":104}],147:[function(u,d,t){var a=u("../internals/to-string-tag-support"),c=u("../internals/object-define-property").f,i=u("../internals/create-non-enumerable-property"),l=u("../internals/has-own-property"),D=u("../internals/object-to-string"),p=u("../internals/well-known-symbol")("toStringTag");d.exports=function(u,d,t,b){if(u){var y=t?u:u.prototype;l(y,p)||c(y,p,{configurable:!0,value:d}),b&&!a&&i(y,"toString",D)}}},{"../internals/create-non-enumerable-property":78,"../internals/has-own-property":105,"../internals/object-define-property":129,"../internals/object-to-string":140,"../internals/to-string-tag-support":160,"../internals/well-known-symbol":166}],148:[function(u,d,t){var a=u("../internals/shared"),c=u("../internals/uid"),i=a("keys");d.exports=function(u){return i[u]||(i[u]=c(u))}},{"../internals/shared":150,"../internals/uid":163}],149:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/set-global"),i="__core-js_shared__",l=a[i]||c(i,{});d.exports=l},{"../internals/global":104,"../internals/set-global":146}],150:[function(u,d,t){var a=u("../internals/is-pure"),c=u("../internals/shared-store");(d.exports=function(u,d){return c[u]||(c[u]=void 0!==d?d:{})})("versions",[]).push({version:"3.20.0",mode:a?"pure":"global",copyright:"© 2021 Denis Pushkarev (zloirock.ru)"})},{"../internals/is-pure":118,"../internals/shared-store":149}],151:[function(u,d,t){var a=u("../internals/function-uncurry-this"),c=u("../internals/to-integer-or-infinity"),i=u("../internals/to-string"),l=u("../internals/require-object-coercible"),D=a("".charAt),p=a("".charCodeAt),b=a("".slice),createMethod=function(u){return function(d,t){var a,y,m=i(l(d)),A=c(t),E=m.length;return A<0||A>=E?u?"":void 0:(a=p(m,A))<55296||a>56319||A+1===E||(y=p(m,A+1))<56320||y>57343?u?D(m,A):a:u?b(m,A,A+2):y-56320+(a-55296<<10)+65536}};d.exports={codeAt:createMethod(!1),charAt:createMethod(!0)}},{"../internals/function-uncurry-this":99,"../internals/require-object-coercible":145,"../internals/to-integer-or-infinity":155,"../internals/to-string":161}],152:[function(u,d,t){var a=u("../internals/function-uncurry-this"),c=u("../internals/require-object-coercible"),i=u("../internals/to-string"),l=u("../internals/whitespaces"),D=a("".replace),p="["+l+"]",b=RegExp("^"+p+p+"*"),y=RegExp(p+p+"*$"),createMethod=function(u){return function(d){var t=i(c(d));return 1&u&&(t=D(t,b,"")),2&u&&(t=D(t,y,"")),t}};d.exports={start:createMethod(1),end:createMethod(2),trim:createMethod(3)}},{"../internals/function-uncurry-this":99,"../internals/require-object-coercible":145,"../internals/to-string":161,"../internals/whitespaces":167}],153:[function(u,d,t){var a=u("../internals/to-integer-or-infinity"),c=Math.max,i=Math.min;d.exports=function(u,d){var t=a(u);return t<0?c(t+d,0):i(t,d)}},{"../internals/to-integer-or-infinity":155}],154:[function(u,d,t){var a=u("../internals/indexed-object"),c=u("../internals/require-object-coercible");d.exports=function(u){return a(c(u))}},{"../internals/indexed-object":109,"../internals/require-object-coercible":145}],155:[function(u,d,t){var a=Math.ceil,c=Math.floor;d.exports=function(u){var d=+u;return d!=d||0===d?0:(d>0?c:a)(d)}},{}],156:[function(u,d,t){var a=u("../internals/to-integer-or-infinity"),c=Math.min;d.exports=function(u){return u>0?c(a(u),9007199254740991):0}},{"../internals/to-integer-or-infinity":155}],157:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/require-object-coercible"),i=a.Object;d.exports=function(u){return i(c(u))}},{"../internals/global":104,"../internals/require-object-coercible":145}],158:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/function-call"),i=u("../internals/is-object"),l=u("../internals/is-symbol"),D=u("../internals/get-method"),p=u("../internals/ordinary-to-primitive"),b=u("../internals/well-known-symbol"),y=a.TypeError,m=b("toPrimitive");d.exports=function(u,d){if(!i(u)||l(u))return u;var t,a=D(u,m);if(a){if(void 0===d&&(d="default"),t=c(a,u,d),!i(t)||l(t))return t;throw y("Can't convert object to primitive value")}return void 0===d&&(d="number"),p(u,d)}},{"../internals/function-call":97,"../internals/get-method":103,"../internals/global":104,"../internals/is-object":117,"../internals/is-symbol":119,"../internals/ordinary-to-primitive":141,"../internals/well-known-symbol":166}],159:[function(u,d,t){var a=u("../internals/to-primitive"),c=u("../internals/is-symbol");d.exports=function(u){var d=a(u,"string");return c(d)?d:d+""}},{"../internals/is-symbol":119,"../internals/to-primitive":158}],160:[function(u,d,t){var a={};a[u("../internals/well-known-symbol")("toStringTag")]="z",d.exports="[object z]"===String(a)},{"../internals/well-known-symbol":166}],161:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/classof"),i=a.String;d.exports=function(u){if("Symbol"===c(u))throw TypeError("Cannot convert a Symbol value to a string");return i(u)}},{"../internals/classof":75,"../internals/global":104}],162:[function(u,d,t){var a=u("../internals/global").String;d.exports=function(u){try{return a(u)}catch(u){return"Object"}}},{"../internals/global":104}],163:[function(u,d,t){var a=u("../internals/function-uncurry-this"),c=0,i=Math.random(),l=a(1..toString);d.exports=function(u){return"Symbol("+(void 0===u?"":u)+")_"+l(++c+i,36)}},{"../internals/function-uncurry-this":99}],164:[function(u,d,t){var a=u("../internals/native-symbol");d.exports=a&&!Symbol.sham&&"symbol"==typeof Symbol.iterator},{"../internals/native-symbol":124}],165:[function(u,d,t){var a=u("../internals/well-known-symbol");t.f=a},{"../internals/well-known-symbol":166}],166:[function(u,d,t){var a=u("../internals/global"),c=u("../internals/shared"),i=u("../internals/has-own-property"),l=u("../internals/uid"),D=u("../internals/native-symbol"),p=u("../internals/use-symbol-as-uid"),b=c("wks"),y=a.Symbol,m=y&&y.for,A=p?y:y&&y.withoutSetter||l;d.exports=function(u){if(!i(b,u)||!D&&"string"!=typeof b[u]){var d="Symbol."+u;D&&i(y,u)?b[u]=y[u]:b[u]=p&&m?m(d):A(d)}return b[u]}},{"../internals/global":104,"../internals/has-own-property":105,"../internals/native-symbol":124,"../internals/shared":150,"../internals/uid":163,"../internals/use-symbol-as-uid":164}],167:[function(u,d,t){d.exports="\t\n\v\f\r                　\u2028\u2029\ufeff"},{}],168:[function(u,d,t){"use strict";var a=u("../internals/export"),c=u("../internals/global"),i=u("../internals/fails"),l=u("../internals/is-array"),D=u("../internals/is-object"),p=u("../internals/to-object"),b=u("../internals/length-of-array-like"),y=u("../internals/create-property"),m=u("../internals/array-species-create"),A=u("../internals/array-method-has-species-support"),E=u("../internals/well-known-symbol"),C=u("../internals/engine-v8-version"),g=E("isConcatSpreadable"),h=9007199254740991,x="Maximum allowed index exceeded",v=c.TypeError,B=C>=51||!i((function(){var u=[];return u[g]=!1,u.concat()[0]!==u})),w=A("concat"),isConcatSpreadable=function(u){if(!D(u))return!1;var d=u[g];return void 0!==d?!!d:l(u)};a({target:"Array",proto:!0,forced:!B||!w},{concat:function concat(u){var d,t,a,c,i,l=p(this),D=m(l,0),A=0;for(d=-1,a=arguments.length;d<a;d++)if(isConcatSpreadable(i=-1===d?l:arguments[d])){if(A+(c=b(i))>h)throw v(x);for(t=0;t<c;t++,A++)t in i&&y(D,A,i[t])}else{if(A>=h)throw v(x);y(D,A++,i)}return D.length=A,D}})},{"../internals/array-method-has-species-support":65,"../internals/array-species-create":71,"../internals/create-property":80,"../internals/engine-v8-version":89,"../internals/export":93,"../internals/fails":94,"../internals/global":104,"../internals/is-array":113,"../internals/is-object":117,"../internals/length-of-array-like":123,"../internals/to-object":157,"../internals/well-known-symbol":166}],169:[function(u,d,t){"use strict";var a=u("../internals/export"),c=u("../internals/array-for-each");a({target:"Array",proto:!0,forced:[].forEach!=c},{forEach:c})},{"../internals/array-for-each":61,"../internals/export":93}],170:[function(u,d,t){var a=u("../internals/export"),c=u("../internals/array-from");a({target:"Array",stat:!0,forced:!u("../internals/check-correctness-of-iteration")((function(u){Array.from(u)}))},{from:c})},{"../internals/array-from":62,"../internals/check-correctness-of-iteration":73,"../internals/export":93}],171:[function(u,d,t){"use strict";var a=u("../internals/export"),c=u("../internals/function-uncurry-this"),i=u("../internals/array-includes").indexOf,l=u("../internals/array-method-is-strict"),D=c([].indexOf),p=!!D&&1/D([1],1,-0)<0,b=l("indexOf");a({target:"Array",proto:!0,forced:p||!b},{indexOf:function indexOf(u){var d=arguments.length>1?arguments[1]:void 0;return p?D(this,u,d)||0:i(this,u,d)}})},{"../internals/array-includes":63,"../internals/array-method-is-strict":66,"../internals/export":93,"../internals/function-uncurry-this":99}],172:[function(u,d,t){u("../internals/export")({target:"Array",stat:!0},{isArray:u("../internals/is-array")})},{"../internals/export":93,"../internals/is-array":113}],173:[function(u,d,t){"use strict";var a=u("../internals/to-indexed-object"),c=u("../internals/add-to-unscopables"),i=u("../internals/iterators"),l=u("../internals/internal-state"),D=u("../internals/object-define-property").f,p=u("../internals/define-iterator"),b=u("../internals/is-pure"),y=u("../internals/descriptors"),m="Array Iterator",A=l.set,E=l.getterFor(m);d.exports=p(Array,"Array",(function(u,d){A(this,{type:m,target:a(u),index:0,kind:d})}),(function(){var u=E(this),d=u.target,t=u.kind,a=u.index++;return!d||a>=d.length?(u.target=void 0,{value:void 0,done:!0}):"keys"==t?{value:a,done:!1}:"values"==t?{value:d[a],done:!1}:{value:[a,d[a]],done:!1}}),"values");var C=i.Arguments=i.Array;if(c("keys"),c("values"),c("entries"),!b&&y&&"values"!==C.name)try{D(C,"name",{value:"values"})}catch(u){}},{"../internals/add-to-unscopables":59,"../internals/define-iterator":81,"../internals/descriptors":83,"../internals/internal-state":111,"../internals/is-pure":118,"../internals/iterators":122,"../internals/object-define-property":129,"../internals/to-indexed-object":154}],174:[function(u,d,t){"use strict";var a=u("../internals/export"),c=u("../internals/global"),i=u("../internals/is-array"),l=u("../internals/is-constructor"),D=u("../internals/is-object"),p=u("../internals/to-absolute-index"),b=u("../internals/length-of-array-like"),y=u("../internals/to-indexed-object"),m=u("../internals/create-property"),A=u("../internals/well-known-symbol"),E=u("../internals/array-method-has-species-support"),C=u("../internals/array-slice"),g=E("slice"),h=A("species"),x=c.Array,v=Math.max;a({target:"Array",proto:!0,forced:!g},{slice:function slice(u,d){var t,a,c,A=y(this),E=b(A),g=p(u,E),B=p(void 0===d?E:d,E);if(i(A)&&(t=A.constructor,(l(t)&&(t===x||i(t.prototype))||D(t)&&null===(t=t[h]))&&(t=void 0),t===x||void 0===t))return C(A,g,B);for(a=new(void 0===t?x:t)(v(B-g,0)),c=0;g<B;g++,c++)g in A&&m(a,c,A[g]);return a.length=c,a}})},{"../internals/array-method-has-species-support":65,"../internals/array-slice":68,"../internals/create-property":80,"../internals/export":93,"../internals/global":104,"../internals/is-array":113,"../internals/is-constructor":115,"../internals/is-object":117,"../internals/length-of-array-like":123,"../internals/to-absolute-index":153,"../internals/to-indexed-object":154,"../internals/well-known-symbol":166}],175:[function(u,d,t){"use strict";var a=u("../internals/export"),c=u("../internals/function-uncurry-this"),i=u("../internals/a-callable"),l=u("../internals/to-object"),D=u("../internals/length-of-array-like"),p=u("../internals/to-string"),b=u("../internals/fails"),y=u("../internals/array-sort"),m=u("../internals/array-method-is-strict"),A=u("../internals/engine-ff-version"),E=u("../internals/engine-is-ie-or-edge"),C=u("../internals/engine-v8-version"),g=u("../internals/engine-webkit-version"),h=[],x=c(h.sort),v=c(h.push),B=b((function(){h.sort(void 0)})),w=b((function(){h.sort(null)})),j=m("sort"),k=!b((function(){if(C)return C<70;if(!(A&&A>3)){if(E)return!0;if(g)return g<603;var u,d,t,a,c="";for(u=65;u<76;u++){switch(d=String.fromCharCode(u),u){case 66:case 69:case 70:case 72:t=3;break;case 68:case 71:t=4;break;default:t=2}for(a=0;a<47;a++)h.push({k:d+a,v:t})}for(h.sort((function(u,d){return d.v-u.v})),a=0;a<h.length;a++)d=h[a].k.charAt(0),c.charAt(c.length-1)!==d&&(c+=d);return"DGBEFHACIJK"!==c}}));a({target:"Array",proto:!0,forced:B||!w||!j||!k},{sort:function sort(u){void 0!==u&&i(u);var d=l(this);if(k)return void 0===u?x(d):x(d,u);var t,a,c=[],b=D(d);for(a=0;a<b;a++)a in d&&v(c,d[a]);for(y(c,function(u){return function(d,t){return void 0===t?-1:void 0===d?1:void 0!==u?+u(d,t)||0:p(d)>p(t)?1:-1}}(u)),t=c.length,a=0;a<t;)d[a]=c[a++];for(;a<b;)delete d[a++];return d}})},{"../internals/a-callable":57,"../internals/array-method-is-strict":66,"../internals/array-sort":69,"../internals/engine-ff-version":86,"../internals/engine-is-ie-or-edge":87,"../internals/engine-v8-version":89,"../internals/engine-webkit-version":90,"../internals/export":93,"../internals/fails":94,"../internals/function-uncurry-this":99,"../internals/length-of-array-like":123,"../internals/to-object":157,"../internals/to-string":161}],176:[function(u,d,t){var a=u("../internals/global");u("../internals/set-to-string-tag")(a.JSON,"JSON",!0)},{"../internals/global":104,"../internals/set-to-string-tag":147}],177:[function(u,d,t){},{}],178:[function(u,d,t){u("../internals/export")({target:"Object",stat:!0,sham:!u("../internals/descriptors")},{create:u("../internals/object-create")})},{"../internals/descriptors":83,"../internals/export":93,"../internals/object-create":127}],179:[function(u,d,t){var a=u("../internals/export"),c=u("../internals/descriptors");a({target:"Object",stat:!0,forced:!c,sham:!c},{defineProperty:u("../internals/object-define-property").f})},{"../internals/descriptors":83,"../internals/export":93,"../internals/object-define-property":129}],180:[function(u,d,t){arguments[4][177][0].apply(t,arguments)},{dup:177}],181:[function(u,d,t){var a=u("../internals/export"),c=u("../internals/number-parse-int");a({global:!0,forced:parseInt!=c},{parseInt:c})},{"../internals/export":93,"../internals/number-parse-int":126}],182:[function(u,d,t){arguments[4][177][0].apply(t,arguments)},{dup:177}],183:[function(u,d,t){arguments[4][177][0].apply(t,arguments)},{dup:177}],184:[function(u,d,t){"use strict";var a=u("../internals/string-multibyte").charAt,c=u("../internals/to-string"),i=u("../internals/internal-state"),l=u("../internals/define-iterator"),D="String Iterator",p=i.set,b=i.getterFor(D);l(String,"String",(function(u){p(this,{type:D,string:c(u),index:0})}),(function next(){var u,d=b(this),t=d.string,c=d.index;return c>=t.length?{value:void 0,done:!0}:(u=a(t,c),d.index+=u.length,{value:u,done:!1})}))},{"../internals/define-iterator":81,"../internals/internal-state":111,"../internals/string-multibyte":151,"../internals/to-string":161}],185:[function(u,d,t){u("../internals/define-well-known-symbol")("asyncIterator")},{"../internals/define-well-known-symbol":82}],186:[function(u,d,t){arguments[4][177][0].apply(t,arguments)},{dup:177}],187:[function(u,d,t){u("../internals/define-well-known-symbol")("hasInstance")},{"../internals/define-well-known-symbol":82}],188:[function(u,d,t){u("../internals/define-well-known-symbol")("isConcatSpreadable")},{"../internals/define-well-known-symbol":82}],189:[function(u,d,t){u("../internals/define-well-known-symbol")("iterator")},{"../internals/define-well-known-symbol":82}],190:[function(u,d,t){"use strict";var a=u("../internals/export"),c=u("../internals/global"),i=u("../internals/get-built-in"),l=u("../internals/function-apply"),D=u("../internals/function-call"),p=u("../internals/function-uncurry-this"),b=u("../internals/is-pure"),y=u("../internals/descriptors"),m=u("../internals/native-symbol"),A=u("../internals/fails"),E=u("../internals/has-own-property"),C=u("../internals/is-array"),g=u("../internals/is-callable"),h=u("../internals/is-object"),x=u("../internals/object-is-prototype-of"),v=u("../internals/is-symbol"),B=u("../internals/an-object"),w=u("../internals/to-object"),j=u("../internals/to-indexed-object"),k=u("../internals/to-property-key"),S=u("../internals/to-string"),O=u("../internals/create-property-descriptor"),R=u("../internals/object-create"),_=u("../internals/object-keys"),T=u("../internals/object-get-own-property-names"),I=u("../internals/object-get-own-property-names-external"),P=u("../internals/object-get-own-property-symbols"),X=u("../internals/object-get-own-property-descriptor"),L=u("../internals/object-define-property"),N=u("../internals/object-property-is-enumerable"),M=u("../internals/array-slice"),U=u("../internals/redefine"),G=u("../internals/shared"),q=u("../internals/shared-key"),z=u("../internals/hidden-keys"),$=u("../internals/uid"),H=u("../internals/well-known-symbol"),Z=u("../internals/well-known-symbol-wrapped"),Y=u("../internals/define-well-known-symbol"),V=u("../internals/set-to-string-tag"),W=u("../internals/internal-state"),J=u("../internals/array-iteration").forEach,K=q("hidden"),Q="Symbol",uu=H("toPrimitive"),eu=W.set,du=W.getterFor(Q),nu=Object.prototype,tu=c.Symbol,ru=tu&&tu.prototype,au=c.TypeError,cu=c.QObject,ou=i("JSON","stringify"),iu=X.f,su=L.f,fu=I.f,lu=N.f,Du=p([].push),pu=G("symbols"),bu=G("op-symbols"),yu=G("string-to-symbol-registry"),Fu=G("symbol-to-string-registry"),mu=G("wks"),Au=!cu||!cu.prototype||!cu.prototype.findChild,Eu=y&&A((function(){return 7!=R(su({},"a",{get:function(){return su(this,"a",{value:7}).a}})).a}))?function(u,d,t){var a=iu(nu,d);a&&delete nu[d],su(u,d,t),a&&u!==nu&&su(nu,d,a)}:su,wrap=function(u,d){var t=pu[u]=R(ru);return eu(t,{type:Q,tag:u,description:d}),y||(t.description=d),t},Cu=function defineProperty(u,d,t){u===nu&&Cu(bu,d,t),B(u);var a=k(d);return B(t),E(pu,a)?(t.enumerable?(E(u,K)&&u[K][a]&&(u[K][a]=!1),t=R(t,{enumerable:O(0,!1)})):(E(u,K)||su(u,K,O(1,{})),u[K][a]=!0),Eu(u,a,t)):su(u,a,t)},gu=function defineProperties(u,d){B(u);var t=j(d),a=_(t).concat(Bu(t));return J(a,(function(d){y&&!D(hu,t,d)||Cu(u,d,t[d])})),u},hu=function propertyIsEnumerable(u){var d=k(u),t=D(lu,this,d);return!(this===nu&&E(pu,d)&&!E(bu,d))&&(!(t||!E(this,d)||!E(pu,d)||E(this,K)&&this[K][d])||t)},xu=function getOwnPropertyDescriptor(u,d){var t=j(u),a=k(d);if(t!==nu||!E(pu,a)||E(bu,a)){var c=iu(t,a);return!c||!E(pu,a)||E(t,K)&&t[K][a]||(c.enumerable=!0),c}},vu=function getOwnPropertyNames(u){var d=fu(j(u)),t=[];return J(d,(function(u){E(pu,u)||E(z,u)||Du(t,u)})),t},Bu=function getOwnPropertySymbols(u){var d=u===nu,t=fu(d?bu:j(u)),a=[];return J(t,(function(u){!E(pu,u)||d&&!E(nu,u)||Du(a,pu[u])})),a};(m||(tu=function Symbol(){if(x(ru,this))throw au("Symbol is not a constructor");var u=arguments.length&&void 0!==arguments[0]?S(arguments[0]):void 0,d=$(u),setter=function(u){this===nu&&D(setter,bu,u),E(this,K)&&E(this[K],d)&&(this[K][d]=!1),Eu(this,d,O(1,u))};return y&&Au&&Eu(nu,d,{configurable:!0,set:setter}),wrap(d,u)},U(ru=tu.prototype,"toString",(function toString(){return du(this).tag})),U(tu,"withoutSetter",(function(u){return wrap($(u),u)})),N.f=hu,L.f=Cu,X.f=xu,T.f=I.f=vu,P.f=Bu,Z.f=function(u){return wrap(H(u),u)},y&&(su(ru,"description",{configurable:!0,get:function description(){return du(this).description}}),b||U(nu,"propertyIsEnumerable",hu,{unsafe:!0}))),a({global:!0,wrap:!0,forced:!m,sham:!m},{Symbol:tu}),J(_(mu),(function(u){Y(u)})),a({target:Q,stat:!0,forced:!m},{for:function(u){var d=S(u);if(E(yu,d))return yu[d];var t=tu(d);return yu[d]=t,Fu[t]=d,t},keyFor:function keyFor(u){if(!v(u))throw au(u+" is not a symbol");if(E(Fu,u))return Fu[u]},useSetter:function(){Au=!0},useSimple:function(){Au=!1}}),a({target:"Object",stat:!0,forced:!m,sham:!y},{create:function create(u,d){return void 0===d?R(u):gu(R(u),d)},defineProperty:Cu,defineProperties:gu,getOwnPropertyDescriptor:xu}),a({target:"Object",stat:!0,forced:!m},{getOwnPropertyNames:vu,getOwnPropertySymbols:Bu}),a({target:"Object",stat:!0,forced:A((function(){P.f(1)}))},{getOwnPropertySymbols:function getOwnPropertySymbols(u){return P.f(w(u))}}),ou)&&a({target:"JSON",stat:!0,forced:!m||A((function(){var u=tu();return"[null]"!=ou([u])||"{}"!=ou({a:u})||"{}"!=ou(Object(u))}))},{stringify:function stringify(u,d,t){var a=M(arguments),c=d;if((h(d)||void 0!==u)&&!v(u))return C(d)||(d=function(u,d){if(g(c)&&(d=D(c,this,u,d)),!v(d))return d}),a[1]=d,l(ou,null,a)}});if(!ru[uu]){var wu=ru.valueOf;U(ru,uu,(function(u){return D(wu,this)}))}V(tu,Q),z[K]=!0},{"../internals/an-object":60,"../internals/array-iteration":64,"../internals/array-slice":68,"../internals/create-property-descriptor":79,"../internals/define-well-known-symbol":82,"../internals/descriptors":83,"../internals/export":93,"../internals/fails":94,"../internals/function-apply":95,"../internals/function-call":97,"../internals/function-uncurry-this":99,"../internals/get-built-in":100,"../internals/global":104,"../internals/has-own-property":105,"../internals/hidden-keys":106,"../internals/internal-state":111,"../internals/is-array":113,"../internals/is-callable":114,"../internals/is-object":117,"../internals/is-pure":118,"../internals/is-symbol":119,"../internals/native-symbol":124,"../internals/object-create":127,"../internals/object-define-property":129,"../internals/object-get-own-property-descriptor":130,"../internals/object-get-own-property-names":132,"../internals/object-get-own-property-names-external":131,"../internals/object-get-own-property-symbols":133,"../internals/object-is-prototype-of":135,"../internals/object-keys":137,"../internals/object-property-is-enumerable":138,"../internals/redefine":143,"../internals/set-to-string-tag":147,"../internals/shared":150,"../internals/shared-key":148,"../internals/to-indexed-object":154,"../internals/to-object":157,"../internals/to-property-key":159,"../internals/to-string":161,"../internals/uid":163,"../internals/well-known-symbol":166,"../internals/well-known-symbol-wrapped":165}],191:[function(u,d,t){u("../internals/define-well-known-symbol")("matchAll")},{"../internals/define-well-known-symbol":82}],192:[function(u,d,t){u("../internals/define-well-known-symbol")("match")},{"../internals/define-well-known-symbol":82}],193:[function(u,d,t){u("../internals/define-well-known-symbol")("replace")},{"../internals/define-well-known-symbol":82}],194:[function(u,d,t){u("../internals/define-well-known-symbol")("search")},{"../internals/define-well-known-symbol":82}],195:[function(u,d,t){u("../internals/define-well-known-symbol")("species")},{"../internals/define-well-known-symbol":82}],196:[function(u,d,t){u("../internals/define-well-known-symbol")("split")},{"../internals/define-well-known-symbol":82}],197:[function(u,d,t){u("../internals/define-well-known-symbol")("toPrimitive")},{"../internals/define-well-known-symbol":82}],198:[function(u,d,t){u("../internals/define-well-known-symbol")("toStringTag")},{"../internals/define-well-known-symbol":82}],199:[function(u,d,t){u("../internals/define-well-known-symbol")("unscopables")},{"../internals/define-well-known-symbol":82}],200:[function(u,d,t){u("../internals/define-well-known-symbol")("asyncDispose")},{"../internals/define-well-known-symbol":82}],201:[function(u,d,t){u("../internals/define-well-known-symbol")("dispose")},{"../internals/define-well-known-symbol":82}],202:[function(u,d,t){u("../internals/define-well-known-symbol")("matcher")},{"../internals/define-well-known-symbol":82}],203:[function(u,d,t){u("../internals/define-well-known-symbol")("metadata")},{"../internals/define-well-known-symbol":82}],204:[function(u,d,t){u("../internals/define-well-known-symbol")("observable")},{"../internals/define-well-known-symbol":82}],205:[function(u,d,t){u("../internals/define-well-known-symbol")("patternMatch")},{"../internals/define-well-known-symbol":82}],206:[function(u,d,t){u("../internals/define-well-known-symbol")("replaceAll")},{"../internals/define-well-known-symbol":82}],207:[function(u,d,t){u("../modules/es.array.iterator");var a=u("../internals/dom-iterables"),c=u("../internals/global"),i=u("../internals/classof"),l=u("../internals/create-non-enumerable-property"),D=u("../internals/iterators"),p=u("../internals/well-known-symbol")("toStringTag");for(var b in a){var y=c[b],m=y&&y.prototype;m&&i(m)!==p&&l(m,p,b),D[b]=D.Array}},{"../internals/classof":75,"../internals/create-non-enumerable-property":78,"../internals/dom-iterables":85,"../internals/global":104,"../internals/iterators":122,"../internals/well-known-symbol":166,"../modules/es.array.iterator":173}],208:[function(u,d,t){var a=u("../../es/array/from");d.exports=a},{"../../es/array/from":34}],209:[function(u,d,t){var a=u("../../es/array/is-array");d.exports=a},{"../../es/array/is-array":35}],210:[function(u,d,t){var a=u("../../../es/array/virtual/for-each");d.exports=a},{"../../../es/array/virtual/for-each":37}],211:[function(u,d,t){var a=u("../es/get-iterator-method");u("../modules/web.dom-collections.iterator"),d.exports=a},{"../es/get-iterator-method":41,"../modules/web.dom-collections.iterator":207}],212:[function(u,d,t){var a=u("../../es/instance/concat");d.exports=a},{"../../es/instance/concat":42}],213:[function(u,d,t){var a=u("../../es/instance/flags");d.exports=a},{"../../es/instance/flags":43}],214:[function(u,d,t){u("../../modules/web.dom-collections.iterator");var a=u("../../internals/classof"),c=u("../../internals/has-own-property"),i=u("../../internals/object-is-prototype-of"),l=u("../array/virtual/for-each"),D=Array.prototype,p={DOMTokenList:!0,NodeList:!0};d.exports=function(u){var d=u.forEach;return u===D||i(D,u)&&d===D.forEach||c(p,a(u))?l:d}},{"../../internals/classof":75,"../../internals/has-own-property":105,"../../internals/object-is-prototype-of":135,"../../modules/web.dom-collections.iterator":207,"../array/virtual/for-each":210}],215:[function(u,d,t){var a=u("../../es/instance/index-of");d.exports=a},{"../../es/instance/index-of":44}],216:[function(u,d,t){var a=u("../../es/instance/slice");d.exports=a},{"../../es/instance/slice":45}],217:[function(u,d,t){var a=u("../../es/instance/sort");d.exports=a},{"../../es/instance/sort":46}],218:[function(u,d,t){var a=u("../../es/object/create");d.exports=a},{"../../es/object/create":47}],219:[function(u,d,t){var a=u("../../es/object/define-property");d.exports=a},{"../../es/object/define-property":48}],220:[function(u,d,t){var a=u("../es/parse-int");d.exports=a},{"../es/parse-int":49}],221:[function(u,d,t){var a=u("../../es/symbol");u("../../modules/web.dom-collections.iterator"),d.exports=a},{"../../es/symbol":51,"../../modules/web.dom-collections.iterator":207}],222:[function(u,d,t){d.exports=[{name:"C",alias:"Other",isBmpLast:!0,bmp:"\0--­͸͹΀-΃΋΍΢԰՗՘֋֌֐׈-׏׫-׮׵-؅؜۝܎܏݋݌޲-޿߻߼࠮࠯࠿࡜࡝࡟࡫-࡯࢏-ࢗ࣢঄঍঎঑঒঩঱঳-঵঺঻৅৆৉৊৏-৖৘-৛৞৤৥৿਀਄਋-਎਑਒਩਱਴਷਺਻਽੃-੆੉੊੎-੐੒-੘੝੟-੥੷-઀઄઎઒઩઱઴઺઻૆૊૎૏૑-૟૤૥૲-૸଀଄଍଎଑଒଩଱଴଺଻୅୆୉୊୎-୔୘-୛୞୤୥୸-஁஄஋-஍஑஖-஘஛஝஠-஢஥-஧஫-஭஺-஽௃-௅௉௎௏௑-௖௘-௥௻-௿఍఑఩఺఻౅౉౎-౔౗౛౜౞౟౤౥౰-౶಍಑಩಴಺಻೅೉೎-೔೗-೜೟೤೥೰ೳ-೿഍഑൅൉൐-൓൤൥඀඄඗-඙඲඼඾඿෇-෉෋-෎෕෗෠-෥෰෱෵-฀฻-฾๜-຀຃຅຋຤຦຾຿໅໇໎໏໚໛໠-໿཈཭-཰྘྽࿍࿛-࿿჆჈-჌჎჏቉቎቏቗቙቞቟኉኎኏኱኶኷኿዁዆዇዗጑጖጗፛፜፽-፿᎚-᎟᏶᏷᏾᏿᚝-᚟᛹-᛿᜖-᜞᜷-᜿᝔-᝟᝭᝱᝴-᝿៞៟៪-៯៺-៿᠎᠚-᠟᡹-᡿᢫-᢯᣶-᣿᤟᤬-᤯᤼-᤿᥁-᥃᥮᥯᥵-᥿᦬-᦯᧊-᧏᧛-᧝᨜᨝᩟᩽᩾᪊-᪏᪚-᪟᪮᪯᫏-᫿᭍-᭏᭿᯴-᯻᰸-᰺᱊-᱌Ᲊ-᲏᲻᲼᳈-᳏᳻-᳿἖἗἞἟὆὇὎὏὘὚὜὞὾὿᾵῅῔῕῜῰῱῵῿​-‏‪-‮⁠-⁯⁲⁳₏₝-₟⃁-⃏⃱-⃿↌-↏␧-␿⑋-⑟⭴⭵⮖⳴-⳸⴦⴨-⴬⴮⴯⵨-⵮⵱-⵾⶗-⶟⶧⶯⶷⶿⷇⷏⷗⷟⹞-⹿⺚⻴-⻿⿖-⿯⿼-⿿぀゗゘㄀-㄄㄰㆏㇤-㇯㈟꒍-꒏꓇-꓏꘬-꘿꛸-꛿Ɤ-꟏꟒꟔Ꟛ-꟱꠭-꠯꠺-꠿꡸-꡿꣆-꣍꣚-꣟꥔-꥞꥽-꥿꧎꧚-꧝꧿꨷-꨿꩎꩏꩚꩛꫃-꫚꫷-꬀꬇꬈꬏꬐꬗-꬟꬧꬯꭬-꭯꯮꯯꯺-꯿힤-힯퟇-퟊퟼-﩮﩯﫚-﫿﬇-﬒﬘-﬜﬷﬽﬿﭂﭅﯃-﯒﶐﶑﷈-﷎﷐-﷯︚-︟﹓﹧﹬-﹯﹵﻽-＀﾿-￁￈￉￐￑￘￙￝-￟￧￯-￻￾￿",astral:"\ud800[\udc0c\udc27\udc3b\udc3e\udc4e\udc4f\udc5e-\udc7f\udcfb-\udcff\udd03-\udd06\udd34-\udd36\udd8f\udd9d-\udd9f\udda1-\uddcf\uddfe-\ude7f\ude9d-\ude9f\uded1-\udedf\udefc-\udeff\udf24-\udf2c\udf4b-\udf4f\udf7b-\udf7f\udf9e\udfc4-\udfc7\udfd6-\udfff]|\ud801[\udc9e\udc9f\udcaa-\udcaf\udcd4-\udcd7\udcfc-\udcff\udd28-\udd2f\udd64-\udd6e\udd7b\udd8b\udd93\udd96\udda2\uddb2\uddba\uddbd-\uddff\udf37-\udf3f\udf56-\udf5f\udf68-\udf7f\udf86\udfb1\udfbb-\udfff]|\ud802[\udc06\udc07\udc09\udc36\udc39-\udc3b\udc3d\udc3e\udc56\udc9f-\udca6\udcb0-\udcdf\udcf3\udcf6-\udcfa\udd1c-\udd1e\udd3a-\udd3e\udd40-\udd7f\uddb8-\uddbb\uddd0\uddd1\ude04\ude07-\ude0b\ude14\ude18\ude36\ude37\ude3b-\ude3e\ude49-\ude4f\ude59-\ude5f\udea0-\udebf\udee7-\udeea\udef7-\udeff\udf36-\udf38\udf56\udf57\udf73-\udf77\udf92-\udf98\udf9d-\udfa8\udfb0-\udfff]|\ud803[\udc49-\udc7f\udcb3-\udcbf\udcf3-\udcf9\udd28-\udd2f\udd3a-\ude5f\ude7f\udeaa\udeae\udeaf\udeb2-\udeff\udf28-\udf2f\udf5a-\udf6f\udf8a-\udfaf\udfcc-\udfdf\udff7-\udfff]|\ud804[\udc4e-\udc51\udc76-\udc7e\udcbd\udcc3-\udccf\udce9-\udcef\udcfa-\udcff\udd35\udd48-\udd4f\udd77-\udd7f\udde0\uddf5-\uddff\ude12\ude3f-\ude7f\ude87\ude89\ude8e\ude9e\udeaa-\udeaf\udeeb-\udeef\udefa-\udeff\udf04\udf0d\udf0e\udf11\udf12\udf29\udf31\udf34\udf3a\udf45\udf46\udf49\udf4a\udf4e\udf4f\udf51-\udf56\udf58-\udf5c\udf64\udf65\udf6d-\udf6f\udf75-\udfff]|\ud805[\udc5c\udc62-\udc7f\udcc8-\udccf\udcda-\udd7f\uddb6\uddb7\uddde-\uddff\ude45-\ude4f\ude5a-\ude5f\ude6d-\ude7f\udeba-\udebf\udeca-\udeff\udf1b\udf1c\udf2c-\udf2f\udf47-\udfff]|\ud806[\udc3c-\udc9f\udcf3-\udcfe\udd07\udd08\udd0a\udd0b\udd14\udd17\udd36\udd39\udd3a\udd47-\udd4f\udd5a-\udd9f\udda8\udda9\uddd8\uddd9\udde5-\uddff\ude48-\ude4f\udea3-\udeaf\udef9-\udfff]|\ud807[\udc09\udc37\udc46-\udc4f\udc6d-\udc6f\udc90\udc91\udca8\udcb7-\udcff\udd07\udd0a\udd37-\udd39\udd3b\udd3e\udd48-\udd4f\udd5a-\udd5f\udd66\udd69\udd8f\udd92\udd99-\udd9f\uddaa-\udedf\udef9-\udfaf\udfb1-\udfbf\udff2-\udffe]|\ud808[\udf9a-\udfff]|\ud809[\udc6f\udc75-\udc7f\udd44-\udfff]|[\ud80a\ud80e-\ud810\ud812-\ud819\ud824-\ud82a\ud82d\ud82e\ud830-\ud832\ud83f\ud87b-\ud87d\ud87f\ud885-\udb3f\udb41-\udbff][\udc00-\udfff]|\ud80b[\udc00-\udf8f\udff3-\udfff]|\ud80d[\udc2f-\udfff]|\ud811[\ude47-\udfff]|\ud81a[\ude39-\ude3f\ude5f\ude6a-\ude6d\udebf\udeca-\udecf\udeee\udeef\udef6-\udeff\udf46-\udf4f\udf5a\udf62\udf78-\udf7c\udf90-\udfff]|\ud81b[\udc00-\ude3f\ude9b-\udeff\udf4b-\udf4e\udf88-\udf8e\udfa0-\udfdf\udfe5-\udfef\udff2-\udfff]|\ud821[\udff8-\udfff]|\ud823[\udcd6-\udcff\udd09-\udfff]|\ud82b[\udc00-\udfef\udff4\udffc\udfff]|\ud82c[\udd23-\udd4f\udd53-\udd63\udd68-\udd6f\udefc-\udfff]|\ud82f[\udc6b-\udc6f\udc7d-\udc7f\udc89-\udc8f\udc9a\udc9b\udca0-\udfff]|\ud833[\udc00-\udeff\udf2e\udf2f\udf47-\udf4f\udfc4-\udfff]|\ud834[\udcf6-\udcff\udd27\udd28\udd73-\udd7a\uddeb-\uddff\ude46-\udedf\udef4-\udeff\udf57-\udf5f\udf79-\udfff]|\ud835[\udc55\udc9d\udca0\udca1\udca3\udca4\udca7\udca8\udcad\udcba\udcbc\udcc4\udd06\udd0b\udd0c\udd15\udd1d\udd3a\udd3f\udd45\udd47-\udd49\udd51\udea6\udea7\udfcc\udfcd]|\ud836[\ude8c-\ude9a\udea0\udeb0-\udfff]|\ud837[\udc00-\udeff\udf1f-\udfff]|\ud838[\udc07\udc19\udc1a\udc22\udc25\udc2b-\udcff\udd2d-\udd2f\udd3e\udd3f\udd4a-\udd4d\udd50-\ude8f\udeaf-\udebf\udefa-\udefe\udf00-\udfff]|\ud839[\udc00-\udfdf\udfe7\udfec\udfef\udfff]|\ud83a[\udcc5\udcc6\udcd7-\udcff\udd4c-\udd4f\udd5a-\udd5d\udd60-\udfff]|\ud83b[\udc00-\udc70\udcb5-\udd00\udd3e-\uddff\ude04\ude20\ude23\ude25\ude26\ude28\ude33\ude38\ude3a\ude3c-\ude41\ude43-\ude46\ude48\ude4a\ude4c\ude50\ude53\ude55\ude56\ude58\ude5a\ude5c\ude5e\ude60\ude63\ude65\ude66\ude6b\ude73\ude78\ude7d\ude7f\ude8a\ude9c-\udea0\udea4\udeaa\udebc-\udeef\udef2-\udfff]|\ud83c[\udc2c-\udc2f\udc94-\udc9f\udcaf\udcb0\udcc0\udcd0\udcf6-\udcff\uddae-\udde5\ude03-\ude0f\ude3c-\ude3f\ude49-\ude4f\ude52-\ude5f\ude66-\udeff]|\ud83d[\uded8-\udedc\udeed-\udeef\udefd-\udeff\udf74-\udf7f\udfd9-\udfdf\udfec-\udfef\udff1-\udfff]|\ud83e[\udc0c-\udc0f\udc48-\udc4f\udc5a-\udc5f\udc88-\udc8f\udcae\udcaf\udcb2-\udcff\ude54-\ude5f\ude6e\ude6f\ude75-\ude77\ude7d-\ude7f\ude87-\ude8f\udead-\udeaf\udebb-\udebf\udec6-\udecf\udeda-\udedf\udee8-\udeef\udef7-\udeff\udf93\udfcb-\udfef\udffa-\udfff]|\ud869[\udee0-\udeff]|\ud86d[\udf39-\udf3f]|\ud86e[\udc1e\udc1f]|\ud873[\udea2-\udeaf]|\ud87a[\udfe1-\udfff]|\ud87e[\ude1e-\udfff]|\ud884[\udf4b-\udfff]|\udb40[\udc00-\udcff\uddf0-\udfff]"},{name:"Cc",alias:"Control",bmp:"\0--"},{name:"Cf",alias:"Format",bmp:"­؀-؅؜۝܏࢐࢑࣢᠎​-‏‪-‮⁠-⁤⁦-⁯\ufeff￹-￻",astral:"\ud804[\udcbd\udccd]|\ud80d[\udc30-\udc38]|\ud82f[\udca0-\udca3]|\ud834[\udd73-\udd7a]|\udb40[\udc01\udc20-\udc7f]"},{name:"Cn",alias:"Unassigned",bmp:"͸͹΀-΃΋΍΢԰՗՘֋֌֐׈-׏׫-׮׵-׿܎݋݌޲-޿߻߼࠮࠯࠿࡜࡝࡟࡫-࡯࢏࢒-ࢗ঄঍঎঑঒঩঱঳-঵঺঻৅৆৉৊৏-৖৘-৛৞৤৥৿਀਄਋-਎਑਒਩਱਴਷਺਻਽੃-੆੉੊੎-੐੒-੘੝੟-੥੷-઀઄઎઒઩઱઴઺઻૆૊૎૏૑-૟૤૥૲-૸଀଄଍଎଑଒଩଱଴଺଻୅୆୉୊୎-୔୘-୛୞୤୥୸-஁஄஋-஍஑஖-஘஛஝஠-஢஥-஧஫-஭஺-஽௃-௅௉௎௏௑-௖௘-௥௻-௿఍఑఩఺఻౅౉౎-౔౗౛౜౞౟౤౥౰-౶಍಑಩಴಺಻೅೉೎-೔೗-೜೟೤೥೰ೳ-೿഍഑൅൉൐-൓൤൥඀඄඗-඙඲඼඾඿෇-෉෋-෎෕෗෠-෥෰෱෵-฀฻-฾๜-຀຃຅຋຤຦຾຿໅໇໎໏໚໛໠-໿཈཭-཰྘྽࿍࿛-࿿჆჈-჌჎჏቉቎቏቗቙቞቟኉኎኏኱኶኷኿዁዆዇዗጑጖጗፛፜፽-፿᎚-᎟᏶᏷᏾᏿᚝-᚟᛹-᛿᜖-᜞᜷-᜿᝔-᝟᝭᝱᝴-᝿៞៟៪-៯៺-៿᠚-᠟᡹-᡿᢫-᢯᣶-᣿᤟᤬-᤯᤼-᤿᥁-᥃᥮᥯᥵-᥿᦬-᦯᧊-᧏᧛-᧝᨜᨝᩟᩽᩾᪊-᪏᪚-᪟᪮᪯᫏-᫿᭍-᭏᭿᯴-᯻᰸-᰺᱊-᱌Ᲊ-᲏᲻᲼᳈-᳏᳻-᳿἖἗἞἟὆὇὎὏὘὚὜὞὾὿᾵῅῔῕῜῰῱῵῿⁥⁲⁳₏₝-₟⃁-⃏⃱-⃿↌-↏␧-␿⑋-⑟⭴⭵⮖⳴-⳸⴦⴨-⴬⴮⴯⵨-⵮⵱-⵾⶗-⶟⶧⶯⶷⶿⷇⷏⷗⷟⹞-⹿⺚⻴-⻿⿖-⿯⿼-⿿぀゗゘㄀-㄄㄰㆏㇤-㇯㈟꒍-꒏꓇-꓏꘬-꘿꛸-꛿Ɤ-꟏꟒꟔Ꟛ-꟱꠭-꠯꠺-꠿꡸-꡿꣆-꣍꣚-꣟꥔-꥞꥽-꥿꧎꧚-꧝꧿꨷-꨿꩎꩏꩚꩛꫃-꫚꫷-꬀꬇꬈꬏꬐꬗-꬟꬧꬯꭬-꭯꯮꯯꯺-꯿힤-힯퟇-퟊퟼-퟿﩮﩯﫚-﫿﬇-﬒﬘-﬜﬷﬽﬿﭂﭅﯃-﯒﶐﶑﷈-﷎﷐-﷯︚-︟﹓﹧﹬-﹯﹵﻽﻾＀﾿-￁￈￉￐￑￘￙￝-￟￧￯-￸￾￿",astral:"\ud800[\udc0c\udc27\udc3b\udc3e\udc4e\udc4f\udc5e-\udc7f\udcfb-\udcff\udd03-\udd06\udd34-\udd36\udd8f\udd9d-\udd9f\udda1-\uddcf\uddfe-\ude7f\ude9d-\ude9f\uded1-\udedf\udefc-\udeff\udf24-\udf2c\udf4b-\udf4f\udf7b-\udf7f\udf9e\udfc4-\udfc7\udfd6-\udfff]|\ud801[\udc9e\udc9f\udcaa-\udcaf\udcd4-\udcd7\udcfc-\udcff\udd28-\udd2f\udd64-\udd6e\udd7b\udd8b\udd93\udd96\udda2\uddb2\uddba\uddbd-\uddff\udf37-\udf3f\udf56-\udf5f\udf68-\udf7f\udf86\udfb1\udfbb-\udfff]|\ud802[\udc06\udc07\udc09\udc36\udc39-\udc3b\udc3d\udc3e\udc56\udc9f-\udca6\udcb0-\udcdf\udcf3\udcf6-\udcfa\udd1c-\udd1e\udd3a-\udd3e\udd40-\udd7f\uddb8-\uddbb\uddd0\uddd1\ude04\ude07-\ude0b\ude14\ude18\ude36\ude37\ude3b-\ude3e\ude49-\ude4f\ude59-\ude5f\udea0-\udebf\udee7-\udeea\udef7-\udeff\udf36-\udf38\udf56\udf57\udf73-\udf77\udf92-\udf98\udf9d-\udfa8\udfb0-\udfff]|\ud803[\udc49-\udc7f\udcb3-\udcbf\udcf3-\udcf9\udd28-\udd2f\udd3a-\ude5f\ude7f\udeaa\udeae\udeaf\udeb2-\udeff\udf28-\udf2f\udf5a-\udf6f\udf8a-\udfaf\udfcc-\udfdf\udff7-\udfff]|\ud804[\udc4e-\udc51\udc76-\udc7e\udcc3-\udccc\udcce\udccf\udce9-\udcef\udcfa-\udcff\udd35\udd48-\udd4f\udd77-\udd7f\udde0\uddf5-\uddff\ude12\ude3f-\ude7f\ude87\ude89\ude8e\ude9e\udeaa-\udeaf\udeeb-\udeef\udefa-\udeff\udf04\udf0d\udf0e\udf11\udf12\udf29\udf31\udf34\udf3a\udf45\udf46\udf49\udf4a\udf4e\udf4f\udf51-\udf56\udf58-\udf5c\udf64\udf65\udf6d-\udf6f\udf75-\udfff]|\ud805[\udc5c\udc62-\udc7f\udcc8-\udccf\udcda-\udd7f\uddb6\uddb7\uddde-\uddff\ude45-\ude4f\ude5a-\ude5f\ude6d-\ude7f\udeba-\udebf\udeca-\udeff\udf1b\udf1c\udf2c-\udf2f\udf47-\udfff]|\ud806[\udc3c-\udc9f\udcf3-\udcfe\udd07\udd08\udd0a\udd0b\udd14\udd17\udd36\udd39\udd3a\udd47-\udd4f\udd5a-\udd9f\udda8\udda9\uddd8\uddd9\udde5-\uddff\ude48-\ude4f\udea3-\udeaf\udef9-\udfff]|\ud807[\udc09\udc37\udc46-\udc4f\udc6d-\udc6f\udc90\udc91\udca8\udcb7-\udcff\udd07\udd0a\udd37-\udd39\udd3b\udd3e\udd48-\udd4f\udd5a-\udd5f\udd66\udd69\udd8f\udd92\udd99-\udd9f\uddaa-\udedf\udef9-\udfaf\udfb1-\udfbf\udff2-\udffe]|\ud808[\udf9a-\udfff]|\ud809[\udc6f\udc75-\udc7f\udd44-\udfff]|[\ud80a\ud80e-\ud810\ud812-\ud819\ud824-\ud82a\ud82d\ud82e\ud830-\ud832\ud83f\ud87b-\ud87d\ud87f\ud885-\udb3f\udb41-\udb7f][\udc00-\udfff]|\ud80b[\udc00-\udf8f\udff3-\udfff]|\ud80d[\udc2f\udc39-\udfff]|\ud811[\ude47-\udfff]|\ud81a[\ude39-\ude3f\ude5f\ude6a-\ude6d\udebf\udeca-\udecf\udeee\udeef\udef6-\udeff\udf46-\udf4f\udf5a\udf62\udf78-\udf7c\udf90-\udfff]|\ud81b[\udc00-\ude3f\ude9b-\udeff\udf4b-\udf4e\udf88-\udf8e\udfa0-\udfdf\udfe5-\udfef\udff2-\udfff]|\ud821[\udff8-\udfff]|\ud823[\udcd6-\udcff\udd09-\udfff]|\ud82b[\udc00-\udfef\udff4\udffc\udfff]|\ud82c[\udd23-\udd4f\udd53-\udd63\udd68-\udd6f\udefc-\udfff]|\ud82f[\udc6b-\udc6f\udc7d-\udc7f\udc89-\udc8f\udc9a\udc9b\udca4-\udfff]|\ud833[\udc00-\udeff\udf2e\udf2f\udf47-\udf4f\udfc4-\udfff]|\ud834[\udcf6-\udcff\udd27\udd28\uddeb-\uddff\ude46-\udedf\udef4-\udeff\udf57-\udf5f\udf79-\udfff]|\ud835[\udc55\udc9d\udca0\udca1\udca3\udca4\udca7\udca8\udcad\udcba\udcbc\udcc4\udd06\udd0b\udd0c\udd15\udd1d\udd3a\udd3f\udd45\udd47-\udd49\udd51\udea6\udea7\udfcc\udfcd]|\ud836[\ude8c-\ude9a\udea0\udeb0-\udfff]|\ud837[\udc00-\udeff\udf1f-\udfff]|\ud838[\udc07\udc19\udc1a\udc22\udc25\udc2b-\udcff\udd2d-\udd2f\udd3e\udd3f\udd4a-\udd4d\udd50-\ude8f\udeaf-\udebf\udefa-\udefe\udf00-\udfff]|\ud839[\udc00-\udfdf\udfe7\udfec\udfef\udfff]|\ud83a[\udcc5\udcc6\udcd7-\udcff\udd4c-\udd4f\udd5a-\udd5d\udd60-\udfff]|\ud83b[\udc00-\udc70\udcb5-\udd00\udd3e-\uddff\ude04\ude20\ude23\ude25\ude26\ude28\ude33\ude38\ude3a\ude3c-\ude41\ude43-\ude46\ude48\ude4a\ude4c\ude50\ude53\ude55\ude56\ude58\ude5a\ude5c\ude5e\ude60\ude63\ude65\ude66\ude6b\ude73\ude78\ude7d\ude7f\ude8a\ude9c-\udea0\udea4\udeaa\udebc-\udeef\udef2-\udfff]|\ud83c[\udc2c-\udc2f\udc94-\udc9f\udcaf\udcb0\udcc0\udcd0\udcf6-\udcff\uddae-\udde5\ude03-\ude0f\ude3c-\ude3f\ude49-\ude4f\ude52-\ude5f\ude66-\udeff]|\ud83d[\uded8-\udedc\udeed-\udeef\udefd-\udeff\udf74-\udf7f\udfd9-\udfdf\udfec-\udfef\udff1-\udfff]|\ud83e[\udc0c-\udc0f\udc48-\udc4f\udc5a-\udc5f\udc88-\udc8f\udcae\udcaf\udcb2-\udcff\ude54-\ude5f\ude6e\ude6f\ude75-\ude77\ude7d-\ude7f\ude87-\ude8f\udead-\udeaf\udebb-\udebf\udec6-\udecf\udeda-\udedf\udee8-\udeef\udef7-\udeff\udf93\udfcb-\udfef\udffa-\udfff]|\ud869[\udee0-\udeff]|\ud86d[\udf39-\udf3f]|\ud86e[\udc1e\udc1f]|\ud873[\udea2-\udeaf]|\ud87a[\udfe1-\udfff]|\ud87e[\ude1e-\udfff]|\ud884[\udf4b-\udfff]|\udb40[\udc00\udc02-\udc1f\udc80-\udcff\uddf0-\udfff]|[\udbbf\udbff][\udffe\udfff]"},{name:"Co",alias:"Private_Use",bmp:"-",astral:"[\udb80-\udbbe\udbc0-\udbfe][\udc00-\udfff]|[\udbbf\udbff][\udc00-\udffd]"},{name:"Cs",alias:"Surrogate",bmp:"\ud800-\udfff"},{name:"L",alias:"Letter",bmp:"A-Za-zªµºÀ-ÖØ-öø-ˁˆ-ˑˠ-ˤˬˮͰ-ʹͶͷͺ-ͽͿΆΈ-ΊΌΎ-ΡΣ-ϵϷ-ҁҊ-ԯԱ-Ֆՙՠ-ֈא-תׯ-ײؠ-يٮٯٱ-ۓەۥۦۮۯۺ-ۼۿܐܒ-ܯݍ-ޥޱߊ-ߪߴߵߺࠀ-ࠕࠚࠤࠨࡀ-ࡘࡠ-ࡪࡰ-ࢇࢉ-ࢎࢠ-ࣉऄ-हऽॐक़-ॡॱ-ঀঅ-ঌএঐও-নপ-রলশ-হঽৎড়ঢ়য়-ৡৰৱৼਅ-ਊਏਐਓ-ਨਪ-ਰਲਲ਼ਵਸ਼ਸਹਖ਼-ੜਫ਼ੲ-ੴઅ-ઍએ-ઑઓ-નપ-રલળવ-હઽૐૠૡૹଅ-ଌଏଐଓ-ନପ-ରଲଳଵ-ହଽଡ଼ଢ଼ୟ-ୡୱஃஅ-ஊஎ-ஐஒ-கஙசஜஞடணதந-பம-ஹௐఅ-ఌఎ-ఐఒ-నప-హఽౘ-ౚౝౠౡಀಅ-ಌಎ-ಐಒ-ನಪ-ಳವ-ಹಽೝೞೠೡೱೲഄ-ഌഎ-ഐഒ-ഺഽൎൔ-ൖൟ-ൡൺ-ൿඅ-ඖක-නඳ-රලව-ෆก-ะาำเ-ๆກຂຄຆ-ຊຌ-ຣລວ-ະາຳຽເ-ໄໆໜ-ໟༀཀ-ཇཉ-ཬྈ-ྌက-ဪဿၐ-ၕၚ-ၝၡၥၦၮ-ၰၵ-ႁႎႠ-ჅჇჍა-ჺჼ-ቈቊ-ቍቐ-ቖቘቚ-ቝበ-ኈኊ-ኍነ-ኰኲ-ኵኸ-ኾዀዂ-ዅወ-ዖዘ-ጐጒ-ጕጘ-ፚᎀ-ᎏᎠ-Ᏽᏸ-ᏽᐁ-ᙬᙯ-ᙿᚁ-ᚚᚠ-ᛪᛱ-ᛸᜀ-ᜑᜟ-ᜱᝀ-ᝑᝠ-ᝬᝮ-ᝰក-ឳៗៜᠠ-ᡸᢀ-ᢄᢇ-ᢨᢪᢰ-ᣵᤀ-ᤞᥐ-ᥭᥰ-ᥴᦀ-ᦫᦰ-ᧉᨀ-ᨖᨠ-ᩔᪧᬅ-ᬳᭅ-ᭌᮃ-ᮠᮮᮯᮺ-ᯥᰀ-ᰣᱍ-ᱏᱚ-ᱽᲀ-ᲈᲐ-ᲺᲽ-Ჿᳩ-ᳬᳮ-ᳳᳵᳶᳺᴀ-ᶿḀ-ἕἘ-Ἕἠ-ὅὈ-Ὅὐ-ὗὙὛὝὟ-ώᾀ-ᾴᾶ-ᾼιῂ-ῄῆ-ῌῐ-ΐῖ-Ίῠ-Ῥῲ-ῴῶ-ῼⁱⁿₐ-ₜℂℇℊ-ℓℕℙ-ℝℤΩℨK-ℭℯ-ℹℼ-ℿⅅ-ⅉⅎↃↄⰀ-ⳤⳫ-ⳮⳲⳳⴀ-ⴥⴧⴭⴰ-ⵧⵯⶀ-ⶖⶠ-ⶦⶨ-ⶮⶰ-ⶶⶸ-ⶾⷀ-ⷆⷈ-ⷎⷐ-ⷖⷘ-ⷞⸯ々〆〱-〵〻〼ぁ-ゖゝ-ゟァ-ヺー-ヿㄅ-ㄯㄱ-ㆎㆠ-ㆿㇰ-ㇿ㐀-䶿一-ꒌꓐ-ꓽꔀ-ꘌꘐ-ꘟꘪꘫꙀ-ꙮꙿ-ꚝꚠ-ꛥꜗ-ꜟꜢ-ꞈꞋ-ꟊꟐꟑꟓꟕ-ꟙꟲ-ꠁꠃ-ꠅꠇ-ꠊꠌ-ꠢꡀ-ꡳꢂ-ꢳꣲ-ꣷꣻꣽꣾꤊ-ꤥꤰ-ꥆꥠ-ꥼꦄ-ꦲꧏꧠ-ꧤꧦ-ꧯꧺ-ꧾꨀ-ꨨꩀ-ꩂꩄ-ꩋꩠ-ꩶꩺꩾ-ꪯꪱꪵꪶꪹ-ꪽꫀꫂꫛ-ꫝꫠ-ꫪꫲ-ꫴꬁ-ꬆꬉ-ꬎꬑ-ꬖꬠ-ꬦꬨ-ꬮꬰ-ꭚꭜ-ꭩꭰ-ꯢ가-힣ힰ-ퟆퟋ-ퟻ豈-舘並-龎ﬀ-ﬆﬓ-ﬗיִײַ-ﬨשׁ-זּטּ-לּמּנּסּףּפּצּ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻﹰ-ﹴﹶ-ﻼＡ-Ｚａ-ｚｦ-ﾾￂ-ￇￊ-ￏￒ-ￗￚ-ￜ",astral:"\ud800[\udc00-\udc0b\udc0d-\udc26\udc28-\udc3a\udc3c\udc3d\udc3f-\udc4d\udc50-\udc5d\udc80-\udcfa\ude80-\ude9c\udea0-\uded0\udf00-\udf1f\udf2d-\udf40\udf42-\udf49\udf50-\udf75\udf80-\udf9d\udfa0-\udfc3\udfc8-\udfcf]|\ud801[\udc00-\udc9d\udcb0-\udcd3\udcd8-\udcfb\udd00-\udd27\udd30-\udd63\udd70-\udd7a\udd7c-\udd8a\udd8c-\udd92\udd94\udd95\udd97-\udda1\udda3-\uddb1\uddb3-\uddb9\uddbb\uddbc\ude00-\udf36\udf40-\udf55\udf60-\udf67\udf80-\udf85\udf87-\udfb0\udfb2-\udfba]|\ud802[\udc00-\udc05\udc08\udc0a-\udc35\udc37\udc38\udc3c\udc3f-\udc55\udc60-\udc76\udc80-\udc9e\udce0-\udcf2\udcf4\udcf5\udd00-\udd15\udd20-\udd39\udd80-\uddb7\uddbe\uddbf\ude00\ude10-\ude13\ude15-\ude17\ude19-\ude35\ude60-\ude7c\ude80-\ude9c\udec0-\udec7\udec9-\udee4\udf00-\udf35\udf40-\udf55\udf60-\udf72\udf80-\udf91]|\ud803[\udc00-\udc48\udc80-\udcb2\udcc0-\udcf2\udd00-\udd23\ude80-\udea9\udeb0\udeb1\udf00-\udf1c\udf27\udf30-\udf45\udf70-\udf81\udfb0-\udfc4\udfe0-\udff6]|\ud804[\udc03-\udc37\udc71\udc72\udc75\udc83-\udcaf\udcd0-\udce8\udd03-\udd26\udd44\udd47\udd50-\udd72\udd76\udd83-\uddb2\uddc1-\uddc4\uddda\udddc\ude00-\ude11\ude13-\ude2b\ude80-\ude86\ude88\ude8a-\ude8d\ude8f-\ude9d\ude9f-\udea8\udeb0-\udede\udf05-\udf0c\udf0f\udf10\udf13-\udf28\udf2a-\udf30\udf32\udf33\udf35-\udf39\udf3d\udf50\udf5d-\udf61]|\ud805[\udc00-\udc34\udc47-\udc4a\udc5f-\udc61\udc80-\udcaf\udcc4\udcc5\udcc7\udd80-\uddae\uddd8-\udddb\ude00-\ude2f\ude44\ude80-\udeaa\udeb8\udf00-\udf1a\udf40-\udf46]|\ud806[\udc00-\udc2b\udca0-\udcdf\udcff-\udd06\udd09\udd0c-\udd13\udd15\udd16\udd18-\udd2f\udd3f\udd41\udda0-\udda7\uddaa-\uddd0\udde1\udde3\ude00\ude0b-\ude32\ude3a\ude50\ude5c-\ude89\ude9d\udeb0-\udef8]|\ud807[\udc00-\udc08\udc0a-\udc2e\udc40\udc72-\udc8f\udd00-\udd06\udd08\udd09\udd0b-\udd30\udd46\udd60-\udd65\udd67\udd68\udd6a-\udd89\udd98\udee0-\udef2\udfb0]|\ud808[\udc00-\udf99]|\ud809[\udc80-\udd43]|\ud80b[\udf90-\udff0]|[\ud80c\ud81c-\ud820\ud822\ud840-\ud868\ud86a-\ud86c\ud86f-\ud872\ud874-\ud879\ud880-\ud883][\udc00-\udfff]|\ud80d[\udc00-\udc2e]|\ud811[\udc00-\ude46]|\ud81a[\udc00-\ude38\ude40-\ude5e\ude70-\udebe\uded0-\udeed\udf00-\udf2f\udf40-\udf43\udf63-\udf77\udf7d-\udf8f]|\ud81b[\ude40-\ude7f\udf00-\udf4a\udf50\udf93-\udf9f\udfe0\udfe1\udfe3]|\ud821[\udc00-\udff7]|\ud823[\udc00-\udcd5\udd00-\udd08]|\ud82b[\udff0-\udff3\udff5-\udffb\udffd\udffe]|\ud82c[\udc00-\udd22\udd50-\udd52\udd64-\udd67\udd70-\udefb]|\ud82f[\udc00-\udc6a\udc70-\udc7c\udc80-\udc88\udc90-\udc99]|\ud835[\udc00-\udc54\udc56-\udc9c\udc9e\udc9f\udca2\udca5\udca6\udca9-\udcac\udcae-\udcb9\udcbb\udcbd-\udcc3\udcc5-\udd05\udd07-\udd0a\udd0d-\udd14\udd16-\udd1c\udd1e-\udd39\udd3b-\udd3e\udd40-\udd44\udd46\udd4a-\udd50\udd52-\udea5\udea8-\udec0\udec2-\udeda\udedc-\udefa\udefc-\udf14\udf16-\udf34\udf36-\udf4e\udf50-\udf6e\udf70-\udf88\udf8a-\udfa8\udfaa-\udfc2\udfc4-\udfcb]|\ud837[\udf00-\udf1e]|\ud838[\udd00-\udd2c\udd37-\udd3d\udd4e\ude90-\udead\udec0-\udeeb]|\ud839[\udfe0-\udfe6\udfe8-\udfeb\udfed\udfee\udff0-\udffe]|\ud83a[\udc00-\udcc4\udd00-\udd43\udd4b]|\ud83b[\ude00-\ude03\ude05-\ude1f\ude21\ude22\ude24\ude27\ude29-\ude32\ude34-\ude37\ude39\ude3b\ude42\ude47\ude49\ude4b\ude4d-\ude4f\ude51\ude52\ude54\ude57\ude59\ude5b\ude5d\ude5f\ude61\ude62\ude64\ude67-\ude6a\ude6c-\ude72\ude74-\ude77\ude79-\ude7c\ude7e\ude80-\ude89\ude8b-\ude9b\udea1-\udea3\udea5-\udea9\udeab-\udebb]|\ud869[\udc00-\udedf\udf00-\udfff]|\ud86d[\udc00-\udf38\udf40-\udfff]|\ud86e[\udc00-\udc1d\udc20-\udfff]|\ud873[\udc00-\udea1\udeb0-\udfff]|\ud87a[\udc00-\udfe0]|\ud87e[\udc00-\ude1d]|\ud884[\udc00-\udf4a]"},{name:"LC",alias:"Cased_Letter",bmp:"A-Za-zµÀ-ÖØ-öø-ƺƼ-ƿǄ-ʓʕ-ʯͰ-ͳͶͷͻ-ͽͿΆΈ-ΊΌΎ-ΡΣ-ϵϷ-ҁҊ-ԯԱ-Ֆՠ-ֈႠ-ჅჇჍა-ჺჽ-ჿᎠ-Ᏽᏸ-ᏽᲀ-ᲈᲐ-ᲺᲽ-Ჿᴀ-ᴫᵫ-ᵷᵹ-ᶚḀ-ἕἘ-Ἕἠ-ὅὈ-Ὅὐ-ὗὙὛὝὟ-ώᾀ-ᾴᾶ-ᾼιῂ-ῄῆ-ῌῐ-ΐῖ-Ίῠ-Ῥῲ-ῴῶ-ῼℂℇℊ-ℓℕℙ-ℝℤΩℨK-ℭℯ-ℴℹℼ-ℿⅅ-ⅉⅎↃↄⰀ-ⱻⱾ-ⳤⳫ-ⳮⳲⳳⴀ-ⴥⴧⴭꙀ-ꙭꚀ-ꚛꜢ-ꝯꝱ-ꞇꞋ-ꞎꞐ-ꟊꟐꟑꟓꟕ-ꟙꟵꟶꟺꬰ-ꭚꭠ-ꭨꭰ-ꮿﬀ-ﬆﬓ-ﬗＡ-Ｚａ-ｚ",astral:"\ud801[\udc00-\udc4f\udcb0-\udcd3\udcd8-\udcfb\udd70-\udd7a\udd7c-\udd8a\udd8c-\udd92\udd94\udd95\udd97-\udda1\udda3-\uddb1\uddb3-\uddb9\uddbb\uddbc]|\ud803[\udc80-\udcb2\udcc0-\udcf2]|\ud806[\udca0-\udcdf]|\ud81b[\ude40-\ude7f]|\ud835[\udc00-\udc54\udc56-\udc9c\udc9e\udc9f\udca2\udca5\udca6\udca9-\udcac\udcae-\udcb9\udcbb\udcbd-\udcc3\udcc5-\udd05\udd07-\udd0a\udd0d-\udd14\udd16-\udd1c\udd1e-\udd39\udd3b-\udd3e\udd40-\udd44\udd46\udd4a-\udd50\udd52-\udea5\udea8-\udec0\udec2-\udeda\udedc-\udefa\udefc-\udf14\udf16-\udf34\udf36-\udf4e\udf50-\udf6e\udf70-\udf88\udf8a-\udfa8\udfaa-\udfc2\udfc4-\udfcb]|\ud837[\udf00-\udf09\udf0b-\udf1e]|\ud83a[\udd00-\udd43]"},{name:"Ll",alias:"Lowercase_Letter",bmp:"a-zµß-öø-ÿāăąćĉċčďđēĕėęěĝğġģĥħĩīĭįıĳĵķĸĺļľŀłńņňŉŋōŏőœŕŗřśŝşšţťŧũūŭůűųŵŷźżž-ƀƃƅƈƌƍƒƕƙ-ƛƞơƣƥƨƪƫƭưƴƶƹƺƽ-ƿǆǉǌǎǐǒǔǖǘǚǜǝǟǡǣǥǧǩǫǭǯǰǳǵǹǻǽǿȁȃȅȇȉȋȍȏȑȓȕȗșțȝȟȡȣȥȧȩȫȭȯȱȳ-ȹȼȿɀɂɇɉɋɍɏ-ʓʕ-ʯͱͳͷͻ-ͽΐά-ώϐϑϕ-ϗϙϛϝϟϡϣϥϧϩϫϭϯ-ϳϵϸϻϼа-џѡѣѥѧѩѫѭѯѱѳѵѷѹѻѽѿҁҋҍҏґғҕҗҙқҝҟҡңҥҧҩҫҭүұҳҵҷҹһҽҿӂӄӆӈӊӌӎӏӑӓӕӗәӛӝӟӡӣӥӧөӫӭӯӱӳӵӷӹӻӽӿԁԃԅԇԉԋԍԏԑԓԕԗԙԛԝԟԡԣԥԧԩԫԭԯՠ-ֈა-ჺჽ-ჿᏸ-ᏽᲀ-ᲈᴀ-ᴫᵫ-ᵷᵹ-ᶚḁḃḅḇḉḋḍḏḑḓḕḗḙḛḝḟḡḣḥḧḩḫḭḯḱḳḵḷḹḻḽḿṁṃṅṇṉṋṍṏṑṓṕṗṙṛṝṟṡṣṥṧṩṫṭṯṱṳṵṷṹṻṽṿẁẃẅẇẉẋẍẏẑẓẕ-ẝẟạảấầẩẫậắằẳẵặẹẻẽếềểễệỉịọỏốồổỗộớờởỡợụủứừửữựỳỵỷỹỻỽỿ-ἇἐ-ἕἠ-ἧἰ-ἷὀ-ὅὐ-ὗὠ-ὧὰ-ώᾀ-ᾇᾐ-ᾗᾠ-ᾧᾰ-ᾴᾶᾷιῂ-ῄῆῇῐ-ΐῖῗῠ-ῧῲ-ῴῶῷℊℎℏℓℯℴℹℼℽⅆ-ⅉⅎↄⰰ-ⱟⱡⱥⱦⱨⱪⱬⱱⱳⱴⱶ-ⱻⲁⲃⲅⲇⲉⲋⲍⲏⲑⲓⲕⲗⲙⲛⲝⲟⲡⲣⲥⲧⲩⲫⲭⲯⲱⲳⲵⲷⲹⲻⲽⲿⳁⳃⳅⳇⳉⳋⳍⳏⳑⳓⳕⳗⳙⳛⳝⳟⳡⳣⳤⳬⳮⳳⴀ-ⴥⴧⴭꙁꙃꙅꙇꙉꙋꙍꙏꙑꙓꙕꙗꙙꙛꙝꙟꙡꙣꙥꙧꙩꙫꙭꚁꚃꚅꚇꚉꚋꚍꚏꚑꚓꚕꚗꚙꚛꜣꜥꜧꜩꜫꜭꜯ-ꜱꜳꜵꜷꜹꜻꜽꜿꝁꝃꝅꝇꝉꝋꝍꝏꝑꝓꝕꝗꝙꝛꝝꝟꝡꝣꝥꝧꝩꝫꝭꝯꝱ-ꝸꝺꝼꝿꞁꞃꞅꞇꞌꞎꞑꞓ-ꞕꞗꞙꞛꞝꞟꞡꞣꞥꞧꞩꞯꞵꞷꞹꞻꞽꞿꟁꟃꟈꟊꟑꟓꟕꟗꟙꟶꟺꬰ-ꭚꭠ-ꭨꭰ-ꮿﬀ-ﬆﬓ-ﬗａ-ｚ",astral:"\ud801[\udc28-\udc4f\udcd8-\udcfb\udd97-\udda1\udda3-\uddb1\uddb3-\uddb9\uddbb\uddbc]|\ud803[\udcc0-\udcf2]|\ud806[\udcc0-\udcdf]|\ud81b[\ude60-\ude7f]|\ud835[\udc1a-\udc33\udc4e-\udc54\udc56-\udc67\udc82-\udc9b\udcb6-\udcb9\udcbb\udcbd-\udcc3\udcc5-\udccf\udcea-\udd03\udd1e-\udd37\udd52-\udd6b\udd86-\udd9f\uddba-\uddd3\uddee-\ude07\ude22-\ude3b\ude56-\ude6f\ude8a-\udea5\udec2-\udeda\udedc-\udee1\udefc-\udf14\udf16-\udf1b\udf36-\udf4e\udf50-\udf55\udf70-\udf88\udf8a-\udf8f\udfaa-\udfc2\udfc4-\udfc9\udfcb]|\ud837[\udf00-\udf09\udf0b-\udf1e]|\ud83a[\udd22-\udd43]"},{name:"Lm",alias:"Modifier_Letter",bmp:"ʰ-ˁˆ-ˑˠ-ˤˬˮʹͺՙـۥۦߴߵߺࠚࠤࠨࣉॱๆໆჼៗᡃᪧᱸ-ᱽᴬ-ᵪᵸᶛ-ᶿⁱⁿₐ-ₜⱼⱽⵯⸯ々〱-〵〻ゝゞー-ヾꀕꓸ-ꓽꘌꙿꚜꚝꜗ-ꜟꝰꞈꟲ-ꟴꟸꟹꧏꧦꩰꫝꫳꫴꭜ-ꭟꭩｰﾞﾟ",astral:"\ud801[\udf80-\udf85\udf87-\udfb0\udfb2-\udfba]|\ud81a[\udf40-\udf43]|\ud81b[\udf93-\udf9f\udfe0\udfe1\udfe3]|\ud82b[\udff0-\udff3\udff5-\udffb\udffd\udffe]|\ud838[\udd37-\udd3d]|𞥋"},{name:"Lo",alias:"Other_Letter",bmp:"ªºƻǀ-ǃʔא-תׯ-ײؠ-ؿف-يٮٯٱ-ۓەۮۯۺ-ۼۿܐܒ-ܯݍ-ޥޱߊ-ߪࠀ-ࠕࡀ-ࡘࡠ-ࡪࡰ-ࢇࢉ-ࢎࢠ-ࣈऄ-हऽॐक़-ॡॲ-ঀঅ-ঌএঐও-নপ-রলশ-হঽৎড়ঢ়য়-ৡৰৱৼਅ-ਊਏਐਓ-ਨਪ-ਰਲਲ਼ਵਸ਼ਸਹਖ਼-ੜਫ਼ੲ-ੴઅ-ઍએ-ઑઓ-નપ-રલળવ-હઽૐૠૡૹଅ-ଌଏଐଓ-ନପ-ରଲଳଵ-ହଽଡ଼ଢ଼ୟ-ୡୱஃஅ-ஊஎ-ஐஒ-கஙசஜஞடணதந-பம-ஹௐఅ-ఌఎ-ఐఒ-నప-హఽౘ-ౚౝౠౡಀಅ-ಌಎ-ಐಒ-ನಪ-ಳವ-ಹಽೝೞೠೡೱೲഄ-ഌഎ-ഐഒ-ഺഽൎൔ-ൖൟ-ൡൺ-ൿඅ-ඖක-නඳ-රලව-ෆก-ะาำเ-ๅກຂຄຆ-ຊຌ-ຣລວ-ະາຳຽເ-ໄໜ-ໟༀཀ-ཇཉ-ཬྈ-ྌက-ဪဿၐ-ၕၚ-ၝၡၥၦၮ-ၰၵ-ႁႎᄀ-ቈቊ-ቍቐ-ቖቘቚ-ቝበ-ኈኊ-ኍነ-ኰኲ-ኵኸ-ኾዀዂ-ዅወ-ዖዘ-ጐጒ-ጕጘ-ፚᎀ-ᎏᐁ-ᙬᙯ-ᙿᚁ-ᚚᚠ-ᛪᛱ-ᛸᜀ-ᜑᜟ-ᜱᝀ-ᝑᝠ-ᝬᝮ-ᝰក-ឳៜᠠ-ᡂᡄ-ᡸᢀ-ᢄᢇ-ᢨᢪᢰ-ᣵᤀ-ᤞᥐ-ᥭᥰ-ᥴᦀ-ᦫᦰ-ᧉᨀ-ᨖᨠ-ᩔᬅ-ᬳᭅ-ᭌᮃ-ᮠᮮᮯᮺ-ᯥᰀ-ᰣᱍ-ᱏᱚ-ᱷᳩ-ᳬᳮ-ᳳᳵᳶᳺℵ-ℸⴰ-ⵧⶀ-ⶖⶠ-ⶦⶨ-ⶮⶰ-ⶶⶸ-ⶾⷀ-ⷆⷈ-ⷎⷐ-ⷖⷘ-ⷞ〆〼ぁ-ゖゟァ-ヺヿㄅ-ㄯㄱ-ㆎㆠ-ㆿㇰ-ㇿ㐀-䶿一-ꀔꀖ-ꒌꓐ-ꓷꔀ-ꘋꘐ-ꘟꘪꘫꙮꚠ-ꛥꞏꟷꟻ-ꠁꠃ-ꠅꠇ-ꠊꠌ-ꠢꡀ-ꡳꢂ-ꢳꣲ-ꣷꣻꣽꣾꤊ-ꤥꤰ-ꥆꥠ-ꥼꦄ-ꦲꧠ-ꧤꧧ-ꧯꧺ-ꧾꨀ-ꨨꩀ-ꩂꩄ-ꩋꩠ-ꩯꩱ-ꩶꩺꩾ-ꪯꪱꪵꪶꪹ-ꪽꫀꫂꫛꫜꫠ-ꫪꫲꬁ-ꬆꬉ-ꬎꬑ-ꬖꬠ-ꬦꬨ-ꬮꯀ-ꯢ가-힣ힰ-ퟆퟋ-ퟻ豈-舘並-龎יִײַ-ﬨשׁ-זּטּ-לּמּנּסּףּפּצּ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻﹰ-ﹴﹶ-ﻼｦ-ｯｱ-ﾝﾠ-ﾾￂ-ￇￊ-ￏￒ-ￗￚ-ￜ",astral:"\ud800[\udc00-\udc0b\udc0d-\udc26\udc28-\udc3a\udc3c\udc3d\udc3f-\udc4d\udc50-\udc5d\udc80-\udcfa\ude80-\ude9c\udea0-\uded0\udf00-\udf1f\udf2d-\udf40\udf42-\udf49\udf50-\udf75\udf80-\udf9d\udfa0-\udfc3\udfc8-\udfcf]|\ud801[\udc50-\udc9d\udd00-\udd27\udd30-\udd63\ude00-\udf36\udf40-\udf55\udf60-\udf67]|\ud802[\udc00-\udc05\udc08\udc0a-\udc35\udc37\udc38\udc3c\udc3f-\udc55\udc60-\udc76\udc80-\udc9e\udce0-\udcf2\udcf4\udcf5\udd00-\udd15\udd20-\udd39\udd80-\uddb7\uddbe\uddbf\ude00\ude10-\ude13\ude15-\ude17\ude19-\ude35\ude60-\ude7c\ude80-\ude9c\udec0-\udec7\udec9-\udee4\udf00-\udf35\udf40-\udf55\udf60-\udf72\udf80-\udf91]|\ud803[\udc00-\udc48\udd00-\udd23\ude80-\udea9\udeb0\udeb1\udf00-\udf1c\udf27\udf30-\udf45\udf70-\udf81\udfb0-\udfc4\udfe0-\udff6]|\ud804[\udc03-\udc37\udc71\udc72\udc75\udc83-\udcaf\udcd0-\udce8\udd03-\udd26\udd44\udd47\udd50-\udd72\udd76\udd83-\uddb2\uddc1-\uddc4\uddda\udddc\ude00-\ude11\ude13-\ude2b\ude80-\ude86\ude88\ude8a-\ude8d\ude8f-\ude9d\ude9f-\udea8\udeb0-\udede\udf05-\udf0c\udf0f\udf10\udf13-\udf28\udf2a-\udf30\udf32\udf33\udf35-\udf39\udf3d\udf50\udf5d-\udf61]|\ud805[\udc00-\udc34\udc47-\udc4a\udc5f-\udc61\udc80-\udcaf\udcc4\udcc5\udcc7\udd80-\uddae\uddd8-\udddb\ude00-\ude2f\ude44\ude80-\udeaa\udeb8\udf00-\udf1a\udf40-\udf46]|\ud806[\udc00-\udc2b\udcff-\udd06\udd09\udd0c-\udd13\udd15\udd16\udd18-\udd2f\udd3f\udd41\udda0-\udda7\uddaa-\uddd0\udde1\udde3\ude00\ude0b-\ude32\ude3a\ude50\ude5c-\ude89\ude9d\udeb0-\udef8]|\ud807[\udc00-\udc08\udc0a-\udc2e\udc40\udc72-\udc8f\udd00-\udd06\udd08\udd09\udd0b-\udd30\udd46\udd60-\udd65\udd67\udd68\udd6a-\udd89\udd98\udee0-\udef2\udfb0]|\ud808[\udc00-\udf99]|\ud809[\udc80-\udd43]|\ud80b[\udf90-\udff0]|[\ud80c\ud81c-\ud820\ud822\ud840-\ud868\ud86a-\ud86c\ud86f-\ud872\ud874-\ud879\ud880-\ud883][\udc00-\udfff]|\ud80d[\udc00-\udc2e]|\ud811[\udc00-\ude46]|\ud81a[\udc00-\ude38\ude40-\ude5e\ude70-\udebe\uded0-\udeed\udf00-\udf2f\udf63-\udf77\udf7d-\udf8f]|\ud81b[\udf00-\udf4a\udf50]|\ud821[\udc00-\udff7]|\ud823[\udc00-\udcd5\udd00-\udd08]|\ud82c[\udc00-\udd22\udd50-\udd52\udd64-\udd67\udd70-\udefb]|\ud82f[\udc00-\udc6a\udc70-\udc7c\udc80-\udc88\udc90-\udc99]|𝼊|\ud838[\udd00-\udd2c\udd4e\ude90-\udead\udec0-\udeeb]|\ud839[\udfe0-\udfe6\udfe8-\udfeb\udfed\udfee\udff0-\udffe]|\ud83a[\udc00-\udcc4]|\ud83b[\ude00-\ude03\ude05-\ude1f\ude21\ude22\ude24\ude27\ude29-\ude32\ude34-\ude37\ude39\ude3b\ude42\ude47\ude49\ude4b\ude4d-\ude4f\ude51\ude52\ude54\ude57\ude59\ude5b\ude5d\ude5f\ude61\ude62\ude64\ude67-\ude6a\ude6c-\ude72\ude74-\ude77\ude79-\ude7c\ude7e\ude80-\ude89\ude8b-\ude9b\udea1-\udea3\udea5-\udea9\udeab-\udebb]|\ud869[\udc00-\udedf\udf00-\udfff]|\ud86d[\udc00-\udf38\udf40-\udfff]|\ud86e[\udc00-\udc1d\udc20-\udfff]|\ud873[\udc00-\udea1\udeb0-\udfff]|\ud87a[\udc00-\udfe0]|\ud87e[\udc00-\ude1d]|\ud884[\udc00-\udf4a]"},{name:"Lt",alias:"Titlecase_Letter",bmp:"ǅǈǋǲᾈ-ᾏᾘ-ᾟᾨ-ᾯᾼῌῼ"},{name:"Lu",alias:"Uppercase_Letter",bmp:"A-ZÀ-ÖØ-ÞĀĂĄĆĈĊČĎĐĒĔĖĘĚĜĞĠĢĤĦĨĪĬĮİĲĴĶĹĻĽĿŁŃŅŇŊŌŎŐŒŔŖŘŚŜŞŠŢŤŦŨŪŬŮŰŲŴŶŸŹŻŽƁƂƄƆƇƉ-ƋƎ-ƑƓƔƖ-ƘƜƝƟƠƢƤƦƧƩƬƮƯƱ-ƳƵƷƸƼǄǇǊǍǏǑǓǕǗǙǛǞǠǢǤǦǨǪǬǮǱǴǶ-ǸǺǼǾȀȂȄȆȈȊȌȎȐȒȔȖȘȚȜȞȠȢȤȦȨȪȬȮȰȲȺȻȽȾɁɃ-ɆɈɊɌɎͰͲͶͿΆΈ-ΊΌΎΏΑ-ΡΣ-ΫϏϒ-ϔϘϚϜϞϠϢϤϦϨϪϬϮϴϷϹϺϽ-ЯѠѢѤѦѨѪѬѮѰѲѴѶѸѺѼѾҀҊҌҎҐҒҔҖҘҚҜҞҠҢҤҦҨҪҬҮҰҲҴҶҸҺҼҾӀӁӃӅӇӉӋӍӐӒӔӖӘӚӜӞӠӢӤӦӨӪӬӮӰӲӴӶӸӺӼӾԀԂԄԆԈԊԌԎԐԒԔԖԘԚԜԞԠԢԤԦԨԪԬԮԱ-ՖႠ-ჅჇჍᎠ-ᏵᲐ-ᲺᲽ-ᲿḀḂḄḆḈḊḌḎḐḒḔḖḘḚḜḞḠḢḤḦḨḪḬḮḰḲḴḶḸḺḼḾṀṂṄṆṈṊṌṎṐṒṔṖṘṚṜṞṠṢṤṦṨṪṬṮṰṲṴṶṸṺṼṾẀẂẄẆẈẊẌẎẐẒẔẞẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼẾỀỂỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪỬỮỰỲỴỶỸỺỼỾἈ-ἏἘ-ἝἨ-ἯἸ-ἿὈ-ὍὙὛὝὟὨ-ὯᾸ-ΆῈ-ΉῘ-ΊῨ-ῬῸ-Ώℂℇℋ-ℍℐ-ℒℕℙ-ℝℤΩℨK-ℭℰ-ℳℾℿⅅↃⰀ-ⰯⱠⱢ-ⱤⱧⱩⱫⱭ-ⱰⱲⱵⱾ-ⲀⲂⲄⲆⲈⲊⲌⲎⲐⲒⲔⲖⲘⲚⲜⲞⲠⲢⲤⲦⲨⲪⲬⲮⲰⲲⲴⲶⲸⲺⲼⲾⳀⳂⳄⳆⳈⳊⳌⳎⳐⳒⳔⳖⳘⳚⳜⳞⳠⳢⳫⳭⳲꙀꙂꙄꙆꙈꙊꙌꙎꙐꙒꙔꙖꙘꙚꙜꙞꙠꙢꙤꙦꙨꙪꙬꚀꚂꚄꚆꚈꚊꚌꚎꚐꚒꚔꚖꚘꚚꜢꜤꜦꜨꜪꜬꜮꜲꜴꜶꜸꜺꜼꜾꝀꝂꝄꝆꝈꝊꝌꝎꝐꝒꝔꝖꝘꝚꝜꝞꝠꝢꝤꝦꝨꝪꝬꝮꝹꝻꝽꝾꞀꞂꞄꞆꞋꞍꞐꞒꞖꞘꞚꞜꞞꞠꞢꞤꞦꞨꞪ-ꞮꞰ-ꞴꞶꞸꞺꞼꞾꟀꟂꟄ-ꟇꟉꟐꟖꟘꟵＡ-Ｚ",astral:"\ud801[\udc00-\udc27\udcb0-\udcd3\udd70-\udd7a\udd7c-\udd8a\udd8c-\udd92\udd94\udd95]|\ud803[\udc80-\udcb2]|\ud806[\udca0-\udcbf]|\ud81b[\ude40-\ude5f]|\ud835[\udc00-\udc19\udc34-\udc4d\udc68-\udc81\udc9c\udc9e\udc9f\udca2\udca5\udca6\udca9-\udcac\udcae-\udcb5\udcd0-\udce9\udd04\udd05\udd07-\udd0a\udd0d-\udd14\udd16-\udd1c\udd38\udd39\udd3b-\udd3e\udd40-\udd44\udd46\udd4a-\udd50\udd6c-\udd85\udda0-\uddb9\uddd4-\udded\ude08-\ude21\ude3c-\ude55\ude70-\ude89\udea8-\udec0\udee2-\udefa\udf1c-\udf34\udf56-\udf6e\udf90-\udfa8\udfca]|\ud83a[\udd00-\udd21]"},{name:"M",alias:"Mark",bmp:"̀-ͯ҃-҉֑-ׇֽֿׁׂׅׄؐ-ًؚ-ٰٟۖ-ۜ۟-۪ۤۧۨ-ܑۭܰ-݊ަ-ް߫-߽߳ࠖ-࠙ࠛ-ࠣࠥ-ࠧࠩ-࡙࠭-࡛࢘-࢟࣊-ࣣ࣡-ःऺ-़ा-ॏ॑-ॗॢॣঁ-ঃ়া-ৄেৈো-্ৗৢৣ৾ਁ-ਃ਼ਾ-ੂੇੈੋ-੍ੑੰੱੵઁ-ઃ઼ા-ૅે-ૉો-્ૢૣૺ-૿ଁ-ଃ଼ା-ୄେୈୋ-୍୕-ୗୢୣஂா-ூெ-ைொ-்ௗఀ-ఄ఼ా-ౄె-ైొ-్ౕౖౢౣಁ-ಃ಼ಾ-ೄೆ-ೈೊ-್ೕೖೢೣഀ-ഃ഻഼ാ-ൄെ-ൈൊ-്ൗൢൣඁ-ඃ්ා-ුූෘ-ෟෲෳัิ-ฺ็-๎ັິ-ຼ່-ໍ༹༘༙༵༷༾༿ཱ-྄྆྇ྍ-ྗྙ-ྼ࿆ါ-ှၖ-ၙၞ-ၠၢ-ၤၧ-ၭၱ-ၴႂ-ႍႏႚ-ႝ፝-፟ᜒ-᜕ᜲ-᜴ᝒᝓᝲᝳ឴-៓៝᠋-᠍᠏ᢅᢆᢩᤠ-ᤫᤰ-᤻ᨗ-ᨛᩕ-ᩞ᩠-᩿᩼᪰-ᫎᬀ-ᬄ᬴-᭄᭫-᭳ᮀ-ᮂᮡ-ᮭ᯦-᯳ᰤ-᰷᳐-᳔᳒-᳨᳭᳴᳷-᳹᷀-᷿⃐-⃰⳯-⵿⳱ⷠ-〪ⷿ-゙゚〯꙯-꙲ꙴ-꙽ꚞꚟ꛰꛱ꠂ꠆ꠋꠣ-ꠧ꠬ꢀꢁꢴ-ꣅ꣠-꣱ꣿꤦ-꤭ꥇ-꥓ꦀ-ꦃ꦳-꧀ꧥꨩ-ꨶꩃꩌꩍꩻ-ꩽꪰꪲ-ꪴꪷꪸꪾ꪿꫁ꫫ-ꫯꫵ꫶ꯣ-ꯪ꯬꯭ﬞ︀-️︠-︯",astral:"\ud800[\uddfd\udee0\udf76-\udf7a]|\ud802[\ude01-\ude03\ude05\ude06\ude0c-\ude0f\ude38-\ude3a\ude3f\udee5\udee6]|\ud803[\udd24-\udd27\udeab\udeac\udf46-\udf50\udf82-\udf85]|\ud804[\udc00-\udc02\udc38-\udc46\udc70\udc73\udc74\udc7f-\udc82\udcb0-\udcba\udcc2\udd00-\udd02\udd27-\udd34\udd45\udd46\udd73\udd80-\udd82\uddb3-\uddc0\uddc9-\uddcc\uddce\uddcf\ude2c-\ude37\ude3e\udedf-\udeea\udf00-\udf03\udf3b\udf3c\udf3e-\udf44\udf47\udf48\udf4b-\udf4d\udf57\udf62\udf63\udf66-\udf6c\udf70-\udf74]|\ud805[\udc35-\udc46\udc5e\udcb0-\udcc3\uddaf-\uddb5\uddb8-\uddc0\udddc\udddd\ude30-\ude40\udeab-\udeb7\udf1d-\udf2b]|\ud806[\udc2c-\udc3a\udd30-\udd35\udd37\udd38\udd3b-\udd3e\udd40\udd42\udd43\uddd1-\uddd7\uddda-\udde0\udde4\ude01-\ude0a\ude33-\ude39\ude3b-\ude3e\ude47\ude51-\ude5b\ude8a-\ude99]|\ud807[\udc2f-\udc36\udc38-\udc3f\udc92-\udca7\udca9-\udcb6\udd31-\udd36\udd3a\udd3c\udd3d\udd3f-\udd45\udd47\udd8a-\udd8e\udd90\udd91\udd93-\udd97\udef3-\udef6]|\ud81a[\udef0-\udef4\udf30-\udf36]|\ud81b[\udf4f\udf51-\udf87\udf8f-\udf92\udfe4\udff0\udff1]|\ud82f[\udc9d\udc9e]|\ud833[\udf00-\udf2d\udf30-\udf46]|\ud834[\udd65-\udd69\udd6d-\udd72\udd7b-\udd82\udd85-\udd8b\uddaa-\uddad\ude42-\ude44]|\ud836[\ude00-\ude36\ude3b-\ude6c\ude75\ude84\ude9b-\ude9f\udea1-\udeaf]|\ud838[\udc00-\udc06\udc08-\udc18\udc1b-\udc21\udc23\udc24\udc26-\udc2a\udd30-\udd36\udeae\udeec-\udeef]|\ud83a[\udcd0-\udcd6\udd44-\udd4a]|\udb40[\udd00-\uddef]"},{name:"Mc",alias:"Spacing_Mark",bmp:"ःऻा-ीॉ-ौॎॏংঃা-ীেৈোৌৗਃਾ-ੀઃા-ીૉોૌଂଃାୀେୈୋୌୗாிுூெ-ைொ-ௌௗఁ-ఃు-ౄಂಃಾೀ-ೄೇೈೊೋೕೖംഃാ-ീെ-ൈൊ-ൌൗංඃා-ෑෘ-ෟෲෳ༾༿ཿါာေးျြၖၗၢ-ၤၧ-ၭႃႄႇ-ႌႏႚ-ႜ᜕᜴ាើ-ៅះៈᤣ-ᤦᤩ-ᤫᤰᤱᤳ-ᤸᨙᨚᩕᩗᩡᩣᩤᩭ-ᩲᬄᬵᬻᬽ-ᭁᭃ᭄ᮂᮡᮦᮧ᮪ᯧᯪ-ᯬᯮ᯲᯳ᰤ-ᰫᰴᰵ᳡᳷〮〯ꠣꠤꠧꢀꢁꢴ-ꣃꥒ꥓ꦃꦴꦵꦺꦻꦾ-꧀ꨯꨰꨳꨴꩍꩻꩽꫫꫮꫯꫵꯣꯤꯦꯧꯩꯪ꯬",astral:"\ud804[\udc00\udc02\udc82\udcb0-\udcb2\udcb7\udcb8\udd2c\udd45\udd46\udd82\uddb3-\uddb5\uddbf\uddc0\uddce\ude2c-\ude2e\ude32\ude33\ude35\udee0-\udee2\udf02\udf03\udf3e\udf3f\udf41-\udf44\udf47\udf48\udf4b-\udf4d\udf57\udf62\udf63]|\ud805[\udc35-\udc37\udc40\udc41\udc45\udcb0-\udcb2\udcb9\udcbb-\udcbe\udcc1\uddaf-\uddb1\uddb8-\uddbb\uddbe\ude30-\ude32\ude3b\ude3c\ude3e\udeac\udeae\udeaf\udeb6\udf20\udf21\udf26]|\ud806[\udc2c-\udc2e\udc38\udd30-\udd35\udd37\udd38\udd3d\udd40\udd42\uddd1-\uddd3\udddc-\udddf\udde4\ude39\ude57\ude58\ude97]|\ud807[\udc2f\udc3e\udca9\udcb1\udcb4\udd8a-\udd8e\udd93\udd94\udd96\udef5\udef6]|\ud81b[\udf51-\udf87\udff0\udff1]|\ud834[\udd65\udd66\udd6d-\udd72]"},{name:"Me",alias:"Enclosing_Mark",bmp:"҈҉᪾⃝-⃠⃢-⃤꙰-꙲"},{name:"Mn",alias:"Nonspacing_Mark",bmp:"̀-ͯ҃-֑҇-ׇֽֿׁׂׅׄؐ-ًؚ-ٰٟۖ-ۜ۟-۪ۤۧۨ-ܑۭܰ-݊ަ-ް߫-߽߳ࠖ-࠙ࠛ-ࠣࠥ-ࠧࠩ-࡙࠭-࡛࢘-࢟࣊-ࣣ࣡-ंऺ़ु-ै्॑-ॗॢॣঁ়ু-ৄ্ৢৣ৾ਁਂ਼ੁੂੇੈੋ-੍ੑੰੱੵઁં઼ુ-ૅેૈ્ૢૣૺ-૿ଁ଼ିୁ-ୄ୍୕ୖୢୣஂீ்ఀఄ఼ా-ీె-ైొ-్ౕౖౢౣಁ಼ಿೆೌ್ೢೣഀഁ഻഼ു-ൄ്ൢൣඁ්ි-ුූัิ-ฺ็-๎ັິ-ຼ່-ໍཱ༹༘༙༵༷-ཾྀ-྄྆྇ྍ-ྗྙ-ྼ࿆ိ-ူဲ-့္်ွှၘၙၞ-ၠၱ-ၴႂႅႆႍႝ፝-፟ᜒ-᜔ᜲᜳᝒᝓᝲᝳ឴឵ិ-ួំ៉-៓៝᠋-᠍᠏ᢅᢆᢩᤠ-ᤢᤧᤨᤲ᤹-᤻ᨘᨗᨛᩖᩘ-ᩞ᩠ᩢᩥ-ᩬᩳ-᩿᩼᪰-᪽ᪿ-ᫎᬀ-ᬃ᬴ᬶ-ᬺᬼᭂ᭫-᭳ᮀᮁᮢ-ᮥᮨᮩ᮫-ᮭ᯦ᯨᯩᯭᯯ-ᯱᰬ-ᰳᰶ᰷᳐-᳔᳒-᳢᳠-᳨᳭᳴᳸᳹᷀-᷿⃐-⃥⃜⃡-⃰⳯-⵿⳱ⷠ-〪ⷿ-゙゚〭꙯ꙴ-꙽ꚞꚟ꛰꛱ꠂ꠆ꠋꠥꠦ꠬꣄ꣅ꣠-꣱ꣿꤦ-꤭ꥇ-ꥑꦀ-ꦂ꦳ꦶ-ꦹꦼꦽꧥꨩ-ꨮꨱꨲꨵꨶꩃꩌꩼꪰꪲ-ꪴꪷꪸꪾ꪿꫁ꫬꫭ꫶ꯥꯨ꯭ﬞ︀-️︠-︯",astral:"\ud800[\uddfd\udee0\udf76-\udf7a]|\ud802[\ude01-\ude03\ude05\ude06\ude0c-\ude0f\ude38-\ude3a\ude3f\udee5\udee6]|\ud803[\udd24-\udd27\udeab\udeac\udf46-\udf50\udf82-\udf85]|\ud804[\udc01\udc38-\udc46\udc70\udc73\udc74\udc7f-\udc81\udcb3-\udcb6\udcb9\udcba\udcc2\udd00-\udd02\udd27-\udd2b\udd2d-\udd34\udd73\udd80\udd81\uddb6-\uddbe\uddc9-\uddcc\uddcf\ude2f-\ude31\ude34\ude36\ude37\ude3e\udedf\udee3-\udeea\udf00\udf01\udf3b\udf3c\udf40\udf66-\udf6c\udf70-\udf74]|\ud805[\udc38-\udc3f\udc42-\udc44\udc46\udc5e\udcb3-\udcb8\udcba\udcbf\udcc0\udcc2\udcc3\uddb2-\uddb5\uddbc\uddbd\uddbf\uddc0\udddc\udddd\ude33-\ude3a\ude3d\ude3f\ude40\udeab\udead\udeb0-\udeb5\udeb7\udf1d-\udf1f\udf22-\udf25\udf27-\udf2b]|\ud806[\udc2f-\udc37\udc39\udc3a\udd3b\udd3c\udd3e\udd43\uddd4-\uddd7\uddda\udddb\udde0\ude01-\ude0a\ude33-\ude38\ude3b-\ude3e\ude47\ude51-\ude56\ude59-\ude5b\ude8a-\ude96\ude98\ude99]|\ud807[\udc30-\udc36\udc38-\udc3d\udc3f\udc92-\udca7\udcaa-\udcb0\udcb2\udcb3\udcb5\udcb6\udd31-\udd36\udd3a\udd3c\udd3d\udd3f-\udd45\udd47\udd90\udd91\udd95\udd97\udef3\udef4]|\ud81a[\udef0-\udef4\udf30-\udf36]|\ud81b[\udf4f\udf8f-\udf92\udfe4]|\ud82f[\udc9d\udc9e]|\ud833[\udf00-\udf2d\udf30-\udf46]|\ud834[\udd67-\udd69\udd7b-\udd82\udd85-\udd8b\uddaa-\uddad\ude42-\ude44]|\ud836[\ude00-\ude36\ude3b-\ude6c\ude75\ude84\ude9b-\ude9f\udea1-\udeaf]|\ud838[\udc00-\udc06\udc08-\udc18\udc1b-\udc21\udc23\udc24\udc26-\udc2a\udd30-\udd36\udeae\udeec-\udeef]|\ud83a[\udcd0-\udcd6\udd44-\udd4a]|\udb40[\udd00-\uddef]"},{name:"N",alias:"Number",bmp:"0-9²³¹¼-¾٠-٩۰-۹߀-߉०-९০-৯৴-৹੦-੯૦-૯୦-୯୲-୷௦-௲౦-౯౸-౾೦-೯൘-൞൦-൸෦-෯๐-๙໐-໙༠-༳၀-၉႐-႙፩-፼ᛮ-ᛰ០-៩៰-៹᠐-᠙᥆-᥏᧐-᧚᪀-᪉᪐-᪙᭐-᭙᮰-᮹᱀-᱉᱐-᱙⁰⁴-⁹₀-₉⅐-ↂↅ-↉①-⒛⓪-⓿❶-➓⳽〇〡-〩〸-〺㆒-㆕㈠-㈩㉈-㉏㉑-㉟㊀-㊉㊱-㊿꘠-꘩ꛦ-ꛯ꠰-꠵꣐-꣙꤀-꤉꧐-꧙꧰-꧹꩐-꩙꯰-꯹０-９",astral:"\ud800[\udd07-\udd33\udd40-\udd78\udd8a\udd8b\udee1-\udefb\udf20-\udf23\udf41\udf4a\udfd1-\udfd5]|\ud801[\udca0-\udca9]|\ud802[\udc58-\udc5f\udc79-\udc7f\udca7-\udcaf\udcfb-\udcff\udd16-\udd1b\uddbc\uddbd\uddc0-\uddcf\uddd2-\uddff\ude40-\ude48\ude7d\ude7e\ude9d-\ude9f\udeeb-\udeef\udf58-\udf5f\udf78-\udf7f\udfa9-\udfaf]|\ud803[\udcfa-\udcff\udd30-\udd39\ude60-\ude7e\udf1d-\udf26\udf51-\udf54\udfc5-\udfcb]|\ud804[\udc52-\udc6f\udcf0-\udcf9\udd36-\udd3f\uddd0-\uddd9\udde1-\uddf4\udef0-\udef9]|\ud805[\udc50-\udc59\udcd0-\udcd9\ude50-\ude59\udec0-\udec9\udf30-\udf3b]|\ud806[\udce0-\udcf2\udd50-\udd59]|\ud807[\udc50-\udc6c\udd50-\udd59\udda0-\udda9\udfc0-\udfd4]|\ud809[\udc00-\udc6e]|\ud81a[\ude60-\ude69\udec0-\udec9\udf50-\udf59\udf5b-\udf61]|\ud81b[\ude80-\ude96]|\ud834[\udee0-\udef3\udf60-\udf78]|\ud835[\udfce-\udfff]|\ud838[\udd40-\udd49\udef0-\udef9]|\ud83a[\udcc7-\udccf\udd50-\udd59]|\ud83b[\udc71-\udcab\udcad-\udcaf\udcb1-\udcb4\udd01-\udd2d\udd2f-\udd3d]|\ud83c[\udd00-\udd0c]|\ud83e[\udff0-\udff9]"},{name:"Nd",alias:"Decimal_Number",bmp:"0-9٠-٩۰-۹߀-߉०-९০-৯੦-੯૦-૯୦-୯௦-௯౦-౯೦-೯൦-൯෦-෯๐-๙໐-໙༠-༩၀-၉႐-႙០-៩᠐-᠙᥆-᥏᧐-᧙᪀-᪉᪐-᪙᭐-᭙᮰-᮹᱀-᱉᱐-᱙꘠-꘩꣐-꣙꤀-꤉꧐-꧙꧰-꧹꩐-꩙꯰-꯹０-９",astral:"\ud801[\udca0-\udca9]|\ud803[\udd30-\udd39]|\ud804[\udc66-\udc6f\udcf0-\udcf9\udd36-\udd3f\uddd0-\uddd9\udef0-\udef9]|\ud805[\udc50-\udc59\udcd0-\udcd9\ude50-\ude59\udec0-\udec9\udf30-\udf39]|\ud806[\udce0-\udce9\udd50-\udd59]|\ud807[\udc50-\udc59\udd50-\udd59\udda0-\udda9]|\ud81a[\ude60-\ude69\udec0-\udec9\udf50-\udf59]|\ud835[\udfce-\udfff]|\ud838[\udd40-\udd49\udef0-\udef9]|\ud83a[\udd50-\udd59]|\ud83e[\udff0-\udff9]"},{name:"Nl",alias:"Letter_Number",bmp:"ᛮ-ᛰⅠ-ↂↅ-ↈ〇〡-〩〸-〺ꛦ-ꛯ",astral:"\ud800[\udd40-\udd74\udf41\udf4a\udfd1-\udfd5]|\ud809[\udc00-\udc6e]"},{name:"No",alias:"Other_Number",bmp:"²³¹¼-¾৴-৹୲-୷௰-௲౸-౾൘-൞൰-൸༪-༳፩-፼៰-៹᧚⁰⁴-⁹₀-₉⅐-⅟↉①-⒛⓪-⓿❶-➓⳽㆒-㆕㈠-㈩㉈-㉏㉑-㉟㊀-㊉㊱-㊿꠰-꠵",astral:"\ud800[\udd07-\udd33\udd75-\udd78\udd8a\udd8b\udee1-\udefb\udf20-\udf23]|\ud802[\udc58-\udc5f\udc79-\udc7f\udca7-\udcaf\udcfb-\udcff\udd16-\udd1b\uddbc\uddbd\uddc0-\uddcf\uddd2-\uddff\ude40-\ude48\ude7d\ude7e\ude9d-\ude9f\udeeb-\udeef\udf58-\udf5f\udf78-\udf7f\udfa9-\udfaf]|\ud803[\udcfa-\udcff\ude60-\ude7e\udf1d-\udf26\udf51-\udf54\udfc5-\udfcb]|\ud804[\udc52-\udc65\udde1-\uddf4]|\ud805[\udf3a\udf3b]|\ud806[\udcea-\udcf2]|\ud807[\udc5a-\udc6c\udfc0-\udfd4]|\ud81a[\udf5b-\udf61]|\ud81b[\ude80-\ude96]|\ud834[\udee0-\udef3\udf60-\udf78]|\ud83a[\udcc7-\udccf]|\ud83b[\udc71-\udcab\udcad-\udcaf\udcb1-\udcb4\udd01-\udd2d\udd2f-\udd3d]|\ud83c[\udd00-\udd0c]"},{name:"P",alias:"Punctuation",bmp:"!-#%-\\*,-\\/:;\\?@\\[-\\]_\\{\\}¡§«¶·»¿;·՚-՟։֊־׀׃׆׳״؉؊،؍؛؝-؟٪-٭۔܀-܍߷-߹࠰-࠾࡞।॥॰৽੶૰౷಄෴๏๚๛༄-༒༔༺-༽྅࿐-࿔࿙࿚၊-၏჻፠-፨᐀᙮᚛᚜᛫-᛭᜵᜶។-៖៘-៚᠀-᠊᥄᥅᨞᨟᪠-᪦᪨-᪭᭚-᭠᭽᭾᯼-᯿᰻-᰿᱾᱿᳀-᳇᳓‐-‧‰-⁃⁅-⁑⁓-⁞⁽⁾₍₎⌈-⌋〈〉❨-❵⟅⟆⟦-⟯⦃-⦘⧘-⧛⧼⧽⳹-⳼⳾⳿⵰⸀-⸮⸰-⹏⹒-⹝、-〃〈-】〔-〟〰〽゠・꓾꓿꘍-꘏꙳꙾꛲-꛷꡴-꡷꣎꣏꣸-꣺꣼꤮꤯꥟꧁-꧍꧞꧟꩜-꩟꫞꫟꫰꫱꯫﴾﴿︐-︙︰-﹒﹔-﹡﹣﹨﹪﹫！-＃％-＊，-／：；？＠［-］＿｛｝｟-･",astral:"\ud800[\udd00-\udd02\udf9f\udfd0]|𐕯|\ud802[\udc57\udd1f\udd3f\ude50-\ude58\ude7f\udef0-\udef6\udf39-\udf3f\udf99-\udf9c]|\ud803[\udead\udf55-\udf59\udf86-\udf89]|\ud804[\udc47-\udc4d\udcbb\udcbc\udcbe-\udcc1\udd40-\udd43\udd74\udd75\uddc5-\uddc8\uddcd\udddb\udddd-\udddf\ude38-\ude3d\udea9]|\ud805[\udc4b-\udc4f\udc5a\udc5b\udc5d\udcc6\uddc1-\uddd7\ude41-\ude43\ude60-\ude6c\udeb9\udf3c-\udf3e]|\ud806[\udc3b\udd44-\udd46\udde2\ude3f-\ude46\ude9a-\ude9c\ude9e-\udea2]|\ud807[\udc41-\udc45\udc70\udc71\udef7\udef8\udfff]|\ud809[\udc70-\udc74]|\ud80b[\udff1\udff2]|\ud81a[\ude6e\ude6f\udef5\udf37-\udf3b\udf44]|\ud81b[\ude97-\ude9a\udfe2]|𛲟|\ud836[\ude87-\ude8b]|\ud83a[\udd5e\udd5f]"},{name:"Pc",alias:"Connector_Punctuation",bmp:"_‿⁀⁔︳︴﹍-﹏＿"},{name:"Pd",alias:"Dash_Punctuation",bmp:"\\-֊־᐀᠆‐-―⸗⸚⸺⸻⹀⹝〜〰゠︱︲﹘﹣－",astral:"𐺭"},{name:"Pe",alias:"Close_Punctuation",bmp:"\\)\\]\\}༻༽᚜⁆⁾₎⌉⌋〉❩❫❭❯❱❳❵⟆⟧⟩⟫⟭⟯⦄⦆⦈⦊⦌⦎⦐⦒⦔⦖⦘⧙⧛⧽⸣⸥⸧⸩⹖⹘⹚⹜〉》」』】〕〗〙〛〞〟﴾︘︶︸︺︼︾﹀﹂﹄﹈﹚﹜﹞）］｝｠｣"},{name:"Pf",alias:"Final_Punctuation",bmp:"»’”›⸃⸅⸊⸍⸝⸡"},{name:"Pi",alias:"Initial_Punctuation",bmp:"«‘‛“‟‹⸂⸄⸉⸌⸜⸠"},{name:"Po",alias:"Other_Punctuation",bmp:"!-#%-'\\*,\\.\\/:;\\?@\\¡§¶·¿;·՚-՟։׀׃׆׳״؉؊،؍؛؝-؟٪-٭۔܀-܍߷-߹࠰-࠾࡞।॥॰৽੶૰౷಄෴๏๚๛༄-༒༔྅࿐-࿔࿙࿚၊-၏჻፠-፨᙮᛫-᛭᜵᜶។-៖៘-៚᠀-᠅᠇-᠊᥄᥅᨞᨟᪠-᪦᪨-᪭᭚-᭠᭽᭾᯼-᯿᰻-᰿᱾᱿᳀-᳇᳓‖‗†-‧‰-‸※-‾⁁-⁃⁇-⁑⁓⁕-⁞⳹-⳼⳾⳿⵰⸀⸁⸆-⸈⸋⸎-⸖⸘⸙⸛⸞⸟⸪-⸮⸰-⸹⸼-⸿⹁⹃-⹏⹒-⹔、-〃〽・꓾꓿꘍-꘏꙳꙾꛲-꛷꡴-꡷꣎꣏꣸-꣺꣼꤮꤯꥟꧁-꧍꧞꧟꩜-꩟꫞꫟꫰꫱꯫︐-︖︙︰﹅﹆﹉-﹌﹐-﹒﹔-﹗﹟-﹡﹨﹪﹫！-＃％-＇＊，．／：；？＠＼｡､･",astral:"\ud800[\udd00-\udd02\udf9f\udfd0]|𐕯|\ud802[\udc57\udd1f\udd3f\ude50-\ude58\ude7f\udef0-\udef6\udf39-\udf3f\udf99-\udf9c]|\ud803[\udf55-\udf59\udf86-\udf89]|\ud804[\udc47-\udc4d\udcbb\udcbc\udcbe-\udcc1\udd40-\udd43\udd74\udd75\uddc5-\uddc8\uddcd\udddb\udddd-\udddf\ude38-\ude3d\udea9]|\ud805[\udc4b-\udc4f\udc5a\udc5b\udc5d\udcc6\uddc1-\uddd7\ude41-\ude43\ude60-\ude6c\udeb9\udf3c-\udf3e]|\ud806[\udc3b\udd44-\udd46\udde2\ude3f-\ude46\ude9a-\ude9c\ude9e-\udea2]|\ud807[\udc41-\udc45\udc70\udc71\udef7\udef8\udfff]|\ud809[\udc70-\udc74]|\ud80b[\udff1\udff2]|\ud81a[\ude6e\ude6f\udef5\udf37-\udf3b\udf44]|\ud81b[\ude97-\ude9a\udfe2]|𛲟|\ud836[\ude87-\ude8b]|\ud83a[\udd5e\udd5f]"},{name:"Ps",alias:"Open_Punctuation",bmp:"\\(\\[\\{༺༼᚛‚„⁅⁽₍⌈⌊〈❨❪❬❮❰❲❴⟅⟦⟨⟪⟬⟮⦃⦅⦇⦉⦋⦍⦏⦑⦓⦕⦗⧘⧚⧼⸢⸤⸦⸨⹂⹕⹗⹙⹛〈《「『【〔〖〘〚〝﴿︗︵︷︹︻︽︿﹁﹃﹇﹙﹛﹝（［｛｟｢"},{name:"S",alias:"Symbol",bmp:"\\$\\+<->\\^`\\|~¢-¦¨©¬®-±´¸×÷˂-˅˒-˟˥-˫˭˯-˿͵΄΅϶҂֍-֏؆-؈؋؎؏۞۩۽۾߶߾߿࢈৲৳৺৻૱୰௳-௺౿൏൹฿༁-༃༓༕-༗༚-༟༴༶༸྾-࿅࿇-࿌࿎࿏࿕-࿘႞႟᎐-᎙᙭៛᥀᧞-᧿᭡-᭪᭴-᭼᾽᾿-῁῍-῏῝-῟῭-`´῾⁄⁒⁺-⁼₊-₌₠-⃀℀℁℃-℆℈℉℔№-℘℞-℣℥℧℩℮℺℻⅀-⅄⅊-⅍⅏↊↋←-⌇⌌-⌨⌫-␦⑀-⑊⒜-ⓩ─-❧➔-⟄⟇-⟥⟰-⦂⦙-⧗⧜-⧻⧾-⭳⭶-⮕⮗-⯿⳥-⳪⹐⹑⺀-⺙⺛-⻳⼀-⿕⿰-⿻〄〒〓〠〶〷〾〿゛゜㆐㆑㆖-㆟㇀-㇣㈀-㈞㈪-㉇㉐㉠-㉿㊊-㊰㋀-㏿䷀-䷿꒐-꓆꜀-꜖꜠꜡꞉꞊꠨-꠫꠶-꠹꩷-꩹꭛꭪꭫﬩﮲-﯂﵀-﵏﷏﷼-﷿﹢﹤-﹦﹩＄＋＜-＞＾｀｜～￠-￦￨-￮￼�",astral:"\ud800[\udd37-\udd3f\udd79-\udd89\udd8c-\udd8e\udd90-\udd9c\udda0\uddd0-\uddfc]|\ud802[\udc77\udc78\udec8]|𑜿|\ud807[\udfd5-\udff1]|\ud81a[\udf3c-\udf3f\udf45]|𛲜|\ud833[\udf50-\udfc3]|\ud834[\udc00-\udcf5\udd00-\udd26\udd29-\udd64\udd6a-\udd6c\udd83\udd84\udd8c-\udda9\uddae-\uddea\ude00-\ude41\ude45\udf00-\udf56]|\ud835[\udec1\udedb\udefb\udf15\udf35\udf4f\udf6f\udf89\udfa9\udfc3]|\ud836[\udc00-\uddff\ude37-\ude3a\ude6d-\ude74\ude76-\ude83\ude85\ude86]|\ud838[\udd4f\udeff]|\ud83b[\udcac\udcb0\udd2e\udef0\udef1]|\ud83c[\udc00-\udc2b\udc30-\udc93\udca0-\udcae\udcb1-\udcbf\udcc1-\udccf\udcd1-\udcf5\udd0d-\uddad\udde6-\ude02\ude10-\ude3b\ude40-\ude48\ude50\ude51\ude60-\ude65\udf00-\udfff]|\ud83d[\udc00-\uded7\udedd-\udeec\udef0-\udefc\udf00-\udf73\udf80-\udfd8\udfe0-\udfeb\udff0]|\ud83e[\udc00-\udc0b\udc10-\udc47\udc50-\udc59\udc60-\udc87\udc90-\udcad\udcb0\udcb1\udd00-\ude53\ude60-\ude6d\ude70-\ude74\ude78-\ude7c\ude80-\ude86\ude90-\udeac\udeb0-\udeba\udec0-\udec5\uded0-\uded9\udee0-\udee7\udef0-\udef6\udf00-\udf92\udf94-\udfca]"},{name:"Sc",alias:"Currency_Symbol",bmp:"\\$¢-¥֏؋߾߿৲৳৻૱௹฿៛₠-⃀꠸﷼﹩＄￠￡￥￦",astral:"\ud807[\udfdd-\udfe0]|𞋿|𞲰"},{name:"Sk",alias:"Modifier_Symbol",bmp:"\\^`¨¯´¸˂-˅˒-˟˥-˫˭˯-˿͵΄΅࢈᾽᾿-῁῍-῏῝-῟῭-`´῾゛゜꜀-꜖꜠꜡꞉꞊꭛꭪꭫﮲-﯂＾｀￣",astral:"\ud83c[\udffb-\udfff]"},{name:"Sm",alias:"Math_Symbol",bmp:"\\+<->\\|~¬±×÷϶؆-؈⁄⁒⁺-⁼₊-₌℘⅀-⅄⅋←-↔↚↛↠↣↦↮⇎⇏⇒⇔⇴-⋿⌠⌡⍼⎛-⎳⏜-⏡▷◁◸-◿♯⟀-⟄⟇-⟥⟰-⟿⤀-⦂⦙-⧗⧜-⧻⧾-⫿⬰-⭄⭇-⭌﬩﹢﹤-﹦＋＜-＞｜～￢￩-￬",astral:"\ud835[\udec1\udedb\udefb\udf15\udf35\udf4f\udf6f\udf89\udfa9\udfc3]|\ud83b[\udef0\udef1]"},{name:"So",alias:"Other_Symbol",bmp:"¦©®°҂֍֎؎؏۞۩۽۾߶৺୰௳-௸௺౿൏൹༁-༃༓༕-༗༚-༟༴༶༸྾-࿅࿇-࿌࿎࿏࿕-࿘႞႟᎐-᎙᙭᥀᧞-᧿᭡-᭪᭴-᭼℀℁℃-℆℈℉℔№℗℞-℣℥℧℩℮℺℻⅊⅌⅍⅏↊↋↕-↙↜-↟↡↢↤↥↧-↭↯-⇍⇐⇑⇓⇕-⇳⌀-⌇⌌-⌟⌢-⌨⌫-⍻⍽-⎚⎴-⏛⏢-␦⑀-⑊⒜-ⓩ─-▶▸-◀◂-◷☀-♮♰-❧➔-➿⠀-⣿⬀-⬯⭅⭆⭍-⭳⭶-⮕⮗-⯿⳥-⳪⹐⹑⺀-⺙⺛-⻳⼀-⿕⿰-⿻〄〒〓〠〶〷〾〿㆐㆑㆖-㆟㇀-㇣㈀-㈞㈪-㉇㉐㉠-㉿㊊-㊰㋀-㏿䷀-䷿꒐-꓆꠨-꠫꠶꠷꠹꩷-꩹﵀-﵏﷏﷽-﷿￤￨￭￮￼�",astral:"\ud800[\udd37-\udd3f\udd79-\udd89\udd8c-\udd8e\udd90-\udd9c\udda0\uddd0-\uddfc]|\ud802[\udc77\udc78\udec8]|𑜿|\ud807[\udfd5-\udfdc\udfe1-\udff1]|\ud81a[\udf3c-\udf3f\udf45]|𛲜|\ud833[\udf50-\udfc3]|\ud834[\udc00-\udcf5\udd00-\udd26\udd29-\udd64\udd6a-\udd6c\udd83\udd84\udd8c-\udda9\uddae-\uddea\ude00-\ude41\ude45\udf00-\udf56]|\ud836[\udc00-\uddff\ude37-\ude3a\ude6d-\ude74\ude76-\ude83\ude85\ude86]|𞅏|\ud83b[\udcac\udd2e]|\ud83c[\udc00-\udc2b\udc30-\udc93\udca0-\udcae\udcb1-\udcbf\udcc1-\udccf\udcd1-\udcf5\udd0d-\uddad\udde6-\ude02\ude10-\ude3b\ude40-\ude48\ude50\ude51\ude60-\ude65\udf00-\udffa]|\ud83d[\udc00-\uded7\udedd-\udeec\udef0-\udefc\udf00-\udf73\udf80-\udfd8\udfe0-\udfeb\udff0]|\ud83e[\udc00-\udc0b\udc10-\udc47\udc50-\udc59\udc60-\udc87\udc90-\udcad\udcb0\udcb1\udd00-\ude53\ude60-\ude6d\ude70-\ude74\ude78-\ude7c\ude80-\ude86\ude90-\udeac\udeb0-\udeba\udec0-\udec5\uded0-\uded9\udee0-\udee7\udef0-\udef6\udf00-\udf92\udf94-\udfca]"},{name:"Z",alias:"Separator",bmp:"    - \u2028\u2029  　"},{name:"Zl",alias:"Line_Separator",bmp:"\u2028"},{name:"Zp",alias:"Paragraph_Separator",bmp:"\u2029"},{name:"Zs",alias:"Space_Separator",bmp:"    -   　"}]},{}]},{},[3])(3)}));



========== staticfiles/admin/js/vendor/xregexp/xregexp.js ==========
(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.XRegExp = f()}})(function(){var define,module,exports;return (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";

var _sliceInstanceProperty = require("@babel/runtime-corejs3/core-js-stable/instance/slice");

var _Array$from = require("@babel/runtime-corejs3/core-js-stable/array/from");

var _Symbol = require("@babel/runtime-corejs3/core-js-stable/symbol");

var _getIteratorMethod = require("@babel/runtime-corejs3/core-js/get-iterator-method");

var _Array$isArray = require("@babel/runtime-corejs3/core-js-stable/array/is-array");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js-stable/object/define-property");

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports["default"] = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime-corejs3/helpers/slicedToArray"));

var _forEach = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/for-each"));

var _concat = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/concat"));

var _indexOf = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/index-of"));

function _createForOfIteratorHelper(o, allowArrayLike) { var it = typeof _Symbol !== "undefined" && _getIteratorMethod(o) || o["@@iterator"]; if (!it) { if (_Array$isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = it.call(o); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it["return"] != null) it["return"](); } finally { if (didErr) throw err; } } }; }

function _unsupportedIterableToArray(o, minLen) { var _context4; if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = _sliceInstanceProperty(_context4 = Object.prototype.toString.call(o)).call(_context4, 8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return _Array$from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

/*!
 * XRegExp Unicode Base 5.1.1
 * <xregexp.com>
 * Steven Levithan (c) 2008-present MIT License
 */
var _default = function _default(XRegExp) {
  /**
   * Adds base support for Unicode matching:
   * - Adds syntax `\p{..}` for matching Unicode tokens. Tokens can be inverted using `\P{..}` or
   *   `\p{^..}`. Token names ignore case, spaces, hyphens, and underscores. You can omit the
   *   braces for token names that are a single letter (e.g. `\pL` or `PL`).
   * - Adds flag A (astral), which enables 21-bit Unicode support.
   * - Adds the `XRegExp.addUnicodeData` method used by other addons to provide character data.
   *
   * Unicode Base relies on externally provided Unicode character data. Official addons are
   * available to provide data for Unicode categories, scripts, and properties.
   *
   * @requires XRegExp
   */
  // ==--------------------------==
  // Private stuff
  // ==--------------------------==
  // Storage for Unicode data
  var unicode = {};
  var unicodeTypes = {}; // Reuse utils

  var dec = XRegExp._dec;
  var hex = XRegExp._hex;
  var pad4 = XRegExp._pad4; // Generates a token lookup name: lowercase, with hyphens, spaces, and underscores removed

  function normalize(name) {
    return name.replace(/[- _]+/g, '').toLowerCase();
  } // Gets the decimal code of a literal code unit, \xHH, \uHHHH, or a backslash-escaped literal


  function charCode(chr) {
    var esc = /^\\[xu](.+)/.exec(chr);
    return esc ? dec(esc[1]) : chr.charCodeAt(chr[0] === '\\' ? 1 : 0);
  } // Inverts a list of ordered BMP characters and ranges


  function invertBmp(range) {
    var output = '';
    var lastEnd = -1;
    (0, _forEach["default"])(XRegExp).call(XRegExp, range, /(\\x..|\\u....|\\?[\s\S])(?:-(\\x..|\\u....|\\?[\s\S]))?/, function (m) {
      var start = charCode(m[1]);

      if (start > lastEnd + 1) {
        output += "\\u".concat(pad4(hex(lastEnd + 1)));

        if (start > lastEnd + 2) {
          output += "-\\u".concat(pad4(hex(start - 1)));
        }
      }

      lastEnd = charCode(m[2] || m[1]);
    });

    if (lastEnd < 0xFFFF) {
      output += "\\u".concat(pad4(hex(lastEnd + 1)));

      if (lastEnd < 0xFFFE) {
        output += '-\\uFFFF';
      }
    }

    return output;
  } // Generates an inverted BMP range on first use


  function cacheInvertedBmp(slug) {
    var prop = 'b!';
    return unicode[slug][prop] || (unicode[slug][prop] = invertBmp(unicode[slug].bmp));
  } // Combines and optionally negates BMP and astral data


  function buildAstral(slug, isNegated) {
    var item = unicode[slug];
    var combined = '';

    if (item.bmp && !item.isBmpLast) {
      var _context;

      combined = (0, _concat["default"])(_context = "[".concat(item.bmp, "]")).call(_context, item.astral ? '|' : '');
    }

    if (item.astral) {
      combined += item.astral;
    }

    if (item.isBmpLast && item.bmp) {
      var _context2;

      combined += (0, _concat["default"])(_context2 = "".concat(item.astral ? '|' : '', "[")).call(_context2, item.bmp, "]");
    } // Astral Unicode tokens always match a code point, never a code unit


    return isNegated ? "(?:(?!".concat(combined, ")(?:[\uD800-\uDBFF][\uDC00-\uDFFF]|[\0-\uFFFF]))") : "(?:".concat(combined, ")");
  } // Builds a complete astral pattern on first use


  function cacheAstral(slug, isNegated) {
    var prop = isNegated ? 'a!' : 'a=';
    return unicode[slug][prop] || (unicode[slug][prop] = buildAstral(slug, isNegated));
  } // ==--------------------------==
  // Core functionality
  // ==--------------------------==

  /*
   * Add astral mode (flag A) and Unicode token syntax: `\p{..}`, `\P{..}`, `\p{^..}`, `\pC`.
   */


  XRegExp.addToken( // Use `*` instead of `+` to avoid capturing `^` as the token name in `\p{^}`
  /\\([pP])(?:{(\^?)(?:(\w+)=)?([^}]*)}|([A-Za-z]))/, function (match, scope, flags) {
    var ERR_DOUBLE_NEG = 'Invalid double negation ';
    var ERR_UNKNOWN_NAME = 'Unknown Unicode token ';
    var ERR_UNKNOWN_REF = 'Unicode token missing data ';
    var ERR_ASTRAL_ONLY = 'Astral mode required for Unicode token ';
    var ERR_ASTRAL_IN_CLASS = 'Astral mode does not support Unicode tokens within character classes';

    var _match = (0, _slicedToArray2["default"])(match, 6),
        fullToken = _match[0],
        pPrefix = _match[1],
        caretNegation = _match[2],
        typePrefix = _match[3],
        tokenName = _match[4],
        tokenSingleCharName = _match[5]; // Negated via \P{..} or \p{^..}


    var isNegated = pPrefix === 'P' || !!caretNegation; // Switch from BMP (0-FFFF) to astral (0-10FFFF) mode via flag A

    var isAstralMode = (0, _indexOf["default"])(flags).call(flags, 'A') !== -1; // Token lookup name. Check `tokenSingleCharName` first to avoid passing `undefined`
    // via `\p{}`

    var slug = normalize(tokenSingleCharName || tokenName); // Token data object

    var item = unicode[slug];

    if (pPrefix === 'P' && caretNegation) {
      throw new SyntaxError(ERR_DOUBLE_NEG + fullToken);
    }

    if (!unicode.hasOwnProperty(slug)) {
      throw new SyntaxError(ERR_UNKNOWN_NAME + fullToken);
    }

    if (typePrefix) {
      if (!(unicodeTypes[typePrefix] && unicodeTypes[typePrefix][slug])) {
        throw new SyntaxError(ERR_UNKNOWN_NAME + fullToken);
      }
    } // Switch to the negated form of the referenced Unicode token


    if (item.inverseOf) {
      slug = normalize(item.inverseOf);

      if (!unicode.hasOwnProperty(slug)) {
        var _context3;

        throw new ReferenceError((0, _concat["default"])(_context3 = "".concat(ERR_UNKNOWN_REF + fullToken, " -> ")).call(_context3, item.inverseOf));
      }

      item = unicode[slug];
      isNegated = !isNegated;
    }

    if (!(item.bmp || isAstralMode)) {
      throw new SyntaxError(ERR_ASTRAL_ONLY + fullToken);
    }

    if (isAstralMode) {
      if (scope === 'class') {
        throw new SyntaxError(ERR_ASTRAL_IN_CLASS);
      }

      return cacheAstral(slug, isNegated);
    }

    return scope === 'class' ? isNegated ? cacheInvertedBmp(slug) : item.bmp : "".concat((isNegated ? '[^' : '[') + item.bmp, "]");
  }, {
    scope: 'all',
    optionalFlags: 'A',
    leadChar: '\\'
  });
  /**
   * Adds to the list of Unicode tokens that XRegExp regexes can match via `\p` or `\P`.
   *
   * @memberOf XRegExp
   * @param {Array} data Objects with named character ranges. Each object may have properties
   *   `name`, `alias`, `isBmpLast`, `inverseOf`, `bmp`, and `astral`. All but `name` are
   *   optional, although one of `bmp` or `astral` is required (unless `inverseOf` is set). If
   *   `astral` is absent, the `bmp` data is used for BMP and astral modes. If `bmp` is absent,
   *   the name errors in BMP mode but works in astral mode. If both `bmp` and `astral` are
   *   provided, the `bmp` data only is used in BMP mode, and the combination of `bmp` and
   *   `astral` data is used in astral mode. `isBmpLast` is needed when a token matches orphan
   *   high surrogates *and* uses surrogate pairs to match astral code points. The `bmp` and
   *   `astral` data should be a combination of literal characters and `\xHH` or `\uHHHH` escape
   *   sequences, with hyphens to create ranges. Any regex metacharacters in the data should be
   *   escaped, apart from range-creating hyphens. The `astral` data can additionally use
   *   character classes and alternation, and should use surrogate pairs to represent astral code
   *   points. `inverseOf` can be used to avoid duplicating character data if a Unicode token is
   *   defined as the exact inverse of another token.
   * @param {String} [typePrefix] Enables optionally using this type as a prefix for all of the
   *   provided Unicode tokens, e.g. if given `'Type'`, then `\p{TokenName}` can also be written
   *   as `\p{Type=TokenName}`.
   * @example
   *
   * // Basic use
   * XRegExp.addUnicodeData([{
   *   name: 'XDigit',
   *   alias: 'Hexadecimal',
   *   bmp: '0-9A-Fa-f'
   * }]);
   * XRegExp('\\p{XDigit}:\\p{Hexadecimal}+').test('0:3D'); // -> true
   */

  XRegExp.addUnicodeData = function (data, typePrefix) {
    var ERR_NO_NAME = 'Unicode token requires name';
    var ERR_NO_DATA = 'Unicode token has no character data ';

    if (typePrefix) {
      // Case sensitive to match ES2018
      unicodeTypes[typePrefix] = {};
    }

    var _iterator = _createForOfIteratorHelper(data),
        _step;

    try {
      for (_iterator.s(); !(_step = _iterator.n()).done;) {
        var item = _step.value;

        if (!item.name) {
          throw new Error(ERR_NO_NAME);
        }

        if (!(item.inverseOf || item.bmp || item.astral)) {
          throw new Error(ERR_NO_DATA + item.name);
        }

        var normalizedName = normalize(item.name);
        unicode[normalizedName] = item;

        if (typePrefix) {
          unicodeTypes[typePrefix][normalizedName] = true;
        }

        if (item.alias) {
          var normalizedAlias = normalize(item.alias);
          unicode[normalizedAlias] = item;

          if (typePrefix) {
            unicodeTypes[typePrefix][normalizedAlias] = true;
          }
        }
      } // Reset the pattern cache used by the `XRegExp` constructor, since the same pattern and
      // flags might now produce different results

    } catch (err) {
      _iterator.e(err);
    } finally {
      _iterator.f();
    }

    XRegExp.cache.flush('patterns');
  };
  /**
   * @ignore
   *
   * Return a reference to the internal Unicode definition structure for the given Unicode
   * Property if the given name is a legal Unicode Property for use in XRegExp `\p` or `\P` regex
   * constructs.
   *
   * @memberOf XRegExp
   * @param {String} name Name by which the Unicode Property may be recognized (case-insensitive),
   *   e.g. `'N'` or `'Number'`. The given name is matched against all registered Unicode
   *   Properties and Property Aliases.
   * @returns {Object} Reference to definition structure when the name matches a Unicode Property.
   *
   * @note
   * For more info on Unicode Properties, see also http://unicode.org/reports/tr18/#Categories.
   *
   * @note
   * This method is *not* part of the officially documented API and may change or be removed in
   * the future. It is meant for userland code that wishes to reuse the (large) internal Unicode
   * structures set up by XRegExp.
   */


  XRegExp._getUnicodeProperty = function (name) {
    var slug = normalize(name);
    return unicode[slug];
  };
};

exports["default"] = _default;
module.exports = exports.default;
},{"@babel/runtime-corejs3/core-js-stable/array/from":5,"@babel/runtime-corejs3/core-js-stable/array/is-array":6,"@babel/runtime-corejs3/core-js-stable/instance/concat":7,"@babel/runtime-corejs3/core-js-stable/instance/for-each":9,"@babel/runtime-corejs3/core-js-stable/instance/index-of":10,"@babel/runtime-corejs3/core-js-stable/instance/slice":11,"@babel/runtime-corejs3/core-js-stable/object/define-property":14,"@babel/runtime-corejs3/core-js-stable/symbol":16,"@babel/runtime-corejs3/core-js/get-iterator-method":19,"@babel/runtime-corejs3/helpers/interopRequireDefault":24,"@babel/runtime-corejs3/helpers/slicedToArray":27}],2:[function(require,module,exports){
"use strict";

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js-stable/object/define-property");

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports["default"] = void 0;

var _categories = _interopRequireDefault(require("../../tools/output/categories"));

/*!
 * XRegExp Unicode Categories 5.1.1
 * <xregexp.com>
 * Steven Levithan (c) 2010-present MIT License
 * Unicode data by Mathias Bynens <mathiasbynens.be>
 */
var _default = function _default(XRegExp) {
  /**
   * Adds support for Unicode's general categories. E.g., `\p{Lu}` or `\p{Uppercase Letter}`. See
   * category descriptions in UAX #44 <http://unicode.org/reports/tr44/#GC_Values_Table>. Token
   * names are case insensitive, and any spaces, hyphens, and underscores are ignored.
   *
   * Uses Unicode 14.0.0.
   *
   * @requires XRegExp, Unicode Base
   */
  if (!XRegExp.addUnicodeData) {
    throw new ReferenceError('Unicode Base must be loaded before Unicode Categories');
  }

  XRegExp.addUnicodeData(_categories["default"]);
};

exports["default"] = _default;
module.exports = exports.default;
},{"../../tools/output/categories":222,"@babel/runtime-corejs3/core-js-stable/object/define-property":14,"@babel/runtime-corejs3/helpers/interopRequireDefault":24}],3:[function(require,module,exports){
"use strict";

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js-stable/object/define-property");

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports["default"] = void 0;

var _xregexp = _interopRequireDefault(require("./xregexp"));

var _unicodeBase = _interopRequireDefault(require("./addons/unicode-base"));

var _unicodeCategories = _interopRequireDefault(require("./addons/unicode-categories"));

(0, _unicodeBase["default"])(_xregexp["default"]);
(0, _unicodeCategories["default"])(_xregexp["default"]);
var _default = _xregexp["default"];
exports["default"] = _default;
module.exports = exports.default;
},{"./addons/unicode-base":1,"./addons/unicode-categories":2,"./xregexp":4,"@babel/runtime-corejs3/core-js-stable/object/define-property":14,"@babel/runtime-corejs3/helpers/interopRequireDefault":24}],4:[function(require,module,exports){
"use strict";

var _sliceInstanceProperty2 = require("@babel/runtime-corejs3/core-js-stable/instance/slice");

var _Array$from = require("@babel/runtime-corejs3/core-js-stable/array/from");

var _Symbol = require("@babel/runtime-corejs3/core-js-stable/symbol");

var _getIteratorMethod = require("@babel/runtime-corejs3/core-js/get-iterator-method");

var _Array$isArray = require("@babel/runtime-corejs3/core-js-stable/array/is-array");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js-stable/object/define-property");

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports["default"] = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime-corejs3/helpers/slicedToArray"));

var _flags = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/flags"));

var _sort = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/sort"));

var _slice = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/slice"));

var _parseInt2 = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/parse-int"));

var _indexOf = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/index-of"));

var _forEach = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/for-each"));

var _create = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/create"));

var _concat = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/concat"));

function _createForOfIteratorHelper(o, allowArrayLike) { var it = typeof _Symbol !== "undefined" && _getIteratorMethod(o) || o["@@iterator"]; if (!it) { if (_Array$isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = it.call(o); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it["return"] != null) it["return"](); } finally { if (didErr) throw err; } } }; }

function _unsupportedIterableToArray(o, minLen) { var _context9; if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = _sliceInstanceProperty2(_context9 = Object.prototype.toString.call(o)).call(_context9, 8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return _Array$from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

/*!
 * XRegExp 5.1.1
 * <xregexp.com>
 * Steven Levithan (c) 2007-present MIT License
 */

/**
 * XRegExp provides augmented, extensible regular expressions. You get additional regex syntax and
 * flags, beyond what browsers support natively. XRegExp is also a regex utility belt with tools to
 * make your client-side grepping simpler and more powerful, while freeing you from related
 * cross-browser inconsistencies.
 */
// ==--------------------------==
// Private stuff
// ==--------------------------==
// Property name used for extended regex instance data
var REGEX_DATA = 'xregexp'; // Optional features that can be installed and uninstalled

var features = {
  astral: false,
  namespacing: true
}; // Storage for fixed/extended native methods

var fixed = {}; // Storage for regexes cached by `XRegExp.cache`

var regexCache = {}; // Storage for pattern details cached by the `XRegExp` constructor

var patternCache = {}; // Storage for regex syntax tokens added internally or by `XRegExp.addToken`

var tokens = []; // Token scopes

var defaultScope = 'default';
var classScope = 'class'; // Regexes that match native regex syntax, including octals

var nativeTokens = {
  // Any native multicharacter token in default scope, or any single character
  'default': /\\(?:0(?:[0-3][0-7]{0,2}|[4-7][0-7]?)?|[1-9]\d*|x[\dA-Fa-f]{2}|u(?:[\dA-Fa-f]{4}|{[\dA-Fa-f]+})|c[A-Za-z]|[\s\S])|\(\?(?:[:=!]|<[=!])|[?*+]\?|{\d+(?:,\d*)?}\??|[\s\S]/,
  // Any native multicharacter token in character class scope, or any single character
  'class': /\\(?:[0-3][0-7]{0,2}|[4-7][0-7]?|x[\dA-Fa-f]{2}|u(?:[\dA-Fa-f]{4}|{[\dA-Fa-f]+})|c[A-Za-z]|[\s\S])|[\s\S]/
}; // Any backreference or dollar-prefixed character in replacement strings

var replacementToken = /\$(?:\{([^\}]+)\}|<([^>]+)>|(\d\d?|[\s\S]?))/g; // Check for correct `exec` handling of nonparticipating capturing groups

var correctExecNpcg = /()??/.exec('')[1] === undefined; // Check for ES6 `flags` prop support

var hasFlagsProp = (0, _flags["default"])(/x/) !== undefined;

function hasNativeFlag(flag) {
  // Can't check based on the presence of properties/getters since browsers might support such
  // properties even when they don't support the corresponding flag in regex construction (tested
  // in Chrome 48, where `'unicode' in /x/` is true but trying to construct a regex with flag `u`
  // throws an error)
  var isSupported = true;

  try {
    // Can't use regex literals for testing even in a `try` because regex literals with
    // unsupported flags cause a compilation error in IE
    new RegExp('', flag); // Work around a broken/incomplete IE11 polyfill for sticky introduced in core-js 3.6.0

    if (flag === 'y') {
      // Using function to avoid babel transform to regex literal
      var gy = function () {
        return 'gy';
      }();

      var incompleteY = '.a'.replace(new RegExp('a', gy), '.') === '..';

      if (incompleteY) {
        isSupported = false;
      }
    }
  } catch (exception) {
    isSupported = false;
  }

  return isSupported;
} // Check for ES2021 `d` flag support


var hasNativeD = hasNativeFlag('d'); // Check for ES2018 `s` flag support

var hasNativeS = hasNativeFlag('s'); // Check for ES6 `u` flag support

var hasNativeU = hasNativeFlag('u'); // Check for ES6 `y` flag support

var hasNativeY = hasNativeFlag('y'); // Tracker for known flags, including addon flags

var registeredFlags = {
  d: hasNativeD,
  g: true,
  i: true,
  m: true,
  s: hasNativeS,
  u: hasNativeU,
  y: hasNativeY
}; // Flags to remove when passing to native `RegExp` constructor

var nonnativeFlags = hasNativeS ? /[^dgimsuy]+/g : /[^dgimuy]+/g;
/**
 * Attaches extended data and `XRegExp.prototype` properties to a regex object.
 *
 * @private
 * @param {RegExp} regex Regex to augment.
 * @param {Array} captureNames Array with capture names, or `null`.
 * @param {String} xSource XRegExp pattern used to generate `regex`, or `null` if N/A.
 * @param {String} xFlags XRegExp flags used to generate `regex`, or `null` if N/A.
 * @param {Boolean} [isInternalOnly=false] Whether the regex will be used only for internal
 *   operations, and never exposed to users. For internal-only regexes, we can improve perf by
 *   skipping some operations like attaching `XRegExp.prototype` properties.
 * @returns {!RegExp} Augmented regex.
 */

function augment(regex, captureNames, xSource, xFlags, isInternalOnly) {
  var _context;

  regex[REGEX_DATA] = {
    captureNames: captureNames
  };

  if (isInternalOnly) {
    return regex;
  } // Can't auto-inherit these since the XRegExp constructor returns a nonprimitive value


  if (regex.__proto__) {
    regex.__proto__ = XRegExp.prototype;
  } else {
    for (var p in XRegExp.prototype) {
      // An `XRegExp.prototype.hasOwnProperty(p)` check wouldn't be worth it here, since this
      // is performance sensitive, and enumerable `Object.prototype` or `RegExp.prototype`
      // extensions exist on `regex.prototype` anyway
      regex[p] = XRegExp.prototype[p];
    }
  }

  regex[REGEX_DATA].source = xSource; // Emulate the ES6 `flags` prop by ensuring flags are in alphabetical order

  regex[REGEX_DATA].flags = xFlags ? (0, _sort["default"])(_context = xFlags.split('')).call(_context).join('') : xFlags;
  return regex;
}
/**
 * Removes any duplicate characters from the provided string.
 *
 * @private
 * @param {String} str String to remove duplicate characters from.
 * @returns {string} String with any duplicate characters removed.
 */


function clipDuplicates(str) {
  return str.replace(/([\s\S])(?=[\s\S]*\1)/g, '');
}
/**
 * Copies a regex object while preserving extended data and augmenting with `XRegExp.prototype`
 * properties. The copy has a fresh `lastIndex` property (set to zero). Allows adding and removing
 * flags g and y while copying the regex.
 *
 * @private
 * @param {RegExp} regex Regex to copy.
 * @param {Object} [options] Options object with optional properties:
 *   - `addG` {Boolean} Add flag g while copying the regex.
 *   - `addY` {Boolean} Add flag y while copying the regex.
 *   - `removeG` {Boolean} Remove flag g while copying the regex.
 *   - `removeY` {Boolean} Remove flag y while copying the regex.
 *   - `isInternalOnly` {Boolean} Whether the copied regex will be used only for internal
 *     operations, and never exposed to users. For internal-only regexes, we can improve perf by
 *     skipping some operations like attaching `XRegExp.prototype` properties.
 *   - `source` {String} Overrides `<regex>.source`, for special cases.
 * @returns {RegExp} Copy of the provided regex, possibly with modified flags.
 */


function copyRegex(regex, options) {
  var _context2;

  if (!XRegExp.isRegExp(regex)) {
    throw new TypeError('Type RegExp expected');
  }

  var xData = regex[REGEX_DATA] || {};
  var flags = getNativeFlags(regex);
  var flagsToAdd = '';
  var flagsToRemove = '';
  var xregexpSource = null;
  var xregexpFlags = null;
  options = options || {};

  if (options.removeG) {
    flagsToRemove += 'g';
  }

  if (options.removeY) {
    flagsToRemove += 'y';
  }

  if (flagsToRemove) {
    flags = flags.replace(new RegExp("[".concat(flagsToRemove, "]+"), 'g'), '');
  }

  if (options.addG) {
    flagsToAdd += 'g';
  }

  if (options.addY) {
    flagsToAdd += 'y';
  }

  if (flagsToAdd) {
    flags = clipDuplicates(flags + flagsToAdd);
  }

  if (!options.isInternalOnly) {
    if (xData.source !== undefined) {
      xregexpSource = xData.source;
    } // null or undefined; don't want to add to `flags` if the previous value was null, since
    // that indicates we're not tracking original precompilation flags


    if ((0, _flags["default"])(xData) != null) {
      // Flags are only added for non-internal regexes by `XRegExp.globalize`. Flags are never
      // removed for non-internal regexes, so don't need to handle it
      xregexpFlags = flagsToAdd ? clipDuplicates((0, _flags["default"])(xData) + flagsToAdd) : (0, _flags["default"])(xData);
    }
  } // Augment with `XRegExp.prototype` properties, but use the native `RegExp` constructor to avoid
  // searching for special tokens. That would be wrong for regexes constructed by `RegExp`, and
  // unnecessary for regexes constructed by `XRegExp` because the regex has already undergone the
  // translation to native regex syntax


  regex = augment(new RegExp(options.source || regex.source, flags), hasNamedCapture(regex) ? (0, _slice["default"])(_context2 = xData.captureNames).call(_context2, 0) : null, xregexpSource, xregexpFlags, options.isInternalOnly);
  return regex;
}
/**
 * Converts hexadecimal to decimal.
 *
 * @private
 * @param {String} hex
 * @returns {number}
 */


function dec(hex) {
  return (0, _parseInt2["default"])(hex, 16);
}
/**
 * Returns a pattern that can be used in a native RegExp in place of an ignorable token such as an
 * inline comment or whitespace with flag x. This is used directly as a token handler function
 * passed to `XRegExp.addToken`.
 *
 * @private
 * @param {String} match Match arg of `XRegExp.addToken` handler
 * @param {String} scope Scope arg of `XRegExp.addToken` handler
 * @param {String} flags Flags arg of `XRegExp.addToken` handler
 * @returns {string} Either '' or '(?:)', depending on which is needed in the context of the match.
 */


function getContextualTokenSeparator(match, scope, flags) {
  var matchEndPos = match.index + match[0].length;
  var precedingChar = match.input[match.index - 1];
  var followingChar = match.input[matchEndPos];

  if ( // No need to separate tokens if at the beginning or end of a group, before or after a
  // group, or before or after a `|`
  /^[()|]$/.test(precedingChar) || /^[()|]$/.test(followingChar) || // No need to separate tokens if at the beginning or end of the pattern
  match.index === 0 || matchEndPos === match.input.length || // No need to separate tokens if at the beginning of a noncapturing group or lookaround.
  // Looks only at the last 4 chars (at most) for perf when constructing long regexes.
  /\(\?(?:[:=!]|<[=!])$/.test(match.input.substring(match.index - 4, match.index)) || // Avoid separating tokens when the following token is a quantifier
  isQuantifierNext(match.input, matchEndPos, flags)) {
    return '';
  } // Keep tokens separated. This avoids e.g. inadvertedly changing `\1 1` or `\1(?#)1` to `\11`.
  // This also ensures all tokens remain as discrete atoms, e.g. it prevents converting the
  // syntax error `(? :` into `(?:`.


  return '(?:)';
}
/**
 * Returns native `RegExp` flags used by a regex object.
 *
 * @private
 * @param {RegExp} regex Regex to check.
 * @returns {string} Native flags in use.
 */


function getNativeFlags(regex) {
  return hasFlagsProp ? (0, _flags["default"])(regex) : // Explicitly using `RegExp.prototype.toString` (rather than e.g. `String` or concatenation
  // with an empty string) allows this to continue working predictably when
  // `XRegExp.proptotype.toString` is overridden
  /\/([a-z]*)$/i.exec(RegExp.prototype.toString.call(regex))[1];
}
/**
 * Determines whether a regex has extended instance data used to track capture names.
 *
 * @private
 * @param {RegExp} regex Regex to check.
 * @returns {boolean} Whether the regex uses named capture.
 */


function hasNamedCapture(regex) {
  return !!(regex[REGEX_DATA] && regex[REGEX_DATA].captureNames);
}
/**
 * Converts decimal to hexadecimal.
 *
 * @private
 * @param {Number|String} dec
 * @returns {string}
 */


function hex(dec) {
  return (0, _parseInt2["default"])(dec, 10).toString(16);
}
/**
 * Checks whether the next nonignorable token after the specified position is a quantifier.
 *
 * @private
 * @param {String} pattern Pattern to search within.
 * @param {Number} pos Index in `pattern` to search at.
 * @param {String} flags Flags used by the pattern.
 * @returns {Boolean} Whether the next nonignorable token is a quantifier.
 */


function isQuantifierNext(pattern, pos, flags) {
  var inlineCommentPattern = '\\(\\?#[^)]*\\)';
  var lineCommentPattern = '#[^#\\n]*';
  var quantifierPattern = '[?*+]|{\\d+(?:,\\d*)?}';
  var regex = (0, _indexOf["default"])(flags).call(flags, 'x') !== -1 ? // Ignore any leading whitespace, line comments, and inline comments
  /^(?:\s|#[^#\n]*|\(\?#[^)]*\))*(?:[?*+]|{\d+(?:,\d*)?})/ : // Ignore any leading inline comments
  /^(?:\(\?#[^)]*\))*(?:[?*+]|{\d+(?:,\d*)?})/;
  return regex.test((0, _slice["default"])(pattern).call(pattern, pos));
}
/**
 * Determines whether a value is of the specified type, by resolving its internal [[Class]].
 *
 * @private
 * @param {*} value Object to check.
 * @param {String} type Type to check for, in TitleCase.
 * @returns {boolean} Whether the object matches the type.
 */


function isType(value, type) {
  return Object.prototype.toString.call(value) === "[object ".concat(type, "]");
}
/**
 * Returns the object, or throws an error if it is `null` or `undefined`. This is used to follow
 * the ES5 abstract operation `ToObject`.
 *
 * @private
 * @param {*} value Object to check and return.
 * @returns {*} The provided object.
 */


function nullThrows(value) {
  // null or undefined
  if (value == null) {
    throw new TypeError('Cannot convert null or undefined to object');
  }

  return value;
}
/**
 * Adds leading zeros if shorter than four characters. Used for fixed-length hexadecimal values.
 *
 * @private
 * @param {String} str
 * @returns {string}
 */


function pad4(str) {
  while (str.length < 4) {
    str = "0".concat(str);
  }

  return str;
}
/**
 * Checks for flag-related errors, and strips/applies flags in a leading mode modifier. Offloads
 * the flag preparation logic from the `XRegExp` constructor.
 *
 * @private
 * @param {String} pattern Regex pattern, possibly with a leading mode modifier.
 * @param {String} flags Any combination of flags.
 * @returns {!Object} Object with properties `pattern` and `flags`.
 */


function prepareFlags(pattern, flags) {
  // Recent browsers throw on duplicate flags, so copy this behavior for nonnative flags
  if (clipDuplicates(flags) !== flags) {
    throw new SyntaxError("Invalid duplicate regex flag ".concat(flags));
  } // Strip and apply a leading mode modifier with any combination of flags except `dgy`


  pattern = pattern.replace(/^\(\?([\w$]+)\)/, function ($0, $1) {
    if (/[dgy]/.test($1)) {
      throw new SyntaxError("Cannot use flags dgy in mode modifier ".concat($0));
    } // Allow duplicate flags within the mode modifier


    flags = clipDuplicates(flags + $1);
    return '';
  }); // Throw on unknown native or nonnative flags

  var _iterator = _createForOfIteratorHelper(flags),
      _step;

  try {
    for (_iterator.s(); !(_step = _iterator.n()).done;) {
      var flag = _step.value;

      if (!registeredFlags[flag]) {
        throw new SyntaxError("Unknown regex flag ".concat(flag));
      }
    }
  } catch (err) {
    _iterator.e(err);
  } finally {
    _iterator.f();
  }

  return {
    pattern: pattern,
    flags: flags
  };
}
/**
 * Prepares an options object from the given value.
 *
 * @private
 * @param {String|Object} value Value to convert to an options object.
 * @returns {Object} Options object.
 */


function prepareOptions(value) {
  var options = {};

  if (isType(value, 'String')) {
    (0, _forEach["default"])(XRegExp).call(XRegExp, value, /[^\s,]+/, function (match) {
      options[match] = true;
    });
    return options;
  }

  return value;
}
/**
 * Registers a flag so it doesn't throw an 'unknown flag' error.
 *
 * @private
 * @param {String} flag Single-character flag to register.
 */


function registerFlag(flag) {
  if (!/^[\w$]$/.test(flag)) {
    throw new Error('Flag must be a single character A-Za-z0-9_$');
  }

  registeredFlags[flag] = true;
}
/**
 * Runs built-in and custom regex syntax tokens in reverse insertion order at the specified
 * position, until a match is found.
 *
 * @private
 * @param {String} pattern Original pattern from which an XRegExp object is being built.
 * @param {String} flags Flags being used to construct the regex.
 * @param {Number} pos Position to search for tokens within `pattern`.
 * @param {Number} scope Regex scope to apply: 'default' or 'class'.
 * @param {Object} context Context object to use for token handler functions.
 * @returns {Object} Object with properties `matchLength`, `output`, and `reparse`; or `null`.
 */


function runTokens(pattern, flags, pos, scope, context) {
  var i = tokens.length;
  var leadChar = pattern[pos];
  var result = null;
  var match;
  var t; // Run in reverse insertion order

  while (i--) {
    t = tokens[i];

    if (t.leadChar && t.leadChar !== leadChar || t.scope !== scope && t.scope !== 'all' || t.flag && !((0, _indexOf["default"])(flags).call(flags, t.flag) !== -1)) {
      continue;
    }

    match = XRegExp.exec(pattern, t.regex, pos, 'sticky');

    if (match) {
      result = {
        matchLength: match[0].length,
        output: t.handler.call(context, match, scope, flags),
        reparse: t.reparse
      }; // Finished with token tests

      break;
    }
  }

  return result;
}
/**
 * Enables or disables implicit astral mode opt-in. When enabled, flag A is automatically added to
 * all new regexes created by XRegExp. This causes an error to be thrown when creating regexes if
 * the Unicode Base addon is not available, since flag A is registered by that addon.
 *
 * @private
 * @param {Boolean} on `true` to enable; `false` to disable.
 */


function setAstral(on) {
  features.astral = on;
}
/**
 * Adds named capture groups to the `groups` property of match arrays. See here for details:
 * https://github.com/tc39/proposal-regexp-named-groups
 *
 * @private
 * @param {Boolean} on `true` to enable; `false` to disable.
 */


function setNamespacing(on) {
  features.namespacing = on;
} // ==--------------------------==
// Constructor
// ==--------------------------==

/**
 * Creates an extended regular expression object for matching text with a pattern. Differs from a
 * native regular expression in that additional syntax and flags are supported. The returned object
 * is in fact a native `RegExp` and works with all native methods.
 *
 * @class XRegExp
 * @constructor
 * @param {String|RegExp} pattern Regex pattern string, or an existing regex object to copy.
 * @param {String} [flags] Any combination of flags.
 *   Native flags:
 *     - `d` - indices for capturing groups (ES2021)
 *     - `g` - global
 *     - `i` - ignore case
 *     - `m` - multiline anchors
 *     - `u` - unicode (ES6)
 *     - `y` - sticky (Firefox 3+, ES6)
 *   Additional XRegExp flags:
 *     - `n` - named capture only
 *     - `s` - dot matches all (aka singleline) - works even when not natively supported
 *     - `x` - free-spacing and line comments (aka extended)
 *     - `A` - 21-bit Unicode properties (aka astral) - requires the Unicode Base addon
 *   Flags cannot be provided when constructing one `RegExp` from another.
 * @returns {RegExp} Extended regular expression object.
 * @example
 *
 * // With named capture and flag x
 * XRegExp(`(?<year>  [0-9]{4} ) -?  # year
 *          (?<month> [0-9]{2} ) -?  # month
 *          (?<day>   [0-9]{2} )     # day`, 'x');
 *
 * // Providing a regex object copies it. Native regexes are recompiled using native (not XRegExp)
 * // syntax. Copies maintain extended data, are augmented with `XRegExp.prototype` properties, and
 * // have fresh `lastIndex` properties (set to zero).
 * XRegExp(/regex/);
 */


function XRegExp(pattern, flags) {
  if (XRegExp.isRegExp(pattern)) {
    if (flags !== undefined) {
      throw new TypeError('Cannot supply flags when copying a RegExp');
    }

    return copyRegex(pattern);
  } // Copy the argument behavior of `RegExp`


  pattern = pattern === undefined ? '' : String(pattern);
  flags = flags === undefined ? '' : String(flags);

  if (XRegExp.isInstalled('astral') && !((0, _indexOf["default"])(flags).call(flags, 'A') !== -1)) {
    // This causes an error to be thrown if the Unicode Base addon is not available
    flags += 'A';
  }

  if (!patternCache[pattern]) {
    patternCache[pattern] = {};
  }

  if (!patternCache[pattern][flags]) {
    var context = {
      hasNamedCapture: false,
      captureNames: []
    };
    var scope = defaultScope;
    var output = '';
    var pos = 0;
    var result; // Check for flag-related errors, and strip/apply flags in a leading mode modifier

    var applied = prepareFlags(pattern, flags);
    var appliedPattern = applied.pattern;
    var appliedFlags = (0, _flags["default"])(applied); // Use XRegExp's tokens to translate the pattern to a native regex pattern.
    // `appliedPattern.length` may change on each iteration if tokens use `reparse`

    while (pos < appliedPattern.length) {
      do {
        // Check for custom tokens at the current position
        result = runTokens(appliedPattern, appliedFlags, pos, scope, context); // If the matched token used the `reparse` option, splice its output into the
        // pattern before running tokens again at the same position

        if (result && result.reparse) {
          appliedPattern = (0, _slice["default"])(appliedPattern).call(appliedPattern, 0, pos) + result.output + (0, _slice["default"])(appliedPattern).call(appliedPattern, pos + result.matchLength);
        }
      } while (result && result.reparse);

      if (result) {
        output += result.output;
        pos += result.matchLength || 1;
      } else {
        // Get the native token at the current position
        var _XRegExp$exec = XRegExp.exec(appliedPattern, nativeTokens[scope], pos, 'sticky'),
            _XRegExp$exec2 = (0, _slicedToArray2["default"])(_XRegExp$exec, 1),
            token = _XRegExp$exec2[0];

        output += token;
        pos += token.length;

        if (token === '[' && scope === defaultScope) {
          scope = classScope;
        } else if (token === ']' && scope === classScope) {
          scope = defaultScope;
        }
      }
    }

    patternCache[pattern][flags] = {
      // Use basic cleanup to collapse repeated empty groups like `(?:)(?:)` to `(?:)`. Empty
      // groups are sometimes inserted during regex transpilation in order to keep tokens
      // separated. However, more than one empty group in a row is never needed.
      pattern: output.replace(/(?:\(\?:\))+/g, '(?:)'),
      // Strip all but native flags
      flags: appliedFlags.replace(nonnativeFlags, ''),
      // `context.captureNames` has an item for each capturing group, even if unnamed
      captures: context.hasNamedCapture ? context.captureNames : null
    };
  }

  var generated = patternCache[pattern][flags];
  return augment(new RegExp(generated.pattern, (0, _flags["default"])(generated)), generated.captures, pattern, flags);
} // Add `RegExp.prototype` to the prototype chain


XRegExp.prototype = /(?:)/; // ==--------------------------==
// Public properties
// ==--------------------------==

/**
 * The XRegExp version number as a string containing three dot-separated parts. For example,
 * '2.0.0-beta-3'.
 *
 * @static
 * @memberOf XRegExp
 * @type String
 */

XRegExp.version = '5.1.1'; // ==--------------------------==
// Public methods
// ==--------------------------==
// Intentionally undocumented; used in tests and addons

XRegExp._clipDuplicates = clipDuplicates;
XRegExp._hasNativeFlag = hasNativeFlag;
XRegExp._dec = dec;
XRegExp._hex = hex;
XRegExp._pad4 = pad4;
/**
 * Extends XRegExp syntax and allows custom flags. This is used internally and can be used to
 * create XRegExp addons. If more than one token can match the same string, the last added wins.
 *
 * @memberOf XRegExp
 * @param {RegExp} regex Regex object that matches the new token.
 * @param {Function} handler Function that returns a new pattern string (using native regex syntax)
 *   to replace the matched token within all future XRegExp regexes. Has access to persistent
 *   properties of the regex being built, through `this`. Invoked with three arguments:
 *   - The match array, with named backreference properties.
 *   - The regex scope where the match was found: 'default' or 'class'.
 *   - The flags used by the regex, including any flags in a leading mode modifier.
 *   The handler function becomes part of the XRegExp construction process, so be careful not to
 *   construct XRegExps within the function or you will trigger infinite recursion.
 * @param {Object} [options] Options object with optional properties:
 *   - `scope` {String} Scope where the token applies: 'default', 'class', or 'all'.
 *   - `flag` {String} Single-character flag that triggers the token. This also registers the
 *     flag, which prevents XRegExp from throwing an 'unknown flag' error when the flag is used.
 *   - `optionalFlags` {String} Any custom flags checked for within the token `handler` that are
 *     not required to trigger the token. This registers the flags, to prevent XRegExp from
 *     throwing an 'unknown flag' error when any of the flags are used.
 *   - `reparse` {Boolean} Whether the `handler` function's output should not be treated as
 *     final, and instead be reparseable by other tokens (including the current token). Allows
 *     token chaining or deferring.
 *   - `leadChar` {String} Single character that occurs at the beginning of any successful match
 *     of the token (not always applicable). This doesn't change the behavior of the token unless
 *     you provide an erroneous value. However, providing it can increase the token's performance
 *     since the token can be skipped at any positions where this character doesn't appear.
 * @example
 *
 * // Basic usage: Add \a for the ALERT control code
 * XRegExp.addToken(
 *   /\\a/,
 *   () => '\\x07',
 *   {scope: 'all'}
 * );
 * XRegExp('\\a[\\a-\\n]+').test('\x07\n\x07'); // -> true
 *
 * // Add the U (ungreedy) flag from PCRE and RE2, which reverses greedy and lazy quantifiers.
 * // Since `scope` is not specified, it uses 'default' (i.e., transformations apply outside of
 * // character classes only)
 * XRegExp.addToken(
 *   /([?*+]|{\d+(?:,\d*)?})(\??)/,
 *   (match) => `${match[1]}${match[2] ? '' : '?'}`,
 *   {flag: 'U'}
 * );
 * XRegExp('a+', 'U').exec('aaa')[0]; // -> 'a'
 * XRegExp('a+?', 'U').exec('aaa')[0]; // -> 'aaa'
 */

XRegExp.addToken = function (regex, handler, options) {
  options = options || {};
  var _options = options,
      optionalFlags = _options.optionalFlags;

  if (options.flag) {
    registerFlag(options.flag);
  }

  if (optionalFlags) {
    optionalFlags = optionalFlags.split('');

    var _iterator2 = _createForOfIteratorHelper(optionalFlags),
        _step2;

    try {
      for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {
        var flag = _step2.value;
        registerFlag(flag);
      }
    } catch (err) {
      _iterator2.e(err);
    } finally {
      _iterator2.f();
    }
  } // Add to the private list of syntax tokens


  tokens.push({
    regex: copyRegex(regex, {
      addG: true,
      addY: hasNativeY,
      isInternalOnly: true
    }),
    handler: handler,
    scope: options.scope || defaultScope,
    flag: options.flag,
    reparse: options.reparse,
    leadChar: options.leadChar
  }); // Reset the pattern cache used by the `XRegExp` constructor, since the same pattern and flags
  // might now produce different results

  XRegExp.cache.flush('patterns');
};
/**
 * Caches and returns the result of calling `XRegExp(pattern, flags)`. On any subsequent call with
 * the same pattern and flag combination, the cached copy of the regex is returned.
 *
 * @memberOf XRegExp
 * @param {String} pattern Regex pattern string.
 * @param {String} [flags] Any combination of XRegExp flags.
 * @returns {RegExp} Cached XRegExp object.
 * @example
 *
 * let match;
 * while (match = XRegExp.cache('.', 'gs').exec('abc')) {
 *   // The regex is compiled once only
 * }
 */


XRegExp.cache = function (pattern, flags) {
  if (!regexCache[pattern]) {
    regexCache[pattern] = {};
  }

  return regexCache[pattern][flags] || (regexCache[pattern][flags] = XRegExp(pattern, flags));
}; // Intentionally undocumented; used in tests


XRegExp.cache.flush = function (cacheName) {
  if (cacheName === 'patterns') {
    // Flush the pattern cache used by the `XRegExp` constructor
    patternCache = {};
  } else {
    // Flush the regex cache populated by `XRegExp.cache`
    regexCache = {};
  }
};
/**
 * Escapes any regular expression metacharacters, for use when matching literal strings. The result
 * can safely be used at any position within a regex that uses any flags.
 *
 * @memberOf XRegExp
 * @param {String} str String to escape.
 * @returns {string} String with regex metacharacters escaped.
 * @example
 *
 * XRegExp.escape('Escaped? <.>');
 * // -> 'Escaped\?\u0020<\.>'
 */
// Following are the contexts where each metacharacter needs to be escaped because it would
// otherwise have a special meaning, change the meaning of surrounding characters, or cause an
// error. Context 'default' means outside character classes only.
// - `\` - context: all
// - `[()*+?.$|` - context: default
// - `]` - context: default with flag u or if forming the end of a character class
// - `{}` - context: default with flag u or if part of a valid/complete quantifier pattern
// - `,` - context: default if in a position that causes an unescaped `{` to turn into a quantifier.
//   Ex: `/^a{1\,2}$/` matches `'a{1,2}'`, but `/^a{1,2}$/` matches `'a'` or `'aa'`
// - `#` and <whitespace> - context: default with flag x
// - `^` - context: default, and context: class if it's the first character in the class
// - `-` - context: class if part of a valid character class range


XRegExp.escape = function (str) {
  return String(nullThrows(str)). // Escape most special chars with a backslash
  replace(/[\\\[\]{}()*+?.^$|]/g, '\\$&'). // Convert to \uNNNN for special chars that can't be escaped when used with ES6 flag `u`
  replace(/[\s#\-,]/g, function (match) {
    return "\\u".concat(pad4(hex(match.charCodeAt(0))));
  });
};
/**
 * Executes a regex search in a specified string. Returns a match array or `null`. If the provided
 * regex uses named capture, named capture properties are included on the match array's `groups`
 * property. Optional `pos` and `sticky` arguments specify the search start position, and whether
 * the match must start at the specified position only. The `lastIndex` property of the provided
 * regex is not used, but is updated for compatibility. Also fixes browser bugs compared to the
 * native `RegExp.prototype.exec` and can be used reliably cross-browser.
 *
 * @memberOf XRegExp
 * @param {String} str String to search.
 * @param {RegExp} regex Regex to search with.
 * @param {Number} [pos=0] Zero-based index at which to start the search.
 * @param {Boolean|String} [sticky=false] Whether the match must start at the specified position
 *   only. The string `'sticky'` is accepted as an alternative to `true`.
 * @returns {Array} Match array with named capture properties on the `groups` object, or `null`. If
 *   the `namespacing` feature is off, named capture properties are directly on the match array.
 * @example
 *
 * // Basic use, with named capturing group
 * let match = XRegExp.exec('U+2620', XRegExp('U\\+(?<hex>[0-9A-F]{4})'));
 * match.groups.hex; // -> '2620'
 *
 * // With pos and sticky, in a loop
 * let pos = 3, result = [], match;
 * while (match = XRegExp.exec('<1><2><3><4>5<6>', /<(\d)>/, pos, 'sticky')) {
 *   result.push(match[1]);
 *   pos = match.index + match[0].length;
 * }
 * // result -> ['2', '3', '4']
 */


XRegExp.exec = function (str, regex, pos, sticky) {
  var cacheKey = 'g';
  var addY = false;
  var fakeY = false;
  var match;
  addY = hasNativeY && !!(sticky || regex.sticky && sticky !== false);

  if (addY) {
    cacheKey += 'y';
  } else if (sticky) {
    // Simulate sticky matching by appending an empty capture to the original regex. The
    // resulting regex will succeed no matter what at the current index (set with `lastIndex`),
    // and will not search the rest of the subject string. We'll know that the original regex
    // has failed if that last capture is `''` rather than `undefined` (i.e., if that last
    // capture participated in the match).
    fakeY = true;
    cacheKey += 'FakeY';
  }

  regex[REGEX_DATA] = regex[REGEX_DATA] || {}; // Shares cached copies with `XRegExp.match`/`replace`

  var r2 = regex[REGEX_DATA][cacheKey] || (regex[REGEX_DATA][cacheKey] = copyRegex(regex, {
    addG: true,
    addY: addY,
    source: fakeY ? "".concat(regex.source, "|()") : undefined,
    removeY: sticky === false,
    isInternalOnly: true
  }));
  pos = pos || 0;
  r2.lastIndex = pos; // Fixed `exec` required for `lastIndex` fix, named backreferences, etc.

  match = fixed.exec.call(r2, str); // Get rid of the capture added by the pseudo-sticky matcher if needed. An empty string means
  // the original regexp failed (see above).

  if (fakeY && match && match.pop() === '') {
    match = null;
  }

  if (regex.global) {
    regex.lastIndex = match ? r2.lastIndex : 0;
  }

  return match;
};
/**
 * Executes a provided function once per regex match. Searches always start at the beginning of the
 * string and continue until the end, regardless of the state of the regex's `global` property and
 * initial `lastIndex`.
 *
 * @memberOf XRegExp
 * @param {String} str String to search.
 * @param {RegExp} regex Regex to search with.
 * @param {Function} callback Function to execute for each match. Invoked with four arguments:
 *   - The match array, with named backreference properties.
 *   - The zero-based match index.
 *   - The string being traversed.
 *   - The regex object being used to traverse the string.
 * @example
 *
 * // Extracts every other digit from a string
 * const evens = [];
 * XRegExp.forEach('1a2345', /\d/, (match, i) => {
 *   if (i % 2) evens.push(+match[0]);
 * });
 * // evens -> [2, 4]
 */


XRegExp.forEach = function (str, regex, callback) {
  var pos = 0;
  var i = -1;
  var match;

  while (match = XRegExp.exec(str, regex, pos)) {
    // Because `regex` is provided to `callback`, the function could use the deprecated/
    // nonstandard `RegExp.prototype.compile` to mutate the regex. However, since `XRegExp.exec`
    // doesn't use `lastIndex` to set the search position, this can't lead to an infinite loop,
    // at least. Actually, because of the way `XRegExp.exec` caches globalized versions of
    // regexes, mutating the regex will not have any effect on the iteration or matched strings,
    // which is a nice side effect that brings extra safety.
    callback(match, ++i, str, regex);
    pos = match.index + (match[0].length || 1);
  }
};
/**
 * Copies a regex object and adds flag `g`. The copy maintains extended data, is augmented with
 * `XRegExp.prototype` properties, and has a fresh `lastIndex` property (set to zero). Native
 * regexes are not recompiled using XRegExp syntax.
 *
 * @memberOf XRegExp
 * @param {RegExp} regex Regex to globalize.
 * @returns {RegExp} Copy of the provided regex with flag `g` added.
 * @example
 *
 * const globalCopy = XRegExp.globalize(/regex/);
 * globalCopy.global; // -> true
 */


XRegExp.globalize = function (regex) {
  return copyRegex(regex, {
    addG: true
  });
};
/**
 * Installs optional features according to the specified options. Can be undone using
 * `XRegExp.uninstall`.
 *
 * @memberOf XRegExp
 * @param {Object|String} options Options object or string.
 * @example
 *
 * // With an options object
 * XRegExp.install({
 *   // Enables support for astral code points in Unicode addons (implicitly sets flag A)
 *   astral: true,
 *
 *   // Adds named capture groups to the `groups` property of matches
 *   namespacing: true
 * });
 *
 * // With an options string
 * XRegExp.install('astral namespacing');
 */


XRegExp.install = function (options) {
  options = prepareOptions(options);

  if (!features.astral && options.astral) {
    setAstral(true);
  }

  if (!features.namespacing && options.namespacing) {
    setNamespacing(true);
  }
};
/**
 * Checks whether an individual optional feature is installed.
 *
 * @memberOf XRegExp
 * @param {String} feature Name of the feature to check. One of:
 *   - `astral`
 *   - `namespacing`
 * @returns {boolean} Whether the feature is installed.
 * @example
 *
 * XRegExp.isInstalled('astral');
 */


XRegExp.isInstalled = function (feature) {
  return !!features[feature];
};
/**
 * Returns `true` if an object is a regex; `false` if it isn't. This works correctly for regexes
 * created in another frame, when `instanceof` and `constructor` checks would fail.
 *
 * @memberOf XRegExp
 * @param {*} value Object to check.
 * @returns {boolean} Whether the object is a `RegExp` object.
 * @example
 *
 * XRegExp.isRegExp('string'); // -> false
 * XRegExp.isRegExp(/regex/i); // -> true
 * XRegExp.isRegExp(RegExp('^', 'm')); // -> true
 * XRegExp.isRegExp(XRegExp('(?s).')); // -> true
 */


XRegExp.isRegExp = function (value) {
  return Object.prototype.toString.call(value) === '[object RegExp]';
}; // Same as `isType(value, 'RegExp')`, but avoiding that function call here for perf since
// `isRegExp` is used heavily by internals including regex construction

/**
 * Returns the first matched string, or in global mode, an array containing all matched strings.
 * This is essentially a more convenient re-implementation of `String.prototype.match` that gives
 * the result types you actually want (string instead of `exec`-style array in match-first mode,
 * and an empty array instead of `null` when no matches are found in match-all mode). It also lets
 * you override flag g and ignore `lastIndex`, and fixes browser bugs.
 *
 * @memberOf XRegExp
 * @param {String} str String to search.
 * @param {RegExp} regex Regex to search with.
 * @param {String} [scope='one'] Use 'one' to return the first match as a string. Use 'all' to
 *   return an array of all matched strings. If not explicitly specified and `regex` uses flag g,
 *   `scope` is 'all'.
 * @returns {String|Array} In match-first mode: First match as a string, or `null`. In match-all
 *   mode: Array of all matched strings, or an empty array.
 * @example
 *
 * // Match first
 * XRegExp.match('abc', /\w/); // -> 'a'
 * XRegExp.match('abc', /\w/g, 'one'); // -> 'a'
 * XRegExp.match('abc', /x/g, 'one'); // -> null
 *
 * // Match all
 * XRegExp.match('abc', /\w/g); // -> ['a', 'b', 'c']
 * XRegExp.match('abc', /\w/, 'all'); // -> ['a', 'b', 'c']
 * XRegExp.match('abc', /x/, 'all'); // -> []
 */


XRegExp.match = function (str, regex, scope) {
  var global = regex.global && scope !== 'one' || scope === 'all';
  var cacheKey = (global ? 'g' : '') + (regex.sticky ? 'y' : '') || 'noGY';
  regex[REGEX_DATA] = regex[REGEX_DATA] || {}; // Shares cached copies with `XRegExp.exec`/`replace`

  var r2 = regex[REGEX_DATA][cacheKey] || (regex[REGEX_DATA][cacheKey] = copyRegex(regex, {
    addG: !!global,
    removeG: scope === 'one',
    isInternalOnly: true
  }));
  var result = String(nullThrows(str)).match(r2);

  if (regex.global) {
    regex.lastIndex = scope === 'one' && result ? // Can't use `r2.lastIndex` since `r2` is nonglobal in this case
    result.index + result[0].length : 0;
  }

  return global ? result || [] : result && result[0];
};
/**
 * Retrieves the matches from searching a string using a chain of regexes that successively search
 * within previous matches. The provided `chain` array can contain regexes and or objects with
 * `regex` and `backref` properties. When a backreference is specified, the named or numbered
 * backreference is passed forward to the next regex or returned.
 *
 * @memberOf XRegExp
 * @param {String} str String to search.
 * @param {Array} chain Regexes that each search for matches within preceding results.
 * @returns {Array} Matches by the last regex in the chain, or an empty array.
 * @example
 *
 * // Basic usage; matches numbers within <b> tags
 * XRegExp.matchChain('1 <b>2</b> 3 <b>4 a 56</b>', [
 *   XRegExp('(?is)<b>.*?</b>'),
 *   /\d+/
 * ]);
 * // -> ['2', '4', '56']
 *
 * // Passing forward and returning specific backreferences
 * const html = `<a href="http://xregexp.com/api/">XRegExp</a>
 *               <a href="http://www.google.com/">Google</a>`;
 * XRegExp.matchChain(html, [
 *   {regex: /<a href="([^"]+)">/i, backref: 1},
 *   {regex: XRegExp('(?i)^https?://(?<domain>[^/?#]+)'), backref: 'domain'}
 * ]);
 * // -> ['xregexp.com', 'www.google.com']
 */


XRegExp.matchChain = function (str, chain) {
  return function recurseChain(values, level) {
    var item = chain[level].regex ? chain[level] : {
      regex: chain[level]
    };
    var matches = [];

    function addMatch(match) {
      if (item.backref) {
        var ERR_UNDEFINED_GROUP = "Backreference to undefined group: ".concat(item.backref);
        var isNamedBackref = isNaN(item.backref);

        if (isNamedBackref && XRegExp.isInstalled('namespacing')) {
          // `groups` has `null` as prototype, so using `in` instead of `hasOwnProperty`
          if (!(match.groups && item.backref in match.groups)) {
            throw new ReferenceError(ERR_UNDEFINED_GROUP);
          }
        } else if (!match.hasOwnProperty(item.backref)) {
          throw new ReferenceError(ERR_UNDEFINED_GROUP);
        }

        var backrefValue = isNamedBackref && XRegExp.isInstalled('namespacing') ? match.groups[item.backref] : match[item.backref];
        matches.push(backrefValue || '');
      } else {
        matches.push(match[0]);
      }
    }

    var _iterator3 = _createForOfIteratorHelper(values),
        _step3;

    try {
      for (_iterator3.s(); !(_step3 = _iterator3.n()).done;) {
        var value = _step3.value;
        (0, _forEach["default"])(XRegExp).call(XRegExp, value, item.regex, addMatch);
      }
    } catch (err) {
      _iterator3.e(err);
    } finally {
      _iterator3.f();
    }

    return level === chain.length - 1 || !matches.length ? matches : recurseChain(matches, level + 1);
  }([str], 0);
};
/**
 * Returns a new string with one or all matches of a pattern replaced. The pattern can be a string
 * or regex, and the replacement can be a string or a function to be called for each match. To
 * perform a global search and replace, use the optional `scope` argument or include flag g if using
 * a regex. Replacement strings can use `$<n>` or `${n}` for named and numbered backreferences.
 * Replacement functions can use named backreferences via the last argument. Also fixes browser bugs
 * compared to the native `String.prototype.replace` and can be used reliably cross-browser.
 *
 * @memberOf XRegExp
 * @param {String} str String to search.
 * @param {RegExp|String} search Search pattern to be replaced.
 * @param {String|Function} replacement Replacement string or a function invoked to create it.
 *   Replacement strings can include special replacement syntax:
 *     - $$ - Inserts a literal $ character.
 *     - $&, $0 - Inserts the matched substring.
 *     - $` - Inserts the string that precedes the matched substring (left context).
 *     - $' - Inserts the string that follows the matched substring (right context).
 *     - $n, $nn - Where n/nn are digits referencing an existing capturing group, inserts
 *       backreference n/nn.
 *     - $<n>, ${n} - Where n is a name or any number of digits that reference an existing capturing
 *       group, inserts backreference n.
 *   Replacement functions are invoked with three or more arguments:
 *     - args[0] - The matched substring (corresponds to `$&` above). If the `namespacing` feature
 *       is off, named backreferences are accessible as properties of this argument.
 *     - args[1..n] - One argument for each backreference (corresponding to `$1`, `$2`, etc. above).
 *       If the regex has no capturing groups, no arguments appear in this position.
 *     - args[n+1] - The zero-based index of the match within the entire search string.
 *     - args[n+2] - The total string being searched.
 *     - args[n+3] - If the the search pattern is a regex with named capturing groups, the last
 *       argument is the groups object. Its keys are the backreference names and its values are the
 *       backreference values. If the `namespacing` feature is off, this argument is not present.
 * @param {String} [scope] Use 'one' to replace the first match only, or 'all'. Defaults to 'one'.
 *   Defaults to 'all' if using a regex with flag g.
 * @returns {String} New string with one or all matches replaced.
 * @example
 *
 * // Regex search, using named backreferences in replacement string
 * const name = XRegExp('(?<first>\\w+) (?<last>\\w+)');
 * XRegExp.replace('John Smith', name, '$<last>, $<first>');
 * // -> 'Smith, John'
 *
 * // Regex search, using named backreferences in replacement function
 * XRegExp.replace('John Smith', name, (...args) => {
 *   const groups = args[args.length - 1];
 *   return `${groups.last}, ${groups.first}`;
 * });
 * // -> 'Smith, John'
 *
 * // String search, with replace-all
 * XRegExp.replace('RegExp builds RegExps', 'RegExp', 'XRegExp', 'all');
 * // -> 'XRegExp builds XRegExps'
 */


XRegExp.replace = function (str, search, replacement, scope) {
  var isRegex = XRegExp.isRegExp(search);
  var global = search.global && scope !== 'one' || scope === 'all';
  var cacheKey = (global ? 'g' : '') + (search.sticky ? 'y' : '') || 'noGY';
  var s2 = search;

  if (isRegex) {
    search[REGEX_DATA] = search[REGEX_DATA] || {}; // Shares cached copies with `XRegExp.exec`/`match`. Since a copy is used, `search`'s
    // `lastIndex` isn't updated *during* replacement iterations

    s2 = search[REGEX_DATA][cacheKey] || (search[REGEX_DATA][cacheKey] = copyRegex(search, {
      addG: !!global,
      removeG: scope === 'one',
      isInternalOnly: true
    }));
  } else if (global) {
    s2 = new RegExp(XRegExp.escape(String(search)), 'g');
  } // Fixed `replace` required for named backreferences, etc.


  var result = fixed.replace.call(nullThrows(str), s2, replacement);

  if (isRegex && search.global) {
    // Fixes IE, Safari bug (last tested IE 9, Safari 5.1)
    search.lastIndex = 0;
  }

  return result;
};
/**
 * Performs batch processing of string replacements. Used like `XRegExp.replace`, but accepts an
 * array of replacement details. Later replacements operate on the output of earlier replacements.
 * Replacement details are accepted as an array with a regex or string to search for, the
 * replacement string or function, and an optional scope of 'one' or 'all'. Uses the XRegExp
 * replacement text syntax, which supports named backreference properties via `$<name>` or
 * `${name}`.
 *
 * @memberOf XRegExp
 * @param {String} str String to search.
 * @param {Array} replacements Array of replacement detail arrays.
 * @returns {String} New string with all replacements.
 * @example
 *
 * str = XRegExp.replaceEach(str, [
 *   [XRegExp('(?<name>a)'), 'z$<name>'],
 *   [/b/gi, 'y'],
 *   [/c/g, 'x', 'one'], // scope 'one' overrides /g
 *   [/d/, 'w', 'all'],  // scope 'all' overrides lack of /g
 *   ['e', 'v', 'all'],  // scope 'all' allows replace-all for strings
 *   [/f/g, (match) => match.toUpperCase()]
 * ]);
 */


XRegExp.replaceEach = function (str, replacements) {
  var _iterator4 = _createForOfIteratorHelper(replacements),
      _step4;

  try {
    for (_iterator4.s(); !(_step4 = _iterator4.n()).done;) {
      var r = _step4.value;
      str = XRegExp.replace(str, r[0], r[1], r[2]);
    }
  } catch (err) {
    _iterator4.e(err);
  } finally {
    _iterator4.f();
  }

  return str;
};
/**
 * Splits a string into an array of strings using a regex or string separator. Matches of the
 * separator are not included in the result array. However, if `separator` is a regex that contains
 * capturing groups, backreferences are spliced into the result each time `separator` is matched.
 * Fixes browser bugs compared to the native `String.prototype.split` and can be used reliably
 * cross-browser.
 *
 * @memberOf XRegExp
 * @param {String} str String to split.
 * @param {RegExp|String} separator Regex or string to use for separating the string.
 * @param {Number} [limit] Maximum number of items to include in the result array.
 * @returns {Array} Array of substrings.
 * @example
 *
 * // Basic use
 * XRegExp.split('a b c', ' ');
 * // -> ['a', 'b', 'c']
 *
 * // With limit
 * XRegExp.split('a b c', ' ', 2);
 * // -> ['a', 'b']
 *
 * // Backreferences in result array
 * XRegExp.split('..word1..', /([a-z]+)(\d+)/i);
 * // -> ['..', 'word', '1', '..']
 */


XRegExp.split = function (str, separator, limit) {
  return fixed.split.call(nullThrows(str), separator, limit);
};
/**
 * Executes a regex search in a specified string. Returns `true` or `false`. Optional `pos` and
 * `sticky` arguments specify the search start position, and whether the match must start at the
 * specified position only. The `lastIndex` property of the provided regex is not used, but is
 * updated for compatibility. Also fixes browser bugs compared to the native
 * `RegExp.prototype.test` and can be used reliably cross-browser.
 *
 * @memberOf XRegExp
 * @param {String} str String to search.
 * @param {RegExp} regex Regex to search with.
 * @param {Number} [pos=0] Zero-based index at which to start the search.
 * @param {Boolean|String} [sticky=false] Whether the match must start at the specified position
 *   only. The string `'sticky'` is accepted as an alternative to `true`.
 * @returns {boolean} Whether the regex matched the provided value.
 * @example
 *
 * // Basic use
 * XRegExp.test('abc', /c/); // -> true
 *
 * // With pos and sticky
 * XRegExp.test('abc', /c/, 0, 'sticky'); // -> false
 * XRegExp.test('abc', /c/, 2, 'sticky'); // -> true
 */
// Do this the easy way :-)


XRegExp.test = function (str, regex, pos, sticky) {
  return !!XRegExp.exec(str, regex, pos, sticky);
};
/**
 * Uninstalls optional features according to the specified options. Used to undo the actions of
 * `XRegExp.install`.
 *
 * @memberOf XRegExp
 * @param {Object|String} options Options object or string.
 * @example
 *
 * // With an options object
 * XRegExp.uninstall({
 *   // Disables support for astral code points in Unicode addons (unless enabled per regex)
 *   astral: true,
 *
 *   // Don't add named capture groups to the `groups` property of matches
 *   namespacing: true
 * });
 *
 * // With an options string
 * XRegExp.uninstall('astral namespacing');
 */


XRegExp.uninstall = function (options) {
  options = prepareOptions(options);

  if (features.astral && options.astral) {
    setAstral(false);
  }

  if (features.namespacing && options.namespacing) {
    setNamespacing(false);
  }
};
/**
 * Returns an XRegExp object that is the union of the given patterns. Patterns can be provided as
 * regex objects or strings. Metacharacters are escaped in patterns provided as strings.
 * Backreferences in provided regex objects are automatically renumbered to work correctly within
 * the larger combined pattern. Native flags used by provided regexes are ignored in favor of the
 * `flags` argument.
 *
 * @memberOf XRegExp
 * @param {Array} patterns Regexes and strings to combine.
 * @param {String} [flags] Any combination of XRegExp flags.
 * @param {Object} [options] Options object with optional properties:
 *   - `conjunction` {String} Type of conjunction to use: 'or' (default) or 'none'.
 * @returns {RegExp} Union of the provided regexes and strings.
 * @example
 *
 * XRegExp.union(['a+b*c', /(dogs)\1/, /(cats)\1/], 'i');
 * // -> /a\+b\*c|(dogs)\1|(cats)\2/i
 *
 * XRegExp.union([/man/, /bear/, /pig/], 'i', {conjunction: 'none'});
 * // -> /manbearpig/i
 */


XRegExp.union = function (patterns, flags, options) {
  options = options || {};
  var conjunction = options.conjunction || 'or';
  var numCaptures = 0;
  var numPriorCaptures;
  var captureNames;

  function rewrite(match, paren, backref) {
    var name = captureNames[numCaptures - numPriorCaptures]; // Capturing group

    if (paren) {
      ++numCaptures; // If the current capture has a name, preserve the name

      if (name) {
        return "(?<".concat(name, ">");
      } // Backreference

    } else if (backref) {
      // Rewrite the backreference
      return "\\".concat(+backref + numPriorCaptures);
    }

    return match;
  }

  if (!(isType(patterns, 'Array') && patterns.length)) {
    throw new TypeError('Must provide a nonempty array of patterns to merge');
  }

  var parts = /(\()(?!\?)|\\([1-9]\d*)|\\[\s\S]|\[(?:[^\\\]]|\\[\s\S])*\]/g;
  var output = [];

  var _iterator5 = _createForOfIteratorHelper(patterns),
      _step5;

  try {
    for (_iterator5.s(); !(_step5 = _iterator5.n()).done;) {
      var pattern = _step5.value;

      if (XRegExp.isRegExp(pattern)) {
        numPriorCaptures = numCaptures;
        captureNames = pattern[REGEX_DATA] && pattern[REGEX_DATA].captureNames || []; // Rewrite backreferences. Passing to XRegExp dies on octals and ensures patterns are
        // independently valid; helps keep this simple. Named captures are put back

        output.push(XRegExp(pattern.source).source.replace(parts, rewrite));
      } else {
        output.push(XRegExp.escape(pattern));
      }
    }
  } catch (err) {
    _iterator5.e(err);
  } finally {
    _iterator5.f();
  }

  var separator = conjunction === 'none' ? '' : '|';
  return XRegExp(output.join(separator), flags);
}; // ==--------------------------==
// Fixed/extended native methods
// ==--------------------------==

/**
 * Adds named capture support (with backreferences returned as `result.name`), and fixes browser
 * bugs in the native `RegExp.prototype.exec`. Use via `XRegExp.exec`.
 *
 * @memberOf RegExp
 * @param {String} str String to search.
 * @returns {Array} Match array with named backreference properties, or `null`.
 */


fixed.exec = function (str) {
  var origLastIndex = this.lastIndex;
  var match = RegExp.prototype.exec.apply(this, arguments);

  if (match) {
    // Fix browsers whose `exec` methods don't return `undefined` for nonparticipating capturing
    // groups. This fixes IE 5.5-8, but not IE 9's quirks mode or emulation of older IEs. IE 9
    // in standards mode follows the spec.
    if (!correctExecNpcg && match.length > 1 && (0, _indexOf["default"])(match).call(match, '') !== -1) {
      var _context3;

      var r2 = copyRegex(this, {
        removeG: true,
        isInternalOnly: true
      }); // Using `str.slice(match.index)` rather than `match[0]` in case lookahead allowed
      // matching due to characters outside the match

      (0, _slice["default"])(_context3 = String(str)).call(_context3, match.index).replace(r2, function () {
        var len = arguments.length; // Skip index 0 and the last 2

        for (var i = 1; i < len - 2; ++i) {
          if ((i < 0 || arguments.length <= i ? undefined : arguments[i]) === undefined) {
            match[i] = undefined;
          }
        }
      });
    } // Attach named capture properties


    if (this[REGEX_DATA] && this[REGEX_DATA].captureNames) {
      var groupsObject = match;

      if (XRegExp.isInstalled('namespacing')) {
        // https://tc39.github.io/proposal-regexp-named-groups/#sec-regexpbuiltinexec
        match.groups = (0, _create["default"])(null);
        groupsObject = match.groups;
      } // Skip index 0


      for (var i = 1; i < match.length; ++i) {
        var name = this[REGEX_DATA].captureNames[i - 1];

        if (name) {
          groupsObject[name] = match[i];
        }
      } // Preserve any existing `groups` obj that came from native ES2018 named capture

    } else if (!match.groups && XRegExp.isInstalled('namespacing')) {
      match.groups = undefined;
    } // Fix browsers that increment `lastIndex` after zero-length matches


    if (this.global && !match[0].length && this.lastIndex > match.index) {
      this.lastIndex = match.index;
    }
  }

  if (!this.global) {
    // Fixes IE, Opera bug (last tested IE 9, Opera 11.6)
    this.lastIndex = origLastIndex;
  }

  return match;
};
/**
 * Fixes browser bugs in the native `RegExp.prototype.test`.
 *
 * @memberOf RegExp
 * @param {String} str String to search.
 * @returns {boolean} Whether the regex matched the provided value.
 */


fixed.test = function (str) {
  // Do this the easy way :-)
  return !!fixed.exec.call(this, str);
};
/**
 * Adds named capture support (with backreferences returned as `result.name`), and fixes browser
 * bugs in the native `String.prototype.match`.
 *
 * @memberOf String
 * @param {RegExp|*} regex Regex to search with. If not a regex object, it is passed to `RegExp`.
 * @returns {Array} If `regex` uses flag g, an array of match strings or `null`. Without flag g,
 *   the result of calling `regex.exec(this)`.
 */


fixed.match = function (regex) {
  if (!XRegExp.isRegExp(regex)) {
    // Use the native `RegExp` rather than `XRegExp`
    regex = new RegExp(regex);
  } else if (regex.global) {
    var result = String.prototype.match.apply(this, arguments); // Fixes IE bug

    regex.lastIndex = 0;
    return result;
  }

  return fixed.exec.call(regex, nullThrows(this));
};
/**
 * Adds support for `${n}` (or `$<n>`) tokens for named and numbered backreferences in replacement
 * text, and provides named backreferences to replacement functions as `arguments[0].name`. Also
 * fixes browser bugs in replacement text syntax when performing a replacement using a nonregex
 * search value, and the value of a replacement regex's `lastIndex` property during replacement
 * iterations and upon completion. Note that this doesn't support SpiderMonkey's proprietary third
 * (`flags`) argument. Use via `XRegExp.replace`.
 *
 * @memberOf String
 * @param {RegExp|String} search Search pattern to be replaced.
 * @param {String|Function} replacement Replacement string or a function invoked to create it.
 * @returns {string} New string with one or all matches replaced.
 */


fixed.replace = function (search, replacement) {
  var isRegex = XRegExp.isRegExp(search);
  var origLastIndex;
  var captureNames;
  var result;

  if (isRegex) {
    if (search[REGEX_DATA]) {
      captureNames = search[REGEX_DATA].captureNames;
    } // Only needed if `search` is nonglobal


    origLastIndex = search.lastIndex;
  } else {
    search += ''; // Type-convert
  } // Don't use `typeof`; some older browsers return 'function' for regex objects


  if (isType(replacement, 'Function')) {
    // Stringifying `this` fixes a bug in IE < 9 where the last argument in replacement
    // functions isn't type-converted to a string
    result = String(this).replace(search, function () {
      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      if (captureNames) {
        var groupsObject;

        if (XRegExp.isInstalled('namespacing')) {
          // https://tc39.github.io/proposal-regexp-named-groups/#sec-regexpbuiltinexec
          groupsObject = (0, _create["default"])(null);
          args.push(groupsObject);
        } else {
          // Change the `args[0]` string primitive to a `String` object that can store
          // properties. This really does need to use `String` as a constructor
          args[0] = new String(args[0]);
          groupsObject = args[0];
        } // Store named backreferences


        for (var i = 0; i < captureNames.length; ++i) {
          if (captureNames[i]) {
            groupsObject[captureNames[i]] = args[i + 1];
          }
        }
      } // ES6 specs the context for replacement functions as `undefined`


      return replacement.apply(void 0, args);
    });
  } else {
    // Ensure that the last value of `args` will be a string when given nonstring `this`,
    // while still throwing on null or undefined context
    result = String(nullThrows(this)).replace(search, function () {
      for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        args[_key2] = arguments[_key2];
      }

      return String(replacement).replace(replacementToken, replacer);

      function replacer($0, bracketed, angled, dollarToken) {
        bracketed = bracketed || angled; // ES2018 added a new trailing `groups` arg that's passed to replacement functions
        // when the search regex uses native named capture

        var numNonCaptureArgs = isType(args[args.length - 1], 'Object') ? 4 : 3;
        var numCaptures = args.length - numNonCaptureArgs; // Handle named or numbered backreference with curly or angled braces: ${n}, $<n>

        if (bracketed) {
          // Handle backreference to numbered capture, if `bracketed` is an integer. Use
          // `0` for the entire match. Any number of leading zeros may be used.
          if (/^\d+$/.test(bracketed)) {
            // Type-convert and drop leading zeros
            var _n = +bracketed;

            if (_n <= numCaptures) {
              return args[_n] || '';
            }
          } // Handle backreference to named capture. If the name does not refer to an
          // existing capturing group, it's an error. Also handles the error for numbered
          // backference that does not refer to an existing group.
          // Using `indexOf` since having groups with the same name is already an error,
          // otherwise would need `lastIndexOf`.


          var n = captureNames ? (0, _indexOf["default"])(captureNames).call(captureNames, bracketed) : -1;

          if (n < 0) {
            throw new SyntaxError("Backreference to undefined group ".concat($0));
          }

          return args[n + 1] || '';
        } // Handle `$`-prefixed variable
        // Handle space/blank first because type conversion with `+` drops space padding
        // and converts spaces and empty strings to `0`


        if (dollarToken === '' || dollarToken === ' ') {
          throw new SyntaxError("Invalid token ".concat($0));
        }

        if (dollarToken === '&' || +dollarToken === 0) {
          // $&, $0 (not followed by 1-9), $00
          return args[0];
        }

        if (dollarToken === '$') {
          // $$
          return '$';
        }

        if (dollarToken === '`') {
          var _context4;

          // $` (left context)
          return (0, _slice["default"])(_context4 = args[args.length - 1]).call(_context4, 0, args[args.length - 2]);
        }

        if (dollarToken === "'") {
          var _context5;

          // $' (right context)
          return (0, _slice["default"])(_context5 = args[args.length - 1]).call(_context5, args[args.length - 2] + args[0].length);
        } // Handle numbered backreference without braces
        // Type-convert and drop leading zero


        dollarToken = +dollarToken; // XRegExp behavior for `$n` and `$nn`:
        // - Backrefs end after 1 or 2 digits. Use `${..}` or `$<..>` for more digits.
        // - `$1` is an error if no capturing groups.
        // - `$10` is an error if less than 10 capturing groups. Use `${1}0` or `$<1>0`
        //   instead.
        // - `$01` is `$1` if at least one capturing group, else it's an error.
        // - `$0` (not followed by 1-9) and `$00` are the entire match.
        // Native behavior, for comparison:
        // - Backrefs end after 1 or 2 digits. Cannot reference capturing group 100+.
        // - `$1` is a literal `$1` if no capturing groups.
        // - `$10` is `$1` followed by a literal `0` if less than 10 capturing groups.
        // - `$01` is `$1` if at least one capturing group, else it's a literal `$01`.
        // - `$0` is a literal `$0`.

        if (!isNaN(dollarToken)) {
          if (dollarToken > numCaptures) {
            throw new SyntaxError("Backreference to undefined group ".concat($0));
          }

          return args[dollarToken] || '';
        } // `$` followed by an unsupported char is an error, unlike native JS


        throw new SyntaxError("Invalid token ".concat($0));
      }
    });
  }

  if (isRegex) {
    if (search.global) {
      // Fixes IE, Safari bug (last tested IE 9, Safari 5.1)
      search.lastIndex = 0;
    } else {
      // Fixes IE, Opera bug (last tested IE 9, Opera 11.6)
      search.lastIndex = origLastIndex;
    }
  }

  return result;
};
/**
 * Fixes browser bugs in the native `String.prototype.split`. Use via `XRegExp.split`.
 *
 * @memberOf String
 * @param {RegExp|String} separator Regex or string to use for separating the string.
 * @param {Number} [limit] Maximum number of items to include in the result array.
 * @returns {!Array} Array of substrings.
 */


fixed.split = function (separator, limit) {
  if (!XRegExp.isRegExp(separator)) {
    // Browsers handle nonregex split correctly, so use the faster native method
    return String.prototype.split.apply(this, arguments);
  }

  var str = String(this);
  var output = [];
  var origLastIndex = separator.lastIndex;
  var lastLastIndex = 0;
  var lastLength; // Values for `limit`, per the spec:
  // If undefined: pow(2,32) - 1
  // If 0, Infinity, or NaN: 0
  // If positive number: limit = floor(limit); if (limit >= pow(2,32)) limit -= pow(2,32);
  // If negative number: pow(2,32) - floor(abs(limit))
  // If other: Type-convert, then use the above rules
  // This line fails in very strange ways for some values of `limit` in Opera 10.5-10.63, unless
  // Opera Dragonfly is open (go figure). It works in at least Opera 9.5-10.1 and 11+

  limit = (limit === undefined ? -1 : limit) >>> 0;
  (0, _forEach["default"])(XRegExp).call(XRegExp, str, separator, function (match) {
    // This condition is not the same as `if (match[0].length)`
    if (match.index + match[0].length > lastLastIndex) {
      output.push((0, _slice["default"])(str).call(str, lastLastIndex, match.index));

      if (match.length > 1 && match.index < str.length) {
        Array.prototype.push.apply(output, (0, _slice["default"])(match).call(match, 1));
      }

      lastLength = match[0].length;
      lastLastIndex = match.index + lastLength;
    }
  });

  if (lastLastIndex === str.length) {
    if (!separator.test('') || lastLength) {
      output.push('');
    }
  } else {
    output.push((0, _slice["default"])(str).call(str, lastLastIndex));
  }

  separator.lastIndex = origLastIndex;
  return output.length > limit ? (0, _slice["default"])(output).call(output, 0, limit) : output;
}; // ==--------------------------==
// Built-in syntax/flag tokens
// ==--------------------------==

/*
 * Letter escapes that natively match literal characters: `\a`, `\A`, etc. These should be
 * SyntaxErrors but are allowed in web reality. XRegExp makes them errors for cross-browser
 * consistency and to reserve their syntax, but lets them be superseded by addons.
 */


XRegExp.addToken(/\\([ABCE-RTUVXYZaeg-mopqyz]|c(?![A-Za-z])|u(?![\dA-Fa-f]{4}|{[\dA-Fa-f]+})|x(?![\dA-Fa-f]{2}))/, function (match, scope) {
  // \B is allowed in default scope only
  if (match[1] === 'B' && scope === defaultScope) {
    return match[0];
  }

  throw new SyntaxError("Invalid escape ".concat(match[0]));
}, {
  scope: 'all',
  leadChar: '\\'
});
/*
 * Unicode code point escape with curly braces: `\u{N..}`. `N..` is any one or more digit
 * hexadecimal number from 0-10FFFF, and can include leading zeros. Requires the native ES6 `u` flag
 * to support code points greater than U+FFFF. Avoids converting code points above U+FFFF to
 * surrogate pairs (which could be done without flag `u`), since that could lead to broken behavior
 * if you follow a `\u{N..}` token that references a code point above U+FFFF with a quantifier, or
 * if you use the same in a character class.
 */

XRegExp.addToken(/\\u{([\dA-Fa-f]+)}/, function (match, scope, flags) {
  var code = dec(match[1]);

  if (code > 0x10FFFF) {
    throw new SyntaxError("Invalid Unicode code point ".concat(match[0]));
  }

  if (code <= 0xFFFF) {
    // Converting to \uNNNN avoids needing to escape the literal character and keep it
    // separate from preceding tokens
    return "\\u".concat(pad4(hex(code)));
  } // If `code` is between 0xFFFF and 0x10FFFF, require and defer to native handling


  if (hasNativeU && (0, _indexOf["default"])(flags).call(flags, 'u') !== -1) {
    return match[0];
  }

  throw new SyntaxError('Cannot use Unicode code point above \\u{FFFF} without flag u');
}, {
  scope: 'all',
  leadChar: '\\'
});
/*
 * Comment pattern: `(?# )`. Inline comments are an alternative to the line comments allowed in
 * free-spacing mode (flag x).
 */

XRegExp.addToken(/\(\?#[^)]*\)/, getContextualTokenSeparator, {
  leadChar: '('
});
/*
 * Whitespace and line comments, in free-spacing mode (aka extended mode, flag x) only.
 */

XRegExp.addToken(/\s+|#[^\n]*\n?/, getContextualTokenSeparator, {
  flag: 'x'
});
/*
 * Dot, in dotAll mode (aka singleline mode, flag s) only.
 */

if (!hasNativeS) {
  XRegExp.addToken(/\./, function () {
    return '[\\s\\S]';
  }, {
    flag: 's',
    leadChar: '.'
  });
}
/*
 * Named backreference: `\k<name>`. Backreference names can use RegExpIdentifierName characters
 * only. Also allows numbered backreferences as `\k<n>`.
 */


XRegExp.addToken(/\\k<([^>]+)>/, function (match) {
  var _context6, _context7;

  // Groups with the same name is an error, else would need `lastIndexOf`
  var index = isNaN(match[1]) ? (0, _indexOf["default"])(_context6 = this.captureNames).call(_context6, match[1]) + 1 : +match[1];
  var endIndex = match.index + match[0].length;

  if (!index || index > this.captureNames.length) {
    throw new SyntaxError("Backreference to undefined group ".concat(match[0]));
  } // Keep backreferences separate from subsequent literal numbers. This avoids e.g.
  // inadvertedly changing `(?<n>)\k<n>1` to `()\11`.


  return (0, _concat["default"])(_context7 = "\\".concat(index)).call(_context7, endIndex === match.input.length || isNaN(match.input[endIndex]) ? '' : '(?:)');
}, {
  leadChar: '\\'
});
/*
 * Numbered backreference or octal, plus any following digits: `\0`, `\11`, etc. Octals except `\0`
 * not followed by 0-9 and backreferences to unopened capture groups throw an error. Other matches
 * are returned unaltered. IE < 9 doesn't support backreferences above `\99` in regex syntax.
 */

XRegExp.addToken(/\\(\d+)/, function (match, scope) {
  if (!(scope === defaultScope && /^[1-9]/.test(match[1]) && +match[1] <= this.captureNames.length) && match[1] !== '0') {
    throw new SyntaxError("Cannot use octal escape or backreference to undefined group ".concat(match[0]));
  }

  return match[0];
}, {
  scope: 'all',
  leadChar: '\\'
});
/*
 * Named capturing group; match the opening delimiter only: `(?<name>`. Capture names can use the
 * RegExpIdentifierName characters only. Names can't be integers. Supports Python-style
 * `(?P<name>` as an alternate syntax to avoid issues in some older versions of Opera which natively
 * supported the Python-style syntax. Otherwise, XRegExp might treat numbered backreferences to
 * Python-style named capture as octals.
 */

XRegExp.addToken(/\(\?P?<((?:[\$A-Z_a-z\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u05D0-\u05EA\u05EF-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u0860-\u086A\u0870-\u0887\u0889-\u088E\u08A0-\u08C9\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u09FC\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0AF9\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58-\u0C5A\u0C5D\u0C60\u0C61\u0C80\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D04-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D54-\u0D56\u0D5F-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u1711\u171F-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1878\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4C\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CE9-\u1CEC\u1CEE-\u1CF3\u1CF5\u1CF6\u1CFA\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303C\u3041-\u3096\u309B-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u31BF\u31F0-\u31FF\u3400-\u4DBF\u4E00-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6EF\uA717-\uA71F\uA722-\uA788\uA78B-\uA7CA\uA7D0\uA7D1\uA7D3\uA7D5-\uA7D9\uA7F2-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA8FD\uA8FE\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uA9E0-\uA9E4\uA9E6-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB69\uAB70-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD40-\uDD74\uDE80-\uDE9C\uDEA0-\uDED0\uDF00-\uDF1F\uDF2D-\uDF4A\uDF50-\uDF75\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD00-\uDD27\uDD30-\uDD63\uDD70-\uDD7A\uDD7C-\uDD8A\uDD8C-\uDD92\uDD94\uDD95\uDD97-\uDDA1\uDDA3-\uDDB1\uDDB3-\uDDB9\uDDBB\uDDBC\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67\uDF80-\uDF85\uDF87-\uDFB0\uDFB2-\uDFBA]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDCE0-\uDCF2\uDCF4\uDCF5\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00\uDE10-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE4\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48\uDC80-\uDCB2\uDCC0-\uDCF2\uDD00-\uDD23\uDE80-\uDEA9\uDEB0\uDEB1\uDF00-\uDF1C\uDF27\uDF30-\uDF45\uDF70-\uDF81\uDFB0-\uDFC4\uDFE0-\uDFF6]|\uD804[\uDC03-\uDC37\uDC71\uDC72\uDC75\uDC83-\uDCAF\uDCD0-\uDCE8\uDD03-\uDD26\uDD44\uDD47\uDD50-\uDD72\uDD76\uDD83-\uDDB2\uDDC1-\uDDC4\uDDDA\uDDDC\uDE00-\uDE11\uDE13-\uDE2B\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEDE\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3D\uDF50\uDF5D-\uDF61]|\uD805[\uDC00-\uDC34\uDC47-\uDC4A\uDC5F-\uDC61\uDC80-\uDCAF\uDCC4\uDCC5\uDCC7\uDD80-\uDDAE\uDDD8-\uDDDB\uDE00-\uDE2F\uDE44\uDE80-\uDEAA\uDEB8\uDF00-\uDF1A\uDF40-\uDF46]|\uD806[\uDC00-\uDC2B\uDCA0-\uDCDF\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD2F\uDD3F\uDD41\uDDA0-\uDDA7\uDDAA-\uDDD0\uDDE1\uDDE3\uDE00\uDE0B-\uDE32\uDE3A\uDE50\uDE5C-\uDE89\uDE9D\uDEB0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC2E\uDC40\uDC72-\uDC8F\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD30\uDD46\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD89\uDD98\uDEE0-\uDEF2\uDFB0]|\uD808[\uDC00-\uDF99]|\uD809[\uDC00-\uDC6E\uDC80-\uDD43]|\uD80B[\uDF90-\uDFF0]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE70-\uDEBE\uDED0-\uDEED\uDF00-\uDF2F\uDF40-\uDF43\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDE40-\uDE7F\uDF00-\uDF4A\uDF50\uDF93-\uDF9F\uDFE0\uDFE1\uDFE3]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD82C[\uDC00-\uDD22\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB]|\uD837[\uDF00-\uDF1E]|\uD838[\uDD00-\uDD2C\uDD37-\uDD3D\uDD4E\uDE90-\uDEAD\uDEC0-\uDEEB]|\uD839[\uDFE0-\uDFE6\uDFE8-\uDFEB\uDFED\uDFEE\uDFF0-\uDFFE]|\uD83A[\uDC00-\uDCC4\uDD00-\uDD43\uDD4B]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF38\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A])(?:[\$0-9A-Z_a-z\xAA\xB5\xB7\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0300-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u0483-\u0487\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u05D0-\u05EA\u05EF-\u05F2\u0610-\u061A\u0620-\u0669\u066E-\u06D3\u06D5-\u06DC\u06DF-\u06E8\u06EA-\u06FC\u06FF\u0710-\u074A\u074D-\u07B1\u07C0-\u07F5\u07FA\u07FD\u0800-\u082D\u0840-\u085B\u0860-\u086A\u0870-\u0887\u0889-\u088E\u0898-\u08E1\u08E3-\u0963\u0966-\u096F\u0971-\u0983\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC-\u09C4\u09C7\u09C8\u09CB-\u09CE\u09D7\u09DC\u09DD\u09DF-\u09E3\u09E6-\u09F1\u09FC\u09FE\u0A01-\u0A03\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A59-\u0A5C\u0A5E\u0A66-\u0A75\u0A81-\u0A83\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AD0\u0AE0-\u0AE3\u0AE6-\u0AEF\u0AF9-\u0AFF\u0B01-\u0B03\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B55-\u0B57\u0B5C\u0B5D\u0B5F-\u0B63\u0B66-\u0B6F\u0B71\u0B82\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD0\u0BD7\u0BE6-\u0BEF\u0C00-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3C-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C58-\u0C5A\u0C5D\u0C60-\u0C63\u0C66-\u0C6F\u0C80-\u0C83\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CDD\u0CDE\u0CE0-\u0CE3\u0CE6-\u0CEF\u0CF1\u0CF2\u0D00-\u0D0C\u0D0E-\u0D10\u0D12-\u0D44\u0D46-\u0D48\u0D4A-\u0D4E\u0D54-\u0D57\u0D5F-\u0D63\u0D66-\u0D6F\u0D7A-\u0D7F\u0D81-\u0D83\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DE6-\u0DEF\u0DF2\u0DF3\u0E01-\u0E3A\u0E40-\u0E4E\u0E50-\u0E59\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECD\u0ED0-\u0ED9\u0EDC-\u0EDF\u0F00\u0F18\u0F19\u0F20-\u0F29\u0F35\u0F37\u0F39\u0F3E-\u0F47\u0F49-\u0F6C\u0F71-\u0F84\u0F86-\u0F97\u0F99-\u0FBC\u0FC6\u1000-\u1049\u1050-\u109D\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u135F\u1369-\u1371\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u1715\u171F-\u1734\u1740-\u1753\u1760-\u176C\u176E-\u1770\u1772\u1773\u1780-\u17D3\u17D7\u17DC\u17DD\u17E0-\u17E9\u180B-\u180D\u180F-\u1819\u1820-\u1878\u1880-\u18AA\u18B0-\u18F5\u1900-\u191E\u1920-\u192B\u1930-\u193B\u1946-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u19D0-\u19DA\u1A00-\u1A1B\u1A20-\u1A5E\u1A60-\u1A7C\u1A7F-\u1A89\u1A90-\u1A99\u1AA7\u1AB0-\u1ABD\u1ABF-\u1ACE\u1B00-\u1B4C\u1B50-\u1B59\u1B6B-\u1B73\u1B80-\u1BF3\u1C00-\u1C37\u1C40-\u1C49\u1C4D-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CD0-\u1CD2\u1CD4-\u1CFA\u1D00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u200C\u200D\u203F\u2040\u2054\u2071\u207F\u2090-\u209C\u20D0-\u20DC\u20E1\u20E5-\u20F0\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2CE4\u2CEB-\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D7F-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2DE0-\u2DFF\u3005-\u3007\u3021-\u302F\u3031-\u3035\u3038-\u303C\u3041-\u3096\u3099-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u31BF\u31F0-\u31FF\u3400-\u4DBF\u4E00-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA62B\uA640-\uA66F\uA674-\uA67D\uA67F-\uA6F1\uA717-\uA71F\uA722-\uA788\uA78B-\uA7CA\uA7D0\uA7D1\uA7D3\uA7D5-\uA7D9\uA7F2-\uA827\uA82C\uA840-\uA873\uA880-\uA8C5\uA8D0-\uA8D9\uA8E0-\uA8F7\uA8FB\uA8FD-\uA92D\uA930-\uA953\uA960-\uA97C\uA980-\uA9C0\uA9CF-\uA9D9\uA9E0-\uA9FE\uAA00-\uAA36\uAA40-\uAA4D\uAA50-\uAA59\uAA60-\uAA76\uAA7A-\uAAC2\uAADB-\uAADD\uAAE0-\uAAEF\uAAF2-\uAAF6\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB69\uAB70-\uABEA\uABEC\uABED\uABF0-\uABF9\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE00-\uFE0F\uFE20-\uFE2F\uFE33\uFE34\uFE4D-\uFE4F\uFE70-\uFE74\uFE76-\uFEFC\uFF10-\uFF19\uFF21-\uFF3A\uFF3F\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD40-\uDD74\uDDFD\uDE80-\uDE9C\uDEA0-\uDED0\uDEE0\uDF00-\uDF1F\uDF2D-\uDF4A\uDF50-\uDF7A\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCA0-\uDCA9\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD00-\uDD27\uDD30-\uDD63\uDD70-\uDD7A\uDD7C-\uDD8A\uDD8C-\uDD92\uDD94\uDD95\uDD97-\uDDA1\uDDA3-\uDDB1\uDDB3-\uDDB9\uDDBB\uDDBC\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67\uDF80-\uDF85\uDF87-\uDFB0\uDFB2-\uDFBA]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDCE0-\uDCF2\uDCF4\uDCF5\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00-\uDE03\uDE05\uDE06\uDE0C-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE38-\uDE3A\uDE3F\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE6\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48\uDC80-\uDCB2\uDCC0-\uDCF2\uDD00-\uDD27\uDD30-\uDD39\uDE80-\uDEA9\uDEAB\uDEAC\uDEB0\uDEB1\uDF00-\uDF1C\uDF27\uDF30-\uDF50\uDF70-\uDF85\uDFB0-\uDFC4\uDFE0-\uDFF6]|\uD804[\uDC00-\uDC46\uDC66-\uDC75\uDC7F-\uDCBA\uDCC2\uDCD0-\uDCE8\uDCF0-\uDCF9\uDD00-\uDD34\uDD36-\uDD3F\uDD44-\uDD47\uDD50-\uDD73\uDD76\uDD80-\uDDC4\uDDC9-\uDDCC\uDDCE-\uDDDA\uDDDC\uDE00-\uDE11\uDE13-\uDE37\uDE3E\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEEA\uDEF0-\uDEF9\uDF00-\uDF03\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3B-\uDF44\uDF47\uDF48\uDF4B-\uDF4D\uDF50\uDF57\uDF5D-\uDF63\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC00-\uDC4A\uDC50-\uDC59\uDC5E-\uDC61\uDC80-\uDCC5\uDCC7\uDCD0-\uDCD9\uDD80-\uDDB5\uDDB8-\uDDC0\uDDD8-\uDDDD\uDE00-\uDE40\uDE44\uDE50-\uDE59\uDE80-\uDEB8\uDEC0-\uDEC9\uDF00-\uDF1A\uDF1D-\uDF2B\uDF30-\uDF39\uDF40-\uDF46]|\uD806[\uDC00-\uDC3A\uDCA0-\uDCE9\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD35\uDD37\uDD38\uDD3B-\uDD43\uDD50-\uDD59\uDDA0-\uDDA7\uDDAA-\uDDD7\uDDDA-\uDDE1\uDDE3\uDDE4\uDE00-\uDE3E\uDE47\uDE50-\uDE99\uDE9D\uDEB0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC36\uDC38-\uDC40\uDC50-\uDC59\uDC72-\uDC8F\uDC92-\uDCA7\uDCA9-\uDCB6\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD36\uDD3A\uDD3C\uDD3D\uDD3F-\uDD47\uDD50-\uDD59\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD8E\uDD90\uDD91\uDD93-\uDD98\uDDA0-\uDDA9\uDEE0-\uDEF6\uDFB0]|\uD808[\uDC00-\uDF99]|\uD809[\uDC00-\uDC6E\uDC80-\uDD43]|\uD80B[\uDF90-\uDFF0]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE60-\uDE69\uDE70-\uDEBE\uDEC0-\uDEC9\uDED0-\uDEED\uDEF0-\uDEF4\uDF00-\uDF36\uDF40-\uDF43\uDF50-\uDF59\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDE40-\uDE7F\uDF00-\uDF4A\uDF4F-\uDF87\uDF8F-\uDF9F\uDFE0\uDFE1\uDFE3\uDFE4\uDFF0\uDFF1]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD82C[\uDC00-\uDD22\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99\uDC9D\uDC9E]|\uD833[\uDF00-\uDF2D\uDF30-\uDF46]|\uD834[\uDD65-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD\uDE42-\uDE44]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB\uDFCE-\uDFFF]|\uD836[\uDE00-\uDE36\uDE3B-\uDE6C\uDE75\uDE84\uDE9B-\uDE9F\uDEA1-\uDEAF]|\uD837[\uDF00-\uDF1E]|\uD838[\uDC00-\uDC06\uDC08-\uDC18\uDC1B-\uDC21\uDC23\uDC24\uDC26-\uDC2A\uDD00-\uDD2C\uDD30-\uDD3D\uDD40-\uDD49\uDD4E\uDE90-\uDEAE\uDEC0-\uDEF9]|\uD839[\uDFE0-\uDFE6\uDFE8-\uDFEB\uDFED\uDFEE\uDFF0-\uDFFE]|\uD83A[\uDC00-\uDCC4\uDCD0-\uDCD6\uDD00-\uDD4B\uDD50-\uDD59]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD83E[\uDFF0-\uDFF9]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF38\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A]|\uDB40[\uDD00-\uDDEF])*)>/, function (match) {
  var _context8;

  if (!XRegExp.isInstalled('namespacing') && (match[1] === 'length' || match[1] === '__proto__')) {
    throw new SyntaxError("Cannot use reserved word as capture name ".concat(match[0]));
  }

  if ((0, _indexOf["default"])(_context8 = this.captureNames).call(_context8, match[1]) !== -1) {
    throw new SyntaxError("Cannot use same name for multiple groups ".concat(match[0]));
  }

  this.captureNames.push(match[1]);
  this.hasNamedCapture = true;
  return '(';
}, {
  leadChar: '('
});
/*
 * Capturing group; match the opening parenthesis only. Required for support of named capturing
 * groups. Also adds named capture only mode (flag n).
 */

XRegExp.addToken(/\((?!\?)/, function (match, scope, flags) {
  if ((0, _indexOf["default"])(flags).call(flags, 'n') !== -1) {
    return '(?:';
  }

  this.captureNames.push(null);
  return '(';
}, {
  optionalFlags: 'n',
  leadChar: '('
});
var _default = XRegExp;
exports["default"] = _default;
module.exports = exports.default;
},{"@babel/runtime-corejs3/core-js-stable/array/from":5,"@babel/runtime-corejs3/core-js-stable/array/is-array":6,"@babel/runtime-corejs3/core-js-stable/instance/concat":7,"@babel/runtime-corejs3/core-js-stable/instance/flags":8,"@babel/runtime-corejs3/core-js-stable/instance/for-each":9,"@babel/runtime-corejs3/core-js-stable/instance/index-of":10,"@babel/runtime-corejs3/core-js-stable/instance/slice":11,"@babel/runtime-corejs3/core-js-stable/instance/sort":12,"@babel/runtime-corejs3/core-js-stable/object/create":13,"@babel/runtime-corejs3/core-js-stable/object/define-property":14,"@babel/runtime-corejs3/core-js-stable/parse-int":15,"@babel/runtime-corejs3/core-js-stable/symbol":16,"@babel/runtime-corejs3/core-js/get-iterator-method":19,"@babel/runtime-corejs3/helpers/interopRequireDefault":24,"@babel/runtime-corejs3/helpers/slicedToArray":27}],5:[function(require,module,exports){
module.exports = require("core-js-pure/stable/array/from");
},{"core-js-pure/stable/array/from":208}],6:[function(require,module,exports){
module.exports = require("core-js-pure/stable/array/is-array");
},{"core-js-pure/stable/array/is-array":209}],7:[function(require,module,exports){
module.exports = require("core-js-pure/stable/instance/concat");
},{"core-js-pure/stable/instance/concat":212}],8:[function(require,module,exports){
module.exports = require("core-js-pure/stable/instance/flags");
},{"core-js-pure/stable/instance/flags":213}],9:[function(require,module,exports){
module.exports = require("core-js-pure/stable/instance/for-each");
},{"core-js-pure/stable/instance/for-each":214}],10:[function(require,module,exports){
module.exports = require("core-js-pure/stable/instance/index-of");
},{"core-js-pure/stable/instance/index-of":215}],11:[function(require,module,exports){
module.exports = require("core-js-pure/stable/instance/slice");
},{"core-js-pure/stable/instance/slice":216}],12:[function(require,module,exports){
module.exports = require("core-js-pure/stable/instance/sort");
},{"core-js-pure/stable/instance/sort":217}],13:[function(require,module,exports){
module.exports = require("core-js-pure/stable/object/create");
},{"core-js-pure/stable/object/create":218}],14:[function(require,module,exports){
module.exports = require("core-js-pure/stable/object/define-property");
},{"core-js-pure/stable/object/define-property":219}],15:[function(require,module,exports){
module.exports = require("core-js-pure/stable/parse-int");
},{"core-js-pure/stable/parse-int":220}],16:[function(require,module,exports){
module.exports = require("core-js-pure/stable/symbol");
},{"core-js-pure/stable/symbol":221}],17:[function(require,module,exports){
module.exports = require("core-js-pure/features/array/from");
},{"core-js-pure/features/array/from":52}],18:[function(require,module,exports){
module.exports = require("core-js-pure/features/array/is-array");
},{"core-js-pure/features/array/is-array":53}],19:[function(require,module,exports){
module.exports = require("core-js-pure/features/get-iterator-method");
},{"core-js-pure/features/get-iterator-method":54}],20:[function(require,module,exports){
module.exports = require("core-js-pure/features/instance/slice");
},{"core-js-pure/features/instance/slice":55}],21:[function(require,module,exports){
module.exports = require("core-js-pure/features/symbol");
},{"core-js-pure/features/symbol":56}],22:[function(require,module,exports){
function _arrayLikeToArray(arr, len) {
  if (len == null || len > arr.length) len = arr.length;

  for (var i = 0, arr2 = new Array(len); i < len; i++) {
    arr2[i] = arr[i];
  }

  return arr2;
}

module.exports = _arrayLikeToArray, module.exports.__esModule = true, module.exports["default"] = module.exports;
},{}],23:[function(require,module,exports){
var _Array$isArray = require("@babel/runtime-corejs3/core-js/array/is-array");

function _arrayWithHoles(arr) {
  if (_Array$isArray(arr)) return arr;
}

module.exports = _arrayWithHoles, module.exports.__esModule = true, module.exports["default"] = module.exports;
},{"@babel/runtime-corejs3/core-js/array/is-array":18}],24:[function(require,module,exports){
function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    "default": obj
  };
}

module.exports = _interopRequireDefault, module.exports.__esModule = true, module.exports["default"] = module.exports;
},{}],25:[function(require,module,exports){
var _Symbol = require("@babel/runtime-corejs3/core-js/symbol");

var _getIteratorMethod = require("@babel/runtime-corejs3/core-js/get-iterator-method");

function _iterableToArrayLimit(arr, i) {
  var _i = arr == null ? null : typeof _Symbol !== "undefined" && _getIteratorMethod(arr) || arr["@@iterator"];

  if (_i == null) return;
  var _arr = [];
  var _n = true;
  var _d = false;

  var _s, _e;

  try {
    for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) {
      _arr.push(_s.value);

      if (i && _arr.length === i) break;
    }
  } catch (err) {
    _d = true;
    _e = err;
  } finally {
    try {
      if (!_n && _i["return"] != null) _i["return"]();
    } finally {
      if (_d) throw _e;
    }
  }

  return _arr;
}

module.exports = _iterableToArrayLimit, module.exports.__esModule = true, module.exports["default"] = module.exports;
},{"@babel/runtime-corejs3/core-js/get-iterator-method":19,"@babel/runtime-corejs3/core-js/symbol":21}],26:[function(require,module,exports){
function _nonIterableRest() {
  throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
}

module.exports = _nonIterableRest, module.exports.__esModule = true, module.exports["default"] = module.exports;
},{}],27:[function(require,module,exports){
var arrayWithHoles = require("./arrayWithHoles.js");

var iterableToArrayLimit = require("./iterableToArrayLimit.js");

var unsupportedIterableToArray = require("./unsupportedIterableToArray.js");

var nonIterableRest = require("./nonIterableRest.js");

function _slicedToArray(arr, i) {
  return arrayWithHoles(arr) || iterableToArrayLimit(arr, i) || unsupportedIterableToArray(arr, i) || nonIterableRest();
}

module.exports = _slicedToArray, module.exports.__esModule = true, module.exports["default"] = module.exports;
},{"./arrayWithHoles.js":23,"./iterableToArrayLimit.js":25,"./nonIterableRest.js":26,"./unsupportedIterableToArray.js":28}],28:[function(require,module,exports){
var _sliceInstanceProperty = require("@babel/runtime-corejs3/core-js/instance/slice");

var _Array$from = require("@babel/runtime-corejs3/core-js/array/from");

var arrayLikeToArray = require("./arrayLikeToArray.js");

function _unsupportedIterableToArray(o, minLen) {
  var _context;

  if (!o) return;
  if (typeof o === "string") return arrayLikeToArray(o, minLen);

  var n = _sliceInstanceProperty(_context = Object.prototype.toString.call(o)).call(_context, 8, -1);

  if (n === "Object" && o.constructor) n = o.constructor.name;
  if (n === "Map" || n === "Set") return _Array$from(o);
  if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return arrayLikeToArray(o, minLen);
}

module.exports = _unsupportedIterableToArray, module.exports.__esModule = true, module.exports["default"] = module.exports;
},{"./arrayLikeToArray.js":22,"@babel/runtime-corejs3/core-js/array/from":17,"@babel/runtime-corejs3/core-js/instance/slice":20}],29:[function(require,module,exports){
var parent = require('../../stable/array/from');

module.exports = parent;

},{"../../stable/array/from":208}],30:[function(require,module,exports){
var parent = require('../../stable/array/is-array');

module.exports = parent;

},{"../../stable/array/is-array":209}],31:[function(require,module,exports){
var parent = require('../stable/get-iterator-method');

module.exports = parent;

},{"../stable/get-iterator-method":211}],32:[function(require,module,exports){
var parent = require('../../stable/instance/slice');

module.exports = parent;

},{"../../stable/instance/slice":216}],33:[function(require,module,exports){
var parent = require('../../stable/symbol');

module.exports = parent;

},{"../../stable/symbol":221}],34:[function(require,module,exports){
require('../../modules/es.string.iterator');
require('../../modules/es.array.from');
var path = require('../../internals/path');

module.exports = path.Array.from;

},{"../../internals/path":142,"../../modules/es.array.from":170,"../../modules/es.string.iterator":184}],35:[function(require,module,exports){
require('../../modules/es.array.is-array');
var path = require('../../internals/path');

module.exports = path.Array.isArray;

},{"../../internals/path":142,"../../modules/es.array.is-array":172}],36:[function(require,module,exports){
require('../../../modules/es.array.concat');
var entryVirtual = require('../../../internals/entry-virtual');

module.exports = entryVirtual('Array').concat;

},{"../../../internals/entry-virtual":91,"../../../modules/es.array.concat":168}],37:[function(require,module,exports){
require('../../../modules/es.array.for-each');
var entryVirtual = require('../../../internals/entry-virtual');

module.exports = entryVirtual('Array').forEach;

},{"../../../internals/entry-virtual":91,"../../../modules/es.array.for-each":169}],38:[function(require,module,exports){
require('../../../modules/es.array.index-of');
var entryVirtual = require('../../../internals/entry-virtual');

module.exports = entryVirtual('Array').indexOf;

},{"../../../internals/entry-virtual":91,"../../../modules/es.array.index-of":171}],39:[function(require,module,exports){
require('../../../modules/es.array.slice');
var entryVirtual = require('../../../internals/entry-virtual');

module.exports = entryVirtual('Array').slice;

},{"../../../internals/entry-virtual":91,"../../../modules/es.array.slice":174}],40:[function(require,module,exports){
require('../../../modules/es.array.sort');
var entryVirtual = require('../../../internals/entry-virtual');

module.exports = entryVirtual('Array').sort;

},{"../../../internals/entry-virtual":91,"../../../modules/es.array.sort":175}],41:[function(require,module,exports){
require('../modules/es.array.iterator');
require('../modules/es.string.iterator');
var getIteratorMethod = require('../internals/get-iterator-method');

module.exports = getIteratorMethod;

},{"../internals/get-iterator-method":101,"../modules/es.array.iterator":173,"../modules/es.string.iterator":184}],42:[function(require,module,exports){
var isPrototypeOf = require('../../internals/object-is-prototype-of');
var method = require('../array/virtual/concat');

var ArrayPrototype = Array.prototype;

module.exports = function (it) {
  var own = it.concat;
  return it === ArrayPrototype || (isPrototypeOf(ArrayPrototype, it) && own === ArrayPrototype.concat) ? method : own;
};

},{"../../internals/object-is-prototype-of":135,"../array/virtual/concat":36}],43:[function(require,module,exports){
var isPrototypeOf = require('../../internals/object-is-prototype-of');
var flags = require('../regexp/flags');

var RegExpPrototype = RegExp.prototype;

module.exports = function (it) {
  return (it === RegExpPrototype || isPrototypeOf(RegExpPrototype, it)) ? flags(it) : it.flags;
};

},{"../../internals/object-is-prototype-of":135,"../regexp/flags":50}],44:[function(require,module,exports){
var isPrototypeOf = require('../../internals/object-is-prototype-of');
var method = require('../array/virtual/index-of');

var ArrayPrototype = Array.prototype;

module.exports = function (it) {
  var own = it.indexOf;
  return it === ArrayPrototype || (isPrototypeOf(ArrayPrototype, it) && own === ArrayPrototype.indexOf) ? method : own;
};

},{"../../internals/object-is-prototype-of":135,"../array/virtual/index-of":38}],45:[function(require,module,exports){
var isPrototypeOf = require('../../internals/object-is-prototype-of');
var method = require('../array/virtual/slice');

var ArrayPrototype = Array.prototype;

module.exports = function (it) {
  var own = it.slice;
  return it === ArrayPrototype || (isPrototypeOf(ArrayPrototype, it) && own === ArrayPrototype.slice) ? method : own;
};

},{"../../internals/object-is-prototype-of":135,"../array/virtual/slice":39}],46:[function(require,module,exports){
var isPrototypeOf = require('../../internals/object-is-prototype-of');
var method = require('../array/virtual/sort');

var ArrayPrototype = Array.prototype;

module.exports = function (it) {
  var own = it.sort;
  return it === ArrayPrototype || (isPrototypeOf(ArrayPrototype, it) && own === ArrayPrototype.sort) ? method : own;
};

},{"../../internals/object-is-prototype-of":135,"../array/virtual/sort":40}],47:[function(require,module,exports){
require('../../modules/es.object.create');
var path = require('../../internals/path');

var Object = path.Object;

module.exports = function create(P, D) {
  return Object.create(P, D);
};

},{"../../internals/path":142,"../../modules/es.object.create":178}],48:[function(require,module,exports){
require('../../modules/es.object.define-property');
var path = require('../../internals/path');

var Object = path.Object;

var defineProperty = module.exports = function defineProperty(it, key, desc) {
  return Object.defineProperty(it, key, desc);
};

if (Object.defineProperty.sham) defineProperty.sham = true;

},{"../../internals/path":142,"../../modules/es.object.define-property":179}],49:[function(require,module,exports){
require('../modules/es.parse-int');
var path = require('../internals/path');

module.exports = path.parseInt;

},{"../internals/path":142,"../modules/es.parse-int":181}],50:[function(require,module,exports){
require('../../modules/es.regexp.flags');
var uncurryThis = require('../../internals/function-uncurry-this');
var regExpFlags = require('../../internals/regexp-flags');

module.exports = uncurryThis(regExpFlags);

},{"../../internals/function-uncurry-this":99,"../../internals/regexp-flags":144,"../../modules/es.regexp.flags":183}],51:[function(require,module,exports){
require('../../modules/es.array.concat');
require('../../modules/es.object.to-string');
require('../../modules/es.symbol');
require('../../modules/es.symbol.async-iterator');
require('../../modules/es.symbol.description');
require('../../modules/es.symbol.has-instance');
require('../../modules/es.symbol.is-concat-spreadable');
require('../../modules/es.symbol.iterator');
require('../../modules/es.symbol.match');
require('../../modules/es.symbol.match-all');
require('../../modules/es.symbol.replace');
require('../../modules/es.symbol.search');
require('../../modules/es.symbol.species');
require('../../modules/es.symbol.split');
require('../../modules/es.symbol.to-primitive');
require('../../modules/es.symbol.to-string-tag');
require('../../modules/es.symbol.unscopables');
require('../../modules/es.json.to-string-tag');
require('../../modules/es.math.to-string-tag');
require('../../modules/es.reflect.to-string-tag');
var path = require('../../internals/path');

module.exports = path.Symbol;

},{"../../internals/path":142,"../../modules/es.array.concat":168,"../../modules/es.json.to-string-tag":176,"../../modules/es.math.to-string-tag":177,"../../modules/es.object.to-string":180,"../../modules/es.reflect.to-string-tag":182,"../../modules/es.symbol":190,"../../modules/es.symbol.async-iterator":185,"../../modules/es.symbol.description":186,"../../modules/es.symbol.has-instance":187,"../../modules/es.symbol.is-concat-spreadable":188,"../../modules/es.symbol.iterator":189,"../../modules/es.symbol.match":192,"../../modules/es.symbol.match-all":191,"../../modules/es.symbol.replace":193,"../../modules/es.symbol.search":194,"../../modules/es.symbol.species":195,"../../modules/es.symbol.split":196,"../../modules/es.symbol.to-primitive":197,"../../modules/es.symbol.to-string-tag":198,"../../modules/es.symbol.unscopables":199}],52:[function(require,module,exports){
var parent = require('../../actual/array/from');

module.exports = parent;

},{"../../actual/array/from":29}],53:[function(require,module,exports){
var parent = require('../../actual/array/is-array');

module.exports = parent;

},{"../../actual/array/is-array":30}],54:[function(require,module,exports){
var parent = require('../actual/get-iterator-method');

module.exports = parent;

},{"../actual/get-iterator-method":31}],55:[function(require,module,exports){
var parent = require('../../actual/instance/slice');

module.exports = parent;

},{"../../actual/instance/slice":32}],56:[function(require,module,exports){
var parent = require('../../actual/symbol');
require('../../modules/esnext.symbol.async-dispose');
require('../../modules/esnext.symbol.dispose');
require('../../modules/esnext.symbol.matcher');
require('../../modules/esnext.symbol.metadata');
require('../../modules/esnext.symbol.observable');
// TODO: Remove from `core-js@4`
require('../../modules/esnext.symbol.pattern-match');
// TODO: Remove from `core-js@4`
require('../../modules/esnext.symbol.replace-all');

module.exports = parent;

},{"../../actual/symbol":33,"../../modules/esnext.symbol.async-dispose":200,"../../modules/esnext.symbol.dispose":201,"../../modules/esnext.symbol.matcher":202,"../../modules/esnext.symbol.metadata":203,"../../modules/esnext.symbol.observable":204,"../../modules/esnext.symbol.pattern-match":205,"../../modules/esnext.symbol.replace-all":206}],57:[function(require,module,exports){
var global = require('../internals/global');
var isCallable = require('../internals/is-callable');
var tryToString = require('../internals/try-to-string');

var TypeError = global.TypeError;

// `Assert: IsCallable(argument) is true`
module.exports = function (argument) {
  if (isCallable(argument)) return argument;
  throw TypeError(tryToString(argument) + ' is not a function');
};

},{"../internals/global":104,"../internals/is-callable":114,"../internals/try-to-string":162}],58:[function(require,module,exports){
var global = require('../internals/global');
var isCallable = require('../internals/is-callable');

var String = global.String;
var TypeError = global.TypeError;

module.exports = function (argument) {
  if (typeof argument == 'object' || isCallable(argument)) return argument;
  throw TypeError("Can't set " + String(argument) + ' as a prototype');
};

},{"../internals/global":104,"../internals/is-callable":114}],59:[function(require,module,exports){
module.exports = function () { /* empty */ };

},{}],60:[function(require,module,exports){
var global = require('../internals/global');
var isObject = require('../internals/is-object');

var String = global.String;
var TypeError = global.TypeError;

// `Assert: Type(argument) is Object`
module.exports = function (argument) {
  if (isObject(argument)) return argument;
  throw TypeError(String(argument) + ' is not an object');
};

},{"../internals/global":104,"../internals/is-object":117}],61:[function(require,module,exports){
'use strict';
var $forEach = require('../internals/array-iteration').forEach;
var arrayMethodIsStrict = require('../internals/array-method-is-strict');

var STRICT_METHOD = arrayMethodIsStrict('forEach');

// `Array.prototype.forEach` method implementation
// https://tc39.es/ecma262/#sec-array.prototype.foreach
module.exports = !STRICT_METHOD ? function forEach(callbackfn /* , thisArg */) {
  return $forEach(this, callbackfn, arguments.length > 1 ? arguments[1] : undefined);
// eslint-disable-next-line es/no-array-prototype-foreach -- safe
} : [].forEach;

},{"../internals/array-iteration":64,"../internals/array-method-is-strict":66}],62:[function(require,module,exports){
'use strict';
var global = require('../internals/global');
var bind = require('../internals/function-bind-context');
var call = require('../internals/function-call');
var toObject = require('../internals/to-object');
var callWithSafeIterationClosing = require('../internals/call-with-safe-iteration-closing');
var isArrayIteratorMethod = require('../internals/is-array-iterator-method');
var isConstructor = require('../internals/is-constructor');
var lengthOfArrayLike = require('../internals/length-of-array-like');
var createProperty = require('../internals/create-property');
var getIterator = require('../internals/get-iterator');
var getIteratorMethod = require('../internals/get-iterator-method');

var Array = global.Array;

// `Array.from` method implementation
// https://tc39.es/ecma262/#sec-array.from
module.exports = function from(arrayLike /* , mapfn = undefined, thisArg = undefined */) {
  var O = toObject(arrayLike);
  var IS_CONSTRUCTOR = isConstructor(this);
  var argumentsLength = arguments.length;
  var mapfn = argumentsLength > 1 ? arguments[1] : undefined;
  var mapping = mapfn !== undefined;
  if (mapping) mapfn = bind(mapfn, argumentsLength > 2 ? arguments[2] : undefined);
  var iteratorMethod = getIteratorMethod(O);
  var index = 0;
  var length, result, step, iterator, next, value;
  // if the target is not iterable or it's an array with the default iterator - use a simple case
  if (iteratorMethod && !(this == Array && isArrayIteratorMethod(iteratorMethod))) {
    iterator = getIterator(O, iteratorMethod);
    next = iterator.next;
    result = IS_CONSTRUCTOR ? new this() : [];
    for (;!(step = call(next, iterator)).done; index++) {
      value = mapping ? callWithSafeIterationClosing(iterator, mapfn, [step.value, index], true) : step.value;
      createProperty(result, index, value);
    }
  } else {
    length = lengthOfArrayLike(O);
    result = IS_CONSTRUCTOR ? new this(length) : Array(length);
    for (;length > index; index++) {
      value = mapping ? mapfn(O[index], index) : O[index];
      createProperty(result, index, value);
    }
  }
  result.length = index;
  return result;
};

},{"../internals/call-with-safe-iteration-closing":72,"../internals/create-property":80,"../internals/function-bind-context":96,"../internals/function-call":97,"../internals/get-iterator":102,"../internals/get-iterator-method":101,"../internals/global":104,"../internals/is-array-iterator-method":112,"../internals/is-constructor":115,"../internals/length-of-array-like":123,"../internals/to-object":157}],63:[function(require,module,exports){
var toIndexedObject = require('../internals/to-indexed-object');
var toAbsoluteIndex = require('../internals/to-absolute-index');
var lengthOfArrayLike = require('../internals/length-of-array-like');

// `Array.prototype.{ indexOf, includes }` methods implementation
var createMethod = function (IS_INCLUDES) {
  return function ($this, el, fromIndex) {
    var O = toIndexedObject($this);
    var length = lengthOfArrayLike(O);
    var index = toAbsoluteIndex(fromIndex, length);
    var value;
    // Array#includes uses SameValueZero equality algorithm
    // eslint-disable-next-line no-self-compare -- NaN check
    if (IS_INCLUDES && el != el) while (length > index) {
      value = O[index++];
      // eslint-disable-next-line no-self-compare -- NaN check
      if (value != value) return true;
    // Array#indexOf ignores holes, Array#includes - not
    } else for (;length > index; index++) {
      if ((IS_INCLUDES || index in O) && O[index] === el) return IS_INCLUDES || index || 0;
    } return !IS_INCLUDES && -1;
  };
};

module.exports = {
  // `Array.prototype.includes` method
  // https://tc39.es/ecma262/#sec-array.prototype.includes
  includes: createMethod(true),
  // `Array.prototype.indexOf` method
  // https://tc39.es/ecma262/#sec-array.prototype.indexof
  indexOf: createMethod(false)
};

},{"../internals/length-of-array-like":123,"../internals/to-absolute-index":153,"../internals/to-indexed-object":154}],64:[function(require,module,exports){
var bind = require('../internals/function-bind-context');
var uncurryThis = require('../internals/function-uncurry-this');
var IndexedObject = require('../internals/indexed-object');
var toObject = require('../internals/to-object');
var lengthOfArrayLike = require('../internals/length-of-array-like');
var arraySpeciesCreate = require('../internals/array-species-create');

var push = uncurryThis([].push);

// `Array.prototype.{ forEach, map, filter, some, every, find, findIndex, filterReject }` methods implementation
var createMethod = function (TYPE) {
  var IS_MAP = TYPE == 1;
  var IS_FILTER = TYPE == 2;
  var IS_SOME = TYPE == 3;
  var IS_EVERY = TYPE == 4;
  var IS_FIND_INDEX = TYPE == 6;
  var IS_FILTER_REJECT = TYPE == 7;
  var NO_HOLES = TYPE == 5 || IS_FIND_INDEX;
  return function ($this, callbackfn, that, specificCreate) {
    var O = toObject($this);
    var self = IndexedObject(O);
    var boundFunction = bind(callbackfn, that);
    var length = lengthOfArrayLike(self);
    var index = 0;
    var create = specificCreate || arraySpeciesCreate;
    var target = IS_MAP ? create($this, length) : IS_FILTER || IS_FILTER_REJECT ? create($this, 0) : undefined;
    var value, result;
    for (;length > index; index++) if (NO_HOLES || index in self) {
      value = self[index];
      result = boundFunction(value, index, O);
      if (TYPE) {
        if (IS_MAP) target[index] = result; // map
        else if (result) switch (TYPE) {
          case 3: return true;              // some
          case 5: return value;             // find
          case 6: return index;             // findIndex
          case 2: push(target, value);      // filter
        } else switch (TYPE) {
          case 4: return false;             // every
          case 7: push(target, value);      // filterReject
        }
      }
    }
    return IS_FIND_INDEX ? -1 : IS_SOME || IS_EVERY ? IS_EVERY : target;
  };
};

module.exports = {
  // `Array.prototype.forEach` method
  // https://tc39.es/ecma262/#sec-array.prototype.foreach
  forEach: createMethod(0),
  // `Array.prototype.map` method
  // https://tc39.es/ecma262/#sec-array.prototype.map
  map: createMethod(1),
  // `Array.prototype.filter` method
  // https://tc39.es/ecma262/#sec-array.prototype.filter
  filter: createMethod(2),
  // `Array.prototype.some` method
  // https://tc39.es/ecma262/#sec-array.prototype.some
  some: createMethod(3),
  // `Array.prototype.every` method
  // https://tc39.es/ecma262/#sec-array.prototype.every
  every: createMethod(4),
  // `Array.prototype.find` method
  // https://tc39.es/ecma262/#sec-array.prototype.find
  find: createMethod(5),
  // `Array.prototype.findIndex` method
  // https://tc39.es/ecma262/#sec-array.prototype.findIndex
  findIndex: createMethod(6),
  // `Array.prototype.filterReject` method
  // https://github.com/tc39/proposal-array-filtering
  filterReject: createMethod(7)
};

},{"../internals/array-species-create":71,"../internals/function-bind-context":96,"../internals/function-uncurry-this":99,"../internals/indexed-object":109,"../internals/length-of-array-like":123,"../internals/to-object":157}],65:[function(require,module,exports){
var fails = require('../internals/fails');
var wellKnownSymbol = require('../internals/well-known-symbol');
var V8_VERSION = require('../internals/engine-v8-version');

var SPECIES = wellKnownSymbol('species');

module.exports = function (METHOD_NAME) {
  // We can't use this feature detection in V8 since it causes
  // deoptimization and serious performance degradation
  // https://github.com/zloirock/core-js/issues/677
  return V8_VERSION >= 51 || !fails(function () {
    var array = [];
    var constructor = array.constructor = {};
    constructor[SPECIES] = function () {
      return { foo: 1 };
    };
    return array[METHOD_NAME](Boolean).foo !== 1;
  });
};

},{"../internals/engine-v8-version":89,"../internals/fails":94,"../internals/well-known-symbol":166}],66:[function(require,module,exports){
'use strict';
var fails = require('../internals/fails');

module.exports = function (METHOD_NAME, argument) {
  var method = [][METHOD_NAME];
  return !!method && fails(function () {
    // eslint-disable-next-line no-useless-call,no-throw-literal -- required for testing
    method.call(null, argument || function () { throw 1; }, 1);
  });
};

},{"../internals/fails":94}],67:[function(require,module,exports){
var global = require('../internals/global');
var toAbsoluteIndex = require('../internals/to-absolute-index');
var lengthOfArrayLike = require('../internals/length-of-array-like');
var createProperty = require('../internals/create-property');

var Array = global.Array;
var max = Math.max;

module.exports = function (O, start, end) {
  var length = lengthOfArrayLike(O);
  var k = toAbsoluteIndex(start, length);
  var fin = toAbsoluteIndex(end === undefined ? length : end, length);
  var result = Array(max(fin - k, 0));
  for (var n = 0; k < fin; k++, n++) createProperty(result, n, O[k]);
  result.length = n;
  return result;
};

},{"../internals/create-property":80,"../internals/global":104,"../internals/length-of-array-like":123,"../internals/to-absolute-index":153}],68:[function(require,module,exports){
var uncurryThis = require('../internals/function-uncurry-this');

module.exports = uncurryThis([].slice);

},{"../internals/function-uncurry-this":99}],69:[function(require,module,exports){
var arraySlice = require('../internals/array-slice-simple');

var floor = Math.floor;

var mergeSort = function (array, comparefn) {
  var length = array.length;
  var middle = floor(length / 2);
  return length < 8 ? insertionSort(array, comparefn) : merge(
    array,
    mergeSort(arraySlice(array, 0, middle), comparefn),
    mergeSort(arraySlice(array, middle), comparefn),
    comparefn
  );
};

var insertionSort = function (array, comparefn) {
  var length = array.length;
  var i = 1;
  var element, j;

  while (i < length) {
    j = i;
    element = array[i];
    while (j && comparefn(array[j - 1], element) > 0) {
      array[j] = array[--j];
    }
    if (j !== i++) array[j] = element;
  } return array;
};

var merge = function (array, left, right, comparefn) {
  var llength = left.length;
  var rlength = right.length;
  var lindex = 0;
  var rindex = 0;

  while (lindex < llength || rindex < rlength) {
    array[lindex + rindex] = (lindex < llength && rindex < rlength)
      ? comparefn(left[lindex], right[rindex]) <= 0 ? left[lindex++] : right[rindex++]
      : lindex < llength ? left[lindex++] : right[rindex++];
  } return array;
};

module.exports = mergeSort;

},{"../internals/array-slice-simple":67}],70:[function(require,module,exports){
var global = require('../internals/global');
var isArray = require('../internals/is-array');
var isConstructor = require('../internals/is-constructor');
var isObject = require('../internals/is-object');
var wellKnownSymbol = require('../internals/well-known-symbol');

var SPECIES = wellKnownSymbol('species');
var Array = global.Array;

// a part of `ArraySpeciesCreate` abstract operation
// https://tc39.es/ecma262/#sec-arrayspeciescreate
module.exports = function (originalArray) {
  var C;
  if (isArray(originalArray)) {
    C = originalArray.constructor;
    // cross-realm fallback
    if (isConstructor(C) && (C === Array || isArray(C.prototype))) C = undefined;
    else if (isObject(C)) {
      C = C[SPECIES];
      if (C === null) C = undefined;
    }
  } return C === undefined ? Array : C;
};

},{"../internals/global":104,"../internals/is-array":113,"../internals/is-constructor":115,"../internals/is-object":117,"../internals/well-known-symbol":166}],71:[function(require,module,exports){
var arraySpeciesConstructor = require('../internals/array-species-constructor');

// `ArraySpeciesCreate` abstract operation
// https://tc39.es/ecma262/#sec-arrayspeciescreate
module.exports = function (originalArray, length) {
  return new (arraySpeciesConstructor(originalArray))(length === 0 ? 0 : length);
};

},{"../internals/array-species-constructor":70}],72:[function(require,module,exports){
var anObject = require('../internals/an-object');
var iteratorClose = require('../internals/iterator-close');

// call something on iterator step with safe closing on error
module.exports = function (iterator, fn, value, ENTRIES) {
  try {
    return ENTRIES ? fn(anObject(value)[0], value[1]) : fn(value);
  } catch (error) {
    iteratorClose(iterator, 'throw', error);
  }
};

},{"../internals/an-object":60,"../internals/iterator-close":120}],73:[function(require,module,exports){
var wellKnownSymbol = require('../internals/well-known-symbol');

var ITERATOR = wellKnownSymbol('iterator');
var SAFE_CLOSING = false;

try {
  var called = 0;
  var iteratorWithReturn = {
    next: function () {
      return { done: !!called++ };
    },
    'return': function () {
      SAFE_CLOSING = true;
    }
  };
  iteratorWithReturn[ITERATOR] = function () {
    return this;
  };
  // eslint-disable-next-line es/no-array-from, no-throw-literal -- required for testing
  Array.from(iteratorWithReturn, function () { throw 2; });
} catch (error) { /* empty */ }

module.exports = function (exec, SKIP_CLOSING) {
  if (!SKIP_CLOSING && !SAFE_CLOSING) return false;
  var ITERATION_SUPPORT = false;
  try {
    var object = {};
    object[ITERATOR] = function () {
      return {
        next: function () {
          return { done: ITERATION_SUPPORT = true };
        }
      };
    };
    exec(object);
  } catch (error) { /* empty */ }
  return ITERATION_SUPPORT;
};

},{"../internals/well-known-symbol":166}],74:[function(require,module,exports){
var uncurryThis = require('../internals/function-uncurry-this');

var toString = uncurryThis({}.toString);
var stringSlice = uncurryThis(''.slice);

module.exports = function (it) {
  return stringSlice(toString(it), 8, -1);
};

},{"../internals/function-uncurry-this":99}],75:[function(require,module,exports){
var global = require('../internals/global');
var TO_STRING_TAG_SUPPORT = require('../internals/to-string-tag-support');
var isCallable = require('../internals/is-callable');
var classofRaw = require('../internals/classof-raw');
var wellKnownSymbol = require('../internals/well-known-symbol');

var TO_STRING_TAG = wellKnownSymbol('toStringTag');
var Object = global.Object;

// ES3 wrong here
var CORRECT_ARGUMENTS = classofRaw(function () { return arguments; }()) == 'Arguments';

// fallback for IE11 Script Access Denied error
var tryGet = function (it, key) {
  try {
    return it[key];
  } catch (error) { /* empty */ }
};

// getting tag from ES6+ `Object.prototype.toString`
module.exports = TO_STRING_TAG_SUPPORT ? classofRaw : function (it) {
  var O, tag, result;
  return it === undefined ? 'Undefined' : it === null ? 'Null'
    // @@toStringTag case
    : typeof (tag = tryGet(O = Object(it), TO_STRING_TAG)) == 'string' ? tag
    // builtinTag case
    : CORRECT_ARGUMENTS ? classofRaw(O)
    // ES3 arguments fallback
    : (result = classofRaw(O)) == 'Object' && isCallable(O.callee) ? 'Arguments' : result;
};

},{"../internals/classof-raw":74,"../internals/global":104,"../internals/is-callable":114,"../internals/to-string-tag-support":160,"../internals/well-known-symbol":166}],76:[function(require,module,exports){
var fails = require('../internals/fails');

module.exports = !fails(function () {
  function F() { /* empty */ }
  F.prototype.constructor = null;
  // eslint-disable-next-line es/no-object-getprototypeof -- required for testing
  return Object.getPrototypeOf(new F()) !== F.prototype;
});

},{"../internals/fails":94}],77:[function(require,module,exports){
'use strict';
var IteratorPrototype = require('../internals/iterators-core').IteratorPrototype;
var create = require('../internals/object-create');
var createPropertyDescriptor = require('../internals/create-property-descriptor');
var setToStringTag = require('../internals/set-to-string-tag');
var Iterators = require('../internals/iterators');

var returnThis = function () { return this; };

module.exports = function (IteratorConstructor, NAME, next, ENUMERABLE_NEXT) {
  var TO_STRING_TAG = NAME + ' Iterator';
  IteratorConstructor.prototype = create(IteratorPrototype, { next: createPropertyDescriptor(+!ENUMERABLE_NEXT, next) });
  setToStringTag(IteratorConstructor, TO_STRING_TAG, false, true);
  Iterators[TO_STRING_TAG] = returnThis;
  return IteratorConstructor;
};

},{"../internals/create-property-descriptor":79,"../internals/iterators":122,"../internals/iterators-core":121,"../internals/object-create":127,"../internals/set-to-string-tag":147}],78:[function(require,module,exports){
var DESCRIPTORS = require('../internals/descriptors');
var definePropertyModule = require('../internals/object-define-property');
var createPropertyDescriptor = require('../internals/create-property-descriptor');

module.exports = DESCRIPTORS ? function (object, key, value) {
  return definePropertyModule.f(object, key, createPropertyDescriptor(1, value));
} : function (object, key, value) {
  object[key] = value;
  return object;
};

},{"../internals/create-property-descriptor":79,"../internals/descriptors":83,"../internals/object-define-property":129}],79:[function(require,module,exports){
module.exports = function (bitmap, value) {
  return {
    enumerable: !(bitmap & 1),
    configurable: !(bitmap & 2),
    writable: !(bitmap & 4),
    value: value
  };
};

},{}],80:[function(require,module,exports){
'use strict';
var toPropertyKey = require('../internals/to-property-key');
var definePropertyModule = require('../internals/object-define-property');
var createPropertyDescriptor = require('../internals/create-property-descriptor');

module.exports = function (object, key, value) {
  var propertyKey = toPropertyKey(key);
  if (propertyKey in object) definePropertyModule.f(object, propertyKey, createPropertyDescriptor(0, value));
  else object[propertyKey] = value;
};

},{"../internals/create-property-descriptor":79,"../internals/object-define-property":129,"../internals/to-property-key":159}],81:[function(require,module,exports){
'use strict';
var $ = require('../internals/export');
var call = require('../internals/function-call');
var IS_PURE = require('../internals/is-pure');
var FunctionName = require('../internals/function-name');
var isCallable = require('../internals/is-callable');
var createIteratorConstructor = require('../internals/create-iterator-constructor');
var getPrototypeOf = require('../internals/object-get-prototype-of');
var setPrototypeOf = require('../internals/object-set-prototype-of');
var setToStringTag = require('../internals/set-to-string-tag');
var createNonEnumerableProperty = require('../internals/create-non-enumerable-property');
var redefine = require('../internals/redefine');
var wellKnownSymbol = require('../internals/well-known-symbol');
var Iterators = require('../internals/iterators');
var IteratorsCore = require('../internals/iterators-core');

var PROPER_FUNCTION_NAME = FunctionName.PROPER;
var CONFIGURABLE_FUNCTION_NAME = FunctionName.CONFIGURABLE;
var IteratorPrototype = IteratorsCore.IteratorPrototype;
var BUGGY_SAFARI_ITERATORS = IteratorsCore.BUGGY_SAFARI_ITERATORS;
var ITERATOR = wellKnownSymbol('iterator');
var KEYS = 'keys';
var VALUES = 'values';
var ENTRIES = 'entries';

var returnThis = function () { return this; };

module.exports = function (Iterable, NAME, IteratorConstructor, next, DEFAULT, IS_SET, FORCED) {
  createIteratorConstructor(IteratorConstructor, NAME, next);

  var getIterationMethod = function (KIND) {
    if (KIND === DEFAULT && defaultIterator) return defaultIterator;
    if (!BUGGY_SAFARI_ITERATORS && KIND in IterablePrototype) return IterablePrototype[KIND];
    switch (KIND) {
      case KEYS: return function keys() { return new IteratorConstructor(this, KIND); };
      case VALUES: return function values() { return new IteratorConstructor(this, KIND); };
      case ENTRIES: return function entries() { return new IteratorConstructor(this, KIND); };
    } return function () { return new IteratorConstructor(this); };
  };

  var TO_STRING_TAG = NAME + ' Iterator';
  var INCORRECT_VALUES_NAME = false;
  var IterablePrototype = Iterable.prototype;
  var nativeIterator = IterablePrototype[ITERATOR]
    || IterablePrototype['@@iterator']
    || DEFAULT && IterablePrototype[DEFAULT];
  var defaultIterator = !BUGGY_SAFARI_ITERATORS && nativeIterator || getIterationMethod(DEFAULT);
  var anyNativeIterator = NAME == 'Array' ? IterablePrototype.entries || nativeIterator : nativeIterator;
  var CurrentIteratorPrototype, methods, KEY;

  // fix native
  if (anyNativeIterator) {
    CurrentIteratorPrototype = getPrototypeOf(anyNativeIterator.call(new Iterable()));
    if (CurrentIteratorPrototype !== Object.prototype && CurrentIteratorPrototype.next) {
      if (!IS_PURE && getPrototypeOf(CurrentIteratorPrototype) !== IteratorPrototype) {
        if (setPrototypeOf) {
          setPrototypeOf(CurrentIteratorPrototype, IteratorPrototype);
        } else if (!isCallable(CurrentIteratorPrototype[ITERATOR])) {
          redefine(CurrentIteratorPrototype, ITERATOR, returnThis);
        }
      }
      // Set @@toStringTag to native iterators
      setToStringTag(CurrentIteratorPrototype, TO_STRING_TAG, true, true);
      if (IS_PURE) Iterators[TO_STRING_TAG] = returnThis;
    }
  }

  // fix Array.prototype.{ values, @@iterator }.name in V8 / FF
  if (PROPER_FUNCTION_NAME && DEFAULT == VALUES && nativeIterator && nativeIterator.name !== VALUES) {
    if (!IS_PURE && CONFIGURABLE_FUNCTION_NAME) {
      createNonEnumerableProperty(IterablePrototype, 'name', VALUES);
    } else {
      INCORRECT_VALUES_NAME = true;
      defaultIterator = function values() { return call(nativeIterator, this); };
    }
  }

  // export additional methods
  if (DEFAULT) {
    methods = {
      values: getIterationMethod(VALUES),
      keys: IS_SET ? defaultIterator : getIterationMethod(KEYS),
      entries: getIterationMethod(ENTRIES)
    };
    if (FORCED) for (KEY in methods) {
      if (BUGGY_SAFARI_ITERATORS || INCORRECT_VALUES_NAME || !(KEY in IterablePrototype)) {
        redefine(IterablePrototype, KEY, methods[KEY]);
      }
    } else $({ target: NAME, proto: true, forced: BUGGY_SAFARI_ITERATORS || INCORRECT_VALUES_NAME }, methods);
  }

  // define iterator
  if ((!IS_PURE || FORCED) && IterablePrototype[ITERATOR] !== defaultIterator) {
    redefine(IterablePrototype, ITERATOR, defaultIterator, { name: DEFAULT });
  }
  Iterators[NAME] = defaultIterator;

  return methods;
};

},{"../internals/create-iterator-constructor":77,"../internals/create-non-enumerable-property":78,"../internals/export":93,"../internals/function-call":97,"../internals/function-name":98,"../internals/is-callable":114,"../internals/is-pure":118,"../internals/iterators":122,"../internals/iterators-core":121,"../internals/object-get-prototype-of":134,"../internals/object-set-prototype-of":139,"../internals/redefine":143,"../internals/set-to-string-tag":147,"../internals/well-known-symbol":166}],82:[function(require,module,exports){
var path = require('../internals/path');
var hasOwn = require('../internals/has-own-property');
var wrappedWellKnownSymbolModule = require('../internals/well-known-symbol-wrapped');
var defineProperty = require('../internals/object-define-property').f;

module.exports = function (NAME) {
  var Symbol = path.Symbol || (path.Symbol = {});
  if (!hasOwn(Symbol, NAME)) defineProperty(Symbol, NAME, {
    value: wrappedWellKnownSymbolModule.f(NAME)
  });
};

},{"../internals/has-own-property":105,"../internals/object-define-property":129,"../internals/path":142,"../internals/well-known-symbol-wrapped":165}],83:[function(require,module,exports){
var fails = require('../internals/fails');

// Detect IE8's incomplete defineProperty implementation
module.exports = !fails(function () {
  // eslint-disable-next-line es/no-object-defineproperty -- required for testing
  return Object.defineProperty({}, 1, { get: function () { return 7; } })[1] != 7;
});

},{"../internals/fails":94}],84:[function(require,module,exports){
var global = require('../internals/global');
var isObject = require('../internals/is-object');

var document = global.document;
// typeof document.createElement is 'object' in old IE
var EXISTS = isObject(document) && isObject(document.createElement);

module.exports = function (it) {
  return EXISTS ? document.createElement(it) : {};
};

},{"../internals/global":104,"../internals/is-object":117}],85:[function(require,module,exports){
// iterable DOM collections
// flag - `iterable` interface - 'entries', 'keys', 'values', 'forEach' methods
module.exports = {
  CSSRuleList: 0,
  CSSStyleDeclaration: 0,
  CSSValueList: 0,
  ClientRectList: 0,
  DOMRectList: 0,
  DOMStringList: 0,
  DOMTokenList: 1,
  DataTransferItemList: 0,
  FileList: 0,
  HTMLAllCollection: 0,
  HTMLCollection: 0,
  HTMLFormElement: 0,
  HTMLSelectElement: 0,
  MediaList: 0,
  MimeTypeArray: 0,
  NamedNodeMap: 0,
  NodeList: 1,
  PaintRequestList: 0,
  Plugin: 0,
  PluginArray: 0,
  SVGLengthList: 0,
  SVGNumberList: 0,
  SVGPathSegList: 0,
  SVGPointList: 0,
  SVGStringList: 0,
  SVGTransformList: 0,
  SourceBufferList: 0,
  StyleSheetList: 0,
  TextTrackCueList: 0,
  TextTrackList: 0,
  TouchList: 0
};

},{}],86:[function(require,module,exports){
var userAgent = require('../internals/engine-user-agent');

var firefox = userAgent.match(/firefox\/(\d+)/i);

module.exports = !!firefox && +firefox[1];

},{"../internals/engine-user-agent":88}],87:[function(require,module,exports){
var UA = require('../internals/engine-user-agent');

module.exports = /MSIE|Trident/.test(UA);

},{"../internals/engine-user-agent":88}],88:[function(require,module,exports){
var getBuiltIn = require('../internals/get-built-in');

module.exports = getBuiltIn('navigator', 'userAgent') || '';

},{"../internals/get-built-in":100}],89:[function(require,module,exports){
var global = require('../internals/global');
var userAgent = require('../internals/engine-user-agent');

var process = global.process;
var Deno = global.Deno;
var versions = process && process.versions || Deno && Deno.version;
var v8 = versions && versions.v8;
var match, version;

if (v8) {
  match = v8.split('.');
  // in old Chrome, versions of V8 isn't V8 = Chrome / 10
  // but their correct versions are not interesting for us
  version = match[0] > 0 && match[0] < 4 ? 1 : +(match[0] + match[1]);
}

// BrowserFS NodeJS `process` polyfill incorrectly set `.v8` to `0.0`
// so check `userAgent` even if `.v8` exists, but 0
if (!version && userAgent) {
  match = userAgent.match(/Edge\/(\d+)/);
  if (!match || match[1] >= 74) {
    match = userAgent.match(/Chrome\/(\d+)/);
    if (match) version = +match[1];
  }
}

module.exports = version;

},{"../internals/engine-user-agent":88,"../internals/global":104}],90:[function(require,module,exports){
var userAgent = require('../internals/engine-user-agent');

var webkit = userAgent.match(/AppleWebKit\/(\d+)\./);

module.exports = !!webkit && +webkit[1];

},{"../internals/engine-user-agent":88}],91:[function(require,module,exports){
var path = require('../internals/path');

module.exports = function (CONSTRUCTOR) {
  return path[CONSTRUCTOR + 'Prototype'];
};

},{"../internals/path":142}],92:[function(require,module,exports){
// IE8- don't enum bug keys
module.exports = [
  'constructor',
  'hasOwnProperty',
  'isPrototypeOf',
  'propertyIsEnumerable',
  'toLocaleString',
  'toString',
  'valueOf'
];

},{}],93:[function(require,module,exports){
'use strict';
var global = require('../internals/global');
var apply = require('../internals/function-apply');
var uncurryThis = require('../internals/function-uncurry-this');
var isCallable = require('../internals/is-callable');
var getOwnPropertyDescriptor = require('../internals/object-get-own-property-descriptor').f;
var isForced = require('../internals/is-forced');
var path = require('../internals/path');
var bind = require('../internals/function-bind-context');
var createNonEnumerableProperty = require('../internals/create-non-enumerable-property');
var hasOwn = require('../internals/has-own-property');

var wrapConstructor = function (NativeConstructor) {
  var Wrapper = function (a, b, c) {
    if (this instanceof Wrapper) {
      switch (arguments.length) {
        case 0: return new NativeConstructor();
        case 1: return new NativeConstructor(a);
        case 2: return new NativeConstructor(a, b);
      } return new NativeConstructor(a, b, c);
    } return apply(NativeConstructor, this, arguments);
  };
  Wrapper.prototype = NativeConstructor.prototype;
  return Wrapper;
};

/*
  options.target      - name of the target object
  options.global      - target is the global object
  options.stat        - export as static methods of target
  options.proto       - export as prototype methods of target
  options.real        - real prototype method for the `pure` version
  options.forced      - export even if the native feature is available
  options.bind        - bind methods to the target, required for the `pure` version
  options.wrap        - wrap constructors to preventing global pollution, required for the `pure` version
  options.unsafe      - use the simple assignment of property instead of delete + defineProperty
  options.sham        - add a flag to not completely full polyfills
  options.enumerable  - export as enumerable property
  options.noTargetGet - prevent calling a getter on target
  options.name        - the .name of the function if it does not match the key
*/
module.exports = function (options, source) {
  var TARGET = options.target;
  var GLOBAL = options.global;
  var STATIC = options.stat;
  var PROTO = options.proto;

  var nativeSource = GLOBAL ? global : STATIC ? global[TARGET] : (global[TARGET] || {}).prototype;

  var target = GLOBAL ? path : path[TARGET] || createNonEnumerableProperty(path, TARGET, {})[TARGET];
  var targetPrototype = target.prototype;

  var FORCED, USE_NATIVE, VIRTUAL_PROTOTYPE;
  var key, sourceProperty, targetProperty, nativeProperty, resultProperty, descriptor;

  for (key in source) {
    FORCED = isForced(GLOBAL ? key : TARGET + (STATIC ? '.' : '#') + key, options.forced);
    // contains in native
    USE_NATIVE = !FORCED && nativeSource && hasOwn(nativeSource, key);

    targetProperty = target[key];

    if (USE_NATIVE) if (options.noTargetGet) {
      descriptor = getOwnPropertyDescriptor(nativeSource, key);
      nativeProperty = descriptor && descriptor.value;
    } else nativeProperty = nativeSource[key];

    // export native or implementation
    sourceProperty = (USE_NATIVE && nativeProperty) ? nativeProperty : source[key];

    if (USE_NATIVE && typeof targetProperty == typeof sourceProperty) continue;

    // bind timers to global for call from export context
    if (options.bind && USE_NATIVE) resultProperty = bind(sourceProperty, global);
    // wrap global constructors for prevent changs in this version
    else if (options.wrap && USE_NATIVE) resultProperty = wrapConstructor(sourceProperty);
    // make static versions for prototype methods
    else if (PROTO && isCallable(sourceProperty)) resultProperty = uncurryThis(sourceProperty);
    // default case
    else resultProperty = sourceProperty;

    // add a flag to not completely full polyfills
    if (options.sham || (sourceProperty && sourceProperty.sham) || (targetProperty && targetProperty.sham)) {
      createNonEnumerableProperty(resultProperty, 'sham', true);
    }

    createNonEnumerableProperty(target, key, resultProperty);

    if (PROTO) {
      VIRTUAL_PROTOTYPE = TARGET + 'Prototype';
      if (!hasOwn(path, VIRTUAL_PROTOTYPE)) {
        createNonEnumerableProperty(path, VIRTUAL_PROTOTYPE, {});
      }
      // export virtual prototype methods
      createNonEnumerableProperty(path[VIRTUAL_PROTOTYPE], key, sourceProperty);
      // export real prototype methods
      if (options.real && targetPrototype && !targetPrototype[key]) {
        createNonEnumerableProperty(targetPrototype, key, sourceProperty);
      }
    }
  }
};

},{"../internals/create-non-enumerable-property":78,"../internals/function-apply":95,"../internals/function-bind-context":96,"../internals/function-uncurry-this":99,"../internals/global":104,"../internals/has-own-property":105,"../internals/is-callable":114,"../internals/is-forced":116,"../internals/object-get-own-property-descriptor":130,"../internals/path":142}],94:[function(require,module,exports){
module.exports = function (exec) {
  try {
    return !!exec();
  } catch (error) {
    return true;
  }
};

},{}],95:[function(require,module,exports){
var FunctionPrototype = Function.prototype;
var apply = FunctionPrototype.apply;
var bind = FunctionPrototype.bind;
var call = FunctionPrototype.call;

// eslint-disable-next-line es/no-reflect -- safe
module.exports = typeof Reflect == 'object' && Reflect.apply || (bind ? call.bind(apply) : function () {
  return call.apply(apply, arguments);
});

},{}],96:[function(require,module,exports){
var uncurryThis = require('../internals/function-uncurry-this');
var aCallable = require('../internals/a-callable');

var bind = uncurryThis(uncurryThis.bind);

// optional / simple context binding
module.exports = function (fn, that) {
  aCallable(fn);
  return that === undefined ? fn : bind ? bind(fn, that) : function (/* ...args */) {
    return fn.apply(that, arguments);
  };
};

},{"../internals/a-callable":57,"../internals/function-uncurry-this":99}],97:[function(require,module,exports){
var call = Function.prototype.call;

module.exports = call.bind ? call.bind(call) : function () {
  return call.apply(call, arguments);
};

},{}],98:[function(require,module,exports){
var DESCRIPTORS = require('../internals/descriptors');
var hasOwn = require('../internals/has-own-property');

var FunctionPrototype = Function.prototype;
// eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe
var getDescriptor = DESCRIPTORS && Object.getOwnPropertyDescriptor;

var EXISTS = hasOwn(FunctionPrototype, 'name');
// additional protection from minified / mangled / dropped function names
var PROPER = EXISTS && (function something() { /* empty */ }).name === 'something';
var CONFIGURABLE = EXISTS && (!DESCRIPTORS || (DESCRIPTORS && getDescriptor(FunctionPrototype, 'name').configurable));

module.exports = {
  EXISTS: EXISTS,
  PROPER: PROPER,
  CONFIGURABLE: CONFIGURABLE
};

},{"../internals/descriptors":83,"../internals/has-own-property":105}],99:[function(require,module,exports){
var FunctionPrototype = Function.prototype;
var bind = FunctionPrototype.bind;
var call = FunctionPrototype.call;
var callBind = bind && bind.bind(call);

module.exports = bind ? function (fn) {
  return fn && callBind(call, fn);
} : function (fn) {
  return fn && function () {
    return call.apply(fn, arguments);
  };
};

},{}],100:[function(require,module,exports){
var path = require('../internals/path');
var global = require('../internals/global');
var isCallable = require('../internals/is-callable');

var aFunction = function (variable) {
  return isCallable(variable) ? variable : undefined;
};

module.exports = function (namespace, method) {
  return arguments.length < 2 ? aFunction(path[namespace]) || aFunction(global[namespace])
    : path[namespace] && path[namespace][method] || global[namespace] && global[namespace][method];
};

},{"../internals/global":104,"../internals/is-callable":114,"../internals/path":142}],101:[function(require,module,exports){
var classof = require('../internals/classof');
var getMethod = require('../internals/get-method');
var Iterators = require('../internals/iterators');
var wellKnownSymbol = require('../internals/well-known-symbol');

var ITERATOR = wellKnownSymbol('iterator');

module.exports = function (it) {
  if (it != undefined) return getMethod(it, ITERATOR)
    || getMethod(it, '@@iterator')
    || Iterators[classof(it)];
};

},{"../internals/classof":75,"../internals/get-method":103,"../internals/iterators":122,"../internals/well-known-symbol":166}],102:[function(require,module,exports){
var global = require('../internals/global');
var call = require('../internals/function-call');
var aCallable = require('../internals/a-callable');
var anObject = require('../internals/an-object');
var tryToString = require('../internals/try-to-string');
var getIteratorMethod = require('../internals/get-iterator-method');

var TypeError = global.TypeError;

module.exports = function (argument, usingIterator) {
  var iteratorMethod = arguments.length < 2 ? getIteratorMethod(argument) : usingIterator;
  if (aCallable(iteratorMethod)) return anObject(call(iteratorMethod, argument));
  throw TypeError(tryToString(argument) + ' is not iterable');
};

},{"../internals/a-callable":57,"../internals/an-object":60,"../internals/function-call":97,"../internals/get-iterator-method":101,"../internals/global":104,"../internals/try-to-string":162}],103:[function(require,module,exports){
var aCallable = require('../internals/a-callable');

// `GetMethod` abstract operation
// https://tc39.es/ecma262/#sec-getmethod
module.exports = function (V, P) {
  var func = V[P];
  return func == null ? undefined : aCallable(func);
};

},{"../internals/a-callable":57}],104:[function(require,module,exports){
(function (global){(function (){
var check = function (it) {
  return it && it.Math == Math && it;
};

// https://github.com/zloirock/core-js/issues/86#issuecomment-115759028
module.exports =
  // eslint-disable-next-line es/no-global-this -- safe
  check(typeof globalThis == 'object' && globalThis) ||
  check(typeof window == 'object' && window) ||
  // eslint-disable-next-line no-restricted-globals -- safe
  check(typeof self == 'object' && self) ||
  check(typeof global == 'object' && global) ||
  // eslint-disable-next-line no-new-func -- fallback
  (function () { return this; })() || Function('return this')();

}).call(this)}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],105:[function(require,module,exports){
var uncurryThis = require('../internals/function-uncurry-this');
var toObject = require('../internals/to-object');

var hasOwnProperty = uncurryThis({}.hasOwnProperty);

// `HasOwnProperty` abstract operation
// https://tc39.es/ecma262/#sec-hasownproperty
module.exports = Object.hasOwn || function hasOwn(it, key) {
  return hasOwnProperty(toObject(it), key);
};

},{"../internals/function-uncurry-this":99,"../internals/to-object":157}],106:[function(require,module,exports){
module.exports = {};

},{}],107:[function(require,module,exports){
var getBuiltIn = require('../internals/get-built-in');

module.exports = getBuiltIn('document', 'documentElement');

},{"../internals/get-built-in":100}],108:[function(require,module,exports){
var DESCRIPTORS = require('../internals/descriptors');
var fails = require('../internals/fails');
var createElement = require('../internals/document-create-element');

// Thank's IE8 for his funny defineProperty
module.exports = !DESCRIPTORS && !fails(function () {
  // eslint-disable-next-line es/no-object-defineproperty -- requied for testing
  return Object.defineProperty(createElement('div'), 'a', {
    get: function () { return 7; }
  }).a != 7;
});

},{"../internals/descriptors":83,"../internals/document-create-element":84,"../internals/fails":94}],109:[function(require,module,exports){
var global = require('../internals/global');
var uncurryThis = require('../internals/function-uncurry-this');
var fails = require('../internals/fails');
var classof = require('../internals/classof-raw');

var Object = global.Object;
var split = uncurryThis(''.split);

// fallback for non-array-like ES3 and non-enumerable old V8 strings
module.exports = fails(function () {
  // throws an error in rhino, see https://github.com/mozilla/rhino/issues/346
  // eslint-disable-next-line no-prototype-builtins -- safe
  return !Object('z').propertyIsEnumerable(0);
}) ? function (it) {
  return classof(it) == 'String' ? split(it, '') : Object(it);
} : Object;

},{"../internals/classof-raw":74,"../internals/fails":94,"../internals/function-uncurry-this":99,"../internals/global":104}],110:[function(require,module,exports){
var uncurryThis = require('../internals/function-uncurry-this');
var isCallable = require('../internals/is-callable');
var store = require('../internals/shared-store');

var functionToString = uncurryThis(Function.toString);

// this helper broken in `core-js@3.4.1-3.4.4`, so we can't use `shared` helper
if (!isCallable(store.inspectSource)) {
  store.inspectSource = function (it) {
    return functionToString(it);
  };
}

module.exports = store.inspectSource;

},{"../internals/function-uncurry-this":99,"../internals/is-callable":114,"../internals/shared-store":149}],111:[function(require,module,exports){
var NATIVE_WEAK_MAP = require('../internals/native-weak-map');
var global = require('../internals/global');
var uncurryThis = require('../internals/function-uncurry-this');
var isObject = require('../internals/is-object');
var createNonEnumerableProperty = require('../internals/create-non-enumerable-property');
var hasOwn = require('../internals/has-own-property');
var shared = require('../internals/shared-store');
var sharedKey = require('../internals/shared-key');
var hiddenKeys = require('../internals/hidden-keys');

var OBJECT_ALREADY_INITIALIZED = 'Object already initialized';
var TypeError = global.TypeError;
var WeakMap = global.WeakMap;
var set, get, has;

var enforce = function (it) {
  return has(it) ? get(it) : set(it, {});
};

var getterFor = function (TYPE) {
  return function (it) {
    var state;
    if (!isObject(it) || (state = get(it)).type !== TYPE) {
      throw TypeError('Incompatible receiver, ' + TYPE + ' required');
    } return state;
  };
};

if (NATIVE_WEAK_MAP || shared.state) {
  var store = shared.state || (shared.state = new WeakMap());
  var wmget = uncurryThis(store.get);
  var wmhas = uncurryThis(store.has);
  var wmset = uncurryThis(store.set);
  set = function (it, metadata) {
    if (wmhas(store, it)) throw new TypeError(OBJECT_ALREADY_INITIALIZED);
    metadata.facade = it;
    wmset(store, it, metadata);
    return metadata;
  };
  get = function (it) {
    return wmget(store, it) || {};
  };
  has = function (it) {
    return wmhas(store, it);
  };
} else {
  var STATE = sharedKey('state');
  hiddenKeys[STATE] = true;
  set = function (it, metadata) {
    if (hasOwn(it, STATE)) throw new TypeError(OBJECT_ALREADY_INITIALIZED);
    metadata.facade = it;
    createNonEnumerableProperty(it, STATE, metadata);
    return metadata;
  };
  get = function (it) {
    return hasOwn(it, STATE) ? it[STATE] : {};
  };
  has = function (it) {
    return hasOwn(it, STATE);
  };
}

module.exports = {
  set: set,
  get: get,
  has: has,
  enforce: enforce,
  getterFor: getterFor
};

},{"../internals/create-non-enumerable-property":78,"../internals/function-uncurry-this":99,"../internals/global":104,"../internals/has-own-property":105,"../internals/hidden-keys":106,"../internals/is-object":117,"../internals/native-weak-map":125,"../internals/shared-key":148,"../internals/shared-store":149}],112:[function(require,module,exports){
var wellKnownSymbol = require('../internals/well-known-symbol');
var Iterators = require('../internals/iterators');

var ITERATOR = wellKnownSymbol('iterator');
var ArrayPrototype = Array.prototype;

// check on default Array iterator
module.exports = function (it) {
  return it !== undefined && (Iterators.Array === it || ArrayPrototype[ITERATOR] === it);
};

},{"../internals/iterators":122,"../internals/well-known-symbol":166}],113:[function(require,module,exports){
var classof = require('../internals/classof-raw');

// `IsArray` abstract operation
// https://tc39.es/ecma262/#sec-isarray
// eslint-disable-next-line es/no-array-isarray -- safe
module.exports = Array.isArray || function isArray(argument) {
  return classof(argument) == 'Array';
};

},{"../internals/classof-raw":74}],114:[function(require,module,exports){
// `IsCallable` abstract operation
// https://tc39.es/ecma262/#sec-iscallable
module.exports = function (argument) {
  return typeof argument == 'function';
};

},{}],115:[function(require,module,exports){
var uncurryThis = require('../internals/function-uncurry-this');
var fails = require('../internals/fails');
var isCallable = require('../internals/is-callable');
var classof = require('../internals/classof');
var getBuiltIn = require('../internals/get-built-in');
var inspectSource = require('../internals/inspect-source');

var noop = function () { /* empty */ };
var empty = [];
var construct = getBuiltIn('Reflect', 'construct');
var constructorRegExp = /^\s*(?:class|function)\b/;
var exec = uncurryThis(constructorRegExp.exec);
var INCORRECT_TO_STRING = !constructorRegExp.exec(noop);

var isConstructorModern = function isConstructor(argument) {
  if (!isCallable(argument)) return false;
  try {
    construct(noop, empty, argument);
    return true;
  } catch (error) {
    return false;
  }
};

var isConstructorLegacy = function isConstructor(argument) {
  if (!isCallable(argument)) return false;
  switch (classof(argument)) {
    case 'AsyncFunction':
    case 'GeneratorFunction':
    case 'AsyncGeneratorFunction': return false;
  }
  try {
    // we can't check .prototype since constructors produced by .bind haven't it
    // `Function#toString` throws on some built-it function in some legacy engines
    // (for example, `DOMQuad` and similar in FF41-)
    return INCORRECT_TO_STRING || !!exec(constructorRegExp, inspectSource(argument));
  } catch (error) {
    return true;
  }
};

isConstructorLegacy.sham = true;

// `IsConstructor` abstract operation
// https://tc39.es/ecma262/#sec-isconstructor
module.exports = !construct || fails(function () {
  var called;
  return isConstructorModern(isConstructorModern.call)
    || !isConstructorModern(Object)
    || !isConstructorModern(function () { called = true; })
    || called;
}) ? isConstructorLegacy : isConstructorModern;

},{"../internals/classof":75,"../internals/fails":94,"../internals/function-uncurry-this":99,"../internals/get-built-in":100,"../internals/inspect-source":110,"../internals/is-callable":114}],116:[function(require,module,exports){
var fails = require('../internals/fails');
var isCallable = require('../internals/is-callable');

var replacement = /#|\.prototype\./;

var isForced = function (feature, detection) {
  var value = data[normalize(feature)];
  return value == POLYFILL ? true
    : value == NATIVE ? false
    : isCallable(detection) ? fails(detection)
    : !!detection;
};

var normalize = isForced.normalize = function (string) {
  return String(string).replace(replacement, '.').toLowerCase();
};

var data = isForced.data = {};
var NATIVE = isForced.NATIVE = 'N';
var POLYFILL = isForced.POLYFILL = 'P';

module.exports = isForced;

},{"../internals/fails":94,"../internals/is-callable":114}],117:[function(require,module,exports){
var isCallable = require('../internals/is-callable');

module.exports = function (it) {
  return typeof it == 'object' ? it !== null : isCallable(it);
};

},{"../internals/is-callable":114}],118:[function(require,module,exports){
module.exports = true;

},{}],119:[function(require,module,exports){
var global = require('../internals/global');
var getBuiltIn = require('../internals/get-built-in');
var isCallable = require('../internals/is-callable');
var isPrototypeOf = require('../internals/object-is-prototype-of');
var USE_SYMBOL_AS_UID = require('../internals/use-symbol-as-uid');

var Object = global.Object;

module.exports = USE_SYMBOL_AS_UID ? function (it) {
  return typeof it == 'symbol';
} : function (it) {
  var $Symbol = getBuiltIn('Symbol');
  return isCallable($Symbol) && isPrototypeOf($Symbol.prototype, Object(it));
};

},{"../internals/get-built-in":100,"../internals/global":104,"../internals/is-callable":114,"../internals/object-is-prototype-of":135,"../internals/use-symbol-as-uid":164}],120:[function(require,module,exports){
var call = require('../internals/function-call');
var anObject = require('../internals/an-object');
var getMethod = require('../internals/get-method');

module.exports = function (iterator, kind, value) {
  var innerResult, innerError;
  anObject(iterator);
  try {
    innerResult = getMethod(iterator, 'return');
    if (!innerResult) {
      if (kind === 'throw') throw value;
      return value;
    }
    innerResult = call(innerResult, iterator);
  } catch (error) {
    innerError = true;
    innerResult = error;
  }
  if (kind === 'throw') throw value;
  if (innerError) throw innerResult;
  anObject(innerResult);
  return value;
};

},{"../internals/an-object":60,"../internals/function-call":97,"../internals/get-method":103}],121:[function(require,module,exports){
'use strict';
var fails = require('../internals/fails');
var isCallable = require('../internals/is-callable');
var create = require('../internals/object-create');
var getPrototypeOf = require('../internals/object-get-prototype-of');
var redefine = require('../internals/redefine');
var wellKnownSymbol = require('../internals/well-known-symbol');
var IS_PURE = require('../internals/is-pure');

var ITERATOR = wellKnownSymbol('iterator');
var BUGGY_SAFARI_ITERATORS = false;

// `%IteratorPrototype%` object
// https://tc39.es/ecma262/#sec-%iteratorprototype%-object
var IteratorPrototype, PrototypeOfArrayIteratorPrototype, arrayIterator;

/* eslint-disable es/no-array-prototype-keys -- safe */
if ([].keys) {
  arrayIterator = [].keys();
  // Safari 8 has buggy iterators w/o `next`
  if (!('next' in arrayIterator)) BUGGY_SAFARI_ITERATORS = true;
  else {
    PrototypeOfArrayIteratorPrototype = getPrototypeOf(getPrototypeOf(arrayIterator));
    if (PrototypeOfArrayIteratorPrototype !== Object.prototype) IteratorPrototype = PrototypeOfArrayIteratorPrototype;
  }
}

var NEW_ITERATOR_PROTOTYPE = IteratorPrototype == undefined || fails(function () {
  var test = {};
  // FF44- legacy iterators case
  return IteratorPrototype[ITERATOR].call(test) !== test;
});

if (NEW_ITERATOR_PROTOTYPE) IteratorPrototype = {};
else if (IS_PURE) IteratorPrototype = create(IteratorPrototype);

// `%IteratorPrototype%[@@iterator]()` method
// https://tc39.es/ecma262/#sec-%iteratorprototype%-@@iterator
if (!isCallable(IteratorPrototype[ITERATOR])) {
  redefine(IteratorPrototype, ITERATOR, function () {
    return this;
  });
}

module.exports = {
  IteratorPrototype: IteratorPrototype,
  BUGGY_SAFARI_ITERATORS: BUGGY_SAFARI_ITERATORS
};

},{"../internals/fails":94,"../internals/is-callable":114,"../internals/is-pure":118,"../internals/object-create":127,"../internals/object-get-prototype-of":134,"../internals/redefine":143,"../internals/well-known-symbol":166}],122:[function(require,module,exports){
arguments[4][106][0].apply(exports,arguments)
},{"dup":106}],123:[function(require,module,exports){
var toLength = require('../internals/to-length');

// `LengthOfArrayLike` abstract operation
// https://tc39.es/ecma262/#sec-lengthofarraylike
module.exports = function (obj) {
  return toLength(obj.length);
};

},{"../internals/to-length":156}],124:[function(require,module,exports){
/* eslint-disable es/no-symbol -- required for testing */
var V8_VERSION = require('../internals/engine-v8-version');
var fails = require('../internals/fails');

// eslint-disable-next-line es/no-object-getownpropertysymbols -- required for testing
module.exports = !!Object.getOwnPropertySymbols && !fails(function () {
  var symbol = Symbol();
  // Chrome 38 Symbol has incorrect toString conversion
  // `get-own-property-symbols` polyfill symbols converted to object are not Symbol instances
  return !String(symbol) || !(Object(symbol) instanceof Symbol) ||
    // Chrome 38-40 symbols are not inherited from DOM collections prototypes to instances
    !Symbol.sham && V8_VERSION && V8_VERSION < 41;
});

},{"../internals/engine-v8-version":89,"../internals/fails":94}],125:[function(require,module,exports){
var global = require('../internals/global');
var isCallable = require('../internals/is-callable');
var inspectSource = require('../internals/inspect-source');

var WeakMap = global.WeakMap;

module.exports = isCallable(WeakMap) && /native code/.test(inspectSource(WeakMap));

},{"../internals/global":104,"../internals/inspect-source":110,"../internals/is-callable":114}],126:[function(require,module,exports){
var global = require('../internals/global');
var fails = require('../internals/fails');
var uncurryThis = require('../internals/function-uncurry-this');
var toString = require('../internals/to-string');
var trim = require('../internals/string-trim').trim;
var whitespaces = require('../internals/whitespaces');

var $parseInt = global.parseInt;
var Symbol = global.Symbol;
var ITERATOR = Symbol && Symbol.iterator;
var hex = /^[+-]?0x/i;
var exec = uncurryThis(hex.exec);
var FORCED = $parseInt(whitespaces + '08') !== 8 || $parseInt(whitespaces + '0x16') !== 22
  // MS Edge 18- broken with boxed symbols
  || (ITERATOR && !fails(function () { $parseInt(Object(ITERATOR)); }));

// `parseInt` method
// https://tc39.es/ecma262/#sec-parseint-string-radix
module.exports = FORCED ? function parseInt(string, radix) {
  var S = trim(toString(string));
  return $parseInt(S, (radix >>> 0) || (exec(hex, S) ? 16 : 10));
} : $parseInt;

},{"../internals/fails":94,"../internals/function-uncurry-this":99,"../internals/global":104,"../internals/string-trim":152,"../internals/to-string":161,"../internals/whitespaces":167}],127:[function(require,module,exports){
/* global ActiveXObject -- old IE, WSH */
var anObject = require('../internals/an-object');
var defineProperties = require('../internals/object-define-properties');
var enumBugKeys = require('../internals/enum-bug-keys');
var hiddenKeys = require('../internals/hidden-keys');
var html = require('../internals/html');
var documentCreateElement = require('../internals/document-create-element');
var sharedKey = require('../internals/shared-key');

var GT = '>';
var LT = '<';
var PROTOTYPE = 'prototype';
var SCRIPT = 'script';
var IE_PROTO = sharedKey('IE_PROTO');

var EmptyConstructor = function () { /* empty */ };

var scriptTag = function (content) {
  return LT + SCRIPT + GT + content + LT + '/' + SCRIPT + GT;
};

// Create object with fake `null` prototype: use ActiveX Object with cleared prototype
var NullProtoObjectViaActiveX = function (activeXDocument) {
  activeXDocument.write(scriptTag(''));
  activeXDocument.close();
  var temp = activeXDocument.parentWindow.Object;
  activeXDocument = null; // avoid memory leak
  return temp;
};

// Create object with fake `null` prototype: use iframe Object with cleared prototype
var NullProtoObjectViaIFrame = function () {
  // Thrash, waste and sodomy: IE GC bug
  var iframe = documentCreateElement('iframe');
  var JS = 'java' + SCRIPT + ':';
  var iframeDocument;
  iframe.style.display = 'none';
  html.appendChild(iframe);
  // https://github.com/zloirock/core-js/issues/475
  iframe.src = String(JS);
  iframeDocument = iframe.contentWindow.document;
  iframeDocument.open();
  iframeDocument.write(scriptTag('document.F=Object'));
  iframeDocument.close();
  return iframeDocument.F;
};

// Check for document.domain and active x support
// No need to use active x approach when document.domain is not set
// see https://github.com/es-shims/es5-shim/issues/150
// variation of https://github.com/kitcambridge/es5-shim/commit/4f738ac066346
// avoid IE GC bug
var activeXDocument;
var NullProtoObject = function () {
  try {
    activeXDocument = new ActiveXObject('htmlfile');
  } catch (error) { /* ignore */ }
  NullProtoObject = typeof document != 'undefined'
    ? document.domain && activeXDocument
      ? NullProtoObjectViaActiveX(activeXDocument) // old IE
      : NullProtoObjectViaIFrame()
    : NullProtoObjectViaActiveX(activeXDocument); // WSH
  var length = enumBugKeys.length;
  while (length--) delete NullProtoObject[PROTOTYPE][enumBugKeys[length]];
  return NullProtoObject();
};

hiddenKeys[IE_PROTO] = true;

// `Object.create` method
// https://tc39.es/ecma262/#sec-object.create
module.exports = Object.create || function create(O, Properties) {
  var result;
  if (O !== null) {
    EmptyConstructor[PROTOTYPE] = anObject(O);
    result = new EmptyConstructor();
    EmptyConstructor[PROTOTYPE] = null;
    // add "__proto__" for Object.getPrototypeOf polyfill
    result[IE_PROTO] = O;
  } else result = NullProtoObject();
  return Properties === undefined ? result : defineProperties(result, Properties);
};

},{"../internals/an-object":60,"../internals/document-create-element":84,"../internals/enum-bug-keys":92,"../internals/hidden-keys":106,"../internals/html":107,"../internals/object-define-properties":128,"../internals/shared-key":148}],128:[function(require,module,exports){
var DESCRIPTORS = require('../internals/descriptors');
var definePropertyModule = require('../internals/object-define-property');
var anObject = require('../internals/an-object');
var toIndexedObject = require('../internals/to-indexed-object');
var objectKeys = require('../internals/object-keys');

// `Object.defineProperties` method
// https://tc39.es/ecma262/#sec-object.defineproperties
// eslint-disable-next-line es/no-object-defineproperties -- safe
module.exports = DESCRIPTORS ? Object.defineProperties : function defineProperties(O, Properties) {
  anObject(O);
  var props = toIndexedObject(Properties);
  var keys = objectKeys(Properties);
  var length = keys.length;
  var index = 0;
  var key;
  while (length > index) definePropertyModule.f(O, key = keys[index++], props[key]);
  return O;
};

},{"../internals/an-object":60,"../internals/descriptors":83,"../internals/object-define-property":129,"../internals/object-keys":137,"../internals/to-indexed-object":154}],129:[function(require,module,exports){
var global = require('../internals/global');
var DESCRIPTORS = require('../internals/descriptors');
var IE8_DOM_DEFINE = require('../internals/ie8-dom-define');
var anObject = require('../internals/an-object');
var toPropertyKey = require('../internals/to-property-key');

var TypeError = global.TypeError;
// eslint-disable-next-line es/no-object-defineproperty -- safe
var $defineProperty = Object.defineProperty;

// `Object.defineProperty` method
// https://tc39.es/ecma262/#sec-object.defineproperty
exports.f = DESCRIPTORS ? $defineProperty : function defineProperty(O, P, Attributes) {
  anObject(O);
  P = toPropertyKey(P);
  anObject(Attributes);
  if (IE8_DOM_DEFINE) try {
    return $defineProperty(O, P, Attributes);
  } catch (error) { /* empty */ }
  if ('get' in Attributes || 'set' in Attributes) throw TypeError('Accessors not supported');
  if ('value' in Attributes) O[P] = Attributes.value;
  return O;
};

},{"../internals/an-object":60,"../internals/descriptors":83,"../internals/global":104,"../internals/ie8-dom-define":108,"../internals/to-property-key":159}],130:[function(require,module,exports){
var DESCRIPTORS = require('../internals/descriptors');
var call = require('../internals/function-call');
var propertyIsEnumerableModule = require('../internals/object-property-is-enumerable');
var createPropertyDescriptor = require('../internals/create-property-descriptor');
var toIndexedObject = require('../internals/to-indexed-object');
var toPropertyKey = require('../internals/to-property-key');
var hasOwn = require('../internals/has-own-property');
var IE8_DOM_DEFINE = require('../internals/ie8-dom-define');

// eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe
var $getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;

// `Object.getOwnPropertyDescriptor` method
// https://tc39.es/ecma262/#sec-object.getownpropertydescriptor
exports.f = DESCRIPTORS ? $getOwnPropertyDescriptor : function getOwnPropertyDescriptor(O, P) {
  O = toIndexedObject(O);
  P = toPropertyKey(P);
  if (IE8_DOM_DEFINE) try {
    return $getOwnPropertyDescriptor(O, P);
  } catch (error) { /* empty */ }
  if (hasOwn(O, P)) return createPropertyDescriptor(!call(propertyIsEnumerableModule.f, O, P), O[P]);
};

},{"../internals/create-property-descriptor":79,"../internals/descriptors":83,"../internals/function-call":97,"../internals/has-own-property":105,"../internals/ie8-dom-define":108,"../internals/object-property-is-enumerable":138,"../internals/to-indexed-object":154,"../internals/to-property-key":159}],131:[function(require,module,exports){
/* eslint-disable es/no-object-getownpropertynames -- safe */
var classof = require('../internals/classof-raw');
var toIndexedObject = require('../internals/to-indexed-object');
var $getOwnPropertyNames = require('../internals/object-get-own-property-names').f;
var arraySlice = require('../internals/array-slice-simple');

var windowNames = typeof window == 'object' && window && Object.getOwnPropertyNames
  ? Object.getOwnPropertyNames(window) : [];

var getWindowNames = function (it) {
  try {
    return $getOwnPropertyNames(it);
  } catch (error) {
    return arraySlice(windowNames);
  }
};

// fallback for IE11 buggy Object.getOwnPropertyNames with iframe and window
module.exports.f = function getOwnPropertyNames(it) {
  return windowNames && classof(it) == 'Window'
    ? getWindowNames(it)
    : $getOwnPropertyNames(toIndexedObject(it));
};

},{"../internals/array-slice-simple":67,"../internals/classof-raw":74,"../internals/object-get-own-property-names":132,"../internals/to-indexed-object":154}],132:[function(require,module,exports){
var internalObjectKeys = require('../internals/object-keys-internal');
var enumBugKeys = require('../internals/enum-bug-keys');

var hiddenKeys = enumBugKeys.concat('length', 'prototype');

// `Object.getOwnPropertyNames` method
// https://tc39.es/ecma262/#sec-object.getownpropertynames
// eslint-disable-next-line es/no-object-getownpropertynames -- safe
exports.f = Object.getOwnPropertyNames || function getOwnPropertyNames(O) {
  return internalObjectKeys(O, hiddenKeys);
};

},{"../internals/enum-bug-keys":92,"../internals/object-keys-internal":136}],133:[function(require,module,exports){
// eslint-disable-next-line es/no-object-getownpropertysymbols -- safe
exports.f = Object.getOwnPropertySymbols;

},{}],134:[function(require,module,exports){
var global = require('../internals/global');
var hasOwn = require('../internals/has-own-property');
var isCallable = require('../internals/is-callable');
var toObject = require('../internals/to-object');
var sharedKey = require('../internals/shared-key');
var CORRECT_PROTOTYPE_GETTER = require('../internals/correct-prototype-getter');

var IE_PROTO = sharedKey('IE_PROTO');
var Object = global.Object;
var ObjectPrototype = Object.prototype;

// `Object.getPrototypeOf` method
// https://tc39.es/ecma262/#sec-object.getprototypeof
module.exports = CORRECT_PROTOTYPE_GETTER ? Object.getPrototypeOf : function (O) {
  var object = toObject(O);
  if (hasOwn(object, IE_PROTO)) return object[IE_PROTO];
  var constructor = object.constructor;
  if (isCallable(constructor) && object instanceof constructor) {
    return constructor.prototype;
  } return object instanceof Object ? ObjectPrototype : null;
};

},{"../internals/correct-prototype-getter":76,"../internals/global":104,"../internals/has-own-property":105,"../internals/is-callable":114,"../internals/shared-key":148,"../internals/to-object":157}],135:[function(require,module,exports){
var uncurryThis = require('../internals/function-uncurry-this');

module.exports = uncurryThis({}.isPrototypeOf);

},{"../internals/function-uncurry-this":99}],136:[function(require,module,exports){
var uncurryThis = require('../internals/function-uncurry-this');
var hasOwn = require('../internals/has-own-property');
var toIndexedObject = require('../internals/to-indexed-object');
var indexOf = require('../internals/array-includes').indexOf;
var hiddenKeys = require('../internals/hidden-keys');

var push = uncurryThis([].push);

module.exports = function (object, names) {
  var O = toIndexedObject(object);
  var i = 0;
  var result = [];
  var key;
  for (key in O) !hasOwn(hiddenKeys, key) && hasOwn(O, key) && push(result, key);
  // Don't enum bug & hidden keys
  while (names.length > i) if (hasOwn(O, key = names[i++])) {
    ~indexOf(result, key) || push(result, key);
  }
  return result;
};

},{"../internals/array-includes":63,"../internals/function-uncurry-this":99,"../internals/has-own-property":105,"../internals/hidden-keys":106,"../internals/to-indexed-object":154}],137:[function(require,module,exports){
var internalObjectKeys = require('../internals/object-keys-internal');
var enumBugKeys = require('../internals/enum-bug-keys');

// `Object.keys` method
// https://tc39.es/ecma262/#sec-object.keys
// eslint-disable-next-line es/no-object-keys -- safe
module.exports = Object.keys || function keys(O) {
  return internalObjectKeys(O, enumBugKeys);
};

},{"../internals/enum-bug-keys":92,"../internals/object-keys-internal":136}],138:[function(require,module,exports){
'use strict';
var $propertyIsEnumerable = {}.propertyIsEnumerable;
// eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe
var getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;

// Nashorn ~ JDK8 bug
var NASHORN_BUG = getOwnPropertyDescriptor && !$propertyIsEnumerable.call({ 1: 2 }, 1);

// `Object.prototype.propertyIsEnumerable` method implementation
// https://tc39.es/ecma262/#sec-object.prototype.propertyisenumerable
exports.f = NASHORN_BUG ? function propertyIsEnumerable(V) {
  var descriptor = getOwnPropertyDescriptor(this, V);
  return !!descriptor && descriptor.enumerable;
} : $propertyIsEnumerable;

},{}],139:[function(require,module,exports){
/* eslint-disable no-proto -- safe */
var uncurryThis = require('../internals/function-uncurry-this');
var anObject = require('../internals/an-object');
var aPossiblePrototype = require('../internals/a-possible-prototype');

// `Object.setPrototypeOf` method
// https://tc39.es/ecma262/#sec-object.setprototypeof
// Works with __proto__ only. Old v8 can't work with null proto objects.
// eslint-disable-next-line es/no-object-setprototypeof -- safe
module.exports = Object.setPrototypeOf || ('__proto__' in {} ? function () {
  var CORRECT_SETTER = false;
  var test = {};
  var setter;
  try {
    // eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe
    setter = uncurryThis(Object.getOwnPropertyDescriptor(Object.prototype, '__proto__').set);
    setter(test, []);
    CORRECT_SETTER = test instanceof Array;
  } catch (error) { /* empty */ }
  return function setPrototypeOf(O, proto) {
    anObject(O);
    aPossiblePrototype(proto);
    if (CORRECT_SETTER) setter(O, proto);
    else O.__proto__ = proto;
    return O;
  };
}() : undefined);

},{"../internals/a-possible-prototype":58,"../internals/an-object":60,"../internals/function-uncurry-this":99}],140:[function(require,module,exports){
'use strict';
var TO_STRING_TAG_SUPPORT = require('../internals/to-string-tag-support');
var classof = require('../internals/classof');

// `Object.prototype.toString` method implementation
// https://tc39.es/ecma262/#sec-object.prototype.tostring
module.exports = TO_STRING_TAG_SUPPORT ? {}.toString : function toString() {
  return '[object ' + classof(this) + ']';
};

},{"../internals/classof":75,"../internals/to-string-tag-support":160}],141:[function(require,module,exports){
var global = require('../internals/global');
var call = require('../internals/function-call');
var isCallable = require('../internals/is-callable');
var isObject = require('../internals/is-object');

var TypeError = global.TypeError;

// `OrdinaryToPrimitive` abstract operation
// https://tc39.es/ecma262/#sec-ordinarytoprimitive
module.exports = function (input, pref) {
  var fn, val;
  if (pref === 'string' && isCallable(fn = input.toString) && !isObject(val = call(fn, input))) return val;
  if (isCallable(fn = input.valueOf) && !isObject(val = call(fn, input))) return val;
  if (pref !== 'string' && isCallable(fn = input.toString) && !isObject(val = call(fn, input))) return val;
  throw TypeError("Can't convert object to primitive value");
};

},{"../internals/function-call":97,"../internals/global":104,"../internals/is-callable":114,"../internals/is-object":117}],142:[function(require,module,exports){
arguments[4][106][0].apply(exports,arguments)
},{"dup":106}],143:[function(require,module,exports){
var createNonEnumerableProperty = require('../internals/create-non-enumerable-property');

module.exports = function (target, key, value, options) {
  if (options && options.enumerable) target[key] = value;
  else createNonEnumerableProperty(target, key, value);
};

},{"../internals/create-non-enumerable-property":78}],144:[function(require,module,exports){
'use strict';
var anObject = require('../internals/an-object');

// `RegExp.prototype.flags` getter implementation
// https://tc39.es/ecma262/#sec-get-regexp.prototype.flags
module.exports = function () {
  var that = anObject(this);
  var result = '';
  if (that.global) result += 'g';
  if (that.ignoreCase) result += 'i';
  if (that.multiline) result += 'm';
  if (that.dotAll) result += 's';
  if (that.unicode) result += 'u';
  if (that.sticky) result += 'y';
  return result;
};

},{"../internals/an-object":60}],145:[function(require,module,exports){
var global = require('../internals/global');

var TypeError = global.TypeError;

// `RequireObjectCoercible` abstract operation
// https://tc39.es/ecma262/#sec-requireobjectcoercible
module.exports = function (it) {
  if (it == undefined) throw TypeError("Can't call method on " + it);
  return it;
};

},{"../internals/global":104}],146:[function(require,module,exports){
var global = require('../internals/global');

// eslint-disable-next-line es/no-object-defineproperty -- safe
var defineProperty = Object.defineProperty;

module.exports = function (key, value) {
  try {
    defineProperty(global, key, { value: value, configurable: true, writable: true });
  } catch (error) {
    global[key] = value;
  } return value;
};

},{"../internals/global":104}],147:[function(require,module,exports){
var TO_STRING_TAG_SUPPORT = require('../internals/to-string-tag-support');
var defineProperty = require('../internals/object-define-property').f;
var createNonEnumerableProperty = require('../internals/create-non-enumerable-property');
var hasOwn = require('../internals/has-own-property');
var toString = require('../internals/object-to-string');
var wellKnownSymbol = require('../internals/well-known-symbol');

var TO_STRING_TAG = wellKnownSymbol('toStringTag');

module.exports = function (it, TAG, STATIC, SET_METHOD) {
  if (it) {
    var target = STATIC ? it : it.prototype;
    if (!hasOwn(target, TO_STRING_TAG)) {
      defineProperty(target, TO_STRING_TAG, { configurable: true, value: TAG });
    }
    if (SET_METHOD && !TO_STRING_TAG_SUPPORT) {
      createNonEnumerableProperty(target, 'toString', toString);
    }
  }
};

},{"../internals/create-non-enumerable-property":78,"../internals/has-own-property":105,"../internals/object-define-property":129,"../internals/object-to-string":140,"../internals/to-string-tag-support":160,"../internals/well-known-symbol":166}],148:[function(require,module,exports){
var shared = require('../internals/shared');
var uid = require('../internals/uid');

var keys = shared('keys');

module.exports = function (key) {
  return keys[key] || (keys[key] = uid(key));
};

},{"../internals/shared":150,"../internals/uid":163}],149:[function(require,module,exports){
var global = require('../internals/global');
var setGlobal = require('../internals/set-global');

var SHARED = '__core-js_shared__';
var store = global[SHARED] || setGlobal(SHARED, {});

module.exports = store;

},{"../internals/global":104,"../internals/set-global":146}],150:[function(require,module,exports){
var IS_PURE = require('../internals/is-pure');
var store = require('../internals/shared-store');

(module.exports = function (key, value) {
  return store[key] || (store[key] = value !== undefined ? value : {});
})('versions', []).push({
  version: '3.20.0',
  mode: IS_PURE ? 'pure' : 'global',
  copyright: '© 2021 Denis Pushkarev (zloirock.ru)'
});

},{"../internals/is-pure":118,"../internals/shared-store":149}],151:[function(require,module,exports){
var uncurryThis = require('../internals/function-uncurry-this');
var toIntegerOrInfinity = require('../internals/to-integer-or-infinity');
var toString = require('../internals/to-string');
var requireObjectCoercible = require('../internals/require-object-coercible');

var charAt = uncurryThis(''.charAt);
var charCodeAt = uncurryThis(''.charCodeAt);
var stringSlice = uncurryThis(''.slice);

var createMethod = function (CONVERT_TO_STRING) {
  return function ($this, pos) {
    var S = toString(requireObjectCoercible($this));
    var position = toIntegerOrInfinity(pos);
    var size = S.length;
    var first, second;
    if (position < 0 || position >= size) return CONVERT_TO_STRING ? '' : undefined;
    first = charCodeAt(S, position);
    return first < 0xD800 || first > 0xDBFF || position + 1 === size
      || (second = charCodeAt(S, position + 1)) < 0xDC00 || second > 0xDFFF
        ? CONVERT_TO_STRING
          ? charAt(S, position)
          : first
        : CONVERT_TO_STRING
          ? stringSlice(S, position, position + 2)
          : (first - 0xD800 << 10) + (second - 0xDC00) + 0x10000;
  };
};

module.exports = {
  // `String.prototype.codePointAt` method
  // https://tc39.es/ecma262/#sec-string.prototype.codepointat
  codeAt: createMethod(false),
  // `String.prototype.at` method
  // https://github.com/mathiasbynens/String.prototype.at
  charAt: createMethod(true)
};

},{"../internals/function-uncurry-this":99,"../internals/require-object-coercible":145,"../internals/to-integer-or-infinity":155,"../internals/to-string":161}],152:[function(require,module,exports){
var uncurryThis = require('../internals/function-uncurry-this');
var requireObjectCoercible = require('../internals/require-object-coercible');
var toString = require('../internals/to-string');
var whitespaces = require('../internals/whitespaces');

var replace = uncurryThis(''.replace);
var whitespace = '[' + whitespaces + ']';
var ltrim = RegExp('^' + whitespace + whitespace + '*');
var rtrim = RegExp(whitespace + whitespace + '*$');

// `String.prototype.{ trim, trimStart, trimEnd, trimLeft, trimRight }` methods implementation
var createMethod = function (TYPE) {
  return function ($this) {
    var string = toString(requireObjectCoercible($this));
    if (TYPE & 1) string = replace(string, ltrim, '');
    if (TYPE & 2) string = replace(string, rtrim, '');
    return string;
  };
};

module.exports = {
  // `String.prototype.{ trimLeft, trimStart }` methods
  // https://tc39.es/ecma262/#sec-string.prototype.trimstart
  start: createMethod(1),
  // `String.prototype.{ trimRight, trimEnd }` methods
  // https://tc39.es/ecma262/#sec-string.prototype.trimend
  end: createMethod(2),
  // `String.prototype.trim` method
  // https://tc39.es/ecma262/#sec-string.prototype.trim
  trim: createMethod(3)
};

},{"../internals/function-uncurry-this":99,"../internals/require-object-coercible":145,"../internals/to-string":161,"../internals/whitespaces":167}],153:[function(require,module,exports){
var toIntegerOrInfinity = require('../internals/to-integer-or-infinity');

var max = Math.max;
var min = Math.min;

// Helper for a popular repeating case of the spec:
// Let integer be ? ToInteger(index).
// If integer < 0, let result be max((length + integer), 0); else let result be min(integer, length).
module.exports = function (index, length) {
  var integer = toIntegerOrInfinity(index);
  return integer < 0 ? max(integer + length, 0) : min(integer, length);
};

},{"../internals/to-integer-or-infinity":155}],154:[function(require,module,exports){
// toObject with fallback for non-array-like ES3 strings
var IndexedObject = require('../internals/indexed-object');
var requireObjectCoercible = require('../internals/require-object-coercible');

module.exports = function (it) {
  return IndexedObject(requireObjectCoercible(it));
};

},{"../internals/indexed-object":109,"../internals/require-object-coercible":145}],155:[function(require,module,exports){
var ceil = Math.ceil;
var floor = Math.floor;

// `ToIntegerOrInfinity` abstract operation
// https://tc39.es/ecma262/#sec-tointegerorinfinity
module.exports = function (argument) {
  var number = +argument;
  // eslint-disable-next-line no-self-compare -- safe
  return number !== number || number === 0 ? 0 : (number > 0 ? floor : ceil)(number);
};

},{}],156:[function(require,module,exports){
var toIntegerOrInfinity = require('../internals/to-integer-or-infinity');

var min = Math.min;

// `ToLength` abstract operation
// https://tc39.es/ecma262/#sec-tolength
module.exports = function (argument) {
  return argument > 0 ? min(toIntegerOrInfinity(argument), 0x1FFFFFFFFFFFFF) : 0; // 2 ** 53 - 1 == 9007199254740991
};

},{"../internals/to-integer-or-infinity":155}],157:[function(require,module,exports){
var global = require('../internals/global');
var requireObjectCoercible = require('../internals/require-object-coercible');

var Object = global.Object;

// `ToObject` abstract operation
// https://tc39.es/ecma262/#sec-toobject
module.exports = function (argument) {
  return Object(requireObjectCoercible(argument));
};

},{"../internals/global":104,"../internals/require-object-coercible":145}],158:[function(require,module,exports){
var global = require('../internals/global');
var call = require('../internals/function-call');
var isObject = require('../internals/is-object');
var isSymbol = require('../internals/is-symbol');
var getMethod = require('../internals/get-method');
var ordinaryToPrimitive = require('../internals/ordinary-to-primitive');
var wellKnownSymbol = require('../internals/well-known-symbol');

var TypeError = global.TypeError;
var TO_PRIMITIVE = wellKnownSymbol('toPrimitive');

// `ToPrimitive` abstract operation
// https://tc39.es/ecma262/#sec-toprimitive
module.exports = function (input, pref) {
  if (!isObject(input) || isSymbol(input)) return input;
  var exoticToPrim = getMethod(input, TO_PRIMITIVE);
  var result;
  if (exoticToPrim) {
    if (pref === undefined) pref = 'default';
    result = call(exoticToPrim, input, pref);
    if (!isObject(result) || isSymbol(result)) return result;
    throw TypeError("Can't convert object to primitive value");
  }
  if (pref === undefined) pref = 'number';
  return ordinaryToPrimitive(input, pref);
};

},{"../internals/function-call":97,"../internals/get-method":103,"../internals/global":104,"../internals/is-object":117,"../internals/is-symbol":119,"../internals/ordinary-to-primitive":141,"../internals/well-known-symbol":166}],159:[function(require,module,exports){
var toPrimitive = require('../internals/to-primitive');
var isSymbol = require('../internals/is-symbol');

// `ToPropertyKey` abstract operation
// https://tc39.es/ecma262/#sec-topropertykey
module.exports = function (argument) {
  var key = toPrimitive(argument, 'string');
  return isSymbol(key) ? key : key + '';
};

},{"../internals/is-symbol":119,"../internals/to-primitive":158}],160:[function(require,module,exports){
var wellKnownSymbol = require('../internals/well-known-symbol');

var TO_STRING_TAG = wellKnownSymbol('toStringTag');
var test = {};

test[TO_STRING_TAG] = 'z';

module.exports = String(test) === '[object z]';

},{"../internals/well-known-symbol":166}],161:[function(require,module,exports){
var global = require('../internals/global');
var classof = require('../internals/classof');

var String = global.String;

module.exports = function (argument) {
  if (classof(argument) === 'Symbol') throw TypeError('Cannot convert a Symbol value to a string');
  return String(argument);
};

},{"../internals/classof":75,"../internals/global":104}],162:[function(require,module,exports){
var global = require('../internals/global');

var String = global.String;

module.exports = function (argument) {
  try {
    return String(argument);
  } catch (error) {
    return 'Object';
  }
};

},{"../internals/global":104}],163:[function(require,module,exports){
var uncurryThis = require('../internals/function-uncurry-this');

var id = 0;
var postfix = Math.random();
var toString = uncurryThis(1.0.toString);

module.exports = function (key) {
  return 'Symbol(' + (key === undefined ? '' : key) + ')_' + toString(++id + postfix, 36);
};

},{"../internals/function-uncurry-this":99}],164:[function(require,module,exports){
/* eslint-disable es/no-symbol -- required for testing */
var NATIVE_SYMBOL = require('../internals/native-symbol');

module.exports = NATIVE_SYMBOL
  && !Symbol.sham
  && typeof Symbol.iterator == 'symbol';

},{"../internals/native-symbol":124}],165:[function(require,module,exports){
var wellKnownSymbol = require('../internals/well-known-symbol');

exports.f = wellKnownSymbol;

},{"../internals/well-known-symbol":166}],166:[function(require,module,exports){
var global = require('../internals/global');
var shared = require('../internals/shared');
var hasOwn = require('../internals/has-own-property');
var uid = require('../internals/uid');
var NATIVE_SYMBOL = require('../internals/native-symbol');
var USE_SYMBOL_AS_UID = require('../internals/use-symbol-as-uid');

var WellKnownSymbolsStore = shared('wks');
var Symbol = global.Symbol;
var symbolFor = Symbol && Symbol['for'];
var createWellKnownSymbol = USE_SYMBOL_AS_UID ? Symbol : Symbol && Symbol.withoutSetter || uid;

module.exports = function (name) {
  if (!hasOwn(WellKnownSymbolsStore, name) || !(NATIVE_SYMBOL || typeof WellKnownSymbolsStore[name] == 'string')) {
    var description = 'Symbol.' + name;
    if (NATIVE_SYMBOL && hasOwn(Symbol, name)) {
      WellKnownSymbolsStore[name] = Symbol[name];
    } else if (USE_SYMBOL_AS_UID && symbolFor) {
      WellKnownSymbolsStore[name] = symbolFor(description);
    } else {
      WellKnownSymbolsStore[name] = createWellKnownSymbol(description);
    }
  } return WellKnownSymbolsStore[name];
};

},{"../internals/global":104,"../internals/has-own-property":105,"../internals/native-symbol":124,"../internals/shared":150,"../internals/uid":163,"../internals/use-symbol-as-uid":164}],167:[function(require,module,exports){
// a string of all valid unicode whitespaces
module.exports = '\u0009\u000A\u000B\u000C\u000D\u0020\u00A0\u1680\u2000\u2001\u2002' +
  '\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF';

},{}],168:[function(require,module,exports){
'use strict';
var $ = require('../internals/export');
var global = require('../internals/global');
var fails = require('../internals/fails');
var isArray = require('../internals/is-array');
var isObject = require('../internals/is-object');
var toObject = require('../internals/to-object');
var lengthOfArrayLike = require('../internals/length-of-array-like');
var createProperty = require('../internals/create-property');
var arraySpeciesCreate = require('../internals/array-species-create');
var arrayMethodHasSpeciesSupport = require('../internals/array-method-has-species-support');
var wellKnownSymbol = require('../internals/well-known-symbol');
var V8_VERSION = require('../internals/engine-v8-version');

var IS_CONCAT_SPREADABLE = wellKnownSymbol('isConcatSpreadable');
var MAX_SAFE_INTEGER = 0x1FFFFFFFFFFFFF;
var MAXIMUM_ALLOWED_INDEX_EXCEEDED = 'Maximum allowed index exceeded';
var TypeError = global.TypeError;

// We can't use this feature detection in V8 since it causes
// deoptimization and serious performance degradation
// https://github.com/zloirock/core-js/issues/679
var IS_CONCAT_SPREADABLE_SUPPORT = V8_VERSION >= 51 || !fails(function () {
  var array = [];
  array[IS_CONCAT_SPREADABLE] = false;
  return array.concat()[0] !== array;
});

var SPECIES_SUPPORT = arrayMethodHasSpeciesSupport('concat');

var isConcatSpreadable = function (O) {
  if (!isObject(O)) return false;
  var spreadable = O[IS_CONCAT_SPREADABLE];
  return spreadable !== undefined ? !!spreadable : isArray(O);
};

var FORCED = !IS_CONCAT_SPREADABLE_SUPPORT || !SPECIES_SUPPORT;

// `Array.prototype.concat` method
// https://tc39.es/ecma262/#sec-array.prototype.concat
// with adding support of @@isConcatSpreadable and @@species
$({ target: 'Array', proto: true, forced: FORCED }, {
  // eslint-disable-next-line no-unused-vars -- required for `.length`
  concat: function concat(arg) {
    var O = toObject(this);
    var A = arraySpeciesCreate(O, 0);
    var n = 0;
    var i, k, length, len, E;
    for (i = -1, length = arguments.length; i < length; i++) {
      E = i === -1 ? O : arguments[i];
      if (isConcatSpreadable(E)) {
        len = lengthOfArrayLike(E);
        if (n + len > MAX_SAFE_INTEGER) throw TypeError(MAXIMUM_ALLOWED_INDEX_EXCEEDED);
        for (k = 0; k < len; k++, n++) if (k in E) createProperty(A, n, E[k]);
      } else {
        if (n >= MAX_SAFE_INTEGER) throw TypeError(MAXIMUM_ALLOWED_INDEX_EXCEEDED);
        createProperty(A, n++, E);
      }
    }
    A.length = n;
    return A;
  }
});

},{"../internals/array-method-has-species-support":65,"../internals/array-species-create":71,"../internals/create-property":80,"../internals/engine-v8-version":89,"../internals/export":93,"../internals/fails":94,"../internals/global":104,"../internals/is-array":113,"../internals/is-object":117,"../internals/length-of-array-like":123,"../internals/to-object":157,"../internals/well-known-symbol":166}],169:[function(require,module,exports){
'use strict';
var $ = require('../internals/export');
var forEach = require('../internals/array-for-each');

// `Array.prototype.forEach` method
// https://tc39.es/ecma262/#sec-array.prototype.foreach
// eslint-disable-next-line es/no-array-prototype-foreach -- safe
$({ target: 'Array', proto: true, forced: [].forEach != forEach }, {
  forEach: forEach
});

},{"../internals/array-for-each":61,"../internals/export":93}],170:[function(require,module,exports){
var $ = require('../internals/export');
var from = require('../internals/array-from');
var checkCorrectnessOfIteration = require('../internals/check-correctness-of-iteration');

var INCORRECT_ITERATION = !checkCorrectnessOfIteration(function (iterable) {
  // eslint-disable-next-line es/no-array-from -- required for testing
  Array.from(iterable);
});

// `Array.from` method
// https://tc39.es/ecma262/#sec-array.from
$({ target: 'Array', stat: true, forced: INCORRECT_ITERATION }, {
  from: from
});

},{"../internals/array-from":62,"../internals/check-correctness-of-iteration":73,"../internals/export":93}],171:[function(require,module,exports){
'use strict';
/* eslint-disable es/no-array-prototype-indexof -- required for testing */
var $ = require('../internals/export');
var uncurryThis = require('../internals/function-uncurry-this');
var $IndexOf = require('../internals/array-includes').indexOf;
var arrayMethodIsStrict = require('../internals/array-method-is-strict');

var un$IndexOf = uncurryThis([].indexOf);

var NEGATIVE_ZERO = !!un$IndexOf && 1 / un$IndexOf([1], 1, -0) < 0;
var STRICT_METHOD = arrayMethodIsStrict('indexOf');

// `Array.prototype.indexOf` method
// https://tc39.es/ecma262/#sec-array.prototype.indexof
$({ target: 'Array', proto: true, forced: NEGATIVE_ZERO || !STRICT_METHOD }, {
  indexOf: function indexOf(searchElement /* , fromIndex = 0 */) {
    var fromIndex = arguments.length > 1 ? arguments[1] : undefined;
    return NEGATIVE_ZERO
      // convert -0 to +0
      ? un$IndexOf(this, searchElement, fromIndex) || 0
      : $IndexOf(this, searchElement, fromIndex);
  }
});

},{"../internals/array-includes":63,"../internals/array-method-is-strict":66,"../internals/export":93,"../internals/function-uncurry-this":99}],172:[function(require,module,exports){
var $ = require('../internals/export');
var isArray = require('../internals/is-array');

// `Array.isArray` method
// https://tc39.es/ecma262/#sec-array.isarray
$({ target: 'Array', stat: true }, {
  isArray: isArray
});

},{"../internals/export":93,"../internals/is-array":113}],173:[function(require,module,exports){
'use strict';
var toIndexedObject = require('../internals/to-indexed-object');
var addToUnscopables = require('../internals/add-to-unscopables');
var Iterators = require('../internals/iterators');
var InternalStateModule = require('../internals/internal-state');
var defineProperty = require('../internals/object-define-property').f;
var defineIterator = require('../internals/define-iterator');
var IS_PURE = require('../internals/is-pure');
var DESCRIPTORS = require('../internals/descriptors');

var ARRAY_ITERATOR = 'Array Iterator';
var setInternalState = InternalStateModule.set;
var getInternalState = InternalStateModule.getterFor(ARRAY_ITERATOR);

// `Array.prototype.entries` method
// https://tc39.es/ecma262/#sec-array.prototype.entries
// `Array.prototype.keys` method
// https://tc39.es/ecma262/#sec-array.prototype.keys
// `Array.prototype.values` method
// https://tc39.es/ecma262/#sec-array.prototype.values
// `Array.prototype[@@iterator]` method
// https://tc39.es/ecma262/#sec-array.prototype-@@iterator
// `CreateArrayIterator` internal method
// https://tc39.es/ecma262/#sec-createarrayiterator
module.exports = defineIterator(Array, 'Array', function (iterated, kind) {
  setInternalState(this, {
    type: ARRAY_ITERATOR,
    target: toIndexedObject(iterated), // target
    index: 0,                          // next index
    kind: kind                         // kind
  });
// `%ArrayIteratorPrototype%.next` method
// https://tc39.es/ecma262/#sec-%arrayiteratorprototype%.next
}, function () {
  var state = getInternalState(this);
  var target = state.target;
  var kind = state.kind;
  var index = state.index++;
  if (!target || index >= target.length) {
    state.target = undefined;
    return { value: undefined, done: true };
  }
  if (kind == 'keys') return { value: index, done: false };
  if (kind == 'values') return { value: target[index], done: false };
  return { value: [index, target[index]], done: false };
}, 'values');

// argumentsList[@@iterator] is %ArrayProto_values%
// https://tc39.es/ecma262/#sec-createunmappedargumentsobject
// https://tc39.es/ecma262/#sec-createmappedargumentsobject
var values = Iterators.Arguments = Iterators.Array;

// https://tc39.es/ecma262/#sec-array.prototype-@@unscopables
addToUnscopables('keys');
addToUnscopables('values');
addToUnscopables('entries');

// V8 ~ Chrome 45- bug
if (!IS_PURE && DESCRIPTORS && values.name !== 'values') try {
  defineProperty(values, 'name', { value: 'values' });
} catch (error) { /* empty */ }

},{"../internals/add-to-unscopables":59,"../internals/define-iterator":81,"../internals/descriptors":83,"../internals/internal-state":111,"../internals/is-pure":118,"../internals/iterators":122,"../internals/object-define-property":129,"../internals/to-indexed-object":154}],174:[function(require,module,exports){
'use strict';
var $ = require('../internals/export');
var global = require('../internals/global');
var isArray = require('../internals/is-array');
var isConstructor = require('../internals/is-constructor');
var isObject = require('../internals/is-object');
var toAbsoluteIndex = require('../internals/to-absolute-index');
var lengthOfArrayLike = require('../internals/length-of-array-like');
var toIndexedObject = require('../internals/to-indexed-object');
var createProperty = require('../internals/create-property');
var wellKnownSymbol = require('../internals/well-known-symbol');
var arrayMethodHasSpeciesSupport = require('../internals/array-method-has-species-support');
var un$Slice = require('../internals/array-slice');

var HAS_SPECIES_SUPPORT = arrayMethodHasSpeciesSupport('slice');

var SPECIES = wellKnownSymbol('species');
var Array = global.Array;
var max = Math.max;

// `Array.prototype.slice` method
// https://tc39.es/ecma262/#sec-array.prototype.slice
// fallback for not array-like ES3 strings and DOM objects
$({ target: 'Array', proto: true, forced: !HAS_SPECIES_SUPPORT }, {
  slice: function slice(start, end) {
    var O = toIndexedObject(this);
    var length = lengthOfArrayLike(O);
    var k = toAbsoluteIndex(start, length);
    var fin = toAbsoluteIndex(end === undefined ? length : end, length);
    // inline `ArraySpeciesCreate` for usage native `Array#slice` where it's possible
    var Constructor, result, n;
    if (isArray(O)) {
      Constructor = O.constructor;
      // cross-realm fallback
      if (isConstructor(Constructor) && (Constructor === Array || isArray(Constructor.prototype))) {
        Constructor = undefined;
      } else if (isObject(Constructor)) {
        Constructor = Constructor[SPECIES];
        if (Constructor === null) Constructor = undefined;
      }
      if (Constructor === Array || Constructor === undefined) {
        return un$Slice(O, k, fin);
      }
    }
    result = new (Constructor === undefined ? Array : Constructor)(max(fin - k, 0));
    for (n = 0; k < fin; k++, n++) if (k in O) createProperty(result, n, O[k]);
    result.length = n;
    return result;
  }
});

},{"../internals/array-method-has-species-support":65,"../internals/array-slice":68,"../internals/create-property":80,"../internals/export":93,"../internals/global":104,"../internals/is-array":113,"../internals/is-constructor":115,"../internals/is-object":117,"../internals/length-of-array-like":123,"../internals/to-absolute-index":153,"../internals/to-indexed-object":154,"../internals/well-known-symbol":166}],175:[function(require,module,exports){
'use strict';
var $ = require('../internals/export');
var uncurryThis = require('../internals/function-uncurry-this');
var aCallable = require('../internals/a-callable');
var toObject = require('../internals/to-object');
var lengthOfArrayLike = require('../internals/length-of-array-like');
var toString = require('../internals/to-string');
var fails = require('../internals/fails');
var internalSort = require('../internals/array-sort');
var arrayMethodIsStrict = require('../internals/array-method-is-strict');
var FF = require('../internals/engine-ff-version');
var IE_OR_EDGE = require('../internals/engine-is-ie-or-edge');
var V8 = require('../internals/engine-v8-version');
var WEBKIT = require('../internals/engine-webkit-version');

var test = [];
var un$Sort = uncurryThis(test.sort);
var push = uncurryThis(test.push);

// IE8-
var FAILS_ON_UNDEFINED = fails(function () {
  test.sort(undefined);
});
// V8 bug
var FAILS_ON_NULL = fails(function () {
  test.sort(null);
});
// Old WebKit
var STRICT_METHOD = arrayMethodIsStrict('sort');

var STABLE_SORT = !fails(function () {
  // feature detection can be too slow, so check engines versions
  if (V8) return V8 < 70;
  if (FF && FF > 3) return;
  if (IE_OR_EDGE) return true;
  if (WEBKIT) return WEBKIT < 603;

  var result = '';
  var code, chr, value, index;

  // generate an array with more 512 elements (Chakra and old V8 fails only in this case)
  for (code = 65; code < 76; code++) {
    chr = String.fromCharCode(code);

    switch (code) {
      case 66: case 69: case 70: case 72: value = 3; break;
      case 68: case 71: value = 4; break;
      default: value = 2;
    }

    for (index = 0; index < 47; index++) {
      test.push({ k: chr + index, v: value });
    }
  }

  test.sort(function (a, b) { return b.v - a.v; });

  for (index = 0; index < test.length; index++) {
    chr = test[index].k.charAt(0);
    if (result.charAt(result.length - 1) !== chr) result += chr;
  }

  return result !== 'DGBEFHACIJK';
});

var FORCED = FAILS_ON_UNDEFINED || !FAILS_ON_NULL || !STRICT_METHOD || !STABLE_SORT;

var getSortCompare = function (comparefn) {
  return function (x, y) {
    if (y === undefined) return -1;
    if (x === undefined) return 1;
    if (comparefn !== undefined) return +comparefn(x, y) || 0;
    return toString(x) > toString(y) ? 1 : -1;
  };
};

// `Array.prototype.sort` method
// https://tc39.es/ecma262/#sec-array.prototype.sort
$({ target: 'Array', proto: true, forced: FORCED }, {
  sort: function sort(comparefn) {
    if (comparefn !== undefined) aCallable(comparefn);

    var array = toObject(this);

    if (STABLE_SORT) return comparefn === undefined ? un$Sort(array) : un$Sort(array, comparefn);

    var items = [];
    var arrayLength = lengthOfArrayLike(array);
    var itemsLength, index;

    for (index = 0; index < arrayLength; index++) {
      if (index in array) push(items, array[index]);
    }

    internalSort(items, getSortCompare(comparefn));

    itemsLength = items.length;
    index = 0;

    while (index < itemsLength) array[index] = items[index++];
    while (index < arrayLength) delete array[index++];

    return array;
  }
});

},{"../internals/a-callable":57,"../internals/array-method-is-strict":66,"../internals/array-sort":69,"../internals/engine-ff-version":86,"../internals/engine-is-ie-or-edge":87,"../internals/engine-v8-version":89,"../internals/engine-webkit-version":90,"../internals/export":93,"../internals/fails":94,"../internals/function-uncurry-this":99,"../internals/length-of-array-like":123,"../internals/to-object":157,"../internals/to-string":161}],176:[function(require,module,exports){
var global = require('../internals/global');
var setToStringTag = require('../internals/set-to-string-tag');

// JSON[@@toStringTag] property
// https://tc39.es/ecma262/#sec-json-@@tostringtag
setToStringTag(global.JSON, 'JSON', true);

},{"../internals/global":104,"../internals/set-to-string-tag":147}],177:[function(require,module,exports){
// empty

},{}],178:[function(require,module,exports){
var $ = require('../internals/export');
var DESCRIPTORS = require('../internals/descriptors');
var create = require('../internals/object-create');

// `Object.create` method
// https://tc39.es/ecma262/#sec-object.create
$({ target: 'Object', stat: true, sham: !DESCRIPTORS }, {
  create: create
});

},{"../internals/descriptors":83,"../internals/export":93,"../internals/object-create":127}],179:[function(require,module,exports){
var $ = require('../internals/export');
var DESCRIPTORS = require('../internals/descriptors');
var objectDefinePropertyModile = require('../internals/object-define-property');

// `Object.defineProperty` method
// https://tc39.es/ecma262/#sec-object.defineproperty
$({ target: 'Object', stat: true, forced: !DESCRIPTORS, sham: !DESCRIPTORS }, {
  defineProperty: objectDefinePropertyModile.f
});

},{"../internals/descriptors":83,"../internals/export":93,"../internals/object-define-property":129}],180:[function(require,module,exports){
arguments[4][177][0].apply(exports,arguments)
},{"dup":177}],181:[function(require,module,exports){
var $ = require('../internals/export');
var $parseInt = require('../internals/number-parse-int');

// `parseInt` method
// https://tc39.es/ecma262/#sec-parseint-string-radix
$({ global: true, forced: parseInt != $parseInt }, {
  parseInt: $parseInt
});

},{"../internals/export":93,"../internals/number-parse-int":126}],182:[function(require,module,exports){
arguments[4][177][0].apply(exports,arguments)
},{"dup":177}],183:[function(require,module,exports){
arguments[4][177][0].apply(exports,arguments)
},{"dup":177}],184:[function(require,module,exports){
'use strict';
var charAt = require('../internals/string-multibyte').charAt;
var toString = require('../internals/to-string');
var InternalStateModule = require('../internals/internal-state');
var defineIterator = require('../internals/define-iterator');

var STRING_ITERATOR = 'String Iterator';
var setInternalState = InternalStateModule.set;
var getInternalState = InternalStateModule.getterFor(STRING_ITERATOR);

// `String.prototype[@@iterator]` method
// https://tc39.es/ecma262/#sec-string.prototype-@@iterator
defineIterator(String, 'String', function (iterated) {
  setInternalState(this, {
    type: STRING_ITERATOR,
    string: toString(iterated),
    index: 0
  });
// `%StringIteratorPrototype%.next` method
// https://tc39.es/ecma262/#sec-%stringiteratorprototype%.next
}, function next() {
  var state = getInternalState(this);
  var string = state.string;
  var index = state.index;
  var point;
  if (index >= string.length) return { value: undefined, done: true };
  point = charAt(string, index);
  state.index += point.length;
  return { value: point, done: false };
});

},{"../internals/define-iterator":81,"../internals/internal-state":111,"../internals/string-multibyte":151,"../internals/to-string":161}],185:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.asyncIterator` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.asynciterator
defineWellKnownSymbol('asyncIterator');

},{"../internals/define-well-known-symbol":82}],186:[function(require,module,exports){
arguments[4][177][0].apply(exports,arguments)
},{"dup":177}],187:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.hasInstance` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.hasinstance
defineWellKnownSymbol('hasInstance');

},{"../internals/define-well-known-symbol":82}],188:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.isConcatSpreadable` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.isconcatspreadable
defineWellKnownSymbol('isConcatSpreadable');

},{"../internals/define-well-known-symbol":82}],189:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.iterator` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.iterator
defineWellKnownSymbol('iterator');

},{"../internals/define-well-known-symbol":82}],190:[function(require,module,exports){
'use strict';
var $ = require('../internals/export');
var global = require('../internals/global');
var getBuiltIn = require('../internals/get-built-in');
var apply = require('../internals/function-apply');
var call = require('../internals/function-call');
var uncurryThis = require('../internals/function-uncurry-this');
var IS_PURE = require('../internals/is-pure');
var DESCRIPTORS = require('../internals/descriptors');
var NATIVE_SYMBOL = require('../internals/native-symbol');
var fails = require('../internals/fails');
var hasOwn = require('../internals/has-own-property');
var isArray = require('../internals/is-array');
var isCallable = require('../internals/is-callable');
var isObject = require('../internals/is-object');
var isPrototypeOf = require('../internals/object-is-prototype-of');
var isSymbol = require('../internals/is-symbol');
var anObject = require('../internals/an-object');
var toObject = require('../internals/to-object');
var toIndexedObject = require('../internals/to-indexed-object');
var toPropertyKey = require('../internals/to-property-key');
var $toString = require('../internals/to-string');
var createPropertyDescriptor = require('../internals/create-property-descriptor');
var nativeObjectCreate = require('../internals/object-create');
var objectKeys = require('../internals/object-keys');
var getOwnPropertyNamesModule = require('../internals/object-get-own-property-names');
var getOwnPropertyNamesExternal = require('../internals/object-get-own-property-names-external');
var getOwnPropertySymbolsModule = require('../internals/object-get-own-property-symbols');
var getOwnPropertyDescriptorModule = require('../internals/object-get-own-property-descriptor');
var definePropertyModule = require('../internals/object-define-property');
var propertyIsEnumerableModule = require('../internals/object-property-is-enumerable');
var arraySlice = require('../internals/array-slice');
var redefine = require('../internals/redefine');
var shared = require('../internals/shared');
var sharedKey = require('../internals/shared-key');
var hiddenKeys = require('../internals/hidden-keys');
var uid = require('../internals/uid');
var wellKnownSymbol = require('../internals/well-known-symbol');
var wrappedWellKnownSymbolModule = require('../internals/well-known-symbol-wrapped');
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');
var setToStringTag = require('../internals/set-to-string-tag');
var InternalStateModule = require('../internals/internal-state');
var $forEach = require('../internals/array-iteration').forEach;

var HIDDEN = sharedKey('hidden');
var SYMBOL = 'Symbol';
var PROTOTYPE = 'prototype';
var TO_PRIMITIVE = wellKnownSymbol('toPrimitive');

var setInternalState = InternalStateModule.set;
var getInternalState = InternalStateModule.getterFor(SYMBOL);

var ObjectPrototype = Object[PROTOTYPE];
var $Symbol = global.Symbol;
var SymbolPrototype = $Symbol && $Symbol[PROTOTYPE];
var TypeError = global.TypeError;
var QObject = global.QObject;
var $stringify = getBuiltIn('JSON', 'stringify');
var nativeGetOwnPropertyDescriptor = getOwnPropertyDescriptorModule.f;
var nativeDefineProperty = definePropertyModule.f;
var nativeGetOwnPropertyNames = getOwnPropertyNamesExternal.f;
var nativePropertyIsEnumerable = propertyIsEnumerableModule.f;
var push = uncurryThis([].push);

var AllSymbols = shared('symbols');
var ObjectPrototypeSymbols = shared('op-symbols');
var StringToSymbolRegistry = shared('string-to-symbol-registry');
var SymbolToStringRegistry = shared('symbol-to-string-registry');
var WellKnownSymbolsStore = shared('wks');

// Don't use setters in Qt Script, https://github.com/zloirock/core-js/issues/173
var USE_SETTER = !QObject || !QObject[PROTOTYPE] || !QObject[PROTOTYPE].findChild;

// fallback for old Android, https://code.google.com/p/v8/issues/detail?id=687
var setSymbolDescriptor = DESCRIPTORS && fails(function () {
  return nativeObjectCreate(nativeDefineProperty({}, 'a', {
    get: function () { return nativeDefineProperty(this, 'a', { value: 7 }).a; }
  })).a != 7;
}) ? function (O, P, Attributes) {
  var ObjectPrototypeDescriptor = nativeGetOwnPropertyDescriptor(ObjectPrototype, P);
  if (ObjectPrototypeDescriptor) delete ObjectPrototype[P];
  nativeDefineProperty(O, P, Attributes);
  if (ObjectPrototypeDescriptor && O !== ObjectPrototype) {
    nativeDefineProperty(ObjectPrototype, P, ObjectPrototypeDescriptor);
  }
} : nativeDefineProperty;

var wrap = function (tag, description) {
  var symbol = AllSymbols[tag] = nativeObjectCreate(SymbolPrototype);
  setInternalState(symbol, {
    type: SYMBOL,
    tag: tag,
    description: description
  });
  if (!DESCRIPTORS) symbol.description = description;
  return symbol;
};

var $defineProperty = function defineProperty(O, P, Attributes) {
  if (O === ObjectPrototype) $defineProperty(ObjectPrototypeSymbols, P, Attributes);
  anObject(O);
  var key = toPropertyKey(P);
  anObject(Attributes);
  if (hasOwn(AllSymbols, key)) {
    if (!Attributes.enumerable) {
      if (!hasOwn(O, HIDDEN)) nativeDefineProperty(O, HIDDEN, createPropertyDescriptor(1, {}));
      O[HIDDEN][key] = true;
    } else {
      if (hasOwn(O, HIDDEN) && O[HIDDEN][key]) O[HIDDEN][key] = false;
      Attributes = nativeObjectCreate(Attributes, { enumerable: createPropertyDescriptor(0, false) });
    } return setSymbolDescriptor(O, key, Attributes);
  } return nativeDefineProperty(O, key, Attributes);
};

var $defineProperties = function defineProperties(O, Properties) {
  anObject(O);
  var properties = toIndexedObject(Properties);
  var keys = objectKeys(properties).concat($getOwnPropertySymbols(properties));
  $forEach(keys, function (key) {
    if (!DESCRIPTORS || call($propertyIsEnumerable, properties, key)) $defineProperty(O, key, properties[key]);
  });
  return O;
};

var $create = function create(O, Properties) {
  return Properties === undefined ? nativeObjectCreate(O) : $defineProperties(nativeObjectCreate(O), Properties);
};

var $propertyIsEnumerable = function propertyIsEnumerable(V) {
  var P = toPropertyKey(V);
  var enumerable = call(nativePropertyIsEnumerable, this, P);
  if (this === ObjectPrototype && hasOwn(AllSymbols, P) && !hasOwn(ObjectPrototypeSymbols, P)) return false;
  return enumerable || !hasOwn(this, P) || !hasOwn(AllSymbols, P) || hasOwn(this, HIDDEN) && this[HIDDEN][P]
    ? enumerable : true;
};

var $getOwnPropertyDescriptor = function getOwnPropertyDescriptor(O, P) {
  var it = toIndexedObject(O);
  var key = toPropertyKey(P);
  if (it === ObjectPrototype && hasOwn(AllSymbols, key) && !hasOwn(ObjectPrototypeSymbols, key)) return;
  var descriptor = nativeGetOwnPropertyDescriptor(it, key);
  if (descriptor && hasOwn(AllSymbols, key) && !(hasOwn(it, HIDDEN) && it[HIDDEN][key])) {
    descriptor.enumerable = true;
  }
  return descriptor;
};

var $getOwnPropertyNames = function getOwnPropertyNames(O) {
  var names = nativeGetOwnPropertyNames(toIndexedObject(O));
  var result = [];
  $forEach(names, function (key) {
    if (!hasOwn(AllSymbols, key) && !hasOwn(hiddenKeys, key)) push(result, key);
  });
  return result;
};

var $getOwnPropertySymbols = function getOwnPropertySymbols(O) {
  var IS_OBJECT_PROTOTYPE = O === ObjectPrototype;
  var names = nativeGetOwnPropertyNames(IS_OBJECT_PROTOTYPE ? ObjectPrototypeSymbols : toIndexedObject(O));
  var result = [];
  $forEach(names, function (key) {
    if (hasOwn(AllSymbols, key) && (!IS_OBJECT_PROTOTYPE || hasOwn(ObjectPrototype, key))) {
      push(result, AllSymbols[key]);
    }
  });
  return result;
};

// `Symbol` constructor
// https://tc39.es/ecma262/#sec-symbol-constructor
if (!NATIVE_SYMBOL) {
  $Symbol = function Symbol() {
    if (isPrototypeOf(SymbolPrototype, this)) throw TypeError('Symbol is not a constructor');
    var description = !arguments.length || arguments[0] === undefined ? undefined : $toString(arguments[0]);
    var tag = uid(description);
    var setter = function (value) {
      if (this === ObjectPrototype) call(setter, ObjectPrototypeSymbols, value);
      if (hasOwn(this, HIDDEN) && hasOwn(this[HIDDEN], tag)) this[HIDDEN][tag] = false;
      setSymbolDescriptor(this, tag, createPropertyDescriptor(1, value));
    };
    if (DESCRIPTORS && USE_SETTER) setSymbolDescriptor(ObjectPrototype, tag, { configurable: true, set: setter });
    return wrap(tag, description);
  };

  SymbolPrototype = $Symbol[PROTOTYPE];

  redefine(SymbolPrototype, 'toString', function toString() {
    return getInternalState(this).tag;
  });

  redefine($Symbol, 'withoutSetter', function (description) {
    return wrap(uid(description), description);
  });

  propertyIsEnumerableModule.f = $propertyIsEnumerable;
  definePropertyModule.f = $defineProperty;
  getOwnPropertyDescriptorModule.f = $getOwnPropertyDescriptor;
  getOwnPropertyNamesModule.f = getOwnPropertyNamesExternal.f = $getOwnPropertyNames;
  getOwnPropertySymbolsModule.f = $getOwnPropertySymbols;

  wrappedWellKnownSymbolModule.f = function (name) {
    return wrap(wellKnownSymbol(name), name);
  };

  if (DESCRIPTORS) {
    // https://github.com/tc39/proposal-Symbol-description
    nativeDefineProperty(SymbolPrototype, 'description', {
      configurable: true,
      get: function description() {
        return getInternalState(this).description;
      }
    });
    if (!IS_PURE) {
      redefine(ObjectPrototype, 'propertyIsEnumerable', $propertyIsEnumerable, { unsafe: true });
    }
  }
}

$({ global: true, wrap: true, forced: !NATIVE_SYMBOL, sham: !NATIVE_SYMBOL }, {
  Symbol: $Symbol
});

$forEach(objectKeys(WellKnownSymbolsStore), function (name) {
  defineWellKnownSymbol(name);
});

$({ target: SYMBOL, stat: true, forced: !NATIVE_SYMBOL }, {
  // `Symbol.for` method
  // https://tc39.es/ecma262/#sec-symbol.for
  'for': function (key) {
    var string = $toString(key);
    if (hasOwn(StringToSymbolRegistry, string)) return StringToSymbolRegistry[string];
    var symbol = $Symbol(string);
    StringToSymbolRegistry[string] = symbol;
    SymbolToStringRegistry[symbol] = string;
    return symbol;
  },
  // `Symbol.keyFor` method
  // https://tc39.es/ecma262/#sec-symbol.keyfor
  keyFor: function keyFor(sym) {
    if (!isSymbol(sym)) throw TypeError(sym + ' is not a symbol');
    if (hasOwn(SymbolToStringRegistry, sym)) return SymbolToStringRegistry[sym];
  },
  useSetter: function () { USE_SETTER = true; },
  useSimple: function () { USE_SETTER = false; }
});

$({ target: 'Object', stat: true, forced: !NATIVE_SYMBOL, sham: !DESCRIPTORS }, {
  // `Object.create` method
  // https://tc39.es/ecma262/#sec-object.create
  create: $create,
  // `Object.defineProperty` method
  // https://tc39.es/ecma262/#sec-object.defineproperty
  defineProperty: $defineProperty,
  // `Object.defineProperties` method
  // https://tc39.es/ecma262/#sec-object.defineproperties
  defineProperties: $defineProperties,
  // `Object.getOwnPropertyDescriptor` method
  // https://tc39.es/ecma262/#sec-object.getownpropertydescriptors
  getOwnPropertyDescriptor: $getOwnPropertyDescriptor
});

$({ target: 'Object', stat: true, forced: !NATIVE_SYMBOL }, {
  // `Object.getOwnPropertyNames` method
  // https://tc39.es/ecma262/#sec-object.getownpropertynames
  getOwnPropertyNames: $getOwnPropertyNames,
  // `Object.getOwnPropertySymbols` method
  // https://tc39.es/ecma262/#sec-object.getownpropertysymbols
  getOwnPropertySymbols: $getOwnPropertySymbols
});

// Chrome 38 and 39 `Object.getOwnPropertySymbols` fails on primitives
// https://bugs.chromium.org/p/v8/issues/detail?id=3443
$({ target: 'Object', stat: true, forced: fails(function () { getOwnPropertySymbolsModule.f(1); }) }, {
  getOwnPropertySymbols: function getOwnPropertySymbols(it) {
    return getOwnPropertySymbolsModule.f(toObject(it));
  }
});

// `JSON.stringify` method behavior with symbols
// https://tc39.es/ecma262/#sec-json.stringify
if ($stringify) {
  var FORCED_JSON_STRINGIFY = !NATIVE_SYMBOL || fails(function () {
    var symbol = $Symbol();
    // MS Edge converts symbol values to JSON as {}
    return $stringify([symbol]) != '[null]'
      // WebKit converts symbol values to JSON as null
      || $stringify({ a: symbol }) != '{}'
      // V8 throws on boxed symbols
      || $stringify(Object(symbol)) != '{}';
  });

  $({ target: 'JSON', stat: true, forced: FORCED_JSON_STRINGIFY }, {
    // eslint-disable-next-line no-unused-vars -- required for `.length`
    stringify: function stringify(it, replacer, space) {
      var args = arraySlice(arguments);
      var $replacer = replacer;
      if (!isObject(replacer) && it === undefined || isSymbol(it)) return; // IE8 returns string on undefined
      if (!isArray(replacer)) replacer = function (key, value) {
        if (isCallable($replacer)) value = call($replacer, this, key, value);
        if (!isSymbol(value)) return value;
      };
      args[1] = replacer;
      return apply($stringify, null, args);
    }
  });
}

// `Symbol.prototype[@@toPrimitive]` method
// https://tc39.es/ecma262/#sec-symbol.prototype-@@toprimitive
if (!SymbolPrototype[TO_PRIMITIVE]) {
  var valueOf = SymbolPrototype.valueOf;
  // eslint-disable-next-line no-unused-vars -- required for .length
  redefine(SymbolPrototype, TO_PRIMITIVE, function (hint) {
    // TODO: improve hint logic
    return call(valueOf, this);
  });
}
// `Symbol.prototype[@@toStringTag]` property
// https://tc39.es/ecma262/#sec-symbol.prototype-@@tostringtag
setToStringTag($Symbol, SYMBOL);

hiddenKeys[HIDDEN] = true;

},{"../internals/an-object":60,"../internals/array-iteration":64,"../internals/array-slice":68,"../internals/create-property-descriptor":79,"../internals/define-well-known-symbol":82,"../internals/descriptors":83,"../internals/export":93,"../internals/fails":94,"../internals/function-apply":95,"../internals/function-call":97,"../internals/function-uncurry-this":99,"../internals/get-built-in":100,"../internals/global":104,"../internals/has-own-property":105,"../internals/hidden-keys":106,"../internals/internal-state":111,"../internals/is-array":113,"../internals/is-callable":114,"../internals/is-object":117,"../internals/is-pure":118,"../internals/is-symbol":119,"../internals/native-symbol":124,"../internals/object-create":127,"../internals/object-define-property":129,"../internals/object-get-own-property-descriptor":130,"../internals/object-get-own-property-names":132,"../internals/object-get-own-property-names-external":131,"../internals/object-get-own-property-symbols":133,"../internals/object-is-prototype-of":135,"../internals/object-keys":137,"../internals/object-property-is-enumerable":138,"../internals/redefine":143,"../internals/set-to-string-tag":147,"../internals/shared":150,"../internals/shared-key":148,"../internals/to-indexed-object":154,"../internals/to-object":157,"../internals/to-property-key":159,"../internals/to-string":161,"../internals/uid":163,"../internals/well-known-symbol":166,"../internals/well-known-symbol-wrapped":165}],191:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.matchAll` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.matchall
defineWellKnownSymbol('matchAll');

},{"../internals/define-well-known-symbol":82}],192:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.match` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.match
defineWellKnownSymbol('match');

},{"../internals/define-well-known-symbol":82}],193:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.replace` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.replace
defineWellKnownSymbol('replace');

},{"../internals/define-well-known-symbol":82}],194:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.search` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.search
defineWellKnownSymbol('search');

},{"../internals/define-well-known-symbol":82}],195:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.species` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.species
defineWellKnownSymbol('species');

},{"../internals/define-well-known-symbol":82}],196:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.split` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.split
defineWellKnownSymbol('split');

},{"../internals/define-well-known-symbol":82}],197:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.toPrimitive` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.toprimitive
defineWellKnownSymbol('toPrimitive');

},{"../internals/define-well-known-symbol":82}],198:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.toStringTag` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.tostringtag
defineWellKnownSymbol('toStringTag');

},{"../internals/define-well-known-symbol":82}],199:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.unscopables` well-known symbol
// https://tc39.es/ecma262/#sec-symbol.unscopables
defineWellKnownSymbol('unscopables');

},{"../internals/define-well-known-symbol":82}],200:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.asyncDispose` well-known symbol
// https://github.com/tc39/proposal-using-statement
defineWellKnownSymbol('asyncDispose');

},{"../internals/define-well-known-symbol":82}],201:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.dispose` well-known symbol
// https://github.com/tc39/proposal-using-statement
defineWellKnownSymbol('dispose');

},{"../internals/define-well-known-symbol":82}],202:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.matcher` well-known symbol
// https://github.com/tc39/proposal-pattern-matching
defineWellKnownSymbol('matcher');

},{"../internals/define-well-known-symbol":82}],203:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.metadata` well-known symbol
// https://github.com/tc39/proposal-decorators
defineWellKnownSymbol('metadata');

},{"../internals/define-well-known-symbol":82}],204:[function(require,module,exports){
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.observable` well-known symbol
// https://github.com/tc39/proposal-observable
defineWellKnownSymbol('observable');

},{"../internals/define-well-known-symbol":82}],205:[function(require,module,exports){
// TODO: remove from `core-js@4`
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

// `Symbol.patternMatch` well-known symbol
// https://github.com/tc39/proposal-pattern-matching
defineWellKnownSymbol('patternMatch');

},{"../internals/define-well-known-symbol":82}],206:[function(require,module,exports){
// TODO: remove from `core-js@4`
var defineWellKnownSymbol = require('../internals/define-well-known-symbol');

defineWellKnownSymbol('replaceAll');

},{"../internals/define-well-known-symbol":82}],207:[function(require,module,exports){
require('../modules/es.array.iterator');
var DOMIterables = require('../internals/dom-iterables');
var global = require('../internals/global');
var classof = require('../internals/classof');
var createNonEnumerableProperty = require('../internals/create-non-enumerable-property');
var Iterators = require('../internals/iterators');
var wellKnownSymbol = require('../internals/well-known-symbol');

var TO_STRING_TAG = wellKnownSymbol('toStringTag');

for (var COLLECTION_NAME in DOMIterables) {
  var Collection = global[COLLECTION_NAME];
  var CollectionPrototype = Collection && Collection.prototype;
  if (CollectionPrototype && classof(CollectionPrototype) !== TO_STRING_TAG) {
    createNonEnumerableProperty(CollectionPrototype, TO_STRING_TAG, COLLECTION_NAME);
  }
  Iterators[COLLECTION_NAME] = Iterators.Array;
}

},{"../internals/classof":75,"../internals/create-non-enumerable-property":78,"../internals/dom-iterables":85,"../internals/global":104,"../internals/iterators":122,"../internals/well-known-symbol":166,"../modules/es.array.iterator":173}],208:[function(require,module,exports){
var parent = require('../../es/array/from');

module.exports = parent;

},{"../../es/array/from":34}],209:[function(require,module,exports){
var parent = require('../../es/array/is-array');

module.exports = parent;

},{"../../es/array/is-array":35}],210:[function(require,module,exports){
var parent = require('../../../es/array/virtual/for-each');

module.exports = parent;

},{"../../../es/array/virtual/for-each":37}],211:[function(require,module,exports){
var parent = require('../es/get-iterator-method');
require('../modules/web.dom-collections.iterator');

module.exports = parent;

},{"../es/get-iterator-method":41,"../modules/web.dom-collections.iterator":207}],212:[function(require,module,exports){
var parent = require('../../es/instance/concat');

module.exports = parent;

},{"../../es/instance/concat":42}],213:[function(require,module,exports){
var parent = require('../../es/instance/flags');

module.exports = parent;

},{"../../es/instance/flags":43}],214:[function(require,module,exports){
require('../../modules/web.dom-collections.iterator');
var classof = require('../../internals/classof');
var hasOwn = require('../../internals/has-own-property');
var isPrototypeOf = require('../../internals/object-is-prototype-of');
var method = require('../array/virtual/for-each');

var ArrayPrototype = Array.prototype;

var DOMIterables = {
  DOMTokenList: true,
  NodeList: true
};

module.exports = function (it) {
  var own = it.forEach;
  return it === ArrayPrototype || (isPrototypeOf(ArrayPrototype, it) && own === ArrayPrototype.forEach)
    || hasOwn(DOMIterables, classof(it)) ? method : own;
};

},{"../../internals/classof":75,"../../internals/has-own-property":105,"../../internals/object-is-prototype-of":135,"../../modules/web.dom-collections.iterator":207,"../array/virtual/for-each":210}],215:[function(require,module,exports){
var parent = require('../../es/instance/index-of');

module.exports = parent;

},{"../../es/instance/index-of":44}],216:[function(require,module,exports){
var parent = require('../../es/instance/slice');

module.exports = parent;

},{"../../es/instance/slice":45}],217:[function(require,module,exports){
var parent = require('../../es/instance/sort');

module.exports = parent;

},{"../../es/instance/sort":46}],218:[function(require,module,exports){
var parent = require('../../es/object/create');

module.exports = parent;

},{"../../es/object/create":47}],219:[function(require,module,exports){
var parent = require('../../es/object/define-property');

module.exports = parent;

},{"../../es/object/define-property":48}],220:[function(require,module,exports){
var parent = require('../es/parse-int');

module.exports = parent;

},{"../es/parse-int":49}],221:[function(require,module,exports){
var parent = require('../../es/symbol');
require('../../modules/web.dom-collections.iterator');

module.exports = parent;

},{"../../es/symbol":51,"../../modules/web.dom-collections.iterator":207}],222:[function(require,module,exports){
module.exports = [
    {
        'name': 'C',
        'alias': 'Other',
        'isBmpLast': true,
        'bmp': '\0-\x1F\x7F-\x9F\xAD\u0378\u0379\u0380-\u0383\u038B\u038D\u03A2\u0530\u0557\u0558\u058B\u058C\u0590\u05C8-\u05CF\u05EB-\u05EE\u05F5-\u0605\u061C\u06DD\u070E\u070F\u074B\u074C\u07B2-\u07BF\u07FB\u07FC\u082E\u082F\u083F\u085C\u085D\u085F\u086B-\u086F\u088F-\u0897\u08E2\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FF\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A77-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0AF8\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B54\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0BFF\u0C0D\u0C11\u0C29\u0C3A\u0C3B\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5B\u0C5C\u0C5E\u0C5F\u0C64\u0C65\u0C70-\u0C76\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDC\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0CFF\u0D0D\u0D11\u0D45\u0D49\u0D50-\u0D53\u0D64\u0D65\u0D80\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DE5\u0DF0\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E8B\u0EA4\u0EA6\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F6\u13F7\u13FE\u13FF\u169D-\u169F\u16F9-\u16FF\u1716-\u171E\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u180E\u181A-\u181F\u1879-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE\u1AAF\u1ACF-\u1AFF\u1B4D-\u1B4F\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C89-\u1C8F\u1CBB\u1CBC\u1CC8-\u1CCF\u1CFB-\u1CFF\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2072\u2073\u208F\u209D-\u209F\u20C1-\u20CF\u20F1-\u20FF\u218C-\u218F\u2427-\u243F\u244B-\u245F\u2B74\u2B75\u2B96\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E5E-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u3130\u318F\u31E4-\u31EF\u321F\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA6F8-\uA6FF\uA7CB-\uA7CF\uA7D2\uA7D4\uA7DA-\uA7F1\uA82D-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C6-\uA8CD\uA8DA-\uA8DF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F\uAB6C-\uAB6F\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC3-\uFBD2\uFD90\uFD91\uFDC8-\uFDCE\uFDD0-\uFDEF\uFE1A-\uFE1F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD-\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFFB\uFFFE\uFFFF',
        'astral': '\uD800[\uDC0C\uDC27\uDC3B\uDC3E\uDC4E\uDC4F\uDC5E-\uDC7F\uDCFB-\uDCFF\uDD03-\uDD06\uDD34-\uDD36\uDD8F\uDD9D-\uDD9F\uDDA1-\uDDCF\uDDFE-\uDE7F\uDE9D-\uDE9F\uDED1-\uDEDF\uDEFC-\uDEFF\uDF24-\uDF2C\uDF4B-\uDF4F\uDF7B-\uDF7F\uDF9E\uDFC4-\uDFC7\uDFD6-\uDFFF]|\uD801[\uDC9E\uDC9F\uDCAA-\uDCAF\uDCD4-\uDCD7\uDCFC-\uDCFF\uDD28-\uDD2F\uDD64-\uDD6E\uDD7B\uDD8B\uDD93\uDD96\uDDA2\uDDB2\uDDBA\uDDBD-\uDDFF\uDF37-\uDF3F\uDF56-\uDF5F\uDF68-\uDF7F\uDF86\uDFB1\uDFBB-\uDFFF]|\uD802[\uDC06\uDC07\uDC09\uDC36\uDC39-\uDC3B\uDC3D\uDC3E\uDC56\uDC9F-\uDCA6\uDCB0-\uDCDF\uDCF3\uDCF6-\uDCFA\uDD1C-\uDD1E\uDD3A-\uDD3E\uDD40-\uDD7F\uDDB8-\uDDBB\uDDD0\uDDD1\uDE04\uDE07-\uDE0B\uDE14\uDE18\uDE36\uDE37\uDE3B-\uDE3E\uDE49-\uDE4F\uDE59-\uDE5F\uDEA0-\uDEBF\uDEE7-\uDEEA\uDEF7-\uDEFF\uDF36-\uDF38\uDF56\uDF57\uDF73-\uDF77\uDF92-\uDF98\uDF9D-\uDFA8\uDFB0-\uDFFF]|\uD803[\uDC49-\uDC7F\uDCB3-\uDCBF\uDCF3-\uDCF9\uDD28-\uDD2F\uDD3A-\uDE5F\uDE7F\uDEAA\uDEAE\uDEAF\uDEB2-\uDEFF\uDF28-\uDF2F\uDF5A-\uDF6F\uDF8A-\uDFAF\uDFCC-\uDFDF\uDFF7-\uDFFF]|\uD804[\uDC4E-\uDC51\uDC76-\uDC7E\uDCBD\uDCC3-\uDCCF\uDCE9-\uDCEF\uDCFA-\uDCFF\uDD35\uDD48-\uDD4F\uDD77-\uDD7F\uDDE0\uDDF5-\uDDFF\uDE12\uDE3F-\uDE7F\uDE87\uDE89\uDE8E\uDE9E\uDEAA-\uDEAF\uDEEB-\uDEEF\uDEFA-\uDEFF\uDF04\uDF0D\uDF0E\uDF11\uDF12\uDF29\uDF31\uDF34\uDF3A\uDF45\uDF46\uDF49\uDF4A\uDF4E\uDF4F\uDF51-\uDF56\uDF58-\uDF5C\uDF64\uDF65\uDF6D-\uDF6F\uDF75-\uDFFF]|\uD805[\uDC5C\uDC62-\uDC7F\uDCC8-\uDCCF\uDCDA-\uDD7F\uDDB6\uDDB7\uDDDE-\uDDFF\uDE45-\uDE4F\uDE5A-\uDE5F\uDE6D-\uDE7F\uDEBA-\uDEBF\uDECA-\uDEFF\uDF1B\uDF1C\uDF2C-\uDF2F\uDF47-\uDFFF]|\uD806[\uDC3C-\uDC9F\uDCF3-\uDCFE\uDD07\uDD08\uDD0A\uDD0B\uDD14\uDD17\uDD36\uDD39\uDD3A\uDD47-\uDD4F\uDD5A-\uDD9F\uDDA8\uDDA9\uDDD8\uDDD9\uDDE5-\uDDFF\uDE48-\uDE4F\uDEA3-\uDEAF\uDEF9-\uDFFF]|\uD807[\uDC09\uDC37\uDC46-\uDC4F\uDC6D-\uDC6F\uDC90\uDC91\uDCA8\uDCB7-\uDCFF\uDD07\uDD0A\uDD37-\uDD39\uDD3B\uDD3E\uDD48-\uDD4F\uDD5A-\uDD5F\uDD66\uDD69\uDD8F\uDD92\uDD99-\uDD9F\uDDAA-\uDEDF\uDEF9-\uDFAF\uDFB1-\uDFBF\uDFF2-\uDFFE]|\uD808[\uDF9A-\uDFFF]|\uD809[\uDC6F\uDC75-\uDC7F\uDD44-\uDFFF]|[\uD80A\uD80E-\uD810\uD812-\uD819\uD824-\uD82A\uD82D\uD82E\uD830-\uD832\uD83F\uD87B-\uD87D\uD87F\uD885-\uDB3F\uDB41-\uDBFF][\uDC00-\uDFFF]|\uD80B[\uDC00-\uDF8F\uDFF3-\uDFFF]|\uD80D[\uDC2F-\uDFFF]|\uD811[\uDE47-\uDFFF]|\uD81A[\uDE39-\uDE3F\uDE5F\uDE6A-\uDE6D\uDEBF\uDECA-\uDECF\uDEEE\uDEEF\uDEF6-\uDEFF\uDF46-\uDF4F\uDF5A\uDF62\uDF78-\uDF7C\uDF90-\uDFFF]|\uD81B[\uDC00-\uDE3F\uDE9B-\uDEFF\uDF4B-\uDF4E\uDF88-\uDF8E\uDFA0-\uDFDF\uDFE5-\uDFEF\uDFF2-\uDFFF]|\uD821[\uDFF8-\uDFFF]|\uD823[\uDCD6-\uDCFF\uDD09-\uDFFF]|\uD82B[\uDC00-\uDFEF\uDFF4\uDFFC\uDFFF]|\uD82C[\uDD23-\uDD4F\uDD53-\uDD63\uDD68-\uDD6F\uDEFC-\uDFFF]|\uD82F[\uDC6B-\uDC6F\uDC7D-\uDC7F\uDC89-\uDC8F\uDC9A\uDC9B\uDCA0-\uDFFF]|\uD833[\uDC00-\uDEFF\uDF2E\uDF2F\uDF47-\uDF4F\uDFC4-\uDFFF]|\uD834[\uDCF6-\uDCFF\uDD27\uDD28\uDD73-\uDD7A\uDDEB-\uDDFF\uDE46-\uDEDF\uDEF4-\uDEFF\uDF57-\uDF5F\uDF79-\uDFFF]|\uD835[\uDC55\uDC9D\uDCA0\uDCA1\uDCA3\uDCA4\uDCA7\uDCA8\uDCAD\uDCBA\uDCBC\uDCC4\uDD06\uDD0B\uDD0C\uDD15\uDD1D\uDD3A\uDD3F\uDD45\uDD47-\uDD49\uDD51\uDEA6\uDEA7\uDFCC\uDFCD]|\uD836[\uDE8C-\uDE9A\uDEA0\uDEB0-\uDFFF]|\uD837[\uDC00-\uDEFF\uDF1F-\uDFFF]|\uD838[\uDC07\uDC19\uDC1A\uDC22\uDC25\uDC2B-\uDCFF\uDD2D-\uDD2F\uDD3E\uDD3F\uDD4A-\uDD4D\uDD50-\uDE8F\uDEAF-\uDEBF\uDEFA-\uDEFE\uDF00-\uDFFF]|\uD839[\uDC00-\uDFDF\uDFE7\uDFEC\uDFEF\uDFFF]|\uD83A[\uDCC5\uDCC6\uDCD7-\uDCFF\uDD4C-\uDD4F\uDD5A-\uDD5D\uDD60-\uDFFF]|\uD83B[\uDC00-\uDC70\uDCB5-\uDD00\uDD3E-\uDDFF\uDE04\uDE20\uDE23\uDE25\uDE26\uDE28\uDE33\uDE38\uDE3A\uDE3C-\uDE41\uDE43-\uDE46\uDE48\uDE4A\uDE4C\uDE50\uDE53\uDE55\uDE56\uDE58\uDE5A\uDE5C\uDE5E\uDE60\uDE63\uDE65\uDE66\uDE6B\uDE73\uDE78\uDE7D\uDE7F\uDE8A\uDE9C-\uDEA0\uDEA4\uDEAA\uDEBC-\uDEEF\uDEF2-\uDFFF]|\uD83C[\uDC2C-\uDC2F\uDC94-\uDC9F\uDCAF\uDCB0\uDCC0\uDCD0\uDCF6-\uDCFF\uDDAE-\uDDE5\uDE03-\uDE0F\uDE3C-\uDE3F\uDE49-\uDE4F\uDE52-\uDE5F\uDE66-\uDEFF]|\uD83D[\uDED8-\uDEDC\uDEED-\uDEEF\uDEFD-\uDEFF\uDF74-\uDF7F\uDFD9-\uDFDF\uDFEC-\uDFEF\uDFF1-\uDFFF]|\uD83E[\uDC0C-\uDC0F\uDC48-\uDC4F\uDC5A-\uDC5F\uDC88-\uDC8F\uDCAE\uDCAF\uDCB2-\uDCFF\uDE54-\uDE5F\uDE6E\uDE6F\uDE75-\uDE77\uDE7D-\uDE7F\uDE87-\uDE8F\uDEAD-\uDEAF\uDEBB-\uDEBF\uDEC6-\uDECF\uDEDA-\uDEDF\uDEE8-\uDEEF\uDEF7-\uDEFF\uDF93\uDFCB-\uDFEF\uDFFA-\uDFFF]|\uD869[\uDEE0-\uDEFF]|\uD86D[\uDF39-\uDF3F]|\uD86E[\uDC1E\uDC1F]|\uD873[\uDEA2-\uDEAF]|\uD87A[\uDFE1-\uDFFF]|\uD87E[\uDE1E-\uDFFF]|\uD884[\uDF4B-\uDFFF]|\uDB40[\uDC00-\uDCFF\uDDF0-\uDFFF]'
    },
    {
        'name': 'Cc',
        'alias': 'Control',
        'bmp': '\0-\x1F\x7F-\x9F'
    },
    {
        'name': 'Cf',
        'alias': 'Format',
        'bmp': '\xAD\u0600-\u0605\u061C\u06DD\u070F\u0890\u0891\u08E2\u180E\u200B-\u200F\u202A-\u202E\u2060-\u2064\u2066-\u206F\uFEFF\uFFF9-\uFFFB',
        'astral': '\uD804[\uDCBD\uDCCD]|\uD80D[\uDC30-\uDC38]|\uD82F[\uDCA0-\uDCA3]|\uD834[\uDD73-\uDD7A]|\uDB40[\uDC01\uDC20-\uDC7F]'
    },
    {
        'name': 'Cn',
        'alias': 'Unassigned',
        'bmp': '\u0378\u0379\u0380-\u0383\u038B\u038D\u03A2\u0530\u0557\u0558\u058B\u058C\u0590\u05C8-\u05CF\u05EB-\u05EE\u05F5-\u05FF\u070E\u074B\u074C\u07B2-\u07BF\u07FB\u07FC\u082E\u082F\u083F\u085C\u085D\u085F\u086B-\u086F\u088F\u0892-\u0897\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FF\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A77-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0AF8\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B54\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0BFF\u0C0D\u0C11\u0C29\u0C3A\u0C3B\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5B\u0C5C\u0C5E\u0C5F\u0C64\u0C65\u0C70-\u0C76\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDC\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0CFF\u0D0D\u0D11\u0D45\u0D49\u0D50-\u0D53\u0D64\u0D65\u0D80\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DE5\u0DF0\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E8B\u0EA4\u0EA6\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F6\u13F7\u13FE\u13FF\u169D-\u169F\u16F9-\u16FF\u1716-\u171E\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u181A-\u181F\u1879-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE\u1AAF\u1ACF-\u1AFF\u1B4D-\u1B4F\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C89-\u1C8F\u1CBB\u1CBC\u1CC8-\u1CCF\u1CFB-\u1CFF\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u2065\u2072\u2073\u208F\u209D-\u209F\u20C1-\u20CF\u20F1-\u20FF\u218C-\u218F\u2427-\u243F\u244B-\u245F\u2B74\u2B75\u2B96\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E5E-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u3130\u318F\u31E4-\u31EF\u321F\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA6F8-\uA6FF\uA7CB-\uA7CF\uA7D2\uA7D4\uA7DA-\uA7F1\uA82D-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C6-\uA8CD\uA8DA-\uA8DF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F\uAB6C-\uAB6F\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uD7FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC3-\uFBD2\uFD90\uFD91\uFDC8-\uFDCE\uFDD0-\uFDEF\uFE1A-\uFE1F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD\uFEFE\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFF8\uFFFE\uFFFF',
        'astral': '\uD800[\uDC0C\uDC27\uDC3B\uDC3E\uDC4E\uDC4F\uDC5E-\uDC7F\uDCFB-\uDCFF\uDD03-\uDD06\uDD34-\uDD36\uDD8F\uDD9D-\uDD9F\uDDA1-\uDDCF\uDDFE-\uDE7F\uDE9D-\uDE9F\uDED1-\uDEDF\uDEFC-\uDEFF\uDF24-\uDF2C\uDF4B-\uDF4F\uDF7B-\uDF7F\uDF9E\uDFC4-\uDFC7\uDFD6-\uDFFF]|\uD801[\uDC9E\uDC9F\uDCAA-\uDCAF\uDCD4-\uDCD7\uDCFC-\uDCFF\uDD28-\uDD2F\uDD64-\uDD6E\uDD7B\uDD8B\uDD93\uDD96\uDDA2\uDDB2\uDDBA\uDDBD-\uDDFF\uDF37-\uDF3F\uDF56-\uDF5F\uDF68-\uDF7F\uDF86\uDFB1\uDFBB-\uDFFF]|\uD802[\uDC06\uDC07\uDC09\uDC36\uDC39-\uDC3B\uDC3D\uDC3E\uDC56\uDC9F-\uDCA6\uDCB0-\uDCDF\uDCF3\uDCF6-\uDCFA\uDD1C-\uDD1E\uDD3A-\uDD3E\uDD40-\uDD7F\uDDB8-\uDDBB\uDDD0\uDDD1\uDE04\uDE07-\uDE0B\uDE14\uDE18\uDE36\uDE37\uDE3B-\uDE3E\uDE49-\uDE4F\uDE59-\uDE5F\uDEA0-\uDEBF\uDEE7-\uDEEA\uDEF7-\uDEFF\uDF36-\uDF38\uDF56\uDF57\uDF73-\uDF77\uDF92-\uDF98\uDF9D-\uDFA8\uDFB0-\uDFFF]|\uD803[\uDC49-\uDC7F\uDCB3-\uDCBF\uDCF3-\uDCF9\uDD28-\uDD2F\uDD3A-\uDE5F\uDE7F\uDEAA\uDEAE\uDEAF\uDEB2-\uDEFF\uDF28-\uDF2F\uDF5A-\uDF6F\uDF8A-\uDFAF\uDFCC-\uDFDF\uDFF7-\uDFFF]|\uD804[\uDC4E-\uDC51\uDC76-\uDC7E\uDCC3-\uDCCC\uDCCE\uDCCF\uDCE9-\uDCEF\uDCFA-\uDCFF\uDD35\uDD48-\uDD4F\uDD77-\uDD7F\uDDE0\uDDF5-\uDDFF\uDE12\uDE3F-\uDE7F\uDE87\uDE89\uDE8E\uDE9E\uDEAA-\uDEAF\uDEEB-\uDEEF\uDEFA-\uDEFF\uDF04\uDF0D\uDF0E\uDF11\uDF12\uDF29\uDF31\uDF34\uDF3A\uDF45\uDF46\uDF49\uDF4A\uDF4E\uDF4F\uDF51-\uDF56\uDF58-\uDF5C\uDF64\uDF65\uDF6D-\uDF6F\uDF75-\uDFFF]|\uD805[\uDC5C\uDC62-\uDC7F\uDCC8-\uDCCF\uDCDA-\uDD7F\uDDB6\uDDB7\uDDDE-\uDDFF\uDE45-\uDE4F\uDE5A-\uDE5F\uDE6D-\uDE7F\uDEBA-\uDEBF\uDECA-\uDEFF\uDF1B\uDF1C\uDF2C-\uDF2F\uDF47-\uDFFF]|\uD806[\uDC3C-\uDC9F\uDCF3-\uDCFE\uDD07\uDD08\uDD0A\uDD0B\uDD14\uDD17\uDD36\uDD39\uDD3A\uDD47-\uDD4F\uDD5A-\uDD9F\uDDA8\uDDA9\uDDD8\uDDD9\uDDE5-\uDDFF\uDE48-\uDE4F\uDEA3-\uDEAF\uDEF9-\uDFFF]|\uD807[\uDC09\uDC37\uDC46-\uDC4F\uDC6D-\uDC6F\uDC90\uDC91\uDCA8\uDCB7-\uDCFF\uDD07\uDD0A\uDD37-\uDD39\uDD3B\uDD3E\uDD48-\uDD4F\uDD5A-\uDD5F\uDD66\uDD69\uDD8F\uDD92\uDD99-\uDD9F\uDDAA-\uDEDF\uDEF9-\uDFAF\uDFB1-\uDFBF\uDFF2-\uDFFE]|\uD808[\uDF9A-\uDFFF]|\uD809[\uDC6F\uDC75-\uDC7F\uDD44-\uDFFF]|[\uD80A\uD80E-\uD810\uD812-\uD819\uD824-\uD82A\uD82D\uD82E\uD830-\uD832\uD83F\uD87B-\uD87D\uD87F\uD885-\uDB3F\uDB41-\uDB7F][\uDC00-\uDFFF]|\uD80B[\uDC00-\uDF8F\uDFF3-\uDFFF]|\uD80D[\uDC2F\uDC39-\uDFFF]|\uD811[\uDE47-\uDFFF]|\uD81A[\uDE39-\uDE3F\uDE5F\uDE6A-\uDE6D\uDEBF\uDECA-\uDECF\uDEEE\uDEEF\uDEF6-\uDEFF\uDF46-\uDF4F\uDF5A\uDF62\uDF78-\uDF7C\uDF90-\uDFFF]|\uD81B[\uDC00-\uDE3F\uDE9B-\uDEFF\uDF4B-\uDF4E\uDF88-\uDF8E\uDFA0-\uDFDF\uDFE5-\uDFEF\uDFF2-\uDFFF]|\uD821[\uDFF8-\uDFFF]|\uD823[\uDCD6-\uDCFF\uDD09-\uDFFF]|\uD82B[\uDC00-\uDFEF\uDFF4\uDFFC\uDFFF]|\uD82C[\uDD23-\uDD4F\uDD53-\uDD63\uDD68-\uDD6F\uDEFC-\uDFFF]|\uD82F[\uDC6B-\uDC6F\uDC7D-\uDC7F\uDC89-\uDC8F\uDC9A\uDC9B\uDCA4-\uDFFF]|\uD833[\uDC00-\uDEFF\uDF2E\uDF2F\uDF47-\uDF4F\uDFC4-\uDFFF]|\uD834[\uDCF6-\uDCFF\uDD27\uDD28\uDDEB-\uDDFF\uDE46-\uDEDF\uDEF4-\uDEFF\uDF57-\uDF5F\uDF79-\uDFFF]|\uD835[\uDC55\uDC9D\uDCA0\uDCA1\uDCA3\uDCA4\uDCA7\uDCA8\uDCAD\uDCBA\uDCBC\uDCC4\uDD06\uDD0B\uDD0C\uDD15\uDD1D\uDD3A\uDD3F\uDD45\uDD47-\uDD49\uDD51\uDEA6\uDEA7\uDFCC\uDFCD]|\uD836[\uDE8C-\uDE9A\uDEA0\uDEB0-\uDFFF]|\uD837[\uDC00-\uDEFF\uDF1F-\uDFFF]|\uD838[\uDC07\uDC19\uDC1A\uDC22\uDC25\uDC2B-\uDCFF\uDD2D-\uDD2F\uDD3E\uDD3F\uDD4A-\uDD4D\uDD50-\uDE8F\uDEAF-\uDEBF\uDEFA-\uDEFE\uDF00-\uDFFF]|\uD839[\uDC00-\uDFDF\uDFE7\uDFEC\uDFEF\uDFFF]|\uD83A[\uDCC5\uDCC6\uDCD7-\uDCFF\uDD4C-\uDD4F\uDD5A-\uDD5D\uDD60-\uDFFF]|\uD83B[\uDC00-\uDC70\uDCB5-\uDD00\uDD3E-\uDDFF\uDE04\uDE20\uDE23\uDE25\uDE26\uDE28\uDE33\uDE38\uDE3A\uDE3C-\uDE41\uDE43-\uDE46\uDE48\uDE4A\uDE4C\uDE50\uDE53\uDE55\uDE56\uDE58\uDE5A\uDE5C\uDE5E\uDE60\uDE63\uDE65\uDE66\uDE6B\uDE73\uDE78\uDE7D\uDE7F\uDE8A\uDE9C-\uDEA0\uDEA4\uDEAA\uDEBC-\uDEEF\uDEF2-\uDFFF]|\uD83C[\uDC2C-\uDC2F\uDC94-\uDC9F\uDCAF\uDCB0\uDCC0\uDCD0\uDCF6-\uDCFF\uDDAE-\uDDE5\uDE03-\uDE0F\uDE3C-\uDE3F\uDE49-\uDE4F\uDE52-\uDE5F\uDE66-\uDEFF]|\uD83D[\uDED8-\uDEDC\uDEED-\uDEEF\uDEFD-\uDEFF\uDF74-\uDF7F\uDFD9-\uDFDF\uDFEC-\uDFEF\uDFF1-\uDFFF]|\uD83E[\uDC0C-\uDC0F\uDC48-\uDC4F\uDC5A-\uDC5F\uDC88-\uDC8F\uDCAE\uDCAF\uDCB2-\uDCFF\uDE54-\uDE5F\uDE6E\uDE6F\uDE75-\uDE77\uDE7D-\uDE7F\uDE87-\uDE8F\uDEAD-\uDEAF\uDEBB-\uDEBF\uDEC6-\uDECF\uDEDA-\uDEDF\uDEE8-\uDEEF\uDEF7-\uDEFF\uDF93\uDFCB-\uDFEF\uDFFA-\uDFFF]|\uD869[\uDEE0-\uDEFF]|\uD86D[\uDF39-\uDF3F]|\uD86E[\uDC1E\uDC1F]|\uD873[\uDEA2-\uDEAF]|\uD87A[\uDFE1-\uDFFF]|\uD87E[\uDE1E-\uDFFF]|\uD884[\uDF4B-\uDFFF]|\uDB40[\uDC00\uDC02-\uDC1F\uDC80-\uDCFF\uDDF0-\uDFFF]|[\uDBBF\uDBFF][\uDFFE\uDFFF]'
    },
    {
        'name': 'Co',
        'alias': 'Private_Use',
        'bmp': '\uE000-\uF8FF',
        'astral': '[\uDB80-\uDBBE\uDBC0-\uDBFE][\uDC00-\uDFFF]|[\uDBBF\uDBFF][\uDC00-\uDFFD]'
    },
    {
        'name': 'Cs',
        'alias': 'Surrogate',
        'bmp': '\uD800-\uDFFF'
    },
    {
        'name': 'L',
        'alias': 'Letter',
        'bmp': 'A-Za-z\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u05D0-\u05EA\u05EF-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u0860-\u086A\u0870-\u0887\u0889-\u088E\u08A0-\u08C9\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u09FC\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0AF9\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58-\u0C5A\u0C5D\u0C60\u0C61\u0C80\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D04-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D54-\u0D56\u0D5F-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16F1-\u16F8\u1700-\u1711\u171F-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1878\u1880-\u1884\u1887-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4C\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CE9-\u1CEC\u1CEE-\u1CF3\u1CF5\u1CF6\u1CFA\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u31BF\u31F0-\u31FF\u3400-\u4DBF\u4E00-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B-\uA7CA\uA7D0\uA7D1\uA7D3\uA7D5-\uA7D9\uA7F2-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA8FD\uA8FE\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uA9E0-\uA9E4\uA9E6-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB69\uAB70-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC',
        'astral': '\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDE80-\uDE9C\uDEA0-\uDED0\uDF00-\uDF1F\uDF2D-\uDF40\uDF42-\uDF49\uDF50-\uDF75\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF]|\uD801[\uDC00-\uDC9D\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD00-\uDD27\uDD30-\uDD63\uDD70-\uDD7A\uDD7C-\uDD8A\uDD8C-\uDD92\uDD94\uDD95\uDD97-\uDDA1\uDDA3-\uDDB1\uDDB3-\uDDB9\uDDBB\uDDBC\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67\uDF80-\uDF85\uDF87-\uDFB0\uDFB2-\uDFBA]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDCE0-\uDCF2\uDCF4\uDCF5\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00\uDE10-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE4\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48\uDC80-\uDCB2\uDCC0-\uDCF2\uDD00-\uDD23\uDE80-\uDEA9\uDEB0\uDEB1\uDF00-\uDF1C\uDF27\uDF30-\uDF45\uDF70-\uDF81\uDFB0-\uDFC4\uDFE0-\uDFF6]|\uD804[\uDC03-\uDC37\uDC71\uDC72\uDC75\uDC83-\uDCAF\uDCD0-\uDCE8\uDD03-\uDD26\uDD44\uDD47\uDD50-\uDD72\uDD76\uDD83-\uDDB2\uDDC1-\uDDC4\uDDDA\uDDDC\uDE00-\uDE11\uDE13-\uDE2B\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEDE\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3D\uDF50\uDF5D-\uDF61]|\uD805[\uDC00-\uDC34\uDC47-\uDC4A\uDC5F-\uDC61\uDC80-\uDCAF\uDCC4\uDCC5\uDCC7\uDD80-\uDDAE\uDDD8-\uDDDB\uDE00-\uDE2F\uDE44\uDE80-\uDEAA\uDEB8\uDF00-\uDF1A\uDF40-\uDF46]|\uD806[\uDC00-\uDC2B\uDCA0-\uDCDF\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD2F\uDD3F\uDD41\uDDA0-\uDDA7\uDDAA-\uDDD0\uDDE1\uDDE3\uDE00\uDE0B-\uDE32\uDE3A\uDE50\uDE5C-\uDE89\uDE9D\uDEB0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC2E\uDC40\uDC72-\uDC8F\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD30\uDD46\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD89\uDD98\uDEE0-\uDEF2\uDFB0]|\uD808[\uDC00-\uDF99]|\uD809[\uDC80-\uDD43]|\uD80B[\uDF90-\uDFF0]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE70-\uDEBE\uDED0-\uDEED\uDF00-\uDF2F\uDF40-\uDF43\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDE40-\uDE7F\uDF00-\uDF4A\uDF50\uDF93-\uDF9F\uDFE0\uDFE1\uDFE3]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD82C[\uDC00-\uDD22\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB]|\uD837[\uDF00-\uDF1E]|\uD838[\uDD00-\uDD2C\uDD37-\uDD3D\uDD4E\uDE90-\uDEAD\uDEC0-\uDEEB]|\uD839[\uDFE0-\uDFE6\uDFE8-\uDFEB\uDFED\uDFEE\uDFF0-\uDFFE]|\uD83A[\uDC00-\uDCC4\uDD00-\uDD43\uDD4B]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF38\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A]'
    },
    {
        'name': 'LC',
        'alias': 'Cased_Letter',
        'bmp': 'A-Za-z\xB5\xC0-\xD6\xD8-\xF6\xF8-\u01BA\u01BC-\u01BF\u01C4-\u0293\u0295-\u02AF\u0370-\u0373\u0376\u0377\u037B-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0560-\u0588\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FD-\u10FF\u13A0-\u13F5\u13F8-\u13FD\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1D00-\u1D2B\u1D6B-\u1D77\u1D79-\u1D9A\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2134\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C7B\u2C7E-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\uA640-\uA66D\uA680-\uA69B\uA722-\uA76F\uA771-\uA787\uA78B-\uA78E\uA790-\uA7CA\uA7D0\uA7D1\uA7D3\uA7D5-\uA7D9\uA7F5\uA7F6\uA7FA\uAB30-\uAB5A\uAB60-\uAB68\uAB70-\uABBF\uFB00-\uFB06\uFB13-\uFB17\uFF21-\uFF3A\uFF41-\uFF5A',
        'astral': '\uD801[\uDC00-\uDC4F\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD70-\uDD7A\uDD7C-\uDD8A\uDD8C-\uDD92\uDD94\uDD95\uDD97-\uDDA1\uDDA3-\uDDB1\uDDB3-\uDDB9\uDDBB\uDDBC]|\uD803[\uDC80-\uDCB2\uDCC0-\uDCF2]|\uD806[\uDCA0-\uDCDF]|\uD81B[\uDE40-\uDE7F]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB]|\uD837[\uDF00-\uDF09\uDF0B-\uDF1E]|\uD83A[\uDD00-\uDD43]'
    },
    {
        'name': 'Ll',
        'alias': 'Lowercase_Letter',
        'bmp': 'a-z\xB5\xDF-\xF6\xF8-\xFF\u0101\u0103\u0105\u0107\u0109\u010B\u010D\u010F\u0111\u0113\u0115\u0117\u0119\u011B\u011D\u011F\u0121\u0123\u0125\u0127\u0129\u012B\u012D\u012F\u0131\u0133\u0135\u0137\u0138\u013A\u013C\u013E\u0140\u0142\u0144\u0146\u0148\u0149\u014B\u014D\u014F\u0151\u0153\u0155\u0157\u0159\u015B\u015D\u015F\u0161\u0163\u0165\u0167\u0169\u016B\u016D\u016F\u0171\u0173\u0175\u0177\u017A\u017C\u017E-\u0180\u0183\u0185\u0188\u018C\u018D\u0192\u0195\u0199-\u019B\u019E\u01A1\u01A3\u01A5\u01A8\u01AA\u01AB\u01AD\u01B0\u01B4\u01B6\u01B9\u01BA\u01BD-\u01BF\u01C6\u01C9\u01CC\u01CE\u01D0\u01D2\u01D4\u01D6\u01D8\u01DA\u01DC\u01DD\u01DF\u01E1\u01E3\u01E5\u01E7\u01E9\u01EB\u01ED\u01EF\u01F0\u01F3\u01F5\u01F9\u01FB\u01FD\u01FF\u0201\u0203\u0205\u0207\u0209\u020B\u020D\u020F\u0211\u0213\u0215\u0217\u0219\u021B\u021D\u021F\u0221\u0223\u0225\u0227\u0229\u022B\u022D\u022F\u0231\u0233-\u0239\u023C\u023F\u0240\u0242\u0247\u0249\u024B\u024D\u024F-\u0293\u0295-\u02AF\u0371\u0373\u0377\u037B-\u037D\u0390\u03AC-\u03CE\u03D0\u03D1\u03D5-\u03D7\u03D9\u03DB\u03DD\u03DF\u03E1\u03E3\u03E5\u03E7\u03E9\u03EB\u03ED\u03EF-\u03F3\u03F5\u03F8\u03FB\u03FC\u0430-\u045F\u0461\u0463\u0465\u0467\u0469\u046B\u046D\u046F\u0471\u0473\u0475\u0477\u0479\u047B\u047D\u047F\u0481\u048B\u048D\u048F\u0491\u0493\u0495\u0497\u0499\u049B\u049D\u049F\u04A1\u04A3\u04A5\u04A7\u04A9\u04AB\u04AD\u04AF\u04B1\u04B3\u04B5\u04B7\u04B9\u04BB\u04BD\u04BF\u04C2\u04C4\u04C6\u04C8\u04CA\u04CC\u04CE\u04CF\u04D1\u04D3\u04D5\u04D7\u04D9\u04DB\u04DD\u04DF\u04E1\u04E3\u04E5\u04E7\u04E9\u04EB\u04ED\u04EF\u04F1\u04F3\u04F5\u04F7\u04F9\u04FB\u04FD\u04FF\u0501\u0503\u0505\u0507\u0509\u050B\u050D\u050F\u0511\u0513\u0515\u0517\u0519\u051B\u051D\u051F\u0521\u0523\u0525\u0527\u0529\u052B\u052D\u052F\u0560-\u0588\u10D0-\u10FA\u10FD-\u10FF\u13F8-\u13FD\u1C80-\u1C88\u1D00-\u1D2B\u1D6B-\u1D77\u1D79-\u1D9A\u1E01\u1E03\u1E05\u1E07\u1E09\u1E0B\u1E0D\u1E0F\u1E11\u1E13\u1E15\u1E17\u1E19\u1E1B\u1E1D\u1E1F\u1E21\u1E23\u1E25\u1E27\u1E29\u1E2B\u1E2D\u1E2F\u1E31\u1E33\u1E35\u1E37\u1E39\u1E3B\u1E3D\u1E3F\u1E41\u1E43\u1E45\u1E47\u1E49\u1E4B\u1E4D\u1E4F\u1E51\u1E53\u1E55\u1E57\u1E59\u1E5B\u1E5D\u1E5F\u1E61\u1E63\u1E65\u1E67\u1E69\u1E6B\u1E6D\u1E6F\u1E71\u1E73\u1E75\u1E77\u1E79\u1E7B\u1E7D\u1E7F\u1E81\u1E83\u1E85\u1E87\u1E89\u1E8B\u1E8D\u1E8F\u1E91\u1E93\u1E95-\u1E9D\u1E9F\u1EA1\u1EA3\u1EA5\u1EA7\u1EA9\u1EAB\u1EAD\u1EAF\u1EB1\u1EB3\u1EB5\u1EB7\u1EB9\u1EBB\u1EBD\u1EBF\u1EC1\u1EC3\u1EC5\u1EC7\u1EC9\u1ECB\u1ECD\u1ECF\u1ED1\u1ED3\u1ED5\u1ED7\u1ED9\u1EDB\u1EDD\u1EDF\u1EE1\u1EE3\u1EE5\u1EE7\u1EE9\u1EEB\u1EED\u1EEF\u1EF1\u1EF3\u1EF5\u1EF7\u1EF9\u1EFB\u1EFD\u1EFF-\u1F07\u1F10-\u1F15\u1F20-\u1F27\u1F30-\u1F37\u1F40-\u1F45\u1F50-\u1F57\u1F60-\u1F67\u1F70-\u1F7D\u1F80-\u1F87\u1F90-\u1F97\u1FA0-\u1FA7\u1FB0-\u1FB4\u1FB6\u1FB7\u1FBE\u1FC2-\u1FC4\u1FC6\u1FC7\u1FD0-\u1FD3\u1FD6\u1FD7\u1FE0-\u1FE7\u1FF2-\u1FF4\u1FF6\u1FF7\u210A\u210E\u210F\u2113\u212F\u2134\u2139\u213C\u213D\u2146-\u2149\u214E\u2184\u2C30-\u2C5F\u2C61\u2C65\u2C66\u2C68\u2C6A\u2C6C\u2C71\u2C73\u2C74\u2C76-\u2C7B\u2C81\u2C83\u2C85\u2C87\u2C89\u2C8B\u2C8D\u2C8F\u2C91\u2C93\u2C95\u2C97\u2C99\u2C9B\u2C9D\u2C9F\u2CA1\u2CA3\u2CA5\u2CA7\u2CA9\u2CAB\u2CAD\u2CAF\u2CB1\u2CB3\u2CB5\u2CB7\u2CB9\u2CBB\u2CBD\u2CBF\u2CC1\u2CC3\u2CC5\u2CC7\u2CC9\u2CCB\u2CCD\u2CCF\u2CD1\u2CD3\u2CD5\u2CD7\u2CD9\u2CDB\u2CDD\u2CDF\u2CE1\u2CE3\u2CE4\u2CEC\u2CEE\u2CF3\u2D00-\u2D25\u2D27\u2D2D\uA641\uA643\uA645\uA647\uA649\uA64B\uA64D\uA64F\uA651\uA653\uA655\uA657\uA659\uA65B\uA65D\uA65F\uA661\uA663\uA665\uA667\uA669\uA66B\uA66D\uA681\uA683\uA685\uA687\uA689\uA68B\uA68D\uA68F\uA691\uA693\uA695\uA697\uA699\uA69B\uA723\uA725\uA727\uA729\uA72B\uA72D\uA72F-\uA731\uA733\uA735\uA737\uA739\uA73B\uA73D\uA73F\uA741\uA743\uA745\uA747\uA749\uA74B\uA74D\uA74F\uA751\uA753\uA755\uA757\uA759\uA75B\uA75D\uA75F\uA761\uA763\uA765\uA767\uA769\uA76B\uA76D\uA76F\uA771-\uA778\uA77A\uA77C\uA77F\uA781\uA783\uA785\uA787\uA78C\uA78E\uA791\uA793-\uA795\uA797\uA799\uA79B\uA79D\uA79F\uA7A1\uA7A3\uA7A5\uA7A7\uA7A9\uA7AF\uA7B5\uA7B7\uA7B9\uA7BB\uA7BD\uA7BF\uA7C1\uA7C3\uA7C8\uA7CA\uA7D1\uA7D3\uA7D5\uA7D7\uA7D9\uA7F6\uA7FA\uAB30-\uAB5A\uAB60-\uAB68\uAB70-\uABBF\uFB00-\uFB06\uFB13-\uFB17\uFF41-\uFF5A',
        'astral': '\uD801[\uDC28-\uDC4F\uDCD8-\uDCFB\uDD97-\uDDA1\uDDA3-\uDDB1\uDDB3-\uDDB9\uDDBB\uDDBC]|\uD803[\uDCC0-\uDCF2]|\uD806[\uDCC0-\uDCDF]|\uD81B[\uDE60-\uDE7F]|\uD835[\uDC1A-\uDC33\uDC4E-\uDC54\uDC56-\uDC67\uDC82-\uDC9B\uDCB6-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDCCF\uDCEA-\uDD03\uDD1E-\uDD37\uDD52-\uDD6B\uDD86-\uDD9F\uDDBA-\uDDD3\uDDEE-\uDE07\uDE22-\uDE3B\uDE56-\uDE6F\uDE8A-\uDEA5\uDEC2-\uDEDA\uDEDC-\uDEE1\uDEFC-\uDF14\uDF16-\uDF1B\uDF36-\uDF4E\uDF50-\uDF55\uDF70-\uDF88\uDF8A-\uDF8F\uDFAA-\uDFC2\uDFC4-\uDFC9\uDFCB]|\uD837[\uDF00-\uDF09\uDF0B-\uDF1E]|\uD83A[\uDD22-\uDD43]'
    },
    {
        'name': 'Lm',
        'alias': 'Modifier_Letter',
        'bmp': '\u02B0-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0374\u037A\u0559\u0640\u06E5\u06E6\u07F4\u07F5\u07FA\u081A\u0824\u0828\u08C9\u0971\u0E46\u0EC6\u10FC\u17D7\u1843\u1AA7\u1C78-\u1C7D\u1D2C-\u1D6A\u1D78\u1D9B-\u1DBF\u2071\u207F\u2090-\u209C\u2C7C\u2C7D\u2D6F\u2E2F\u3005\u3031-\u3035\u303B\u309D\u309E\u30FC-\u30FE\uA015\uA4F8-\uA4FD\uA60C\uA67F\uA69C\uA69D\uA717-\uA71F\uA770\uA788\uA7F2-\uA7F4\uA7F8\uA7F9\uA9CF\uA9E6\uAA70\uAADD\uAAF3\uAAF4\uAB5C-\uAB5F\uAB69\uFF70\uFF9E\uFF9F',
        'astral': '\uD801[\uDF80-\uDF85\uDF87-\uDFB0\uDFB2-\uDFBA]|\uD81A[\uDF40-\uDF43]|\uD81B[\uDF93-\uDF9F\uDFE0\uDFE1\uDFE3]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD838[\uDD37-\uDD3D]|\uD83A\uDD4B'
    },
    {
        'name': 'Lo',
        'alias': 'Other_Letter',
        'bmp': '\xAA\xBA\u01BB\u01C0-\u01C3\u0294\u05D0-\u05EA\u05EF-\u05F2\u0620-\u063F\u0641-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u0800-\u0815\u0840-\u0858\u0860-\u086A\u0870-\u0887\u0889-\u088E\u08A0-\u08C8\u0904-\u0939\u093D\u0950\u0958-\u0961\u0972-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u09FC\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0AF9\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58-\u0C5A\u0C5D\u0C60\u0C61\u0C80\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D04-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D54-\u0D56\u0D5F-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E45\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u1100-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16F1-\u16F8\u1700-\u1711\u171F-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17DC\u1820-\u1842\u1844-\u1878\u1880-\u1884\u1887-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u1A00-\u1A16\u1A20-\u1A54\u1B05-\u1B33\u1B45-\u1B4C\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C77\u1CE9-\u1CEC\u1CEE-\u1CF3\u1CF5\u1CF6\u1CFA\u2135-\u2138\u2D30-\u2D67\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3006\u303C\u3041-\u3096\u309F\u30A1-\u30FA\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u31BF\u31F0-\u31FF\u3400-\u4DBF\u4E00-\uA014\uA016-\uA48C\uA4D0-\uA4F7\uA500-\uA60B\uA610-\uA61F\uA62A\uA62B\uA66E\uA6A0-\uA6E5\uA78F\uA7F7\uA7FB-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA8FD\uA8FE\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9E0-\uA9E4\uA9E7-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA6F\uAA71-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB\uAADC\uAAE0-\uAAEA\uAAF2\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF66-\uFF6F\uFF71-\uFF9D\uFFA0-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC',
        'astral': '\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDE80-\uDE9C\uDEA0-\uDED0\uDF00-\uDF1F\uDF2D-\uDF40\uDF42-\uDF49\uDF50-\uDF75\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF]|\uD801[\uDC50-\uDC9D\uDD00-\uDD27\uDD30-\uDD63\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDCE0-\uDCF2\uDCF4\uDCF5\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00\uDE10-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE4\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48\uDD00-\uDD23\uDE80-\uDEA9\uDEB0\uDEB1\uDF00-\uDF1C\uDF27\uDF30-\uDF45\uDF70-\uDF81\uDFB0-\uDFC4\uDFE0-\uDFF6]|\uD804[\uDC03-\uDC37\uDC71\uDC72\uDC75\uDC83-\uDCAF\uDCD0-\uDCE8\uDD03-\uDD26\uDD44\uDD47\uDD50-\uDD72\uDD76\uDD83-\uDDB2\uDDC1-\uDDC4\uDDDA\uDDDC\uDE00-\uDE11\uDE13-\uDE2B\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEDE\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3D\uDF50\uDF5D-\uDF61]|\uD805[\uDC00-\uDC34\uDC47-\uDC4A\uDC5F-\uDC61\uDC80-\uDCAF\uDCC4\uDCC5\uDCC7\uDD80-\uDDAE\uDDD8-\uDDDB\uDE00-\uDE2F\uDE44\uDE80-\uDEAA\uDEB8\uDF00-\uDF1A\uDF40-\uDF46]|\uD806[\uDC00-\uDC2B\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD2F\uDD3F\uDD41\uDDA0-\uDDA7\uDDAA-\uDDD0\uDDE1\uDDE3\uDE00\uDE0B-\uDE32\uDE3A\uDE50\uDE5C-\uDE89\uDE9D\uDEB0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC2E\uDC40\uDC72-\uDC8F\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD30\uDD46\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD89\uDD98\uDEE0-\uDEF2\uDFB0]|\uD808[\uDC00-\uDF99]|\uD809[\uDC80-\uDD43]|\uD80B[\uDF90-\uDFF0]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE70-\uDEBE\uDED0-\uDEED\uDF00-\uDF2F\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDF00-\uDF4A\uDF50]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82C[\uDC00-\uDD22\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99]|\uD837\uDF0A|\uD838[\uDD00-\uDD2C\uDD4E\uDE90-\uDEAD\uDEC0-\uDEEB]|\uD839[\uDFE0-\uDFE6\uDFE8-\uDFEB\uDFED\uDFEE\uDFF0-\uDFFE]|\uD83A[\uDC00-\uDCC4]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF38\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A]'
    },
    {
        'name': 'Lt',
        'alias': 'Titlecase_Letter',
        'bmp': '\u01C5\u01C8\u01CB\u01F2\u1F88-\u1F8F\u1F98-\u1F9F\u1FA8-\u1FAF\u1FBC\u1FCC\u1FFC'
    },
    {
        'name': 'Lu',
        'alias': 'Uppercase_Letter',
        'bmp': 'A-Z\xC0-\xD6\xD8-\xDE\u0100\u0102\u0104\u0106\u0108\u010A\u010C\u010E\u0110\u0112\u0114\u0116\u0118\u011A\u011C\u011E\u0120\u0122\u0124\u0126\u0128\u012A\u012C\u012E\u0130\u0132\u0134\u0136\u0139\u013B\u013D\u013F\u0141\u0143\u0145\u0147\u014A\u014C\u014E\u0150\u0152\u0154\u0156\u0158\u015A\u015C\u015E\u0160\u0162\u0164\u0166\u0168\u016A\u016C\u016E\u0170\u0172\u0174\u0176\u0178\u0179\u017B\u017D\u0181\u0182\u0184\u0186\u0187\u0189-\u018B\u018E-\u0191\u0193\u0194\u0196-\u0198\u019C\u019D\u019F\u01A0\u01A2\u01A4\u01A6\u01A7\u01A9\u01AC\u01AE\u01AF\u01B1-\u01B3\u01B5\u01B7\u01B8\u01BC\u01C4\u01C7\u01CA\u01CD\u01CF\u01D1\u01D3\u01D5\u01D7\u01D9\u01DB\u01DE\u01E0\u01E2\u01E4\u01E6\u01E8\u01EA\u01EC\u01EE\u01F1\u01F4\u01F6-\u01F8\u01FA\u01FC\u01FE\u0200\u0202\u0204\u0206\u0208\u020A\u020C\u020E\u0210\u0212\u0214\u0216\u0218\u021A\u021C\u021E\u0220\u0222\u0224\u0226\u0228\u022A\u022C\u022E\u0230\u0232\u023A\u023B\u023D\u023E\u0241\u0243-\u0246\u0248\u024A\u024C\u024E\u0370\u0372\u0376\u037F\u0386\u0388-\u038A\u038C\u038E\u038F\u0391-\u03A1\u03A3-\u03AB\u03CF\u03D2-\u03D4\u03D8\u03DA\u03DC\u03DE\u03E0\u03E2\u03E4\u03E6\u03E8\u03EA\u03EC\u03EE\u03F4\u03F7\u03F9\u03FA\u03FD-\u042F\u0460\u0462\u0464\u0466\u0468\u046A\u046C\u046E\u0470\u0472\u0474\u0476\u0478\u047A\u047C\u047E\u0480\u048A\u048C\u048E\u0490\u0492\u0494\u0496\u0498\u049A\u049C\u049E\u04A0\u04A2\u04A4\u04A6\u04A8\u04AA\u04AC\u04AE\u04B0\u04B2\u04B4\u04B6\u04B8\u04BA\u04BC\u04BE\u04C0\u04C1\u04C3\u04C5\u04C7\u04C9\u04CB\u04CD\u04D0\u04D2\u04D4\u04D6\u04D8\u04DA\u04DC\u04DE\u04E0\u04E2\u04E4\u04E6\u04E8\u04EA\u04EC\u04EE\u04F0\u04F2\u04F4\u04F6\u04F8\u04FA\u04FC\u04FE\u0500\u0502\u0504\u0506\u0508\u050A\u050C\u050E\u0510\u0512\u0514\u0516\u0518\u051A\u051C\u051E\u0520\u0522\u0524\u0526\u0528\u052A\u052C\u052E\u0531-\u0556\u10A0-\u10C5\u10C7\u10CD\u13A0-\u13F5\u1C90-\u1CBA\u1CBD-\u1CBF\u1E00\u1E02\u1E04\u1E06\u1E08\u1E0A\u1E0C\u1E0E\u1E10\u1E12\u1E14\u1E16\u1E18\u1E1A\u1E1C\u1E1E\u1E20\u1E22\u1E24\u1E26\u1E28\u1E2A\u1E2C\u1E2E\u1E30\u1E32\u1E34\u1E36\u1E38\u1E3A\u1E3C\u1E3E\u1E40\u1E42\u1E44\u1E46\u1E48\u1E4A\u1E4C\u1E4E\u1E50\u1E52\u1E54\u1E56\u1E58\u1E5A\u1E5C\u1E5E\u1E60\u1E62\u1E64\u1E66\u1E68\u1E6A\u1E6C\u1E6E\u1E70\u1E72\u1E74\u1E76\u1E78\u1E7A\u1E7C\u1E7E\u1E80\u1E82\u1E84\u1E86\u1E88\u1E8A\u1E8C\u1E8E\u1E90\u1E92\u1E94\u1E9E\u1EA0\u1EA2\u1EA4\u1EA6\u1EA8\u1EAA\u1EAC\u1EAE\u1EB0\u1EB2\u1EB4\u1EB6\u1EB8\u1EBA\u1EBC\u1EBE\u1EC0\u1EC2\u1EC4\u1EC6\u1EC8\u1ECA\u1ECC\u1ECE\u1ED0\u1ED2\u1ED4\u1ED6\u1ED8\u1EDA\u1EDC\u1EDE\u1EE0\u1EE2\u1EE4\u1EE6\u1EE8\u1EEA\u1EEC\u1EEE\u1EF0\u1EF2\u1EF4\u1EF6\u1EF8\u1EFA\u1EFC\u1EFE\u1F08-\u1F0F\u1F18-\u1F1D\u1F28-\u1F2F\u1F38-\u1F3F\u1F48-\u1F4D\u1F59\u1F5B\u1F5D\u1F5F\u1F68-\u1F6F\u1FB8-\u1FBB\u1FC8-\u1FCB\u1FD8-\u1FDB\u1FE8-\u1FEC\u1FF8-\u1FFB\u2102\u2107\u210B-\u210D\u2110-\u2112\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u2130-\u2133\u213E\u213F\u2145\u2183\u2C00-\u2C2F\u2C60\u2C62-\u2C64\u2C67\u2C69\u2C6B\u2C6D-\u2C70\u2C72\u2C75\u2C7E-\u2C80\u2C82\u2C84\u2C86\u2C88\u2C8A\u2C8C\u2C8E\u2C90\u2C92\u2C94\u2C96\u2C98\u2C9A\u2C9C\u2C9E\u2CA0\u2CA2\u2CA4\u2CA6\u2CA8\u2CAA\u2CAC\u2CAE\u2CB0\u2CB2\u2CB4\u2CB6\u2CB8\u2CBA\u2CBC\u2CBE\u2CC0\u2CC2\u2CC4\u2CC6\u2CC8\u2CCA\u2CCC\u2CCE\u2CD0\u2CD2\u2CD4\u2CD6\u2CD8\u2CDA\u2CDC\u2CDE\u2CE0\u2CE2\u2CEB\u2CED\u2CF2\uA640\uA642\uA644\uA646\uA648\uA64A\uA64C\uA64E\uA650\uA652\uA654\uA656\uA658\uA65A\uA65C\uA65E\uA660\uA662\uA664\uA666\uA668\uA66A\uA66C\uA680\uA682\uA684\uA686\uA688\uA68A\uA68C\uA68E\uA690\uA692\uA694\uA696\uA698\uA69A\uA722\uA724\uA726\uA728\uA72A\uA72C\uA72E\uA732\uA734\uA736\uA738\uA73A\uA73C\uA73E\uA740\uA742\uA744\uA746\uA748\uA74A\uA74C\uA74E\uA750\uA752\uA754\uA756\uA758\uA75A\uA75C\uA75E\uA760\uA762\uA764\uA766\uA768\uA76A\uA76C\uA76E\uA779\uA77B\uA77D\uA77E\uA780\uA782\uA784\uA786\uA78B\uA78D\uA790\uA792\uA796\uA798\uA79A\uA79C\uA79E\uA7A0\uA7A2\uA7A4\uA7A6\uA7A8\uA7AA-\uA7AE\uA7B0-\uA7B4\uA7B6\uA7B8\uA7BA\uA7BC\uA7BE\uA7C0\uA7C2\uA7C4-\uA7C7\uA7C9\uA7D0\uA7D6\uA7D8\uA7F5\uFF21-\uFF3A',
        'astral': '\uD801[\uDC00-\uDC27\uDCB0-\uDCD3\uDD70-\uDD7A\uDD7C-\uDD8A\uDD8C-\uDD92\uDD94\uDD95]|\uD803[\uDC80-\uDCB2]|\uD806[\uDCA0-\uDCBF]|\uD81B[\uDE40-\uDE5F]|\uD835[\uDC00-\uDC19\uDC34-\uDC4D\uDC68-\uDC81\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB5\uDCD0-\uDCE9\uDD04\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD38\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD6C-\uDD85\uDDA0-\uDDB9\uDDD4-\uDDED\uDE08-\uDE21\uDE3C-\uDE55\uDE70-\uDE89\uDEA8-\uDEC0\uDEE2-\uDEFA\uDF1C-\uDF34\uDF56-\uDF6E\uDF90-\uDFA8\uDFCA]|\uD83A[\uDD00-\uDD21]'
    },
    {
        'name': 'M',
        'alias': 'Mark',
        'bmp': '\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u0898-\u089F\u08CA-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B55-\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C04\u0C3C\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D81-\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1715\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u180F\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ACE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA82C\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F',
        'astral': '\uD800[\uDDFD\uDEE0\uDF76-\uDF7A]|\uD802[\uDE01-\uDE03\uDE05\uDE06\uDE0C-\uDE0F\uDE38-\uDE3A\uDE3F\uDEE5\uDEE6]|\uD803[\uDD24-\uDD27\uDEAB\uDEAC\uDF46-\uDF50\uDF82-\uDF85]|\uD804[\uDC00-\uDC02\uDC38-\uDC46\uDC70\uDC73\uDC74\uDC7F-\uDC82\uDCB0-\uDCBA\uDCC2\uDD00-\uDD02\uDD27-\uDD34\uDD45\uDD46\uDD73\uDD80-\uDD82\uDDB3-\uDDC0\uDDC9-\uDDCC\uDDCE\uDDCF\uDE2C-\uDE37\uDE3E\uDEDF-\uDEEA\uDF00-\uDF03\uDF3B\uDF3C\uDF3E-\uDF44\uDF47\uDF48\uDF4B-\uDF4D\uDF57\uDF62\uDF63\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC35-\uDC46\uDC5E\uDCB0-\uDCC3\uDDAF-\uDDB5\uDDB8-\uDDC0\uDDDC\uDDDD\uDE30-\uDE40\uDEAB-\uDEB7\uDF1D-\uDF2B]|\uD806[\uDC2C-\uDC3A\uDD30-\uDD35\uDD37\uDD38\uDD3B-\uDD3E\uDD40\uDD42\uDD43\uDDD1-\uDDD7\uDDDA-\uDDE0\uDDE4\uDE01-\uDE0A\uDE33-\uDE39\uDE3B-\uDE3E\uDE47\uDE51-\uDE5B\uDE8A-\uDE99]|\uD807[\uDC2F-\uDC36\uDC38-\uDC3F\uDC92-\uDCA7\uDCA9-\uDCB6\uDD31-\uDD36\uDD3A\uDD3C\uDD3D\uDD3F-\uDD45\uDD47\uDD8A-\uDD8E\uDD90\uDD91\uDD93-\uDD97\uDEF3-\uDEF6]|\uD81A[\uDEF0-\uDEF4\uDF30-\uDF36]|\uD81B[\uDF4F\uDF51-\uDF87\uDF8F-\uDF92\uDFE4\uDFF0\uDFF1]|\uD82F[\uDC9D\uDC9E]|\uD833[\uDF00-\uDF2D\uDF30-\uDF46]|\uD834[\uDD65-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD\uDE42-\uDE44]|\uD836[\uDE00-\uDE36\uDE3B-\uDE6C\uDE75\uDE84\uDE9B-\uDE9F\uDEA1-\uDEAF]|\uD838[\uDC00-\uDC06\uDC08-\uDC18\uDC1B-\uDC21\uDC23\uDC24\uDC26-\uDC2A\uDD30-\uDD36\uDEAE\uDEEC-\uDEEF]|\uD83A[\uDCD0-\uDCD6\uDD44-\uDD4A]|\uDB40[\uDD00-\uDDEF]'
    },
    {
        'name': 'Mc',
        'alias': 'Spacing_Mark',
        'bmp': '\u0903\u093B\u093E-\u0940\u0949-\u094C\u094E\u094F\u0982\u0983\u09BE-\u09C0\u09C7\u09C8\u09CB\u09CC\u09D7\u0A03\u0A3E-\u0A40\u0A83\u0ABE-\u0AC0\u0AC9\u0ACB\u0ACC\u0B02\u0B03\u0B3E\u0B40\u0B47\u0B48\u0B4B\u0B4C\u0B57\u0BBE\u0BBF\u0BC1\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCC\u0BD7\u0C01-\u0C03\u0C41-\u0C44\u0C82\u0C83\u0CBE\u0CC0-\u0CC4\u0CC7\u0CC8\u0CCA\u0CCB\u0CD5\u0CD6\u0D02\u0D03\u0D3E-\u0D40\u0D46-\u0D48\u0D4A-\u0D4C\u0D57\u0D82\u0D83\u0DCF-\u0DD1\u0DD8-\u0DDF\u0DF2\u0DF3\u0F3E\u0F3F\u0F7F\u102B\u102C\u1031\u1038\u103B\u103C\u1056\u1057\u1062-\u1064\u1067-\u106D\u1083\u1084\u1087-\u108C\u108F\u109A-\u109C\u1715\u1734\u17B6\u17BE-\u17C5\u17C7\u17C8\u1923-\u1926\u1929-\u192B\u1930\u1931\u1933-\u1938\u1A19\u1A1A\u1A55\u1A57\u1A61\u1A63\u1A64\u1A6D-\u1A72\u1B04\u1B35\u1B3B\u1B3D-\u1B41\u1B43\u1B44\u1B82\u1BA1\u1BA6\u1BA7\u1BAA\u1BE7\u1BEA-\u1BEC\u1BEE\u1BF2\u1BF3\u1C24-\u1C2B\u1C34\u1C35\u1CE1\u1CF7\u302E\u302F\uA823\uA824\uA827\uA880\uA881\uA8B4-\uA8C3\uA952\uA953\uA983\uA9B4\uA9B5\uA9BA\uA9BB\uA9BE-\uA9C0\uAA2F\uAA30\uAA33\uAA34\uAA4D\uAA7B\uAA7D\uAAEB\uAAEE\uAAEF\uAAF5\uABE3\uABE4\uABE6\uABE7\uABE9\uABEA\uABEC',
        'astral': '\uD804[\uDC00\uDC02\uDC82\uDCB0-\uDCB2\uDCB7\uDCB8\uDD2C\uDD45\uDD46\uDD82\uDDB3-\uDDB5\uDDBF\uDDC0\uDDCE\uDE2C-\uDE2E\uDE32\uDE33\uDE35\uDEE0-\uDEE2\uDF02\uDF03\uDF3E\uDF3F\uDF41-\uDF44\uDF47\uDF48\uDF4B-\uDF4D\uDF57\uDF62\uDF63]|\uD805[\uDC35-\uDC37\uDC40\uDC41\uDC45\uDCB0-\uDCB2\uDCB9\uDCBB-\uDCBE\uDCC1\uDDAF-\uDDB1\uDDB8-\uDDBB\uDDBE\uDE30-\uDE32\uDE3B\uDE3C\uDE3E\uDEAC\uDEAE\uDEAF\uDEB6\uDF20\uDF21\uDF26]|\uD806[\uDC2C-\uDC2E\uDC38\uDD30-\uDD35\uDD37\uDD38\uDD3D\uDD40\uDD42\uDDD1-\uDDD3\uDDDC-\uDDDF\uDDE4\uDE39\uDE57\uDE58\uDE97]|\uD807[\uDC2F\uDC3E\uDCA9\uDCB1\uDCB4\uDD8A-\uDD8E\uDD93\uDD94\uDD96\uDEF5\uDEF6]|\uD81B[\uDF51-\uDF87\uDFF0\uDFF1]|\uD834[\uDD65\uDD66\uDD6D-\uDD72]'
    },
    {
        'name': 'Me',
        'alias': 'Enclosing_Mark',
        'bmp': '\u0488\u0489\u1ABE\u20DD-\u20E0\u20E2-\u20E4\uA670-\uA672'
    },
    {
        'name': 'Mn',
        'alias': 'Nonspacing_Mark',
        'bmp': '\u0300-\u036F\u0483-\u0487\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u0898-\u089F\u08CA-\u08E1\u08E3-\u0902\u093A\u093C\u0941-\u0948\u094D\u0951-\u0957\u0962\u0963\u0981\u09BC\u09C1-\u09C4\u09CD\u09E2\u09E3\u09FE\u0A01\u0A02\u0A3C\u0A41\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81\u0A82\u0ABC\u0AC1-\u0AC5\u0AC7\u0AC8\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01\u0B3C\u0B3F\u0B41-\u0B44\u0B4D\u0B55\u0B56\u0B62\u0B63\u0B82\u0BC0\u0BCD\u0C00\u0C04\u0C3C\u0C3E-\u0C40\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81\u0CBC\u0CBF\u0CC6\u0CCC\u0CCD\u0CE2\u0CE3\u0D00\u0D01\u0D3B\u0D3C\u0D41-\u0D44\u0D4D\u0D62\u0D63\u0D81\u0DCA\u0DD2-\u0DD4\u0DD6\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F71-\u0F7E\u0F80-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102D-\u1030\u1032-\u1037\u1039\u103A\u103D\u103E\u1058\u1059\u105E-\u1060\u1071-\u1074\u1082\u1085\u1086\u108D\u109D\u135D-\u135F\u1712-\u1714\u1732\u1733\u1752\u1753\u1772\u1773\u17B4\u17B5\u17B7-\u17BD\u17C6\u17C9-\u17D3\u17DD\u180B-\u180D\u180F\u1885\u1886\u18A9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193B\u1A17\u1A18\u1A1B\u1A56\u1A58-\u1A5E\u1A60\u1A62\u1A65-\u1A6C\u1A73-\u1A7C\u1A7F\u1AB0-\u1ABD\u1ABF-\u1ACE\u1B00-\u1B03\u1B34\u1B36-\u1B3A\u1B3C\u1B42\u1B6B-\u1B73\u1B80\u1B81\u1BA2-\u1BA5\u1BA8\u1BA9\u1BAB-\u1BAD\u1BE6\u1BE8\u1BE9\u1BED\u1BEF-\u1BF1\u1C2C-\u1C33\u1C36\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE0\u1CE2-\u1CE8\u1CED\u1CF4\u1CF8\u1CF9\u1DC0-\u1DFF\u20D0-\u20DC\u20E1\u20E5-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302D\u3099\u309A\uA66F\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA825\uA826\uA82C\uA8C4\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA951\uA980-\uA982\uA9B3\uA9B6-\uA9B9\uA9BC\uA9BD\uA9E5\uAA29-\uAA2E\uAA31\uAA32\uAA35\uAA36\uAA43\uAA4C\uAA7C\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEC\uAAED\uAAF6\uABE5\uABE8\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F',
        'astral': '\uD800[\uDDFD\uDEE0\uDF76-\uDF7A]|\uD802[\uDE01-\uDE03\uDE05\uDE06\uDE0C-\uDE0F\uDE38-\uDE3A\uDE3F\uDEE5\uDEE6]|\uD803[\uDD24-\uDD27\uDEAB\uDEAC\uDF46-\uDF50\uDF82-\uDF85]|\uD804[\uDC01\uDC38-\uDC46\uDC70\uDC73\uDC74\uDC7F-\uDC81\uDCB3-\uDCB6\uDCB9\uDCBA\uDCC2\uDD00-\uDD02\uDD27-\uDD2B\uDD2D-\uDD34\uDD73\uDD80\uDD81\uDDB6-\uDDBE\uDDC9-\uDDCC\uDDCF\uDE2F-\uDE31\uDE34\uDE36\uDE37\uDE3E\uDEDF\uDEE3-\uDEEA\uDF00\uDF01\uDF3B\uDF3C\uDF40\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC38-\uDC3F\uDC42-\uDC44\uDC46\uDC5E\uDCB3-\uDCB8\uDCBA\uDCBF\uDCC0\uDCC2\uDCC3\uDDB2-\uDDB5\uDDBC\uDDBD\uDDBF\uDDC0\uDDDC\uDDDD\uDE33-\uDE3A\uDE3D\uDE3F\uDE40\uDEAB\uDEAD\uDEB0-\uDEB5\uDEB7\uDF1D-\uDF1F\uDF22-\uDF25\uDF27-\uDF2B]|\uD806[\uDC2F-\uDC37\uDC39\uDC3A\uDD3B\uDD3C\uDD3E\uDD43\uDDD4-\uDDD7\uDDDA\uDDDB\uDDE0\uDE01-\uDE0A\uDE33-\uDE38\uDE3B-\uDE3E\uDE47\uDE51-\uDE56\uDE59-\uDE5B\uDE8A-\uDE96\uDE98\uDE99]|\uD807[\uDC30-\uDC36\uDC38-\uDC3D\uDC3F\uDC92-\uDCA7\uDCAA-\uDCB0\uDCB2\uDCB3\uDCB5\uDCB6\uDD31-\uDD36\uDD3A\uDD3C\uDD3D\uDD3F-\uDD45\uDD47\uDD90\uDD91\uDD95\uDD97\uDEF3\uDEF4]|\uD81A[\uDEF0-\uDEF4\uDF30-\uDF36]|\uD81B[\uDF4F\uDF8F-\uDF92\uDFE4]|\uD82F[\uDC9D\uDC9E]|\uD833[\uDF00-\uDF2D\uDF30-\uDF46]|\uD834[\uDD67-\uDD69\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD\uDE42-\uDE44]|\uD836[\uDE00-\uDE36\uDE3B-\uDE6C\uDE75\uDE84\uDE9B-\uDE9F\uDEA1-\uDEAF]|\uD838[\uDC00-\uDC06\uDC08-\uDC18\uDC1B-\uDC21\uDC23\uDC24\uDC26-\uDC2A\uDD30-\uDD36\uDEAE\uDEEC-\uDEEF]|\uD83A[\uDCD0-\uDCD6\uDD44-\uDD4A]|\uDB40[\uDD00-\uDDEF]'
    },
    {
        'name': 'N',
        'alias': 'Number',
        'bmp': '0-9\xB2\xB3\xB9\xBC-\xBE\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u09F4-\u09F9\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0B72-\u0B77\u0BE6-\u0BF2\u0C66-\u0C6F\u0C78-\u0C7E\u0CE6-\u0CEF\u0D58-\u0D5E\u0D66-\u0D78\u0DE6-\u0DEF\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F33\u1040-\u1049\u1090-\u1099\u1369-\u137C\u16EE-\u16F0\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1946-\u194F\u19D0-\u19DA\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\u2070\u2074-\u2079\u2080-\u2089\u2150-\u2182\u2185-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2CFD\u3007\u3021-\u3029\u3038-\u303A\u3192-\u3195\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\uA620-\uA629\uA6E6-\uA6EF\uA830-\uA835\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uA9F0-\uA9F9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19',
        'astral': '\uD800[\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDEE1-\uDEFB\uDF20-\uDF23\uDF41\uDF4A\uDFD1-\uDFD5]|\uD801[\uDCA0-\uDCA9]|\uD802[\uDC58-\uDC5F\uDC79-\uDC7F\uDCA7-\uDCAF\uDCFB-\uDCFF\uDD16-\uDD1B\uDDBC\uDDBD\uDDC0-\uDDCF\uDDD2-\uDDFF\uDE40-\uDE48\uDE7D\uDE7E\uDE9D-\uDE9F\uDEEB-\uDEEF\uDF58-\uDF5F\uDF78-\uDF7F\uDFA9-\uDFAF]|\uD803[\uDCFA-\uDCFF\uDD30-\uDD39\uDE60-\uDE7E\uDF1D-\uDF26\uDF51-\uDF54\uDFC5-\uDFCB]|\uD804[\uDC52-\uDC6F\uDCF0-\uDCF9\uDD36-\uDD3F\uDDD0-\uDDD9\uDDE1-\uDDF4\uDEF0-\uDEF9]|\uD805[\uDC50-\uDC59\uDCD0-\uDCD9\uDE50-\uDE59\uDEC0-\uDEC9\uDF30-\uDF3B]|\uD806[\uDCE0-\uDCF2\uDD50-\uDD59]|\uD807[\uDC50-\uDC6C\uDD50-\uDD59\uDDA0-\uDDA9\uDFC0-\uDFD4]|\uD809[\uDC00-\uDC6E]|\uD81A[\uDE60-\uDE69\uDEC0-\uDEC9\uDF50-\uDF59\uDF5B-\uDF61]|\uD81B[\uDE80-\uDE96]|\uD834[\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDFCE-\uDFFF]|\uD838[\uDD40-\uDD49\uDEF0-\uDEF9]|\uD83A[\uDCC7-\uDCCF\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]'
    },
    {
        'name': 'Nd',
        'alias': 'Decimal_Number',
        'bmp': '0-9\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0BE6-\u0BEF\u0C66-\u0C6F\u0CE6-\u0CEF\u0D66-\u0D6F\u0DE6-\u0DEF\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F29\u1040-\u1049\u1090-\u1099\u17E0-\u17E9\u1810-\u1819\u1946-\u194F\u19D0-\u19D9\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\uA620-\uA629\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uA9F0-\uA9F9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19',
        'astral': '\uD801[\uDCA0-\uDCA9]|\uD803[\uDD30-\uDD39]|\uD804[\uDC66-\uDC6F\uDCF0-\uDCF9\uDD36-\uDD3F\uDDD0-\uDDD9\uDEF0-\uDEF9]|\uD805[\uDC50-\uDC59\uDCD0-\uDCD9\uDE50-\uDE59\uDEC0-\uDEC9\uDF30-\uDF39]|\uD806[\uDCE0-\uDCE9\uDD50-\uDD59]|\uD807[\uDC50-\uDC59\uDD50-\uDD59\uDDA0-\uDDA9]|\uD81A[\uDE60-\uDE69\uDEC0-\uDEC9\uDF50-\uDF59]|\uD835[\uDFCE-\uDFFF]|\uD838[\uDD40-\uDD49\uDEF0-\uDEF9]|\uD83A[\uDD50-\uDD59]|\uD83E[\uDFF0-\uDFF9]'
    },
    {
        'name': 'Nl',
        'alias': 'Letter_Number',
        'bmp': '\u16EE-\u16F0\u2160-\u2182\u2185-\u2188\u3007\u3021-\u3029\u3038-\u303A\uA6E6-\uA6EF',
        'astral': '\uD800[\uDD40-\uDD74\uDF41\uDF4A\uDFD1-\uDFD5]|\uD809[\uDC00-\uDC6E]'
    },
    {
        'name': 'No',
        'alias': 'Other_Number',
        'bmp': '\xB2\xB3\xB9\xBC-\xBE\u09F4-\u09F9\u0B72-\u0B77\u0BF0-\u0BF2\u0C78-\u0C7E\u0D58-\u0D5E\u0D70-\u0D78\u0F2A-\u0F33\u1369-\u137C\u17F0-\u17F9\u19DA\u2070\u2074-\u2079\u2080-\u2089\u2150-\u215F\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2CFD\u3192-\u3195\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\uA830-\uA835',
        'astral': '\uD800[\uDD07-\uDD33\uDD75-\uDD78\uDD8A\uDD8B\uDEE1-\uDEFB\uDF20-\uDF23]|\uD802[\uDC58-\uDC5F\uDC79-\uDC7F\uDCA7-\uDCAF\uDCFB-\uDCFF\uDD16-\uDD1B\uDDBC\uDDBD\uDDC0-\uDDCF\uDDD2-\uDDFF\uDE40-\uDE48\uDE7D\uDE7E\uDE9D-\uDE9F\uDEEB-\uDEEF\uDF58-\uDF5F\uDF78-\uDF7F\uDFA9-\uDFAF]|\uD803[\uDCFA-\uDCFF\uDE60-\uDE7E\uDF1D-\uDF26\uDF51-\uDF54\uDFC5-\uDFCB]|\uD804[\uDC52-\uDC65\uDDE1-\uDDF4]|\uD805[\uDF3A\uDF3B]|\uD806[\uDCEA-\uDCF2]|\uD807[\uDC5A-\uDC6C\uDFC0-\uDFD4]|\uD81A[\uDF5B-\uDF61]|\uD81B[\uDE80-\uDE96]|\uD834[\uDEE0-\uDEF3\uDF60-\uDF78]|\uD83A[\uDCC7-\uDCCF]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D]|\uD83C[\uDD00-\uDD0C]'
    },
    {
        'name': 'P',
        'alias': 'Punctuation',
        'bmp': '!-#%-\\*,-\\/:;\\?@\\[-\\]_\\{\\}\xA1\xA7\xAB\xB6\xB7\xBB\xBF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061D-\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0A76\u0AF0\u0C77\u0C84\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166E\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1B7D\u1B7E\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2010-\u2027\u2030-\u2043\u2045-\u2051\u2053-\u205E\u207D\u207E\u208D\u208E\u2308-\u230B\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E4F\u2E52-\u2E5D\u3001-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65',
        'astral': '\uD800[\uDD00-\uDD02\uDF9F\uDFD0]|\uD801\uDD6F|\uD802[\uDC57\uDD1F\uDD3F\uDE50-\uDE58\uDE7F\uDEF0-\uDEF6\uDF39-\uDF3F\uDF99-\uDF9C]|\uD803[\uDEAD\uDF55-\uDF59\uDF86-\uDF89]|\uD804[\uDC47-\uDC4D\uDCBB\uDCBC\uDCBE-\uDCC1\uDD40-\uDD43\uDD74\uDD75\uDDC5-\uDDC8\uDDCD\uDDDB\uDDDD-\uDDDF\uDE38-\uDE3D\uDEA9]|\uD805[\uDC4B-\uDC4F\uDC5A\uDC5B\uDC5D\uDCC6\uDDC1-\uDDD7\uDE41-\uDE43\uDE60-\uDE6C\uDEB9\uDF3C-\uDF3E]|\uD806[\uDC3B\uDD44-\uDD46\uDDE2\uDE3F-\uDE46\uDE9A-\uDE9C\uDE9E-\uDEA2]|\uD807[\uDC41-\uDC45\uDC70\uDC71\uDEF7\uDEF8\uDFFF]|\uD809[\uDC70-\uDC74]|\uD80B[\uDFF1\uDFF2]|\uD81A[\uDE6E\uDE6F\uDEF5\uDF37-\uDF3B\uDF44]|\uD81B[\uDE97-\uDE9A\uDFE2]|\uD82F\uDC9F|\uD836[\uDE87-\uDE8B]|\uD83A[\uDD5E\uDD5F]'
    },
    {
        'name': 'Pc',
        'alias': 'Connector_Punctuation',
        'bmp': '_\u203F\u2040\u2054\uFE33\uFE34\uFE4D-\uFE4F\uFF3F'
    },
    {
        'name': 'Pd',
        'alias': 'Dash_Punctuation',
        'bmp': '\\-\u058A\u05BE\u1400\u1806\u2010-\u2015\u2E17\u2E1A\u2E3A\u2E3B\u2E40\u2E5D\u301C\u3030\u30A0\uFE31\uFE32\uFE58\uFE63\uFF0D',
        'astral': '\uD803\uDEAD'
    },
    {
        'name': 'Pe',
        'alias': 'Close_Punctuation',
        'bmp': '\\)\\]\\}\u0F3B\u0F3D\u169C\u2046\u207E\u208E\u2309\u230B\u232A\u2769\u276B\u276D\u276F\u2771\u2773\u2775\u27C6\u27E7\u27E9\u27EB\u27ED\u27EF\u2984\u2986\u2988\u298A\u298C\u298E\u2990\u2992\u2994\u2996\u2998\u29D9\u29DB\u29FD\u2E23\u2E25\u2E27\u2E29\u2E56\u2E58\u2E5A\u2E5C\u3009\u300B\u300D\u300F\u3011\u3015\u3017\u3019\u301B\u301E\u301F\uFD3E\uFE18\uFE36\uFE38\uFE3A\uFE3C\uFE3E\uFE40\uFE42\uFE44\uFE48\uFE5A\uFE5C\uFE5E\uFF09\uFF3D\uFF5D\uFF60\uFF63'
    },
    {
        'name': 'Pf',
        'alias': 'Final_Punctuation',
        'bmp': '\xBB\u2019\u201D\u203A\u2E03\u2E05\u2E0A\u2E0D\u2E1D\u2E21'
    },
    {
        'name': 'Pi',
        'alias': 'Initial_Punctuation',
        'bmp': '\xAB\u2018\u201B\u201C\u201F\u2039\u2E02\u2E04\u2E09\u2E0C\u2E1C\u2E20'
    },
    {
        'name': 'Po',
        'alias': 'Other_Punctuation',
        'bmp': '!-#%-\'\\*,\\.\\/:;\\?@\\\xA1\xA7\xB6\xB7\xBF\u037E\u0387\u055A-\u055F\u0589\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061D-\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0A76\u0AF0\u0C77\u0C84\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u166E\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u1805\u1807-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1B7D\u1B7E\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2016\u2017\u2020-\u2027\u2030-\u2038\u203B-\u203E\u2041-\u2043\u2047-\u2051\u2053\u2055-\u205E\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00\u2E01\u2E06-\u2E08\u2E0B\u2E0E-\u2E16\u2E18\u2E19\u2E1B\u2E1E\u2E1F\u2E2A-\u2E2E\u2E30-\u2E39\u2E3C-\u2E3F\u2E41\u2E43-\u2E4F\u2E52-\u2E54\u3001-\u3003\u303D\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFE10-\uFE16\uFE19\uFE30\uFE45\uFE46\uFE49-\uFE4C\uFE50-\uFE52\uFE54-\uFE57\uFE5F-\uFE61\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF07\uFF0A\uFF0C\uFF0E\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3C\uFF61\uFF64\uFF65',
        'astral': '\uD800[\uDD00-\uDD02\uDF9F\uDFD0]|\uD801\uDD6F|\uD802[\uDC57\uDD1F\uDD3F\uDE50-\uDE58\uDE7F\uDEF0-\uDEF6\uDF39-\uDF3F\uDF99-\uDF9C]|\uD803[\uDF55-\uDF59\uDF86-\uDF89]|\uD804[\uDC47-\uDC4D\uDCBB\uDCBC\uDCBE-\uDCC1\uDD40-\uDD43\uDD74\uDD75\uDDC5-\uDDC8\uDDCD\uDDDB\uDDDD-\uDDDF\uDE38-\uDE3D\uDEA9]|\uD805[\uDC4B-\uDC4F\uDC5A\uDC5B\uDC5D\uDCC6\uDDC1-\uDDD7\uDE41-\uDE43\uDE60-\uDE6C\uDEB9\uDF3C-\uDF3E]|\uD806[\uDC3B\uDD44-\uDD46\uDDE2\uDE3F-\uDE46\uDE9A-\uDE9C\uDE9E-\uDEA2]|\uD807[\uDC41-\uDC45\uDC70\uDC71\uDEF7\uDEF8\uDFFF]|\uD809[\uDC70-\uDC74]|\uD80B[\uDFF1\uDFF2]|\uD81A[\uDE6E\uDE6F\uDEF5\uDF37-\uDF3B\uDF44]|\uD81B[\uDE97-\uDE9A\uDFE2]|\uD82F\uDC9F|\uD836[\uDE87-\uDE8B]|\uD83A[\uDD5E\uDD5F]'
    },
    {
        'name': 'Ps',
        'alias': 'Open_Punctuation',
        'bmp': '\\(\\[\\{\u0F3A\u0F3C\u169B\u201A\u201E\u2045\u207D\u208D\u2308\u230A\u2329\u2768\u276A\u276C\u276E\u2770\u2772\u2774\u27C5\u27E6\u27E8\u27EA\u27EC\u27EE\u2983\u2985\u2987\u2989\u298B\u298D\u298F\u2991\u2993\u2995\u2997\u29D8\u29DA\u29FC\u2E22\u2E24\u2E26\u2E28\u2E42\u2E55\u2E57\u2E59\u2E5B\u3008\u300A\u300C\u300E\u3010\u3014\u3016\u3018\u301A\u301D\uFD3F\uFE17\uFE35\uFE37\uFE39\uFE3B\uFE3D\uFE3F\uFE41\uFE43\uFE47\uFE59\uFE5B\uFE5D\uFF08\uFF3B\uFF5B\uFF5F\uFF62'
    },
    {
        'name': 'S',
        'alias': 'Symbol',
        'bmp': '\\$\\+<->\\^`\\|~\xA2-\xA6\xA8\xA9\xAC\xAE-\xB1\xB4\xB8\xD7\xF7\u02C2-\u02C5\u02D2-\u02DF\u02E5-\u02EB\u02ED\u02EF-\u02FF\u0375\u0384\u0385\u03F6\u0482\u058D-\u058F\u0606-\u0608\u060B\u060E\u060F\u06DE\u06E9\u06FD\u06FE\u07F6\u07FE\u07FF\u0888\u09F2\u09F3\u09FA\u09FB\u0AF1\u0B70\u0BF3-\u0BFA\u0C7F\u0D4F\u0D79\u0E3F\u0F01-\u0F03\u0F13\u0F15-\u0F17\u0F1A-\u0F1F\u0F34\u0F36\u0F38\u0FBE-\u0FC5\u0FC7-\u0FCC\u0FCE\u0FCF\u0FD5-\u0FD8\u109E\u109F\u1390-\u1399\u166D\u17DB\u1940\u19DE-\u19FF\u1B61-\u1B6A\u1B74-\u1B7C\u1FBD\u1FBF-\u1FC1\u1FCD-\u1FCF\u1FDD-\u1FDF\u1FED-\u1FEF\u1FFD\u1FFE\u2044\u2052\u207A-\u207C\u208A-\u208C\u20A0-\u20C0\u2100\u2101\u2103-\u2106\u2108\u2109\u2114\u2116-\u2118\u211E-\u2123\u2125\u2127\u2129\u212E\u213A\u213B\u2140-\u2144\u214A-\u214D\u214F\u218A\u218B\u2190-\u2307\u230C-\u2328\u232B-\u2426\u2440-\u244A\u249C-\u24E9\u2500-\u2767\u2794-\u27C4\u27C7-\u27E5\u27F0-\u2982\u2999-\u29D7\u29DC-\u29FB\u29FE-\u2B73\u2B76-\u2B95\u2B97-\u2BFF\u2CE5-\u2CEA\u2E50\u2E51\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u2FFB\u3004\u3012\u3013\u3020\u3036\u3037\u303E\u303F\u309B\u309C\u3190\u3191\u3196-\u319F\u31C0-\u31E3\u3200-\u321E\u322A-\u3247\u3250\u3260-\u327F\u328A-\u32B0\u32C0-\u33FF\u4DC0-\u4DFF\uA490-\uA4C6\uA700-\uA716\uA720\uA721\uA789\uA78A\uA828-\uA82B\uA836-\uA839\uAA77-\uAA79\uAB5B\uAB6A\uAB6B\uFB29\uFBB2-\uFBC2\uFD40-\uFD4F\uFDCF\uFDFC-\uFDFF\uFE62\uFE64-\uFE66\uFE69\uFF04\uFF0B\uFF1C-\uFF1E\uFF3E\uFF40\uFF5C\uFF5E\uFFE0-\uFFE6\uFFE8-\uFFEE\uFFFC\uFFFD',
        'astral': '\uD800[\uDD37-\uDD3F\uDD79-\uDD89\uDD8C-\uDD8E\uDD90-\uDD9C\uDDA0\uDDD0-\uDDFC]|\uD802[\uDC77\uDC78\uDEC8]|\uD805\uDF3F|\uD807[\uDFD5-\uDFF1]|\uD81A[\uDF3C-\uDF3F\uDF45]|\uD82F\uDC9C|\uD833[\uDF50-\uDFC3]|\uD834[\uDC00-\uDCF5\uDD00-\uDD26\uDD29-\uDD64\uDD6A-\uDD6C\uDD83\uDD84\uDD8C-\uDDA9\uDDAE-\uDDEA\uDE00-\uDE41\uDE45\uDF00-\uDF56]|\uD835[\uDEC1\uDEDB\uDEFB\uDF15\uDF35\uDF4F\uDF6F\uDF89\uDFA9\uDFC3]|\uD836[\uDC00-\uDDFF\uDE37-\uDE3A\uDE6D-\uDE74\uDE76-\uDE83\uDE85\uDE86]|\uD838[\uDD4F\uDEFF]|\uD83B[\uDCAC\uDCB0\uDD2E\uDEF0\uDEF1]|\uD83C[\uDC00-\uDC2B\uDC30-\uDC93\uDCA0-\uDCAE\uDCB1-\uDCBF\uDCC1-\uDCCF\uDCD1-\uDCF5\uDD0D-\uDDAD\uDDE6-\uDE02\uDE10-\uDE3B\uDE40-\uDE48\uDE50\uDE51\uDE60-\uDE65\uDF00-\uDFFF]|\uD83D[\uDC00-\uDED7\uDEDD-\uDEEC\uDEF0-\uDEFC\uDF00-\uDF73\uDF80-\uDFD8\uDFE0-\uDFEB\uDFF0]|\uD83E[\uDC00-\uDC0B\uDC10-\uDC47\uDC50-\uDC59\uDC60-\uDC87\uDC90-\uDCAD\uDCB0\uDCB1\uDD00-\uDE53\uDE60-\uDE6D\uDE70-\uDE74\uDE78-\uDE7C\uDE80-\uDE86\uDE90-\uDEAC\uDEB0-\uDEBA\uDEC0-\uDEC5\uDED0-\uDED9\uDEE0-\uDEE7\uDEF0-\uDEF6\uDF00-\uDF92\uDF94-\uDFCA]'
    },
    {
        'name': 'Sc',
        'alias': 'Currency_Symbol',
        'bmp': '\\$\xA2-\xA5\u058F\u060B\u07FE\u07FF\u09F2\u09F3\u09FB\u0AF1\u0BF9\u0E3F\u17DB\u20A0-\u20C0\uA838\uFDFC\uFE69\uFF04\uFFE0\uFFE1\uFFE5\uFFE6',
        'astral': '\uD807[\uDFDD-\uDFE0]|\uD838\uDEFF|\uD83B\uDCB0'
    },
    {
        'name': 'Sk',
        'alias': 'Modifier_Symbol',
        'bmp': '\\^`\xA8\xAF\xB4\xB8\u02C2-\u02C5\u02D2-\u02DF\u02E5-\u02EB\u02ED\u02EF-\u02FF\u0375\u0384\u0385\u0888\u1FBD\u1FBF-\u1FC1\u1FCD-\u1FCF\u1FDD-\u1FDF\u1FED-\u1FEF\u1FFD\u1FFE\u309B\u309C\uA700-\uA716\uA720\uA721\uA789\uA78A\uAB5B\uAB6A\uAB6B\uFBB2-\uFBC2\uFF3E\uFF40\uFFE3',
        'astral': '\uD83C[\uDFFB-\uDFFF]'
    },
    {
        'name': 'Sm',
        'alias': 'Math_Symbol',
        'bmp': '\\+<->\\|~\xAC\xB1\xD7\xF7\u03F6\u0606-\u0608\u2044\u2052\u207A-\u207C\u208A-\u208C\u2118\u2140-\u2144\u214B\u2190-\u2194\u219A\u219B\u21A0\u21A3\u21A6\u21AE\u21CE\u21CF\u21D2\u21D4\u21F4-\u22FF\u2320\u2321\u237C\u239B-\u23B3\u23DC-\u23E1\u25B7\u25C1\u25F8-\u25FF\u266F\u27C0-\u27C4\u27C7-\u27E5\u27F0-\u27FF\u2900-\u2982\u2999-\u29D7\u29DC-\u29FB\u29FE-\u2AFF\u2B30-\u2B44\u2B47-\u2B4C\uFB29\uFE62\uFE64-\uFE66\uFF0B\uFF1C-\uFF1E\uFF5C\uFF5E\uFFE2\uFFE9-\uFFEC',
        'astral': '\uD835[\uDEC1\uDEDB\uDEFB\uDF15\uDF35\uDF4F\uDF6F\uDF89\uDFA9\uDFC3]|\uD83B[\uDEF0\uDEF1]'
    },
    {
        'name': 'So',
        'alias': 'Other_Symbol',
        'bmp': '\xA6\xA9\xAE\xB0\u0482\u058D\u058E\u060E\u060F\u06DE\u06E9\u06FD\u06FE\u07F6\u09FA\u0B70\u0BF3-\u0BF8\u0BFA\u0C7F\u0D4F\u0D79\u0F01-\u0F03\u0F13\u0F15-\u0F17\u0F1A-\u0F1F\u0F34\u0F36\u0F38\u0FBE-\u0FC5\u0FC7-\u0FCC\u0FCE\u0FCF\u0FD5-\u0FD8\u109E\u109F\u1390-\u1399\u166D\u1940\u19DE-\u19FF\u1B61-\u1B6A\u1B74-\u1B7C\u2100\u2101\u2103-\u2106\u2108\u2109\u2114\u2116\u2117\u211E-\u2123\u2125\u2127\u2129\u212E\u213A\u213B\u214A\u214C\u214D\u214F\u218A\u218B\u2195-\u2199\u219C-\u219F\u21A1\u21A2\u21A4\u21A5\u21A7-\u21AD\u21AF-\u21CD\u21D0\u21D1\u21D3\u21D5-\u21F3\u2300-\u2307\u230C-\u231F\u2322-\u2328\u232B-\u237B\u237D-\u239A\u23B4-\u23DB\u23E2-\u2426\u2440-\u244A\u249C-\u24E9\u2500-\u25B6\u25B8-\u25C0\u25C2-\u25F7\u2600-\u266E\u2670-\u2767\u2794-\u27BF\u2800-\u28FF\u2B00-\u2B2F\u2B45\u2B46\u2B4D-\u2B73\u2B76-\u2B95\u2B97-\u2BFF\u2CE5-\u2CEA\u2E50\u2E51\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u2FFB\u3004\u3012\u3013\u3020\u3036\u3037\u303E\u303F\u3190\u3191\u3196-\u319F\u31C0-\u31E3\u3200-\u321E\u322A-\u3247\u3250\u3260-\u327F\u328A-\u32B0\u32C0-\u33FF\u4DC0-\u4DFF\uA490-\uA4C6\uA828-\uA82B\uA836\uA837\uA839\uAA77-\uAA79\uFD40-\uFD4F\uFDCF\uFDFD-\uFDFF\uFFE4\uFFE8\uFFED\uFFEE\uFFFC\uFFFD',
        'astral': '\uD800[\uDD37-\uDD3F\uDD79-\uDD89\uDD8C-\uDD8E\uDD90-\uDD9C\uDDA0\uDDD0-\uDDFC]|\uD802[\uDC77\uDC78\uDEC8]|\uD805\uDF3F|\uD807[\uDFD5-\uDFDC\uDFE1-\uDFF1]|\uD81A[\uDF3C-\uDF3F\uDF45]|\uD82F\uDC9C|\uD833[\uDF50-\uDFC3]|\uD834[\uDC00-\uDCF5\uDD00-\uDD26\uDD29-\uDD64\uDD6A-\uDD6C\uDD83\uDD84\uDD8C-\uDDA9\uDDAE-\uDDEA\uDE00-\uDE41\uDE45\uDF00-\uDF56]|\uD836[\uDC00-\uDDFF\uDE37-\uDE3A\uDE6D-\uDE74\uDE76-\uDE83\uDE85\uDE86]|\uD838\uDD4F|\uD83B[\uDCAC\uDD2E]|\uD83C[\uDC00-\uDC2B\uDC30-\uDC93\uDCA0-\uDCAE\uDCB1-\uDCBF\uDCC1-\uDCCF\uDCD1-\uDCF5\uDD0D-\uDDAD\uDDE6-\uDE02\uDE10-\uDE3B\uDE40-\uDE48\uDE50\uDE51\uDE60-\uDE65\uDF00-\uDFFA]|\uD83D[\uDC00-\uDED7\uDEDD-\uDEEC\uDEF0-\uDEFC\uDF00-\uDF73\uDF80-\uDFD8\uDFE0-\uDFEB\uDFF0]|\uD83E[\uDC00-\uDC0B\uDC10-\uDC47\uDC50-\uDC59\uDC60-\uDC87\uDC90-\uDCAD\uDCB0\uDCB1\uDD00-\uDE53\uDE60-\uDE6D\uDE70-\uDE74\uDE78-\uDE7C\uDE80-\uDE86\uDE90-\uDEAC\uDEB0-\uDEBA\uDEC0-\uDEC5\uDED0-\uDED9\uDEE0-\uDEE7\uDEF0-\uDEF6\uDF00-\uDF92\uDF94-\uDFCA]'
    },
    {
        'name': 'Z',
        'alias': 'Separator',
        'bmp': ' \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000'
    },
    {
        'name': 'Zl',
        'alias': 'Line_Separator',
        'bmp': '\u2028'
    },
    {
        'name': 'Zp',
        'alias': 'Paragraph_Separator',
        'bmp': '\u2029'
    },
    {
        'name': 'Zs',
        'alias': 'Space_Separator',
        'bmp': ' \xA0\u1680\u2000-\u200A\u202F\u205F\u3000'
    }
];

},{}]},{},[3])(3)
});



========== staticfiles/admin/js/vendor/jquery/jquery.js ==========
/*!
 * jQuery JavaScript Library v3.7.1
 * https://jquery.com/
 *
 * Copyright OpenJS Foundation and other contributors
 * Released under the MIT license
 * https://jquery.org/license
 *
 * Date: 2023-08-28T13:37Z
 */
( function( global, factory ) {

	"use strict";

	if ( typeof module === "object" && typeof module.exports === "object" ) {

		// For CommonJS and CommonJS-like environments where a proper `window`
		// is present, execute the factory and get jQuery.
		// For environments that do not have a `window` with a `document`
		// (such as Node.js), expose a factory as module.exports.
		// This accentuates the need for the creation of a real `window`.
		// e.g. var jQuery = require("jquery")(window);
		// See ticket trac-14549 for more info.
		module.exports = global.document ?
			factory( global, true ) :
			function( w ) {
				if ( !w.document ) {
					throw new Error( "jQuery requires a window with a document" );
				}
				return factory( w );
			};
	} else {
		factory( global );
	}

// Pass this if window is not defined yet
} )( typeof window !== "undefined" ? window : this, function( window, noGlobal ) {

// Edge <= 12 - 13+, Firefox <=18 - 45+, IE 10 - 11, Safari 5.1 - 9+, iOS 6 - 9.1
// throw exceptions when non-strict code (e.g., ASP.NET 4.5) accesses strict mode
// arguments.callee.caller (trac-13335). But as of jQuery 3.0 (2016), strict mode should be common
// enough that all such attempts are guarded in a try block.
"use strict";

var arr = [];

var getProto = Object.getPrototypeOf;

var slice = arr.slice;

var flat = arr.flat ? function( array ) {
	return arr.flat.call( array );
} : function( array ) {
	return arr.concat.apply( [], array );
};


var push = arr.push;

var indexOf = arr.indexOf;

var class2type = {};

var toString = class2type.toString;

var hasOwn = class2type.hasOwnProperty;

var fnToString = hasOwn.toString;

var ObjectFunctionString = fnToString.call( Object );

var support = {};

var isFunction = function isFunction( obj ) {

		// Support: Chrome <=57, Firefox <=52
		// In some browsers, typeof returns "function" for HTML <object> elements
		// (i.e., `typeof document.createElement( "object" ) === "function"`).
		// We don't want to classify *any* DOM node as a function.
		// Support: QtWeb <=3.8.5, WebKit <=534.34, wkhtmltopdf tool <=0.12.5
		// Plus for old WebKit, typeof returns "function" for HTML collections
		// (e.g., `typeof document.getElementsByTagName("div") === "function"`). (gh-4756)
		return typeof obj === "function" && typeof obj.nodeType !== "number" &&
			typeof obj.item !== "function";
	};


var isWindow = function isWindow( obj ) {
		return obj != null && obj === obj.window;
	};


var document = window.document;



	var preservedScriptAttributes = {
		type: true,
		src: true,
		nonce: true,
		noModule: true
	};

	function DOMEval( code, node, doc ) {
		doc = doc || document;

		var i, val,
			script = doc.createElement( "script" );

		script.text = code;
		if ( node ) {
			for ( i in preservedScriptAttributes ) {

				// Support: Firefox 64+, Edge 18+
				// Some browsers don't support the "nonce" property on scripts.
				// On the other hand, just using `getAttribute` is not enough as
				// the `nonce` attribute is reset to an empty string whenever it
				// becomes browsing-context connected.
				// See https://github.com/whatwg/html/issues/2369
				// See https://html.spec.whatwg.org/#nonce-attributes
				// The `node.getAttribute` check was added for the sake of
				// `jQuery.globalEval` so that it can fake a nonce-containing node
				// via an object.
				val = node[ i ] || node.getAttribute && node.getAttribute( i );
				if ( val ) {
					script.setAttribute( i, val );
				}
			}
		}
		doc.head.appendChild( script ).parentNode.removeChild( script );
	}


function toType( obj ) {
	if ( obj == null ) {
		return obj + "";
	}

	// Support: Android <=2.3 only (functionish RegExp)
	return typeof obj === "object" || typeof obj === "function" ?
		class2type[ toString.call( obj ) ] || "object" :
		typeof obj;
}
/* global Symbol */
// Defining this global in .eslintrc.json would create a danger of using the global
// unguarded in another place, it seems safer to define global only for this module



var version = "3.7.1",

	rhtmlSuffix = /HTML$/i,

	// Define a local copy of jQuery
	jQuery = function( selector, context ) {

		// The jQuery object is actually just the init constructor 'enhanced'
		// Need init if jQuery is called (just allow error to be thrown if not included)
		return new jQuery.fn.init( selector, context );
	};

jQuery.fn = jQuery.prototype = {

	// The current version of jQuery being used
	jquery: version,

	constructor: jQuery,

	// The default length of a jQuery object is 0
	length: 0,

	toArray: function() {
		return slice.call( this );
	},

	// Get the Nth element in the matched element set OR
	// Get the whole matched element set as a clean array
	get: function( num ) {

		// Return all the elements in a clean array
		if ( num == null ) {
			return slice.call( this );
		}

		// Return just the one element from the set
		return num < 0 ? this[ num + this.length ] : this[ num ];
	},

	// Take an array of elements and push it onto the stack
	// (returning the new matched element set)
	pushStack: function( elems ) {

		// Build a new jQuery matched element set
		var ret = jQuery.merge( this.constructor(), elems );

		// Add the old object onto the stack (as a reference)
		ret.prevObject = this;

		// Return the newly-formed element set
		return ret;
	},

	// Execute a callback for every element in the matched set.
	each: function( callback ) {
		return jQuery.each( this, callback );
	},

	map: function( callback ) {
		return this.pushStack( jQuery.map( this, function( elem, i ) {
			return callback.call( elem, i, elem );
		} ) );
	},

	slice: function() {
		return this.pushStack( slice.apply( this, arguments ) );
	},

	first: function() {
		return this.eq( 0 );
	},

	last: function() {
		return this.eq( -1 );
	},

	even: function() {
		return this.pushStack( jQuery.grep( this, function( _elem, i ) {
			return ( i + 1 ) % 2;
		} ) );
	},

	odd: function() {
		return this.pushStack( jQuery.grep( this, function( _elem, i ) {
			return i % 2;
		} ) );
	},

	eq: function( i ) {
		var len = this.length,
			j = +i + ( i < 0 ? len : 0 );
		return this.pushStack( j >= 0 && j < len ? [ this[ j ] ] : [] );
	},

	end: function() {
		return this.prevObject || this.constructor();
	},

	// For internal use only.
	// Behaves like an Array's method, not like a jQuery method.
	push: push,
	sort: arr.sort,
	splice: arr.splice
};

jQuery.extend = jQuery.fn.extend = function() {
	var options, name, src, copy, copyIsArray, clone,
		target = arguments[ 0 ] || {},
		i = 1,
		length = arguments.length,
		deep = false;

	// Handle a deep copy situation
	if ( typeof target === "boolean" ) {
		deep = target;

		// Skip the boolean and the target
		target = arguments[ i ] || {};
		i++;
	}

	// Handle case when target is a string or something (possible in deep copy)
	if ( typeof target !== "object" && !isFunction( target ) ) {
		target = {};
	}

	// Extend jQuery itself if only one argument is passed
	if ( i === length ) {
		target = this;
		i--;
	}

	for ( ; i < length; i++ ) {

		// Only deal with non-null/undefined values
		if ( ( options = arguments[ i ] ) != null ) {

			// Extend the base object
			for ( name in options ) {
				copy = options[ name ];

				// Prevent Object.prototype pollution
				// Prevent never-ending loop
				if ( name === "__proto__" || target === copy ) {
					continue;
				}

				// Recurse if we're merging plain objects or arrays
				if ( deep && copy && ( jQuery.isPlainObject( copy ) ||
					( copyIsArray = Array.isArray( copy ) ) ) ) {
					src = target[ name ];

					// Ensure proper type for the source value
					if ( copyIsArray && !Array.isArray( src ) ) {
						clone = [];
					} else if ( !copyIsArray && !jQuery.isPlainObject( src ) ) {
						clone = {};
					} else {
						clone = src;
					}
					copyIsArray = false;

					// Never move original objects, clone them
					target[ name ] = jQuery.extend( deep, clone, copy );

				// Don't bring in undefined values
				} else if ( copy !== undefined ) {
					target[ name ] = copy;
				}
			}
		}
	}

	// Return the modified object
	return target;
};

jQuery.extend( {

	// Unique for each copy of jQuery on the page
	expando: "jQuery" + ( version + Math.random() ).replace( /\D/g, "" ),

	// Assume jQuery is ready without the ready module
	isReady: true,

	error: function( msg ) {
		throw new Error( msg );
	},

	noop: function() {},

	isPlainObject: function( obj ) {
		var proto, Ctor;

		// Detect obvious negatives
		// Use toString instead of jQuery.type to catch host objects
		if ( !obj || toString.call( obj ) !== "[object Object]" ) {
			return false;
		}

		proto = getProto( obj );

		// Objects with no prototype (e.g., `Object.create( null )`) are plain
		if ( !proto ) {
			return true;
		}

		// Objects with prototype are plain iff they were constructed by a global Object function
		Ctor = hasOwn.call( proto, "constructor" ) && proto.constructor;
		return typeof Ctor === "function" && fnToString.call( Ctor ) === ObjectFunctionString;
	},

	isEmptyObject: function( obj ) {
		var name;

		for ( name in obj ) {
			return false;
		}
		return true;
	},

	// Evaluates a script in a provided context; falls back to the global one
	// if not specified.
	globalEval: function( code, options, doc ) {
		DOMEval( code, { nonce: options && options.nonce }, doc );
	},

	each: function( obj, callback ) {
		var length, i = 0;

		if ( isArrayLike( obj ) ) {
			length = obj.length;
			for ( ; i < length; i++ ) {
				if ( callback.call( obj[ i ], i, obj[ i ] ) === false ) {
					break;
				}
			}
		} else {
			for ( i in obj ) {
				if ( callback.call( obj[ i ], i, obj[ i ] ) === false ) {
					break;
				}
			}
		}

		return obj;
	},


	// Retrieve the text value of an array of DOM nodes
	text: function( elem ) {
		var node,
			ret = "",
			i = 0,
			nodeType = elem.nodeType;

		if ( !nodeType ) {

			// If no nodeType, this is expected to be an array
			while ( ( node = elem[ i++ ] ) ) {

				// Do not traverse comment nodes
				ret += jQuery.text( node );
			}
		}
		if ( nodeType === 1 || nodeType === 11 ) {
			return elem.textContent;
		}
		if ( nodeType === 9 ) {
			return elem.documentElement.textContent;
		}
		if ( nodeType === 3 || nodeType === 4 ) {
			return elem.nodeValue;
		}

		// Do not include comment or processing instruction nodes

		return ret;
	},

	// results is for internal usage only
	makeArray: function( arr, results ) {
		var ret = results || [];

		if ( arr != null ) {
			if ( isArrayLike( Object( arr ) ) ) {
				jQuery.merge( ret,
					typeof arr === "string" ?
						[ arr ] : arr
				);
			} else {
				push.call( ret, arr );
			}
		}

		return ret;
	},

	inArray: function( elem, arr, i ) {
		return arr == null ? -1 : indexOf.call( arr, elem, i );
	},

	isXMLDoc: function( elem ) {
		var namespace = elem && elem.namespaceURI,
			docElem = elem && ( elem.ownerDocument || elem ).documentElement;

		// Assume HTML when documentElement doesn't yet exist, such as inside
		// document fragments.
		return !rhtmlSuffix.test( namespace || docElem && docElem.nodeName || "HTML" );
	},

	// Support: Android <=4.0 only, PhantomJS 1 only
	// push.apply(_, arraylike) throws on ancient WebKit
	merge: function( first, second ) {
		var len = +second.length,
			j = 0,
			i = first.length;

		for ( ; j < len; j++ ) {
			first[ i++ ] = second[ j ];
		}

		first.length = i;

		return first;
	},

	grep: function( elems, callback, invert ) {
		var callbackInverse,
			matches = [],
			i = 0,
			length = elems.length,
			callbackExpect = !invert;

		// Go through the array, only saving the items
		// that pass the validator function
		for ( ; i < length; i++ ) {
			callbackInverse = !callback( elems[ i ], i );
			if ( callbackInverse !== callbackExpect ) {
				matches.push( elems[ i ] );
			}
		}

		return matches;
	},

	// arg is for internal usage only
	map: function( elems, callback, arg ) {
		var length, value,
			i = 0,
			ret = [];

		// Go through the array, translating each of the items to their new values
		if ( isArrayLike( elems ) ) {
			length = elems.length;
			for ( ; i < length; i++ ) {
				value = callback( elems[ i ], i, arg );

				if ( value != null ) {
					ret.push( value );
				}
			}

		// Go through every key on the object,
		} else {
			for ( i in elems ) {
				value = callback( elems[ i ], i, arg );

				if ( value != null ) {
					ret.push( value );
				}
			}
		}

		// Flatten any nested arrays
		return flat( ret );
	},

	// A global GUID counter for objects
	guid: 1,

	// jQuery.support is not used in Core but other projects attach their
	// properties to it so it needs to exist.
	support: support
} );

if ( typeof Symbol === "function" ) {
	jQuery.fn[ Symbol.iterator ] = arr[ Symbol.iterator ];
}

// Populate the class2type map
jQuery.each( "Boolean Number String Function Array Date RegExp Object Error Symbol".split( " " ),
	function( _i, name ) {
		class2type[ "[object " + name + "]" ] = name.toLowerCase();
	} );

function isArrayLike( obj ) {

	// Support: real iOS 8.2 only (not reproducible in simulator)
	// `in` check used to prevent JIT error (gh-2145)
	// hasOwn isn't used here due to false negatives
	// regarding Nodelist length in IE
	var length = !!obj && "length" in obj && obj.length,
		type = toType( obj );

	if ( isFunction( obj ) || isWindow( obj ) ) {
		return false;
	}

	return type === "array" || length === 0 ||
		typeof length === "number" && length > 0 && ( length - 1 ) in obj;
}


function nodeName( elem, name ) {

	return elem.nodeName && elem.nodeName.toLowerCase() === name.toLowerCase();

}
var pop = arr.pop;


var sort = arr.sort;


var splice = arr.splice;


var whitespace = "[\\x20\\t\\r\\n\\f]";


var rtrimCSS = new RegExp(
	"^" + whitespace + "+|((?:^|[^\\\\])(?:\\\\.)*)" + whitespace + "+$",
	"g"
);




// Note: an element does not contain itself
jQuery.contains = function( a, b ) {
	var bup = b && b.parentNode;

	return a === bup || !!( bup && bup.nodeType === 1 && (

		// Support: IE 9 - 11+
		// IE doesn't have `contains` on SVG.
		a.contains ?
			a.contains( bup ) :
			a.compareDocumentPosition && a.compareDocumentPosition( bup ) & 16
	) );
};




// CSS string/identifier serialization
// https://drafts.csswg.org/cssom/#common-serializing-idioms
var rcssescape = /([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g;

function fcssescape( ch, asCodePoint ) {
	if ( asCodePoint ) {

		// U+0000 NULL becomes U+FFFD REPLACEMENT CHARACTER
		if ( ch === "\0" ) {
			return "\uFFFD";
		}

		// Control characters and (dependent upon position) numbers get escaped as code points
		return ch.slice( 0, -1 ) + "\\" + ch.charCodeAt( ch.length - 1 ).toString( 16 ) + " ";
	}

	// Other potentially-special ASCII characters get backslash-escaped
	return "\\" + ch;
}

jQuery.escapeSelector = function( sel ) {
	return ( sel + "" ).replace( rcssescape, fcssescape );
};




var preferredDoc = document,
	pushNative = push;

( function() {

var i,
	Expr,
	outermostContext,
	sortInput,
	hasDuplicate,
	push = pushNative,

	// Local document vars
	document,
	documentElement,
	documentIsHTML,
	rbuggyQSA,
	matches,

	// Instance-specific data
	expando = jQuery.expando,
	dirruns = 0,
	done = 0,
	classCache = createCache(),
	tokenCache = createCache(),
	compilerCache = createCache(),
	nonnativeSelectorCache = createCache(),
	sortOrder = function( a, b ) {
		if ( a === b ) {
			hasDuplicate = true;
		}
		return 0;
	},

	booleans = "checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|" +
		"loop|multiple|open|readonly|required|scoped",

	// Regular expressions

	// https://www.w3.org/TR/css-syntax-3/#ident-token-diagram
	identifier = "(?:\\\\[\\da-fA-F]{1,6}" + whitespace +
		"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",

	// Attribute selectors: https://www.w3.org/TR/selectors/#attribute-selectors
	attributes = "\\[" + whitespace + "*(" + identifier + ")(?:" + whitespace +

		// Operator (capture 2)
		"*([*^$|!~]?=)" + whitespace +

		// "Attribute values must be CSS identifiers [capture 5] or strings [capture 3 or capture 4]"
		"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|(" + identifier + "))|)" +
		whitespace + "*\\]",

	pseudos = ":(" + identifier + ")(?:\\((" +

		// To reduce the number of selectors needing tokenize in the preFilter, prefer arguments:
		// 1. quoted (capture 3; capture 4 or capture 5)
		"('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|" +

		// 2. simple (capture 6)
		"((?:\\\\.|[^\\\\()[\\]]|" + attributes + ")*)|" +

		// 3. anything else (capture 2)
		".*" +
		")\\)|)",

	// Leading and non-escaped trailing whitespace, capturing some non-whitespace characters preceding the latter
	rwhitespace = new RegExp( whitespace + "+", "g" ),

	rcomma = new RegExp( "^" + whitespace + "*," + whitespace + "*" ),
	rleadingCombinator = new RegExp( "^" + whitespace + "*([>+~]|" + whitespace + ")" +
		whitespace + "*" ),
	rdescend = new RegExp( whitespace + "|>" ),

	rpseudo = new RegExp( pseudos ),
	ridentifier = new RegExp( "^" + identifier + "$" ),

	matchExpr = {
		ID: new RegExp( "^#(" + identifier + ")" ),
		CLASS: new RegExp( "^\\.(" + identifier + ")" ),
		TAG: new RegExp( "^(" + identifier + "|[*])" ),
		ATTR: new RegExp( "^" + attributes ),
		PSEUDO: new RegExp( "^" + pseudos ),
		CHILD: new RegExp(
			"^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\(" +
				whitespace + "*(even|odd|(([+-]|)(\\d*)n|)" + whitespace + "*(?:([+-]|)" +
				whitespace + "*(\\d+)|))" + whitespace + "*\\)|)", "i" ),
		bool: new RegExp( "^(?:" + booleans + ")$", "i" ),

		// For use in libraries implementing .is()
		// We use this for POS matching in `select`
		needsContext: new RegExp( "^" + whitespace +
			"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\(" + whitespace +
			"*((?:-\\d)?\\d*)" + whitespace + "*\\)|)(?=[^-]|$)", "i" )
	},

	rinputs = /^(?:input|select|textarea|button)$/i,
	rheader = /^h\d$/i,

	// Easily-parseable/retrievable ID or TAG or CLASS selectors
	rquickExpr = /^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,

	rsibling = /[+~]/,

	// CSS escapes
	// https://www.w3.org/TR/CSS21/syndata.html#escaped-characters
	runescape = new RegExp( "\\\\[\\da-fA-F]{1,6}" + whitespace +
		"?|\\\\([^\\r\\n\\f])", "g" ),
	funescape = function( escape, nonHex ) {
		var high = "0x" + escape.slice( 1 ) - 0x10000;

		if ( nonHex ) {

			// Strip the backslash prefix from a non-hex escape sequence
			return nonHex;
		}

		// Replace a hexadecimal escape sequence with the encoded Unicode code point
		// Support: IE <=11+
		// For values outside the Basic Multilingual Plane (BMP), manually construct a
		// surrogate pair
		return high < 0 ?
			String.fromCharCode( high + 0x10000 ) :
			String.fromCharCode( high >> 10 | 0xD800, high & 0x3FF | 0xDC00 );
	},

	// Used for iframes; see `setDocument`.
	// Support: IE 9 - 11+, Edge 12 - 18+
	// Removing the function wrapper causes a "Permission Denied"
	// error in IE/Edge.
	unloadHandler = function() {
		setDocument();
	},

	inDisabledFieldset = addCombinator(
		function( elem ) {
			return elem.disabled === true && nodeName( elem, "fieldset" );
		},
		{ dir: "parentNode", next: "legend" }
	);

// Support: IE <=9 only
// Accessing document.activeElement can throw unexpectedly
// https://bugs.jquery.com/ticket/13393
function safeActiveElement() {
	try {
		return document.activeElement;
	} catch ( err ) { }
}

// Optimize for push.apply( _, NodeList )
try {
	push.apply(
		( arr = slice.call( preferredDoc.childNodes ) ),
		preferredDoc.childNodes
	);

	// Support: Android <=4.0
	// Detect silently failing push.apply
	// eslint-disable-next-line no-unused-expressions
	arr[ preferredDoc.childNodes.length ].nodeType;
} catch ( e ) {
	push = {
		apply: function( target, els ) {
			pushNative.apply( target, slice.call( els ) );
		},
		call: function( target ) {
			pushNative.apply( target, slice.call( arguments, 1 ) );
		}
	};
}

function find( selector, context, results, seed ) {
	var m, i, elem, nid, match, groups, newSelector,
		newContext = context && context.ownerDocument,

		// nodeType defaults to 9, since context defaults to document
		nodeType = context ? context.nodeType : 9;

	results = results || [];

	// Return early from calls with invalid selector or context
	if ( typeof selector !== "string" || !selector ||
		nodeType !== 1 && nodeType !== 9 && nodeType !== 11 ) {

		return results;
	}

	// Try to shortcut find operations (as opposed to filters) in HTML documents
	if ( !seed ) {
		setDocument( context );
		context = context || document;

		if ( documentIsHTML ) {

			// If the selector is sufficiently simple, try using a "get*By*" DOM method
			// (excepting DocumentFragment context, where the methods don't exist)
			if ( nodeType !== 11 && ( match = rquickExpr.exec( selector ) ) ) {

				// ID selector
				if ( ( m = match[ 1 ] ) ) {

					// Document context
					if ( nodeType === 9 ) {
						if ( ( elem = context.getElementById( m ) ) ) {

							// Support: IE 9 only
							// getElementById can match elements by name instead of ID
							if ( elem.id === m ) {
								push.call( results, elem );
								return results;
							}
						} else {
							return results;
						}

					// Element context
					} else {

						// Support: IE 9 only
						// getElementById can match elements by name instead of ID
						if ( newContext && ( elem = newContext.getElementById( m ) ) &&
							find.contains( context, elem ) &&
							elem.id === m ) {

							push.call( results, elem );
							return results;
						}
					}

				// Type selector
				} else if ( match[ 2 ] ) {
					push.apply( results, context.getElementsByTagName( selector ) );
					return results;

				// Class selector
				} else if ( ( m = match[ 3 ] ) && context.getElementsByClassName ) {
					push.apply( results, context.getElementsByClassName( m ) );
					return results;
				}
			}

			// Take advantage of querySelectorAll
			if ( !nonnativeSelectorCache[ selector + " " ] &&
				( !rbuggyQSA || !rbuggyQSA.test( selector ) ) ) {

				newSelector = selector;
				newContext = context;

				// qSA considers elements outside a scoping root when evaluating child or
				// descendant combinators, which is not what we want.
				// In such cases, we work around the behavior by prefixing every selector in the
				// list with an ID selector referencing the scope context.
				// The technique has to be used as well when a leading combinator is used
				// as such selectors are not recognized by querySelectorAll.
				// Thanks to Andrew Dupont for this technique.
				if ( nodeType === 1 &&
					( rdescend.test( selector ) || rleadingCombinator.test( selector ) ) ) {

					// Expand context for sibling selectors
					newContext = rsibling.test( selector ) && testContext( context.parentNode ) ||
						context;

					// We can use :scope instead of the ID hack if the browser
					// supports it & if we're not changing the context.
					// Support: IE 11+, Edge 17 - 18+
					// IE/Edge sometimes throw a "Permission denied" error when
					// strict-comparing two documents; shallow comparisons work.
					// eslint-disable-next-line eqeqeq
					if ( newContext != context || !support.scope ) {

						// Capture the context ID, setting it first if necessary
						if ( ( nid = context.getAttribute( "id" ) ) ) {
							nid = jQuery.escapeSelector( nid );
						} else {
							context.setAttribute( "id", ( nid = expando ) );
						}
					}

					// Prefix every selector in the list
					groups = tokenize( selector );
					i = groups.length;
					while ( i-- ) {
						groups[ i ] = ( nid ? "#" + nid : ":scope" ) + " " +
							toSelector( groups[ i ] );
					}
					newSelector = groups.join( "," );
				}

				try {
					push.apply( results,
						newContext.querySelectorAll( newSelector )
					);
					return results;
				} catch ( qsaError ) {
					nonnativeSelectorCache( selector, true );
				} finally {
					if ( nid === expando ) {
						context.removeAttribute( "id" );
					}
				}
			}
		}
	}

	// All others
	return select( selector.replace( rtrimCSS, "$1" ), context, results, seed );
}

/**
 * Create key-value caches of limited size
 * @returns {function(string, object)} Returns the Object data after storing it on itself with
 *	property name the (space-suffixed) string and (if the cache is larger than Expr.cacheLength)
 *	deleting the oldest entry
 */
function createCache() {
	var keys = [];

	function cache( key, value ) {

		// Use (key + " ") to avoid collision with native prototype properties
		// (see https://github.com/jquery/sizzle/issues/157)
		if ( keys.push( key + " " ) > Expr.cacheLength ) {

			// Only keep the most recent entries
			delete cache[ keys.shift() ];
		}
		return ( cache[ key + " " ] = value );
	}
	return cache;
}

/**
 * Mark a function for special use by jQuery selector module
 * @param {Function} fn The function to mark
 */
function markFunction( fn ) {
	fn[ expando ] = true;
	return fn;
}

/**
 * Support testing using an element
 * @param {Function} fn Passed the created element and returns a boolean result
 */
function assert( fn ) {
	var el = document.createElement( "fieldset" );

	try {
		return !!fn( el );
	} catch ( e ) {
		return false;
	} finally {

		// Remove from its parent by default
		if ( el.parentNode ) {
			el.parentNode.removeChild( el );
		}

		// release memory in IE
		el = null;
	}
}

/**
 * Returns a function to use in pseudos for input types
 * @param {String} type
 */
function createInputPseudo( type ) {
	return function( elem ) {
		return nodeName( elem, "input" ) && elem.type === type;
	};
}

/**
 * Returns a function to use in pseudos for buttons
 * @param {String} type
 */
function createButtonPseudo( type ) {
	return function( elem ) {
		return ( nodeName( elem, "input" ) || nodeName( elem, "button" ) ) &&
			elem.type === type;
	};
}

/**
 * Returns a function to use in pseudos for :enabled/:disabled
 * @param {Boolean} disabled true for :disabled; false for :enabled
 */
function createDisabledPseudo( disabled ) {

	// Known :disabled false positives: fieldset[disabled] > legend:nth-of-type(n+2) :can-disable
	return function( elem ) {

		// Only certain elements can match :enabled or :disabled
		// https://html.spec.whatwg.org/multipage/scripting.html#selector-enabled
		// https://html.spec.whatwg.org/multipage/scripting.html#selector-disabled
		if ( "form" in elem ) {

			// Check for inherited disabledness on relevant non-disabled elements:
			// * listed form-associated elements in a disabled fieldset
			//   https://html.spec.whatwg.org/multipage/forms.html#category-listed
			//   https://html.spec.whatwg.org/multipage/forms.html#concept-fe-disabled
			// * option elements in a disabled optgroup
			//   https://html.spec.whatwg.org/multipage/forms.html#concept-option-disabled
			// All such elements have a "form" property.
			if ( elem.parentNode && elem.disabled === false ) {

				// Option elements defer to a parent optgroup if present
				if ( "label" in elem ) {
					if ( "label" in elem.parentNode ) {
						return elem.parentNode.disabled === disabled;
					} else {
						return elem.disabled === disabled;
					}
				}

				// Support: IE 6 - 11+
				// Use the isDisabled shortcut property to check for disabled fieldset ancestors
				return elem.isDisabled === disabled ||

					// Where there is no isDisabled, check manually
					elem.isDisabled !== !disabled &&
						inDisabledFieldset( elem ) === disabled;
			}

			return elem.disabled === disabled;

		// Try to winnow out elements that can't be disabled before trusting the disabled property.
		// Some victims get caught in our net (label, legend, menu, track), but it shouldn't
		// even exist on them, let alone have a boolean value.
		} else if ( "label" in elem ) {
			return elem.disabled === disabled;
		}

		// Remaining elements are neither :enabled nor :disabled
		return false;
	};
}

/**
 * Returns a function to use in pseudos for positionals
 * @param {Function} fn
 */
function createPositionalPseudo( fn ) {
	return markFunction( function( argument ) {
		argument = +argument;
		return markFunction( function( seed, matches ) {
			var j,
				matchIndexes = fn( [], seed.length, argument ),
				i = matchIndexes.length;

			// Match elements found at the specified indexes
			while ( i-- ) {
				if ( seed[ ( j = matchIndexes[ i ] ) ] ) {
					seed[ j ] = !( matches[ j ] = seed[ j ] );
				}
			}
		} );
	} );
}

/**
 * Checks a node for validity as a jQuery selector context
 * @param {Element|Object=} context
 * @returns {Element|Object|Boolean} The input node if acceptable, otherwise a falsy value
 */
function testContext( context ) {
	return context && typeof context.getElementsByTagName !== "undefined" && context;
}

/**
 * Sets document-related variables once based on the current document
 * @param {Element|Object} [node] An element or document object to use to set the document
 * @returns {Object} Returns the current document
 */
function setDocument( node ) {
	var subWindow,
		doc = node ? node.ownerDocument || node : preferredDoc;

	// Return early if doc is invalid or already selected
	// Support: IE 11+, Edge 17 - 18+
	// IE/Edge sometimes throw a "Permission denied" error when strict-comparing
	// two documents; shallow comparisons work.
	// eslint-disable-next-line eqeqeq
	if ( doc == document || doc.nodeType !== 9 || !doc.documentElement ) {
		return document;
	}

	// Update global variables
	document = doc;
	documentElement = document.documentElement;
	documentIsHTML = !jQuery.isXMLDoc( document );

	// Support: iOS 7 only, IE 9 - 11+
	// Older browsers didn't support unprefixed `matches`.
	matches = documentElement.matches ||
		documentElement.webkitMatchesSelector ||
		documentElement.msMatchesSelector;

	// Support: IE 9 - 11+, Edge 12 - 18+
	// Accessing iframe documents after unload throws "permission denied" errors
	// (see trac-13936).
	// Limit the fix to IE & Edge Legacy; despite Edge 15+ implementing `matches`,
	// all IE 9+ and Edge Legacy versions implement `msMatchesSelector` as well.
	if ( documentElement.msMatchesSelector &&

		// Support: IE 11+, Edge 17 - 18+
		// IE/Edge sometimes throw a "Permission denied" error when strict-comparing
		// two documents; shallow comparisons work.
		// eslint-disable-next-line eqeqeq
		preferredDoc != document &&
		( subWindow = document.defaultView ) && subWindow.top !== subWindow ) {

		// Support: IE 9 - 11+, Edge 12 - 18+
		subWindow.addEventListener( "unload", unloadHandler );
	}

	// Support: IE <10
	// Check if getElementById returns elements by name
	// The broken getElementById methods don't pick up programmatically-set names,
	// so use a roundabout getElementsByName test
	support.getById = assert( function( el ) {
		documentElement.appendChild( el ).id = jQuery.expando;
		return !document.getElementsByName ||
			!document.getElementsByName( jQuery.expando ).length;
	} );

	// Support: IE 9 only
	// Check to see if it's possible to do matchesSelector
	// on a disconnected node.
	support.disconnectedMatch = assert( function( el ) {
		return matches.call( el, "*" );
	} );

	// Support: IE 9 - 11+, Edge 12 - 18+
	// IE/Edge don't support the :scope pseudo-class.
	support.scope = assert( function() {
		return document.querySelectorAll( ":scope" );
	} );

	// Support: Chrome 105 - 111 only, Safari 15.4 - 16.3 only
	// Make sure the `:has()` argument is parsed unforgivingly.
	// We include `*` in the test to detect buggy implementations that are
	// _selectively_ forgiving (specifically when the list includes at least
	// one valid selector).
	// Note that we treat complete lack of support for `:has()` as if it were
	// spec-compliant support, which is fine because use of `:has()` in such
	// environments will fail in the qSA path and fall back to jQuery traversal
	// anyway.
	support.cssHas = assert( function() {
		try {
			document.querySelector( ":has(*,:jqfake)" );
			return false;
		} catch ( e ) {
			return true;
		}
	} );

	// ID filter and find
	if ( support.getById ) {
		Expr.filter.ID = function( id ) {
			var attrId = id.replace( runescape, funescape );
			return function( elem ) {
				return elem.getAttribute( "id" ) === attrId;
			};
		};
		Expr.find.ID = function( id, context ) {
			if ( typeof context.getElementById !== "undefined" && documentIsHTML ) {
				var elem = context.getElementById( id );
				return elem ? [ elem ] : [];
			}
		};
	} else {
		Expr.filter.ID =  function( id ) {
			var attrId = id.replace( runescape, funescape );
			return function( elem ) {
				var node = typeof elem.getAttributeNode !== "undefined" &&
					elem.getAttributeNode( "id" );
				return node && node.value === attrId;
			};
		};

		// Support: IE 6 - 7 only
		// getElementById is not reliable as a find shortcut
		Expr.find.ID = function( id, context ) {
			if ( typeof context.getElementById !== "undefined" && documentIsHTML ) {
				var node, i, elems,
					elem = context.getElementById( id );

				if ( elem ) {

					// Verify the id attribute
					node = elem.getAttributeNode( "id" );
					if ( node && node.value === id ) {
						return [ elem ];
					}

					// Fall back on getElementsByName
					elems = context.getElementsByName( id );
					i = 0;
					while ( ( elem = elems[ i++ ] ) ) {
						node = elem.getAttributeNode( "id" );
						if ( node && node.value === id ) {
							return [ elem ];
						}
					}
				}

				return [];
			}
		};
	}

	// Tag
	Expr.find.TAG = function( tag, context ) {
		if ( typeof context.getElementsByTagName !== "undefined" ) {
			return context.getElementsByTagName( tag );

		// DocumentFragment nodes don't have gEBTN
		} else {
			return context.querySelectorAll( tag );
		}
	};

	// Class
	Expr.find.CLASS = function( className, context ) {
		if ( typeof context.getElementsByClassName !== "undefined" && documentIsHTML ) {
			return context.getElementsByClassName( className );
		}
	};

	/* QSA/matchesSelector
	---------------------------------------------------------------------- */

	// QSA and matchesSelector support

	rbuggyQSA = [];

	// Build QSA regex
	// Regex strategy adopted from Diego Perini
	assert( function( el ) {

		var input;

		documentElement.appendChild( el ).innerHTML =
			"<a id='" + expando + "' href='' disabled='disabled'></a>" +
			"<select id='" + expando + "-\r\\' disabled='disabled'>" +
			"<option selected=''></option></select>";

		// Support: iOS <=7 - 8 only
		// Boolean attributes and "value" are not treated correctly in some XML documents
		if ( !el.querySelectorAll( "[selected]" ).length ) {
			rbuggyQSA.push( "\\[" + whitespace + "*(?:value|" + booleans + ")" );
		}

		// Support: iOS <=7 - 8 only
		if ( !el.querySelectorAll( "[id~=" + expando + "-]" ).length ) {
			rbuggyQSA.push( "~=" );
		}

		// Support: iOS 8 only
		// https://bugs.webkit.org/show_bug.cgi?id=136851
		// In-page `selector#id sibling-combinator selector` fails
		if ( !el.querySelectorAll( "a#" + expando + "+*" ).length ) {
			rbuggyQSA.push( ".#.+[+~]" );
		}

		// Support: Chrome <=105+, Firefox <=104+, Safari <=15.4+
		// In some of the document kinds, these selectors wouldn't work natively.
		// This is probably OK but for backwards compatibility we want to maintain
		// handling them through jQuery traversal in jQuery 3.x.
		if ( !el.querySelectorAll( ":checked" ).length ) {
			rbuggyQSA.push( ":checked" );
		}

		// Support: Windows 8 Native Apps
		// The type and name attributes are restricted during .innerHTML assignment
		input = document.createElement( "input" );
		input.setAttribute( "type", "hidden" );
		el.appendChild( input ).setAttribute( "name", "D" );

		// Support: IE 9 - 11+
		// IE's :disabled selector does not pick up the children of disabled fieldsets
		// Support: Chrome <=105+, Firefox <=104+, Safari <=15.4+
		// In some of the document kinds, these selectors wouldn't work natively.
		// This is probably OK but for backwards compatibility we want to maintain
		// handling them through jQuery traversal in jQuery 3.x.
		documentElement.appendChild( el ).disabled = true;
		if ( el.querySelectorAll( ":disabled" ).length !== 2 ) {
			rbuggyQSA.push( ":enabled", ":disabled" );
		}

		// Support: IE 11+, Edge 15 - 18+
		// IE 11/Edge don't find elements on a `[name='']` query in some cases.
		// Adding a temporary attribute to the document before the selection works
		// around the issue.
		// Interestingly, IE 10 & older don't seem to have the issue.
		input = document.createElement( "input" );
		input.setAttribute( "name", "" );
		el.appendChild( input );
		if ( !el.querySelectorAll( "[name='']" ).length ) {
			rbuggyQSA.push( "\\[" + whitespace + "*name" + whitespace + "*=" +
				whitespace + "*(?:''|\"\")" );
		}
	} );

	if ( !support.cssHas ) {

		// Support: Chrome 105 - 110+, Safari 15.4 - 16.3+
		// Our regular `try-catch` mechanism fails to detect natively-unsupported
		// pseudo-classes inside `:has()` (such as `:has(:contains("Foo"))`)
		// in browsers that parse the `:has()` argument as a forgiving selector list.
		// https://drafts.csswg.org/selectors/#relational now requires the argument
		// to be parsed unforgivingly, but browsers have not yet fully adjusted.
		rbuggyQSA.push( ":has" );
	}

	rbuggyQSA = rbuggyQSA.length && new RegExp( rbuggyQSA.join( "|" ) );

	/* Sorting
	---------------------------------------------------------------------- */

	// Document order sorting
	sortOrder = function( a, b ) {

		// Flag for duplicate removal
		if ( a === b ) {
			hasDuplicate = true;
			return 0;
		}

		// Sort on method existence if only one input has compareDocumentPosition
		var compare = !a.compareDocumentPosition - !b.compareDocumentPosition;
		if ( compare ) {
			return compare;
		}

		// Calculate position if both inputs belong to the same document
		// Support: IE 11+, Edge 17 - 18+
		// IE/Edge sometimes throw a "Permission denied" error when strict-comparing
		// two documents; shallow comparisons work.
		// eslint-disable-next-line eqeqeq
		compare = ( a.ownerDocument || a ) == ( b.ownerDocument || b ) ?
			a.compareDocumentPosition( b ) :

			// Otherwise we know they are disconnected
			1;

		// Disconnected nodes
		if ( compare & 1 ||
			( !support.sortDetached && b.compareDocumentPosition( a ) === compare ) ) {

			// Choose the first element that is related to our preferred document
			// Support: IE 11+, Edge 17 - 18+
			// IE/Edge sometimes throw a "Permission denied" error when strict-comparing
			// two documents; shallow comparisons work.
			// eslint-disable-next-line eqeqeq
			if ( a === document || a.ownerDocument == preferredDoc &&
				find.contains( preferredDoc, a ) ) {
				return -1;
			}

			// Support: IE 11+, Edge 17 - 18+
			// IE/Edge sometimes throw a "Permission denied" error when strict-comparing
			// two documents; shallow comparisons work.
			// eslint-disable-next-line eqeqeq
			if ( b === document || b.ownerDocument == preferredDoc &&
				find.contains( preferredDoc, b ) ) {
				return 1;
			}

			// Maintain original order
			return sortInput ?
				( indexOf.call( sortInput, a ) - indexOf.call( sortInput, b ) ) :
				0;
		}

		return compare & 4 ? -1 : 1;
	};

	return document;
}

find.matches = function( expr, elements ) {
	return find( expr, null, null, elements );
};

find.matchesSelector = function( elem, expr ) {
	setDocument( elem );

	if ( documentIsHTML &&
		!nonnativeSelectorCache[ expr + " " ] &&
		( !rbuggyQSA || !rbuggyQSA.test( expr ) ) ) {

		try {
			var ret = matches.call( elem, expr );

			// IE 9's matchesSelector returns false on disconnected nodes
			if ( ret || support.disconnectedMatch ||

					// As well, disconnected nodes are said to be in a document
					// fragment in IE 9
					elem.document && elem.document.nodeType !== 11 ) {
				return ret;
			}
		} catch ( e ) {
			nonnativeSelectorCache( expr, true );
		}
	}

	return find( expr, document, null, [ elem ] ).length > 0;
};

find.contains = function( context, elem ) {

	// Set document vars if needed
	// Support: IE 11+, Edge 17 - 18+
	// IE/Edge sometimes throw a "Permission denied" error when strict-comparing
	// two documents; shallow comparisons work.
	// eslint-disable-next-line eqeqeq
	if ( ( context.ownerDocument || context ) != document ) {
		setDocument( context );
	}
	return jQuery.contains( context, elem );
};


find.attr = function( elem, name ) {

	// Set document vars if needed
	// Support: IE 11+, Edge 17 - 18+
	// IE/Edge sometimes throw a "Permission denied" error when strict-comparing
	// two documents; shallow comparisons work.
	// eslint-disable-next-line eqeqeq
	if ( ( elem.ownerDocument || elem ) != document ) {
		setDocument( elem );
	}

	var fn = Expr.attrHandle[ name.toLowerCase() ],

		// Don't get fooled by Object.prototype properties (see trac-13807)
		val = fn && hasOwn.call( Expr.attrHandle, name.toLowerCase() ) ?
			fn( elem, name, !documentIsHTML ) :
			undefined;

	if ( val !== undefined ) {
		return val;
	}

	return elem.getAttribute( name );
};

find.error = function( msg ) {
	throw new Error( "Syntax error, unrecognized expression: " + msg );
};

/**
 * Document sorting and removing duplicates
 * @param {ArrayLike} results
 */
jQuery.uniqueSort = function( results ) {
	var elem,
		duplicates = [],
		j = 0,
		i = 0;

	// Unless we *know* we can detect duplicates, assume their presence
	//
	// Support: Android <=4.0+
	// Testing for detecting duplicates is unpredictable so instead assume we can't
	// depend on duplicate detection in all browsers without a stable sort.
	hasDuplicate = !support.sortStable;
	sortInput = !support.sortStable && slice.call( results, 0 );
	sort.call( results, sortOrder );

	if ( hasDuplicate ) {
		while ( ( elem = results[ i++ ] ) ) {
			if ( elem === results[ i ] ) {
				j = duplicates.push( i );
			}
		}
		while ( j-- ) {
			splice.call( results, duplicates[ j ], 1 );
		}
	}

	// Clear input after sorting to release objects
	// See https://github.com/jquery/sizzle/pull/225
	sortInput = null;

	return results;
};

jQuery.fn.uniqueSort = function() {
	return this.pushStack( jQuery.uniqueSort( slice.apply( this ) ) );
};

Expr = jQuery.expr = {

	// Can be adjusted by the user
	cacheLength: 50,

	createPseudo: markFunction,

	match: matchExpr,

	attrHandle: {},

	find: {},

	relative: {
		">": { dir: "parentNode", first: true },
		" ": { dir: "parentNode" },
		"+": { dir: "previousSibling", first: true },
		"~": { dir: "previousSibling" }
	},

	preFilter: {
		ATTR: function( match ) {
			match[ 1 ] = match[ 1 ].replace( runescape, funescape );

			// Move the given value to match[3] whether quoted or unquoted
			match[ 3 ] = ( match[ 3 ] || match[ 4 ] || match[ 5 ] || "" )
				.replace( runescape, funescape );

			if ( match[ 2 ] === "~=" ) {
				match[ 3 ] = " " + match[ 3 ] + " ";
			}

			return match.slice( 0, 4 );
		},

		CHILD: function( match ) {

			/* matches from matchExpr["CHILD"]
				1 type (only|nth|...)
				2 what (child|of-type)
				3 argument (even|odd|\d*|\d*n([+-]\d+)?|...)
				4 xn-component of xn+y argument ([+-]?\d*n|)
				5 sign of xn-component
				6 x of xn-component
				7 sign of y-component
				8 y of y-component
			*/
			match[ 1 ] = match[ 1 ].toLowerCase();

			if ( match[ 1 ].slice( 0, 3 ) === "nth" ) {

				// nth-* requires argument
				if ( !match[ 3 ] ) {
					find.error( match[ 0 ] );
				}

				// numeric x and y parameters for Expr.filter.CHILD
				// remember that false/true cast respectively to 0/1
				match[ 4 ] = +( match[ 4 ] ?
					match[ 5 ] + ( match[ 6 ] || 1 ) :
					2 * ( match[ 3 ] === "even" || match[ 3 ] === "odd" )
				);
				match[ 5 ] = +( ( match[ 7 ] + match[ 8 ] ) || match[ 3 ] === "odd" );

			// other types prohibit arguments
			} else if ( match[ 3 ] ) {
				find.error( match[ 0 ] );
			}

			return match;
		},

		PSEUDO: function( match ) {
			var excess,
				unquoted = !match[ 6 ] && match[ 2 ];

			if ( matchExpr.CHILD.test( match[ 0 ] ) ) {
				return null;
			}

			// Accept quoted arguments as-is
			if ( match[ 3 ] ) {
				match[ 2 ] = match[ 4 ] || match[ 5 ] || "";

			// Strip excess characters from unquoted arguments
			} else if ( unquoted && rpseudo.test( unquoted ) &&

				// Get excess from tokenize (recursively)
				( excess = tokenize( unquoted, true ) ) &&

				// advance to the next closing parenthesis
				( excess = unquoted.indexOf( ")", unquoted.length - excess ) - unquoted.length ) ) {

				// excess is a negative index
				match[ 0 ] = match[ 0 ].slice( 0, excess );
				match[ 2 ] = unquoted.slice( 0, excess );
			}

			// Return only captures needed by the pseudo filter method (type and argument)
			return match.slice( 0, 3 );
		}
	},

	filter: {

		TAG: function( nodeNameSelector ) {
			var expectedNodeName = nodeNameSelector.replace( runescape, funescape ).toLowerCase();
			return nodeNameSelector === "*" ?
				function() {
					return true;
				} :
				function( elem ) {
					return nodeName( elem, expectedNodeName );
				};
		},

		CLASS: function( className ) {
			var pattern = classCache[ className + " " ];

			return pattern ||
				( pattern = new RegExp( "(^|" + whitespace + ")" + className +
					"(" + whitespace + "|$)" ) ) &&
				classCache( className, function( elem ) {
					return pattern.test(
						typeof elem.className === "string" && elem.className ||
							typeof elem.getAttribute !== "undefined" &&
								elem.getAttribute( "class" ) ||
							""
					);
				} );
		},

		ATTR: function( name, operator, check ) {
			return function( elem ) {
				var result = find.attr( elem, name );

				if ( result == null ) {
					return operator === "!=";
				}
				if ( !operator ) {
					return true;
				}

				result += "";

				if ( operator === "=" ) {
					return result === check;
				}
				if ( operator === "!=" ) {
					return result !== check;
				}
				if ( operator === "^=" ) {
					return check && result.indexOf( check ) === 0;
				}
				if ( operator === "*=" ) {
					return check && result.indexOf( check ) > -1;
				}
				if ( operator === "$=" ) {
					return check && result.slice( -check.length ) === check;
				}
				if ( operator === "~=" ) {
					return ( " " + result.replace( rwhitespace, " " ) + " " )
						.indexOf( check ) > -1;
				}
				if ( operator === "|=" ) {
					return result === check || result.slice( 0, check.length + 1 ) === check + "-";
				}

				return false;
			};
		},

		CHILD: function( type, what, _argument, first, last ) {
			var simple = type.slice( 0, 3 ) !== "nth",
				forward = type.slice( -4 ) !== "last",
				ofType = what === "of-type";

			return first === 1 && last === 0 ?

				// Shortcut for :nth-*(n)
				function( elem ) {
					return !!elem.parentNode;
				} :

				function( elem, _context, xml ) {
					var cache, outerCache, node, nodeIndex, start,
						dir = simple !== forward ? "nextSibling" : "previousSibling",
						parent = elem.parentNode,
						name = ofType && elem.nodeName.toLowerCase(),
						useCache = !xml && !ofType,
						diff = false;

					if ( parent ) {

						// :(first|last|only)-(child|of-type)
						if ( simple ) {
							while ( dir ) {
								node = elem;
								while ( ( node = node[ dir ] ) ) {
									if ( ofType ?
										nodeName( node, name ) :
										node.nodeType === 1 ) {

										return false;
									}
								}

								// Reverse direction for :only-* (if we haven't yet done so)
								start = dir = type === "only" && !start && "nextSibling";
							}
							return true;
						}

						start = [ forward ? parent.firstChild : parent.lastChild ];

						// non-xml :nth-child(...) stores cache data on `parent`
						if ( forward && useCache ) {

							// Seek `elem` from a previously-cached index
							outerCache = parent[ expando ] || ( parent[ expando ] = {} );
							cache = outerCache[ type ] || [];
							nodeIndex = cache[ 0 ] === dirruns && cache[ 1 ];
							diff = nodeIndex && cache[ 2 ];
							node = nodeIndex && parent.childNodes[ nodeIndex ];

							while ( ( node = ++nodeIndex && node && node[ dir ] ||

								// Fallback to seeking `elem` from the start
								( diff = nodeIndex = 0 ) || start.pop() ) ) {

								// When found, cache indexes on `parent` and break
								if ( node.nodeType === 1 && ++diff && node === elem ) {
									outerCache[ type ] = [ dirruns, nodeIndex, diff ];
									break;
								}
							}

						} else {

							// Use previously-cached element index if available
							if ( useCache ) {
								outerCache = elem[ expando ] || ( elem[ expando ] = {} );
								cache = outerCache[ type ] || [];
								nodeIndex = cache[ 0 ] === dirruns && cache[ 1 ];
								diff = nodeIndex;
							}

							// xml :nth-child(...)
							// or :nth-last-child(...) or :nth(-last)?-of-type(...)
							if ( diff === false ) {

								// Use the same loop as above to seek `elem` from the start
								while ( ( node = ++nodeIndex && node && node[ dir ] ||
									( diff = nodeIndex = 0 ) || start.pop() ) ) {

									if ( ( ofType ?
										nodeName( node, name ) :
										node.nodeType === 1 ) &&
										++diff ) {

										// Cache the index of each encountered element
										if ( useCache ) {
											outerCache = node[ expando ] ||
												( node[ expando ] = {} );
											outerCache[ type ] = [ dirruns, diff ];
										}

										if ( node === elem ) {
											break;
										}
									}
								}
							}
						}

						// Incorporate the offset, then check against cycle size
						diff -= last;
						return diff === first || ( diff % first === 0 && diff / first >= 0 );
					}
				};
		},

		PSEUDO: function( pseudo, argument ) {

			// pseudo-class names are case-insensitive
			// https://www.w3.org/TR/selectors/#pseudo-classes
			// Prioritize by case sensitivity in case custom pseudos are added with uppercase letters
			// Remember that setFilters inherits from pseudos
			var args,
				fn = Expr.pseudos[ pseudo ] || Expr.setFilters[ pseudo.toLowerCase() ] ||
					find.error( "unsupported pseudo: " + pseudo );

			// The user may use createPseudo to indicate that
			// arguments are needed to create the filter function
			// just as jQuery does
			if ( fn[ expando ] ) {
				return fn( argument );
			}

			// But maintain support for old signatures
			if ( fn.length > 1 ) {
				args = [ pseudo, pseudo, "", argument ];
				return Expr.setFilters.hasOwnProperty( pseudo.toLowerCase() ) ?
					markFunction( function( seed, matches ) {
						var idx,
							matched = fn( seed, argument ),
							i = matched.length;
						while ( i-- ) {
							idx = indexOf.call( seed, matched[ i ] );
							seed[ idx ] = !( matches[ idx ] = matched[ i ] );
						}
					} ) :
					function( elem ) {
						return fn( elem, 0, args );
					};
			}

			return fn;
		}
	},

	pseudos: {

		// Potentially complex pseudos
		not: markFunction( function( selector ) {

			// Trim the selector passed to compile
			// to avoid treating leading and trailing
			// spaces as combinators
			var input = [],
				results = [],
				matcher = compile( selector.replace( rtrimCSS, "$1" ) );

			return matcher[ expando ] ?
				markFunction( function( seed, matches, _context, xml ) {
					var elem,
						unmatched = matcher( seed, null, xml, [] ),
						i = seed.length;

					// Match elements unmatched by `matcher`
					while ( i-- ) {
						if ( ( elem = unmatched[ i ] ) ) {
							seed[ i ] = !( matches[ i ] = elem );
						}
					}
				} ) :
				function( elem, _context, xml ) {
					input[ 0 ] = elem;
					matcher( input, null, xml, results );

					// Don't keep the element
					// (see https://github.com/jquery/sizzle/issues/299)
					input[ 0 ] = null;
					return !results.pop();
				};
		} ),

		has: markFunction( function( selector ) {
			return function( elem ) {
				return find( selector, elem ).length > 0;
			};
		} ),

		contains: markFunction( function( text ) {
			text = text.replace( runescape, funescape );
			return function( elem ) {
				return ( elem.textContent || jQuery.text( elem ) ).indexOf( text ) > -1;
			};
		} ),

		// "Whether an element is represented by a :lang() selector
		// is based solely on the element's language value
		// being equal to the identifier C,
		// or beginning with the identifier C immediately followed by "-".
		// The matching of C against the element's language value is performed case-insensitively.
		// The identifier C does not have to be a valid language name."
		// https://www.w3.org/TR/selectors/#lang-pseudo
		lang: markFunction( function( lang ) {

			// lang value must be a valid identifier
			if ( !ridentifier.test( lang || "" ) ) {
				find.error( "unsupported lang: " + lang );
			}
			lang = lang.replace( runescape, funescape ).toLowerCase();
			return function( elem ) {
				var elemLang;
				do {
					if ( ( elemLang = documentIsHTML ?
						elem.lang :
						elem.getAttribute( "xml:lang" ) || elem.getAttribute( "lang" ) ) ) {

						elemLang = elemLang.toLowerCase();
						return elemLang === lang || elemLang.indexOf( lang + "-" ) === 0;
					}
				} while ( ( elem = elem.parentNode ) && elem.nodeType === 1 );
				return false;
			};
		} ),

		// Miscellaneous
		target: function( elem ) {
			var hash = window.location && window.location.hash;
			return hash && hash.slice( 1 ) === elem.id;
		},

		root: function( elem ) {
			return elem === documentElement;
		},

		focus: function( elem ) {
			return elem === safeActiveElement() &&
				document.hasFocus() &&
				!!( elem.type || elem.href || ~elem.tabIndex );
		},

		// Boolean properties
		enabled: createDisabledPseudo( false ),
		disabled: createDisabledPseudo( true ),

		checked: function( elem ) {

			// In CSS3, :checked should return both checked and selected elements
			// https://www.w3.org/TR/2011/REC-css3-selectors-20110929/#checked
			return ( nodeName( elem, "input" ) && !!elem.checked ) ||
				( nodeName( elem, "option" ) && !!elem.selected );
		},

		selected: function( elem ) {

			// Support: IE <=11+
			// Accessing the selectedIndex property
			// forces the browser to treat the default option as
			// selected when in an optgroup.
			if ( elem.parentNode ) {
				// eslint-disable-next-line no-unused-expressions
				elem.parentNode.selectedIndex;
			}

			return elem.selected === true;
		},

		// Contents
		empty: function( elem ) {

			// https://www.w3.org/TR/selectors/#empty-pseudo
			// :empty is negated by element (1) or content nodes (text: 3; cdata: 4; entity ref: 5),
			//   but not by others (comment: 8; processing instruction: 7; etc.)
			// nodeType < 6 works because attributes (2) do not appear as children
			for ( elem = elem.firstChild; elem; elem = elem.nextSibling ) {
				if ( elem.nodeType < 6 ) {
					return false;
				}
			}
			return true;
		},

		parent: function( elem ) {
			return !Expr.pseudos.empty( elem );
		},

		// Element/input types
		header: function( elem ) {
			return rheader.test( elem.nodeName );
		},

		input: function( elem ) {
			return rinputs.test( elem.nodeName );
		},

		button: function( elem ) {
			return nodeName( elem, "input" ) && elem.type === "button" ||
				nodeName( elem, "button" );
		},

		text: function( elem ) {
			var attr;
			return nodeName( elem, "input" ) && elem.type === "text" &&

				// Support: IE <10 only
				// New HTML5 attribute values (e.g., "search") appear
				// with elem.type === "text"
				( ( attr = elem.getAttribute( "type" ) ) == null ||
					attr.toLowerCase() === "text" );
		},

		// Position-in-collection
		first: createPositionalPseudo( function() {
			return [ 0 ];
		} ),

		last: createPositionalPseudo( function( _matchIndexes, length ) {
			return [ length - 1 ];
		} ),

		eq: createPositionalPseudo( function( _matchIndexes, length, argument ) {
			return [ argument < 0 ? argument + length : argument ];
		} ),

		even: createPositionalPseudo( function( matchIndexes, length ) {
			var i = 0;
			for ( ; i < length; i += 2 ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		} ),

		odd: createPositionalPseudo( function( matchIndexes, length ) {
			var i = 1;
			for ( ; i < length; i += 2 ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		} ),

		lt: createPositionalPseudo( function( matchIndexes, length, argument ) {
			var i;

			if ( argument < 0 ) {
				i = argument + length;
			} else if ( argument > length ) {
				i = length;
			} else {
				i = argument;
			}

			for ( ; --i >= 0; ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		} ),

		gt: createPositionalPseudo( function( matchIndexes, length, argument ) {
			var i = argument < 0 ? argument + length : argument;
			for ( ; ++i < length; ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		} )
	}
};

Expr.pseudos.nth = Expr.pseudos.eq;

// Add button/input type pseudos
for ( i in { radio: true, checkbox: true, file: true, password: true, image: true } ) {
	Expr.pseudos[ i ] = createInputPseudo( i );
}
for ( i in { submit: true, reset: true } ) {
	Expr.pseudos[ i ] = createButtonPseudo( i );
}

// Easy API for creating new setFilters
function setFilters() {}
setFilters.prototype = Expr.filters = Expr.pseudos;
Expr.setFilters = new setFilters();

function tokenize( selector, parseOnly ) {
	var matched, match, tokens, type,
		soFar, groups, preFilters,
		cached = tokenCache[ selector + " " ];

	if ( cached ) {
		return parseOnly ? 0 : cached.slice( 0 );
	}

	soFar = selector;
	groups = [];
	preFilters = Expr.preFilter;

	while ( soFar ) {

		// Comma and first run
		if ( !matched || ( match = rcomma.exec( soFar ) ) ) {
			if ( match ) {

				// Don't consume trailing commas as valid
				soFar = soFar.slice( match[ 0 ].length ) || soFar;
			}
			groups.push( ( tokens = [] ) );
		}

		matched = false;

		// Combinators
		if ( ( match = rleadingCombinator.exec( soFar ) ) ) {
			matched = match.shift();
			tokens.push( {
				value: matched,

				// Cast descendant combinators to space
				type: match[ 0 ].replace( rtrimCSS, " " )
			} );
			soFar = soFar.slice( matched.length );
		}

		// Filters
		for ( type in Expr.filter ) {
			if ( ( match = matchExpr[ type ].exec( soFar ) ) && ( !preFilters[ type ] ||
				( match = preFilters[ type ]( match ) ) ) ) {
				matched = match.shift();
				tokens.push( {
					value: matched,
					type: type,
					matches: match
				} );
				soFar = soFar.slice( matched.length );
			}
		}

		if ( !matched ) {
			break;
		}
	}

	// Return the length of the invalid excess
	// if we're just parsing
	// Otherwise, throw an error or return tokens
	if ( parseOnly ) {
		return soFar.length;
	}

	return soFar ?
		find.error( selector ) :

		// Cache the tokens
		tokenCache( selector, groups ).slice( 0 );
}

function toSelector( tokens ) {
	var i = 0,
		len = tokens.length,
		selector = "";
	for ( ; i < len; i++ ) {
		selector += tokens[ i ].value;
	}
	return selector;
}

function addCombinator( matcher, combinator, base ) {
	var dir = combinator.dir,
		skip = combinator.next,
		key = skip || dir,
		checkNonElements = base && key === "parentNode",
		doneName = done++;

	return combinator.first ?

		// Check against closest ancestor/preceding element
		function( elem, context, xml ) {
			while ( ( elem = elem[ dir ] ) ) {
				if ( elem.nodeType === 1 || checkNonElements ) {
					return matcher( elem, context, xml );
				}
			}
			return false;
		} :

		// Check against all ancestor/preceding elements
		function( elem, context, xml ) {
			var oldCache, outerCache,
				newCache = [ dirruns, doneName ];

			// We can't set arbitrary data on XML nodes, so they don't benefit from combinator caching
			if ( xml ) {
				while ( ( elem = elem[ dir ] ) ) {
					if ( elem.nodeType === 1 || checkNonElements ) {
						if ( matcher( elem, context, xml ) ) {
							return true;
						}
					}
				}
			} else {
				while ( ( elem = elem[ dir ] ) ) {
					if ( elem.nodeType === 1 || checkNonElements ) {
						outerCache = elem[ expando ] || ( elem[ expando ] = {} );

						if ( skip && nodeName( elem, skip ) ) {
							elem = elem[ dir ] || elem;
						} else if ( ( oldCache = outerCache[ key ] ) &&
							oldCache[ 0 ] === dirruns && oldCache[ 1 ] === doneName ) {

							// Assign to newCache so results back-propagate to previous elements
							return ( newCache[ 2 ] = oldCache[ 2 ] );
						} else {

							// Reuse newcache so results back-propagate to previous elements
							outerCache[ key ] = newCache;

							// A match means we're done; a fail means we have to keep checking
							if ( ( newCache[ 2 ] = matcher( elem, context, xml ) ) ) {
								return true;
							}
						}
					}
				}
			}
			return false;
		};
}

function elementMatcher( matchers ) {
	return matchers.length > 1 ?
		function( elem, context, xml ) {
			var i = matchers.length;
			while ( i-- ) {
				if ( !matchers[ i ]( elem, context, xml ) ) {
					return false;
				}
			}
			return true;
		} :
		matchers[ 0 ];
}

function multipleContexts( selector, contexts, results ) {
	var i = 0,
		len = contexts.length;
	for ( ; i < len; i++ ) {
		find( selector, contexts[ i ], results );
	}
	return results;
}

function condense( unmatched, map, filter, context, xml ) {
	var elem,
		newUnmatched = [],
		i = 0,
		len = unmatched.length,
		mapped = map != null;

	for ( ; i < len; i++ ) {
		if ( ( elem = unmatched[ i ] ) ) {
			if ( !filter || filter( elem, context, xml ) ) {
				newUnmatched.push( elem );
				if ( mapped ) {
					map.push( i );
				}
			}
		}
	}

	return newUnmatched;
}

function setMatcher( preFilter, selector, matcher, postFilter, postFinder, postSelector ) {
	if ( postFilter && !postFilter[ expando ] ) {
		postFilter = setMatcher( postFilter );
	}
	if ( postFinder && !postFinder[ expando ] ) {
		postFinder = setMatcher( postFinder, postSelector );
	}
	return markFunction( function( seed, results, context, xml ) {
		var temp, i, elem, matcherOut,
			preMap = [],
			postMap = [],
			preexisting = results.length,

			// Get initial elements from seed or context
			elems = seed ||
				multipleContexts( selector || "*",
					context.nodeType ? [ context ] : context, [] ),

			// Prefilter to get matcher input, preserving a map for seed-results synchronization
			matcherIn = preFilter && ( seed || !selector ) ?
				condense( elems, preMap, preFilter, context, xml ) :
				elems;

		if ( matcher ) {

			// If we have a postFinder, or filtered seed, or non-seed postFilter
			// or preexisting results,
			matcherOut = postFinder || ( seed ? preFilter : preexisting || postFilter ) ?

				// ...intermediate processing is necessary
				[] :

				// ...otherwise use results directly
				results;

			// Find primary matches
			matcher( matcherIn, matcherOut, context, xml );
		} else {
			matcherOut = matcherIn;
		}

		// Apply postFilter
		if ( postFilter ) {
			temp = condense( matcherOut, postMap );
			postFilter( temp, [], context, xml );

			// Un-match failing elements by moving them back to matcherIn
			i = temp.length;
			while ( i-- ) {
				if ( ( elem = temp[ i ] ) ) {
					matcherOut[ postMap[ i ] ] = !( matcherIn[ postMap[ i ] ] = elem );
				}
			}
		}

		if ( seed ) {
			if ( postFinder || preFilter ) {
				if ( postFinder ) {

					// Get the final matcherOut by condensing this intermediate into postFinder contexts
					temp = [];
					i = matcherOut.length;
					while ( i-- ) {
						if ( ( elem = matcherOut[ i ] ) ) {

							// Restore matcherIn since elem is not yet a final match
							temp.push( ( matcherIn[ i ] = elem ) );
						}
					}
					postFinder( null, ( matcherOut = [] ), temp, xml );
				}

				// Move matched elements from seed to results to keep them synchronized
				i = matcherOut.length;
				while ( i-- ) {
					if ( ( elem = matcherOut[ i ] ) &&
						( temp = postFinder ? indexOf.call( seed, elem ) : preMap[ i ] ) > -1 ) {

						seed[ temp ] = !( results[ temp ] = elem );
					}
				}
			}

		// Add elements to results, through postFinder if defined
		} else {
			matcherOut = condense(
				matcherOut === results ?
					matcherOut.splice( preexisting, matcherOut.length ) :
					matcherOut
			);
			if ( postFinder ) {
				postFinder( null, results, matcherOut, xml );
			} else {
				push.apply( results, matcherOut );
			}
		}
	} );
}

function matcherFromTokens( tokens ) {
	var checkContext, matcher, j,
		len = tokens.length,
		leadingRelative = Expr.relative[ tokens[ 0 ].type ],
		implicitRelative = leadingRelative || Expr.relative[ " " ],
		i = leadingRelative ? 1 : 0,

		// The foundational matcher ensures that elements are reachable from top-level context(s)
		matchContext = addCombinator( function( elem ) {
			return elem === checkContext;
		}, implicitRelative, true ),
		matchAnyContext = addCombinator( function( elem ) {
			return indexOf.call( checkContext, elem ) > -1;
		}, implicitRelative, true ),
		matchers = [ function( elem, context, xml ) {

			// Support: IE 11+, Edge 17 - 18+
			// IE/Edge sometimes throw a "Permission denied" error when strict-comparing
			// two documents; shallow comparisons work.
			// eslint-disable-next-line eqeqeq
			var ret = ( !leadingRelative && ( xml || context != outermostContext ) ) || (
				( checkContext = context ).nodeType ?
					matchContext( elem, context, xml ) :
					matchAnyContext( elem, context, xml ) );

			// Avoid hanging onto element
			// (see https://github.com/jquery/sizzle/issues/299)
			checkContext = null;
			return ret;
		} ];

	for ( ; i < len; i++ ) {
		if ( ( matcher = Expr.relative[ tokens[ i ].type ] ) ) {
			matchers = [ addCombinator( elementMatcher( matchers ), matcher ) ];
		} else {
			matcher = Expr.filter[ tokens[ i ].type ].apply( null, tokens[ i ].matches );

			// Return special upon seeing a positional matcher
			if ( matcher[ expando ] ) {

				// Find the next relative operator (if any) for proper handling
				j = ++i;
				for ( ; j < len; j++ ) {
					if ( Expr.relative[ tokens[ j ].type ] ) {
						break;
					}
				}
				return setMatcher(
					i > 1 && elementMatcher( matchers ),
					i > 1 && toSelector(

						// If the preceding token was a descendant combinator, insert an implicit any-element `*`
						tokens.slice( 0, i - 1 )
							.concat( { value: tokens[ i - 2 ].type === " " ? "*" : "" } )
					).replace( rtrimCSS, "$1" ),
					matcher,
					i < j && matcherFromTokens( tokens.slice( i, j ) ),
					j < len && matcherFromTokens( ( tokens = tokens.slice( j ) ) ),
					j < len && toSelector( tokens )
				);
			}
			matchers.push( matcher );
		}
	}

	return elementMatcher( matchers );
}

function matcherFromGroupMatchers( elementMatchers, setMatchers ) {
	var bySet = setMatchers.length > 0,
		byElement = elementMatchers.length > 0,
		superMatcher = function( seed, context, xml, results, outermost ) {
			var elem, j, matcher,
				matchedCount = 0,
				i = "0",
				unmatched = seed && [],
				setMatched = [],
				contextBackup = outermostContext,

				// We must always have either seed elements or outermost context
				elems = seed || byElement && Expr.find.TAG( "*", outermost ),

				// Use integer dirruns iff this is the outermost matcher
				dirrunsUnique = ( dirruns += contextBackup == null ? 1 : Math.random() || 0.1 ),
				len = elems.length;

			if ( outermost ) {

				// Support: IE 11+, Edge 17 - 18+
				// IE/Edge sometimes throw a "Permission denied" error when strict-comparing
				// two documents; shallow comparisons work.
				// eslint-disable-next-line eqeqeq
				outermostContext = context == document || context || outermost;
			}

			// Add elements passing elementMatchers directly to results
			// Support: iOS <=7 - 9 only
			// Tolerate NodeList properties (IE: "length"; Safari: <number>) matching
			// elements by id. (see trac-14142)
			for ( ; i !== len && ( elem = elems[ i ] ) != null; i++ ) {
				if ( byElement && elem ) {
					j = 0;

					// Support: IE 11+, Edge 17 - 18+
					// IE/Edge sometimes throw a "Permission denied" error when strict-comparing
					// two documents; shallow comparisons work.
					// eslint-disable-next-line eqeqeq
					if ( !context && elem.ownerDocument != document ) {
						setDocument( elem );
						xml = !documentIsHTML;
					}
					while ( ( matcher = elementMatchers[ j++ ] ) ) {
						if ( matcher( elem, context || document, xml ) ) {
							push.call( results, elem );
							break;
						}
					}
					if ( outermost ) {
						dirruns = dirrunsUnique;
					}
				}

				// Track unmatched elements for set filters
				if ( bySet ) {

					// They will have gone through all possible matchers
					if ( ( elem = !matcher && elem ) ) {
						matchedCount--;
					}

					// Lengthen the array for every element, matched or not
					if ( seed ) {
						unmatched.push( elem );
					}
				}
			}

			// `i` is now the count of elements visited above, and adding it to `matchedCount`
			// makes the latter nonnegative.
			matchedCount += i;

			// Apply set filters to unmatched elements
			// NOTE: This can be skipped if there are no unmatched elements (i.e., `matchedCount`
			// equals `i`), unless we didn't visit _any_ elements in the above loop because we have
			// no element matchers and no seed.
			// Incrementing an initially-string "0" `i` allows `i` to remain a string only in that
			// case, which will result in a "00" `matchedCount` that differs from `i` but is also
			// numerically zero.
			if ( bySet && i !== matchedCount ) {
				j = 0;
				while ( ( matcher = setMatchers[ j++ ] ) ) {
					matcher( unmatched, setMatched, context, xml );
				}

				if ( seed ) {

					// Reintegrate element matches to eliminate the need for sorting
					if ( matchedCount > 0 ) {
						while ( i-- ) {
							if ( !( unmatched[ i ] || setMatched[ i ] ) ) {
								setMatched[ i ] = pop.call( results );
							}
						}
					}

					// Discard index placeholder values to get only actual matches
					setMatched = condense( setMatched );
				}

				// Add matches to results
				push.apply( results, setMatched );

				// Seedless set matches succeeding multiple successful matchers stipulate sorting
				if ( outermost && !seed && setMatched.length > 0 &&
					( matchedCount + setMatchers.length ) > 1 ) {

					jQuery.uniqueSort( results );
				}
			}

			// Override manipulation of globals by nested matchers
			if ( outermost ) {
				dirruns = dirrunsUnique;
				outermostContext = contextBackup;
			}

			return unmatched;
		};

	return bySet ?
		markFunction( superMatcher ) :
		superMatcher;
}

function compile( selector, match /* Internal Use Only */ ) {
	var i,
		setMatchers = [],
		elementMatchers = [],
		cached = compilerCache[ selector + " " ];

	if ( !cached ) {

		// Generate a function of recursive functions that can be used to check each element
		if ( !match ) {
			match = tokenize( selector );
		}
		i = match.length;
		while ( i-- ) {
			cached = matcherFromTokens( match[ i ] );
			if ( cached[ expando ] ) {
				setMatchers.push( cached );
			} else {
				elementMatchers.push( cached );
			}
		}

		// Cache the compiled function
		cached = compilerCache( selector,
			matcherFromGroupMatchers( elementMatchers, setMatchers ) );

		// Save selector and tokenization
		cached.selector = selector;
	}
	return cached;
}

/**
 * A low-level selection function that works with jQuery's compiled
 *  selector functions
 * @param {String|Function} selector A selector or a pre-compiled
 *  selector function built with jQuery selector compile
 * @param {Element} context
 * @param {Array} [results]
 * @param {Array} [seed] A set of elements to match against
 */
function select( selector, context, results, seed ) {
	var i, tokens, token, type, find,
		compiled = typeof selector === "function" && selector,
		match = !seed && tokenize( ( selector = compiled.selector || selector ) );

	results = results || [];

	// Try to minimize operations if there is only one selector in the list and no seed
	// (the latter of which guarantees us context)
	if ( match.length === 1 ) {

		// Reduce context if the leading compound selector is an ID
		tokens = match[ 0 ] = match[ 0 ].slice( 0 );
		if ( tokens.length > 2 && ( token = tokens[ 0 ] ).type === "ID" &&
				context.nodeType === 9 && documentIsHTML && Expr.relative[ tokens[ 1 ].type ] ) {

			context = ( Expr.find.ID(
				token.matches[ 0 ].replace( runescape, funescape ),
				context
			) || [] )[ 0 ];
			if ( !context ) {
				return results;

			// Precompiled matchers will still verify ancestry, so step up a level
			} else if ( compiled ) {
				context = context.parentNode;
			}

			selector = selector.slice( tokens.shift().value.length );
		}

		// Fetch a seed set for right-to-left matching
		i = matchExpr.needsContext.test( selector ) ? 0 : tokens.length;
		while ( i-- ) {
			token = tokens[ i ];

			// Abort if we hit a combinator
			if ( Expr.relative[ ( type = token.type ) ] ) {
				break;
			}
			if ( ( find = Expr.find[ type ] ) ) {

				// Search, expanding context for leading sibling combinators
				if ( ( seed = find(
					token.matches[ 0 ].replace( runescape, funescape ),
					rsibling.test( tokens[ 0 ].type ) &&
						testContext( context.parentNode ) || context
				) ) ) {

					// If seed is empty or no tokens remain, we can return early
					tokens.splice( i, 1 );
					selector = seed.length && toSelector( tokens );
					if ( !selector ) {
						push.apply( results, seed );
						return results;
					}

					break;
				}
			}
		}
	}

	// Compile and execute a filtering function if one is not provided
	// Provide `match` to avoid retokenization if we modified the selector above
	( compiled || compile( selector, match ) )(
		seed,
		context,
		!documentIsHTML,
		results,
		!context || rsibling.test( selector ) && testContext( context.parentNode ) || context
	);
	return results;
}

// One-time assignments

// Support: Android <=4.0 - 4.1+
// Sort stability
support.sortStable = expando.split( "" ).sort( sortOrder ).join( "" ) === expando;

// Initialize against the default document
setDocument();

// Support: Android <=4.0 - 4.1+
// Detached nodes confoundingly follow *each other*
support.sortDetached = assert( function( el ) {

	// Should return 1, but returns 4 (following)
	return el.compareDocumentPosition( document.createElement( "fieldset" ) ) & 1;
} );

jQuery.find = find;

// Deprecated
jQuery.expr[ ":" ] = jQuery.expr.pseudos;
jQuery.unique = jQuery.uniqueSort;

// These have always been private, but they used to be documented as part of
// Sizzle so let's maintain them for now for backwards compatibility purposes.
find.compile = compile;
find.select = select;
find.setDocument = setDocument;
find.tokenize = tokenize;

find.escape = jQuery.escapeSelector;
find.getText = jQuery.text;
find.isXML = jQuery.isXMLDoc;
find.selectors = jQuery.expr;
find.support = jQuery.support;
find.uniqueSort = jQuery.uniqueSort;

	/* eslint-enable */

} )();


var dir = function( elem, dir, until ) {
	var matched = [],
		truncate = until !== undefined;

	while ( ( elem = elem[ dir ] ) && elem.nodeType !== 9 ) {
		if ( elem.nodeType === 1 ) {
			if ( truncate && jQuery( elem ).is( until ) ) {
				break;
			}
			matched.push( elem );
		}
	}
	return matched;
};


var siblings = function( n, elem ) {
	var matched = [];

	for ( ; n; n = n.nextSibling ) {
		if ( n.nodeType === 1 && n !== elem ) {
			matched.push( n );
		}
	}

	return matched;
};


var rneedsContext = jQuery.expr.match.needsContext;

var rsingleTag = ( /^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i );



// Implement the identical functionality for filter and not
function winnow( elements, qualifier, not ) {
	if ( isFunction( qualifier ) ) {
		return jQuery.grep( elements, function( elem, i ) {
			return !!qualifier.call( elem, i, elem ) !== not;
		} );
	}

	// Single element
	if ( qualifier.nodeType ) {
		return jQuery.grep( elements, function( elem ) {
			return ( elem === qualifier ) !== not;
		} );
	}

	// Arraylike of elements (jQuery, arguments, Array)
	if ( typeof qualifier !== "string" ) {
		return jQuery.grep( elements, function( elem ) {
			return ( indexOf.call( qualifier, elem ) > -1 ) !== not;
		} );
	}

	// Filtered directly for both simple and complex selectors
	return jQuery.filter( qualifier, elements, not );
}

jQuery.filter = function( expr, elems, not ) {
	var elem = elems[ 0 ];

	if ( not ) {
		expr = ":not(" + expr + ")";
	}

	if ( elems.length === 1 && elem.nodeType === 1 ) {
		return jQuery.find.matchesSelector( elem, expr ) ? [ elem ] : [];
	}

	return jQuery.find.matches( expr, jQuery.grep( elems, function( elem ) {
		return elem.nodeType === 1;
	} ) );
};

jQuery.fn.extend( {
	find: function( selector ) {
		var i, ret,
			len = this.length,
			self = this;

		if ( typeof selector !== "string" ) {
			return this.pushStack( jQuery( selector ).filter( function() {
				for ( i = 0; i < len; i++ ) {
					if ( jQuery.contains( self[ i ], this ) ) {
						return true;
					}
				}
			} ) );
		}

		ret = this.pushStack( [] );

		for ( i = 0; i < len; i++ ) {
			jQuery.find( selector, self[ i ], ret );
		}

		return len > 1 ? jQuery.uniqueSort( ret ) : ret;
	},
	filter: function( selector ) {
		return this.pushStack( winnow( this, selector || [], false ) );
	},
	not: function( selector ) {
		return this.pushStack( winnow( this, selector || [], true ) );
	},
	is: function( selector ) {
		return !!winnow(
			this,

			// If this is a positional/relative selector, check membership in the returned set
			// so $("p:first").is("p:last") won't return true for a doc with two "p".
			typeof selector === "string" && rneedsContext.test( selector ) ?
				jQuery( selector ) :
				selector || [],
			false
		).length;
	}
} );


// Initialize a jQuery object


// A central reference to the root jQuery(document)
var rootjQuery,

	// A simple way to check for HTML strings
	// Prioritize #id over <tag> to avoid XSS via location.hash (trac-9521)
	// Strict HTML recognition (trac-11290: must start with <)
	// Shortcut simple #id case for speed
	rquickExpr = /^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/,

	init = jQuery.fn.init = function( selector, context, root ) {
		var match, elem;

		// HANDLE: $(""), $(null), $(undefined), $(false)
		if ( !selector ) {
			return this;
		}

		// Method init() accepts an alternate rootjQuery
		// so migrate can support jQuery.sub (gh-2101)
		root = root || rootjQuery;

		// Handle HTML strings
		if ( typeof selector === "string" ) {
			if ( selector[ 0 ] === "<" &&
				selector[ selector.length - 1 ] === ">" &&
				selector.length >= 3 ) {

				// Assume that strings that start and end with <> are HTML and skip the regex check
				match = [ null, selector, null ];

			} else {
				match = rquickExpr.exec( selector );
			}

			// Match html or make sure no context is specified for #id
			if ( match && ( match[ 1 ] || !context ) ) {

				// HANDLE: $(html) -> $(array)
				if ( match[ 1 ] ) {
					context = context instanceof jQuery ? context[ 0 ] : context;

					// Option to run scripts is true for back-compat
					// Intentionally let the error be thrown if parseHTML is not present
					jQuery.merge( this, jQuery.parseHTML(
						match[ 1 ],
						context && context.nodeType ? context.ownerDocument || context : document,
						true
					) );

					// HANDLE: $(html, props)
					if ( rsingleTag.test( match[ 1 ] ) && jQuery.isPlainObject( context ) ) {
						for ( match in context ) {

							// Properties of context are called as methods if possible
							if ( isFunction( this[ match ] ) ) {
								this[ match ]( context[ match ] );

							// ...and otherwise set as attributes
							} else {
								this.attr( match, context[ match ] );
							}
						}
					}

					return this;

				// HANDLE: $(#id)
				} else {
					elem = document.getElementById( match[ 2 ] );

					if ( elem ) {

						// Inject the element directly into the jQuery object
						this[ 0 ] = elem;
						this.length = 1;
					}
					return this;
				}

			// HANDLE: $(expr, $(...))
			} else if ( !context || context.jquery ) {
				return ( context || root ).find( selector );

			// HANDLE: $(expr, context)
			// (which is just equivalent to: $(context).find(expr)
			} else {
				return this.constructor( context ).find( selector );
			}

		// HANDLE: $(DOMElement)
		} else if ( selector.nodeType ) {
			this[ 0 ] = selector;
			this.length = 1;
			return this;

		// HANDLE: $(function)
		// Shortcut for document ready
		} else if ( isFunction( selector ) ) {
			return root.ready !== undefined ?
				root.ready( selector ) :

				// Execute immediately if ready is not present
				selector( jQuery );
		}

		return jQuery.makeArray( selector, this );
	};

// Give the init function the jQuery prototype for later instantiation
init.prototype = jQuery.fn;

// Initialize central reference
rootjQuery = jQuery( document );


var rparentsprev = /^(?:parents|prev(?:Until|All))/,

	// Methods guaranteed to produce a unique set when starting from a unique set
	guaranteedUnique = {
		children: true,
		contents: true,
		next: true,
		prev: true
	};

jQuery.fn.extend( {
	has: function( target ) {
		var targets = jQuery( target, this ),
			l = targets.length;

		return this.filter( function() {
			var i = 0;
			for ( ; i < l; i++ ) {
				if ( jQuery.contains( this, targets[ i ] ) ) {
					return true;
				}
			}
		} );
	},

	closest: function( selectors, context ) {
		var cur,
			i = 0,
			l = this.length,
			matched = [],
			targets = typeof selectors !== "string" && jQuery( selectors );

		// Positional selectors never match, since there's no _selection_ context
		if ( !rneedsContext.test( selectors ) ) {
			for ( ; i < l; i++ ) {
				for ( cur = this[ i ]; cur && cur !== context; cur = cur.parentNode ) {

					// Always skip document fragments
					if ( cur.nodeType < 11 && ( targets ?
						targets.index( cur ) > -1 :

						// Don't pass non-elements to jQuery#find
						cur.nodeType === 1 &&
							jQuery.find.matchesSelector( cur, selectors ) ) ) {

						matched.push( cur );
						break;
					}
				}
			}
		}

		return this.pushStack( matched.length > 1 ? jQuery.uniqueSort( matched ) : matched );
	},

	// Determine the position of an element within the set
	index: function( elem ) {

		// No argument, return index in parent
		if ( !elem ) {
			return ( this[ 0 ] && this[ 0 ].parentNode ) ? this.first().prevAll().length : -1;
		}

		// Index in selector
		if ( typeof elem === "string" ) {
			return indexOf.call( jQuery( elem ), this[ 0 ] );
		}

		// Locate the position of the desired element
		return indexOf.call( this,

			// If it receives a jQuery object, the first element is used
			elem.jquery ? elem[ 0 ] : elem
		);
	},

	add: function( selector, context ) {
		return this.pushStack(
			jQuery.uniqueSort(
				jQuery.merge( this.get(), jQuery( selector, context ) )
			)
		);
	},

	addBack: function( selector ) {
		return this.add( selector == null ?
			this.prevObject : this.prevObject.filter( selector )
		);
	}
} );

function sibling( cur, dir ) {
	while ( ( cur = cur[ dir ] ) && cur.nodeType !== 1 ) {}
	return cur;
}

jQuery.each( {
	parent: function( elem ) {
		var parent = elem.parentNode;
		return parent && parent.nodeType !== 11 ? parent : null;
	},
	parents: function( elem ) {
		return dir( elem, "parentNode" );
	},
	parentsUntil: function( elem, _i, until ) {
		return dir( elem, "parentNode", until );
	},
	next: function( elem ) {
		return sibling( elem, "nextSibling" );
	},
	prev: function( elem ) {
		return sibling( elem, "previousSibling" );
	},
	nextAll: function( elem ) {
		return dir( elem, "nextSibling" );
	},
	prevAll: function( elem ) {
		return dir( elem, "previousSibling" );
	},
	nextUntil: function( elem, _i, until ) {
		return dir( elem, "nextSibling", until );
	},
	prevUntil: function( elem, _i, until ) {
		return dir( elem, "previousSibling", until );
	},
	siblings: function( elem ) {
		return siblings( ( elem.parentNode || {} ).firstChild, elem );
	},
	children: function( elem ) {
		return siblings( elem.firstChild );
	},
	contents: function( elem ) {
		if ( elem.contentDocument != null &&

			// Support: IE 11+
			// <object> elements with no `data` attribute has an object
			// `contentDocument` with a `null` prototype.
			getProto( elem.contentDocument ) ) {

			return elem.contentDocument;
		}

		// Support: IE 9 - 11 only, iOS 7 only, Android Browser <=4.3 only
		// Treat the template element as a regular one in browsers that
		// don't support it.
		if ( nodeName( elem, "template" ) ) {
			elem = elem.content || elem;
		}

		return jQuery.merge( [], elem.childNodes );
	}
}, function( name, fn ) {
	jQuery.fn[ name ] = function( until, selector ) {
		var matched = jQuery.map( this, fn, until );

		if ( name.slice( -5 ) !== "Until" ) {
			selector = until;
		}

		if ( selector && typeof selector === "string" ) {
			matched = jQuery.filter( selector, matched );
		}

		if ( this.length > 1 ) {

			// Remove duplicates
			if ( !guaranteedUnique[ name ] ) {
				jQuery.uniqueSort( matched );
			}

			// Reverse order for parents* and prev-derivatives
			if ( rparentsprev.test( name ) ) {
				matched.reverse();
			}
		}

		return this.pushStack( matched );
	};
} );
var rnothtmlwhite = ( /[^\x20\t\r\n\f]+/g );



// Convert String-formatted options into Object-formatted ones
function createOptions( options ) {
	var object = {};
	jQuery.each( options.match( rnothtmlwhite ) || [], function( _, flag ) {
		object[ flag ] = true;
	} );
	return object;
}

/*
 * Create a callback list using the following parameters:
 *
 *	options: an optional list of space-separated options that will change how
 *			the callback list behaves or a more traditional option object
 *
 * By default a callback list will act like an event callback list and can be
 * "fired" multiple times.
 *
 * Possible options:
 *
 *	once:			will ensure the callback list can only be fired once (like a Deferred)
 *
 *	memory:			will keep track of previous values and will call any callback added
 *					after the list has been fired right away with the latest "memorized"
 *					values (like a Deferred)
 *
 *	unique:			will ensure a callback can only be added once (no duplicate in the list)
 *
 *	stopOnFalse:	interrupt callings when a callback returns false
 *
 */
jQuery.Callbacks = function( options ) {

	// Convert options from String-formatted to Object-formatted if needed
	// (we check in cache first)
	options = typeof options === "string" ?
		createOptions( options ) :
		jQuery.extend( {}, options );

	var // Flag to know if list is currently firing
		firing,

		// Last fire value for non-forgettable lists
		memory,

		// Flag to know if list was already fired
		fired,

		// Flag to prevent firing
		locked,

		// Actual callback list
		list = [],

		// Queue of execution data for repeatable lists
		queue = [],

		// Index of currently firing callback (modified by add/remove as needed)
		firingIndex = -1,

		// Fire callbacks
		fire = function() {

			// Enforce single-firing
			locked = locked || options.once;

			// Execute callbacks for all pending executions,
			// respecting firingIndex overrides and runtime changes
			fired = firing = true;
			for ( ; queue.length; firingIndex = -1 ) {
				memory = queue.shift();
				while ( ++firingIndex < list.length ) {

					// Run callback and check for early termination
					if ( list[ firingIndex ].apply( memory[ 0 ], memory[ 1 ] ) === false &&
						options.stopOnFalse ) {

						// Jump to end and forget the data so .add doesn't re-fire
						firingIndex = list.length;
						memory = false;
					}
				}
			}

			// Forget the data if we're done with it
			if ( !options.memory ) {
				memory = false;
			}

			firing = false;

			// Clean up if we're done firing for good
			if ( locked ) {

				// Keep an empty list if we have data for future add calls
				if ( memory ) {
					list = [];

				// Otherwise, this object is spent
				} else {
					list = "";
				}
			}
		},

		// Actual Callbacks object
		self = {

			// Add a callback or a collection of callbacks to the list
			add: function() {
				if ( list ) {

					// If we have memory from a past run, we should fire after adding
					if ( memory && !firing ) {
						firingIndex = list.length - 1;
						queue.push( memory );
					}

					( function add( args ) {
						jQuery.each( args, function( _, arg ) {
							if ( isFunction( arg ) ) {
								if ( !options.unique || !self.has( arg ) ) {
									list.push( arg );
								}
							} else if ( arg && arg.length && toType( arg ) !== "string" ) {

								// Inspect recursively
								add( arg );
							}
						} );
					} )( arguments );

					if ( memory && !firing ) {
						fire();
					}
				}
				return this;
			},

			// Remove a callback from the list
			remove: function() {
				jQuery.each( arguments, function( _, arg ) {
					var index;
					while ( ( index = jQuery.inArray( arg, list, index ) ) > -1 ) {
						list.splice( index, 1 );

						// Handle firing indexes
						if ( index <= firingIndex ) {
							firingIndex--;
						}
					}
				} );
				return this;
			},

			// Check if a given callback is in the list.
			// If no argument is given, return whether or not list has callbacks attached.
			has: function( fn ) {
				return fn ?
					jQuery.inArray( fn, list ) > -1 :
					list.length > 0;
			},

			// Remove all callbacks from the list
			empty: function() {
				if ( list ) {
					list = [];
				}
				return this;
			},

			// Disable .fire and .add
			// Abort any current/pending executions
			// Clear all callbacks and values
			disable: function() {
				locked = queue = [];
				list = memory = "";
				return this;
			},
			disabled: function() {
				return !list;
			},

			// Disable .fire
			// Also disable .add unless we have memory (since it would have no effect)
			// Abort any pending executions
			lock: function() {
				locked = queue = [];
				if ( !memory && !firing ) {
					list = memory = "";
				}
				return this;
			},
			locked: function() {
				return !!locked;
			},

			// Call all callbacks with the given context and arguments
			fireWith: function( context, args ) {
				if ( !locked ) {
					args = args || [];
					args = [ context, args.slice ? args.slice() : args ];
					queue.push( args );
					if ( !firing ) {
						fire();
					}
				}
				return this;
			},

			// Call all the callbacks with the given arguments
			fire: function() {
				self.fireWith( this, arguments );
				return this;
			},

			// To know if the callbacks have already been called at least once
			fired: function() {
				return !!fired;
			}
		};

	return self;
};


function Identity( v ) {
	return v;
}
function Thrower( ex ) {
	throw ex;
}

function adoptValue( value, resolve, reject, noValue ) {
	var method;

	try {

		// Check for promise aspect first to privilege synchronous behavior
		if ( value && isFunction( ( method = value.promise ) ) ) {
			method.call( value ).done( resolve ).fail( reject );

		// Other thenables
		} else if ( value && isFunction( ( method = value.then ) ) ) {
			method.call( value, resolve, reject );

		// Other non-thenables
		} else {

			// Control `resolve` arguments by letting Array#slice cast boolean `noValue` to integer:
			// * false: [ value ].slice( 0 ) => resolve( value )
			// * true: [ value ].slice( 1 ) => resolve()
			resolve.apply( undefined, [ value ].slice( noValue ) );
		}

	// For Promises/A+, convert exceptions into rejections
	// Since jQuery.when doesn't unwrap thenables, we can skip the extra checks appearing in
	// Deferred#then to conditionally suppress rejection.
	} catch ( value ) {

		// Support: Android 4.0 only
		// Strict mode functions invoked without .call/.apply get global-object context
		reject.apply( undefined, [ value ] );
	}
}

jQuery.extend( {

	Deferred: function( func ) {
		var tuples = [

				// action, add listener, callbacks,
				// ... .then handlers, argument index, [final state]
				[ "notify", "progress", jQuery.Callbacks( "memory" ),
					jQuery.Callbacks( "memory" ), 2 ],
				[ "resolve", "done", jQuery.Callbacks( "once memory" ),
					jQuery.Callbacks( "once memory" ), 0, "resolved" ],
				[ "reject", "fail", jQuery.Callbacks( "once memory" ),
					jQuery.Callbacks( "once memory" ), 1, "rejected" ]
			],
			state = "pending",
			promise = {
				state: function() {
					return state;
				},
				always: function() {
					deferred.done( arguments ).fail( arguments );
					return this;
				},
				"catch": function( fn ) {
					return promise.then( null, fn );
				},

				// Keep pipe for back-compat
				pipe: function( /* fnDone, fnFail, fnProgress */ ) {
					var fns = arguments;

					return jQuery.Deferred( function( newDefer ) {
						jQuery.each( tuples, function( _i, tuple ) {

							// Map tuples (progress, done, fail) to arguments (done, fail, progress)
							var fn = isFunction( fns[ tuple[ 4 ] ] ) && fns[ tuple[ 4 ] ];

							// deferred.progress(function() { bind to newDefer or newDefer.notify })
							// deferred.done(function() { bind to newDefer or newDefer.resolve })
							// deferred.fail(function() { bind to newDefer or newDefer.reject })
							deferred[ tuple[ 1 ] ]( function() {
								var returned = fn && fn.apply( this, arguments );
								if ( returned && isFunction( returned.promise ) ) {
									returned.promise()
										.progress( newDefer.notify )
										.done( newDefer.resolve )
										.fail( newDefer.reject );
								} else {
									newDefer[ tuple[ 0 ] + "With" ](
										this,
										fn ? [ returned ] : arguments
									);
								}
							} );
						} );
						fns = null;
					} ).promise();
				},
				then: function( onFulfilled, onRejected, onProgress ) {
					var maxDepth = 0;
					function resolve( depth, deferred, handler, special ) {
						return function() {
							var that = this,
								args = arguments,
								mightThrow = function() {
									var returned, then;

									// Support: Promises/A+ section 2.3.3.3.3
									// https://promisesaplus.com/#point-59
									// Ignore double-resolution attempts
									if ( depth < maxDepth ) {
										return;
									}

									returned = handler.apply( that, args );

									// Support: Promises/A+ section 2.3.1
									// https://promisesaplus.com/#point-48
									if ( returned === deferred.promise() ) {
										throw new TypeError( "Thenable self-resolution" );
									}

									// Support: Promises/A+ sections 2.3.3.1, 3.5
									// https://promisesaplus.com/#point-54
									// https://promisesaplus.com/#point-75
									// Retrieve `then` only once
									then = returned &&

										// Support: Promises/A+ section 2.3.4
										// https://promisesaplus.com/#point-64
										// Only check objects and functions for thenability
										( typeof returned === "object" ||
											typeof returned === "function" ) &&
										returned.then;

									// Handle a returned thenable
									if ( isFunction( then ) ) {

										// Special processors (notify) just wait for resolution
										if ( special ) {
											then.call(
												returned,
												resolve( maxDepth, deferred, Identity, special ),
												resolve( maxDepth, deferred, Thrower, special )
											);

										// Normal processors (resolve) also hook into progress
										} else {

											// ...and disregard older resolution values
											maxDepth++;

											then.call(
												returned,
												resolve( maxDepth, deferred, Identity, special ),
												resolve( maxDepth, deferred, Thrower, special ),
												resolve( maxDepth, deferred, Identity,
													deferred.notifyWith )
											);
										}

									// Handle all other returned values
									} else {

										// Only substitute handlers pass on context
										// and multiple values (non-spec behavior)
										if ( handler !== Identity ) {
											that = undefined;
											args = [ returned ];
										}

										// Process the value(s)
										// Default process is resolve
										( special || deferred.resolveWith )( that, args );
									}
								},

								// Only normal processors (resolve) catch and reject exceptions
								process = special ?
									mightThrow :
									function() {
										try {
											mightThrow();
										} catch ( e ) {

											if ( jQuery.Deferred.exceptionHook ) {
												jQuery.Deferred.exceptionHook( e,
													process.error );
											}

											// Support: Promises/A+ section 2.3.3.3.4.1
											// https://promisesaplus.com/#point-61
											// Ignore post-resolution exceptions
											if ( depth + 1 >= maxDepth ) {

												// Only substitute handlers pass on context
												// and multiple values (non-spec behavior)
												if ( handler !== Thrower ) {
													that = undefined;
													args = [ e ];
												}

												deferred.rejectWith( that, args );
											}
										}
									};

							// Support: Promises/A+ section 2.3.3.3.1
							// https://promisesaplus.com/#point-57
							// Re-resolve promises immediately to dodge false rejection from
							// subsequent errors
							if ( depth ) {
								process();
							} else {

								// Call an optional hook to record the error, in case of exception
								// since it's otherwise lost when execution goes async
								if ( jQuery.Deferred.getErrorHook ) {
									process.error = jQuery.Deferred.getErrorHook();

								// The deprecated alias of the above. While the name suggests
								// returning the stack, not an error instance, jQuery just passes
								// it directly to `console.warn` so both will work; an instance
								// just better cooperates with source maps.
								} else if ( jQuery.Deferred.getStackHook ) {
									process.error = jQuery.Deferred.getStackHook();
								}
								window.setTimeout( process );
							}
						};
					}

					return jQuery.Deferred( function( newDefer ) {

						// progress_handlers.add( ... )
						tuples[ 0 ][ 3 ].add(
							resolve(
								0,
								newDefer,
								isFunction( onProgress ) ?
									onProgress :
									Identity,
								newDefer.notifyWith
							)
						);

						// fulfilled_handlers.add( ... )
						tuples[ 1 ][ 3 ].add(
							resolve(
								0,
								newDefer,
								isFunction( onFulfilled ) ?
									onFulfilled :
									Identity
							)
						);

						// rejected_handlers.add( ... )
						tuples[ 2 ][ 3 ].add(
							resolve(
								0,
								newDefer,
								isFunction( onRejected ) ?
									onRejected :
									Thrower
							)
						);
					} ).promise();
				},

				// Get a promise for this deferred
				// If obj is provided, the promise aspect is added to the object
				promise: function( obj ) {
					return obj != null ? jQuery.extend( obj, promise ) : promise;
				}
			},
			deferred = {};

		// Add list-specific methods
		jQuery.each( tuples, function( i, tuple ) {
			var list = tuple[ 2 ],
				stateString = tuple[ 5 ];

			// promise.progress = list.add
			// promise.done = list.add
			// promise.fail = list.add
			promise[ tuple[ 1 ] ] = list.add;

			// Handle state
			if ( stateString ) {
				list.add(
					function() {

						// state = "resolved" (i.e., fulfilled)
						// state = "rejected"
						state = stateString;
					},

					// rejected_callbacks.disable
					// fulfilled_callbacks.disable
					tuples[ 3 - i ][ 2 ].disable,

					// rejected_handlers.disable
					// fulfilled_handlers.disable
					tuples[ 3 - i ][ 3 ].disable,

					// progress_callbacks.lock
					tuples[ 0 ][ 2 ].lock,

					// progress_handlers.lock
					tuples[ 0 ][ 3 ].lock
				);
			}

			// progress_handlers.fire
			// fulfilled_handlers.fire
			// rejected_handlers.fire
			list.add( tuple[ 3 ].fire );

			// deferred.notify = function() { deferred.notifyWith(...) }
			// deferred.resolve = function() { deferred.resolveWith(...) }
			// deferred.reject = function() { deferred.rejectWith(...) }
			deferred[ tuple[ 0 ] ] = function() {
				deferred[ tuple[ 0 ] + "With" ]( this === deferred ? undefined : this, arguments );
				return this;
			};

			// deferred.notifyWith = list.fireWith
			// deferred.resolveWith = list.fireWith
			// deferred.rejectWith = list.fireWith
			deferred[ tuple[ 0 ] + "With" ] = list.fireWith;
		} );

		// Make the deferred a promise
		promise.promise( deferred );

		// Call given func if any
		if ( func ) {
			func.call( deferred, deferred );
		}

		// All done!
		return deferred;
	},

	// Deferred helper
	when: function( singleValue ) {
		var

			// count of uncompleted subordinates
			remaining = arguments.length,

			// count of unprocessed arguments
			i = remaining,

			// subordinate fulfillment data
			resolveContexts = Array( i ),
			resolveValues = slice.call( arguments ),

			// the primary Deferred
			primary = jQuery.Deferred(),

			// subordinate callback factory
			updateFunc = function( i ) {
				return function( value ) {
					resolveContexts[ i ] = this;
					resolveValues[ i ] = arguments.length > 1 ? slice.call( arguments ) : value;
					if ( !( --remaining ) ) {
						primary.resolveWith( resolveContexts, resolveValues );
					}
				};
			};

		// Single- and empty arguments are adopted like Promise.resolve
		if ( remaining <= 1 ) {
			adoptValue( singleValue, primary.done( updateFunc( i ) ).resolve, primary.reject,
				!remaining );

			// Use .then() to unwrap secondary thenables (cf. gh-3000)
			if ( primary.state() === "pending" ||
				isFunction( resolveValues[ i ] && resolveValues[ i ].then ) ) {

				return primary.then();
			}
		}

		// Multiple arguments are aggregated like Promise.all array elements
		while ( i-- ) {
			adoptValue( resolveValues[ i ], updateFunc( i ), primary.reject );
		}

		return primary.promise();
	}
} );


// These usually indicate a programmer mistake during development,
// warn about them ASAP rather than swallowing them by default.
var rerrorNames = /^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;

// If `jQuery.Deferred.getErrorHook` is defined, `asyncError` is an error
// captured before the async barrier to get the original error cause
// which may otherwise be hidden.
jQuery.Deferred.exceptionHook = function( error, asyncError ) {

	// Support: IE 8 - 9 only
	// Console exists when dev tools are open, which can happen at any time
	if ( window.console && window.console.warn && error && rerrorNames.test( error.name ) ) {
		window.console.warn( "jQuery.Deferred exception: " + error.message,
			error.stack, asyncError );
	}
};




jQuery.readyException = function( error ) {
	window.setTimeout( function() {
		throw error;
	} );
};




// The deferred used on DOM ready
var readyList = jQuery.Deferred();

jQuery.fn.ready = function( fn ) {

	readyList
		.then( fn )

		// Wrap jQuery.readyException in a function so that the lookup
		// happens at the time of error handling instead of callback
		// registration.
		.catch( function( error ) {
			jQuery.readyException( error );
		} );

	return this;
};

jQuery.extend( {

	// Is the DOM ready to be used? Set to true once it occurs.
	isReady: false,

	// A counter to track how many items to wait for before
	// the ready event fires. See trac-6781
	readyWait: 1,

	// Handle when the DOM is ready
	ready: function( wait ) {

		// Abort if there are pending holds or we're already ready
		if ( wait === true ? --jQuery.readyWait : jQuery.isReady ) {
			return;
		}

		// Remember that the DOM is ready
		jQuery.isReady = true;

		// If a normal DOM Ready event fired, decrement, and wait if need be
		if ( wait !== true && --jQuery.readyWait > 0 ) {
			return;
		}

		// If there are functions bound, to execute
		readyList.resolveWith( document, [ jQuery ] );
	}
} );

jQuery.ready.then = readyList.then;

// The ready event handler and self cleanup method
function completed() {
	document.removeEventListener( "DOMContentLoaded", completed );
	window.removeEventListener( "load", completed );
	jQuery.ready();
}

// Catch cases where $(document).ready() is called
// after the browser event has already occurred.
// Support: IE <=9 - 10 only
// Older IE sometimes signals "interactive" too soon
if ( document.readyState === "complete" ||
	( document.readyState !== "loading" && !document.documentElement.doScroll ) ) {

	// Handle it asynchronously to allow scripts the opportunity to delay ready
	window.setTimeout( jQuery.ready );

} else {

	// Use the handy event callback
	document.addEventListener( "DOMContentLoaded", completed );

	// A fallback to window.onload, that will always work
	window.addEventListener( "load", completed );
}




// Multifunctional method to get and set values of a collection
// The value/s can optionally be executed if it's a function
var access = function( elems, fn, key, value, chainable, emptyGet, raw ) {
	var i = 0,
		len = elems.length,
		bulk = key == null;

	// Sets many values
	if ( toType( key ) === "object" ) {
		chainable = true;
		for ( i in key ) {
			access( elems, fn, i, key[ i ], true, emptyGet, raw );
		}

	// Sets one value
	} else if ( value !== undefined ) {
		chainable = true;

		if ( !isFunction( value ) ) {
			raw = true;
		}

		if ( bulk ) {

			// Bulk operations run against the entire set
			if ( raw ) {
				fn.call( elems, value );
				fn = null;

			// ...except when executing function values
			} else {
				bulk = fn;
				fn = function( elem, _key, value ) {
					return bulk.call( jQuery( elem ), value );
				};
			}
		}

		if ( fn ) {
			for ( ; i < len; i++ ) {
				fn(
					elems[ i ], key, raw ?
						value :
						value.call( elems[ i ], i, fn( elems[ i ], key ) )
				);
			}
		}
	}

	if ( chainable ) {
		return elems;
	}

	// Gets
	if ( bulk ) {
		return fn.call( elems );
	}

	return len ? fn( elems[ 0 ], key ) : emptyGet;
};


// Matches dashed string for camelizing
var rmsPrefix = /^-ms-/,
	rdashAlpha = /-([a-z])/g;

// Used by camelCase as callback to replace()
function fcamelCase( _all, letter ) {
	return letter.toUpperCase();
}

// Convert dashed to camelCase; used by the css and data modules
// Support: IE <=9 - 11, Edge 12 - 15
// Microsoft forgot to hump their vendor prefix (trac-9572)
function camelCase( string ) {
	return string.replace( rmsPrefix, "ms-" ).replace( rdashAlpha, fcamelCase );
}
var acceptData = function( owner ) {

	// Accepts only:
	//  - Node
	//    - Node.ELEMENT_NODE
	//    - Node.DOCUMENT_NODE
	//  - Object
	//    - Any
	return owner.nodeType === 1 || owner.nodeType === 9 || !( +owner.nodeType );
};




function Data() {
	this.expando = jQuery.expando + Data.uid++;
}

Data.uid = 1;

Data.prototype = {

	cache: function( owner ) {

		// Check if the owner object already has a cache
		var value = owner[ this.expando ];

		// If not, create one
		if ( !value ) {
			value = {};

			// We can accept data for non-element nodes in modern browsers,
			// but we should not, see trac-8335.
			// Always return an empty object.
			if ( acceptData( owner ) ) {

				// If it is a node unlikely to be stringify-ed or looped over
				// use plain assignment
				if ( owner.nodeType ) {
					owner[ this.expando ] = value;

				// Otherwise secure it in a non-enumerable property
				// configurable must be true to allow the property to be
				// deleted when data is removed
				} else {
					Object.defineProperty( owner, this.expando, {
						value: value,
						configurable: true
					} );
				}
			}
		}

		return value;
	},
	set: function( owner, data, value ) {
		var prop,
			cache = this.cache( owner );

		// Handle: [ owner, key, value ] args
		// Always use camelCase key (gh-2257)
		if ( typeof data === "string" ) {
			cache[ camelCase( data ) ] = value;

		// Handle: [ owner, { properties } ] args
		} else {

			// Copy the properties one-by-one to the cache object
			for ( prop in data ) {
				cache[ camelCase( prop ) ] = data[ prop ];
			}
		}
		return cache;
	},
	get: function( owner, key ) {
		return key === undefined ?
			this.cache( owner ) :

			// Always use camelCase key (gh-2257)
			owner[ this.expando ] && owner[ this.expando ][ camelCase( key ) ];
	},
	access: function( owner, key, value ) {

		// In cases where either:
		//
		//   1. No key was specified
		//   2. A string key was specified, but no value provided
		//
		// Take the "read" path and allow the get method to determine
		// which value to return, respectively either:
		//
		//   1. The entire cache object
		//   2. The data stored at the key
		//
		if ( key === undefined ||
				( ( key && typeof key === "string" ) && value === undefined ) ) {

			return this.get( owner, key );
		}

		// When the key is not a string, or both a key and value
		// are specified, set or extend (existing objects) with either:
		//
		//   1. An object of properties
		//   2. A key and value
		//
		this.set( owner, key, value );

		// Since the "set" path can have two possible entry points
		// return the expected data based on which path was taken[*]
		return value !== undefined ? value : key;
	},
	remove: function( owner, key ) {
		var i,
			cache = owner[ this.expando ];

		if ( cache === undefined ) {
			return;
		}

		if ( key !== undefined ) {

			// Support array or space separated string of keys
			if ( Array.isArray( key ) ) {

				// If key is an array of keys...
				// We always set camelCase keys, so remove that.
				key = key.map( camelCase );
			} else {
				key = camelCase( key );

				// If a key with the spaces exists, use it.
				// Otherwise, create an array by matching non-whitespace
				key = key in cache ?
					[ key ] :
					( key.match( rnothtmlwhite ) || [] );
			}

			i = key.length;

			while ( i-- ) {
				delete cache[ key[ i ] ];
			}
		}

		// Remove the expando if there's no more data
		if ( key === undefined || jQuery.isEmptyObject( cache ) ) {

			// Support: Chrome <=35 - 45
			// Webkit & Blink performance suffers when deleting properties
			// from DOM nodes, so set to undefined instead
			// https://bugs.chromium.org/p/chromium/issues/detail?id=378607 (bug restricted)
			if ( owner.nodeType ) {
				owner[ this.expando ] = undefined;
			} else {
				delete owner[ this.expando ];
			}
		}
	},
	hasData: function( owner ) {
		var cache = owner[ this.expando ];
		return cache !== undefined && !jQuery.isEmptyObject( cache );
	}
};
var dataPriv = new Data();

var dataUser = new Data();



//	Implementation Summary
//
//	1. Enforce API surface and semantic compatibility with 1.9.x branch
//	2. Improve the module's maintainability by reducing the storage
//		paths to a single mechanism.
//	3. Use the same single mechanism to support "private" and "user" data.
//	4. _Never_ expose "private" data to user code (TODO: Drop _data, _removeData)
//	5. Avoid exposing implementation details on user objects (eg. expando properties)
//	6. Provide a clear path for implementation upgrade to WeakMap in 2014

var rbrace = /^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,
	rmultiDash = /[A-Z]/g;

function getData( data ) {
	if ( data === "true" ) {
		return true;
	}

	if ( data === "false" ) {
		return false;
	}

	if ( data === "null" ) {
		return null;
	}

	// Only convert to a number if it doesn't change the string
	if ( data === +data + "" ) {
		return +data;
	}

	if ( rbrace.test( data ) ) {
		return JSON.parse( data );
	}

	return data;
}

function dataAttr( elem, key, data ) {
	var name;

	// If nothing was found internally, try to fetch any
	// data from the HTML5 data-* attribute
	if ( data === undefined && elem.nodeType === 1 ) {
		name = "data-" + key.replace( rmultiDash, "-$&" ).toLowerCase();
		data = elem.getAttribute( name );

		if ( typeof data === "string" ) {
			try {
				data = getData( data );
			} catch ( e ) {}

			// Make sure we set the data so it isn't changed later
			dataUser.set( elem, key, data );
		} else {
			data = undefined;
		}
	}
	return data;
}

jQuery.extend( {
	hasData: function( elem ) {
		return dataUser.hasData( elem ) || dataPriv.hasData( elem );
	},

	data: function( elem, name, data ) {
		return dataUser.access( elem, name, data );
	},

	removeData: function( elem, name ) {
		dataUser.remove( elem, name );
	},

	// TODO: Now that all calls to _data and _removeData have been replaced
	// with direct calls to dataPriv methods, these can be deprecated.
	_data: function( elem, name, data ) {
		return dataPriv.access( elem, name, data );
	},

	_removeData: function( elem, name ) {
		dataPriv.remove( elem, name );
	}
} );

jQuery.fn.extend( {
	data: function( key, value ) {
		var i, name, data,
			elem = this[ 0 ],
			attrs = elem && elem.attributes;

		// Gets all values
		if ( key === undefined ) {
			if ( this.length ) {
				data = dataUser.get( elem );

				if ( elem.nodeType === 1 && !dataPriv.get( elem, "hasDataAttrs" ) ) {
					i = attrs.length;
					while ( i-- ) {

						// Support: IE 11 only
						// The attrs elements can be null (trac-14894)
						if ( attrs[ i ] ) {
							name = attrs[ i ].name;
							if ( name.indexOf( "data-" ) === 0 ) {
								name = camelCase( name.slice( 5 ) );
								dataAttr( elem, name, data[ name ] );
							}
						}
					}
					dataPriv.set( elem, "hasDataAttrs", true );
				}
			}

			return data;
		}

		// Sets multiple values
		if ( typeof key === "object" ) {
			return this.each( function() {
				dataUser.set( this, key );
			} );
		}

		return access( this, function( value ) {
			var data;

			// The calling jQuery object (element matches) is not empty
			// (and therefore has an element appears at this[ 0 ]) and the
			// `value` parameter was not undefined. An empty jQuery object
			// will result in `undefined` for elem = this[ 0 ] which will
			// throw an exception if an attempt to read a data cache is made.
			if ( elem && value === undefined ) {

				// Attempt to get data from the cache
				// The key will always be camelCased in Data
				data = dataUser.get( elem, key );
				if ( data !== undefined ) {
					return data;
				}

				// Attempt to "discover" the data in
				// HTML5 custom data-* attrs
				data = dataAttr( elem, key );
				if ( data !== undefined ) {
					return data;
				}

				// We tried really hard, but the data doesn't exist.
				return;
			}

			// Set the data...
			this.each( function() {

				// We always store the camelCased key
				dataUser.set( this, key, value );
			} );
		}, null, value, arguments.length > 1, null, true );
	},

	removeData: function( key ) {
		return this.each( function() {
			dataUser.remove( this, key );
		} );
	}
} );


jQuery.extend( {
	queue: function( elem, type, data ) {
		var queue;

		if ( elem ) {
			type = ( type || "fx" ) + "queue";
			queue = dataPriv.get( elem, type );

			// Speed up dequeue by getting out quickly if this is just a lookup
			if ( data ) {
				if ( !queue || Array.isArray( data ) ) {
					queue = dataPriv.access( elem, type, jQuery.makeArray( data ) );
				} else {
					queue.push( data );
				}
			}
			return queue || [];
		}
	},

	dequeue: function( elem, type ) {
		type = type || "fx";

		var queue = jQuery.queue( elem, type ),
			startLength = queue.length,
			fn = queue.shift(),
			hooks = jQuery._queueHooks( elem, type ),
			next = function() {
				jQuery.dequeue( elem, type );
			};

		// If the fx queue is dequeued, always remove the progress sentinel
		if ( fn === "inprogress" ) {
			fn = queue.shift();
			startLength--;
		}

		if ( fn ) {

			// Add a progress sentinel to prevent the fx queue from being
			// automatically dequeued
			if ( type === "fx" ) {
				queue.unshift( "inprogress" );
			}

			// Clear up the last queue stop function
			delete hooks.stop;
			fn.call( elem, next, hooks );
		}

		if ( !startLength && hooks ) {
			hooks.empty.fire();
		}
	},

	// Not public - generate a queueHooks object, or return the current one
	_queueHooks: function( elem, type ) {
		var key = type + "queueHooks";
		return dataPriv.get( elem, key ) || dataPriv.access( elem, key, {
			empty: jQuery.Callbacks( "once memory" ).add( function() {
				dataPriv.remove( elem, [ type + "queue", key ] );
			} )
		} );
	}
} );

jQuery.fn.extend( {
	queue: function( type, data ) {
		var setter = 2;

		if ( typeof type !== "string" ) {
			data = type;
			type = "fx";
			setter--;
		}

		if ( arguments.length < setter ) {
			return jQuery.queue( this[ 0 ], type );
		}

		return data === undefined ?
			this :
			this.each( function() {
				var queue = jQuery.queue( this, type, data );

				// Ensure a hooks for this queue
				jQuery._queueHooks( this, type );

				if ( type === "fx" && queue[ 0 ] !== "inprogress" ) {
					jQuery.dequeue( this, type );
				}
			} );
	},
	dequeue: function( type ) {
		return this.each( function() {
			jQuery.dequeue( this, type );
		} );
	},
	clearQueue: function( type ) {
		return this.queue( type || "fx", [] );
	},

	// Get a promise resolved when queues of a certain type
	// are emptied (fx is the type by default)
	promise: function( type, obj ) {
		var tmp,
			count = 1,
			defer = jQuery.Deferred(),
			elements = this,
			i = this.length,
			resolve = function() {
				if ( !( --count ) ) {
					defer.resolveWith( elements, [ elements ] );
				}
			};

		if ( typeof type !== "string" ) {
			obj = type;
			type = undefined;
		}
		type = type || "fx";

		while ( i-- ) {
			tmp = dataPriv.get( elements[ i ], type + "queueHooks" );
			if ( tmp && tmp.empty ) {
				count++;
				tmp.empty.add( resolve );
			}
		}
		resolve();
		return defer.promise( obj );
	}
} );
var pnum = ( /[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/ ).source;

var rcssNum = new RegExp( "^(?:([+-])=|)(" + pnum + ")([a-z%]*)$", "i" );


var cssExpand = [ "Top", "Right", "Bottom", "Left" ];

var documentElement = document.documentElement;



	var isAttached = function( elem ) {
			return jQuery.contains( elem.ownerDocument, elem );
		},
		composed = { composed: true };

	// Support: IE 9 - 11+, Edge 12 - 18+, iOS 10.0 - 10.2 only
	// Check attachment across shadow DOM boundaries when possible (gh-3504)
	// Support: iOS 10.0-10.2 only
	// Early iOS 10 versions support `attachShadow` but not `getRootNode`,
	// leading to errors. We need to check for `getRootNode`.
	if ( documentElement.getRootNode ) {
		isAttached = function( elem ) {
			return jQuery.contains( elem.ownerDocument, elem ) ||
				elem.getRootNode( composed ) === elem.ownerDocument;
		};
	}
var isHiddenWithinTree = function( elem, el ) {

		// isHiddenWithinTree might be called from jQuery#filter function;
		// in that case, element will be second argument
		elem = el || elem;

		// Inline style trumps all
		return elem.style.display === "none" ||
			elem.style.display === "" &&

			// Otherwise, check computed style
			// Support: Firefox <=43 - 45
			// Disconnected elements can have computed display: none, so first confirm that elem is
			// in the document.
			isAttached( elem ) &&

			jQuery.css( elem, "display" ) === "none";
	};



function adjustCSS( elem, prop, valueParts, tween ) {
	var adjusted, scale,
		maxIterations = 20,
		currentValue = tween ?
			function() {
				return tween.cur();
			} :
			function() {
				return jQuery.css( elem, prop, "" );
			},
		initial = currentValue(),
		unit = valueParts && valueParts[ 3 ] || ( jQuery.cssNumber[ prop ] ? "" : "px" ),

		// Starting value computation is required for potential unit mismatches
		initialInUnit = elem.nodeType &&
			( jQuery.cssNumber[ prop ] || unit !== "px" && +initial ) &&
			rcssNum.exec( jQuery.css( elem, prop ) );

	if ( initialInUnit && initialInUnit[ 3 ] !== unit ) {

		// Support: Firefox <=54
		// Halve the iteration target value to prevent interference from CSS upper bounds (gh-2144)
		initial = initial / 2;

		// Trust units reported by jQuery.css
		unit = unit || initialInUnit[ 3 ];

		// Iteratively approximate from a nonzero starting point
		initialInUnit = +initial || 1;

		while ( maxIterations-- ) {

			// Evaluate and update our best guess (doubling guesses that zero out).
			// Finish if the scale equals or crosses 1 (making the old*new product non-positive).
			jQuery.style( elem, prop, initialInUnit + unit );
			if ( ( 1 - scale ) * ( 1 - ( scale = currentValue() / initial || 0.5 ) ) <= 0 ) {
				maxIterations = 0;
			}
			initialInUnit = initialInUnit / scale;

		}

		initialInUnit = initialInUnit * 2;
		jQuery.style( elem, prop, initialInUnit + unit );

		// Make sure we update the tween properties later on
		valueParts = valueParts || [];
	}

	if ( valueParts ) {
		initialInUnit = +initialInUnit || +initial || 0;

		// Apply relative offset (+=/-=) if specified
		adjusted = valueParts[ 1 ] ?
			initialInUnit + ( valueParts[ 1 ] + 1 ) * valueParts[ 2 ] :
			+valueParts[ 2 ];
		if ( tween ) {
			tween.unit = unit;
			tween.start = initialInUnit;
			tween.end = adjusted;
		}
	}
	return adjusted;
}


var defaultDisplayMap = {};

function getDefaultDisplay( elem ) {
	var temp,
		doc = elem.ownerDocument,
		nodeName = elem.nodeName,
		display = defaultDisplayMap[ nodeName ];

	if ( display ) {
		return display;
	}

	temp = doc.body.appendChild( doc.createElement( nodeName ) );
	display = jQuery.css( temp, "display" );

	temp.parentNode.removeChild( temp );

	if ( display === "none" ) {
		display = "block";
	}
	defaultDisplayMap[ nodeName ] = display;

	return display;
}

function showHide( elements, show ) {
	var display, elem,
		values = [],
		index = 0,
		length = elements.length;

	// Determine new display value for elements that need to change
	for ( ; index < length; index++ ) {
		elem = elements[ index ];
		if ( !elem.style ) {
			continue;
		}

		display = elem.style.display;
		if ( show ) {

			// Since we force visibility upon cascade-hidden elements, an immediate (and slow)
			// check is required in this first loop unless we have a nonempty display value (either
			// inline or about-to-be-restored)
			if ( display === "none" ) {
				values[ index ] = dataPriv.get( elem, "display" ) || null;
				if ( !values[ index ] ) {
					elem.style.display = "";
				}
			}
			if ( elem.style.display === "" && isHiddenWithinTree( elem ) ) {
				values[ index ] = getDefaultDisplay( elem );
			}
		} else {
			if ( display !== "none" ) {
				values[ index ] = "none";

				// Remember what we're overwriting
				dataPriv.set( elem, "display", display );
			}
		}
	}

	// Set the display of the elements in a second loop to avoid constant reflow
	for ( index = 0; index < length; index++ ) {
		if ( values[ index ] != null ) {
			elements[ index ].style.display = values[ index ];
		}
	}

	return elements;
}

jQuery.fn.extend( {
	show: function() {
		return showHide( this, true );
	},
	hide: function() {
		return showHide( this );
	},
	toggle: function( state ) {
		if ( typeof state === "boolean" ) {
			return state ? this.show() : this.hide();
		}

		return this.each( function() {
			if ( isHiddenWithinTree( this ) ) {
				jQuery( this ).show();
			} else {
				jQuery( this ).hide();
			}
		} );
	}
} );
var rcheckableType = ( /^(?:checkbox|radio)$/i );

var rtagName = ( /<([a-z][^\/\0>\x20\t\r\n\f]*)/i );

var rscriptType = ( /^$|^module$|\/(?:java|ecma)script/i );



( function() {
	var fragment = document.createDocumentFragment(),
		div = fragment.appendChild( document.createElement( "div" ) ),
		input = document.createElement( "input" );

	// Support: Android 4.0 - 4.3 only
	// Check state lost if the name is set (trac-11217)
	// Support: Windows Web Apps (WWA)
	// `name` and `type` must use .setAttribute for WWA (trac-14901)
	input.setAttribute( "type", "radio" );
	input.setAttribute( "checked", "checked" );
	input.setAttribute( "name", "t" );

	div.appendChild( input );

	// Support: Android <=4.1 only
	// Older WebKit doesn't clone checked state correctly in fragments
	support.checkClone = div.cloneNode( true ).cloneNode( true ).lastChild.checked;

	// Support: IE <=11 only
	// Make sure textarea (and checkbox) defaultValue is properly cloned
	div.innerHTML = "<textarea>x</textarea>";
	support.noCloneChecked = !!div.cloneNode( true ).lastChild.defaultValue;

	// Support: IE <=9 only
	// IE <=9 replaces <option> tags with their contents when inserted outside of
	// the select element.
	div.innerHTML = "<option></option>";
	support.option = !!div.lastChild;
} )();


// We have to close these tags to support XHTML (trac-13200)
var wrapMap = {

	// XHTML parsers do not magically insert elements in the
	// same way that tag soup parsers do. So we cannot shorten
	// this by omitting <tbody> or other required elements.
	thead: [ 1, "<table>", "</table>" ],
	col: [ 2, "<table><colgroup>", "</colgroup></table>" ],
	tr: [ 2, "<table><tbody>", "</tbody></table>" ],
	td: [ 3, "<table><tbody><tr>", "</tr></tbody></table>" ],

	_default: [ 0, "", "" ]
};

wrapMap.tbody = wrapMap.tfoot = wrapMap.colgroup = wrapMap.caption = wrapMap.thead;
wrapMap.th = wrapMap.td;

// Support: IE <=9 only
if ( !support.option ) {
	wrapMap.optgroup = wrapMap.option = [ 1, "<select multiple='multiple'>", "</select>" ];
}


function getAll( context, tag ) {

	// Support: IE <=9 - 11 only
	// Use typeof to avoid zero-argument method invocation on host objects (trac-15151)
	var ret;

	if ( typeof context.getElementsByTagName !== "undefined" ) {
		ret = context.getElementsByTagName( tag || "*" );

	} else if ( typeof context.querySelectorAll !== "undefined" ) {
		ret = context.querySelectorAll( tag || "*" );

	} else {
		ret = [];
	}

	if ( tag === undefined || tag && nodeName( context, tag ) ) {
		return jQuery.merge( [ context ], ret );
	}

	return ret;
}


// Mark scripts as having already been evaluated
function setGlobalEval( elems, refElements ) {
	var i = 0,
		l = elems.length;

	for ( ; i < l; i++ ) {
		dataPriv.set(
			elems[ i ],
			"globalEval",
			!refElements || dataPriv.get( refElements[ i ], "globalEval" )
		);
	}
}


var rhtml = /<|&#?\w+;/;

function buildFragment( elems, context, scripts, selection, ignored ) {
	var elem, tmp, tag, wrap, attached, j,
		fragment = context.createDocumentFragment(),
		nodes = [],
		i = 0,
		l = elems.length;

	for ( ; i < l; i++ ) {
		elem = elems[ i ];

		if ( elem || elem === 0 ) {

			// Add nodes directly
			if ( toType( elem ) === "object" ) {

				// Support: Android <=4.0 only, PhantomJS 1 only
				// push.apply(_, arraylike) throws on ancient WebKit
				jQuery.merge( nodes, elem.nodeType ? [ elem ] : elem );

			// Convert non-html into a text node
			} else if ( !rhtml.test( elem ) ) {
				nodes.push( context.createTextNode( elem ) );

			// Convert html into DOM nodes
			} else {
				tmp = tmp || fragment.appendChild( context.createElement( "div" ) );

				// Deserialize a standard representation
				tag = ( rtagName.exec( elem ) || [ "", "" ] )[ 1 ].toLowerCase();
				wrap = wrapMap[ tag ] || wrapMap._default;
				tmp.innerHTML = wrap[ 1 ] + jQuery.htmlPrefilter( elem ) + wrap[ 2 ];

				// Descend through wrappers to the right content
				j = wrap[ 0 ];
				while ( j-- ) {
					tmp = tmp.lastChild;
				}

				// Support: Android <=4.0 only, PhantomJS 1 only
				// push.apply(_, arraylike) throws on ancient WebKit
				jQuery.merge( nodes, tmp.childNodes );

				// Remember the top-level container
				tmp = fragment.firstChild;

				// Ensure the created nodes are orphaned (trac-12392)
				tmp.textContent = "";
			}
		}
	}

	// Remove wrapper from fragment
	fragment.textContent = "";

	i = 0;
	while ( ( elem = nodes[ i++ ] ) ) {

		// Skip elements already in the context collection (trac-4087)
		if ( selection && jQuery.inArray( elem, selection ) > -1 ) {
			if ( ignored ) {
				ignored.push( elem );
			}
			continue;
		}

		attached = isAttached( elem );

		// Append to fragment
		tmp = getAll( fragment.appendChild( elem ), "script" );

		// Preserve script evaluation history
		if ( attached ) {
			setGlobalEval( tmp );
		}

		// Capture executables
		if ( scripts ) {
			j = 0;
			while ( ( elem = tmp[ j++ ] ) ) {
				if ( rscriptType.test( elem.type || "" ) ) {
					scripts.push( elem );
				}
			}
		}
	}

	return fragment;
}


var rtypenamespace = /^([^.]*)(?:\.(.+)|)/;

function returnTrue() {
	return true;
}

function returnFalse() {
	return false;
}

function on( elem, types, selector, data, fn, one ) {
	var origFn, type;

	// Types can be a map of types/handlers
	if ( typeof types === "object" ) {

		// ( types-Object, selector, data )
		if ( typeof selector !== "string" ) {

			// ( types-Object, data )
			data = data || selector;
			selector = undefined;
		}
		for ( type in types ) {
			on( elem, type, selector, data, types[ type ], one );
		}
		return elem;
	}

	if ( data == null && fn == null ) {

		// ( types, fn )
		fn = selector;
		data = selector = undefined;
	} else if ( fn == null ) {
		if ( typeof selector === "string" ) {

			// ( types, selector, fn )
			fn = data;
			data = undefined;
		} else {

			// ( types, data, fn )
			fn = data;
			data = selector;
			selector = undefined;
		}
	}
	if ( fn === false ) {
		fn = returnFalse;
	} else if ( !fn ) {
		return elem;
	}

	if ( one === 1 ) {
		origFn = fn;
		fn = function( event ) {

			// Can use an empty set, since event contains the info
			jQuery().off( event );
			return origFn.apply( this, arguments );
		};

		// Use same guid so caller can remove using origFn
		fn.guid = origFn.guid || ( origFn.guid = jQuery.guid++ );
	}
	return elem.each( function() {
		jQuery.event.add( this, types, fn, data, selector );
	} );
}

/*
 * Helper functions for managing events -- not part of the public interface.
 * Props to Dean Edwards' addEvent library for many of the ideas.
 */
jQuery.event = {

	global: {},

	add: function( elem, types, handler, data, selector ) {

		var handleObjIn, eventHandle, tmp,
			events, t, handleObj,
			special, handlers, type, namespaces, origType,
			elemData = dataPriv.get( elem );

		// Only attach events to objects that accept data
		if ( !acceptData( elem ) ) {
			return;
		}

		// Caller can pass in an object of custom data in lieu of the handler
		if ( handler.handler ) {
			handleObjIn = handler;
			handler = handleObjIn.handler;
			selector = handleObjIn.selector;
		}

		// Ensure that invalid selectors throw exceptions at attach time
		// Evaluate against documentElement in case elem is a non-element node (e.g., document)
		if ( selector ) {
			jQuery.find.matchesSelector( documentElement, selector );
		}

		// Make sure that the handler has a unique ID, used to find/remove it later
		if ( !handler.guid ) {
			handler.guid = jQuery.guid++;
		}

		// Init the element's event structure and main handler, if this is the first
		if ( !( events = elemData.events ) ) {
			events = elemData.events = Object.create( null );
		}
		if ( !( eventHandle = elemData.handle ) ) {
			eventHandle = elemData.handle = function( e ) {

				// Discard the second event of a jQuery.event.trigger() and
				// when an event is called after a page has unloaded
				return typeof jQuery !== "undefined" && jQuery.event.triggered !== e.type ?
					jQuery.event.dispatch.apply( elem, arguments ) : undefined;
			};
		}

		// Handle multiple events separated by a space
		types = ( types || "" ).match( rnothtmlwhite ) || [ "" ];
		t = types.length;
		while ( t-- ) {
			tmp = rtypenamespace.exec( types[ t ] ) || [];
			type = origType = tmp[ 1 ];
			namespaces = ( tmp[ 2 ] || "" ).split( "." ).sort();

			// There *must* be a type, no attaching namespace-only handlers
			if ( !type ) {
				continue;
			}

			// If event changes its type, use the special event handlers for the changed type
			special = jQuery.event.special[ type ] || {};

			// If selector defined, determine special event api type, otherwise given type
			type = ( selector ? special.delegateType : special.bindType ) || type;

			// Update special based on newly reset type
			special = jQuery.event.special[ type ] || {};

			// handleObj is passed to all event handlers
			handleObj = jQuery.extend( {
				type: type,
				origType: origType,
				data: data,
				handler: handler,
				guid: handler.guid,
				selector: selector,
				needsContext: selector && jQuery.expr.match.needsContext.test( selector ),
				namespace: namespaces.join( "." )
			}, handleObjIn );

			// Init the event handler queue if we're the first
			if ( !( handlers = events[ type ] ) ) {
				handlers = events[ type ] = [];
				handlers.delegateCount = 0;

				// Only use addEventListener if the special events handler returns false
				if ( !special.setup ||
					special.setup.call( elem, data, namespaces, eventHandle ) === false ) {

					if ( elem.addEventListener ) {
						elem.addEventListener( type, eventHandle );
					}
				}
			}

			if ( special.add ) {
				special.add.call( elem, handleObj );

				if ( !handleObj.handler.guid ) {
					handleObj.handler.guid = handler.guid;
				}
			}

			// Add to the element's handler list, delegates in front
			if ( selector ) {
				handlers.splice( handlers.delegateCount++, 0, handleObj );
			} else {
				handlers.push( handleObj );
			}

			// Keep track of which events have ever been used, for event optimization
			jQuery.event.global[ type ] = true;
		}

	},

	// Detach an event or set of events from an element
	remove: function( elem, types, handler, selector, mappedTypes ) {

		var j, origCount, tmp,
			events, t, handleObj,
			special, handlers, type, namespaces, origType,
			elemData = dataPriv.hasData( elem ) && dataPriv.get( elem );

		if ( !elemData || !( events = elemData.events ) ) {
			return;
		}

		// Once for each type.namespace in types; type may be omitted
		types = ( types || "" ).match( rnothtmlwhite ) || [ "" ];
		t = types.length;
		while ( t-- ) {
			tmp = rtypenamespace.exec( types[ t ] ) || [];
			type = origType = tmp[ 1 ];
			namespaces = ( tmp[ 2 ] || "" ).split( "." ).sort();

			// Unbind all events (on this namespace, if provided) for the element
			if ( !type ) {
				for ( type in events ) {
					jQuery.event.remove( elem, type + types[ t ], handler, selector, true );
				}
				continue;
			}

			special = jQuery.event.special[ type ] || {};
			type = ( selector ? special.delegateType : special.bindType ) || type;
			handlers = events[ type ] || [];
			tmp = tmp[ 2 ] &&
				new RegExp( "(^|\\.)" + namespaces.join( "\\.(?:.*\\.|)" ) + "(\\.|$)" );

			// Remove matching events
			origCount = j = handlers.length;
			while ( j-- ) {
				handleObj = handlers[ j ];

				if ( ( mappedTypes || origType === handleObj.origType ) &&
					( !handler || handler.guid === handleObj.guid ) &&
					( !tmp || tmp.test( handleObj.namespace ) ) &&
					( !selector || selector === handleObj.selector ||
						selector === "**" && handleObj.selector ) ) {
					handlers.splice( j, 1 );

					if ( handleObj.selector ) {
						handlers.delegateCount--;
					}
					if ( special.remove ) {
						special.remove.call( elem, handleObj );
					}
				}
			}

			// Remove generic event handler if we removed something and no more handlers exist
			// (avoids potential for endless recursion during removal of special event handlers)
			if ( origCount && !handlers.length ) {
				if ( !special.teardown ||
					special.teardown.call( elem, namespaces, elemData.handle ) === false ) {

					jQuery.removeEvent( elem, type, elemData.handle );
				}

				delete events[ type ];
			}
		}

		// Remove data and the expando if it's no longer used
		if ( jQuery.isEmptyObject( events ) ) {
			dataPriv.remove( elem, "handle events" );
		}
	},

	dispatch: function( nativeEvent ) {

		var i, j, ret, matched, handleObj, handlerQueue,
			args = new Array( arguments.length ),

			// Make a writable jQuery.Event from the native event object
			event = jQuery.event.fix( nativeEvent ),

			handlers = (
				dataPriv.get( this, "events" ) || Object.create( null )
			)[ event.type ] || [],
			special = jQuery.event.special[ event.type ] || {};

		// Use the fix-ed jQuery.Event rather than the (read-only) native event
		args[ 0 ] = event;

		for ( i = 1; i < arguments.length; i++ ) {
			args[ i ] = arguments[ i ];
		}

		event.delegateTarget = this;

		// Call the preDispatch hook for the mapped type, and let it bail if desired
		if ( special.preDispatch && special.preDispatch.call( this, event ) === false ) {
			return;
		}

		// Determine handlers
		handlerQueue = jQuery.event.handlers.call( this, event, handlers );

		// Run delegates first; they may want to stop propagation beneath us
		i = 0;
		while ( ( matched = handlerQueue[ i++ ] ) && !event.isPropagationStopped() ) {
			event.currentTarget = matched.elem;

			j = 0;
			while ( ( handleObj = matched.handlers[ j++ ] ) &&
				!event.isImmediatePropagationStopped() ) {

				// If the event is namespaced, then each handler is only invoked if it is
				// specially universal or its namespaces are a superset of the event's.
				if ( !event.rnamespace || handleObj.namespace === false ||
					event.rnamespace.test( handleObj.namespace ) ) {

					event.handleObj = handleObj;
					event.data = handleObj.data;

					ret = ( ( jQuery.event.special[ handleObj.origType ] || {} ).handle ||
						handleObj.handler ).apply( matched.elem, args );

					if ( ret !== undefined ) {
						if ( ( event.result = ret ) === false ) {
							event.preventDefault();
							event.stopPropagation();
						}
					}
				}
			}
		}

		// Call the postDispatch hook for the mapped type
		if ( special.postDispatch ) {
			special.postDispatch.call( this, event );
		}

		return event.result;
	},

	handlers: function( event, handlers ) {
		var i, handleObj, sel, matchedHandlers, matchedSelectors,
			handlerQueue = [],
			delegateCount = handlers.delegateCount,
			cur = event.target;

		// Find delegate handlers
		if ( delegateCount &&

			// Support: IE <=9
			// Black-hole SVG <use> instance trees (trac-13180)
			cur.nodeType &&

			// Support: Firefox <=42
			// Suppress spec-violating clicks indicating a non-primary pointer button (trac-3861)
			// https://www.w3.org/TR/DOM-Level-3-Events/#event-type-click
			// Support: IE 11 only
			// ...but not arrow key "clicks" of radio inputs, which can have `button` -1 (gh-2343)
			!( event.type === "click" && event.button >= 1 ) ) {

			for ( ; cur !== this; cur = cur.parentNode || this ) {

				// Don't check non-elements (trac-13208)
				// Don't process clicks on disabled elements (trac-6911, trac-8165, trac-11382, trac-11764)
				if ( cur.nodeType === 1 && !( event.type === "click" && cur.disabled === true ) ) {
					matchedHandlers = [];
					matchedSelectors = {};
					for ( i = 0; i < delegateCount; i++ ) {
						handleObj = handlers[ i ];

						// Don't conflict with Object.prototype properties (trac-13203)
						sel = handleObj.selector + " ";

						if ( matchedSelectors[ sel ] === undefined ) {
							matchedSelectors[ sel ] = handleObj.needsContext ?
								jQuery( sel, this ).index( cur ) > -1 :
								jQuery.find( sel, this, null, [ cur ] ).length;
						}
						if ( matchedSelectors[ sel ] ) {
							matchedHandlers.push( handleObj );
						}
					}
					if ( matchedHandlers.length ) {
						handlerQueue.push( { elem: cur, handlers: matchedHandlers } );
					}
				}
			}
		}

		// Add the remaining (directly-bound) handlers
		cur = this;
		if ( delegateCount < handlers.length ) {
			handlerQueue.push( { elem: cur, handlers: handlers.slice( delegateCount ) } );
		}

		return handlerQueue;
	},

	addProp: function( name, hook ) {
		Object.defineProperty( jQuery.Event.prototype, name, {
			enumerable: true,
			configurable: true,

			get: isFunction( hook ) ?
				function() {
					if ( this.originalEvent ) {
						return hook( this.originalEvent );
					}
				} :
				function() {
					if ( this.originalEvent ) {
						return this.originalEvent[ name ];
					}
				},

			set: function( value ) {
				Object.defineProperty( this, name, {
					enumerable: true,
					configurable: true,
					writable: true,
					value: value
				} );
			}
		} );
	},

	fix: function( originalEvent ) {
		return originalEvent[ jQuery.expando ] ?
			originalEvent :
			new jQuery.Event( originalEvent );
	},

	special: {
		load: {

			// Prevent triggered image.load events from bubbling to window.load
			noBubble: true
		},
		click: {

			// Utilize native event to ensure correct state for checkable inputs
			setup: function( data ) {

				// For mutual compressibility with _default, replace `this` access with a local var.
				// `|| data` is dead code meant only to preserve the variable through minification.
				var el = this || data;

				// Claim the first handler
				if ( rcheckableType.test( el.type ) &&
					el.click && nodeName( el, "input" ) ) {

					// dataPriv.set( el, "click", ... )
					leverageNative( el, "click", true );
				}

				// Return false to allow normal processing in the caller
				return false;
			},
			trigger: function( data ) {

				// For mutual compressibility with _default, replace `this` access with a local var.
				// `|| data` is dead code meant only to preserve the variable through minification.
				var el = this || data;

				// Force setup before triggering a click
				if ( rcheckableType.test( el.type ) &&
					el.click && nodeName( el, "input" ) ) {

					leverageNative( el, "click" );
				}

				// Return non-false to allow normal event-path propagation
				return true;
			},

			// For cross-browser consistency, suppress native .click() on links
			// Also prevent it if we're currently inside a leveraged native-event stack
			_default: function( event ) {
				var target = event.target;
				return rcheckableType.test( target.type ) &&
					target.click && nodeName( target, "input" ) &&
					dataPriv.get( target, "click" ) ||
					nodeName( target, "a" );
			}
		},

		beforeunload: {
			postDispatch: function( event ) {

				// Support: Firefox 20+
				// Firefox doesn't alert if the returnValue field is not set.
				if ( event.result !== undefined && event.originalEvent ) {
					event.originalEvent.returnValue = event.result;
				}
			}
		}
	}
};

// Ensure the presence of an event listener that handles manually-triggered
// synthetic events by interrupting progress until reinvoked in response to
// *native* events that it fires directly, ensuring that state changes have
// already occurred before other listeners are invoked.
function leverageNative( el, type, isSetup ) {

	// Missing `isSetup` indicates a trigger call, which must force setup through jQuery.event.add
	if ( !isSetup ) {
		if ( dataPriv.get( el, type ) === undefined ) {
			jQuery.event.add( el, type, returnTrue );
		}
		return;
	}

	// Register the controller as a special universal handler for all event namespaces
	dataPriv.set( el, type, false );
	jQuery.event.add( el, type, {
		namespace: false,
		handler: function( event ) {
			var result,
				saved = dataPriv.get( this, type );

			if ( ( event.isTrigger & 1 ) && this[ type ] ) {

				// Interrupt processing of the outer synthetic .trigger()ed event
				if ( !saved ) {

					// Store arguments for use when handling the inner native event
					// There will always be at least one argument (an event object), so this array
					// will not be confused with a leftover capture object.
					saved = slice.call( arguments );
					dataPriv.set( this, type, saved );

					// Trigger the native event and capture its result
					this[ type ]();
					result = dataPriv.get( this, type );
					dataPriv.set( this, type, false );

					if ( saved !== result ) {

						// Cancel the outer synthetic event
						event.stopImmediatePropagation();
						event.preventDefault();

						return result;
					}

				// If this is an inner synthetic event for an event with a bubbling surrogate
				// (focus or blur), assume that the surrogate already propagated from triggering
				// the native event and prevent that from happening again here.
				// This technically gets the ordering wrong w.r.t. to `.trigger()` (in which the
				// bubbling surrogate propagates *after* the non-bubbling base), but that seems
				// less bad than duplication.
				} else if ( ( jQuery.event.special[ type ] || {} ).delegateType ) {
					event.stopPropagation();
				}

			// If this is a native event triggered above, everything is now in order
			// Fire an inner synthetic event with the original arguments
			} else if ( saved ) {

				// ...and capture the result
				dataPriv.set( this, type, jQuery.event.trigger(
					saved[ 0 ],
					saved.slice( 1 ),
					this
				) );

				// Abort handling of the native event by all jQuery handlers while allowing
				// native handlers on the same element to run. On target, this is achieved
				// by stopping immediate propagation just on the jQuery event. However,
				// the native event is re-wrapped by a jQuery one on each level of the
				// propagation so the only way to stop it for jQuery is to stop it for
				// everyone via native `stopPropagation()`. This is not a problem for
				// focus/blur which don't bubble, but it does also stop click on checkboxes
				// and radios. We accept this limitation.
				event.stopPropagation();
				event.isImmediatePropagationStopped = returnTrue;
			}
		}
	} );
}

jQuery.removeEvent = function( elem, type, handle ) {

	// This "if" is needed for plain objects
	if ( elem.removeEventListener ) {
		elem.removeEventListener( type, handle );
	}
};

jQuery.Event = function( src, props ) {

	// Allow instantiation without the 'new' keyword
	if ( !( this instanceof jQuery.Event ) ) {
		return new jQuery.Event( src, props );
	}

	// Event object
	if ( src && src.type ) {
		this.originalEvent = src;
		this.type = src.type;

		// Events bubbling up the document may have been marked as prevented
		// by a handler lower down the tree; reflect the correct value.
		this.isDefaultPrevented = src.defaultPrevented ||
				src.defaultPrevented === undefined &&

				// Support: Android <=2.3 only
				src.returnValue === false ?
			returnTrue :
			returnFalse;

		// Create target properties
		// Support: Safari <=6 - 7 only
		// Target should not be a text node (trac-504, trac-13143)
		this.target = ( src.target && src.target.nodeType === 3 ) ?
			src.target.parentNode :
			src.target;

		this.currentTarget = src.currentTarget;
		this.relatedTarget = src.relatedTarget;

	// Event type
	} else {
		this.type = src;
	}

	// Put explicitly provided properties onto the event object
	if ( props ) {
		jQuery.extend( this, props );
	}

	// Create a timestamp if incoming event doesn't have one
	this.timeStamp = src && src.timeStamp || Date.now();

	// Mark it as fixed
	this[ jQuery.expando ] = true;
};

// jQuery.Event is based on DOM3 Events as specified by the ECMAScript Language Binding
// https://www.w3.org/TR/2003/WD-DOM-Level-3-Events-20030331/ecma-script-binding.html
jQuery.Event.prototype = {
	constructor: jQuery.Event,
	isDefaultPrevented: returnFalse,
	isPropagationStopped: returnFalse,
	isImmediatePropagationStopped: returnFalse,
	isSimulated: false,

	preventDefault: function() {
		var e = this.originalEvent;

		this.isDefaultPrevented = returnTrue;

		if ( e && !this.isSimulated ) {
			e.preventDefault();
		}
	},
	stopPropagation: function() {
		var e = this.originalEvent;

		this.isPropagationStopped = returnTrue;

		if ( e && !this.isSimulated ) {
			e.stopPropagation();
		}
	},
	stopImmediatePropagation: function() {
		var e = this.originalEvent;

		this.isImmediatePropagationStopped = returnTrue;

		if ( e && !this.isSimulated ) {
			e.stopImmediatePropagation();
		}

		this.stopPropagation();
	}
};

// Includes all common event props including KeyEvent and MouseEvent specific props
jQuery.each( {
	altKey: true,
	bubbles: true,
	cancelable: true,
	changedTouches: true,
	ctrlKey: true,
	detail: true,
	eventPhase: true,
	metaKey: true,
	pageX: true,
	pageY: true,
	shiftKey: true,
	view: true,
	"char": true,
	code: true,
	charCode: true,
	key: true,
	keyCode: true,
	button: true,
	buttons: true,
	clientX: true,
	clientY: true,
	offsetX: true,
	offsetY: true,
	pointerId: true,
	pointerType: true,
	screenX: true,
	screenY: true,
	targetTouches: true,
	toElement: true,
	touches: true,
	which: true
}, jQuery.event.addProp );

jQuery.each( { focus: "focusin", blur: "focusout" }, function( type, delegateType ) {

	function focusMappedHandler( nativeEvent ) {
		if ( document.documentMode ) {

			// Support: IE 11+
			// Attach a single focusin/focusout handler on the document while someone wants
			// focus/blur. This is because the former are synchronous in IE while the latter
			// are async. In other browsers, all those handlers are invoked synchronously.

			// `handle` from private data would already wrap the event, but we need
			// to change the `type` here.
			var handle = dataPriv.get( this, "handle" ),
				event = jQuery.event.fix( nativeEvent );
			event.type = nativeEvent.type === "focusin" ? "focus" : "blur";
			event.isSimulated = true;

			// First, handle focusin/focusout
			handle( nativeEvent );

			// ...then, handle focus/blur
			//
			// focus/blur don't bubble while focusin/focusout do; simulate the former by only
			// invoking the handler at the lower level.
			if ( event.target === event.currentTarget ) {

				// The setup part calls `leverageNative`, which, in turn, calls
				// `jQuery.event.add`, so event handle will already have been set
				// by this point.
				handle( event );
			}
		} else {

			// For non-IE browsers, attach a single capturing handler on the document
			// while someone wants focusin/focusout.
			jQuery.event.simulate( delegateType, nativeEvent.target,
				jQuery.event.fix( nativeEvent ) );
		}
	}

	jQuery.event.special[ type ] = {

		// Utilize native event if possible so blur/focus sequence is correct
		setup: function() {

			var attaches;

			// Claim the first handler
			// dataPriv.set( this, "focus", ... )
			// dataPriv.set( this, "blur", ... )
			leverageNative( this, type, true );

			if ( document.documentMode ) {

				// Support: IE 9 - 11+
				// We use the same native handler for focusin & focus (and focusout & blur)
				// so we need to coordinate setup & teardown parts between those events.
				// Use `delegateType` as the key as `type` is already used by `leverageNative`.
				attaches = dataPriv.get( this, delegateType );
				if ( !attaches ) {
					this.addEventListener( delegateType, focusMappedHandler );
				}
				dataPriv.set( this, delegateType, ( attaches || 0 ) + 1 );
			} else {

				// Return false to allow normal processing in the caller
				return false;
			}
		},
		trigger: function() {

			// Force setup before trigger
			leverageNative( this, type );

			// Return non-false to allow normal event-path propagation
			return true;
		},

		teardown: function() {
			var attaches;

			if ( document.documentMode ) {
				attaches = dataPriv.get( this, delegateType ) - 1;
				if ( !attaches ) {
					this.removeEventListener( delegateType, focusMappedHandler );
					dataPriv.remove( this, delegateType );
				} else {
					dataPriv.set( this, delegateType, attaches );
				}
			} else {

				// Return false to indicate standard teardown should be applied
				return false;
			}
		},

		// Suppress native focus or blur if we're currently inside
		// a leveraged native-event stack
		_default: function( event ) {
			return dataPriv.get( event.target, type );
		},

		delegateType: delegateType
	};

	// Support: Firefox <=44
	// Firefox doesn't have focus(in | out) events
	// Related ticket - https://bugzilla.mozilla.org/show_bug.cgi?id=687787
	//
	// Support: Chrome <=48 - 49, Safari <=9.0 - 9.1
	// focus(in | out) events fire after focus & blur events,
	// which is spec violation - http://www.w3.org/TR/DOM-Level-3-Events/#events-focusevent-event-order
	// Related ticket - https://bugs.chromium.org/p/chromium/issues/detail?id=449857
	//
	// Support: IE 9 - 11+
	// To preserve relative focusin/focus & focusout/blur event order guaranteed on the 3.x branch,
	// attach a single handler for both events in IE.
	jQuery.event.special[ delegateType ] = {
		setup: function() {

			// Handle: regular nodes (via `this.ownerDocument`), window
			// (via `this.document`) & document (via `this`).
			var doc = this.ownerDocument || this.document || this,
				dataHolder = document.documentMode ? this : doc,
				attaches = dataPriv.get( dataHolder, delegateType );

			// Support: IE 9 - 11+
			// We use the same native handler for focusin & focus (and focusout & blur)
			// so we need to coordinate setup & teardown parts between those events.
			// Use `delegateType` as the key as `type` is already used by `leverageNative`.
			if ( !attaches ) {
				if ( document.documentMode ) {
					this.addEventListener( delegateType, focusMappedHandler );
				} else {
					doc.addEventListener( type, focusMappedHandler, true );
				}
			}
			dataPriv.set( dataHolder, delegateType, ( attaches || 0 ) + 1 );
		},
		teardown: function() {
			var doc = this.ownerDocument || this.document || this,
				dataHolder = document.documentMode ? this : doc,
				attaches = dataPriv.get( dataHolder, delegateType ) - 1;

			if ( !attaches ) {
				if ( document.documentMode ) {
					this.removeEventListener( delegateType, focusMappedHandler );
				} else {
					doc.removeEventListener( type, focusMappedHandler, true );
				}
				dataPriv.remove( dataHolder, delegateType );
			} else {
				dataPriv.set( dataHolder, delegateType, attaches );
			}
		}
	};
} );

// Create mouseenter/leave events using mouseover/out and event-time checks
// so that event delegation works in jQuery.
// Do the same for pointerenter/pointerleave and pointerover/pointerout
//
// Support: Safari 7 only
// Safari sends mouseenter too often; see:
// https://bugs.chromium.org/p/chromium/issues/detail?id=470258
// for the description of the bug (it existed in older Chrome versions as well).
jQuery.each( {
	mouseenter: "mouseover",
	mouseleave: "mouseout",
	pointerenter: "pointerover",
	pointerleave: "pointerout"
}, function( orig, fix ) {
	jQuery.event.special[ orig ] = {
		delegateType: fix,
		bindType: fix,

		handle: function( event ) {
			var ret,
				target = this,
				related = event.relatedTarget,
				handleObj = event.handleObj;

			// For mouseenter/leave call the handler if related is outside the target.
			// NB: No relatedTarget if the mouse left/entered the browser window
			if ( !related || ( related !== target && !jQuery.contains( target, related ) ) ) {
				event.type = handleObj.origType;
				ret = handleObj.handler.apply( this, arguments );
				event.type = fix;
			}
			return ret;
		}
	};
} );

jQuery.fn.extend( {

	on: function( types, selector, data, fn ) {
		return on( this, types, selector, data, fn );
	},
	one: function( types, selector, data, fn ) {
		return on( this, types, selector, data, fn, 1 );
	},
	off: function( types, selector, fn ) {
		var handleObj, type;
		if ( types && types.preventDefault && types.handleObj ) {

			// ( event )  dispatched jQuery.Event
			handleObj = types.handleObj;
			jQuery( types.delegateTarget ).off(
				handleObj.namespace ?
					handleObj.origType + "." + handleObj.namespace :
					handleObj.origType,
				handleObj.selector,
				handleObj.handler
			);
			return this;
		}
		if ( typeof types === "object" ) {

			// ( types-object [, selector] )
			for ( type in types ) {
				this.off( type, selector, types[ type ] );
			}
			return this;
		}
		if ( selector === false || typeof selector === "function" ) {

			// ( types [, fn] )
			fn = selector;
			selector = undefined;
		}
		if ( fn === false ) {
			fn = returnFalse;
		}
		return this.each( function() {
			jQuery.event.remove( this, types, fn, selector );
		} );
	}
} );


var

	// Support: IE <=10 - 11, Edge 12 - 13 only
	// In IE/Edge using regex groups here causes severe slowdowns.
	// See https://connect.microsoft.com/IE/feedback/details/1736512/
	rnoInnerhtml = /<script|<style|<link/i,

	// checked="checked" or checked
	rchecked = /checked\s*(?:[^=]|=\s*.checked.)/i,

	rcleanScript = /^\s*<!\[CDATA\[|\]\]>\s*$/g;

// Prefer a tbody over its parent table for containing new rows
function manipulationTarget( elem, content ) {
	if ( nodeName( elem, "table" ) &&
		nodeName( content.nodeType !== 11 ? content : content.firstChild, "tr" ) ) {

		return jQuery( elem ).children( "tbody" )[ 0 ] || elem;
	}

	return elem;
}

// Replace/restore the type attribute of script elements for safe DOM manipulation
function disableScript( elem ) {
	elem.type = ( elem.getAttribute( "type" ) !== null ) + "/" + elem.type;
	return elem;
}
function restoreScript( elem ) {
	if ( ( elem.type || "" ).slice( 0, 5 ) === "true/" ) {
		elem.type = elem.type.slice( 5 );
	} else {
		elem.removeAttribute( "type" );
	}

	return elem;
}

function cloneCopyEvent( src, dest ) {
	var i, l, type, pdataOld, udataOld, udataCur, events;

	if ( dest.nodeType !== 1 ) {
		return;
	}

	// 1. Copy private data: events, handlers, etc.
	if ( dataPriv.hasData( src ) ) {
		pdataOld = dataPriv.get( src );
		events = pdataOld.events;

		if ( events ) {
			dataPriv.remove( dest, "handle events" );

			for ( type in events ) {
				for ( i = 0, l = events[ type ].length; i < l; i++ ) {
					jQuery.event.add( dest, type, events[ type ][ i ] );
				}
			}
		}
	}

	// 2. Copy user data
	if ( dataUser.hasData( src ) ) {
		udataOld = dataUser.access( src );
		udataCur = jQuery.extend( {}, udataOld );

		dataUser.set( dest, udataCur );
	}
}

// Fix IE bugs, see support tests
function fixInput( src, dest ) {
	var nodeName = dest.nodeName.toLowerCase();

	// Fails to persist the checked state of a cloned checkbox or radio button.
	if ( nodeName === "input" && rcheckableType.test( src.type ) ) {
		dest.checked = src.checked;

	// Fails to return the selected option to the default selected state when cloning options
	} else if ( nodeName === "input" || nodeName === "textarea" ) {
		dest.defaultValue = src.defaultValue;
	}
}

function domManip( collection, args, callback, ignored ) {

	// Flatten any nested arrays
	args = flat( args );

	var fragment, first, scripts, hasScripts, node, doc,
		i = 0,
		l = collection.length,
		iNoClone = l - 1,
		value = args[ 0 ],
		valueIsFunction = isFunction( value );

	// We can't cloneNode fragments that contain checked, in WebKit
	if ( valueIsFunction ||
			( l > 1 && typeof value === "string" &&
				!support.checkClone && rchecked.test( value ) ) ) {
		return collection.each( function( index ) {
			var self = collection.eq( index );
			if ( valueIsFunction ) {
				args[ 0 ] = value.call( this, index, self.html() );
			}
			domManip( self, args, callback, ignored );
		} );
	}

	if ( l ) {
		fragment = buildFragment( args, collection[ 0 ].ownerDocument, false, collection, ignored );
		first = fragment.firstChild;

		if ( fragment.childNodes.length === 1 ) {
			fragment = first;
		}

		// Require either new content or an interest in ignored elements to invoke the callback
		if ( first || ignored ) {
			scripts = jQuery.map( getAll( fragment, "script" ), disableScript );
			hasScripts = scripts.length;

			// Use the original fragment for the last item
			// instead of the first because it can end up
			// being emptied incorrectly in certain situations (trac-8070).
			for ( ; i < l; i++ ) {
				node = fragment;

				if ( i !== iNoClone ) {
					node = jQuery.clone( node, true, true );

					// Keep references to cloned scripts for later restoration
					if ( hasScripts ) {

						// Support: Android <=4.0 only, PhantomJS 1 only
						// push.apply(_, arraylike) throws on ancient WebKit
						jQuery.merge( scripts, getAll( node, "script" ) );
					}
				}

				callback.call( collection[ i ], node, i );
			}

			if ( hasScripts ) {
				doc = scripts[ scripts.length - 1 ].ownerDocument;

				// Re-enable scripts
				jQuery.map( scripts, restoreScript );

				// Evaluate executable scripts on first document insertion
				for ( i = 0; i < hasScripts; i++ ) {
					node = scripts[ i ];
					if ( rscriptType.test( node.type || "" ) &&
						!dataPriv.access( node, "globalEval" ) &&
						jQuery.contains( doc, node ) ) {

						if ( node.src && ( node.type || "" ).toLowerCase()  !== "module" ) {

							// Optional AJAX dependency, but won't run scripts if not present
							if ( jQuery._evalUrl && !node.noModule ) {
								jQuery._evalUrl( node.src, {
									nonce: node.nonce || node.getAttribute( "nonce" )
								}, doc );
							}
						} else {

							// Unwrap a CDATA section containing script contents. This shouldn't be
							// needed as in XML documents they're already not visible when
							// inspecting element contents and in HTML documents they have no
							// meaning but we're preserving that logic for backwards compatibility.
							// This will be removed completely in 4.0. See gh-4904.
							DOMEval( node.textContent.replace( rcleanScript, "" ), node, doc );
						}
					}
				}
			}
		}
	}

	return collection;
}

function remove( elem, selector, keepData ) {
	var node,
		nodes = selector ? jQuery.filter( selector, elem ) : elem,
		i = 0;

	for ( ; ( node = nodes[ i ] ) != null; i++ ) {
		if ( !keepData && node.nodeType === 1 ) {
			jQuery.cleanData( getAll( node ) );
		}

		if ( node.parentNode ) {
			if ( keepData && isAttached( node ) ) {
				setGlobalEval( getAll( node, "script" ) );
			}
			node.parentNode.removeChild( node );
		}
	}

	return elem;
}

jQuery.extend( {
	htmlPrefilter: function( html ) {
		return html;
	},

	clone: function( elem, dataAndEvents, deepDataAndEvents ) {
		var i, l, srcElements, destElements,
			clone = elem.cloneNode( true ),
			inPage = isAttached( elem );

		// Fix IE cloning issues
		if ( !support.noCloneChecked && ( elem.nodeType === 1 || elem.nodeType === 11 ) &&
				!jQuery.isXMLDoc( elem ) ) {

			// We eschew jQuery#find here for performance reasons:
			// https://jsperf.com/getall-vs-sizzle/2
			destElements = getAll( clone );
			srcElements = getAll( elem );

			for ( i = 0, l = srcElements.length; i < l; i++ ) {
				fixInput( srcElements[ i ], destElements[ i ] );
			}
		}

		// Copy the events from the original to the clone
		if ( dataAndEvents ) {
			if ( deepDataAndEvents ) {
				srcElements = srcElements || getAll( elem );
				destElements = destElements || getAll( clone );

				for ( i = 0, l = srcElements.length; i < l; i++ ) {
					cloneCopyEvent( srcElements[ i ], destElements[ i ] );
				}
			} else {
				cloneCopyEvent( elem, clone );
			}
		}

		// Preserve script evaluation history
		destElements = getAll( clone, "script" );
		if ( destElements.length > 0 ) {
			setGlobalEval( destElements, !inPage && getAll( elem, "script" ) );
		}

		// Return the cloned set
		return clone;
	},

	cleanData: function( elems ) {
		var data, elem, type,
			special = jQuery.event.special,
			i = 0;

		for ( ; ( elem = elems[ i ] ) !== undefined; i++ ) {
			if ( acceptData( elem ) ) {
				if ( ( data = elem[ dataPriv.expando ] ) ) {
					if ( data.events ) {
						for ( type in data.events ) {
							if ( special[ type ] ) {
								jQuery.event.remove( elem, type );

							// This is a shortcut to avoid jQuery.event.remove's overhead
							} else {
								jQuery.removeEvent( elem, type, data.handle );
							}
						}
					}

					// Support: Chrome <=35 - 45+
					// Assign undefined instead of using delete, see Data#remove
					elem[ dataPriv.expando ] = undefined;
				}
				if ( elem[ dataUser.expando ] ) {

					// Support: Chrome <=35 - 45+
					// Assign undefined instead of using delete, see Data#remove
					elem[ dataUser.expando ] = undefined;
				}
			}
		}
	}
} );

jQuery.fn.extend( {
	detach: function( selector ) {
		return remove( this, selector, true );
	},

	remove: function( selector ) {
		return remove( this, selector );
	},

	text: function( value ) {
		return access( this, function( value ) {
			return value === undefined ?
				jQuery.text( this ) :
				this.empty().each( function() {
					if ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {
						this.textContent = value;
					}
				} );
		}, null, value, arguments.length );
	},

	append: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {
				var target = manipulationTarget( this, elem );
				target.appendChild( elem );
			}
		} );
	},

	prepend: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {
				var target = manipulationTarget( this, elem );
				target.insertBefore( elem, target.firstChild );
			}
		} );
	},

	before: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.parentNode ) {
				this.parentNode.insertBefore( elem, this );
			}
		} );
	},

	after: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.parentNode ) {
				this.parentNode.insertBefore( elem, this.nextSibling );
			}
		} );
	},

	empty: function() {
		var elem,
			i = 0;

		for ( ; ( elem = this[ i ] ) != null; i++ ) {
			if ( elem.nodeType === 1 ) {

				// Prevent memory leaks
				jQuery.cleanData( getAll( elem, false ) );

				// Remove any remaining nodes
				elem.textContent = "";
			}
		}

		return this;
	},

	clone: function( dataAndEvents, deepDataAndEvents ) {
		dataAndEvents = dataAndEvents == null ? false : dataAndEvents;
		deepDataAndEvents = deepDataAndEvents == null ? dataAndEvents : deepDataAndEvents;

		return this.map( function() {
			return jQuery.clone( this, dataAndEvents, deepDataAndEvents );
		} );
	},

	html: function( value ) {
		return access( this, function( value ) {
			var elem = this[ 0 ] || {},
				i = 0,
				l = this.length;

			if ( value === undefined && elem.nodeType === 1 ) {
				return elem.innerHTML;
			}

			// See if we can take a shortcut and just use innerHTML
			if ( typeof value === "string" && !rnoInnerhtml.test( value ) &&
				!wrapMap[ ( rtagName.exec( value ) || [ "", "" ] )[ 1 ].toLowerCase() ] ) {

				value = jQuery.htmlPrefilter( value );

				try {
					for ( ; i < l; i++ ) {
						elem = this[ i ] || {};

						// Remove element nodes and prevent memory leaks
						if ( elem.nodeType === 1 ) {
							jQuery.cleanData( getAll( elem, false ) );
							elem.innerHTML = value;
						}
					}

					elem = 0;

				// If using innerHTML throws an exception, use the fallback method
				} catch ( e ) {}
			}

			if ( elem ) {
				this.empty().append( value );
			}
		}, null, value, arguments.length );
	},

	replaceWith: function() {
		var ignored = [];

		// Make the changes, replacing each non-ignored context element with the new content
		return domManip( this, arguments, function( elem ) {
			var parent = this.parentNode;

			if ( jQuery.inArray( this, ignored ) < 0 ) {
				jQuery.cleanData( getAll( this ) );
				if ( parent ) {
					parent.replaceChild( elem, this );
				}
			}

		// Force callback invocation
		}, ignored );
	}
} );

jQuery.each( {
	appendTo: "append",
	prependTo: "prepend",
	insertBefore: "before",
	insertAfter: "after",
	replaceAll: "replaceWith"
}, function( name, original ) {
	jQuery.fn[ name ] = function( selector ) {
		var elems,
			ret = [],
			insert = jQuery( selector ),
			last = insert.length - 1,
			i = 0;

		for ( ; i <= last; i++ ) {
			elems = i === last ? this : this.clone( true );
			jQuery( insert[ i ] )[ original ]( elems );

			// Support: Android <=4.0 only, PhantomJS 1 only
			// .get() because push.apply(_, arraylike) throws on ancient WebKit
			push.apply( ret, elems.get() );
		}

		return this.pushStack( ret );
	};
} );
var rnumnonpx = new RegExp( "^(" + pnum + ")(?!px)[a-z%]+$", "i" );

var rcustomProp = /^--/;


var getStyles = function( elem ) {

		// Support: IE <=11 only, Firefox <=30 (trac-15098, trac-14150)
		// IE throws on elements created in popups
		// FF meanwhile throws on frame elements through "defaultView.getComputedStyle"
		var view = elem.ownerDocument.defaultView;

		if ( !view || !view.opener ) {
			view = window;
		}

		return view.getComputedStyle( elem );
	};

var swap = function( elem, options, callback ) {
	var ret, name,
		old = {};

	// Remember the old values, and insert the new ones
	for ( name in options ) {
		old[ name ] = elem.style[ name ];
		elem.style[ name ] = options[ name ];
	}

	ret = callback.call( elem );

	// Revert the old values
	for ( name in options ) {
		elem.style[ name ] = old[ name ];
	}

	return ret;
};


var rboxStyle = new RegExp( cssExpand.join( "|" ), "i" );



( function() {

	// Executing both pixelPosition & boxSizingReliable tests require only one layout
	// so they're executed at the same time to save the second computation.
	function computeStyleTests() {

		// This is a singleton, we need to execute it only once
		if ( !div ) {
			return;
		}

		container.style.cssText = "position:absolute;left:-11111px;width:60px;" +
			"margin-top:1px;padding:0;border:0";
		div.style.cssText =
			"position:relative;display:block;box-sizing:border-box;overflow:scroll;" +
			"margin:auto;border:1px;padding:1px;" +
			"width:60%;top:1%";
		documentElement.appendChild( container ).appendChild( div );

		var divStyle = window.getComputedStyle( div );
		pixelPositionVal = divStyle.top !== "1%";

		// Support: Android 4.0 - 4.3 only, Firefox <=3 - 44
		reliableMarginLeftVal = roundPixelMeasures( divStyle.marginLeft ) === 12;

		// Support: Android 4.0 - 4.3 only, Safari <=9.1 - 10.1, iOS <=7.0 - 9.3
		// Some styles come back with percentage values, even though they shouldn't
		div.style.right = "60%";
		pixelBoxStylesVal = roundPixelMeasures( divStyle.right ) === 36;

		// Support: IE 9 - 11 only
		// Detect misreporting of content dimensions for box-sizing:border-box elements
		boxSizingReliableVal = roundPixelMeasures( divStyle.width ) === 36;

		// Support: IE 9 only
		// Detect overflow:scroll screwiness (gh-3699)
		// Support: Chrome <=64
		// Don't get tricked when zoom affects offsetWidth (gh-4029)
		div.style.position = "absolute";
		scrollboxSizeVal = roundPixelMeasures( div.offsetWidth / 3 ) === 12;

		documentElement.removeChild( container );

		// Nullify the div so it wouldn't be stored in the memory and
		// it will also be a sign that checks already performed
		div = null;
	}

	function roundPixelMeasures( measure ) {
		return Math.round( parseFloat( measure ) );
	}

	var pixelPositionVal, boxSizingReliableVal, scrollboxSizeVal, pixelBoxStylesVal,
		reliableTrDimensionsVal, reliableMarginLeftVal,
		container = document.createElement( "div" ),
		div = document.createElement( "div" );

	// Finish early in limited (non-browser) environments
	if ( !div.style ) {
		return;
	}

	// Support: IE <=9 - 11 only
	// Style of cloned element affects source element cloned (trac-8908)
	div.style.backgroundClip = "content-box";
	div.cloneNode( true ).style.backgroundClip = "";
	support.clearCloneStyle = div.style.backgroundClip === "content-box";

	jQuery.extend( support, {
		boxSizingReliable: function() {
			computeStyleTests();
			return boxSizingReliableVal;
		},
		pixelBoxStyles: function() {
			computeStyleTests();
			return pixelBoxStylesVal;
		},
		pixelPosition: function() {
			computeStyleTests();
			return pixelPositionVal;
		},
		reliableMarginLeft: function() {
			computeStyleTests();
			return reliableMarginLeftVal;
		},
		scrollboxSize: function() {
			computeStyleTests();
			return scrollboxSizeVal;
		},

		// Support: IE 9 - 11+, Edge 15 - 18+
		// IE/Edge misreport `getComputedStyle` of table rows with width/height
		// set in CSS while `offset*` properties report correct values.
		// Behavior in IE 9 is more subtle than in newer versions & it passes
		// some versions of this test; make sure not to make it pass there!
		//
		// Support: Firefox 70+
		// Only Firefox includes border widths
		// in computed dimensions. (gh-4529)
		reliableTrDimensions: function() {
			var table, tr, trChild, trStyle;
			if ( reliableTrDimensionsVal == null ) {
				table = document.createElement( "table" );
				tr = document.createElement( "tr" );
				trChild = document.createElement( "div" );

				table.style.cssText = "position:absolute;left:-11111px;border-collapse:separate";
				tr.style.cssText = "box-sizing:content-box;border:1px solid";

				// Support: Chrome 86+
				// Height set through cssText does not get applied.
				// Computed height then comes back as 0.
				tr.style.height = "1px";
				trChild.style.height = "9px";

				// Support: Android 8 Chrome 86+
				// In our bodyBackground.html iframe,
				// display for all div elements is set to "inline",
				// which causes a problem only in Android 8 Chrome 86.
				// Ensuring the div is `display: block`
				// gets around this issue.
				trChild.style.display = "block";

				documentElement
					.appendChild( table )
					.appendChild( tr )
					.appendChild( trChild );

				trStyle = window.getComputedStyle( tr );
				reliableTrDimensionsVal = ( parseInt( trStyle.height, 10 ) +
					parseInt( trStyle.borderTopWidth, 10 ) +
					parseInt( trStyle.borderBottomWidth, 10 ) ) === tr.offsetHeight;

				documentElement.removeChild( table );
			}
			return reliableTrDimensionsVal;
		}
	} );
} )();


function curCSS( elem, name, computed ) {
	var width, minWidth, maxWidth, ret,
		isCustomProp = rcustomProp.test( name ),

		// Support: Firefox 51+
		// Retrieving style before computed somehow
		// fixes an issue with getting wrong values
		// on detached elements
		style = elem.style;

	computed = computed || getStyles( elem );

	// getPropertyValue is needed for:
	//   .css('filter') (IE 9 only, trac-12537)
	//   .css('--customProperty) (gh-3144)
	if ( computed ) {

		// Support: IE <=9 - 11+
		// IE only supports `"float"` in `getPropertyValue`; in computed styles
		// it's only available as `"cssFloat"`. We no longer modify properties
		// sent to `.css()` apart from camelCasing, so we need to check both.
		// Normally, this would create difference in behavior: if
		// `getPropertyValue` returns an empty string, the value returned
		// by `.css()` would be `undefined`. This is usually the case for
		// disconnected elements. However, in IE even disconnected elements
		// with no styles return `"none"` for `getPropertyValue( "float" )`
		ret = computed.getPropertyValue( name ) || computed[ name ];

		if ( isCustomProp && ret ) {

			// Support: Firefox 105+, Chrome <=105+
			// Spec requires trimming whitespace for custom properties (gh-4926).
			// Firefox only trims leading whitespace. Chrome just collapses
			// both leading & trailing whitespace to a single space.
			//
			// Fall back to `undefined` if empty string returned.
			// This collapses a missing definition with property defined
			// and set to an empty string but there's no standard API
			// allowing us to differentiate them without a performance penalty
			// and returning `undefined` aligns with older jQuery.
			//
			// rtrimCSS treats U+000D CARRIAGE RETURN and U+000C FORM FEED
			// as whitespace while CSS does not, but this is not a problem
			// because CSS preprocessing replaces them with U+000A LINE FEED
			// (which *is* CSS whitespace)
			// https://www.w3.org/TR/css-syntax-3/#input-preprocessing
			ret = ret.replace( rtrimCSS, "$1" ) || undefined;
		}

		if ( ret === "" && !isAttached( elem ) ) {
			ret = jQuery.style( elem, name );
		}

		// A tribute to the "awesome hack by Dean Edwards"
		// Android Browser returns percentage for some values,
		// but width seems to be reliably pixels.
		// This is against the CSSOM draft spec:
		// https://drafts.csswg.org/cssom/#resolved-values
		if ( !support.pixelBoxStyles() && rnumnonpx.test( ret ) && rboxStyle.test( name ) ) {

			// Remember the original values
			width = style.width;
			minWidth = style.minWidth;
			maxWidth = style.maxWidth;

			// Put in the new values to get a computed value out
			style.minWidth = style.maxWidth = style.width = ret;
			ret = computed.width;

			// Revert the changed values
			style.width = width;
			style.minWidth = minWidth;
			style.maxWidth = maxWidth;
		}
	}

	return ret !== undefined ?

		// Support: IE <=9 - 11 only
		// IE returns zIndex value as an integer.
		ret + "" :
		ret;
}


function addGetHookIf( conditionFn, hookFn ) {

	// Define the hook, we'll check on the first run if it's really needed.
	return {
		get: function() {
			if ( conditionFn() ) {

				// Hook not needed (or it's not possible to use it due
				// to missing dependency), remove it.
				delete this.get;
				return;
			}

			// Hook needed; redefine it so that the support test is not executed again.
			return ( this.get = hookFn ).apply( this, arguments );
		}
	};
}


var cssPrefixes = [ "Webkit", "Moz", "ms" ],
	emptyStyle = document.createElement( "div" ).style,
	vendorProps = {};

// Return a vendor-prefixed property or undefined
function vendorPropName( name ) {

	// Check for vendor prefixed names
	var capName = name[ 0 ].toUpperCase() + name.slice( 1 ),
		i = cssPrefixes.length;

	while ( i-- ) {
		name = cssPrefixes[ i ] + capName;
		if ( name in emptyStyle ) {
			return name;
		}
	}
}

// Return a potentially-mapped jQuery.cssProps or vendor prefixed property
function finalPropName( name ) {
	var final = jQuery.cssProps[ name ] || vendorProps[ name ];

	if ( final ) {
		return final;
	}
	if ( name in emptyStyle ) {
		return name;
	}
	return vendorProps[ name ] = vendorPropName( name ) || name;
}


var

	// Swappable if display is none or starts with table
	// except "table", "table-cell", or "table-caption"
	// See here for display values: https://developer.mozilla.org/en-US/docs/CSS/display
	rdisplayswap = /^(none|table(?!-c[ea]).+)/,
	cssShow = { position: "absolute", visibility: "hidden", display: "block" },
	cssNormalTransform = {
		letterSpacing: "0",
		fontWeight: "400"
	};

function setPositiveNumber( _elem, value, subtract ) {

	// Any relative (+/-) values have already been
	// normalized at this point
	var matches = rcssNum.exec( value );
	return matches ?

		// Guard against undefined "subtract", e.g., when used as in cssHooks
		Math.max( 0, matches[ 2 ] - ( subtract || 0 ) ) + ( matches[ 3 ] || "px" ) :
		value;
}

function boxModelAdjustment( elem, dimension, box, isBorderBox, styles, computedVal ) {
	var i = dimension === "width" ? 1 : 0,
		extra = 0,
		delta = 0,
		marginDelta = 0;

	// Adjustment may not be necessary
	if ( box === ( isBorderBox ? "border" : "content" ) ) {
		return 0;
	}

	for ( ; i < 4; i += 2 ) {

		// Both box models exclude margin
		// Count margin delta separately to only add it after scroll gutter adjustment.
		// This is needed to make negative margins work with `outerHeight( true )` (gh-3982).
		if ( box === "margin" ) {
			marginDelta += jQuery.css( elem, box + cssExpand[ i ], true, styles );
		}

		// If we get here with a content-box, we're seeking "padding" or "border" or "margin"
		if ( !isBorderBox ) {

			// Add padding
			delta += jQuery.css( elem, "padding" + cssExpand[ i ], true, styles );

			// For "border" or "margin", add border
			if ( box !== "padding" ) {
				delta += jQuery.css( elem, "border" + cssExpand[ i ] + "Width", true, styles );

			// But still keep track of it otherwise
			} else {
				extra += jQuery.css( elem, "border" + cssExpand[ i ] + "Width", true, styles );
			}

		// If we get here with a border-box (content + padding + border), we're seeking "content" or
		// "padding" or "margin"
		} else {

			// For "content", subtract padding
			if ( box === "content" ) {
				delta -= jQuery.css( elem, "padding" + cssExpand[ i ], true, styles );
			}

			// For "content" or "padding", subtract border
			if ( box !== "margin" ) {
				delta -= jQuery.css( elem, "border" + cssExpand[ i ] + "Width", true, styles );
			}
		}
	}

	// Account for positive content-box scroll gutter when requested by providing computedVal
	if ( !isBorderBox && computedVal >= 0 ) {

		// offsetWidth/offsetHeight is a rounded sum of content, padding, scroll gutter, and border
		// Assuming integer scroll gutter, subtract the rest and round down
		delta += Math.max( 0, Math.ceil(
			elem[ "offset" + dimension[ 0 ].toUpperCase() + dimension.slice( 1 ) ] -
			computedVal -
			delta -
			extra -
			0.5

		// If offsetWidth/offsetHeight is unknown, then we can't determine content-box scroll gutter
		// Use an explicit zero to avoid NaN (gh-3964)
		) ) || 0;
	}

	return delta + marginDelta;
}

function getWidthOrHeight( elem, dimension, extra ) {

	// Start with computed style
	var styles = getStyles( elem ),

		// To avoid forcing a reflow, only fetch boxSizing if we need it (gh-4322).
		// Fake content-box until we know it's needed to know the true value.
		boxSizingNeeded = !support.boxSizingReliable() || extra,
		isBorderBox = boxSizingNeeded &&
			jQuery.css( elem, "boxSizing", false, styles ) === "border-box",
		valueIsBorderBox = isBorderBox,

		val = curCSS( elem, dimension, styles ),
		offsetProp = "offset" + dimension[ 0 ].toUpperCase() + dimension.slice( 1 );

	// Support: Firefox <=54
	// Return a confounding non-pixel value or feign ignorance, as appropriate.
	if ( rnumnonpx.test( val ) ) {
		if ( !extra ) {
			return val;
		}
		val = "auto";
	}


	// Support: IE 9 - 11 only
	// Use offsetWidth/offsetHeight for when box sizing is unreliable.
	// In those cases, the computed value can be trusted to be border-box.
	if ( ( !support.boxSizingReliable() && isBorderBox ||

		// Support: IE 10 - 11+, Edge 15 - 18+
		// IE/Edge misreport `getComputedStyle` of table rows with width/height
		// set in CSS while `offset*` properties report correct values.
		// Interestingly, in some cases IE 9 doesn't suffer from this issue.
		!support.reliableTrDimensions() && nodeName( elem, "tr" ) ||

		// Fall back to offsetWidth/offsetHeight when value is "auto"
		// This happens for inline elements with no explicit setting (gh-3571)
		val === "auto" ||

		// Support: Android <=4.1 - 4.3 only
		// Also use offsetWidth/offsetHeight for misreported inline dimensions (gh-3602)
		!parseFloat( val ) && jQuery.css( elem, "display", false, styles ) === "inline" ) &&

		// Make sure the element is visible & connected
		elem.getClientRects().length ) {

		isBorderBox = jQuery.css( elem, "boxSizing", false, styles ) === "border-box";

		// Where available, offsetWidth/offsetHeight approximate border box dimensions.
		// Where not available (e.g., SVG), assume unreliable box-sizing and interpret the
		// retrieved value as a content box dimension.
		valueIsBorderBox = offsetProp in elem;
		if ( valueIsBorderBox ) {
			val = elem[ offsetProp ];
		}
	}

	// Normalize "" and auto
	val = parseFloat( val ) || 0;

	// Adjust for the element's box model
	return ( val +
		boxModelAdjustment(
			elem,
			dimension,
			extra || ( isBorderBox ? "border" : "content" ),
			valueIsBorderBox,
			styles,

			// Provide the current computed size to request scroll gutter calculation (gh-3589)
			val
		)
	) + "px";
}

jQuery.extend( {

	// Add in style property hooks for overriding the default
	// behavior of getting and setting a style property
	cssHooks: {
		opacity: {
			get: function( elem, computed ) {
				if ( computed ) {

					// We should always get a number back from opacity
					var ret = curCSS( elem, "opacity" );
					return ret === "" ? "1" : ret;
				}
			}
		}
	},

	// Don't automatically add "px" to these possibly-unitless properties
	cssNumber: {
		animationIterationCount: true,
		aspectRatio: true,
		borderImageSlice: true,
		columnCount: true,
		flexGrow: true,
		flexShrink: true,
		fontWeight: true,
		gridArea: true,
		gridColumn: true,
		gridColumnEnd: true,
		gridColumnStart: true,
		gridRow: true,
		gridRowEnd: true,
		gridRowStart: true,
		lineHeight: true,
		opacity: true,
		order: true,
		orphans: true,
		scale: true,
		widows: true,
		zIndex: true,
		zoom: true,

		// SVG-related
		fillOpacity: true,
		floodOpacity: true,
		stopOpacity: true,
		strokeMiterlimit: true,
		strokeOpacity: true
	},

	// Add in properties whose names you wish to fix before
	// setting or getting the value
	cssProps: {},

	// Get and set the style property on a DOM Node
	style: function( elem, name, value, extra ) {

		// Don't set styles on text and comment nodes
		if ( !elem || elem.nodeType === 3 || elem.nodeType === 8 || !elem.style ) {
			return;
		}

		// Make sure that we're working with the right name
		var ret, type, hooks,
			origName = camelCase( name ),
			isCustomProp = rcustomProp.test( name ),
			style = elem.style;

		// Make sure that we're working with the right name. We don't
		// want to query the value if it is a CSS custom property
		// since they are user-defined.
		if ( !isCustomProp ) {
			name = finalPropName( origName );
		}

		// Gets hook for the prefixed version, then unprefixed version
		hooks = jQuery.cssHooks[ name ] || jQuery.cssHooks[ origName ];

		// Check if we're setting a value
		if ( value !== undefined ) {
			type = typeof value;

			// Convert "+=" or "-=" to relative numbers (trac-7345)
			if ( type === "string" && ( ret = rcssNum.exec( value ) ) && ret[ 1 ] ) {
				value = adjustCSS( elem, name, ret );

				// Fixes bug trac-9237
				type = "number";
			}

			// Make sure that null and NaN values aren't set (trac-7116)
			if ( value == null || value !== value ) {
				return;
			}

			// If a number was passed in, add the unit (except for certain CSS properties)
			// The isCustomProp check can be removed in jQuery 4.0 when we only auto-append
			// "px" to a few hardcoded values.
			if ( type === "number" && !isCustomProp ) {
				value += ret && ret[ 3 ] || ( jQuery.cssNumber[ origName ] ? "" : "px" );
			}

			// background-* props affect original clone's values
			if ( !support.clearCloneStyle && value === "" && name.indexOf( "background" ) === 0 ) {
				style[ name ] = "inherit";
			}

			// If a hook was provided, use that value, otherwise just set the specified value
			if ( !hooks || !( "set" in hooks ) ||
				( value = hooks.set( elem, value, extra ) ) !== undefined ) {

				if ( isCustomProp ) {
					style.setProperty( name, value );
				} else {
					style[ name ] = value;
				}
			}

		} else {

			// If a hook was provided get the non-computed value from there
			if ( hooks && "get" in hooks &&
				( ret = hooks.get( elem, false, extra ) ) !== undefined ) {

				return ret;
			}

			// Otherwise just get the value from the style object
			return style[ name ];
		}
	},

	css: function( elem, name, extra, styles ) {
		var val, num, hooks,
			origName = camelCase( name ),
			isCustomProp = rcustomProp.test( name );

		// Make sure that we're working with the right name. We don't
		// want to modify the value if it is a CSS custom property
		// since they are user-defined.
		if ( !isCustomProp ) {
			name = finalPropName( origName );
		}

		// Try prefixed name followed by the unprefixed name
		hooks = jQuery.cssHooks[ name ] || jQuery.cssHooks[ origName ];

		// If a hook was provided get the computed value from there
		if ( hooks && "get" in hooks ) {
			val = hooks.get( elem, true, extra );
		}

		// Otherwise, if a way to get the computed value exists, use that
		if ( val === undefined ) {
			val = curCSS( elem, name, styles );
		}

		// Convert "normal" to computed value
		if ( val === "normal" && name in cssNormalTransform ) {
			val = cssNormalTransform[ name ];
		}

		// Make numeric if forced or a qualifier was provided and val looks numeric
		if ( extra === "" || extra ) {
			num = parseFloat( val );
			return extra === true || isFinite( num ) ? num || 0 : val;
		}

		return val;
	}
} );

jQuery.each( [ "height", "width" ], function( _i, dimension ) {
	jQuery.cssHooks[ dimension ] = {
		get: function( elem, computed, extra ) {
			if ( computed ) {

				// Certain elements can have dimension info if we invisibly show them
				// but it must have a current display style that would benefit
				return rdisplayswap.test( jQuery.css( elem, "display" ) ) &&

					// Support: Safari 8+
					// Table columns in Safari have non-zero offsetWidth & zero
					// getBoundingClientRect().width unless display is changed.
					// Support: IE <=11 only
					// Running getBoundingClientRect on a disconnected node
					// in IE throws an error.
					( !elem.getClientRects().length || !elem.getBoundingClientRect().width ) ?
					swap( elem, cssShow, function() {
						return getWidthOrHeight( elem, dimension, extra );
					} ) :
					getWidthOrHeight( elem, dimension, extra );
			}
		},

		set: function( elem, value, extra ) {
			var matches,
				styles = getStyles( elem ),

				// Only read styles.position if the test has a chance to fail
				// to avoid forcing a reflow.
				scrollboxSizeBuggy = !support.scrollboxSize() &&
					styles.position === "absolute",

				// To avoid forcing a reflow, only fetch boxSizing if we need it (gh-3991)
				boxSizingNeeded = scrollboxSizeBuggy || extra,
				isBorderBox = boxSizingNeeded &&
					jQuery.css( elem, "boxSizing", false, styles ) === "border-box",
				subtract = extra ?
					boxModelAdjustment(
						elem,
						dimension,
						extra,
						isBorderBox,
						styles
					) :
					0;

			// Account for unreliable border-box dimensions by comparing offset* to computed and
			// faking a content-box to get border and padding (gh-3699)
			if ( isBorderBox && scrollboxSizeBuggy ) {
				subtract -= Math.ceil(
					elem[ "offset" + dimension[ 0 ].toUpperCase() + dimension.slice( 1 ) ] -
					parseFloat( styles[ dimension ] ) -
					boxModelAdjustment( elem, dimension, "border", false, styles ) -
					0.5
				);
			}

			// Convert to pixels if value adjustment is needed
			if ( subtract && ( matches = rcssNum.exec( value ) ) &&
				( matches[ 3 ] || "px" ) !== "px" ) {

				elem.style[ dimension ] = value;
				value = jQuery.css( elem, dimension );
			}

			return setPositiveNumber( elem, value, subtract );
		}
	};
} );

jQuery.cssHooks.marginLeft = addGetHookIf( support.reliableMarginLeft,
	function( elem, computed ) {
		if ( computed ) {
			return ( parseFloat( curCSS( elem, "marginLeft" ) ) ||
				elem.getBoundingClientRect().left -
					swap( elem, { marginLeft: 0 }, function() {
						return elem.getBoundingClientRect().left;
					} )
			) + "px";
		}
	}
);

// These hooks are used by animate to expand properties
jQuery.each( {
	margin: "",
	padding: "",
	border: "Width"
}, function( prefix, suffix ) {
	jQuery.cssHooks[ prefix + suffix ] = {
		expand: function( value ) {
			var i = 0,
				expanded = {},

				// Assumes a single number if not a string
				parts = typeof value === "string" ? value.split( " " ) : [ value ];

			for ( ; i < 4; i++ ) {
				expanded[ prefix + cssExpand[ i ] + suffix ] =
					parts[ i ] || parts[ i - 2 ] || parts[ 0 ];
			}

			return expanded;
		}
	};

	if ( prefix !== "margin" ) {
		jQuery.cssHooks[ prefix + suffix ].set = setPositiveNumber;
	}
} );

jQuery.fn.extend( {
	css: function( name, value ) {
		return access( this, function( elem, name, value ) {
			var styles, len,
				map = {},
				i = 0;

			if ( Array.isArray( name ) ) {
				styles = getStyles( elem );
				len = name.length;

				for ( ; i < len; i++ ) {
					map[ name[ i ] ] = jQuery.css( elem, name[ i ], false, styles );
				}

				return map;
			}

			return value !== undefined ?
				jQuery.style( elem, name, value ) :
				jQuery.css( elem, name );
		}, name, value, arguments.length > 1 );
	}
} );


function Tween( elem, options, prop, end, easing ) {
	return new Tween.prototype.init( elem, options, prop, end, easing );
}
jQuery.Tween = Tween;

Tween.prototype = {
	constructor: Tween,
	init: function( elem, options, prop, end, easing, unit ) {
		this.elem = elem;
		this.prop = prop;
		this.easing = easing || jQuery.easing._default;
		this.options = options;
		this.start = this.now = this.cur();
		this.end = end;
		this.unit = unit || ( jQuery.cssNumber[ prop ] ? "" : "px" );
	},
	cur: function() {
		var hooks = Tween.propHooks[ this.prop ];

		return hooks && hooks.get ?
			hooks.get( this ) :
			Tween.propHooks._default.get( this );
	},
	run: function( percent ) {
		var eased,
			hooks = Tween.propHooks[ this.prop ];

		if ( this.options.duration ) {
			this.pos = eased = jQuery.easing[ this.easing ](
				percent, this.options.duration * percent, 0, 1, this.options.duration
			);
		} else {
			this.pos = eased = percent;
		}
		this.now = ( this.end - this.start ) * eased + this.start;

		if ( this.options.step ) {
			this.options.step.call( this.elem, this.now, this );
		}

		if ( hooks && hooks.set ) {
			hooks.set( this );
		} else {
			Tween.propHooks._default.set( this );
		}
		return this;
	}
};

Tween.prototype.init.prototype = Tween.prototype;

Tween.propHooks = {
	_default: {
		get: function( tween ) {
			var result;

			// Use a property on the element directly when it is not a DOM element,
			// or when there is no matching style property that exists.
			if ( tween.elem.nodeType !== 1 ||
				tween.elem[ tween.prop ] != null && tween.elem.style[ tween.prop ] == null ) {
				return tween.elem[ tween.prop ];
			}

			// Passing an empty string as a 3rd parameter to .css will automatically
			// attempt a parseFloat and fallback to a string if the parse fails.
			// Simple values such as "10px" are parsed to Float;
			// complex values such as "rotate(1rad)" are returned as-is.
			result = jQuery.css( tween.elem, tween.prop, "" );

			// Empty strings, null, undefined and "auto" are converted to 0.
			return !result || result === "auto" ? 0 : result;
		},
		set: function( tween ) {

			// Use step hook for back compat.
			// Use cssHook if its there.
			// Use .style if available and use plain properties where available.
			if ( jQuery.fx.step[ tween.prop ] ) {
				jQuery.fx.step[ tween.prop ]( tween );
			} else if ( tween.elem.nodeType === 1 && (
				jQuery.cssHooks[ tween.prop ] ||
					tween.elem.style[ finalPropName( tween.prop ) ] != null ) ) {
				jQuery.style( tween.elem, tween.prop, tween.now + tween.unit );
			} else {
				tween.elem[ tween.prop ] = tween.now;
			}
		}
	}
};

// Support: IE <=9 only
// Panic based approach to setting things on disconnected nodes
Tween.propHooks.scrollTop = Tween.propHooks.scrollLeft = {
	set: function( tween ) {
		if ( tween.elem.nodeType && tween.elem.parentNode ) {
			tween.elem[ tween.prop ] = tween.now;
		}
	}
};

jQuery.easing = {
	linear: function( p ) {
		return p;
	},
	swing: function( p ) {
		return 0.5 - Math.cos( p * Math.PI ) / 2;
	},
	_default: "swing"
};

jQuery.fx = Tween.prototype.init;

// Back compat <1.8 extension point
jQuery.fx.step = {};




var
	fxNow, inProgress,
	rfxtypes = /^(?:toggle|show|hide)$/,
	rrun = /queueHooks$/;

function schedule() {
	if ( inProgress ) {
		if ( document.hidden === false && window.requestAnimationFrame ) {
			window.requestAnimationFrame( schedule );
		} else {
			window.setTimeout( schedule, jQuery.fx.interval );
		}

		jQuery.fx.tick();
	}
}

// Animations created synchronously will run synchronously
function createFxNow() {
	window.setTimeout( function() {
		fxNow = undefined;
	} );
	return ( fxNow = Date.now() );
}

// Generate parameters to create a standard animation
function genFx( type, includeWidth ) {
	var which,
		i = 0,
		attrs = { height: type };

	// If we include width, step value is 1 to do all cssExpand values,
	// otherwise step value is 2 to skip over Left and Right
	includeWidth = includeWidth ? 1 : 0;
	for ( ; i < 4; i += 2 - includeWidth ) {
		which = cssExpand[ i ];
		attrs[ "margin" + which ] = attrs[ "padding" + which ] = type;
	}

	if ( includeWidth ) {
		attrs.opacity = attrs.width = type;
	}

	return attrs;
}

function createTween( value, prop, animation ) {
	var tween,
		collection = ( Animation.tweeners[ prop ] || [] ).concat( Animation.tweeners[ "*" ] ),
		index = 0,
		length = collection.length;
	for ( ; index < length; index++ ) {
		if ( ( tween = collection[ index ].call( animation, prop, value ) ) ) {

			// We're done with this property
			return tween;
		}
	}
}

function defaultPrefilter( elem, props, opts ) {
	var prop, value, toggle, hooks, oldfire, propTween, restoreDisplay, display,
		isBox = "width" in props || "height" in props,
		anim = this,
		orig = {},
		style = elem.style,
		hidden = elem.nodeType && isHiddenWithinTree( elem ),
		dataShow = dataPriv.get( elem, "fxshow" );

	// Queue-skipping animations hijack the fx hooks
	if ( !opts.queue ) {
		hooks = jQuery._queueHooks( elem, "fx" );
		if ( hooks.unqueued == null ) {
			hooks.unqueued = 0;
			oldfire = hooks.empty.fire;
			hooks.empty.fire = function() {
				if ( !hooks.unqueued ) {
					oldfire();
				}
			};
		}
		hooks.unqueued++;

		anim.always( function() {

			// Ensure the complete handler is called before this completes
			anim.always( function() {
				hooks.unqueued--;
				if ( !jQuery.queue( elem, "fx" ).length ) {
					hooks.empty.fire();
				}
			} );
		} );
	}

	// Detect show/hide animations
	for ( prop in props ) {
		value = props[ prop ];
		if ( rfxtypes.test( value ) ) {
			delete props[ prop ];
			toggle = toggle || value === "toggle";
			if ( value === ( hidden ? "hide" : "show" ) ) {

				// Pretend to be hidden if this is a "show" and
				// there is still data from a stopped show/hide
				if ( value === "show" && dataShow && dataShow[ prop ] !== undefined ) {
					hidden = true;

				// Ignore all other no-op show/hide data
				} else {
					continue;
				}
			}
			orig[ prop ] = dataShow && dataShow[ prop ] || jQuery.style( elem, prop );
		}
	}

	// Bail out if this is a no-op like .hide().hide()
	propTween = !jQuery.isEmptyObject( props );
	if ( !propTween && jQuery.isEmptyObject( orig ) ) {
		return;
	}

	// Restrict "overflow" and "display" styles during box animations
	if ( isBox && elem.nodeType === 1 ) {

		// Support: IE <=9 - 11, Edge 12 - 15
		// Record all 3 overflow attributes because IE does not infer the shorthand
		// from identically-valued overflowX and overflowY and Edge just mirrors
		// the overflowX value there.
		opts.overflow = [ style.overflow, style.overflowX, style.overflowY ];

		// Identify a display type, preferring old show/hide data over the CSS cascade
		restoreDisplay = dataShow && dataShow.display;
		if ( restoreDisplay == null ) {
			restoreDisplay = dataPriv.get( elem, "display" );
		}
		display = jQuery.css( elem, "display" );
		if ( display === "none" ) {
			if ( restoreDisplay ) {
				display = restoreDisplay;
			} else {

				// Get nonempty value(s) by temporarily forcing visibility
				showHide( [ elem ], true );
				restoreDisplay = elem.style.display || restoreDisplay;
				display = jQuery.css( elem, "display" );
				showHide( [ elem ] );
			}
		}

		// Animate inline elements as inline-block
		if ( display === "inline" || display === "inline-block" && restoreDisplay != null ) {
			if ( jQuery.css( elem, "float" ) === "none" ) {

				// Restore the original display value at the end of pure show/hide animations
				if ( !propTween ) {
					anim.done( function() {
						style.display = restoreDisplay;
					} );
					if ( restoreDisplay == null ) {
						display = style.display;
						restoreDisplay = display === "none" ? "" : display;
					}
				}
				style.display = "inline-block";
			}
		}
	}

	if ( opts.overflow ) {
		style.overflow = "hidden";
		anim.always( function() {
			style.overflow = opts.overflow[ 0 ];
			style.overflowX = opts.overflow[ 1 ];
			style.overflowY = opts.overflow[ 2 ];
		} );
	}

	// Implement show/hide animations
	propTween = false;
	for ( prop in orig ) {

		// General show/hide setup for this element animation
		if ( !propTween ) {
			if ( dataShow ) {
				if ( "hidden" in dataShow ) {
					hidden = dataShow.hidden;
				}
			} else {
				dataShow = dataPriv.access( elem, "fxshow", { display: restoreDisplay } );
			}

			// Store hidden/visible for toggle so `.stop().toggle()` "reverses"
			if ( toggle ) {
				dataShow.hidden = !hidden;
			}

			// Show elements before animating them
			if ( hidden ) {
				showHide( [ elem ], true );
			}

			/* eslint-disable no-loop-func */

			anim.done( function() {

				/* eslint-enable no-loop-func */

				// The final step of a "hide" animation is actually hiding the element
				if ( !hidden ) {
					showHide( [ elem ] );
				}
				dataPriv.remove( elem, "fxshow" );
				for ( prop in orig ) {
					jQuery.style( elem, prop, orig[ prop ] );
				}
			} );
		}

		// Per-property setup
		propTween = createTween( hidden ? dataShow[ prop ] : 0, prop, anim );
		if ( !( prop in dataShow ) ) {
			dataShow[ prop ] = propTween.start;
			if ( hidden ) {
				propTween.end = propTween.start;
				propTween.start = 0;
			}
		}
	}
}

function propFilter( props, specialEasing ) {
	var index, name, easing, value, hooks;

	// camelCase, specialEasing and expand cssHook pass
	for ( index in props ) {
		name = camelCase( index );
		easing = specialEasing[ name ];
		value = props[ index ];
		if ( Array.isArray( value ) ) {
			easing = value[ 1 ];
			value = props[ index ] = value[ 0 ];
		}

		if ( index !== name ) {
			props[ name ] = value;
			delete props[ index ];
		}

		hooks = jQuery.cssHooks[ name ];
		if ( hooks && "expand" in hooks ) {
			value = hooks.expand( value );
			delete props[ name ];

			// Not quite $.extend, this won't overwrite existing keys.
			// Reusing 'index' because we have the correct "name"
			for ( index in value ) {
				if ( !( index in props ) ) {
					props[ index ] = value[ index ];
					specialEasing[ index ] = easing;
				}
			}
		} else {
			specialEasing[ name ] = easing;
		}
	}
}

function Animation( elem, properties, options ) {
	var result,
		stopped,
		index = 0,
		length = Animation.prefilters.length,
		deferred = jQuery.Deferred().always( function() {

			// Don't match elem in the :animated selector
			delete tick.elem;
		} ),
		tick = function() {
			if ( stopped ) {
				return false;
			}
			var currentTime = fxNow || createFxNow(),
				remaining = Math.max( 0, animation.startTime + animation.duration - currentTime ),

				// Support: Android 2.3 only
				// Archaic crash bug won't allow us to use `1 - ( 0.5 || 0 )` (trac-12497)
				temp = remaining / animation.duration || 0,
				percent = 1 - temp,
				index = 0,
				length = animation.tweens.length;

			for ( ; index < length; index++ ) {
				animation.tweens[ index ].run( percent );
			}

			deferred.notifyWith( elem, [ animation, percent, remaining ] );

			// If there's more to do, yield
			if ( percent < 1 && length ) {
				return remaining;
			}

			// If this was an empty animation, synthesize a final progress notification
			if ( !length ) {
				deferred.notifyWith( elem, [ animation, 1, 0 ] );
			}

			// Resolve the animation and report its conclusion
			deferred.resolveWith( elem, [ animation ] );
			return false;
		},
		animation = deferred.promise( {
			elem: elem,
			props: jQuery.extend( {}, properties ),
			opts: jQuery.extend( true, {
				specialEasing: {},
				easing: jQuery.easing._default
			}, options ),
			originalProperties: properties,
			originalOptions: options,
			startTime: fxNow || createFxNow(),
			duration: options.duration,
			tweens: [],
			createTween: function( prop, end ) {
				var tween = jQuery.Tween( elem, animation.opts, prop, end,
					animation.opts.specialEasing[ prop ] || animation.opts.easing );
				animation.tweens.push( tween );
				return tween;
			},
			stop: function( gotoEnd ) {
				var index = 0,

					// If we are going to the end, we want to run all the tweens
					// otherwise we skip this part
					length = gotoEnd ? animation.tweens.length : 0;
				if ( stopped ) {
					return this;
				}
				stopped = true;
				for ( ; index < length; index++ ) {
					animation.tweens[ index ].run( 1 );
				}

				// Resolve when we played the last frame; otherwise, reject
				if ( gotoEnd ) {
					deferred.notifyWith( elem, [ animation, 1, 0 ] );
					deferred.resolveWith( elem, [ animation, gotoEnd ] );
				} else {
					deferred.rejectWith( elem, [ animation, gotoEnd ] );
				}
				return this;
			}
		} ),
		props = animation.props;

	propFilter( props, animation.opts.specialEasing );

	for ( ; index < length; index++ ) {
		result = Animation.prefilters[ index ].call( animation, elem, props, animation.opts );
		if ( result ) {
			if ( isFunction( result.stop ) ) {
				jQuery._queueHooks( animation.elem, animation.opts.queue ).stop =
					result.stop.bind( result );
			}
			return result;
		}
	}

	jQuery.map( props, createTween, animation );

	if ( isFunction( animation.opts.start ) ) {
		animation.opts.start.call( elem, animation );
	}

	// Attach callbacks from options
	animation
		.progress( animation.opts.progress )
		.done( animation.opts.done, animation.opts.complete )
		.fail( animation.opts.fail )
		.always( animation.opts.always );

	jQuery.fx.timer(
		jQuery.extend( tick, {
			elem: elem,
			anim: animation,
			queue: animation.opts.queue
		} )
	);

	return animation;
}

jQuery.Animation = jQuery.extend( Animation, {

	tweeners: {
		"*": [ function( prop, value ) {
			var tween = this.createTween( prop, value );
			adjustCSS( tween.elem, prop, rcssNum.exec( value ), tween );
			return tween;
		} ]
	},

	tweener: function( props, callback ) {
		if ( isFunction( props ) ) {
			callback = props;
			props = [ "*" ];
		} else {
			props = props.match( rnothtmlwhite );
		}

		var prop,
			index = 0,
			length = props.length;

		for ( ; index < length; index++ ) {
			prop = props[ index ];
			Animation.tweeners[ prop ] = Animation.tweeners[ prop ] || [];
			Animation.tweeners[ prop ].unshift( callback );
		}
	},

	prefilters: [ defaultPrefilter ],

	prefilter: function( callback, prepend ) {
		if ( prepend ) {
			Animation.prefilters.unshift( callback );
		} else {
			Animation.prefilters.push( callback );
		}
	}
} );

jQuery.speed = function( speed, easing, fn ) {
	var opt = speed && typeof speed === "object" ? jQuery.extend( {}, speed ) : {
		complete: fn || !fn && easing ||
			isFunction( speed ) && speed,
		duration: speed,
		easing: fn && easing || easing && !isFunction( easing ) && easing
	};

	// Go to the end state if fx are off
	if ( jQuery.fx.off ) {
		opt.duration = 0;

	} else {
		if ( typeof opt.duration !== "number" ) {
			if ( opt.duration in jQuery.fx.speeds ) {
				opt.duration = jQuery.fx.speeds[ opt.duration ];

			} else {
				opt.duration = jQuery.fx.speeds._default;
			}
		}
	}

	// Normalize opt.queue - true/undefined/null -> "fx"
	if ( opt.queue == null || opt.queue === true ) {
		opt.queue = "fx";
	}

	// Queueing
	opt.old = opt.complete;

	opt.complete = function() {
		if ( isFunction( opt.old ) ) {
			opt.old.call( this );
		}

		if ( opt.queue ) {
			jQuery.dequeue( this, opt.queue );
		}
	};

	return opt;
};

jQuery.fn.extend( {
	fadeTo: function( speed, to, easing, callback ) {

		// Show any hidden elements after setting opacity to 0
		return this.filter( isHiddenWithinTree ).css( "opacity", 0 ).show()

			// Animate to the value specified
			.end().animate( { opacity: to }, speed, easing, callback );
	},
	animate: function( prop, speed, easing, callback ) {
		var empty = jQuery.isEmptyObject( prop ),
			optall = jQuery.speed( speed, easing, callback ),
			doAnimation = function() {

				// Operate on a copy of prop so per-property easing won't be lost
				var anim = Animation( this, jQuery.extend( {}, prop ), optall );

				// Empty animations, or finishing resolves immediately
				if ( empty || dataPriv.get( this, "finish" ) ) {
					anim.stop( true );
				}
			};

		doAnimation.finish = doAnimation;

		return empty || optall.queue === false ?
			this.each( doAnimation ) :
			this.queue( optall.queue, doAnimation );
	},
	stop: function( type, clearQueue, gotoEnd ) {
		var stopQueue = function( hooks ) {
			var stop = hooks.stop;
			delete hooks.stop;
			stop( gotoEnd );
		};

		if ( typeof type !== "string" ) {
			gotoEnd = clearQueue;
			clearQueue = type;
			type = undefined;
		}
		if ( clearQueue ) {
			this.queue( type || "fx", [] );
		}

		return this.each( function() {
			var dequeue = true,
				index = type != null && type + "queueHooks",
				timers = jQuery.timers,
				data = dataPriv.get( this );

			if ( index ) {
				if ( data[ index ] && data[ index ].stop ) {
					stopQueue( data[ index ] );
				}
			} else {
				for ( index in data ) {
					if ( data[ index ] && data[ index ].stop && rrun.test( index ) ) {
						stopQueue( data[ index ] );
					}
				}
			}

			for ( index = timers.length; index--; ) {
				if ( timers[ index ].elem === this &&
					( type == null || timers[ index ].queue === type ) ) {

					timers[ index ].anim.stop( gotoEnd );
					dequeue = false;
					timers.splice( index, 1 );
				}
			}

			// Start the next in the queue if the last step wasn't forced.
			// Timers currently will call their complete callbacks, which
			// will dequeue but only if they were gotoEnd.
			if ( dequeue || !gotoEnd ) {
				jQuery.dequeue( this, type );
			}
		} );
	},
	finish: function( type ) {
		if ( type !== false ) {
			type = type || "fx";
		}
		return this.each( function() {
			var index,
				data = dataPriv.get( this ),
				queue = data[ type + "queue" ],
				hooks = data[ type + "queueHooks" ],
				timers = jQuery.timers,
				length = queue ? queue.length : 0;

			// Enable finishing flag on private data
			data.finish = true;

			// Empty the queue first
			jQuery.queue( this, type, [] );

			if ( hooks && hooks.stop ) {
				hooks.stop.call( this, true );
			}

			// Look for any active animations, and finish them
			for ( index = timers.length; index--; ) {
				if ( timers[ index ].elem === this && timers[ index ].queue === type ) {
					timers[ index ].anim.stop( true );
					timers.splice( index, 1 );
				}
			}

			// Look for any animations in the old queue and finish them
			for ( index = 0; index < length; index++ ) {
				if ( queue[ index ] && queue[ index ].finish ) {
					queue[ index ].finish.call( this );
				}
			}

			// Turn off finishing flag
			delete data.finish;
		} );
	}
} );

jQuery.each( [ "toggle", "show", "hide" ], function( _i, name ) {
	var cssFn = jQuery.fn[ name ];
	jQuery.fn[ name ] = function( speed, easing, callback ) {
		return speed == null || typeof speed === "boolean" ?
			cssFn.apply( this, arguments ) :
			this.animate( genFx( name, true ), speed, easing, callback );
	};
} );

// Generate shortcuts for custom animations
jQuery.each( {
	slideDown: genFx( "show" ),
	slideUp: genFx( "hide" ),
	slideToggle: genFx( "toggle" ),
	fadeIn: { opacity: "show" },
	fadeOut: { opacity: "hide" },
	fadeToggle: { opacity: "toggle" }
}, function( name, props ) {
	jQuery.fn[ name ] = function( speed, easing, callback ) {
		return this.animate( props, speed, easing, callback );
	};
} );

jQuery.timers = [];
jQuery.fx.tick = function() {
	var timer,
		i = 0,
		timers = jQuery.timers;

	fxNow = Date.now();

	for ( ; i < timers.length; i++ ) {
		timer = timers[ i ];

		// Run the timer and safely remove it when done (allowing for external removal)
		if ( !timer() && timers[ i ] === timer ) {
			timers.splice( i--, 1 );
		}
	}

	if ( !timers.length ) {
		jQuery.fx.stop();
	}
	fxNow = undefined;
};

jQuery.fx.timer = function( timer ) {
	jQuery.timers.push( timer );
	jQuery.fx.start();
};

jQuery.fx.interval = 13;
jQuery.fx.start = function() {
	if ( inProgress ) {
		return;
	}

	inProgress = true;
	schedule();
};

jQuery.fx.stop = function() {
	inProgress = null;
};

jQuery.fx.speeds = {
	slow: 600,
	fast: 200,

	// Default speed
	_default: 400
};


// Based off of the plugin by Clint Helfers, with permission.
jQuery.fn.delay = function( time, type ) {
	time = jQuery.fx ? jQuery.fx.speeds[ time ] || time : time;
	type = type || "fx";

	return this.queue( type, function( next, hooks ) {
		var timeout = window.setTimeout( next, time );
		hooks.stop = function() {
			window.clearTimeout( timeout );
		};
	} );
};


( function() {
	var input = document.createElement( "input" ),
		select = document.createElement( "select" ),
		opt = select.appendChild( document.createElement( "option" ) );

	input.type = "checkbox";

	// Support: Android <=4.3 only
	// Default value for a checkbox should be "on"
	support.checkOn = input.value !== "";

	// Support: IE <=11 only
	// Must access selectedIndex to make default options select
	support.optSelected = opt.selected;

	// Support: IE <=11 only
	// An input loses its value after becoming a radio
	input = document.createElement( "input" );
	input.value = "t";
	input.type = "radio";
	support.radioValue = input.value === "t";
} )();


var boolHook,
	attrHandle = jQuery.expr.attrHandle;

jQuery.fn.extend( {
	attr: function( name, value ) {
		return access( this, jQuery.attr, name, value, arguments.length > 1 );
	},

	removeAttr: function( name ) {
		return this.each( function() {
			jQuery.removeAttr( this, name );
		} );
	}
} );

jQuery.extend( {
	attr: function( elem, name, value ) {
		var ret, hooks,
			nType = elem.nodeType;

		// Don't get/set attributes on text, comment and attribute nodes
		if ( nType === 3 || nType === 8 || nType === 2 ) {
			return;
		}

		// Fallback to prop when attributes are not supported
		if ( typeof elem.getAttribute === "undefined" ) {
			return jQuery.prop( elem, name, value );
		}

		// Attribute hooks are determined by the lowercase version
		// Grab necessary hook if one is defined
		if ( nType !== 1 || !jQuery.isXMLDoc( elem ) ) {
			hooks = jQuery.attrHooks[ name.toLowerCase() ] ||
				( jQuery.expr.match.bool.test( name ) ? boolHook : undefined );
		}

		if ( value !== undefined ) {
			if ( value === null ) {
				jQuery.removeAttr( elem, name );
				return;
			}

			if ( hooks && "set" in hooks &&
				( ret = hooks.set( elem, value, name ) ) !== undefined ) {
				return ret;
			}

			elem.setAttribute( name, value + "" );
			return value;
		}

		if ( hooks && "get" in hooks && ( ret = hooks.get( elem, name ) ) !== null ) {
			return ret;
		}

		ret = jQuery.find.attr( elem, name );

		// Non-existent attributes return null, we normalize to undefined
		return ret == null ? undefined : ret;
	},

	attrHooks: {
		type: {
			set: function( elem, value ) {
				if ( !support.radioValue && value === "radio" &&
					nodeName( elem, "input" ) ) {
					var val = elem.value;
					elem.setAttribute( "type", value );
					if ( val ) {
						elem.value = val;
					}
					return value;
				}
			}
		}
	},

	removeAttr: function( elem, value ) {
		var name,
			i = 0,

			// Attribute names can contain non-HTML whitespace characters
			// https://html.spec.whatwg.org/multipage/syntax.html#attributes-2
			attrNames = value && value.match( rnothtmlwhite );

		if ( attrNames && elem.nodeType === 1 ) {
			while ( ( name = attrNames[ i++ ] ) ) {
				elem.removeAttribute( name );
			}
		}
	}
} );

// Hooks for boolean attributes
boolHook = {
	set: function( elem, value, name ) {
		if ( value === false ) {

			// Remove boolean attributes when set to false
			jQuery.removeAttr( elem, name );
		} else {
			elem.setAttribute( name, name );
		}
		return name;
	}
};

jQuery.each( jQuery.expr.match.bool.source.match( /\w+/g ), function( _i, name ) {
	var getter = attrHandle[ name ] || jQuery.find.attr;

	attrHandle[ name ] = function( elem, name, isXML ) {
		var ret, handle,
			lowercaseName = name.toLowerCase();

		if ( !isXML ) {

			// Avoid an infinite loop by temporarily removing this function from the getter
			handle = attrHandle[ lowercaseName ];
			attrHandle[ lowercaseName ] = ret;
			ret = getter( elem, name, isXML ) != null ?
				lowercaseName :
				null;
			attrHandle[ lowercaseName ] = handle;
		}
		return ret;
	};
} );




var rfocusable = /^(?:input|select|textarea|button)$/i,
	rclickable = /^(?:a|area)$/i;

jQuery.fn.extend( {
	prop: function( name, value ) {
		return access( this, jQuery.prop, name, value, arguments.length > 1 );
	},

	removeProp: function( name ) {
		return this.each( function() {
			delete this[ jQuery.propFix[ name ] || name ];
		} );
	}
} );

jQuery.extend( {
	prop: function( elem, name, value ) {
		var ret, hooks,
			nType = elem.nodeType;

		// Don't get/set properties on text, comment and attribute nodes
		if ( nType === 3 || nType === 8 || nType === 2 ) {
			return;
		}

		if ( nType !== 1 || !jQuery.isXMLDoc( elem ) ) {

			// Fix name and attach hooks
			name = jQuery.propFix[ name ] || name;
			hooks = jQuery.propHooks[ name ];
		}

		if ( value !== undefined ) {
			if ( hooks && "set" in hooks &&
				( ret = hooks.set( elem, value, name ) ) !== undefined ) {
				return ret;
			}

			return ( elem[ name ] = value );
		}

		if ( hooks && "get" in hooks && ( ret = hooks.get( elem, name ) ) !== null ) {
			return ret;
		}

		return elem[ name ];
	},

	propHooks: {
		tabIndex: {
			get: function( elem ) {

				// Support: IE <=9 - 11 only
				// elem.tabIndex doesn't always return the
				// correct value when it hasn't been explicitly set
				// Use proper attribute retrieval (trac-12072)
				var tabindex = jQuery.find.attr( elem, "tabindex" );

				if ( tabindex ) {
					return parseInt( tabindex, 10 );
				}

				if (
					rfocusable.test( elem.nodeName ) ||
					rclickable.test( elem.nodeName ) &&
					elem.href
				) {
					return 0;
				}

				return -1;
			}
		}
	},

	propFix: {
		"for": "htmlFor",
		"class": "className"
	}
} );

// Support: IE <=11 only
// Accessing the selectedIndex property
// forces the browser to respect setting selected
// on the option
// The getter ensures a default option is selected
// when in an optgroup
// eslint rule "no-unused-expressions" is disabled for this code
// since it considers such accessions noop
if ( !support.optSelected ) {
	jQuery.propHooks.selected = {
		get: function( elem ) {

			/* eslint no-unused-expressions: "off" */

			var parent = elem.parentNode;
			if ( parent && parent.parentNode ) {
				parent.parentNode.selectedIndex;
			}
			return null;
		},
		set: function( elem ) {

			/* eslint no-unused-expressions: "off" */

			var parent = elem.parentNode;
			if ( parent ) {
				parent.selectedIndex;

				if ( parent.parentNode ) {
					parent.parentNode.selectedIndex;
				}
			}
		}
	};
}

jQuery.each( [
	"tabIndex",
	"readOnly",
	"maxLength",
	"cellSpacing",
	"cellPadding",
	"rowSpan",
	"colSpan",
	"useMap",
	"frameBorder",
	"contentEditable"
], function() {
	jQuery.propFix[ this.toLowerCase() ] = this;
} );




	// Strip and collapse whitespace according to HTML spec
	// https://infra.spec.whatwg.org/#strip-and-collapse-ascii-whitespace
	function stripAndCollapse( value ) {
		var tokens = value.match( rnothtmlwhite ) || [];
		return tokens.join( " " );
	}


function getClass( elem ) {
	return elem.getAttribute && elem.getAttribute( "class" ) || "";
}

function classesToArray( value ) {
	if ( Array.isArray( value ) ) {
		return value;
	}
	if ( typeof value === "string" ) {
		return value.match( rnothtmlwhite ) || [];
	}
	return [];
}

jQuery.fn.extend( {
	addClass: function( value ) {
		var classNames, cur, curValue, className, i, finalValue;

		if ( isFunction( value ) ) {
			return this.each( function( j ) {
				jQuery( this ).addClass( value.call( this, j, getClass( this ) ) );
			} );
		}

		classNames = classesToArray( value );

		if ( classNames.length ) {
			return this.each( function() {
				curValue = getClass( this );
				cur = this.nodeType === 1 && ( " " + stripAndCollapse( curValue ) + " " );

				if ( cur ) {
					for ( i = 0; i < classNames.length; i++ ) {
						className = classNames[ i ];
						if ( cur.indexOf( " " + className + " " ) < 0 ) {
							cur += className + " ";
						}
					}

					// Only assign if different to avoid unneeded rendering.
					finalValue = stripAndCollapse( cur );
					if ( curValue !== finalValue ) {
						this.setAttribute( "class", finalValue );
					}
				}
			} );
		}

		return this;
	},

	removeClass: function( value ) {
		var classNames, cur, curValue, className, i, finalValue;

		if ( isFunction( value ) ) {
			return this.each( function( j ) {
				jQuery( this ).removeClass( value.call( this, j, getClass( this ) ) );
			} );
		}

		if ( !arguments.length ) {
			return this.attr( "class", "" );
		}

		classNames = classesToArray( value );

		if ( classNames.length ) {
			return this.each( function() {
				curValue = getClass( this );

				// This expression is here for better compressibility (see addClass)
				cur = this.nodeType === 1 && ( " " + stripAndCollapse( curValue ) + " " );

				if ( cur ) {
					for ( i = 0; i < classNames.length; i++ ) {
						className = classNames[ i ];

						// Remove *all* instances
						while ( cur.indexOf( " " + className + " " ) > -1 ) {
							cur = cur.replace( " " + className + " ", " " );
						}
					}

					// Only assign if different to avoid unneeded rendering.
					finalValue = stripAndCollapse( cur );
					if ( curValue !== finalValue ) {
						this.setAttribute( "class", finalValue );
					}
				}
			} );
		}

		return this;
	},

	toggleClass: function( value, stateVal ) {
		var classNames, className, i, self,
			type = typeof value,
			isValidValue = type === "string" || Array.isArray( value );

		if ( isFunction( value ) ) {
			return this.each( function( i ) {
				jQuery( this ).toggleClass(
					value.call( this, i, getClass( this ), stateVal ),
					stateVal
				);
			} );
		}

		if ( typeof stateVal === "boolean" && isValidValue ) {
			return stateVal ? this.addClass( value ) : this.removeClass( value );
		}

		classNames = classesToArray( value );

		return this.each( function() {
			if ( isValidValue ) {

				// Toggle individual class names
				self = jQuery( this );

				for ( i = 0; i < classNames.length; i++ ) {
					className = classNames[ i ];

					// Check each className given, space separated list
					if ( self.hasClass( className ) ) {
						self.removeClass( className );
					} else {
						self.addClass( className );
					}
				}

			// Toggle whole class name
			} else if ( value === undefined || type === "boolean" ) {
				className = getClass( this );
				if ( className ) {

					// Store className if set
					dataPriv.set( this, "__className__", className );
				}

				// If the element has a class name or if we're passed `false`,
				// then remove the whole classname (if there was one, the above saved it).
				// Otherwise bring back whatever was previously saved (if anything),
				// falling back to the empty string if nothing was stored.
				if ( this.setAttribute ) {
					this.setAttribute( "class",
						className || value === false ?
							"" :
							dataPriv.get( this, "__className__" ) || ""
					);
				}
			}
		} );
	},

	hasClass: function( selector ) {
		var className, elem,
			i = 0;

		className = " " + selector + " ";
		while ( ( elem = this[ i++ ] ) ) {
			if ( elem.nodeType === 1 &&
				( " " + stripAndCollapse( getClass( elem ) ) + " " ).indexOf( className ) > -1 ) {
				return true;
			}
		}

		return false;
	}
} );




var rreturn = /\r/g;

jQuery.fn.extend( {
	val: function( value ) {
		var hooks, ret, valueIsFunction,
			elem = this[ 0 ];

		if ( !arguments.length ) {
			if ( elem ) {
				hooks = jQuery.valHooks[ elem.type ] ||
					jQuery.valHooks[ elem.nodeName.toLowerCase() ];

				if ( hooks &&
					"get" in hooks &&
					( ret = hooks.get( elem, "value" ) ) !== undefined
				) {
					return ret;
				}

				ret = elem.value;

				// Handle most common string cases
				if ( typeof ret === "string" ) {
					return ret.replace( rreturn, "" );
				}

				// Handle cases where value is null/undef or number
				return ret == null ? "" : ret;
			}

			return;
		}

		valueIsFunction = isFunction( value );

		return this.each( function( i ) {
			var val;

			if ( this.nodeType !== 1 ) {
				return;
			}

			if ( valueIsFunction ) {
				val = value.call( this, i, jQuery( this ).val() );
			} else {
				val = value;
			}

			// Treat null/undefined as ""; convert numbers to string
			if ( val == null ) {
				val = "";

			} else if ( typeof val === "number" ) {
				val += "";

			} else if ( Array.isArray( val ) ) {
				val = jQuery.map( val, function( value ) {
					return value == null ? "" : value + "";
				} );
			}

			hooks = jQuery.valHooks[ this.type ] || jQuery.valHooks[ this.nodeName.toLowerCase() ];

			// If set returns undefined, fall back to normal setting
			if ( !hooks || !( "set" in hooks ) || hooks.set( this, val, "value" ) === undefined ) {
				this.value = val;
			}
		} );
	}
} );

jQuery.extend( {
	valHooks: {
		option: {
			get: function( elem ) {

				var val = jQuery.find.attr( elem, "value" );
				return val != null ?
					val :

					// Support: IE <=10 - 11 only
					// option.text throws exceptions (trac-14686, trac-14858)
					// Strip and collapse whitespace
					// https://html.spec.whatwg.org/#strip-and-collapse-whitespace
					stripAndCollapse( jQuery.text( elem ) );
			}
		},
		select: {
			get: function( elem ) {
				var value, option, i,
					options = elem.options,
					index = elem.selectedIndex,
					one = elem.type === "select-one",
					values = one ? null : [],
					max = one ? index + 1 : options.length;

				if ( index < 0 ) {
					i = max;

				} else {
					i = one ? index : 0;
				}

				// Loop through all the selected options
				for ( ; i < max; i++ ) {
					option = options[ i ];

					// Support: IE <=9 only
					// IE8-9 doesn't update selected after form reset (trac-2551)
					if ( ( option.selected || i === index ) &&

							// Don't return options that are disabled or in a disabled optgroup
							!option.disabled &&
							( !option.parentNode.disabled ||
								!nodeName( option.parentNode, "optgroup" ) ) ) {

						// Get the specific value for the option
						value = jQuery( option ).val();

						// We don't need an array for one selects
						if ( one ) {
							return value;
						}

						// Multi-Selects return an array
						values.push( value );
					}
				}

				return values;
			},

			set: function( elem, value ) {
				var optionSet, option,
					options = elem.options,
					values = jQuery.makeArray( value ),
					i = options.length;

				while ( i-- ) {
					option = options[ i ];

					/* eslint-disable no-cond-assign */

					if ( option.selected =
						jQuery.inArray( jQuery.valHooks.option.get( option ), values ) > -1
					) {
						optionSet = true;
					}

					/* eslint-enable no-cond-assign */
				}

				// Force browsers to behave consistently when non-matching value is set
				if ( !optionSet ) {
					elem.selectedIndex = -1;
				}
				return values;
			}
		}
	}
} );

// Radios and checkboxes getter/setter
jQuery.each( [ "radio", "checkbox" ], function() {
	jQuery.valHooks[ this ] = {
		set: function( elem, value ) {
			if ( Array.isArray( value ) ) {
				return ( elem.checked = jQuery.inArray( jQuery( elem ).val(), value ) > -1 );
			}
		}
	};
	if ( !support.checkOn ) {
		jQuery.valHooks[ this ].get = function( elem ) {
			return elem.getAttribute( "value" ) === null ? "on" : elem.value;
		};
	}
} );




// Return jQuery for attributes-only inclusion
var location = window.location;

var nonce = { guid: Date.now() };

var rquery = ( /\?/ );



// Cross-browser xml parsing
jQuery.parseXML = function( data ) {
	var xml, parserErrorElem;
	if ( !data || typeof data !== "string" ) {
		return null;
	}

	// Support: IE 9 - 11 only
	// IE throws on parseFromString with invalid input.
	try {
		xml = ( new window.DOMParser() ).parseFromString( data, "text/xml" );
	} catch ( e ) {}

	parserErrorElem = xml && xml.getElementsByTagName( "parsererror" )[ 0 ];
	if ( !xml || parserErrorElem ) {
		jQuery.error( "Invalid XML: " + (
			parserErrorElem ?
				jQuery.map( parserErrorElem.childNodes, function( el ) {
					return el.textContent;
				} ).join( "\n" ) :
				data
		) );
	}
	return xml;
};


var rfocusMorph = /^(?:focusinfocus|focusoutblur)$/,
	stopPropagationCallback = function( e ) {
		e.stopPropagation();
	};

jQuery.extend( jQuery.event, {

	trigger: function( event, data, elem, onlyHandlers ) {

		var i, cur, tmp, bubbleType, ontype, handle, special, lastElement,
			eventPath = [ elem || document ],
			type = hasOwn.call( event, "type" ) ? event.type : event,
			namespaces = hasOwn.call( event, "namespace" ) ? event.namespace.split( "." ) : [];

		cur = lastElement = tmp = elem = elem || document;

		// Don't do events on text and comment nodes
		if ( elem.nodeType === 3 || elem.nodeType === 8 ) {
			return;
		}

		// focus/blur morphs to focusin/out; ensure we're not firing them right now
		if ( rfocusMorph.test( type + jQuery.event.triggered ) ) {
			return;
		}

		if ( type.indexOf( "." ) > -1 ) {

			// Namespaced trigger; create a regexp to match event type in handle()
			namespaces = type.split( "." );
			type = namespaces.shift();
			namespaces.sort();
		}
		ontype = type.indexOf( ":" ) < 0 && "on" + type;

		// Caller can pass in a jQuery.Event object, Object, or just an event type string
		event = event[ jQuery.expando ] ?
			event :
			new jQuery.Event( type, typeof event === "object" && event );

		// Trigger bitmask: & 1 for native handlers; & 2 for jQuery (always true)
		event.isTrigger = onlyHandlers ? 2 : 3;
		event.namespace = namespaces.join( "." );
		event.rnamespace = event.namespace ?
			new RegExp( "(^|\\.)" + namespaces.join( "\\.(?:.*\\.|)" ) + "(\\.|$)" ) :
			null;

		// Clean up the event in case it is being reused
		event.result = undefined;
		if ( !event.target ) {
			event.target = elem;
		}

		// Clone any incoming data and prepend the event, creating the handler arg list
		data = data == null ?
			[ event ] :
			jQuery.makeArray( data, [ event ] );

		// Allow special events to draw outside the lines
		special = jQuery.event.special[ type ] || {};
		if ( !onlyHandlers && special.trigger && special.trigger.apply( elem, data ) === false ) {
			return;
		}

		// Determine event propagation path in advance, per W3C events spec (trac-9951)
		// Bubble up to document, then to window; watch for a global ownerDocument var (trac-9724)
		if ( !onlyHandlers && !special.noBubble && !isWindow( elem ) ) {

			bubbleType = special.delegateType || type;
			if ( !rfocusMorph.test( bubbleType + type ) ) {
				cur = cur.parentNode;
			}
			for ( ; cur; cur = cur.parentNode ) {
				eventPath.push( cur );
				tmp = cur;
			}

			// Only add window if we got to document (e.g., not plain obj or detached DOM)
			if ( tmp === ( elem.ownerDocument || document ) ) {
				eventPath.push( tmp.defaultView || tmp.parentWindow || window );
			}
		}

		// Fire handlers on the event path
		i = 0;
		while ( ( cur = eventPath[ i++ ] ) && !event.isPropagationStopped() ) {
			lastElement = cur;
			event.type = i > 1 ?
				bubbleType :
				special.bindType || type;

			// jQuery handler
			handle = ( dataPriv.get( cur, "events" ) || Object.create( null ) )[ event.type ] &&
				dataPriv.get( cur, "handle" );
			if ( handle ) {
				handle.apply( cur, data );
			}

			// Native handler
			handle = ontype && cur[ ontype ];
			if ( handle && handle.apply && acceptData( cur ) ) {
				event.result = handle.apply( cur, data );
				if ( event.result === false ) {
					event.preventDefault();
				}
			}
		}
		event.type = type;

		// If nobody prevented the default action, do it now
		if ( !onlyHandlers && !event.isDefaultPrevented() ) {

			if ( ( !special._default ||
				special._default.apply( eventPath.pop(), data ) === false ) &&
				acceptData( elem ) ) {

				// Call a native DOM method on the target with the same name as the event.
				// Don't do default actions on window, that's where global variables be (trac-6170)
				if ( ontype && isFunction( elem[ type ] ) && !isWindow( elem ) ) {

					// Don't re-trigger an onFOO event when we call its FOO() method
					tmp = elem[ ontype ];

					if ( tmp ) {
						elem[ ontype ] = null;
					}

					// Prevent re-triggering of the same event, since we already bubbled it above
					jQuery.event.triggered = type;

					if ( event.isPropagationStopped() ) {
						lastElement.addEventListener( type, stopPropagationCallback );
					}

					elem[ type ]();

					if ( event.isPropagationStopped() ) {
						lastElement.removeEventListener( type, stopPropagationCallback );
					}

					jQuery.event.triggered = undefined;

					if ( tmp ) {
						elem[ ontype ] = tmp;
					}
				}
			}
		}

		return event.result;
	},

	// Piggyback on a donor event to simulate a different one
	// Used only for `focus(in | out)` events
	simulate: function( type, elem, event ) {
		var e = jQuery.extend(
			new jQuery.Event(),
			event,
			{
				type: type,
				isSimulated: true
			}
		);

		jQuery.event.trigger( e, null, elem );
	}

} );

jQuery.fn.extend( {

	trigger: function( type, data ) {
		return this.each( function() {
			jQuery.event.trigger( type, data, this );
		} );
	},
	triggerHandler: function( type, data ) {
		var elem = this[ 0 ];
		if ( elem ) {
			return jQuery.event.trigger( type, data, elem, true );
		}
	}
} );


var
	rbracket = /\[\]$/,
	rCRLF = /\r?\n/g,
	rsubmitterTypes = /^(?:submit|button|image|reset|file)$/i,
	rsubmittable = /^(?:input|select|textarea|keygen)/i;

function buildParams( prefix, obj, traditional, add ) {
	var name;

	if ( Array.isArray( obj ) ) {

		// Serialize array item.
		jQuery.each( obj, function( i, v ) {
			if ( traditional || rbracket.test( prefix ) ) {

				// Treat each array item as a scalar.
				add( prefix, v );

			} else {

				// Item is non-scalar (array or object), encode its numeric index.
				buildParams(
					prefix + "[" + ( typeof v === "object" && v != null ? i : "" ) + "]",
					v,
					traditional,
					add
				);
			}
		} );

	} else if ( !traditional && toType( obj ) === "object" ) {

		// Serialize object item.
		for ( name in obj ) {
			buildParams( prefix + "[" + name + "]", obj[ name ], traditional, add );
		}

	} else {

		// Serialize scalar item.
		add( prefix, obj );
	}
}

// Serialize an array of form elements or a set of
// key/values into a query string
jQuery.param = function( a, traditional ) {
	var prefix,
		s = [],
		add = function( key, valueOrFunction ) {

			// If value is a function, invoke it and use its return value
			var value = isFunction( valueOrFunction ) ?
				valueOrFunction() :
				valueOrFunction;

			s[ s.length ] = encodeURIComponent( key ) + "=" +
				encodeURIComponent( value == null ? "" : value );
		};

	if ( a == null ) {
		return "";
	}

	// If an array was passed in, assume that it is an array of form elements.
	if ( Array.isArray( a ) || ( a.jquery && !jQuery.isPlainObject( a ) ) ) {

		// Serialize the form elements
		jQuery.each( a, function() {
			add( this.name, this.value );
		} );

	} else {

		// If traditional, encode the "old" way (the way 1.3.2 or older
		// did it), otherwise encode params recursively.
		for ( prefix in a ) {
			buildParams( prefix, a[ prefix ], traditional, add );
		}
	}

	// Return the resulting serialization
	return s.join( "&" );
};

jQuery.fn.extend( {
	serialize: function() {
		return jQuery.param( this.serializeArray() );
	},
	serializeArray: function() {
		return this.map( function() {

			// Can add propHook for "elements" to filter or add form elements
			var elements = jQuery.prop( this, "elements" );
			return elements ? jQuery.makeArray( elements ) : this;
		} ).filter( function() {
			var type = this.type;

			// Use .is( ":disabled" ) so that fieldset[disabled] works
			return this.name && !jQuery( this ).is( ":disabled" ) &&
				rsubmittable.test( this.nodeName ) && !rsubmitterTypes.test( type ) &&
				( this.checked || !rcheckableType.test( type ) );
		} ).map( function( _i, elem ) {
			var val = jQuery( this ).val();

			if ( val == null ) {
				return null;
			}

			if ( Array.isArray( val ) ) {
				return jQuery.map( val, function( val ) {
					return { name: elem.name, value: val.replace( rCRLF, "\r\n" ) };
				} );
			}

			return { name: elem.name, value: val.replace( rCRLF, "\r\n" ) };
		} ).get();
	}
} );


var
	r20 = /%20/g,
	rhash = /#.*$/,
	rantiCache = /([?&])_=[^&]*/,
	rheaders = /^(.*?):[ \t]*([^\r\n]*)$/mg,

	// trac-7653, trac-8125, trac-8152: local protocol detection
	rlocalProtocol = /^(?:about|app|app-storage|.+-extension|file|res|widget):$/,
	rnoContent = /^(?:GET|HEAD)$/,
	rprotocol = /^\/\//,

	/* Prefilters
	 * 1) They are useful to introduce custom dataTypes (see ajax/jsonp.js for an example)
	 * 2) These are called:
	 *    - BEFORE asking for a transport
	 *    - AFTER param serialization (s.data is a string if s.processData is true)
	 * 3) key is the dataType
	 * 4) the catchall symbol "*" can be used
	 * 5) execution will start with transport dataType and THEN continue down to "*" if needed
	 */
	prefilters = {},

	/* Transports bindings
	 * 1) key is the dataType
	 * 2) the catchall symbol "*" can be used
	 * 3) selection will start with transport dataType and THEN go to "*" if needed
	 */
	transports = {},

	// Avoid comment-prolog char sequence (trac-10098); must appease lint and evade compression
	allTypes = "*/".concat( "*" ),

	// Anchor tag for parsing the document origin
	originAnchor = document.createElement( "a" );

originAnchor.href = location.href;

// Base "constructor" for jQuery.ajaxPrefilter and jQuery.ajaxTransport
function addToPrefiltersOrTransports( structure ) {

	// dataTypeExpression is optional and defaults to "*"
	return function( dataTypeExpression, func ) {

		if ( typeof dataTypeExpression !== "string" ) {
			func = dataTypeExpression;
			dataTypeExpression = "*";
		}

		var dataType,
			i = 0,
			dataTypes = dataTypeExpression.toLowerCase().match( rnothtmlwhite ) || [];

		if ( isFunction( func ) ) {

			// For each dataType in the dataTypeExpression
			while ( ( dataType = dataTypes[ i++ ] ) ) {

				// Prepend if requested
				if ( dataType[ 0 ] === "+" ) {
					dataType = dataType.slice( 1 ) || "*";
					( structure[ dataType ] = structure[ dataType ] || [] ).unshift( func );

				// Otherwise append
				} else {
					( structure[ dataType ] = structure[ dataType ] || [] ).push( func );
				}
			}
		}
	};
}

// Base inspection function for prefilters and transports
function inspectPrefiltersOrTransports( structure, options, originalOptions, jqXHR ) {

	var inspected = {},
		seekingTransport = ( structure === transports );

	function inspect( dataType ) {
		var selected;
		inspected[ dataType ] = true;
		jQuery.each( structure[ dataType ] || [], function( _, prefilterOrFactory ) {
			var dataTypeOrTransport = prefilterOrFactory( options, originalOptions, jqXHR );
			if ( typeof dataTypeOrTransport === "string" &&
				!seekingTransport && !inspected[ dataTypeOrTransport ] ) {

				options.dataTypes.unshift( dataTypeOrTransport );
				inspect( dataTypeOrTransport );
				return false;
			} else if ( seekingTransport ) {
				return !( selected = dataTypeOrTransport );
			}
		} );
		return selected;
	}

	return inspect( options.dataTypes[ 0 ] ) || !inspected[ "*" ] && inspect( "*" );
}

// A special extend for ajax options
// that takes "flat" options (not to be deep extended)
// Fixes trac-9887
function ajaxExtend( target, src ) {
	var key, deep,
		flatOptions = jQuery.ajaxSettings.flatOptions || {};

	for ( key in src ) {
		if ( src[ key ] !== undefined ) {
			( flatOptions[ key ] ? target : ( deep || ( deep = {} ) ) )[ key ] = src[ key ];
		}
	}
	if ( deep ) {
		jQuery.extend( true, target, deep );
	}

	return target;
}

/* Handles responses to an ajax request:
 * - finds the right dataType (mediates between content-type and expected dataType)
 * - returns the corresponding response
 */
function ajaxHandleResponses( s, jqXHR, responses ) {

	var ct, type, finalDataType, firstDataType,
		contents = s.contents,
		dataTypes = s.dataTypes;

	// Remove auto dataType and get content-type in the process
	while ( dataTypes[ 0 ] === "*" ) {
		dataTypes.shift();
		if ( ct === undefined ) {
			ct = s.mimeType || jqXHR.getResponseHeader( "Content-Type" );
		}
	}

	// Check if we're dealing with a known content-type
	if ( ct ) {
		for ( type in contents ) {
			if ( contents[ type ] && contents[ type ].test( ct ) ) {
				dataTypes.unshift( type );
				break;
			}
		}
	}

	// Check to see if we have a response for the expected dataType
	if ( dataTypes[ 0 ] in responses ) {
		finalDataType = dataTypes[ 0 ];
	} else {

		// Try convertible dataTypes
		for ( type in responses ) {
			if ( !dataTypes[ 0 ] || s.converters[ type + " " + dataTypes[ 0 ] ] ) {
				finalDataType = type;
				break;
			}
			if ( !firstDataType ) {
				firstDataType = type;
			}
		}

		// Or just use first one
		finalDataType = finalDataType || firstDataType;
	}

	// If we found a dataType
	// We add the dataType to the list if needed
	// and return the corresponding response
	if ( finalDataType ) {
		if ( finalDataType !== dataTypes[ 0 ] ) {
			dataTypes.unshift( finalDataType );
		}
		return responses[ finalDataType ];
	}
}

/* Chain conversions given the request and the original response
 * Also sets the responseXXX fields on the jqXHR instance
 */
function ajaxConvert( s, response, jqXHR, isSuccess ) {
	var conv2, current, conv, tmp, prev,
		converters = {},

		// Work with a copy of dataTypes in case we need to modify it for conversion
		dataTypes = s.dataTypes.slice();

	// Create converters map with lowercased keys
	if ( dataTypes[ 1 ] ) {
		for ( conv in s.converters ) {
			converters[ conv.toLowerCase() ] = s.converters[ conv ];
		}
	}

	current = dataTypes.shift();

	// Convert to each sequential dataType
	while ( current ) {

		if ( s.responseFields[ current ] ) {
			jqXHR[ s.responseFields[ current ] ] = response;
		}

		// Apply the dataFilter if provided
		if ( !prev && isSuccess && s.dataFilter ) {
			response = s.dataFilter( response, s.dataType );
		}

		prev = current;
		current = dataTypes.shift();

		if ( current ) {

			// There's only work to do if current dataType is non-auto
			if ( current === "*" ) {

				current = prev;

			// Convert response if prev dataType is non-auto and differs from current
			} else if ( prev !== "*" && prev !== current ) {

				// Seek a direct converter
				conv = converters[ prev + " " + current ] || converters[ "* " + current ];

				// If none found, seek a pair
				if ( !conv ) {
					for ( conv2 in converters ) {

						// If conv2 outputs current
						tmp = conv2.split( " " );
						if ( tmp[ 1 ] === current ) {

							// If prev can be converted to accepted input
							conv = converters[ prev + " " + tmp[ 0 ] ] ||
								converters[ "* " + tmp[ 0 ] ];
							if ( conv ) {

								// Condense equivalence converters
								if ( conv === true ) {
									conv = converters[ conv2 ];

								// Otherwise, insert the intermediate dataType
								} else if ( converters[ conv2 ] !== true ) {
									current = tmp[ 0 ];
									dataTypes.unshift( tmp[ 1 ] );
								}
								break;
							}
						}
					}
				}

				// Apply converter (if not an equivalence)
				if ( conv !== true ) {

					// Unless errors are allowed to bubble, catch and return them
					if ( conv && s.throws ) {
						response = conv( response );
					} else {
						try {
							response = conv( response );
						} catch ( e ) {
							return {
								state: "parsererror",
								error: conv ? e : "No conversion from " + prev + " to " + current
							};
						}
					}
				}
			}
		}
	}

	return { state: "success", data: response };
}

jQuery.extend( {

	// Counter for holding the number of active queries
	active: 0,

	// Last-Modified header cache for next request
	lastModified: {},
	etag: {},

	ajaxSettings: {
		url: location.href,
		type: "GET",
		isLocal: rlocalProtocol.test( location.protocol ),
		global: true,
		processData: true,
		async: true,
		contentType: "application/x-www-form-urlencoded; charset=UTF-8",

		/*
		timeout: 0,
		data: null,
		dataType: null,
		username: null,
		password: null,
		cache: null,
		throws: false,
		traditional: false,
		headers: {},
		*/

		accepts: {
			"*": allTypes,
			text: "text/plain",
			html: "text/html",
			xml: "application/xml, text/xml",
			json: "application/json, text/javascript"
		},

		contents: {
			xml: /\bxml\b/,
			html: /\bhtml/,
			json: /\bjson\b/
		},

		responseFields: {
			xml: "responseXML",
			text: "responseText",
			json: "responseJSON"
		},

		// Data converters
		// Keys separate source (or catchall "*") and destination types with a single space
		converters: {

			// Convert anything to text
			"* text": String,

			// Text to html (true = no transformation)
			"text html": true,

			// Evaluate text as a json expression
			"text json": JSON.parse,

			// Parse text as xml
			"text xml": jQuery.parseXML
		},

		// For options that shouldn't be deep extended:
		// you can add your own custom options here if
		// and when you create one that shouldn't be
		// deep extended (see ajaxExtend)
		flatOptions: {
			url: true,
			context: true
		}
	},

	// Creates a full fledged settings object into target
	// with both ajaxSettings and settings fields.
	// If target is omitted, writes into ajaxSettings.
	ajaxSetup: function( target, settings ) {
		return settings ?

			// Building a settings object
			ajaxExtend( ajaxExtend( target, jQuery.ajaxSettings ), settings ) :

			// Extending ajaxSettings
			ajaxExtend( jQuery.ajaxSettings, target );
	},

	ajaxPrefilter: addToPrefiltersOrTransports( prefilters ),
	ajaxTransport: addToPrefiltersOrTransports( transports ),

	// Main method
	ajax: function( url, options ) {

		// If url is an object, simulate pre-1.5 signature
		if ( typeof url === "object" ) {
			options = url;
			url = undefined;
		}

		// Force options to be an object
		options = options || {};

		var transport,

			// URL without anti-cache param
			cacheURL,

			// Response headers
			responseHeadersString,
			responseHeaders,

			// timeout handle
			timeoutTimer,

			// Url cleanup var
			urlAnchor,

			// Request state (becomes false upon send and true upon completion)
			completed,

			// To know if global events are to be dispatched
			fireGlobals,

			// Loop variable
			i,

			// uncached part of the url
			uncached,

			// Create the final options object
			s = jQuery.ajaxSetup( {}, options ),

			// Callbacks context
			callbackContext = s.context || s,

			// Context for global events is callbackContext if it is a DOM node or jQuery collection
			globalEventContext = s.context &&
				( callbackContext.nodeType || callbackContext.jquery ) ?
				jQuery( callbackContext ) :
				jQuery.event,

			// Deferreds
			deferred = jQuery.Deferred(),
			completeDeferred = jQuery.Callbacks( "once memory" ),

			// Status-dependent callbacks
			statusCode = s.statusCode || {},

			// Headers (they are sent all at once)
			requestHeaders = {},
			requestHeadersNames = {},

			// Default abort message
			strAbort = "canceled",

			// Fake xhr
			jqXHR = {
				readyState: 0,

				// Builds headers hashtable if needed
				getResponseHeader: function( key ) {
					var match;
					if ( completed ) {
						if ( !responseHeaders ) {
							responseHeaders = {};
							while ( ( match = rheaders.exec( responseHeadersString ) ) ) {
								responseHeaders[ match[ 1 ].toLowerCase() + " " ] =
									( responseHeaders[ match[ 1 ].toLowerCase() + " " ] || [] )
										.concat( match[ 2 ] );
							}
						}
						match = responseHeaders[ key.toLowerCase() + " " ];
					}
					return match == null ? null : match.join( ", " );
				},

				// Raw string
				getAllResponseHeaders: function() {
					return completed ? responseHeadersString : null;
				},

				// Caches the header
				setRequestHeader: function( name, value ) {
					if ( completed == null ) {
						name = requestHeadersNames[ name.toLowerCase() ] =
							requestHeadersNames[ name.toLowerCase() ] || name;
						requestHeaders[ name ] = value;
					}
					return this;
				},

				// Overrides response content-type header
				overrideMimeType: function( type ) {
					if ( completed == null ) {
						s.mimeType = type;
					}
					return this;
				},

				// Status-dependent callbacks
				statusCode: function( map ) {
					var code;
					if ( map ) {
						if ( completed ) {

							// Execute the appropriate callbacks
							jqXHR.always( map[ jqXHR.status ] );
						} else {

							// Lazy-add the new callbacks in a way that preserves old ones
							for ( code in map ) {
								statusCode[ code ] = [ statusCode[ code ], map[ code ] ];
							}
						}
					}
					return this;
				},

				// Cancel the request
				abort: function( statusText ) {
					var finalText = statusText || strAbort;
					if ( transport ) {
						transport.abort( finalText );
					}
					done( 0, finalText );
					return this;
				}
			};

		// Attach deferreds
		deferred.promise( jqXHR );

		// Add protocol if not provided (prefilters might expect it)
		// Handle falsy url in the settings object (trac-10093: consistency with old signature)
		// We also use the url parameter if available
		s.url = ( ( url || s.url || location.href ) + "" )
			.replace( rprotocol, location.protocol + "//" );

		// Alias method option to type as per ticket trac-12004
		s.type = options.method || options.type || s.method || s.type;

		// Extract dataTypes list
		s.dataTypes = ( s.dataType || "*" ).toLowerCase().match( rnothtmlwhite ) || [ "" ];

		// A cross-domain request is in order when the origin doesn't match the current origin.
		if ( s.crossDomain == null ) {
			urlAnchor = document.createElement( "a" );

			// Support: IE <=8 - 11, Edge 12 - 15
			// IE throws exception on accessing the href property if url is malformed,
			// e.g. http://example.com:80x/
			try {
				urlAnchor.href = s.url;

				// Support: IE <=8 - 11 only
				// Anchor's host property isn't correctly set when s.url is relative
				urlAnchor.href = urlAnchor.href;
				s.crossDomain = originAnchor.protocol + "//" + originAnchor.host !==
					urlAnchor.protocol + "//" + urlAnchor.host;
			} catch ( e ) {

				// If there is an error parsing the URL, assume it is crossDomain,
				// it can be rejected by the transport if it is invalid
				s.crossDomain = true;
			}
		}

		// Convert data if not already a string
		if ( s.data && s.processData && typeof s.data !== "string" ) {
			s.data = jQuery.param( s.data, s.traditional );
		}

		// Apply prefilters
		inspectPrefiltersOrTransports( prefilters, s, options, jqXHR );

		// If request was aborted inside a prefilter, stop there
		if ( completed ) {
			return jqXHR;
		}

		// We can fire global events as of now if asked to
		// Don't fire events if jQuery.event is undefined in an AMD-usage scenario (trac-15118)
		fireGlobals = jQuery.event && s.global;

		// Watch for a new set of requests
		if ( fireGlobals && jQuery.active++ === 0 ) {
			jQuery.event.trigger( "ajaxStart" );
		}

		// Uppercase the type
		s.type = s.type.toUpperCase();

		// Determine if request has content
		s.hasContent = !rnoContent.test( s.type );

		// Save the URL in case we're toying with the If-Modified-Since
		// and/or If-None-Match header later on
		// Remove hash to simplify url manipulation
		cacheURL = s.url.replace( rhash, "" );

		// More options handling for requests with no content
		if ( !s.hasContent ) {

			// Remember the hash so we can put it back
			uncached = s.url.slice( cacheURL.length );

			// If data is available and should be processed, append data to url
			if ( s.data && ( s.processData || typeof s.data === "string" ) ) {
				cacheURL += ( rquery.test( cacheURL ) ? "&" : "?" ) + s.data;

				// trac-9682: remove data so that it's not used in an eventual retry
				delete s.data;
			}

			// Add or update anti-cache param if needed
			if ( s.cache === false ) {
				cacheURL = cacheURL.replace( rantiCache, "$1" );
				uncached = ( rquery.test( cacheURL ) ? "&" : "?" ) + "_=" + ( nonce.guid++ ) +
					uncached;
			}

			// Put hash and anti-cache on the URL that will be requested (gh-1732)
			s.url = cacheURL + uncached;

		// Change '%20' to '+' if this is encoded form body content (gh-2658)
		} else if ( s.data && s.processData &&
			( s.contentType || "" ).indexOf( "application/x-www-form-urlencoded" ) === 0 ) {
			s.data = s.data.replace( r20, "+" );
		}

		// Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.
		if ( s.ifModified ) {
			if ( jQuery.lastModified[ cacheURL ] ) {
				jqXHR.setRequestHeader( "If-Modified-Since", jQuery.lastModified[ cacheURL ] );
			}
			if ( jQuery.etag[ cacheURL ] ) {
				jqXHR.setRequestHeader( "If-None-Match", jQuery.etag[ cacheURL ] );
			}
		}

		// Set the correct header, if data is being sent
		if ( s.data && s.hasContent && s.contentType !== false || options.contentType ) {
			jqXHR.setRequestHeader( "Content-Type", s.contentType );
		}

		// Set the Accepts header for the server, depending on the dataType
		jqXHR.setRequestHeader(
			"Accept",
			s.dataTypes[ 0 ] && s.accepts[ s.dataTypes[ 0 ] ] ?
				s.accepts[ s.dataTypes[ 0 ] ] +
					( s.dataTypes[ 0 ] !== "*" ? ", " + allTypes + "; q=0.01" : "" ) :
				s.accepts[ "*" ]
		);

		// Check for headers option
		for ( i in s.headers ) {
			jqXHR.setRequestHeader( i, s.headers[ i ] );
		}

		// Allow custom headers/mimetypes and early abort
		if ( s.beforeSend &&
			( s.beforeSend.call( callbackContext, jqXHR, s ) === false || completed ) ) {

			// Abort if not done already and return
			return jqXHR.abort();
		}

		// Aborting is no longer a cancellation
		strAbort = "abort";

		// Install callbacks on deferreds
		completeDeferred.add( s.complete );
		jqXHR.done( s.success );
		jqXHR.fail( s.error );

		// Get transport
		transport = inspectPrefiltersOrTransports( transports, s, options, jqXHR );

		// If no transport, we auto-abort
		if ( !transport ) {
			done( -1, "No Transport" );
		} else {
			jqXHR.readyState = 1;

			// Send global event
			if ( fireGlobals ) {
				globalEventContext.trigger( "ajaxSend", [ jqXHR, s ] );
			}

			// If request was aborted inside ajaxSend, stop there
			if ( completed ) {
				return jqXHR;
			}

			// Timeout
			if ( s.async && s.timeout > 0 ) {
				timeoutTimer = window.setTimeout( function() {
					jqXHR.abort( "timeout" );
				}, s.timeout );
			}

			try {
				completed = false;
				transport.send( requestHeaders, done );
			} catch ( e ) {

				// Rethrow post-completion exceptions
				if ( completed ) {
					throw e;
				}

				// Propagate others as results
				done( -1, e );
			}
		}

		// Callback for when everything is done
		function done( status, nativeStatusText, responses, headers ) {
			var isSuccess, success, error, response, modified,
				statusText = nativeStatusText;

			// Ignore repeat invocations
			if ( completed ) {
				return;
			}

			completed = true;

			// Clear timeout if it exists
			if ( timeoutTimer ) {
				window.clearTimeout( timeoutTimer );
			}

			// Dereference transport for early garbage collection
			// (no matter how long the jqXHR object will be used)
			transport = undefined;

			// Cache response headers
			responseHeadersString = headers || "";

			// Set readyState
			jqXHR.readyState = status > 0 ? 4 : 0;

			// Determine if successful
			isSuccess = status >= 200 && status < 300 || status === 304;

			// Get response data
			if ( responses ) {
				response = ajaxHandleResponses( s, jqXHR, responses );
			}

			// Use a noop converter for missing script but not if jsonp
			if ( !isSuccess &&
				jQuery.inArray( "script", s.dataTypes ) > -1 &&
				jQuery.inArray( "json", s.dataTypes ) < 0 ) {
				s.converters[ "text script" ] = function() {};
			}

			// Convert no matter what (that way responseXXX fields are always set)
			response = ajaxConvert( s, response, jqXHR, isSuccess );

			// If successful, handle type chaining
			if ( isSuccess ) {

				// Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.
				if ( s.ifModified ) {
					modified = jqXHR.getResponseHeader( "Last-Modified" );
					if ( modified ) {
						jQuery.lastModified[ cacheURL ] = modified;
					}
					modified = jqXHR.getResponseHeader( "etag" );
					if ( modified ) {
						jQuery.etag[ cacheURL ] = modified;
					}
				}

				// if no content
				if ( status === 204 || s.type === "HEAD" ) {
					statusText = "nocontent";

				// if not modified
				} else if ( status === 304 ) {
					statusText = "notmodified";

				// If we have data, let's convert it
				} else {
					statusText = response.state;
					success = response.data;
					error = response.error;
					isSuccess = !error;
				}
			} else {

				// Extract error from statusText and normalize for non-aborts
				error = statusText;
				if ( status || !statusText ) {
					statusText = "error";
					if ( status < 0 ) {
						status = 0;
					}
				}
			}

			// Set data for the fake xhr object
			jqXHR.status = status;
			jqXHR.statusText = ( nativeStatusText || statusText ) + "";

			// Success/Error
			if ( isSuccess ) {
				deferred.resolveWith( callbackContext, [ success, statusText, jqXHR ] );
			} else {
				deferred.rejectWith( callbackContext, [ jqXHR, statusText, error ] );
			}

			// Status-dependent callbacks
			jqXHR.statusCode( statusCode );
			statusCode = undefined;

			if ( fireGlobals ) {
				globalEventContext.trigger( isSuccess ? "ajaxSuccess" : "ajaxError",
					[ jqXHR, s, isSuccess ? success : error ] );
			}

			// Complete
			completeDeferred.fireWith( callbackContext, [ jqXHR, statusText ] );

			if ( fireGlobals ) {
				globalEventContext.trigger( "ajaxComplete", [ jqXHR, s ] );

				// Handle the global AJAX counter
				if ( !( --jQuery.active ) ) {
					jQuery.event.trigger( "ajaxStop" );
				}
			}
		}

		return jqXHR;
	},

	getJSON: function( url, data, callback ) {
		return jQuery.get( url, data, callback, "json" );
	},

	getScript: function( url, callback ) {
		return jQuery.get( url, undefined, callback, "script" );
	}
} );

jQuery.each( [ "get", "post" ], function( _i, method ) {
	jQuery[ method ] = function( url, data, callback, type ) {

		// Shift arguments if data argument was omitted
		if ( isFunction( data ) ) {
			type = type || callback;
			callback = data;
			data = undefined;
		}

		// The url can be an options object (which then must have .url)
		return jQuery.ajax( jQuery.extend( {
			url: url,
			type: method,
			dataType: type,
			data: data,
			success: callback
		}, jQuery.isPlainObject( url ) && url ) );
	};
} );

jQuery.ajaxPrefilter( function( s ) {
	var i;
	for ( i in s.headers ) {
		if ( i.toLowerCase() === "content-type" ) {
			s.contentType = s.headers[ i ] || "";
		}
	}
} );


jQuery._evalUrl = function( url, options, doc ) {
	return jQuery.ajax( {
		url: url,

		// Make this explicit, since user can override this through ajaxSetup (trac-11264)
		type: "GET",
		dataType: "script",
		cache: true,
		async: false,
		global: false,

		// Only evaluate the response if it is successful (gh-4126)
		// dataFilter is not invoked for failure responses, so using it instead
		// of the default converter is kludgy but it works.
		converters: {
			"text script": function() {}
		},
		dataFilter: function( response ) {
			jQuery.globalEval( response, options, doc );
		}
	} );
};


jQuery.fn.extend( {
	wrapAll: function( html ) {
		var wrap;

		if ( this[ 0 ] ) {
			if ( isFunction( html ) ) {
				html = html.call( this[ 0 ] );
			}

			// The elements to wrap the target around
			wrap = jQuery( html, this[ 0 ].ownerDocument ).eq( 0 ).clone( true );

			if ( this[ 0 ].parentNode ) {
				wrap.insertBefore( this[ 0 ] );
			}

			wrap.map( function() {
				var elem = this;

				while ( elem.firstElementChild ) {
					elem = elem.firstElementChild;
				}

				return elem;
			} ).append( this );
		}

		return this;
	},

	wrapInner: function( html ) {
		if ( isFunction( html ) ) {
			return this.each( function( i ) {
				jQuery( this ).wrapInner( html.call( this, i ) );
			} );
		}

		return this.each( function() {
			var self = jQuery( this ),
				contents = self.contents();

			if ( contents.length ) {
				contents.wrapAll( html );

			} else {
				self.append( html );
			}
		} );
	},

	wrap: function( html ) {
		var htmlIsFunction = isFunction( html );

		return this.each( function( i ) {
			jQuery( this ).wrapAll( htmlIsFunction ? html.call( this, i ) : html );
		} );
	},

	unwrap: function( selector ) {
		this.parent( selector ).not( "body" ).each( function() {
			jQuery( this ).replaceWith( this.childNodes );
		} );
		return this;
	}
} );


jQuery.expr.pseudos.hidden = function( elem ) {
	return !jQuery.expr.pseudos.visible( elem );
};
jQuery.expr.pseudos.visible = function( elem ) {
	return !!( elem.offsetWidth || elem.offsetHeight || elem.getClientRects().length );
};




jQuery.ajaxSettings.xhr = function() {
	try {
		return new window.XMLHttpRequest();
	} catch ( e ) {}
};

var xhrSuccessStatus = {

		// File protocol always yields status code 0, assume 200
		0: 200,

		// Support: IE <=9 only
		// trac-1450: sometimes IE returns 1223 when it should be 204
		1223: 204
	},
	xhrSupported = jQuery.ajaxSettings.xhr();

support.cors = !!xhrSupported && ( "withCredentials" in xhrSupported );
support.ajax = xhrSupported = !!xhrSupported;

jQuery.ajaxTransport( function( options ) {
	var callback, errorCallback;

	// Cross domain only allowed if supported through XMLHttpRequest
	if ( support.cors || xhrSupported && !options.crossDomain ) {
		return {
			send: function( headers, complete ) {
				var i,
					xhr = options.xhr();

				xhr.open(
					options.type,
					options.url,
					options.async,
					options.username,
					options.password
				);

				// Apply custom fields if provided
				if ( options.xhrFields ) {
					for ( i in options.xhrFields ) {
						xhr[ i ] = options.xhrFields[ i ];
					}
				}

				// Override mime type if needed
				if ( options.mimeType && xhr.overrideMimeType ) {
					xhr.overrideMimeType( options.mimeType );
				}

				// X-Requested-With header
				// For cross-domain requests, seeing as conditions for a preflight are
				// akin to a jigsaw puzzle, we simply never set it to be sure.
				// (it can always be set on a per-request basis or even using ajaxSetup)
				// For same-domain requests, won't change header if already provided.
				if ( !options.crossDomain && !headers[ "X-Requested-With" ] ) {
					headers[ "X-Requested-With" ] = "XMLHttpRequest";
				}

				// Set headers
				for ( i in headers ) {
					xhr.setRequestHeader( i, headers[ i ] );
				}

				// Callback
				callback = function( type ) {
					return function() {
						if ( callback ) {
							callback = errorCallback = xhr.onload =
								xhr.onerror = xhr.onabort = xhr.ontimeout =
									xhr.onreadystatechange = null;

							if ( type === "abort" ) {
								xhr.abort();
							} else if ( type === "error" ) {

								// Support: IE <=9 only
								// On a manual native abort, IE9 throws
								// errors on any property access that is not readyState
								if ( typeof xhr.status !== "number" ) {
									complete( 0, "error" );
								} else {
									complete(

										// File: protocol always yields status 0; see trac-8605, trac-14207
										xhr.status,
										xhr.statusText
									);
								}
							} else {
								complete(
									xhrSuccessStatus[ xhr.status ] || xhr.status,
									xhr.statusText,

									// Support: IE <=9 only
									// IE9 has no XHR2 but throws on binary (trac-11426)
									// For XHR2 non-text, let the caller handle it (gh-2498)
									( xhr.responseType || "text" ) !== "text"  ||
									typeof xhr.responseText !== "string" ?
										{ binary: xhr.response } :
										{ text: xhr.responseText },
									xhr.getAllResponseHeaders()
								);
							}
						}
					};
				};

				// Listen to events
				xhr.onload = callback();
				errorCallback = xhr.onerror = xhr.ontimeout = callback( "error" );

				// Support: IE 9 only
				// Use onreadystatechange to replace onabort
				// to handle uncaught aborts
				if ( xhr.onabort !== undefined ) {
					xhr.onabort = errorCallback;
				} else {
					xhr.onreadystatechange = function() {

						// Check readyState before timeout as it changes
						if ( xhr.readyState === 4 ) {

							// Allow onerror to be called first,
							// but that will not handle a native abort
							// Also, save errorCallback to a variable
							// as xhr.onerror cannot be accessed
							window.setTimeout( function() {
								if ( callback ) {
									errorCallback();
								}
							} );
						}
					};
				}

				// Create the abort callback
				callback = callback( "abort" );

				try {

					// Do send the request (this may raise an exception)
					xhr.send( options.hasContent && options.data || null );
				} catch ( e ) {

					// trac-14683: Only rethrow if this hasn't been notified as an error yet
					if ( callback ) {
						throw e;
					}
				}
			},

			abort: function() {
				if ( callback ) {
					callback();
				}
			}
		};
	}
} );




// Prevent auto-execution of scripts when no explicit dataType was provided (See gh-2432)
jQuery.ajaxPrefilter( function( s ) {
	if ( s.crossDomain ) {
		s.contents.script = false;
	}
} );

// Install script dataType
jQuery.ajaxSetup( {
	accepts: {
		script: "text/javascript, application/javascript, " +
			"application/ecmascript, application/x-ecmascript"
	},
	contents: {
		script: /\b(?:java|ecma)script\b/
	},
	converters: {
		"text script": function( text ) {
			jQuery.globalEval( text );
			return text;
		}
	}
} );

// Handle cache's special case and crossDomain
jQuery.ajaxPrefilter( "script", function( s ) {
	if ( s.cache === undefined ) {
		s.cache = false;
	}
	if ( s.crossDomain ) {
		s.type = "GET";
	}
} );

// Bind script tag hack transport
jQuery.ajaxTransport( "script", function( s ) {

	// This transport only deals with cross domain or forced-by-attrs requests
	if ( s.crossDomain || s.scriptAttrs ) {
		var script, callback;
		return {
			send: function( _, complete ) {
				script = jQuery( "<script>" )
					.attr( s.scriptAttrs || {} )
					.prop( { charset: s.scriptCharset, src: s.url } )
					.on( "load error", callback = function( evt ) {
						script.remove();
						callback = null;
						if ( evt ) {
							complete( evt.type === "error" ? 404 : 200, evt.type );
						}
					} );

				// Use native DOM manipulation to avoid our domManip AJAX trickery
				document.head.appendChild( script[ 0 ] );
			},
			abort: function() {
				if ( callback ) {
					callback();
				}
			}
		};
	}
} );




var oldCallbacks = [],
	rjsonp = /(=)\?(?=&|$)|\?\?/;

// Default jsonp settings
jQuery.ajaxSetup( {
	jsonp: "callback",
	jsonpCallback: function() {
		var callback = oldCallbacks.pop() || ( jQuery.expando + "_" + ( nonce.guid++ ) );
		this[ callback ] = true;
		return callback;
	}
} );

// Detect, normalize options and install callbacks for jsonp requests
jQuery.ajaxPrefilter( "json jsonp", function( s, originalSettings, jqXHR ) {

	var callbackName, overwritten, responseContainer,
		jsonProp = s.jsonp !== false && ( rjsonp.test( s.url ) ?
			"url" :
			typeof s.data === "string" &&
				( s.contentType || "" )
					.indexOf( "application/x-www-form-urlencoded" ) === 0 &&
				rjsonp.test( s.data ) && "data"
		);

	// Handle iff the expected data type is "jsonp" or we have a parameter to set
	if ( jsonProp || s.dataTypes[ 0 ] === "jsonp" ) {

		// Get callback name, remembering preexisting value associated with it
		callbackName = s.jsonpCallback = isFunction( s.jsonpCallback ) ?
			s.jsonpCallback() :
			s.jsonpCallback;

		// Insert callback into url or form data
		if ( jsonProp ) {
			s[ jsonProp ] = s[ jsonProp ].replace( rjsonp, "$1" + callbackName );
		} else if ( s.jsonp !== false ) {
			s.url += ( rquery.test( s.url ) ? "&" : "?" ) + s.jsonp + "=" + callbackName;
		}

		// Use data converter to retrieve json after script execution
		s.converters[ "script json" ] = function() {
			if ( !responseContainer ) {
				jQuery.error( callbackName + " was not called" );
			}
			return responseContainer[ 0 ];
		};

		// Force json dataType
		s.dataTypes[ 0 ] = "json";

		// Install callback
		overwritten = window[ callbackName ];
		window[ callbackName ] = function() {
			responseContainer = arguments;
		};

		// Clean-up function (fires after converters)
		jqXHR.always( function() {

			// If previous value didn't exist - remove it
			if ( overwritten === undefined ) {
				jQuery( window ).removeProp( callbackName );

			// Otherwise restore preexisting value
			} else {
				window[ callbackName ] = overwritten;
			}

			// Save back as free
			if ( s[ callbackName ] ) {

				// Make sure that re-using the options doesn't screw things around
				s.jsonpCallback = originalSettings.jsonpCallback;

				// Save the callback name for future use
				oldCallbacks.push( callbackName );
			}

			// Call if it was a function and we have a response
			if ( responseContainer && isFunction( overwritten ) ) {
				overwritten( responseContainer[ 0 ] );
			}

			responseContainer = overwritten = undefined;
		} );

		// Delegate to script
		return "script";
	}
} );




// Support: Safari 8 only
// In Safari 8 documents created via document.implementation.createHTMLDocument
// collapse sibling forms: the second one becomes a child of the first one.
// Because of that, this security measure has to be disabled in Safari 8.
// https://bugs.webkit.org/show_bug.cgi?id=137337
support.createHTMLDocument = ( function() {
	var body = document.implementation.createHTMLDocument( "" ).body;
	body.innerHTML = "<form></form><form></form>";
	return body.childNodes.length === 2;
} )();


// Argument "data" should be string of html
// context (optional): If specified, the fragment will be created in this context,
// defaults to document
// keepScripts (optional): If true, will include scripts passed in the html string
jQuery.parseHTML = function( data, context, keepScripts ) {
	if ( typeof data !== "string" ) {
		return [];
	}
	if ( typeof context === "boolean" ) {
		keepScripts = context;
		context = false;
	}

	var base, parsed, scripts;

	if ( !context ) {

		// Stop scripts or inline event handlers from being executed immediately
		// by using document.implementation
		if ( support.createHTMLDocument ) {
			context = document.implementation.createHTMLDocument( "" );

			// Set the base href for the created document
			// so any parsed elements with URLs
			// are based on the document's URL (gh-2965)
			base = context.createElement( "base" );
			base.href = document.location.href;
			context.head.appendChild( base );
		} else {
			context = document;
		}
	}

	parsed = rsingleTag.exec( data );
	scripts = !keepScripts && [];

	// Single tag
	if ( parsed ) {
		return [ context.createElement( parsed[ 1 ] ) ];
	}

	parsed = buildFragment( [ data ], context, scripts );

	if ( scripts && scripts.length ) {
		jQuery( scripts ).remove();
	}

	return jQuery.merge( [], parsed.childNodes );
};


/**
 * Load a url into a page
 */
jQuery.fn.load = function( url, params, callback ) {
	var selector, type, response,
		self = this,
		off = url.indexOf( " " );

	if ( off > -1 ) {
		selector = stripAndCollapse( url.slice( off ) );
		url = url.slice( 0, off );
	}

	// If it's a function
	if ( isFunction( params ) ) {

		// We assume that it's the callback
		callback = params;
		params = undefined;

	// Otherwise, build a param string
	} else if ( params && typeof params === "object" ) {
		type = "POST";
	}

	// If we have elements to modify, make the request
	if ( self.length > 0 ) {
		jQuery.ajax( {
			url: url,

			// If "type" variable is undefined, then "GET" method will be used.
			// Make value of this field explicit since
			// user can override it through ajaxSetup method
			type: type || "GET",
			dataType: "html",
			data: params
		} ).done( function( responseText ) {

			// Save response for use in complete callback
			response = arguments;

			self.html( selector ?

				// If a selector was specified, locate the right elements in a dummy div
				// Exclude scripts to avoid IE 'Permission Denied' errors
				jQuery( "<div>" ).append( jQuery.parseHTML( responseText ) ).find( selector ) :

				// Otherwise use the full result
				responseText );

		// If the request succeeds, this function gets "data", "status", "jqXHR"
		// but they are ignored because response was set above.
		// If it fails, this function gets "jqXHR", "status", "error"
		} ).always( callback && function( jqXHR, status ) {
			self.each( function() {
				callback.apply( this, response || [ jqXHR.responseText, status, jqXHR ] );
			} );
		} );
	}

	return this;
};




jQuery.expr.pseudos.animated = function( elem ) {
	return jQuery.grep( jQuery.timers, function( fn ) {
		return elem === fn.elem;
	} ).length;
};




jQuery.offset = {
	setOffset: function( elem, options, i ) {
		var curPosition, curLeft, curCSSTop, curTop, curOffset, curCSSLeft, calculatePosition,
			position = jQuery.css( elem, "position" ),
			curElem = jQuery( elem ),
			props = {};

		// Set position first, in-case top/left are set even on static elem
		if ( position === "static" ) {
			elem.style.position = "relative";
		}

		curOffset = curElem.offset();
		curCSSTop = jQuery.css( elem, "top" );
		curCSSLeft = jQuery.css( elem, "left" );
		calculatePosition = ( position === "absolute" || position === "fixed" ) &&
			( curCSSTop + curCSSLeft ).indexOf( "auto" ) > -1;

		// Need to be able to calculate position if either
		// top or left is auto and position is either absolute or fixed
		if ( calculatePosition ) {
			curPosition = curElem.position();
			curTop = curPosition.top;
			curLeft = curPosition.left;

		} else {
			curTop = parseFloat( curCSSTop ) || 0;
			curLeft = parseFloat( curCSSLeft ) || 0;
		}

		if ( isFunction( options ) ) {

			// Use jQuery.extend here to allow modification of coordinates argument (gh-1848)
			options = options.call( elem, i, jQuery.extend( {}, curOffset ) );
		}

		if ( options.top != null ) {
			props.top = ( options.top - curOffset.top ) + curTop;
		}
		if ( options.left != null ) {
			props.left = ( options.left - curOffset.left ) + curLeft;
		}

		if ( "using" in options ) {
			options.using.call( elem, props );

		} else {
			curElem.css( props );
		}
	}
};

jQuery.fn.extend( {

	// offset() relates an element's border box to the document origin
	offset: function( options ) {

		// Preserve chaining for setter
		if ( arguments.length ) {
			return options === undefined ?
				this :
				this.each( function( i ) {
					jQuery.offset.setOffset( this, options, i );
				} );
		}

		var rect, win,
			elem = this[ 0 ];

		if ( !elem ) {
			return;
		}

		// Return zeros for disconnected and hidden (display: none) elements (gh-2310)
		// Support: IE <=11 only
		// Running getBoundingClientRect on a
		// disconnected node in IE throws an error
		if ( !elem.getClientRects().length ) {
			return { top: 0, left: 0 };
		}

		// Get document-relative position by adding viewport scroll to viewport-relative gBCR
		rect = elem.getBoundingClientRect();
		win = elem.ownerDocument.defaultView;
		return {
			top: rect.top + win.pageYOffset,
			left: rect.left + win.pageXOffset
		};
	},

	// position() relates an element's margin box to its offset parent's padding box
	// This corresponds to the behavior of CSS absolute positioning
	position: function() {
		if ( !this[ 0 ] ) {
			return;
		}

		var offsetParent, offset, doc,
			elem = this[ 0 ],
			parentOffset = { top: 0, left: 0 };

		// position:fixed elements are offset from the viewport, which itself always has zero offset
		if ( jQuery.css( elem, "position" ) === "fixed" ) {

			// Assume position:fixed implies availability of getBoundingClientRect
			offset = elem.getBoundingClientRect();

		} else {
			offset = this.offset();

			// Account for the *real* offset parent, which can be the document or its root element
			// when a statically positioned element is identified
			doc = elem.ownerDocument;
			offsetParent = elem.offsetParent || doc.documentElement;
			while ( offsetParent &&
				( offsetParent === doc.body || offsetParent === doc.documentElement ) &&
				jQuery.css( offsetParent, "position" ) === "static" ) {

				offsetParent = offsetParent.parentNode;
			}
			if ( offsetParent && offsetParent !== elem && offsetParent.nodeType === 1 ) {

				// Incorporate borders into its offset, since they are outside its content origin
				parentOffset = jQuery( offsetParent ).offset();
				parentOffset.top += jQuery.css( offsetParent, "borderTopWidth", true );
				parentOffset.left += jQuery.css( offsetParent, "borderLeftWidth", true );
			}
		}

		// Subtract parent offsets and element margins
		return {
			top: offset.top - parentOffset.top - jQuery.css( elem, "marginTop", true ),
			left: offset.left - parentOffset.left - jQuery.css( elem, "marginLeft", true )
		};
	},

	// This method will return documentElement in the following cases:
	// 1) For the element inside the iframe without offsetParent, this method will return
	//    documentElement of the parent window
	// 2) For the hidden or detached element
	// 3) For body or html element, i.e. in case of the html node - it will return itself
	//
	// but those exceptions were never presented as a real life use-cases
	// and might be considered as more preferable results.
	//
	// This logic, however, is not guaranteed and can change at any point in the future
	offsetParent: function() {
		return this.map( function() {
			var offsetParent = this.offsetParent;

			while ( offsetParent && jQuery.css( offsetParent, "position" ) === "static" ) {
				offsetParent = offsetParent.offsetParent;
			}

			return offsetParent || documentElement;
		} );
	}
} );

// Create scrollLeft and scrollTop methods
jQuery.each( { scrollLeft: "pageXOffset", scrollTop: "pageYOffset" }, function( method, prop ) {
	var top = "pageYOffset" === prop;

	jQuery.fn[ method ] = function( val ) {
		return access( this, function( elem, method, val ) {

			// Coalesce documents and windows
			var win;
			if ( isWindow( elem ) ) {
				win = elem;
			} else if ( elem.nodeType === 9 ) {
				win = elem.defaultView;
			}

			if ( val === undefined ) {
				return win ? win[ prop ] : elem[ method ];
			}

			if ( win ) {
				win.scrollTo(
					!top ? val : win.pageXOffset,
					top ? val : win.pageYOffset
				);

			} else {
				elem[ method ] = val;
			}
		}, method, val, arguments.length );
	};
} );

// Support: Safari <=7 - 9.1, Chrome <=37 - 49
// Add the top/left cssHooks using jQuery.fn.position
// Webkit bug: https://bugs.webkit.org/show_bug.cgi?id=29084
// Blink bug: https://bugs.chromium.org/p/chromium/issues/detail?id=589347
// getComputedStyle returns percent when specified for top/left/bottom/right;
// rather than make the css module depend on the offset module, just check for it here
jQuery.each( [ "top", "left" ], function( _i, prop ) {
	jQuery.cssHooks[ prop ] = addGetHookIf( support.pixelPosition,
		function( elem, computed ) {
			if ( computed ) {
				computed = curCSS( elem, prop );

				// If curCSS returns percentage, fallback to offset
				return rnumnonpx.test( computed ) ?
					jQuery( elem ).position()[ prop ] + "px" :
					computed;
			}
		}
	);
} );


// Create innerHeight, innerWidth, height, width, outerHeight and outerWidth methods
jQuery.each( { Height: "height", Width: "width" }, function( name, type ) {
	jQuery.each( {
		padding: "inner" + name,
		content: type,
		"": "outer" + name
	}, function( defaultExtra, funcName ) {

		// Margin is only for outerHeight, outerWidth
		jQuery.fn[ funcName ] = function( margin, value ) {
			var chainable = arguments.length && ( defaultExtra || typeof margin !== "boolean" ),
				extra = defaultExtra || ( margin === true || value === true ? "margin" : "border" );

			return access( this, function( elem, type, value ) {
				var doc;

				if ( isWindow( elem ) ) {

					// $( window ).outerWidth/Height return w/h including scrollbars (gh-1729)
					return funcName.indexOf( "outer" ) === 0 ?
						elem[ "inner" + name ] :
						elem.document.documentElement[ "client" + name ];
				}

				// Get document width or height
				if ( elem.nodeType === 9 ) {
					doc = elem.documentElement;

					// Either scroll[Width/Height] or offset[Width/Height] or client[Width/Height],
					// whichever is greatest
					return Math.max(
						elem.body[ "scroll" + name ], doc[ "scroll" + name ],
						elem.body[ "offset" + name ], doc[ "offset" + name ],
						doc[ "client" + name ]
					);
				}

				return value === undefined ?

					// Get width or height on the element, requesting but not forcing parseFloat
					jQuery.css( elem, type, extra ) :

					// Set width or height on the element
					jQuery.style( elem, type, value, extra );
			}, type, chainable ? margin : undefined, chainable );
		};
	} );
} );


jQuery.each( [
	"ajaxStart",
	"ajaxStop",
	"ajaxComplete",
	"ajaxError",
	"ajaxSuccess",
	"ajaxSend"
], function( _i, type ) {
	jQuery.fn[ type ] = function( fn ) {
		return this.on( type, fn );
	};
} );




jQuery.fn.extend( {

	bind: function( types, data, fn ) {
		return this.on( types, null, data, fn );
	},
	unbind: function( types, fn ) {
		return this.off( types, null, fn );
	},

	delegate: function( selector, types, data, fn ) {
		return this.on( types, selector, data, fn );
	},
	undelegate: function( selector, types, fn ) {

		// ( namespace ) or ( selector, types [, fn] )
		return arguments.length === 1 ?
			this.off( selector, "**" ) :
			this.off( types, selector || "**", fn );
	},

	hover: function( fnOver, fnOut ) {
		return this
			.on( "mouseenter", fnOver )
			.on( "mouseleave", fnOut || fnOver );
	}
} );

jQuery.each(
	( "blur focus focusin focusout resize scroll click dblclick " +
	"mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave " +
	"change select submit keydown keypress keyup contextmenu" ).split( " " ),
	function( _i, name ) {

		// Handle event binding
		jQuery.fn[ name ] = function( data, fn ) {
			return arguments.length > 0 ?
				this.on( name, null, data, fn ) :
				this.trigger( name );
		};
	}
);




// Support: Android <=4.0 only
// Make sure we trim BOM and NBSP
// Require that the "whitespace run" starts from a non-whitespace
// to avoid O(N^2) behavior when the engine would try matching "\s+$" at each space position.
var rtrim = /^[\s\uFEFF\xA0]+|([^\s\uFEFF\xA0])[\s\uFEFF\xA0]+$/g;

// Bind a function to a context, optionally partially applying any
// arguments.
// jQuery.proxy is deprecated to promote standards (specifically Function#bind)
// However, it is not slated for removal any time soon
jQuery.proxy = function( fn, context ) {
	var tmp, args, proxy;

	if ( typeof context === "string" ) {
		tmp = fn[ context ];
		context = fn;
		fn = tmp;
	}

	// Quick check to determine if target is callable, in the spec
	// this throws a TypeError, but we will just return undefined.
	if ( !isFunction( fn ) ) {
		return undefined;
	}

	// Simulated bind
	args = slice.call( arguments, 2 );
	proxy = function() {
		return fn.apply( context || this, args.concat( slice.call( arguments ) ) );
	};

	// Set the guid of unique handler to the same of original handler, so it can be removed
	proxy.guid = fn.guid = fn.guid || jQuery.guid++;

	return proxy;
};

jQuery.holdReady = function( hold ) {
	if ( hold ) {
		jQuery.readyWait++;
	} else {
		jQuery.ready( true );
	}
};
jQuery.isArray = Array.isArray;
jQuery.parseJSON = JSON.parse;
jQuery.nodeName = nodeName;
jQuery.isFunction = isFunction;
jQuery.isWindow = isWindow;
jQuery.camelCase = camelCase;
jQuery.type = toType;

jQuery.now = Date.now;

jQuery.isNumeric = function( obj ) {

	// As of jQuery 3.0, isNumeric is limited to
	// strings and numbers (primitives or objects)
	// that can be coerced to finite numbers (gh-2662)
	var type = jQuery.type( obj );
	return ( type === "number" || type === "string" ) &&

		// parseFloat NaNs numeric-cast false positives ("")
		// ...but misinterprets leading-number strings, particularly hex literals ("0x...")
		// subtraction forces infinities to NaN
		!isNaN( obj - parseFloat( obj ) );
};

jQuery.trim = function( text ) {
	return text == null ?
		"" :
		( text + "" ).replace( rtrim, "$1" );
};



// Register as a named AMD module, since jQuery can be concatenated with other
// files that may use define, but not via a proper concatenation script that
// understands anonymous AMD modules. A named AMD is safest and most robust
// way to register. Lowercase jquery is used because AMD module names are
// derived from file names, and jQuery is normally delivered in a lowercase
// file name. Do this after creating the global so that if an AMD module wants
// to call noConflict to hide this version of jQuery, it will work.

// Note that for maximum portability, libraries that are not jQuery should
// declare themselves as anonymous modules, and avoid setting a global if an
// AMD loader is present. jQuery is a special case. For more information, see
// https://github.com/jrburke/requirejs/wiki/Updating-existing-libraries#wiki-anon

if ( typeof define === "function" && define.amd ) {
	define( "jquery", [], function() {
		return jQuery;
	} );
}




var

	// Map over jQuery in case of overwrite
	_jQuery = window.jQuery,

	// Map over the $ in case of overwrite
	_$ = window.$;

jQuery.noConflict = function( deep ) {
	if ( window.$ === jQuery ) {
		window.$ = _$;
	}

	if ( deep && window.jQuery === jQuery ) {
		window.jQuery = _jQuery;
	}

	return jQuery;
};

// Expose jQuery and $ identifiers, even in AMD
// (trac-7102#comment:10, https://github.com/jquery/jquery/pull/557)
// and CommonJS for browser emulators (trac-13566)
if ( typeof noGlobal === "undefined" ) {
	window.jQuery = window.$ = jQuery;
}




return jQuery;
} );



========== staticfiles/admin/js/vendor/jquery/jquery.min.js ==========
/*! jQuery v3.7.1 | (c) OpenJS Foundation and other contributors | jquery.org/license */
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(ie,e){"use strict";var oe=[],r=Object.getPrototypeOf,ae=oe.slice,g=oe.flat?function(e){return oe.flat.call(e)}:function(e){return oe.concat.apply([],e)},s=oe.push,se=oe.indexOf,n={},i=n.toString,ue=n.hasOwnProperty,o=ue.toString,a=o.call(Object),le={},v=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType&&"function"!=typeof e.item},y=function(e){return null!=e&&e===e.window},C=ie.document,u={type:!0,src:!0,nonce:!0,noModule:!0};function m(e,t,n){var r,i,o=(n=n||C).createElement("script");if(o.text=e,t)for(r in u)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function x(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[i.call(e)]||"object":typeof e}var t="3.7.1",l=/HTML$/i,ce=function(e,t){return new ce.fn.init(e,t)};function c(e){var t=!!e&&"length"in e&&e.length,n=x(e);return!v(e)&&!y(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}function fe(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}ce.fn=ce.prototype={jquery:t,constructor:ce,length:0,toArray:function(){return ae.call(this)},get:function(e){return null==e?ae.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=ce.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return ce.each(this,e)},map:function(n){return this.pushStack(ce.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(ae.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(ce.grep(this,function(e,t){return(t+1)%2}))},odd:function(){return this.pushStack(ce.grep(this,function(e,t){return t%2}))},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:s,sort:oe.sort,splice:oe.splice},ce.extend=ce.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||v(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(l&&r&&(ce.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||ce.isPlainObject(n)?n:{},i=!1,a[t]=ce.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},ce.extend({expando:"jQuery"+(t+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==i.call(e))&&(!(t=r(e))||"function"==typeof(n=ue.call(t,"constructor")&&t.constructor)&&o.call(n)===a)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t,n){m(e,{nonce:t&&t.nonce},n)},each:function(e,t){var n,r=0;if(c(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},text:function(e){var t,n="",r=0,i=e.nodeType;if(!i)while(t=e[r++])n+=ce.text(t);return 1===i||11===i?e.textContent:9===i?e.documentElement.textContent:3===i||4===i?e.nodeValue:n},makeArray:function(e,t){var n=t||[];return null!=e&&(c(Object(e))?ce.merge(n,"string"==typeof e?[e]:e):s.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:se.call(t,e,n)},isXMLDoc:function(e){var t=e&&e.namespaceURI,n=e&&(e.ownerDocument||e).documentElement;return!l.test(t||n&&n.nodeName||"HTML")},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(c(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return g(a)},guid:1,support:le}),"function"==typeof Symbol&&(ce.fn[Symbol.iterator]=oe[Symbol.iterator]),ce.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var pe=oe.pop,de=oe.sort,he=oe.splice,ge="[\\x20\\t\\r\\n\\f]",ve=new RegExp("^"+ge+"+|((?:^|[^\\\\])(?:\\\\.)*)"+ge+"+$","g");ce.contains=function(e,t){var n=t&&t.parentNode;return e===n||!(!n||1!==n.nodeType||!(e.contains?e.contains(n):e.compareDocumentPosition&&16&e.compareDocumentPosition(n)))};var f=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g;function p(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e}ce.escapeSelector=function(e){return(e+"").replace(f,p)};var ye=C,me=s;!function(){var e,b,w,o,a,T,r,C,d,i,k=me,S=ce.expando,E=0,n=0,s=W(),c=W(),u=W(),h=W(),l=function(e,t){return e===t&&(a=!0),0},f="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",t="(?:\\\\[\\da-fA-F]{1,6}"+ge+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",p="\\["+ge+"*("+t+")(?:"+ge+"*([*^$|!~]?=)"+ge+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+t+"))|)"+ge+"*\\]",g=":("+t+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+p+")*)|.*)\\)|)",v=new RegExp(ge+"+","g"),y=new RegExp("^"+ge+"*,"+ge+"*"),m=new RegExp("^"+ge+"*([>+~]|"+ge+")"+ge+"*"),x=new RegExp(ge+"|>"),j=new RegExp(g),A=new RegExp("^"+t+"$"),D={ID:new RegExp("^#("+t+")"),CLASS:new RegExp("^\\.("+t+")"),TAG:new RegExp("^("+t+"|[*])"),ATTR:new RegExp("^"+p),PSEUDO:new RegExp("^"+g),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+ge+"*(even|odd|(([+-]|)(\\d*)n|)"+ge+"*(?:([+-]|)"+ge+"*(\\d+)|))"+ge+"*\\)|)","i"),bool:new RegExp("^(?:"+f+")$","i"),needsContext:new RegExp("^"+ge+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+ge+"*((?:-\\d)?\\d*)"+ge+"*\\)|)(?=[^-]|$)","i")},N=/^(?:input|select|textarea|button)$/i,q=/^h\d$/i,L=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,H=/[+~]/,O=new RegExp("\\\\[\\da-fA-F]{1,6}"+ge+"?|\\\\([^\\r\\n\\f])","g"),P=function(e,t){var n="0x"+e.slice(1)-65536;return t||(n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320))},M=function(){V()},R=J(function(e){return!0===e.disabled&&fe(e,"fieldset")},{dir:"parentNode",next:"legend"});try{k.apply(oe=ae.call(ye.childNodes),ye.childNodes),oe[ye.childNodes.length].nodeType}catch(e){k={apply:function(e,t){me.apply(e,ae.call(t))},call:function(e){me.apply(e,ae.call(arguments,1))}}}function I(t,e,n,r){var i,o,a,s,u,l,c,f=e&&e.ownerDocument,p=e?e.nodeType:9;if(n=n||[],"string"!=typeof t||!t||1!==p&&9!==p&&11!==p)return n;if(!r&&(V(e),e=e||T,C)){if(11!==p&&(u=L.exec(t)))if(i=u[1]){if(9===p){if(!(a=e.getElementById(i)))return n;if(a.id===i)return k.call(n,a),n}else if(f&&(a=f.getElementById(i))&&I.contains(e,a)&&a.id===i)return k.call(n,a),n}else{if(u[2])return k.apply(n,e.getElementsByTagName(t)),n;if((i=u[3])&&e.getElementsByClassName)return k.apply(n,e.getElementsByClassName(i)),n}if(!(h[t+" "]||d&&d.test(t))){if(c=t,f=e,1===p&&(x.test(t)||m.test(t))){(f=H.test(t)&&U(e.parentNode)||e)==e&&le.scope||((s=e.getAttribute("id"))?s=ce.escapeSelector(s):e.setAttribute("id",s=S)),o=(l=Y(t)).length;while(o--)l[o]=(s?"#"+s:":scope")+" "+Q(l[o]);c=l.join(",")}try{return k.apply(n,f.querySelectorAll(c)),n}catch(e){h(t,!0)}finally{s===S&&e.removeAttribute("id")}}}return re(t.replace(ve,"$1"),e,n,r)}function W(){var r=[];return function e(t,n){return r.push(t+" ")>b.cacheLength&&delete e[r.shift()],e[t+" "]=n}}function F(e){return e[S]=!0,e}function $(e){var t=T.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function B(t){return function(e){return fe(e,"input")&&e.type===t}}function _(t){return function(e){return(fe(e,"input")||fe(e,"button"))&&e.type===t}}function z(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&R(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function X(a){return F(function(o){return o=+o,F(function(e,t){var n,r=a([],e.length,o),i=r.length;while(i--)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function U(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}function V(e){var t,n=e?e.ownerDocument||e:ye;return n!=T&&9===n.nodeType&&n.documentElement&&(r=(T=n).documentElement,C=!ce.isXMLDoc(T),i=r.matches||r.webkitMatchesSelector||r.msMatchesSelector,r.msMatchesSelector&&ye!=T&&(t=T.defaultView)&&t.top!==t&&t.addEventListener("unload",M),le.getById=$(function(e){return r.appendChild(e).id=ce.expando,!T.getElementsByName||!T.getElementsByName(ce.expando).length}),le.disconnectedMatch=$(function(e){return i.call(e,"*")}),le.scope=$(function(){return T.querySelectorAll(":scope")}),le.cssHas=$(function(){try{return T.querySelector(":has(*,:jqfake)"),!1}catch(e){return!0}}),le.getById?(b.filter.ID=function(e){var t=e.replace(O,P);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&C){var n=t.getElementById(e);return n?[n]:[]}}):(b.filter.ID=function(e){var n=e.replace(O,P);return function(e){var t="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&C){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];i=t.getElementsByName(e),r=0;while(o=i[r++])if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),b.find.TAG=function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):t.querySelectorAll(e)},b.find.CLASS=function(e,t){if("undefined"!=typeof t.getElementsByClassName&&C)return t.getElementsByClassName(e)},d=[],$(function(e){var t;r.appendChild(e).innerHTML="<a id='"+S+"' href='' disabled='disabled'></a><select id='"+S+"-\r\\' disabled='disabled'><option selected=''></option></select>",e.querySelectorAll("[selected]").length||d.push("\\["+ge+"*(?:value|"+f+")"),e.querySelectorAll("[id~="+S+"-]").length||d.push("~="),e.querySelectorAll("a#"+S+"+*").length||d.push(".#.+[+~]"),e.querySelectorAll(":checked").length||d.push(":checked"),(t=T.createElement("input")).setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),r.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&d.push(":enabled",":disabled"),(t=T.createElement("input")).setAttribute("name",""),e.appendChild(t),e.querySelectorAll("[name='']").length||d.push("\\["+ge+"*name"+ge+"*="+ge+"*(?:''|\"\")")}),le.cssHas||d.push(":has"),d=d.length&&new RegExp(d.join("|")),l=function(e,t){if(e===t)return a=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)==(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!le.sortDetached&&t.compareDocumentPosition(e)===n?e===T||e.ownerDocument==ye&&I.contains(ye,e)?-1:t===T||t.ownerDocument==ye&&I.contains(ye,t)?1:o?se.call(o,e)-se.call(o,t):0:4&n?-1:1)}),T}for(e in I.matches=function(e,t){return I(e,null,null,t)},I.matchesSelector=function(e,t){if(V(e),C&&!h[t+" "]&&(!d||!d.test(t)))try{var n=i.call(e,t);if(n||le.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){h(t,!0)}return 0<I(t,T,null,[e]).length},I.contains=function(e,t){return(e.ownerDocument||e)!=T&&V(e),ce.contains(e,t)},I.attr=function(e,t){(e.ownerDocument||e)!=T&&V(e);var n=b.attrHandle[t.toLowerCase()],r=n&&ue.call(b.attrHandle,t.toLowerCase())?n(e,t,!C):void 0;return void 0!==r?r:e.getAttribute(t)},I.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},ce.uniqueSort=function(e){var t,n=[],r=0,i=0;if(a=!le.sortStable,o=!le.sortStable&&ae.call(e,0),de.call(e,l),a){while(t=e[i++])t===e[i]&&(r=n.push(i));while(r--)he.call(e,n[r],1)}return o=null,e},ce.fn.uniqueSort=function(){return this.pushStack(ce.uniqueSort(ae.apply(this)))},(b=ce.expr={cacheLength:50,createPseudo:F,match:D,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(O,P),e[3]=(e[3]||e[4]||e[5]||"").replace(O,P),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||I.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&I.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return D.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&j.test(n)&&(t=Y(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(O,P).toLowerCase();return"*"===e?function(){return!0}:function(e){return fe(e,t)}},CLASS:function(e){var t=s[e+" "];return t||(t=new RegExp("(^|"+ge+")"+e+"("+ge+"|$)"))&&s(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=I.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace(v," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(d,e,t,h,g){var v="nth"!==d.slice(0,3),y="last"!==d.slice(-4),m="of-type"===e;return 1===h&&0===g?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u=v!==y?"nextSibling":"previousSibling",l=e.parentNode,c=m&&e.nodeName.toLowerCase(),f=!n&&!m,p=!1;if(l){if(v){while(u){o=e;while(o=o[u])if(m?fe(o,c):1===o.nodeType)return!1;s=u="only"===d&&!s&&"nextSibling"}return!0}if(s=[y?l.firstChild:l.lastChild],y&&f){p=(a=(r=(i=l[S]||(l[S]={}))[d]||[])[0]===E&&r[1])&&r[2],o=a&&l.childNodes[a];while(o=++a&&o&&o[u]||(p=a=0)||s.pop())if(1===o.nodeType&&++p&&o===e){i[d]=[E,a,p];break}}else if(f&&(p=a=(r=(i=e[S]||(e[S]={}))[d]||[])[0]===E&&r[1]),!1===p)while(o=++a&&o&&o[u]||(p=a=0)||s.pop())if((m?fe(o,c):1===o.nodeType)&&++p&&(f&&((i=o[S]||(o[S]={}))[d]=[E,p]),o===e))break;return(p-=g)===h||p%h==0&&0<=p/h}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||I.error("unsupported pseudo: "+e);return a[S]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?F(function(e,t){var n,r=a(e,o),i=r.length;while(i--)e[n=se.call(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:F(function(e){var r=[],i=[],s=ne(e.replace(ve,"$1"));return s[S]?F(function(e,t,n,r){var i,o=s(e,null,r,[]),a=e.length;while(a--)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:F(function(t){return function(e){return 0<I(t,e).length}}),contains:F(function(t){return t=t.replace(O,P),function(e){return-1<(e.textContent||ce.text(e)).indexOf(t)}}),lang:F(function(n){return A.test(n||"")||I.error("unsupported lang: "+n),n=n.replace(O,P).toLowerCase(),function(e){var t;do{if(t=C?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=ie.location&&ie.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===r},focus:function(e){return e===function(){try{return T.activeElement}catch(e){}}()&&T.hasFocus()&&!!(e.type||e.href||~e.tabIndex)},enabled:z(!1),disabled:z(!0),checked:function(e){return fe(e,"input")&&!!e.checked||fe(e,"option")&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return q.test(e.nodeName)},input:function(e){return N.test(e.nodeName)},button:function(e){return fe(e,"input")&&"button"===e.type||fe(e,"button")},text:function(e){var t;return fe(e,"input")&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:X(function(){return[0]}),last:X(function(e,t){return[t-1]}),eq:X(function(e,t,n){return[n<0?n+t:n]}),even:X(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:X(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:X(function(e,t,n){var r;for(r=n<0?n+t:t<n?t:n;0<=--r;)e.push(r);return e}),gt:X(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=B(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=_(e);function G(){}function Y(e,t){var n,r,i,o,a,s,u,l=c[e+" "];if(l)return t?0:l.slice(0);a=e,s=[],u=b.preFilter;while(a){for(o in n&&!(r=y.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=m.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace(ve," ")}),a=a.slice(n.length)),b.filter)!(r=D[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?I.error(e):c(e,s).slice(0)}function Q(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function J(a,e,t){var s=e.dir,u=e.next,l=u||s,c=t&&"parentNode"===l,f=n++;return e.first?function(e,t,n){while(e=e[s])if(1===e.nodeType||c)return a(e,t,n);return!1}:function(e,t,n){var r,i,o=[E,f];if(n){while(e=e[s])if((1===e.nodeType||c)&&a(e,t,n))return!0}else while(e=e[s])if(1===e.nodeType||c)if(i=e[S]||(e[S]={}),u&&fe(e,u))e=e[s]||e;else{if((r=i[l])&&r[0]===E&&r[1]===f)return o[2]=r[2];if((i[l]=o)[2]=a(e,t,n))return!0}return!1}}function K(i){return 1<i.length?function(e,t,n){var r=i.length;while(r--)if(!i[r](e,t,n))return!1;return!0}:i[0]}function Z(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function ee(d,h,g,v,y,e){return v&&!v[S]&&(v=ee(v)),y&&!y[S]&&(y=ee(y,e)),F(function(e,t,n,r){var i,o,a,s,u=[],l=[],c=t.length,f=e||function(e,t,n){for(var r=0,i=t.length;r<i;r++)I(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),p=!d||!e&&h?f:Z(f,u,d,n,r);if(g?g(p,s=y||(e?d:c||v)?[]:t,n,r):s=p,v){i=Z(s,l),v(i,[],n,r),o=i.length;while(o--)(a=i[o])&&(s[l[o]]=!(p[l[o]]=a))}if(e){if(y||d){if(y){i=[],o=s.length;while(o--)(a=s[o])&&i.push(p[o]=a);y(null,s=[],i,r)}o=s.length;while(o--)(a=s[o])&&-1<(i=y?se.call(e,a):u[o])&&(e[i]=!(t[i]=a))}}else s=Z(s===t?s.splice(c,s.length):s),y?y(null,t,s,r):k.apply(t,s)})}function te(e){for(var i,t,n,r=e.length,o=b.relative[e[0].type],a=o||b.relative[" "],s=o?1:0,u=J(function(e){return e===i},a,!0),l=J(function(e){return-1<se.call(i,e)},a,!0),c=[function(e,t,n){var r=!o&&(n||t!=w)||((i=t).nodeType?u(e,t,n):l(e,t,n));return i=null,r}];s<r;s++)if(t=b.relative[e[s].type])c=[J(K(c),t)];else{if((t=b.filter[e[s].type].apply(null,e[s].matches))[S]){for(n=++s;n<r;n++)if(b.relative[e[n].type])break;return ee(1<s&&K(c),1<s&&Q(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(ve,"$1"),t,s<n&&te(e.slice(s,n)),n<r&&te(e=e.slice(n)),n<r&&Q(e))}c.push(t)}return K(c)}function ne(e,t){var n,v,y,m,x,r,i=[],o=[],a=u[e+" "];if(!a){t||(t=Y(e)),n=t.length;while(n--)(a=te(t[n]))[S]?i.push(a):o.push(a);(a=u(e,(v=o,m=0<(y=i).length,x=0<v.length,r=function(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],p=w,d=e||x&&b.find.TAG("*",i),h=E+=null==p?1:Math.random()||.1,g=d.length;for(i&&(w=t==T||t||i);l!==g&&null!=(o=d[l]);l++){if(x&&o){a=0,t||o.ownerDocument==T||(V(o),n=!C);while(s=v[a++])if(s(o,t||T,n)){k.call(r,o);break}i&&(E=h)}m&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,m&&l!==u){a=0;while(s=y[a++])s(c,f,t,n);if(e){if(0<u)while(l--)c[l]||f[l]||(f[l]=pe.call(r));f=Z(f)}k.apply(r,f),i&&!e&&0<f.length&&1<u+y.length&&ce.uniqueSort(r)}return i&&(E=h,w=p),c},m?F(r):r))).selector=e}return a}function re(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&Y(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&C&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(O,P),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}i=D.needsContext.test(e)?0:o.length;while(i--){if(a=o[i],b.relative[s=a.type])break;if((u=b.find[s])&&(r=u(a.matches[0].replace(O,P),H.test(o[0].type)&&U(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&Q(o)))return k.apply(n,r),n;break}}}return(l||ne(e,c))(r,t,!C,n,!t||H.test(e)&&U(t.parentNode)||t),n}G.prototype=b.filters=b.pseudos,b.setFilters=new G,le.sortStable=S.split("").sort(l).join("")===S,V(),le.sortDetached=$(function(e){return 1&e.compareDocumentPosition(T.createElement("fieldset"))}),ce.find=I,ce.expr[":"]=ce.expr.pseudos,ce.unique=ce.uniqueSort,I.compile=ne,I.select=re,I.setDocument=V,I.tokenize=Y,I.escape=ce.escapeSelector,I.getText=ce.text,I.isXML=ce.isXMLDoc,I.selectors=ce.expr,I.support=ce.support,I.uniqueSort=ce.uniqueSort}();var d=function(e,t,n){var r=[],i=void 0!==n;while((e=e[t])&&9!==e.nodeType)if(1===e.nodeType){if(i&&ce(e).is(n))break;r.push(e)}return r},h=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},b=ce.expr.match.needsContext,w=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function T(e,n,r){return v(n)?ce.grep(e,function(e,t){return!!n.call(e,t,e)!==r}):n.nodeType?ce.grep(e,function(e){return e===n!==r}):"string"!=typeof n?ce.grep(e,function(e){return-1<se.call(n,e)!==r}):ce.filter(n,e,r)}ce.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?ce.find.matchesSelector(r,e)?[r]:[]:ce.find.matches(e,ce.grep(t,function(e){return 1===e.nodeType}))},ce.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(ce(e).filter(function(){for(t=0;t<r;t++)if(ce.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)ce.find(e,i[t],n);return 1<r?ce.uniqueSort(n):n},filter:function(e){return this.pushStack(T(this,e||[],!1))},not:function(e){return this.pushStack(T(this,e||[],!0))},is:function(e){return!!T(this,"string"==typeof e&&b.test(e)?ce(e):e||[],!1).length}});var k,S=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(ce.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||k,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:S.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof ce?t[0]:t,ce.merge(this,ce.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:C,!0)),w.test(r[1])&&ce.isPlainObject(t))for(r in t)v(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=C.getElementById(r[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):v(e)?void 0!==n.ready?n.ready(e):e(ce):ce.makeArray(e,this)}).prototype=ce.fn,k=ce(C);var E=/^(?:parents|prev(?:Until|All))/,j={children:!0,contents:!0,next:!0,prev:!0};function A(e,t){while((e=e[t])&&1!==e.nodeType);return e}ce.fn.extend({has:function(e){var t=ce(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(ce.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&ce(e);if(!b.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&ce.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?ce.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?se.call(ce(e),this[0]):se.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(ce.uniqueSort(ce.merge(this.get(),ce(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),ce.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return d(e,"parentNode")},parentsUntil:function(e,t,n){return d(e,"parentNode",n)},next:function(e){return A(e,"nextSibling")},prev:function(e){return A(e,"previousSibling")},nextAll:function(e){return d(e,"nextSibling")},prevAll:function(e){return d(e,"previousSibling")},nextUntil:function(e,t,n){return d(e,"nextSibling",n)},prevUntil:function(e,t,n){return d(e,"previousSibling",n)},siblings:function(e){return h((e.parentNode||{}).firstChild,e)},children:function(e){return h(e.firstChild)},contents:function(e){return null!=e.contentDocument&&r(e.contentDocument)?e.contentDocument:(fe(e,"template")&&(e=e.content||e),ce.merge([],e.childNodes))}},function(r,i){ce.fn[r]=function(e,t){var n=ce.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=ce.filter(t,n)),1<this.length&&(j[r]||ce.uniqueSort(n),E.test(r)&&n.reverse()),this.pushStack(n)}});var D=/[^\x20\t\r\n\f]+/g;function N(e){return e}function q(e){throw e}function L(e,t,n,r){var i;try{e&&v(i=e.promise)?i.call(e).done(t).fail(n):e&&v(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}ce.Callbacks=function(r){var e,n;r="string"==typeof r?(e=r,n={},ce.each(e.match(D)||[],function(e,t){n[t]=!0}),n):ce.extend({},r);var i,t,o,a,s=[],u=[],l=-1,c=function(){for(a=a||r.once,o=i=!0;u.length;l=-1){t=u.shift();while(++l<s.length)!1===s[l].apply(t[0],t[1])&&r.stopOnFalse&&(l=s.length,t=!1)}r.memory||(t=!1),i=!1,a&&(s=t?[]:"")},f={add:function(){return s&&(t&&!i&&(l=s.length-1,u.push(t)),function n(e){ce.each(e,function(e,t){v(t)?r.unique&&f.has(t)||s.push(t):t&&t.length&&"string"!==x(t)&&n(t)})}(arguments),t&&!i&&c()),this},remove:function(){return ce.each(arguments,function(e,t){var n;while(-1<(n=ce.inArray(t,s,n)))s.splice(n,1),n<=l&&l--}),this},has:function(e){return e?-1<ce.inArray(e,s):0<s.length},empty:function(){return s&&(s=[]),this},disable:function(){return a=u=[],s=t="",this},disabled:function(){return!s},lock:function(){return a=u=[],t||i||(s=t=""),this},locked:function(){return!!a},fireWith:function(e,t){return a||(t=[e,(t=t||[]).slice?t.slice():t],u.push(t),i||c()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!o}};return f},ce.extend({Deferred:function(e){var o=[["notify","progress",ce.Callbacks("memory"),ce.Callbacks("memory"),2],["resolve","done",ce.Callbacks("once memory"),ce.Callbacks("once memory"),0,"resolved"],["reject","fail",ce.Callbacks("once memory"),ce.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},"catch":function(e){return a.then(null,e)},pipe:function(){var i=arguments;return ce.Deferred(function(r){ce.each(o,function(e,t){var n=v(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&v(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function l(i,o,a,s){return function(){var n=this,r=arguments,e=function(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,v(t)?s?t.call(e,l(u,o,N,s),l(u,o,q,s)):(u++,t.call(e,l(u,o,N,s),l(u,o,q,s),l(u,o,N,o.notifyWith))):(a!==N&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}},t=s?e:function(){try{e()}catch(e){ce.Deferred.exceptionHook&&ce.Deferred.exceptionHook(e,t.error),u<=i+1&&(a!==q&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(ce.Deferred.getErrorHook?t.error=ce.Deferred.getErrorHook():ce.Deferred.getStackHook&&(t.error=ce.Deferred.getStackHook()),ie.setTimeout(t))}}return ce.Deferred(function(e){o[0][3].add(l(0,e,v(r)?r:N,e.notifyWith)),o[1][3].add(l(0,e,v(t)?t:N)),o[2][3].add(l(0,e,v(n)?n:q))}).promise()},promise:function(e){return null!=e?ce.extend(e,a):a}},s={};return ce.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[3-e][3].disable,o[0][2].lock,o[0][3].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var n=arguments.length,t=n,r=Array(t),i=ae.call(arguments),o=ce.Deferred(),a=function(t){return function(e){r[t]=this,i[t]=1<arguments.length?ae.call(arguments):e,--n||o.resolveWith(r,i)}};if(n<=1&&(L(e,o.done(a(t)).resolve,o.reject,!n),"pending"===o.state()||v(i[t]&&i[t].then)))return o.then();while(t--)L(i[t],a(t),o.reject);return o.promise()}});var H=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;ce.Deferred.exceptionHook=function(e,t){ie.console&&ie.console.warn&&e&&H.test(e.name)&&ie.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},ce.readyException=function(e){ie.setTimeout(function(){throw e})};var O=ce.Deferred();function P(){C.removeEventListener("DOMContentLoaded",P),ie.removeEventListener("load",P),ce.ready()}ce.fn.ready=function(e){return O.then(e)["catch"](function(e){ce.readyException(e)}),this},ce.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--ce.readyWait:ce.isReady)||(ce.isReady=!0)!==e&&0<--ce.readyWait||O.resolveWith(C,[ce])}}),ce.ready.then=O.then,"complete"===C.readyState||"loading"!==C.readyState&&!C.documentElement.doScroll?ie.setTimeout(ce.ready):(C.addEventListener("DOMContentLoaded",P),ie.addEventListener("load",P));var M=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===x(n))for(s in i=!0,n)M(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,v(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(ce(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},R=/^-ms-/,I=/-([a-z])/g;function W(e,t){return t.toUpperCase()}function F(e){return e.replace(R,"ms-").replace(I,W)}var $=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function B(){this.expando=ce.expando+B.uid++}B.uid=1,B.prototype={cache:function(e){var t=e[this.expando];return t||(t={},$(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[F(t)]=n;else for(r in t)i[F(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][F(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(F):(t=F(t))in r?[t]:t.match(D)||[]).length;while(n--)delete r[t[n]]}(void 0===t||ce.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!ce.isEmptyObject(t)}};var _=new B,z=new B,X=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,U=/[A-Z]/g;function V(e,t,n){var r,i;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(U,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===(i=n)||"false"!==i&&("null"===i?null:i===+i+""?+i:X.test(i)?JSON.parse(i):i)}catch(e){}z.set(e,t,n)}else n=void 0;return n}ce.extend({hasData:function(e){return z.hasData(e)||_.hasData(e)},data:function(e,t,n){return z.access(e,t,n)},removeData:function(e,t){z.remove(e,t)},_data:function(e,t,n){return _.access(e,t,n)},_removeData:function(e,t){_.remove(e,t)}}),ce.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0===n){if(this.length&&(i=z.get(o),1===o.nodeType&&!_.get(o,"hasDataAttrs"))){t=a.length;while(t--)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=F(r.slice(5)),V(o,r,i[r]));_.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof n?this.each(function(){z.set(this,n)}):M(this,function(e){var t;if(o&&void 0===e)return void 0!==(t=z.get(o,n))?t:void 0!==(t=V(o,n))?t:void 0;this.each(function(){z.set(this,n,e)})},null,e,1<arguments.length,null,!0)},removeData:function(e){return this.each(function(){z.remove(this,e)})}}),ce.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=_.get(e,t),n&&(!r||Array.isArray(n)?r=_.access(e,t,ce.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=ce.queue(e,t),r=n.length,i=n.shift(),o=ce._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){ce.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return _.get(e,n)||_.access(e,n,{empty:ce.Callbacks("once memory").add(function(){_.remove(e,[t+"queue",n])})})}}),ce.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?ce.queue(this[0],t):void 0===n?this:this.each(function(){var e=ce.queue(this,t,n);ce._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&ce.dequeue(this,t)})},dequeue:function(e){return this.each(function(){ce.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=ce.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};"string"!=typeof e&&(t=e,e=void 0),e=e||"fx";while(a--)(n=_.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var G=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Y=new RegExp("^(?:([+-])=|)("+G+")([a-z%]*)$","i"),Q=["Top","Right","Bottom","Left"],J=C.documentElement,K=function(e){return ce.contains(e.ownerDocument,e)},Z={composed:!0};J.getRootNode&&(K=function(e){return ce.contains(e.ownerDocument,e)||e.getRootNode(Z)===e.ownerDocument});var ee=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&K(e)&&"none"===ce.css(e,"display")};function te(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return ce.css(e,t,"")},u=s(),l=n&&n[3]||(ce.cssNumber[t]?"":"px"),c=e.nodeType&&(ce.cssNumber[t]||"px"!==l&&+u)&&Y.exec(ce.css(e,t));if(c&&c[3]!==l){u/=2,l=l||c[3],c=+u||1;while(a--)ce.style(e,t,c+l),(1-o)*(1-(o=s()/u||.5))<=0&&(a=0),c/=o;c*=2,ce.style(e,t,c+l),n=n||[]}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var ne={};function re(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=_.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&ee(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=ne[s])||(o=a.body.appendChild(a.createElement(s)),u=ce.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),ne[s]=u)))):"none"!==n&&(l[c]="none",_.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}ce.fn.extend({show:function(){return re(this,!0)},hide:function(){return re(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){ee(this)?ce(this).show():ce(this).hide()})}});var xe,be,we=/^(?:checkbox|radio)$/i,Te=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,Ce=/^$|^module$|\/(?:java|ecma)script/i;xe=C.createDocumentFragment().appendChild(C.createElement("div")),(be=C.createElement("input")).setAttribute("type","radio"),be.setAttribute("checked","checked"),be.setAttribute("name","t"),xe.appendChild(be),le.checkClone=xe.cloneNode(!0).cloneNode(!0).lastChild.checked,xe.innerHTML="<textarea>x</textarea>",le.noCloneChecked=!!xe.cloneNode(!0).lastChild.defaultValue,xe.innerHTML="<option></option>",le.option=!!xe.lastChild;var ke={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function Se(e,t){var n;return n="undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t||"*"):"undefined"!=typeof e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&fe(e,t)?ce.merge([e],n):n}function Ee(e,t){for(var n=0,r=e.length;n<r;n++)_.set(e[n],"globalEval",!t||_.get(t[n],"globalEval"))}ke.tbody=ke.tfoot=ke.colgroup=ke.caption=ke.thead,ke.th=ke.td,le.option||(ke.optgroup=ke.option=[1,"<select multiple='multiple'>","</select>"]);var je=/<|&#?\w+;/;function Ae(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),p=[],d=0,h=e.length;d<h;d++)if((o=e[d])||0===o)if("object"===x(o))ce.merge(p,o.nodeType?[o]:o);else if(je.test(o)){a=a||f.appendChild(t.createElement("div")),s=(Te.exec(o)||["",""])[1].toLowerCase(),u=ke[s]||ke._default,a.innerHTML=u[1]+ce.htmlPrefilter(o)+u[2],c=u[0];while(c--)a=a.lastChild;ce.merge(p,a.childNodes),(a=f.firstChild).textContent=""}else p.push(t.createTextNode(o));f.textContent="",d=0;while(o=p[d++])if(r&&-1<ce.inArray(o,r))i&&i.push(o);else if(l=K(o),a=Se(f.appendChild(o),"script"),l&&Ee(a),n){c=0;while(o=a[c++])Ce.test(o.type||"")&&n.push(o)}return f}var De=/^([^.]*)(?:\.(.+)|)/;function Ne(){return!0}function qe(){return!1}function Le(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Le(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=qe;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return ce().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=ce.guid++)),e.each(function(){ce.event.add(this,t,i,r,n)})}function He(e,r,t){t?(_.set(e,r,!1),ce.event.add(e,r,{namespace:!1,handler:function(e){var t,n=_.get(this,r);if(1&e.isTrigger&&this[r]){if(n)(ce.event.special[r]||{}).delegateType&&e.stopPropagation();else if(n=ae.call(arguments),_.set(this,r,n),this[r](),t=_.get(this,r),_.set(this,r,!1),n!==t)return e.stopImmediatePropagation(),e.preventDefault(),t}else n&&(_.set(this,r,ce.event.trigger(n[0],n.slice(1),this)),e.stopPropagation(),e.isImmediatePropagationStopped=Ne)}})):void 0===_.get(e,r)&&ce.event.add(e,r,Ne)}ce.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=_.get(t);if($(t)){n.handler&&(n=(o=n).handler,i=o.selector),i&&ce.find.matchesSelector(J,i),n.guid||(n.guid=ce.guid++),(u=v.events)||(u=v.events=Object.create(null)),(a=v.handle)||(a=v.handle=function(e){return"undefined"!=typeof ce&&ce.event.triggered!==e.type?ce.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(D)||[""]).length;while(l--)d=g=(s=De.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),d&&(f=ce.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=ce.event.special[d]||{},c=ce.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&ce.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=u[d])||((p=u[d]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(d,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),ce.event.global[d]=!0)}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=_.hasData(e)&&_.get(e);if(v&&(u=v.events)){l=(t=(t||"").match(D)||[""]).length;while(l--)if(d=g=(s=De.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),d){f=ce.event.special[d]||{},p=u[d=(r?f.delegateType:f.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;while(o--)c=p[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,f.remove&&f.remove.call(e,c));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,v.handle)||ce.removeEvent(e,d,v.handle),delete u[d])}else for(d in u)ce.event.remove(e,d+t[l],n,r,!0);ce.isEmptyObject(u)&&_.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=new Array(arguments.length),u=ce.event.fix(e),l=(_.get(this,"events")||Object.create(null))[u.type]||[],c=ce.event.special[u.type]||{};for(s[0]=u,t=1;t<arguments.length;t++)s[t]=arguments[t];if(u.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,u)){a=ce.event.handlers.call(this,u,l),t=0;while((i=a[t++])&&!u.isPropagationStopped()){u.currentTarget=i.elem,n=0;while((o=i.handlers[n++])&&!u.isImmediatePropagationStopped())u.rnamespace&&!1!==o.namespace&&!u.rnamespace.test(o.namespace)||(u.handleObj=o,u.data=o.data,void 0!==(r=((ce.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,s))&&!1===(u.result=r)&&(u.preventDefault(),u.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,u),u.result}},handlers:function(e,t){var n,r,i,o,a,s=[],u=t.delegateCount,l=e.target;if(u&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],a={},n=0;n<u;n++)void 0===a[i=(r=t[n]).selector+" "]&&(a[i]=r.needsContext?-1<ce(i,this).index(l):ce.find(i,this,null,[l]).length),a[i]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,u<t.length&&s.push({elem:l,handlers:t.slice(u)}),s},addProp:function(t,e){Object.defineProperty(ce.Event.prototype,t,{enumerable:!0,configurable:!0,get:v(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[ce.expando]?e:new ce.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return we.test(t.type)&&t.click&&fe(t,"input")&&He(t,"click",!0),!1},trigger:function(e){var t=this||e;return we.test(t.type)&&t.click&&fe(t,"input")&&He(t,"click"),!0},_default:function(e){var t=e.target;return we.test(t.type)&&t.click&&fe(t,"input")&&_.get(t,"click")||fe(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},ce.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},ce.Event=function(e,t){if(!(this instanceof ce.Event))return new ce.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?Ne:qe,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&ce.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[ce.expando]=!0},ce.Event.prototype={constructor:ce.Event,isDefaultPrevented:qe,isPropagationStopped:qe,isImmediatePropagationStopped:qe,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=Ne,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=Ne,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=Ne,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},ce.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,"char":!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},ce.event.addProp),ce.each({focus:"focusin",blur:"focusout"},function(r,i){function o(e){if(C.documentMode){var t=_.get(this,"handle"),n=ce.event.fix(e);n.type="focusin"===e.type?"focus":"blur",n.isSimulated=!0,t(e),n.target===n.currentTarget&&t(n)}else ce.event.simulate(i,e.target,ce.event.fix(e))}ce.event.special[r]={setup:function(){var e;if(He(this,r,!0),!C.documentMode)return!1;(e=_.get(this,i))||this.addEventListener(i,o),_.set(this,i,(e||0)+1)},trigger:function(){return He(this,r),!0},teardown:function(){var e;if(!C.documentMode)return!1;(e=_.get(this,i)-1)?_.set(this,i,e):(this.removeEventListener(i,o),_.remove(this,i))},_default:function(e){return _.get(e.target,r)},delegateType:i},ce.event.special[i]={setup:function(){var e=this.ownerDocument||this.document||this,t=C.documentMode?this:e,n=_.get(t,i);n||(C.documentMode?this.addEventListener(i,o):e.addEventListener(r,o,!0)),_.set(t,i,(n||0)+1)},teardown:function(){var e=this.ownerDocument||this.document||this,t=C.documentMode?this:e,n=_.get(t,i)-1;n?_.set(t,i,n):(C.documentMode?this.removeEventListener(i,o):e.removeEventListener(r,o,!0),_.remove(t,i))}}}),ce.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){ce.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||ce.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),ce.fn.extend({on:function(e,t,n,r){return Le(this,e,t,n,r)},one:function(e,t,n,r){return Le(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,ce(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=qe),this.each(function(){ce.event.remove(this,e,n,t)})}});var Oe=/<script|<style|<link/i,Pe=/checked\s*(?:[^=]|=\s*.checked.)/i,Me=/^\s*<!\[CDATA\[|\]\]>\s*$/g;function Re(e,t){return fe(e,"table")&&fe(11!==t.nodeType?t:t.firstChild,"tr")&&ce(e).children("tbody")[0]||e}function Ie(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function We(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Fe(e,t){var n,r,i,o,a,s;if(1===t.nodeType){if(_.hasData(e)&&(s=_.get(e).events))for(i in _.remove(t,"handle events"),s)for(n=0,r=s[i].length;n<r;n++)ce.event.add(t,i,s[i][n]);z.hasData(e)&&(o=z.access(e),a=ce.extend({},o),z.set(t,a))}}function $e(n,r,i,o){r=g(r);var e,t,a,s,u,l,c=0,f=n.length,p=f-1,d=r[0],h=v(d);if(h||1<f&&"string"==typeof d&&!le.checkClone&&Pe.test(d))return n.each(function(e){var t=n.eq(e);h&&(r[0]=d.call(this,e,t.html())),$e(t,r,i,o)});if(f&&(t=(e=Ae(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=ce.map(Se(e,"script"),Ie)).length;c<f;c++)u=e,c!==p&&(u=ce.clone(u,!0,!0),s&&ce.merge(a,Se(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,ce.map(a,We),c=0;c<s;c++)u=a[c],Ce.test(u.type||"")&&!_.access(u,"globalEval")&&ce.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?ce._evalUrl&&!u.noModule&&ce._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")},l):m(u.textContent.replace(Me,""),u,l))}return n}function Be(e,t,n){for(var r,i=t?ce.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||ce.cleanData(Se(r)),r.parentNode&&(n&&K(r)&&Ee(Se(r,"script")),r.parentNode.removeChild(r));return e}ce.extend({htmlPrefilter:function(e){return e},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=K(e);if(!(le.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||ce.isXMLDoc(e)))for(a=Se(c),r=0,i=(o=Se(e)).length;r<i;r++)s=o[r],u=a[r],void 0,"input"===(l=u.nodeName.toLowerCase())&&we.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||Se(e),a=a||Se(c),r=0,i=o.length;r<i;r++)Fe(o[r],a[r]);else Fe(e,c);return 0<(a=Se(c,"script")).length&&Ee(a,!f&&Se(e,"script")),c},cleanData:function(e){for(var t,n,r,i=ce.event.special,o=0;void 0!==(n=e[o]);o++)if($(n)){if(t=n[_.expando]){if(t.events)for(r in t.events)i[r]?ce.event.remove(n,r):ce.removeEvent(n,r,t.handle);n[_.expando]=void 0}n[z.expando]&&(n[z.expando]=void 0)}}}),ce.fn.extend({detach:function(e){return Be(this,e,!0)},remove:function(e){return Be(this,e)},text:function(e){return M(this,function(e){return void 0===e?ce.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return $e(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Re(this,e).appendChild(e)})},prepend:function(){return $e(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Re(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return $e(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return $e(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(ce.cleanData(Se(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return ce.clone(this,e,t)})},html:function(e){return M(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!Oe.test(e)&&!ke[(Te.exec(e)||["",""])[1].toLowerCase()]){e=ce.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(ce.cleanData(Se(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return $e(this,arguments,function(e){var t=this.parentNode;ce.inArray(this,n)<0&&(ce.cleanData(Se(this)),t&&t.replaceChild(e,this))},n)}}),ce.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){ce.fn[e]=function(e){for(var t,n=[],r=ce(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),ce(r[o])[a](t),s.apply(n,t.get());return this.pushStack(n)}});var _e=new RegExp("^("+G+")(?!px)[a-z%]+$","i"),ze=/^--/,Xe=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=ie),t.getComputedStyle(e)},Ue=function(e,t,n){var r,i,o={};for(i in t)o[i]=e.style[i],e.style[i]=t[i];for(i in r=n.call(e),t)e.style[i]=o[i];return r},Ve=new RegExp(Q.join("|"),"i");function Ge(e,t,n){var r,i,o,a,s=ze.test(t),u=e.style;return(n=n||Xe(e))&&(a=n.getPropertyValue(t)||n[t],s&&a&&(a=a.replace(ve,"$1")||void 0),""!==a||K(e)||(a=ce.style(e,t)),!le.pixelBoxStyles()&&_e.test(a)&&Ve.test(t)&&(r=u.width,i=u.minWidth,o=u.maxWidth,u.minWidth=u.maxWidth=u.width=a,a=n.width,u.width=r,u.minWidth=i,u.maxWidth=o)),void 0!==a?a+"":a}function Ye(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function e(){if(l){u.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",l.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",J.appendChild(u).appendChild(l);var e=ie.getComputedStyle(l);n="1%"!==e.top,s=12===t(e.marginLeft),l.style.right="60%",o=36===t(e.right),r=36===t(e.width),l.style.position="absolute",i=12===t(l.offsetWidth/3),J.removeChild(u),l=null}}function t(e){return Math.round(parseFloat(e))}var n,r,i,o,a,s,u=C.createElement("div"),l=C.createElement("div");l.style&&(l.style.backgroundClip="content-box",l.cloneNode(!0).style.backgroundClip="",le.clearCloneStyle="content-box"===l.style.backgroundClip,ce.extend(le,{boxSizingReliable:function(){return e(),r},pixelBoxStyles:function(){return e(),o},pixelPosition:function(){return e(),n},reliableMarginLeft:function(){return e(),s},scrollboxSize:function(){return e(),i},reliableTrDimensions:function(){var e,t,n,r;return null==a&&(e=C.createElement("table"),t=C.createElement("tr"),n=C.createElement("div"),e.style.cssText="position:absolute;left:-11111px;border-collapse:separate",t.style.cssText="box-sizing:content-box;border:1px solid",t.style.height="1px",n.style.height="9px",n.style.display="block",J.appendChild(e).appendChild(t).appendChild(n),r=ie.getComputedStyle(t),a=parseInt(r.height,10)+parseInt(r.borderTopWidth,10)+parseInt(r.borderBottomWidth,10)===t.offsetHeight,J.removeChild(e)),a}}))}();var Qe=["Webkit","Moz","ms"],Je=C.createElement("div").style,Ke={};function Ze(e){var t=ce.cssProps[e]||Ke[e];return t||(e in Je?e:Ke[e]=function(e){var t=e[0].toUpperCase()+e.slice(1),n=Qe.length;while(n--)if((e=Qe[n]+t)in Je)return e}(e)||e)}var et=/^(none|table(?!-c[ea]).+)/,tt={position:"absolute",visibility:"hidden",display:"block"},nt={letterSpacing:"0",fontWeight:"400"};function rt(e,t,n){var r=Y.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function it(e,t,n,r,i,o){var a="width"===t?1:0,s=0,u=0,l=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(l+=ce.css(e,n+Q[a],!0,i)),r?("content"===n&&(u-=ce.css(e,"padding"+Q[a],!0,i)),"margin"!==n&&(u-=ce.css(e,"border"+Q[a]+"Width",!0,i))):(u+=ce.css(e,"padding"+Q[a],!0,i),"padding"!==n?u+=ce.css(e,"border"+Q[a]+"Width",!0,i):s+=ce.css(e,"border"+Q[a]+"Width",!0,i));return!r&&0<=o&&(u+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-u-s-.5))||0),u+l}function ot(e,t,n){var r=Xe(e),i=(!le.boxSizingReliable()||n)&&"border-box"===ce.css(e,"boxSizing",!1,r),o=i,a=Ge(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if(_e.test(a)){if(!n)return a;a="auto"}return(!le.boxSizingReliable()&&i||!le.reliableTrDimensions()&&fe(e,"tr")||"auto"===a||!parseFloat(a)&&"inline"===ce.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===ce.css(e,"boxSizing",!1,r),(o=s in e)&&(a=e[s])),(a=parseFloat(a)||0)+it(e,t,n||(i?"border":"content"),o,r,a)+"px"}function at(e,t,n,r,i){return new at.prototype.init(e,t,n,r,i)}ce.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Ge(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,aspectRatio:!0,borderImageSlice:!0,columnCount:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,scale:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeMiterlimit:!0,strokeOpacity:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=F(t),u=ze.test(t),l=e.style;if(u||(t=Ze(s)),a=ce.cssHooks[t]||ce.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:l[t];"string"===(o=typeof n)&&(i=Y.exec(n))&&i[1]&&(n=te(e,t,i),o="number"),null!=n&&n==n&&("number"!==o||u||(n+=i&&i[3]||(ce.cssNumber[s]?"":"px")),le.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var i,o,a,s=F(t);return ze.test(t)||(t=Ze(s)),(a=ce.cssHooks[t]||ce.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=Ge(e,t,r)),"normal"===i&&t in nt&&(i=nt[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),ce.each(["height","width"],function(e,u){ce.cssHooks[u]={get:function(e,t,n){if(t)return!et.test(ce.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?ot(e,u,n):Ue(e,tt,function(){return ot(e,u,n)})},set:function(e,t,n){var r,i=Xe(e),o=!le.scrollboxSize()&&"absolute"===i.position,a=(o||n)&&"border-box"===ce.css(e,"boxSizing",!1,i),s=n?it(e,u,n,a,i):0;return a&&o&&(s-=Math.ceil(e["offset"+u[0].toUpperCase()+u.slice(1)]-parseFloat(i[u])-it(e,u,"border",!1,i)-.5)),s&&(r=Y.exec(t))&&"px"!==(r[3]||"px")&&(e.style[u]=t,t=ce.css(e,u)),rt(0,t,s)}}}),ce.cssHooks.marginLeft=Ye(le.reliableMarginLeft,function(e,t){if(t)return(parseFloat(Ge(e,"marginLeft"))||e.getBoundingClientRect().left-Ue(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),ce.each({margin:"",padding:"",border:"Width"},function(i,o){ce.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+Q[t]+o]=r[t]||r[t-2]||r[0];return n}},"margin"!==i&&(ce.cssHooks[i+o].set=rt)}),ce.fn.extend({css:function(e,t){return M(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=Xe(e),i=t.length;a<i;a++)o[t[a]]=ce.css(e,t[a],!1,r);return o}return void 0!==n?ce.style(e,t,n):ce.css(e,t)},e,t,1<arguments.length)}}),((ce.Tween=at).prototype={constructor:at,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||ce.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(ce.cssNumber[n]?"":"px")},cur:function(){var e=at.propHooks[this.prop];return e&&e.get?e.get(this):at.propHooks._default.get(this)},run:function(e){var t,n=at.propHooks[this.prop];return this.options.duration?this.pos=t=ce.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):at.propHooks._default.set(this),this}}).init.prototype=at.prototype,(at.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=ce.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){ce.fx.step[e.prop]?ce.fx.step[e.prop](e):1!==e.elem.nodeType||!ce.cssHooks[e.prop]&&null==e.elem.style[Ze(e.prop)]?e.elem[e.prop]=e.now:ce.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=at.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},ce.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},ce.fx=at.prototype.init,ce.fx.step={};var st,ut,lt,ct,ft=/^(?:toggle|show|hide)$/,pt=/queueHooks$/;function dt(){ut&&(!1===C.hidden&&ie.requestAnimationFrame?ie.requestAnimationFrame(dt):ie.setTimeout(dt,ce.fx.interval),ce.fx.tick())}function ht(){return ie.setTimeout(function(){st=void 0}),st=Date.now()}function gt(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=Q[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function vt(e,t,n){for(var r,i=(yt.tweeners[t]||[]).concat(yt.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function yt(o,e,t){var n,a,r=0,i=yt.prefilters.length,s=ce.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=st||ht(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(i||s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:ce.extend({},e),opts:ce.extend(!0,{specialEasing:{},easing:ce.easing._default},t),originalProperties:e,originalOptions:t,startTime:st||ht(),duration:t.duration,tweens:[],createTween:function(e,t){var n=ce.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=F(n)],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=ce.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=yt.prefilters[r].call(l,o,c,l.opts))return v(n.stop)&&(ce._queueHooks(l.elem,l.opts.queue).stop=n.stop.bind(n)),n;return ce.map(c,vt,l),v(l.opts.start)&&l.opts.start.call(o,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),ce.fx.timer(ce.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l}ce.Animation=ce.extend(yt,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return te(n.elem,e,Y.exec(t),n),n}]},tweener:function(e,t){v(e)?(t=e,e=["*"]):e=e.match(D);for(var n,r=0,i=e.length;r<i;r++)n=e[r],yt.tweeners[n]=yt.tweeners[n]||[],yt.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&ee(e),v=_.get(e,"fxshow");for(r in n.queue||(null==(a=ce._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,ce.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],ft.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!v||void 0===v[r])continue;g=!0}d[r]=v&&v[r]||ce.style(e,r)}if((u=!ce.isEmptyObject(t))||!ce.isEmptyObject(d))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=v&&v.display)&&(l=_.get(e,"display")),"none"===(c=ce.css(e,"display"))&&(l?c=l:(re([e],!0),l=e.style.display||l,c=ce.css(e,"display"),re([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===ce.css(e,"float")&&(u||(p.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,d)u||(v?"hidden"in v&&(g=v.hidden):v=_.access(e,"fxshow",{display:l}),o&&(v.hidden=!g),g&&re([e],!0),p.done(function(){for(r in g||re([e]),_.remove(e,"fxshow"),d)ce.style(e,r,d[r])})),u=vt(g?v[r]:0,r,p),r in v||(v[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?yt.prefilters.unshift(e):yt.prefilters.push(e)}}),ce.speed=function(e,t,n){var r=e&&"object"==typeof e?ce.extend({},e):{complete:n||!n&&t||v(e)&&e,duration:e,easing:n&&t||t&&!v(t)&&t};return ce.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in ce.fx.speeds?r.duration=ce.fx.speeds[r.duration]:r.duration=ce.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){v(r.old)&&r.old.call(this),r.queue&&ce.dequeue(this,r.queue)},r},ce.fn.extend({fadeTo:function(e,t,n,r){return this.filter(ee).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){var i=ce.isEmptyObject(t),o=ce.speed(e,n,r),a=function(){var e=yt(this,ce.extend({},t),o);(i||_.get(this,"finish"))&&e.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=ce.timers,r=_.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&pt.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||ce.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=_.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=ce.timers,o=n?n.length:0;for(t.finish=!0,ce.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),ce.each(["toggle","show","hide"],function(e,r){var i=ce.fn[r];ce.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(gt(r,!0),e,t,n)}}),ce.each({slideDown:gt("show"),slideUp:gt("hide"),slideToggle:gt("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){ce.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),ce.timers=[],ce.fx.tick=function(){var e,t=0,n=ce.timers;for(st=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||ce.fx.stop(),st=void 0},ce.fx.timer=function(e){ce.timers.push(e),ce.fx.start()},ce.fx.interval=13,ce.fx.start=function(){ut||(ut=!0,dt())},ce.fx.stop=function(){ut=null},ce.fx.speeds={slow:600,fast:200,_default:400},ce.fn.delay=function(r,e){return r=ce.fx&&ce.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=ie.setTimeout(e,r);t.stop=function(){ie.clearTimeout(n)}})},lt=C.createElement("input"),ct=C.createElement("select").appendChild(C.createElement("option")),lt.type="checkbox",le.checkOn=""!==lt.value,le.optSelected=ct.selected,(lt=C.createElement("input")).value="t",lt.type="radio",le.radioValue="t"===lt.value;var mt,xt=ce.expr.attrHandle;ce.fn.extend({attr:function(e,t){return M(this,ce.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){ce.removeAttr(this,e)})}}),ce.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return"undefined"==typeof e.getAttribute?ce.prop(e,t,n):(1===o&&ce.isXMLDoc(e)||(i=ce.attrHooks[t.toLowerCase()]||(ce.expr.match.bool.test(t)?mt:void 0)),void 0!==n?null===n?void ce.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=ce.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!le.radioValue&&"radio"===t&&fe(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(D);if(i&&1===e.nodeType)while(n=i[r++])e.removeAttribute(n)}}),mt={set:function(e,t,n){return!1===t?ce.removeAttr(e,n):e.setAttribute(n,n),n}},ce.each(ce.expr.match.bool.source.match(/\w+/g),function(e,t){var a=xt[t]||ce.find.attr;xt[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=xt[o],xt[o]=r,r=null!=a(e,t,n)?o:null,xt[o]=i),r}});var bt=/^(?:input|select|textarea|button)$/i,wt=/^(?:a|area)$/i;function Tt(e){return(e.match(D)||[]).join(" ")}function Ct(e){return e.getAttribute&&e.getAttribute("class")||""}function kt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(D)||[]}ce.fn.extend({prop:function(e,t){return M(this,ce.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[ce.propFix[e]||e]})}}),ce.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&ce.isXMLDoc(e)||(t=ce.propFix[t]||t,i=ce.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=ce.find.attr(e,"tabindex");return t?parseInt(t,10):bt.test(e.nodeName)||wt.test(e.nodeName)&&e.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),le.optSelected||(ce.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),ce.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){ce.propFix[this.toLowerCase()]=this}),ce.fn.extend({addClass:function(t){var e,n,r,i,o,a;return v(t)?this.each(function(e){ce(this).addClass(t.call(this,e,Ct(this)))}):(e=kt(t)).length?this.each(function(){if(r=Ct(this),n=1===this.nodeType&&" "+Tt(r)+" "){for(o=0;o<e.length;o++)i=e[o],n.indexOf(" "+i+" ")<0&&(n+=i+" ");a=Tt(n),r!==a&&this.setAttribute("class",a)}}):this},removeClass:function(t){var e,n,r,i,o,a;return v(t)?this.each(function(e){ce(this).removeClass(t.call(this,e,Ct(this)))}):arguments.length?(e=kt(t)).length?this.each(function(){if(r=Ct(this),n=1===this.nodeType&&" "+Tt(r)+" "){for(o=0;o<e.length;o++){i=e[o];while(-1<n.indexOf(" "+i+" "))n=n.replace(" "+i+" "," ")}a=Tt(n),r!==a&&this.setAttribute("class",a)}}):this:this.attr("class","")},toggleClass:function(t,n){var e,r,i,o,a=typeof t,s="string"===a||Array.isArray(t);return v(t)?this.each(function(e){ce(this).toggleClass(t.call(this,e,Ct(this),n),n)}):"boolean"==typeof n&&s?n?this.addClass(t):this.removeClass(t):(e=kt(t),this.each(function(){if(s)for(o=ce(this),i=0;i<e.length;i++)r=e[i],o.hasClass(r)?o.removeClass(r):o.addClass(r);else void 0!==t&&"boolean"!==a||((r=Ct(this))&&_.set(this,"__className__",r),this.setAttribute&&this.setAttribute("class",r||!1===t?"":_.get(this,"__className__")||""))}))},hasClass:function(e){var t,n,r=0;t=" "+e+" ";while(n=this[r++])if(1===n.nodeType&&-1<(" "+Tt(Ct(n))+" ").indexOf(t))return!0;return!1}});var St=/\r/g;ce.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=v(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,ce(this).val()):n)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=ce.map(t,function(e){return null==e?"":e+""})),(r=ce.valHooks[this.type]||ce.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=ce.valHooks[t.type]||ce.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(St,""):null==e?"":e:void 0}}),ce.extend({valHooks:{option:{get:function(e){var t=ce.find.attr(e,"value");return null!=t?t:Tt(ce.text(e))}},select:{get:function(e){var t,n,r,i=e.options,o=e.selectedIndex,a="select-one"===e.type,s=a?null:[],u=a?o+1:i.length;for(r=o<0?u:a?o:0;r<u;r++)if(((n=i[r]).selected||r===o)&&!n.disabled&&(!n.parentNode.disabled||!fe(n.parentNode,"optgroup"))){if(t=ce(n).val(),a)return t;s.push(t)}return s},set:function(e,t){var n,r,i=e.options,o=ce.makeArray(t),a=i.length;while(a--)((r=i[a]).selected=-1<ce.inArray(ce.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),ce.each(["radio","checkbox"],function(){ce.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<ce.inArray(ce(e).val(),t)}},le.checkOn||(ce.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var Et=ie.location,jt={guid:Date.now()},At=/\?/;ce.parseXML=function(e){var t,n;if(!e||"string"!=typeof e)return null;try{t=(new ie.DOMParser).parseFromString(e,"text/xml")}catch(e){}return n=t&&t.getElementsByTagName("parsererror")[0],t&&!n||ce.error("Invalid XML: "+(n?ce.map(n.childNodes,function(e){return e.textContent}).join("\n"):e)),t};var Dt=/^(?:focusinfocus|focusoutblur)$/,Nt=function(e){e.stopPropagation()};ce.extend(ce.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f,p=[n||C],d=ue.call(e,"type")?e.type:e,h=ue.call(e,"namespace")?e.namespace.split("."):[];if(o=f=a=n=n||C,3!==n.nodeType&&8!==n.nodeType&&!Dt.test(d+ce.event.triggered)&&(-1<d.indexOf(".")&&(d=(h=d.split(".")).shift(),h.sort()),u=d.indexOf(":")<0&&"on"+d,(e=e[ce.expando]?e:new ce.Event(d,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=h.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:ce.makeArray(t,[e]),c=ce.event.special[d]||{},r||!c.trigger||!1!==c.trigger.apply(n,t))){if(!r&&!c.noBubble&&!y(n)){for(s=c.delegateType||d,Dt.test(s+d)||(o=o.parentNode);o;o=o.parentNode)p.push(o),a=o;a===(n.ownerDocument||C)&&p.push(a.defaultView||a.parentWindow||ie)}i=0;while((o=p[i++])&&!e.isPropagationStopped())f=o,e.type=1<i?s:c.bindType||d,(l=(_.get(o,"events")||Object.create(null))[e.type]&&_.get(o,"handle"))&&l.apply(o,t),(l=u&&o[u])&&l.apply&&$(o)&&(e.result=l.apply(o,t),!1===e.result&&e.preventDefault());return e.type=d,r||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(p.pop(),t)||!$(n)||u&&v(n[d])&&!y(n)&&((a=n[u])&&(n[u]=null),ce.event.triggered=d,e.isPropagationStopped()&&f.addEventListener(d,Nt),n[d](),e.isPropagationStopped()&&f.removeEventListener(d,Nt),ce.event.triggered=void 0,a&&(n[u]=a)),e.result}},simulate:function(e,t,n){var r=ce.extend(new ce.Event,n,{type:e,isSimulated:!0});ce.event.trigger(r,null,t)}}),ce.fn.extend({trigger:function(e,t){return this.each(function(){ce.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return ce.event.trigger(e,t,n,!0)}});var qt=/\[\]$/,Lt=/\r?\n/g,Ht=/^(?:submit|button|image|reset|file)$/i,Ot=/^(?:input|select|textarea|keygen)/i;function Pt(n,e,r,i){var t;if(Array.isArray(e))ce.each(e,function(e,t){r||qt.test(n)?i(n,t):Pt(n+"["+("object"==typeof t&&null!=t?e:"")+"]",t,r,i)});else if(r||"object"!==x(e))i(n,e);else for(t in e)Pt(n+"["+t+"]",e[t],r,i)}ce.param=function(e,t){var n,r=[],i=function(e,t){var n=v(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!ce.isPlainObject(e))ce.each(e,function(){i(this.name,this.value)});else for(n in e)Pt(n,e[n],t,i);return r.join("&")},ce.fn.extend({serialize:function(){return ce.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=ce.prop(this,"elements");return e?ce.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!ce(this).is(":disabled")&&Ot.test(this.nodeName)&&!Ht.test(e)&&(this.checked||!we.test(e))}).map(function(e,t){var n=ce(this).val();return null==n?null:Array.isArray(n)?ce.map(n,function(e){return{name:t.name,value:e.replace(Lt,"\r\n")}}):{name:t.name,value:n.replace(Lt,"\r\n")}}).get()}});var Mt=/%20/g,Rt=/#.*$/,It=/([?&])_=[^&]*/,Wt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Ft=/^(?:GET|HEAD)$/,$t=/^\/\//,Bt={},_t={},zt="*/".concat("*"),Xt=C.createElement("a");function Ut(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(D)||[];if(v(t))while(n=i[r++])"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function Vt(t,i,o,a){var s={},u=t===_t;function l(e){var r;return s[e]=!0,ce.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),l(n),!1)}),r}return l(i.dataTypes[0])||!s["*"]&&l("*")}function Gt(e,t){var n,r,i=ce.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&ce.extend(!0,e,r),e}Xt.href=Et.href,ce.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Et.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(Et.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":zt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":ce.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Gt(Gt(e,ce.ajaxSettings),t):Gt(ce.ajaxSettings,e)},ajaxPrefilter:Ut(Bt),ajaxTransport:Ut(_t),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,p,n,d,r,h,g,i,o,v=ce.ajaxSetup({},t),y=v.context||v,m=v.context&&(y.nodeType||y.jquery)?ce(y):ce.event,x=ce.Deferred(),b=ce.Callbacks("once memory"),w=v.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n){n={};while(t=Wt.exec(p))n[t[1].toLowerCase()+" "]=(n[t[1].toLowerCase()+" "]||[]).concat(t[2])}t=n[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return h?p:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(v.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),l(0,t),this}};if(x.promise(T),v.url=((e||v.url||Et.href)+"").replace($t,Et.protocol+"//"),v.type=t.method||t.type||v.method||v.type,v.dataTypes=(v.dataType||"*").toLowerCase().match(D)||[""],null==v.crossDomain){r=C.createElement("a");try{r.href=v.url,r.href=r.href,v.crossDomain=Xt.protocol+"//"+Xt.host!=r.protocol+"//"+r.host}catch(e){v.crossDomain=!0}}if(v.data&&v.processData&&"string"!=typeof v.data&&(v.data=ce.param(v.data,v.traditional)),Vt(Bt,v,t,T),h)return T;for(i in(g=ce.event&&v.global)&&0==ce.active++&&ce.event.trigger("ajaxStart"),v.type=v.type.toUpperCase(),v.hasContent=!Ft.test(v.type),f=v.url.replace(Rt,""),v.hasContent?v.data&&v.processData&&0===(v.contentType||"").indexOf("application/x-www-form-urlencoded")&&(v.data=v.data.replace(Mt,"+")):(o=v.url.slice(f.length),v.data&&(v.processData||"string"==typeof v.data)&&(f+=(At.test(f)?"&":"?")+v.data,delete v.data),!1===v.cache&&(f=f.replace(It,"$1"),o=(At.test(f)?"&":"?")+"_="+jt.guid+++o),v.url=f+o),v.ifModified&&(ce.lastModified[f]&&T.setRequestHeader("If-Modified-Since",ce.lastModified[f]),ce.etag[f]&&T.setRequestHeader("If-None-Match",ce.etag[f])),(v.data&&v.hasContent&&!1!==v.contentType||t.contentType)&&T.setRequestHeader("Content-Type",v.contentType),T.setRequestHeader("Accept",v.dataTypes[0]&&v.accepts[v.dataTypes[0]]?v.accepts[v.dataTypes[0]]+("*"!==v.dataTypes[0]?", "+zt+"; q=0.01":""):v.accepts["*"]),v.headers)T.setRequestHeader(i,v.headers[i]);if(v.beforeSend&&(!1===v.beforeSend.call(y,T,v)||h))return T.abort();if(u="abort",b.add(v.complete),T.done(v.success),T.fail(v.error),c=Vt(_t,v,t,T)){if(T.readyState=1,g&&m.trigger("ajaxSend",[T,v]),h)return T;v.async&&0<v.timeout&&(d=ie.setTimeout(function(){T.abort("timeout")},v.timeout));try{h=!1,c.send(a,l)}catch(e){if(h)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,d&&ie.clearTimeout(d),c=void 0,p=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function(e,t,n){var r,i,o,a,s=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(v,T,n)),!i&&-1<ce.inArray("script",v.dataTypes)&&ce.inArray("json",v.dataTypes)<0&&(v.converters["text script"]=function(){}),s=function(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(v,s,T,i),i?(v.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(ce.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(ce.etag[f]=u)),204===e||"HEAD"===v.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(y,[o,l,T]):x.rejectWith(y,[T,l,a]),T.statusCode(w),w=void 0,g&&m.trigger(i?"ajaxSuccess":"ajaxError",[T,v,i?o:a]),b.fireWith(y,[T,l]),g&&(m.trigger("ajaxComplete",[T,v]),--ce.active||ce.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return ce.get(e,t,n,"json")},getScript:function(e,t){return ce.get(e,void 0,t,"script")}}),ce.each(["get","post"],function(e,i){ce[i]=function(e,t,n,r){return v(t)&&(r=r||n,n=t,t=void 0),ce.ajax(ce.extend({url:e,type:i,dataType:r,data:t,success:n},ce.isPlainObject(e)&&e))}}),ce.ajaxPrefilter(function(e){var t;for(t in e.headers)"content-type"===t.toLowerCase()&&(e.contentType=e.headers[t]||"")}),ce._evalUrl=function(e,t,n){return ce.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){ce.globalEval(e,t,n)}})},ce.fn.extend({wrapAll:function(e){var t;return this[0]&&(v(e)&&(e=e.call(this[0])),t=ce(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstElementChild)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return v(n)?this.each(function(e){ce(this).wrapInner(n.call(this,e))}):this.each(function(){var e=ce(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=v(t);return this.each(function(e){ce(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){ce(this).replaceWith(this.childNodes)}),this}}),ce.expr.pseudos.hidden=function(e){return!ce.expr.pseudos.visible(e)},ce.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},ce.ajaxSettings.xhr=function(){try{return new ie.XMLHttpRequest}catch(e){}};var Yt={0:200,1223:204},Qt=ce.ajaxSettings.xhr();le.cors=!!Qt&&"withCredentials"in Qt,le.ajax=Qt=!!Qt,ce.ajaxTransport(function(i){var o,a;if(le.cors||Qt&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.ontimeout=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(Yt[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=r.ontimeout=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&ie.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),ce.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),ce.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return ce.globalEval(e),e}}}),ce.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),ce.ajaxTransport("script",function(n){var r,i;if(n.crossDomain||n.scriptAttrs)return{send:function(e,t){r=ce("<script>").attr(n.scriptAttrs||{}).prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),C.head.appendChild(r[0])},abort:function(){i&&i()}}});var Jt,Kt=[],Zt=/(=)\?(?=&|$)|\?\?/;ce.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Kt.pop()||ce.expando+"_"+jt.guid++;return this[e]=!0,e}}),ce.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(Zt.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Zt.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=v(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Zt,"$1"+r):!1!==e.jsonp&&(e.url+=(At.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||ce.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=ie[r],ie[r]=function(){o=arguments},n.always(function(){void 0===i?ce(ie).removeProp(r):ie[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,Kt.push(r)),o&&v(i)&&i(o[0]),o=i=void 0}),"script"}),le.createHTMLDocument=((Jt=C.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Jt.childNodes.length),ce.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(le.createHTMLDocument?((r=(t=C.implementation.createHTMLDocument("")).createElement("base")).href=C.location.href,t.head.appendChild(r)):t=C),o=!n&&[],(i=w.exec(e))?[t.createElement(i[1])]:(i=Ae([e],t,o),o&&o.length&&ce(o).remove(),ce.merge([],i.childNodes)));var r,i,o},ce.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=Tt(e.slice(s)),e=e.slice(0,s)),v(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&ce.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?ce("<div>").append(ce.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},ce.expr.pseudos.animated=function(t){return ce.grep(ce.timers,function(e){return t===e.elem}).length},ce.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=ce.css(e,"position"),c=ce(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=ce.css(e,"top"),u=ce.css(e,"left"),("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(u)||0),v(t)&&(t=t.call(e,n,ce.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},ce.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){ce.offset.setOffset(this,t,e)});var e,n,r=this[0];return r?r.getClientRects().length?(e=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:e.top+n.pageYOffset,left:e.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===ce.css(r,"position"))t=r.getBoundingClientRect();else{t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;while(e&&(e===n.body||e===n.documentElement)&&"static"===ce.css(e,"position"))e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=ce(e).offset()).top+=ce.css(e,"borderTopWidth",!0),i.left+=ce.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-ce.css(r,"marginTop",!0),left:t.left-i.left-ce.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent;while(e&&"static"===ce.css(e,"position"))e=e.offsetParent;return e||J})}}),ce.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;ce.fn[t]=function(e){return M(this,function(e,t,n){var r;if(y(e)?r=e:9===e.nodeType&&(r=e.defaultView),void 0===n)return r?r[i]:e[t];r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n},t,e,arguments.length)}}),ce.each(["top","left"],function(e,n){ce.cssHooks[n]=Ye(le.pixelPosition,function(e,t){if(t)return t=Ge(e,n),_e.test(t)?ce(e).position()[n]+"px":t})}),ce.each({Height:"height",Width:"width"},function(a,s){ce.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){ce.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return M(this,function(e,t,n){var r;return y(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?ce.css(e,t,i):ce.style(e,t,n,i)},s,n?e:void 0,n)}})}),ce.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){ce.fn[t]=function(e){return this.on(t,e)}}),ce.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},hover:function(e,t){return this.on("mouseenter",e).on("mouseleave",t||e)}}),ce.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){ce.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}});var en=/^[\s\uFEFF\xA0]+|([^\s\uFEFF\xA0])[\s\uFEFF\xA0]+$/g;ce.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),v(e))return r=ae.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(ae.call(arguments)))}).guid=e.guid=e.guid||ce.guid++,i},ce.holdReady=function(e){e?ce.readyWait++:ce.ready(!0)},ce.isArray=Array.isArray,ce.parseJSON=JSON.parse,ce.nodeName=fe,ce.isFunction=v,ce.isWindow=y,ce.camelCase=F,ce.type=x,ce.now=Date.now,ce.isNumeric=function(e){var t=ce.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},ce.trim=function(e){return null==e?"":(e+"").replace(en,"$1")},"function"==typeof define&&define.amd&&define("jquery",[],function(){return ce});var tn=ie.jQuery,nn=ie.$;return ce.noConflict=function(e){return ie.$===ce&&(ie.$=nn),e&&ie.jQuery===ce&&(ie.jQuery=tn),ce},"undefined"==typeof e&&(ie.jQuery=ie.$=ce),ce});



========== staticfiles/admin/js/cancel.js ==========
'use strict';
{
    // Call function fn when the DOM is loaded and ready. If it is already
    // loaded, call the function now.
    // http://youmightnotneedjquery.com/#ready
    function ready(fn) {
        if (document.readyState !== 'loading') {
            fn();
        } else {
            document.addEventListener('DOMContentLoaded', fn);
        }
    }

    ready(function() {
        function handleClick(event) {
            event.preventDefault();
            const params = new URLSearchParams(window.location.search);
            if (params.has('_popup')) {
                window.close(); // Close the popup.
            } else {
                window.history.back(); // Otherwise, go back.
            }
        }

        document.querySelectorAll('.cancel-link').forEach(function(el) {
            el.addEventListener('click', handleClick);
        });
    });
}



========== staticfiles/admin/js/SelectBox.js ==========
'use strict';
{
    const SelectBox = {
        cache: {},
        init: function(id) {
            const box = document.getElementById(id);
            SelectBox.cache[id] = [];
            const cache = SelectBox.cache[id];
            for (const node of box.options) {
                cache.push({value: node.value, text: node.text, displayed: 1});
            }
        },
        redisplay: function(id) {
            // Repopulate HTML select box from cache
            const box = document.getElementById(id);
            const scroll_value_from_top = box.scrollTop;
            box.innerHTML = '';
            for (const node of SelectBox.cache[id]) {
                if (node.displayed) {
                    const new_option = new Option(node.text, node.value, false, false);
                    // Shows a tooltip when hovering over the option
                    new_option.title = node.text;
                    box.appendChild(new_option);
                }
            }
            box.scrollTop = scroll_value_from_top;
        },
        filter: function(id, text) {
            // Redisplay the HTML select box, displaying only the choices containing ALL
            // the words in text. (It's an AND search.)
            const tokens = text.toLowerCase().split(/\s+/);
            for (const node of SelectBox.cache[id]) {
                node.displayed = 1;
                const node_text = node.text.toLowerCase();
                for (const token of tokens) {
                    if (!node_text.includes(token)) {
                        node.displayed = 0;
                        break; // Once the first token isn't found we're done
                    }
                }
            }
            SelectBox.redisplay(id);
        },
        get_hidden_node_count(id) {
            const cache = SelectBox.cache[id] || [];
            return cache.filter(node => node.displayed === 0).length;
        },
        delete_from_cache: function(id, value) {
            let delete_index = null;
            const cache = SelectBox.cache[id];
            for (const [i, node] of cache.entries()) {
                if (node.value === value) {
                    delete_index = i;
                    break;
                }
            }
            cache.splice(delete_index, 1);
        },
        add_to_cache: function(id, option) {
            SelectBox.cache[id].push({value: option.value, text: option.text, displayed: 1});
        },
        cache_contains: function(id, value) {
            // Check if an item is contained in the cache
            for (const node of SelectBox.cache[id]) {
                if (node.value === value) {
                    return true;
                }
            }
            return false;
        },
        move: function(from, to) {
            const from_box = document.getElementById(from);
            for (const option of from_box.options) {
                const option_value = option.value;
                if (option.selected && SelectBox.cache_contains(from, option_value)) {
                    SelectBox.add_to_cache(to, {value: option_value, text: option.text, displayed: 1});
                    SelectBox.delete_from_cache(from, option_value);
                }
            }
            SelectBox.redisplay(from);
            SelectBox.redisplay(to);
        },
        move_all: function(from, to) {
            const from_box = document.getElementById(from);
            for (const option of from_box.options) {
                const option_value = option.value;
                if (SelectBox.cache_contains(from, option_value)) {
                    SelectBox.add_to_cache(to, {value: option_value, text: option.text, displayed: 1});
                    SelectBox.delete_from_cache(from, option_value);
                }
            }
            SelectBox.redisplay(from);
            SelectBox.redisplay(to);
        },
        sort: function(id) {
            SelectBox.cache[id].sort(function(a, b) {
                a = a.text.toLowerCase();
                b = b.text.toLowerCase();
                if (a > b) {
                    return 1;
                }
                if (a < b) {
                    return -1;
                }
                return 0;
            } );
        },
        select_all: function(id) {
            const box = document.getElementById(id);
            for (const option of box.options) {
                option.selected = true;
            }
        }
    };
    window.SelectBox = SelectBox;
}



========== staticfiles/admin/js/popup_response.js ==========
'use strict';
{
    const initData = JSON.parse(document.getElementById('django-admin-popup-response-constants').dataset.popupResponse);
    switch(initData.action) {
    case 'change':
        opener.dismissChangeRelatedObjectPopup(window, initData.value, initData.obj, initData.new_value);
        break;
    case 'delete':
        opener.dismissDeleteRelatedObjectPopup(window, initData.value);
        break;
    default:
        opener.dismissAddRelatedObjectPopup(window, initData.value, initData.obj);
        break;
    }
}



========== staticfiles/admin/js/jquery.init.js ==========
/*global jQuery:false*/
'use strict';
/* Puts the included jQuery into our own namespace using noConflict and passing
 * it 'true'. This ensures that the included jQuery doesn't pollute the global
 * namespace (i.e. this preserves pre-existing values for both window.$ and
 * window.jQuery).
 */
window.django = {jQuery: jQuery.noConflict(true)};



========== staticfiles/admin/js/prepopulate.js ==========
/*global URLify*/
'use strict';
{
    const $ = django.jQuery;
    $.fn.prepopulate = function(dependencies, maxLength, allowUnicode) {
        /*
            Depends on urlify.js
            Populates a selected field with the values of the dependent fields,
            URLifies and shortens the string.
            dependencies - array of dependent fields ids
            maxLength - maximum length of the URLify'd string
            allowUnicode - Unicode support of the URLify'd string
        */
        return this.each(function() {
            const prepopulatedField = $(this);

            const populate = function() {
                // Bail if the field's value has been changed by the user
                if (prepopulatedField.data('_changed')) {
                    return;
                }

                const values = [];
                $.each(dependencies, function(i, field) {
                    field = $(field);
                    if (field.val().length > 0) {
                        values.push(field.val());
                    }
                });
                prepopulatedField.val(URLify(values.join(' '), maxLength, allowUnicode));
            };

            prepopulatedField.data('_changed', false);
            prepopulatedField.on('change', function() {
                prepopulatedField.data('_changed', true);
            });

            if (!prepopulatedField.val()) {
                $(dependencies.join(',')).on('keyup change focus', populate);
            }
        });
    };
}



========== staticfiles/admin/js/urlify.js ==========
/*global XRegExp*/
'use strict';
{
    const LATIN_MAP = {
        'À': 'A', 'Á': 'A', 'Â': 'A', 'Ã': 'A', 'Ä': 'A', 'Å': 'A', 'Æ': 'AE',
        'Ç': 'C', 'È': 'E', 'É': 'E', 'Ê': 'E', 'Ë': 'E', 'Ì': 'I', 'Í': 'I',
        'Î': 'I', 'Ï': 'I', 'Ð': 'D', 'Ñ': 'N', 'Ò': 'O', 'Ó': 'O', 'Ô': 'O',
        'Õ': 'O', 'Ö': 'O', 'Ő': 'O', 'Ø': 'O', 'Ù': 'U', 'Ú': 'U', 'Û': 'U',
        'Ü': 'U', 'Ű': 'U', 'Ý': 'Y', 'Þ': 'TH', 'Ÿ': 'Y', 'ß': 'ss', 'à': 'a',
        'á': 'a', 'â': 'a', 'ã': 'a', 'ä': 'a', 'å': 'a', 'æ': 'ae', 'ç': 'c',
        'è': 'e', 'é': 'e', 'ê': 'e', 'ë': 'e', 'ì': 'i', 'í': 'i', 'î': 'i',
        'ï': 'i', 'ð': 'd', 'ñ': 'n', 'ò': 'o', 'ó': 'o', 'ô': 'o', 'õ': 'o',
        'ö': 'o', 'ő': 'o', 'ø': 'o', 'ù': 'u', 'ú': 'u', 'û': 'u', 'ü': 'u',
        'ű': 'u', 'ý': 'y', 'þ': 'th', 'ÿ': 'y'
    };
    const LATIN_SYMBOLS_MAP = {
        '©': '(c)'
    };
    const GREEK_MAP = {
        'α': 'a', 'β': 'b', 'γ': 'g', 'δ': 'd', 'ε': 'e', 'ζ': 'z', 'η': 'h',
        'θ': '8', 'ι': 'i', 'κ': 'k', 'λ': 'l', 'μ': 'm', 'ν': 'n', 'ξ': '3',
        'ο': 'o', 'π': 'p', 'ρ': 'r', 'σ': 's', 'τ': 't', 'υ': 'y', 'φ': 'f',
        'χ': 'x', 'ψ': 'ps', 'ω': 'w', 'ά': 'a', 'έ': 'e', 'ί': 'i', 'ό': 'o',
        'ύ': 'y', 'ή': 'h', 'ώ': 'w', 'ς': 's', 'ϊ': 'i', 'ΰ': 'y', 'ϋ': 'y',
        'ΐ': 'i', 'Α': 'A', 'Β': 'B', 'Γ': 'G', 'Δ': 'D', 'Ε': 'E', 'Ζ': 'Z',
        'Η': 'H', 'Θ': '8', 'Ι': 'I', 'Κ': 'K', 'Λ': 'L', 'Μ': 'M', 'Ν': 'N',
        'Ξ': '3', 'Ο': 'O', 'Π': 'P', 'Ρ': 'R', 'Σ': 'S', 'Τ': 'T', 'Υ': 'Y',
        'Φ': 'F', 'Χ': 'X', 'Ψ': 'PS', 'Ω': 'W', 'Ά': 'A', 'Έ': 'E', 'Ί': 'I',
        'Ό': 'O', 'Ύ': 'Y', 'Ή': 'H', 'Ώ': 'W', 'Ϊ': 'I', 'Ϋ': 'Y'
    };
    const TURKISH_MAP = {
        'ş': 's', 'Ş': 'S', 'ı': 'i', 'İ': 'I', 'ç': 'c', 'Ç': 'C', 'ü': 'u',
        'Ü': 'U', 'ö': 'o', 'Ö': 'O', 'ğ': 'g', 'Ğ': 'G'
    };
    const ROMANIAN_MAP = {
        'ă': 'a', 'î': 'i', 'ș': 's', 'ț': 't', 'â': 'a',
        'Ă': 'A', 'Î': 'I', 'Ș': 'S', 'Ț': 'T', 'Â': 'A'
    };
    const RUSSIAN_MAP = {
        'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo',
        'ж': 'zh', 'з': 'z', 'и': 'i', 'й': 'j', 'к': 'k', 'л': 'l', 'м': 'm',
        'н': 'n', 'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
        'ф': 'f', 'х': 'h', 'ц': 'c', 'ч': 'ch', 'ш': 'sh', 'щ': 'sh', 'ъ': '',
        'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya',
        'А': 'A', 'Б': 'B', 'В': 'V', 'Г': 'G', 'Д': 'D', 'Е': 'E', 'Ё': 'Yo',
        'Ж': 'Zh', 'З': 'Z', 'И': 'I', 'Й': 'J', 'К': 'K', 'Л': 'L', 'М': 'M',
        'Н': 'N', 'О': 'O', 'П': 'P', 'Р': 'R', 'С': 'S', 'Т': 'T', 'У': 'U',
        'Ф': 'F', 'Х': 'H', 'Ц': 'C', 'Ч': 'Ch', 'Ш': 'Sh', 'Щ': 'Sh', 'Ъ': '',
        'Ы': 'Y', 'Ь': '', 'Э': 'E', 'Ю': 'Yu', 'Я': 'Ya'
    };
    const UKRAINIAN_MAP = {
        'Є': 'Ye', 'І': 'I', 'Ї': 'Yi', 'Ґ': 'G', 'є': 'ye', 'і': 'i',
        'ї': 'yi', 'ґ': 'g'
    };
    const CZECH_MAP = {
        'č': 'c', 'ď': 'd', 'ě': 'e', 'ň': 'n', 'ř': 'r', 'š': 's', 'ť': 't',
        'ů': 'u', 'ž': 'z', 'Č': 'C', 'Ď': 'D', 'Ě': 'E', 'Ň': 'N', 'Ř': 'R',
        'Š': 'S', 'Ť': 'T', 'Ů': 'U', 'Ž': 'Z'
    };
    const SLOVAK_MAP = {
        'á': 'a', 'ä': 'a', 'č': 'c', 'ď': 'd', 'é': 'e', 'í': 'i', 'ľ': 'l',
        'ĺ': 'l', 'ň': 'n', 'ó': 'o', 'ô': 'o', 'ŕ': 'r', 'š': 's', 'ť': 't',
        'ú': 'u', 'ý': 'y', 'ž': 'z',
        'Á': 'a', 'Ä': 'A', 'Č': 'C', 'Ď': 'D', 'É': 'E', 'Í': 'I', 'Ľ': 'L',
        'Ĺ': 'L', 'Ň': 'N', 'Ó': 'O', 'Ô': 'O', 'Ŕ': 'R', 'Š': 'S', 'Ť': 'T',
        'Ú': 'U', 'Ý': 'Y', 'Ž': 'Z'
    };
    const POLISH_MAP = {
        'ą': 'a', 'ć': 'c', 'ę': 'e', 'ł': 'l', 'ń': 'n', 'ó': 'o', 'ś': 's',
        'ź': 'z', 'ż': 'z',
        'Ą': 'A', 'Ć': 'C', 'Ę': 'E', 'Ł': 'L', 'Ń': 'N', 'Ó': 'O', 'Ś': 'S',
        'Ź': 'Z', 'Ż': 'Z'
    };
    const LATVIAN_MAP = {
        'ā': 'a', 'č': 'c', 'ē': 'e', 'ģ': 'g', 'ī': 'i', 'ķ': 'k', 'ļ': 'l',
        'ņ': 'n', 'š': 's', 'ū': 'u', 'ž': 'z',
        'Ā': 'A', 'Č': 'C', 'Ē': 'E', 'Ģ': 'G', 'Ī': 'I', 'Ķ': 'K', 'Ļ': 'L',
        'Ņ': 'N', 'Š': 'S', 'Ū': 'U', 'Ž': 'Z'
    };
    const ARABIC_MAP = {
        'أ': 'a', 'ب': 'b', 'ت': 't', 'ث': 'th', 'ج': 'g', 'ح': 'h', 'خ': 'kh', 'د': 'd',
        'ذ': 'th', 'ر': 'r', 'ز': 'z', 'س': 's', 'ش': 'sh', 'ص': 's', 'ض': 'd', 'ط': 't',
        'ظ': 'th', 'ع': 'aa', 'غ': 'gh', 'ف': 'f', 'ق': 'k', 'ك': 'k', 'ل': 'l', 'م': 'm',
        'ن': 'n', 'ه': 'h', 'و': 'o', 'ي': 'y'
    };
    const LITHUANIAN_MAP = {
        'ą': 'a', 'č': 'c', 'ę': 'e', 'ė': 'e', 'į': 'i', 'š': 's', 'ų': 'u',
        'ū': 'u', 'ž': 'z',
        'Ą': 'A', 'Č': 'C', 'Ę': 'E', 'Ė': 'E', 'Į': 'I', 'Š': 'S', 'Ų': 'U',
        'Ū': 'U', 'Ž': 'Z'
    };
    const SERBIAN_MAP = {
        'ђ': 'dj', 'ј': 'j', 'љ': 'lj', 'њ': 'nj', 'ћ': 'c', 'џ': 'dz',
        'đ': 'dj', 'Ђ': 'Dj', 'Ј': 'j', 'Љ': 'Lj', 'Њ': 'Nj', 'Ћ': 'C',
        'Џ': 'Dz', 'Đ': 'Dj'
    };
    const AZERBAIJANI_MAP = {
        'ç': 'c', 'ə': 'e', 'ğ': 'g', 'ı': 'i', 'ö': 'o', 'ş': 's', 'ü': 'u',
        'Ç': 'C', 'Ə': 'E', 'Ğ': 'G', 'İ': 'I', 'Ö': 'O', 'Ş': 'S', 'Ü': 'U'
    };
    const GEORGIAN_MAP = {
        'ა': 'a', 'ბ': 'b', 'გ': 'g', 'დ': 'd', 'ე': 'e', 'ვ': 'v', 'ზ': 'z',
        'თ': 't', 'ი': 'i', 'კ': 'k', 'ლ': 'l', 'მ': 'm', 'ნ': 'n', 'ო': 'o',
        'პ': 'p', 'ჟ': 'j', 'რ': 'r', 'ს': 's', 'ტ': 't', 'უ': 'u', 'ფ': 'f',
        'ქ': 'q', 'ღ': 'g', 'ყ': 'y', 'შ': 'sh', 'ჩ': 'ch', 'ც': 'c', 'ძ': 'dz',
        'წ': 'w', 'ჭ': 'ch', 'ხ': 'x', 'ჯ': 'j', 'ჰ': 'h'
    };

    const ALL_DOWNCODE_MAPS = [
        LATIN_MAP,
        LATIN_SYMBOLS_MAP,
        GREEK_MAP,
        TURKISH_MAP,
        ROMANIAN_MAP,
        RUSSIAN_MAP,
        UKRAINIAN_MAP,
        CZECH_MAP,
        SLOVAK_MAP,
        POLISH_MAP,
        LATVIAN_MAP,
        ARABIC_MAP,
        LITHUANIAN_MAP,
        SERBIAN_MAP,
        AZERBAIJANI_MAP,
        GEORGIAN_MAP
    ];

    const Downcoder = {
        'Initialize': function() {
            if (Downcoder.map) { // already made
                return;
            }
            Downcoder.map = {};
            for (const lookup of ALL_DOWNCODE_MAPS) {
                Object.assign(Downcoder.map, lookup);
            }
            Downcoder.regex = new RegExp(Object.keys(Downcoder.map).join('|'), 'g');
        }
    };

    function downcode(slug) {
        Downcoder.Initialize();
        return slug.replace(Downcoder.regex, function(m) {
            return Downcoder.map[m];
        });
    }


    function URLify(s, num_chars, allowUnicode) {
        // changes, e.g., "Petty theft" to "petty-theft"
        if (!allowUnicode) {
            s = downcode(s);
        }
        s = s.toLowerCase(); // convert to lowercase
        // if downcode doesn't hit, the char will be stripped here
        if (allowUnicode) {
            // Keep Unicode letters including both lowercase and uppercase
            // characters, whitespace, and dash; remove other characters.
            s = XRegExp.replace(s, XRegExp('[^-_\\p{L}\\p{N}\\s]', 'g'), '');
        } else {
            s = s.replace(/[^-\w\s]/g, ''); // remove unneeded chars
        }
        s = s.replace(/^\s+|\s+$/g, ''); // trim leading/trailing spaces
        s = s.replace(/[-\s]+/g, '-'); // convert spaces to hyphens
        s = s.substring(0, num_chars); // trim to first num_chars chars
        return s.replace(/-+$/g, ''); // trim any trailing hyphens
    }
    window.URLify = URLify;
}



========== staticfiles/gis/css/ol3.css ==========
.dj_map_wrapper {
    position: relative;
    float: left;
}
html[dir="rtl"] .dj_map_wrapper {
    float: right;
}

.switch-type {
    background-repeat: no-repeat;
    cursor: pointer;
    top: 0.5em;
    width: 22px;
    height: 20px;
}

.type-Point {
    background-image: url("../img/draw_point_off.svg");
    right: 5px;
}
.type-Point.type-active {
    background-image: url("../img/draw_point_on.svg");
}

.type-LineString {
    background-image: url("../img/draw_line_off.svg");
    right: 30px;
}
.type-LineString.type-active {
    background-image: url("../img/draw_line_on.svg");
}

.type-Polygon {
    background-image: url("../img/draw_polygon_off.svg");
    right: 55px;
}
.type-Polygon.type-active {
    background-image: url("../img/draw_polygon_on.svg");
}



========== staticfiles/gis/js/OLMapWidget.js ==========
/* global ol */
'use strict';
class GeometryTypeControl extends ol.control.Control {
    // Map control to switch type when geometry type is unknown
    constructor(opt_options) {
        const options = opt_options || {};

        const element = document.createElement('div');
        element.className = 'switch-type type-' + options.type + ' ol-control ol-unselectable';
        if (options.active) {
            element.classList.add("type-active");
        }

        super({
            element: element,
            target: options.target
        });
        const self = this;
        const switchType = function(e) {
            e.preventDefault();
            if (options.widget.currentGeometryType !== self) {
                options.widget.map.removeInteraction(options.widget.interactions.draw);
                options.widget.interactions.draw = new ol.interaction.Draw({
                    features: options.widget.featureCollection,
                    type: options.type
                });
                options.widget.map.addInteraction(options.widget.interactions.draw);
                options.widget.currentGeometryType.element.classList.remove('type-active');
                options.widget.currentGeometryType = self;
                element.classList.add("type-active");
            }
        };

        element.addEventListener('click', switchType, false);
        element.addEventListener('touchstart', switchType, false);
    }
}

// TODO: allow deleting individual features (#8972)
class MapWidget {
    constructor(options) {
        this.map = null;
        this.interactions = {draw: null, modify: null};
        this.typeChoices = false;
        this.ready = false;

        // Default options
        this.options = {
            default_lat: 0,
            default_lon: 0,
            default_zoom: 12,
            is_collection: options.geom_name.includes('Multi') || options.geom_name.includes('Collection')
        };

        // Altering using user-provided options
        for (const property in options) {
            if (Object.hasOwn(options, property)) {
                this.options[property] = options[property];
            }
        }

        // Options' base_layer can be empty, or contain a layerBuilder key, or
        // be a layer already constructed.
        const base_layer = options.base_layer;
        if (typeof base_layer === 'string' && base_layer in MapWidget.layerBuilder) {
            this.baseLayer = MapWidget.layerBuilder[base_layer]();
        } else if (base_layer && typeof base_layer !== 'string') {
            this.baseLayer = base_layer;
        } else {
            this.baseLayer = MapWidget.layerBuilder.osm();
        }

        this.map = this.createMap();
        this.featureCollection = new ol.Collection();
        this.featureOverlay = new ol.layer.Vector({
            map: this.map,
            source: new ol.source.Vector({
                features: this.featureCollection,
                useSpatialIndex: false // improve performance
            }),
            updateWhileAnimating: true, // optional, for instant visual feedback
            updateWhileInteracting: true // optional, for instant visual feedback
        });

        // Populate and set handlers for the feature container
        const self = this;
        this.featureCollection.on('add', function(event) {
            const feature = event.element;
            feature.on('change', function() {
                self.serializeFeatures();
            });
            if (self.ready) {
                self.serializeFeatures();
                if (!self.options.is_collection) {
                    self.disableDrawing(); // Only allow one feature at a time
                }
            }
        });

        const initial_value = document.getElementById(this.options.id).value;
        if (initial_value) {
            const jsonFormat = new ol.format.GeoJSON();
            const features = jsonFormat.readFeatures('{"type": "Feature", "geometry": ' + initial_value + '}');
            const extent = ol.extent.createEmpty();
            features.forEach(function(feature) {
                this.featureOverlay.getSource().addFeature(feature);
                ol.extent.extend(extent, feature.getGeometry().getExtent());
            }, this);
            // Center/zoom the map
            this.map.getView().fit(extent, {minResolution: 1});
        } else {
            this.map.getView().setCenter(this.defaultCenter());
        }
        this.createInteractions();
        if (initial_value && !this.options.is_collection) {
            this.disableDrawing();
        }
        const clearNode = document.getElementById(this.map.getTarget()).nextElementSibling;
        if (clearNode.classList.contains('clear_features')) {
            clearNode.querySelector('a').addEventListener('click', (ev) => {
                ev.preventDefault();
                self.clearFeatures();
            });
        }
        this.ready = true;
    }

    createMap() {
        return new ol.Map({
            target: this.options.map_id,
            layers: [this.baseLayer],
            view: new ol.View({
                zoom: this.options.default_zoom
            })
        });
    }

    createInteractions() {
        // Initialize the modify interaction
        this.interactions.modify = new ol.interaction.Modify({
            features: this.featureCollection,
            deleteCondition: function(event) {
                return ol.events.condition.shiftKeyOnly(event) &&
                    ol.events.condition.singleClick(event);
            }
        });

        // Initialize the draw interaction
        let geomType = this.options.geom_name;
        if (geomType === "Geometry" || geomType === "GeometryCollection") {
            // Default to Point, but create icons to switch type
            geomType = "Point";
            this.currentGeometryType = new GeometryTypeControl({widget: this, type: "Point", active: true});
            this.map.addControl(this.currentGeometryType);
            this.map.addControl(new GeometryTypeControl({widget: this, type: "LineString", active: false}));
            this.map.addControl(new GeometryTypeControl({widget: this, type: "Polygon", active: false}));
            this.typeChoices = true;
        }
        this.interactions.draw = new ol.interaction.Draw({
            features: this.featureCollection,
            type: geomType
        });

        this.map.addInteraction(this.interactions.draw);
        this.map.addInteraction(this.interactions.modify);
    }

    defaultCenter() {
        const center = [this.options.default_lon, this.options.default_lat];
        if (this.options.map_srid) {
            return ol.proj.transform(center, 'EPSG:4326', this.map.getView().getProjection());
        }
        return center;
    }

    enableDrawing() {
        this.interactions.draw.setActive(true);
        if (this.typeChoices) {
            // Show geometry type icons
            const divs = document.getElementsByClassName("switch-type");
            for (let i = 0; i !== divs.length; i++) {
                divs[i].style.visibility = "visible";
            }
        }
    }

    disableDrawing() {
        if (this.interactions.draw) {
            this.interactions.draw.setActive(false);
            if (this.typeChoices) {
                // Hide geometry type icons
                const divs = document.getElementsByClassName("switch-type");
                for (let i = 0; i !== divs.length; i++) {
                    divs[i].style.visibility = "hidden";
                }
            }
        }
    }

    clearFeatures() {
        this.featureCollection.clear();
        // Empty textarea widget
        document.getElementById(this.options.id).value = '';
        this.enableDrawing();
    }

    serializeFeatures() {
        // Three use cases: GeometryCollection, multigeometries, and single geometry
        let geometry = null;
        const features = this.featureOverlay.getSource().getFeatures();
        if (this.options.is_collection) {
            if (this.options.geom_name === "GeometryCollection") {
                const geometries = [];
                for (let i = 0; i < features.length; i++) {
                    geometries.push(features[i].getGeometry());
                }
                geometry = new ol.geom.GeometryCollection(geometries);
            } else {
                geometry = features[0].getGeometry().clone();
                for (let j = 1; j < features.length; j++) {
                    switch (geometry.getType()) {
                    case "MultiPoint":
                        geometry.appendPoint(features[j].getGeometry().getPoint(0));
                        break;
                    case "MultiLineString":
                        geometry.appendLineString(features[j].getGeometry().getLineString(0));
                        break;
                    case "MultiPolygon":
                        geometry.appendPolygon(features[j].getGeometry().getPolygon(0));
                    }
                }
            }
        } else {
            if (features[0]) {
                geometry = features[0].getGeometry();
            }
        }
        const jsonFormat = new ol.format.GeoJSON();
        document.getElementById(this.options.id).value = jsonFormat.writeGeometry(geometry);
    }
}

// Static property assignment (ES6-compatible)
MapWidget.layerBuilder = {
    nasaWorldview: () => {
        return new ol.layer.Tile({
            source: new ol.source.XYZ({
                attributions: "NASA Worldview",
                maxZoom: 8,
                url: "https://map1{a-c}.vis.earthdata.nasa.gov/wmts-webmerc/" +
                     "BlueMarble_ShadedRelief_Bathymetry/default/%7BTime%7D/" +
                     "GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpg"
            })
        });
    },
    osm: () => {
        return new ol.layer.Tile({source: new ol.source.OSM()});
    }
};

function initMapWidgetInSection(section) {
    const maps = [];

    section.querySelectorAll(".dj_map_wrapper").forEach((wrapper) => {
        // Avoid initializing map widget on an empty form.
        if (wrapper.id.includes('__prefix__')) {
            return;
        }
        const textarea_id = wrapper.querySelector("textarea").id;
        const options_script = wrapper.querySelector(`script#${textarea_id}_mapwidget_options`);
        const options = JSON.parse(options_script.textContent);
        options.id = textarea_id;
        options.map_id = wrapper.querySelector(".dj_map").id;
        maps.push(new MapWidget(options));
    });

    return maps;
};

document.addEventListener("DOMContentLoaded", () => {
    initMapWidgetInSection(document);
    document.addEventListener('formset:added', (ev) => {initMapWidgetInSection(ev.target);});
});



========== staticfiles/css/rtl.css ==========
/* ~/ebi3/static/css/rtl.css */
/* Styles spécifiques pour les langues RTL (Arabe) */

body[dir="rtl"] {
    font-family: 'Cairo', 'Poppins', sans-serif;
    text-align: right;
}

/* Flips for RTL */
body[dir="rtl"] .me-1 { margin-right: 0 !important; margin-left: 0.25rem !important; }
body[dir="rtl"] .me-2 { margin-right: 0 !important; margin-left: 0.5rem !important; }
body[dir="rtl"] .me-3 { margin-right: 0 !important; margin-left: 1rem !important; }
body[dir="rtl"] .me-4 { margin-right: 0 !important; margin-left: 1.5rem !important; }
body[dir="rtl"] .me-5 { margin-right: 0 !important; margin-left: 3rem !important; }

body[dir="rtl"] .ms-1 { margin-left: 0 !important; margin-right: 0.25rem !important; }
body[dir="rtl"] .ms-2 { margin-left: 0 !important; margin-right: 0.5rem !important; }
body[dir="rtl"] .ms-3 { margin-left: 0 !important; margin-right: 1rem !important; }
body[dir="rtl"] .ms-4 { margin-left: 0 !important; margin-right: 1.5rem !important; }
body[dir="rtl"] .ms-5 { margin-left: 0 !important; margin-right: 3rem !important; }

body[dir="rtl"] .ps-1 { padding-right: 0.25rem !important; padding-left: 0 !important; }
body[dir="rtl"] .ps-2 { padding-right: 0.5rem !important; padding-left: 0 !important; }
body[dir="rtl"] .ps-3 { padding-right: 1rem !important; padding-left: 0 !important; }
body[dir="rtl"] .ps-4 { padding-right: 1.5rem !important; padding-left: 0 !important; }
body[dir="rtl"] .ps-5 { padding-right: 3rem !important; padding-left: 0 !important; }

body[dir="rtl"] .pe-1 { padding-left: 0.25rem !important; padding-right: 0 !important; }
body[dir="rtl"] .pe-2 { padding-left: 0.5rem !important; padding-right: 0 !important; }
body[dir="rtl"] .pe-3 { padding-left: 1rem !important; padding-right: 0 !important; }
body[dir="rtl"] .pe-4 { padding-left: 1.5rem !important; padding-right: 0 !important; }
body[dir="rtl"] .pe-5 { padding-left: 3rem !important; padding-right: 0 !important; }

body[dir="rtl"] .text-start { text-align: right !important; }
body[dir="rtl"] .text-end { text-align: left !important; }

body[dir="rtl"] .float-start { float: right !important; }
body[dir="rtl"] .float-end { float: left !important; }

/* Dropdown alignment */
body[dir="rtl"] .dropdown-menu {
    text-align: right;
    right: auto !important;
    left: 0 !important;
}

body[dir="rtl"] .dropdown-menu-end {
    left: auto !important;
    right: 0 !important;
}

/* Carousel controls */
body[dir="rtl"] .carousel-control-prev {
    right: 0;
    left: auto;
}

body[dir="rtl"] .carousel-control-next {
    left: 0;
    right: auto;
}

/* Breadcrumb */
body[dir="rtl"] .breadcrumb-item + .breadcrumb-item::before {
    float: right;
    padding-left: 0.5rem;
    padding-right: 0;
}

/* Form elements */
body[dir="rtl"] .form-check {
    padding-right: 1.5em;
    padding-left: 0;
}

body[dir="rtl"] .form-check-input {
    float: right;
    margin-right: -1.5em;
    margin-left: 0;
}

body[dir="rtl"] .input-group > .form-control,
body[dir="rtl"] .input-group > .form-select {
    border-radius: 0 0.375rem 0.375rem 0;
}

body[dir="rtl"] .input-group > .form-control:not(:last-child),
body[dir="rtl"] .input-group > .form-select:not(:last-child) {
    border-radius: 0 0.375rem 0.375rem 0;
}

body[dir="rtl"] .input-group > .form-control:not(:first-child),
body[dir="rtl"] .input-group > .form-select:not(:first-child) {
    border-radius: 0.375rem 0 0 0.375rem;
}

/* Modal */
body[dir="rtl"] .modal-header .btn-close {
    margin: -0.5rem auto -0.5rem -0.5rem;
}

/* Navbar brand */
body[dir="rtl"] .navbar-brand {
    margin-right: 0;
    margin-left: 1rem;
}

/* Alert close button */
body[dir="rtl"] .alert-dismissible .btn-close {
    margin-left: 0;
    margin-right: -0.5rem;
}

/* List styles */
body[dir="rtl"] ul {
    padding-right: 20px;
    padding-left: 0;
}

/* Custom Arabic font sizes */
body[dir="rtl"] .display-1,
body[dir="rtl"] .display-2,
body[dir="rtl"] .display-3,
body[dir="rtl"] .display-4,
body[dir="rtl"] .display-5,
body[dir="rtl"] .display-6 {
    line-height: 1.3;
}

/* Fix for Bootstrap icons in RTL */
body[dir="rtl"] .bi-chevron-right::before {
    content: "\f284"; /* Chevron left */
}

body[dir="rtl"] .bi-chevron-left::before {
    content: "\f285"; /* Chevron right */
}

/* Custom RTL spacing utilities */
.rtl-mr-1 { margin-right: 0.25rem !important; }
.rtl-ml-1 { margin-left: 0.25rem !important; }
.rtl-mr-2 { margin-right: 0.5rem !important; }
.rtl-ml-2 { margin-left: 0.5rem !important; }
.rtl-mr-3 { margin-right: 1rem !important; }
.rtl-ml-3 { margin-left: 1rem !important; }


========== staticfiles/css/admin-logistics.css ==========
/* ~/ebi3/static/css/admin-logistics.css */

/* Styles pour les barres de progression */
.progress-bar {
    background-color: #f0f0f0;
    border-radius: 3px;
    height: 20px;
    position: relative;
}

.progress-fill {
    border-radius: 3px;
    height: 100%;
    transition: width 0.3s ease;
}

/* Couleurs selon le pourcentage */
.progress-low { background-color: #F44336; }  /* Rouge */
.progress-medium { background-color: #FFC107; } /* Orange */
.progress-high { background-color: #4CAF50; } /* Vert */

/* Styles pour les statuts */
.status-badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
}

.status-pending { background-color: #FFC107; color: #000; }
.status-confirmed { background-color: #2196F3; color: #fff; }
.status-in-transit { background-color: #9C27B0; color: #fff; }
.status-delivered { background-color: #4CAF50; color: #fff; }
.status-cancelled { background-color: #F44336; color: #fff; }

/* Amélioration des tableaux */
#changelist table thead th {
    background-color: #667eea;
    color: white;
}

/* Espacement amélioré */
.field-get_ad_link,
.field-get_buyer_link,
.field-get_carrier_link {
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 10px;
}


========== staticfiles/css/style.css ==========
/* ~/ebi3/static/css/style.css */
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --success-color: #28a745;
    --info-color: #17a2b8;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
    --border-radius: 8px;
    --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

/* Base Styles */
body {
    font-family: 'Poppins', 'Cairo', sans-serif;
    line-height: 1.6;
    color: #333;
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
    font-weight: 600;
    margin-bottom: 1rem;
}

.display-1, .display-2, .display-3, .display-4, .display-5, .display-6 {
    font-weight: 700;
}

/* Links */
a {
    color: var(--primary-color);
    text-decoration: none;
    transition: var(--transition);
}

a:hover {
    color: var(--secondary-color);
}

/* Buttons */
.btn {
    border-radius: var(--border-radius);
    padding: 0.5rem 1.5rem;
    font-weight: 500;
    transition: var(--transition);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
}

.btn-outline-primary {
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline-primary:hover {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-color: transparent;
    transform: translateY(-2px);
}

/* Cards */
.card {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    transition: var(--transition);
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.card-header {
    border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
}

/* Forms */
.form-control, .form-select {
    border-radius: var(--border-radius);
    border: 1px solid #ddd;
    padding: 0.75rem 1rem;
    transition: var(--transition);
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

/* Navigation */
.navbar-brand {
    font-weight: 700;
    font-size: 1.5rem;
}

.nav-link {
    font-weight: 500;
    padding: 0.5rem 1rem !important;
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.nav-link:hover, .nav-link.active {
    background-color: rgba(102, 126, 234, 0.1);
    color: var(--primary-color) !important;
}

/* Footer */
footer {
    background: linear-gradient(135deg, #343a40 0%, #212529 100%);
}

footer a:hover {
    color: white !important;
    opacity: 0.8;
}

/* Badges */
.badge {
    border-radius: 20px;
    padding: 0.4em 0.8em;
    font-weight: 500;
}

/* Alerts */
.alert {
    border-radius: var(--border-radius);
    border: none;
}

/* Pagination */
.pagination .page-link {
    border-radius: var(--border-radius);
    margin: 0 2px;
}

.pagination .page-item.active .page-link {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-color: transparent;
}

/* Images */
.img-thumbnail {
    border-radius: var(--border-radius);
}

/* Avatar */
.avatar-circle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-weight: bold;
    color: white;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.5s ease-out;
}

/* Responsive */
@media (max-width: 768px) {
    .display-1 { font-size: 3rem; }
    .display-2 { font-size: 2.5rem; }
    .display-3 { font-size: 2rem; }
    .display-4 { font-size: 1.75rem; }
    .display-5 { font-size: 1.5rem; }
    .display-6 { font-size: 1.25rem; }

    .btn {
        padding: 0.4rem 1rem;
        font-size: 0.9rem;
    }
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 10px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    opacity: 0.8;
}

/* Print Styles */
@media print {
    .no-print {
        display: none !important;
    }
}


========== staticfiles/js/main.js ==========
// ~/ebi3/static/js/main.js
// Fonctions utilitaires globales

// Debounce function pour les événements
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Formatage des prix
function formatPrice(price, currency = '€') {
    return new Intl.NumberFormat('fr-FR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(price) + ' ' + currency;
}

// Validation des formulaires
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function validatePhone(phone) {
    const re = /^[\+]?[1-9][\d]{0,15}$/;
    return re.test(phone.replace(/\D/g, ''));
}

// Gestion des toasts
function showToast(message, type = 'success', duration = 5000) {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();

    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: duration });

    toast.show();

    // Nettoyage après fermeture
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}

// Gestion des images
function lazyLoadImages() {
    const images = document.querySelectorAll('img[data-src]');

    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                observer.unobserve(img);
            }
        });
    });

    images.forEach(img => imageObserver.observe(img));
}

// Gestion du multilinguisme
function changeLanguage(langCode) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/i18n/setlang/';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCookie('csrftoken');
    form.appendChild(csrfInput);

    const langInput = document.createElement('input');
    langInput.type = 'hidden';
    langInput.name = 'language';
    langInput.value = langCode;
    form.appendChild(langInput);

    const nextInput = document.createElement('input');
    nextInput.type = 'hidden';
    nextInput.name = 'next';
    nextInput.value = window.location.pathname;
    form.appendChild(nextInput);

    document.body.appendChild(form);
    form.submit();
}

// Helper pour les cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Activer les tooltips Bootstrap
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));

    // Activer les popovers Bootstrap
    const popovers = document.querySelectorAll('[data-bs-toggle="popover"]');
    popovers.forEach(popover => new bootstrap.Popover(popover));

    // Chargement différé des images
    lazyLoadImages();

    // Gestion des formulaires AJAX
    document.querySelectorAll('form[data-ajax]').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const submitBtn = this.querySelector('[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Afficher un indicateur de chargement
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Loading...';
            submitBtn.disabled = true;

            fetch(this.action, {
                method: this.method,
                body: new FormData(this),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast(data.message, 'success');
                    if (data.redirect) {
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 1500);
                    }
                } else {
                    showToast(data.message || 'Une erreur est survenue', 'error');
                }
            })
            .catch(error => {
                showToast('Une erreur est survenue', 'error');
                console.error('Error:', error);
            })
            .finally(() => {
                // Restaurer le bouton
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    });

    // Gestion du scroll pour la navbar
    const navbar = document.querySelector('.navbar');
    if (navbar) {
        window.addEventListener('scroll', debounce(() => {
            if (window.scrollY > 100) {
                navbar.classList.add('navbar-scrolled');
            } else {
                navbar.classList.remove('navbar-scrolled');
            }
        }, 100));
    }

    // Gestion des onglets de contenu
    document.querySelectorAll('.content-tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();

            const targetId = this.getAttribute('href');
            const targetContent = document.querySelector(targetId);

            // Cacher tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Désactiver tous les onglets
            document.querySelectorAll('.content-tab').forEach(t => {
                t.classList.remove('active');
            });

            // Activer l'onglet et le contenu sélectionnés
            this.classList.add('active');
            targetContent.classList.add('active');
        });
    });
});

// Fonction pour partager du contenu
function shareContent(title, text, url) {
    if (navigator.share) {
        navigator.share({
            title: title,
            text: text,
            url: url,
        })
        .then(() => console.log('Partage réussi'))
        .catch(error => console.log('Erreur de partage:', error));
    } else {
        // Fallback pour les navigateurs qui ne supportent pas l'API Web Share
        navigator.clipboard.writeText(url)
            .then(() => showToast('Lien copié dans le presse-papier', 'success'))
            .catch(err => console.error('Erreur de copie:', err));
    }
}

// Fonction pour télécharger des fichiers
function downloadFile(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename || url.split('/').pop();
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Export des fonctions globales
window.Ebi3 = {
    showToast,
    formatPrice,
    validateEmail,
    validatePhone,
    changeLanguage,
    shareContent,
    downloadFile
};


========== staticfiles/colis/css/colis.css ==========
/* Fichier CSS colis */


========== staticfiles/colis/js/colis.js ==========
// Fichier JS colis


========== staticfiles/flags/sprite-hq.css ==========
.flag-sprite {display: inline-block;width:16px;height:11px;image-rendering:-moz-crisp-edges;image-rendering:pixelated;image-rendering:-o-crisp-edges;-ms-interpolation-mode:nearest-neighbor;background-image:url('sprite-hq.png')}
.flag-a {background-position-x:0}
.flag-_a {background-position-y:0}
.flag-b {background-position-x:-16px}
.flag-_b {background-position-y:-11px}
.flag-c {background-position-x:-32px}
.flag-_c {background-position-y:-22px}
.flag-d {background-position-x:-48px}
.flag-_d {background-position-y:-33px}
.flag-e {background-position-x:-64px}
.flag-_e {background-position-y:-44px}
.flag-f {background-position-x:-80px}
.flag-_f {background-position-y:-55px}
.flag-g {background-position-x:-96px}
.flag-_g {background-position-y:-66px}
.flag-h {background-position-x:-112px}
.flag-_h {background-position-y:-77px}
.flag-i {background-position-x:-128px}
.flag-_i {background-position-y:-88px}
.flag-j {background-position-x:-144px}
.flag-_j {background-position-y:-99px}
.flag-k {background-position-x:-160px}
.flag-_k {background-position-y:-110px}
.flag-l {background-position-x:-176px}
.flag-_l {background-position-y:-121px}
.flag-m {background-position-x:-192px}
.flag-_m {background-position-y:-132px}
.flag-n {background-position-x:-208px}
.flag-_n {background-position-y:-143px}
.flag-o {background-position-x:-224px}
.flag-_o {background-position-y:-154px}
.flag-p {background-position-x:-240px}
.flag-_p {background-position-y:-165px}
.flag-q {background-position-x:-256px}
.flag-_q {background-position-y:-176px}
.flag-r {background-position-x:-272px}
.flag-_r {background-position-y:-187px}
.flag-s {background-position-x:-288px}
.flag-_s {background-position-y:-198px}
.flag-t {background-position-x:-304px}
.flag-_t {background-position-y:-209px}
.flag-u {background-position-x:-320px}
.flag-_u {background-position-y:-220px}
.flag-v {background-position-x:-336px}
.flag-_v {background-position-y:-231px}
.flag-w {background-position-x:-352px}
.flag-_w {background-position-y:-242px}
.flag-x {background-position-x:-368px}
.flag-_x {background-position-y:-253px}
.flag-y {background-position-x:-384px}
.flag-_y {background-position-y:-264px}
.flag-z {background-position-x:-400px}
.flag-_z {background-position-y:-275px}
.flag2x {background-size:832px 572px}
.flag2x.flag-sprite {width:32px;height:22px;}
.flag2x.flag-a {background-position-x:0}
.flag2x.flag-_a {background-position-y:0}
.flag2x.flag-b {background-position-x:-32px}
.flag2x.flag-_b {background-position-y:-22px}
.flag2x.flag-c {background-position-x:-64px}
.flag2x.flag-_c {background-position-y:-44px}
.flag2x.flag-d {background-position-x:-96px}
.flag2x.flag-_d {background-position-y:-66px}
.flag2x.flag-e {background-position-x:-128px}
.flag2x.flag-_e {background-position-y:-88px}
.flag2x.flag-f {background-position-x:-160px}
.flag2x.flag-_f {background-position-y:-110px}
.flag2x.flag-g {background-position-x:-192px}
.flag2x.flag-_g {background-position-y:-132px}
.flag2x.flag-h {background-position-x:-224px}
.flag2x.flag-_h {background-position-y:-154px}
.flag2x.flag-i {background-position-x:-256px}
.flag2x.flag-_i {background-position-y:-176px}
.flag2x.flag-j {background-position-x:-288px}
.flag2x.flag-_j {background-position-y:-198px}
.flag2x.flag-k {background-position-x:-320px}
.flag2x.flag-_k {background-position-y:-220px}
.flag2x.flag-l {background-position-x:-352px}
.flag2x.flag-_l {background-position-y:-242px}
.flag2x.flag-m {background-position-x:-384px}
.flag2x.flag-_m {background-position-y:-264px}
.flag2x.flag-n {background-position-x:-416px}
.flag2x.flag-_n {background-position-y:-286px}
.flag2x.flag-o {background-position-x:-448px}
.flag2x.flag-_o {background-position-y:-308px}
.flag2x.flag-p {background-position-x:-480px}
.flag2x.flag-_p {background-position-y:-330px}
.flag2x.flag-q {background-position-x:-512px}
.flag2x.flag-_q {background-position-y:-352px}
.flag2x.flag-r {background-position-x:-544px}
.flag2x.flag-_r {background-position-y:-374px}
.flag2x.flag-s {background-position-x:-576px}
.flag2x.flag-_s {background-position-y:-396px}
.flag2x.flag-t {background-position-x:-608px}
.flag2x.flag-_t {background-position-y:-418px}
.flag2x.flag-u {background-position-x:-640px}
.flag2x.flag-_u {background-position-y:-440px}
.flag2x.flag-v {background-position-x:-672px}
.flag2x.flag-_v {background-position-y:-462px}
.flag2x.flag-w {background-position-x:-704px}
.flag2x.flag-_w {background-position-y:-484px}
.flag2x.flag-x {background-position-x:-736px}
.flag2x.flag-_x {background-position-y:-506px}
.flag2x.flag-y {background-position-x:-768px}
.flag2x.flag-_y {background-position-y:-528px}
.flag2x.flag-z {background-position-x:-800px}
.flag2x.flag-_z {background-position-y:-550px}
.flag3x {background-size:1248px 858px}
.flag3x.flag-sprite {width:48px;height:33px;}
.flag3x.flag-a {background-position-x:0}
.flag3x.flag-_a {background-position-y:0}
.flag3x.flag-b {background-position-x:-48px}
.flag3x.flag-_b {background-position-y:-33px}
.flag3x.flag-c {background-position-x:-96px}
.flag3x.flag-_c {background-position-y:-66px}
.flag3x.flag-d {background-position-x:-144px}
.flag3x.flag-_d {background-position-y:-99px}
.flag3x.flag-e {background-position-x:-192px}
.flag3x.flag-_e {background-position-y:-132px}
.flag3x.flag-f {background-position-x:-240px}
.flag3x.flag-_f {background-position-y:-165px}
.flag3x.flag-g {background-position-x:-288px}
.flag3x.flag-_g {background-position-y:-198px}
.flag3x.flag-h {background-position-x:-336px}
.flag3x.flag-_h {background-position-y:-231px}
.flag3x.flag-i {background-position-x:-384px}
.flag3x.flag-_i {background-position-y:-264px}
.flag3x.flag-j {background-position-x:-432px}
.flag3x.flag-_j {background-position-y:-297px}
.flag3x.flag-k {background-position-x:-480px}
.flag3x.flag-_k {background-position-y:-330px}
.flag3x.flag-l {background-position-x:-528px}
.flag3x.flag-_l {background-position-y:-363px}
.flag3x.flag-m {background-position-x:-576px}
.flag3x.flag-_m {background-position-y:-396px}
.flag3x.flag-n {background-position-x:-624px}
.flag3x.flag-_n {background-position-y:-429px}
.flag3x.flag-o {background-position-x:-672px}
.flag3x.flag-_o {background-position-y:-462px}
.flag3x.flag-p {background-position-x:-720px}
.flag3x.flag-_p {background-position-y:-495px}
.flag3x.flag-q {background-position-x:-768px}
.flag3x.flag-_q {background-position-y:-528px}
.flag3x.flag-r {background-position-x:-816px}
.flag3x.flag-_r {background-position-y:-561px}
.flag3x.flag-s {background-position-x:-864px}
.flag3x.flag-_s {background-position-y:-594px}
.flag3x.flag-t {background-position-x:-912px}
.flag3x.flag-_t {background-position-y:-627px}
.flag3x.flag-u {background-position-x:-960px}
.flag3x.flag-_u {background-position-y:-660px}
.flag3x.flag-v {background-position-x:-1008px}
.flag3x.flag-_v {background-position-y:-693px}
.flag3x.flag-w {background-position-x:-1056px}
.flag3x.flag-_w {background-position-y:-726px}
.flag3x.flag-x {background-position-x:-1104px}
.flag3x.flag-_x {background-position-y:-759px}
.flag3x.flag-y {background-position-x:-1152px}
.flag3x.flag-_y {background-position-y:-792px}
.flag3x.flag-z {background-position-x:-1200px}
.flag3x.flag-_z {background-position-y:-825px}
.flag4x {background-size:1664px 1144px}
.flag4x.flag-sprite {width:64px;height:44px;}
.flag4x.flag-a {background-position-x:0}
.flag4x.flag-_a {background-position-y:0}
.flag4x.flag-b {background-position-x:-64px}
.flag4x.flag-_b {background-position-y:-44px}
.flag4x.flag-c {background-position-x:-128px}
.flag4x.flag-_c {background-position-y:-88px}
.flag4x.flag-d {background-position-x:-192px}
.flag4x.flag-_d {background-position-y:-132px}
.flag4x.flag-e {background-position-x:-256px}
.flag4x.flag-_e {background-position-y:-176px}
.flag4x.flag-f {background-position-x:-320px}
.flag4x.flag-_f {background-position-y:-220px}
.flag4x.flag-g {background-position-x:-384px}
.flag4x.flag-_g {background-position-y:-264px}
.flag4x.flag-h {background-position-x:-448px}
.flag4x.flag-_h {background-position-y:-308px}
.flag4x.flag-i {background-position-x:-512px}
.flag4x.flag-_i {background-position-y:-352px}
.flag4x.flag-j {background-position-x:-576px}
.flag4x.flag-_j {background-position-y:-396px}
.flag4x.flag-k {background-position-x:-640px}
.flag4x.flag-_k {background-position-y:-440px}
.flag4x.flag-l {background-position-x:-704px}
.flag4x.flag-_l {background-position-y:-484px}
.flag4x.flag-m {background-position-x:-768px}
.flag4x.flag-_m {background-position-y:-528px}
.flag4x.flag-n {background-position-x:-832px}
.flag4x.flag-_n {background-position-y:-572px}
.flag4x.flag-o {background-position-x:-896px}
.flag4x.flag-_o {background-position-y:-616px}
.flag4x.flag-p {background-position-x:-960px}
.flag4x.flag-_p {background-position-y:-660px}
.flag4x.flag-q {background-position-x:-1024px}
.flag4x.flag-_q {background-position-y:-704px}
.flag4x.flag-r {background-position-x:-1088px}
.flag4x.flag-_r {background-position-y:-748px}
.flag4x.flag-s {background-position-x:-1152px}
.flag4x.flag-_s {background-position-y:-792px}
.flag4x.flag-t {background-position-x:-1216px}
.flag4x.flag-_t {background-position-y:-836px}
.flag4x.flag-u {background-position-x:-1280px}
.flag4x.flag-_u {background-position-y:-880px}
.flag4x.flag-v {background-position-x:-1344px}
.flag4x.flag-_v {background-position-y:-924px}
.flag4x.flag-w {background-position-x:-1408px}
.flag4x.flag-_w {background-position-y:-968px}
.flag4x.flag-x {background-position-x:-1472px}
.flag4x.flag-_x {background-position-y:-1012px}
.flag4x.flag-y {background-position-x:-1536px}
.flag4x.flag-_y {background-position-y:-1056px}
.flag4x.flag-z {background-position-x:-1600px}
.flag4x.flag-_z {background-position-y:-1100px}


========== staticfiles/flags/sprite.css ==========
.flag-sprite {display: inline-block;width:16px;height:11px;image-rendering:-moz-crisp-edges;image-rendering:pixelated;image-rendering:-o-crisp-edges;-ms-interpolation-mode:nearest-neighbor;background-image:url('sprite.png')}
.flag-a {background-position-x:0}
.flag-_a {background-position-y:0}
.flag-b {background-position-x:-16px}
.flag-_b {background-position-y:-11px}
.flag-c {background-position-x:-32px}
.flag-_c {background-position-y:-22px}
.flag-d {background-position-x:-48px}
.flag-_d {background-position-y:-33px}
.flag-e {background-position-x:-64px}
.flag-_e {background-position-y:-44px}
.flag-f {background-position-x:-80px}
.flag-_f {background-position-y:-55px}
.flag-g {background-position-x:-96px}
.flag-_g {background-position-y:-66px}
.flag-h {background-position-x:-112px}
.flag-_h {background-position-y:-77px}
.flag-i {background-position-x:-128px}
.flag-_i {background-position-y:-88px}
.flag-j {background-position-x:-144px}
.flag-_j {background-position-y:-99px}
.flag-k {background-position-x:-160px}
.flag-_k {background-position-y:-110px}
.flag-l {background-position-x:-176px}
.flag-_l {background-position-y:-121px}
.flag-m {background-position-x:-192px}
.flag-_m {background-position-y:-132px}
.flag-n {background-position-x:-208px}
.flag-_n {background-position-y:-143px}
.flag-o {background-position-x:-224px}
.flag-_o {background-position-y:-154px}
.flag-p {background-position-x:-240px}
.flag-_p {background-position-y:-165px}
.flag-q {background-position-x:-256px}
.flag-_q {background-position-y:-176px}
.flag-r {background-position-x:-272px}
.flag-_r {background-position-y:-187px}
.flag-s {background-position-x:-288px}
.flag-_s {background-position-y:-198px}
.flag-t {background-position-x:-304px}
.flag-_t {background-position-y:-209px}
.flag-u {background-position-x:-320px}
.flag-_u {background-position-y:-220px}
.flag-v {background-position-x:-336px}
.flag-_v {background-position-y:-231px}
.flag-w {background-position-x:-352px}
.flag-_w {background-position-y:-242px}
.flag-x {background-position-x:-368px}
.flag-_x {background-position-y:-253px}
.flag-y {background-position-x:-384px}
.flag-_y {background-position-y:-264px}
.flag-z {background-position-x:-400px}
.flag-_z {background-position-y:-275px}


========== tracking/migrations/__init__.py ==========



========== tracking/tests.py ==========
from django.test import TestCase

# Create your tests here.



========== tracking/admin.py ==========
from django.contrib import admin



========== tracking/__init__.py ==========



========== tracking/apps.py ==========
from django.apps import AppConfig


class TrackingConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "tracking"



========== tracking/urls.py ==========
from django.urls import path

app_name = 'tracking'
urlpatterns = []



========== tracking/models.py ==========
from django.db import models

# Create your models here.



========== tracking/views.py ==========
from django.shortcuts import render

# Create your views here.



========== users/templates/users/register.html ==========
{# ~/ebi3/users/templates/users/register.html #}
{% extends 'users/base_auth.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Inscription - Ebi3" %}{% endblock %}

{% block content %}
<h2 class="text-center mb-4">{% trans "Créer un compte" %}</h2>

<form method="post" novalidate>
    {% csrf_token %}

    {{ form|crispy }}

    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="terms" required>
        <label class="form-check-label" for="terms">
            {% trans "J'accepte les" %}
            <a href="{% url 'core:terms' %}">{% trans "conditions d'utilisation" %}</a>
            {% trans "et la" %}
            <a href="{% url 'core:privacy' %}">{% trans "politique de confidentialité" %}</a>
        </label>
    </div>

    <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary btn-lg">
            {% trans "S'inscrire" %}
        </button>
    </div>
</form>

<hr class="my-4">

<div class="text-center">
    <p class="mb-0">
        {% trans "Déjà un compte ?" %}
        <a href="{% url 'users:login' %}" class="text-decoration-none">
            {% trans "Connectez-vous" %}
        </a>
    </p>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="d-grid">
            <a href="#" class="btn btn-outline-dark">
                <i class="fab fa-google"></i> {% trans "Google" %}
            </a>
        </div>
    </div>
    <div class="col-md-6">
        <div class="d-grid">
            <a href="#" class="btn btn-outline-primary">
                <i class="fab fa-facebook"></i> {% trans "Facebook" %}
            </a>
        </div>
    </div>
</div>
{% endblock %}


========== users/templates/users/login.html ==========
{# ~/ebi3/users/templates/users/login.html #}
{% extends 'users/base_auth.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans "Connexion - Ebi3" %}{% endblock %}

{% block content %}
<h2 class="text-center mb-4">{% trans "Connexion" %}</h2>

<form method="post" novalidate>
    {% csrf_token %}

    {{ form|crispy }}

    <div class="d-grid gap-2 mb-3">
        <button type="submit" class="btn btn-primary btn-lg">
            {% trans "Se connecter" %}
        </button>
    </div>

    <div class="text-center">
        <a href="{% url 'users:password_reset' %}" class="text-decoration-none">
            {% trans "Mot de passe oublié ?" %}
        </a>
    </div>
</form>

<hr class="my-4">

<div class="text-center">
    <p class="mb-0">
        {% trans "Pas encore de compte ?" %}
        <a href="{% url 'users:register' %}" class="text-decoration-none">
            {% trans "Inscrivez-vous" %}
        </a>
    </p>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="d-grid">
            <a href="#" class="btn btn-outline-dark">
                <i class="fab fa-google"></i> {% trans "Google" %}
            </a>
        </div>
    </div>
    <div class="col-md-6">
        <div class="d-grid">
            <a href="#" class="btn btn-outline-primary">
                <i class="fab fa-facebook"></i> {% trans "Facebook" %}
            </a>
        </div>
    </div>
</div>
{% endblock %}


========== users/templates/users/profile.html ==========
{# ~/ebi3/users/templates/users/profile.html #}
{% extends 'core/base.html' %}
{% load i18n %}

{% block title %}{% trans "Profil de" %} {{ user_profile.username }} - Ebi3{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- En-tête du profil -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-2 text-center">
                            <div class="avatar-circle bg-primary mb-3" style="width: 100px; height: 100px;">
                                <span class="avatar-text" style="font-size: 2.5rem;">
                                    {{ user_profile.username|first|upper }}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-10">
                            <h1 class="mb-0">{{ user_profile.get_full_name|default:user_profile.username }}</h1>
                            <p class="text-muted">
                                <i class="fas fa-user-tag"></i>
                                {{ user_profile.get_role_display }}
                            </p>

                            {% if user_profile.is_verified %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle"></i> {% trans "Vérifié" %}
                                </span>
                            {% endif %}

                            {% if user_profile.kyc_verified %}
                                <span class="badge bg-info">
                                    <i class="fas fa-id-card"></i> {% trans "KYC Vérifié" %}
                                </span>
                            {% endif %}

                            {% if user_profile.rating > 0 %}
                                <div class="mt-2">
                                    <span class="text-warning">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= user_profile.rating %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </span>
                                    <span class="text-muted">({{ user_profile.total_reviews }} {% trans "avis" %})</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Informations personnelles -->
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user"></i> {% trans "Informations personnelles" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>{% trans "Email :" %}</strong> {{ user_profile.email }}</p>
                            <p><strong>{% trans "Téléphone :" %}</strong> {{ user_profile.phone_number|default:"-" }}</p>
                            <p><strong>{% trans "Pays :" %}</strong> {{ user_profile.country.name|default:"-" }}</p>
                            <p><strong>{% trans "Ville :" %}</strong> {{ user_profile.city|default:"-" }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>{% trans "Membre depuis :" %}</strong> {{ user_profile.date_joined|date:"d/m/Y" }}</p>
                            <p><strong>{% trans "Langue préférée :" %}</strong> {{ user_profile.get_preferred_language_display }}</p>

                            {% if user_profile.profile %}
                                <p><strong>{% trans "Pays d'origine :" %}</strong>
                                    {{ user_profile.profile.country_of_origin.name|default:"-" }}
                                </p>
                                <p><strong>{% trans "Pays de résidence :" %}</strong>
                                    {{ user_profile.profile.country_of_residence.name|default:"-" }}
                                </p>
                            {% endif %}
                        </div>
                    </div>

                    {% if request.user == user_profile %}
                        <div class="mt-3">
                            <a href="{% url 'users:profile_edit' request.user.username %}"
                               class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i> {% trans "Modifier le profil" %}
                            </a>

                            <a href="{% url 'users:profile_edit_extended' request.user.username %}"
                               class="btn btn-outline-secondary">
                                <i class="fas fa-info-circle"></i> {% trans "Informations supplémentaires" %}
                            </a>

                            <a href="{% url 'users:change_password' %}"
                               class="btn btn-outline-warning">
                                <i class="fas fa-key"></i> {% trans "Changer le mot de passe" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Pour les transporteurs -->
            {% if user_profile.is_carrier %}
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-truck"></i> {% trans "Informations Transporteur" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if user_profile.profile.company_name %}
                            <p><strong>{% trans "Entreprise :" %}</strong> {{ user_profile.profile.company_name }}</p>
                        {% endif %}

                        {% if user_profile.is_available %}
                            <span class="badge bg-success">
                                <i class="fas fa-check"></i> {% trans "Disponible pour des missions" %}
                            </span>
                        {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-times"></i> {% trans "Indisponible" %}
                            </span>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Vérifications -->
            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt"></i> {% trans "Vérifications" %}
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {% trans "Email" %}
                            {% if user_profile.email_verified %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle"></i>
                                </span>
                            {% else %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-exclamation-circle"></i>
                                </span>
                            {% endif %}
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {% trans "Téléphone" %}
                            {% if user_profile.phone_verified %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle"></i>
                                </span>
                            {% else %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-exclamation-circle"></i>
                                </span>
                            {% endif %}
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {% trans "KYC" %}
                            {% if user_profile.kyc_verified %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle"></i>
                                </span>
                            {% else %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-times-circle"></i>
                                </span>
                            {% endif %}
                        </li>
                    </ul>

                    {% if request.user == user_profile and not user_profile.kyc_verified %}
                        <div class="mt-3">
                            <a href="{% url 'users:kyc_verification' %}"
                               class="btn btn-primary btn-sm w-100">
                                <i class="fas fa-id-card"></i> {% trans "Vérifier mon identité" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Statistiques -->
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> {% trans "Statistiques" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if user_profile.profile %}
                        <div class="text-center">
                            <h3>{{ user_profile.profile.successful_transactions }}</h3>
                            <p class="text-muted">{% trans "Transactions réussies" %}</p>

                            <h3>{{ user_profile.profile.total_ads }}</h3>
                            <p class="text-muted">{% trans "Annonces publiées" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.avatar-text {
    line-height: 1;
}
</style>
{% endblock %}


========== users/templates/users/base_auth.html ==========
<!DOCTYPE html>
{% load static i18n crispy_forms_tags %}
{% get_current_language as LANGUAGE_CODE %}
{% get_current_language_bidi as LANGUAGE_BIDI %}

<html lang="{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% trans "Ebi3 Platform" %}{% endblock %}</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- RTL support for Bootstrap if Arabic -->
    {% if LANGUAGE_CODE == 'ar' %}
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-rtl@3.4.0/dist/css/bootstrap-rtl.min.css" rel="stylesheet">
    {% endif %}

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }

        .auth-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .auth-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .auth-logo {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .auth-body {
            padding: 2rem;
        }

        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .auth-footer {
            padding: 1rem;
            text-align: center;
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }

        /* Style pour le lien du logo */
        .logo-link {
            transition: transform 0.3s ease, opacity 0.3s ease;
            text-decoration: none !important;
        }

        .logo-link:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Language Switcher -->
    <div class="language-switcher">
        <form action="{% url 'set_language' %}" method="post">
            {% csrf_token %}
            <select name="language" class="form-select form-select-sm" onchange="this.form.submit()">
                {% get_available_languages as LANGUAGES %}
                {% for lang_code, lang_name in LANGUAGES %}
                    <option value="{{ lang_code }}"
                            {% if lang_code == LANGUAGE_CODE %}selected{% endif %}>
                        {{ lang_name }}
                    </option>
                {% endfor %}
            </select>
        </form>
    </div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="auth-container">
                    <div class="auth-header">
                        <!-- LOGO MODIFIÉ ICI - MAINTENANT CLICABLE -->
                        <div class="auth-logo">
                            <a href="{% url 'core:home' %}" class="text-white logo-link">
                                EBI3
                            </a>
                        </div>
                        <p class="mb-0">{% trans "Plateforme Logistique Transfrontalière" %}</p>
                    </div>

                    <div class="auth-body">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        {% block content %}{% endblock %}
                    </div>

                    <div class="auth-footer">
                        <p class="mb-0">
                            {% trans "© 2024 Ebi3 Platform. Tous droits réservés." %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    {% block extra_js %}{% endblock %}
</body>
</html>


========== users/migrations/0001_initial.py ==========
# Generated by Django 6.0 on 2025-12-31 08:04

import django.contrib.auth.models
import django.contrib.auth.validators
import django.db.models.deletion
import django.utils.timezone
import django_countries.fields
import phonenumber_field.modelfields
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("auth", "0012_alter_user_first_name_max_length"),
    ]

    operations = [
        migrations.CreateModel(
            name="User",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("password", models.CharField(max_length=128, verbose_name="password")),
                (
                    "last_login",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="last login"
                    ),
                ),
                (
                    "is_superuser",
                    models.BooleanField(
                        default=False,
                        help_text="Designates that this user has all permissions without explicitly assigning them.",
                        verbose_name="superuser status",
                    ),
                ),
                (
                    "username",
                    models.CharField(
                        error_messages={
                            "unique": "A user with that username already exists."
                        },
                        help_text="Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.",
                        max_length=150,
                        unique=True,
                        validators=[
                            django.contrib.auth.validators.UnicodeUsernameValidator()
                        ],
                        verbose_name="username",
                    ),
                ),
                (
                    "first_name",
                    models.CharField(
                        blank=True, max_length=150, verbose_name="first name"
                    ),
                ),
                (
                    "last_name",
                    models.CharField(
                        blank=True, max_length=150, verbose_name="last name"
                    ),
                ),
                (
                    "email",
                    models.EmailField(
                        blank=True, max_length=254, verbose_name="email address"
                    ),
                ),
                (
                    "is_staff",
                    models.BooleanField(
                        default=False,
                        help_text="Designates whether the user can log into this admin site.",
                        verbose_name="staff status",
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(
                        default=True,
                        help_text="Designates whether this user should be treated as active. Unselect this instead of deleting accounts.",
                        verbose_name="active",
                    ),
                ),
                (
                    "date_joined",
                    models.DateTimeField(
                        default=django.utils.timezone.now, verbose_name="date joined"
                    ),
                ),
                (
                    "role",
                    models.CharField(
                        choices=[
                            ("BUYER", "Acheteur"),
                            ("SELLER", "Vendeur"),
                            ("CARRIER", "Transporteur Professionnel"),
                            ("CARRIER_PERSONAL", "Transporteur Particulier"),
                            ("ADMIN", "Administrateur"),
                            ("MODERATOR", "Modérateur"),
                        ],
                        default="BUYER",
                        max_length=20,
                        verbose_name="Rôle",
                    ),
                ),
                (
                    "phone_number",
                    phonenumber_field.modelfields.PhoneNumberField(
                        blank=True,
                        max_length=128,
                        null=True,
                        region=None,
                        verbose_name="Numéro de téléphone",
                    ),
                ),
                (
                    "country",
                    django_countries.fields.CountryField(
                        blank=True, max_length=2, null=True, verbose_name="Pays"
                    ),
                ),
                (
                    "city",
                    models.CharField(blank=True, max_length=100, verbose_name="Ville"),
                ),
                ("address", models.TextField(blank=True, verbose_name="Adresse")),
                (
                    "is_verified",
                    models.BooleanField(default=False, verbose_name="Compte vérifié"),
                ),
                (
                    "kyc_verified",
                    models.BooleanField(default=False, verbose_name="KYC vérifié"),
                ),
                (
                    "email_verified",
                    models.BooleanField(default=False, verbose_name="Email vérifié"),
                ),
                (
                    "phone_verified",
                    models.BooleanField(
                        default=False, verbose_name="Téléphone vérifié"
                    ),
                ),
                (
                    "kyc_submitted",
                    models.BooleanField(default=False, verbose_name="KYC soumis"),
                ),
                (
                    "created_at",
                    models.DateTimeField(
                        auto_now_add=True, verbose_name="Date de création"
                    ),
                ),
                (
                    "updated_at",
                    models.DateTimeField(
                        auto_now=True, verbose_name="Date de mise à jour"
                    ),
                ),
                (
                    "preferred_language",
                    models.CharField(
                        choices=[
                            ("ar", "العربية"),
                            ("fr", "Français"),
                            ("en", "English"),
                            ("de", "Deutsch"),
                            ("it", "Italiano"),
                            ("es", "Español"),
                            ("pt", "Português"),
                            ("pl", "Polski"),
                        ],
                        default="fr",
                        max_length=10,
                        verbose_name="Langue préférée",
                    ),
                ),
                (
                    "is_available",
                    models.BooleanField(
                        default=True, verbose_name="Disponible pour des missions"
                    ),
                ),
                (
                    "rating",
                    models.DecimalField(
                        decimal_places=2,
                        default=0.0,
                        max_digits=3,
                        verbose_name="Note moyenne",
                    ),
                ),
                (
                    "total_reviews",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Nombre total d'avis"
                    ),
                ),
                (
                    "groups",
                    models.ManyToManyField(
                        blank=True,
                        help_text="The groups this user belongs to. A user will get all permissions granted to each of their groups.",
                        related_name="user_set",
                        related_query_name="user",
                        to="auth.group",
                        verbose_name="groups",
                    ),
                ),
                (
                    "user_permissions",
                    models.ManyToManyField(
                        blank=True,
                        help_text="Specific permissions for this user.",
                        related_name="user_set",
                        related_query_name="user",
                        to="auth.permission",
                        verbose_name="user permissions",
                    ),
                ),
            ],
            options={
                "verbose_name": "Utilisateur",
                "verbose_name_plural": "Utilisateurs",
                "ordering": ["-date_joined"],
            },
            managers=[
                ("objects", django.contrib.auth.models.UserManager()),
            ],
        ),
        migrations.CreateModel(
            name="UserProfile",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "date_of_birth",
                    models.DateField(
                        blank=True, null=True, verbose_name="Date de naissance"
                    ),
                ),
                (
                    "gender",
                    models.CharField(
                        blank=True,
                        choices=[("M", "Masculin"), ("F", "Féminin"), ("O", "Autre")],
                        max_length=10,
                        verbose_name="Genre",
                    ),
                ),
                (
                    "company_name",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Nom de l'entreprise"
                    ),
                ),
                (
                    "company_registration",
                    models.CharField(
                        blank=True,
                        max_length=100,
                        verbose_name="Numéro d'immatriculation",
                    ),
                ),
                (
                    "tax_id",
                    models.CharField(
                        blank=True, max_length=100, verbose_name="Numéro fiscal"
                    ),
                ),
                (
                    "id_document",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="documents/id/",
                        verbose_name="Document d'identité",
                    ),
                ),
                (
                    "proof_of_address",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="documents/address/",
                        verbose_name="Justificatif de domicile",
                    ),
                ),
                (
                    "company_registration_doc",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="documents/company/",
                        verbose_name="Document d'immatriculation",
                    ),
                ),
                (
                    "country_of_origin",
                    django_countries.fields.CountryField(
                        blank=True,
                        max_length=2,
                        null=True,
                        verbose_name="Pays d'origine",
                    ),
                ),
                (
                    "country_of_residence",
                    django_countries.fields.CountryField(
                        blank=True,
                        max_length=2,
                        null=True,
                        verbose_name="Pays de résidence",
                    ),
                ),
                (
                    "is_expatriate",
                    models.BooleanField(default=False, verbose_name="Est un expatrié"),
                ),
                (
                    "total_ads",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Nombre total d'annonces"
                    ),
                ),
                (
                    "successful_transactions",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Transactions réussies"
                    ),
                ),
                (
                    "created_at",
                    models.DateTimeField(
                        auto_now_add=True, verbose_name="Date de création"
                    ),
                ),
                (
                    "updated_at",
                    models.DateTimeField(
                        auto_now=True, verbose_name="Date de mise à jour"
                    ),
                ),
                (
                    "user",
                    models.OneToOneField(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="profile",
                        to=settings.AUTH_USER_MODEL,
                        verbose_name="Utilisateur",
                    ),
                ),
            ],
            options={
                "verbose_name": "Profil utilisateur",
                "verbose_name_plural": "Profils utilisateurs",
            },
        ),
    ]



========== users/migrations/__init__.py ==========



========== users/tests.py ==========
# ~/ebi3/users/tests.py
from django.test import TestCase
from django.urls import reverse
from .models import User

class UserModelTests(TestCase):
    def test_user_creation(self):
        """Test la création d'un utilisateur"""
        user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='testpass123',
            role=User.Role.SELLER,
            country='FR',
            city='Paris'
        )
        self.assertEqual(user.username, 'testuser')
        self.assertEqual(user.role, User.Role.SELLER)
        self.assertTrue(user.check_password('testpass123'))

    def test_is_carrier_method(self):
        """Test la méthode is_carrier"""
        carrier = User.objects.create_user(
            username='carrier',
            password='testpass123',
            role=User.Role.CARRIER
        )
        self.assertTrue(carrier.is_carrier())

class UserViewsTests(TestCase):
    def test_register_view(self):
        """Test la vue d'inscription"""
        response = self.client.get(reverse('users:register'))
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'users/register.html')


========== users/signals.py ==========
# ~/ebi3/users/signals.py
from django.db.models.signals import post_save
from django.dispatch import receiver
from .models import User, UserProfile

@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
    """Crée automatiquement un profil lorsqu'un utilisateur est créé"""
    if created:
        UserProfile.objects.create(user=instance)

@receiver(post_save, sender=User)
def save_user_profile(sender, instance, **kwargs):
    """Sauvegarde automatiquement le profil"""
    if hasattr(instance, 'profile'):
        instance.profile.save()


========== users/admin.py ==========
# ~/ebi3/users/admin.py
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
from django.utils.translation import gettext_lazy as _
from .models import User, UserProfile

class UserProfileInline(admin.StackedInline):
    model = UserProfile
    can_delete = False
    verbose_name_plural = _('Profil')
    fk_name = 'user'
    fieldsets = (
        (_('Informations personnelles'), {
            'fields': ('date_of_birth', 'gender', 'country_of_origin',
                      'country_of_residence', 'is_expatriate')
        }),
        (_('Informations professionnelles'), {
            'fields': ('company_name', 'company_registration', 'tax_id')
        }),
        (_('Documents'), {
            'fields': ('id_document', 'proof_of_address', 'company_registration_doc'),
            'classes': ('collapse',)
        }),
        (_('Statistiques'), {
            'fields': ('total_ads', 'successful_transactions'),
            'classes': ('collapse',)
        }),
    )

@admin.register(User)
class UserAdmin(BaseUserAdmin):
    list_display = ('username', 'email', 'role', 'country', 'is_verified',
                   'is_active', 'date_joined')
    list_filter = ('role', 'is_verified', 'is_active', 'country')
    search_fields = ('username', 'email', 'first_name', 'last_name', 'city')

    fieldsets = (
        (None, {'fields': ('username', 'password')}),
        (_('Informations personnelles'), {
            'fields': ('first_name', 'last_name', 'email', 'phone_number')
        }),
        (_('Localisation'), {
            'fields': ('country', 'city', 'address')
        }),
        (_('Rôles et permissions'), {
            'fields': ('role', 'is_verified', 'kyc_verified',
                      'email_verified', 'phone_verified',
                      'is_staff', 'is_active', 'is_superuser',
                      'groups', 'user_permissions')
        }),
        (_('Préférences'), {
            'fields': ('preferred_language',)
        }),
        (_('Dates importantes'), {
            'fields': ('last_login', 'date_joined', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    readonly_fields = ('last_login', 'date_joined', 'created_at', 'updated_at')
    inlines = (UserProfileInline,)

    def get_inline_instances(self, request, obj=None):
        if not obj:
            return list()
        return super().get_inline_instances(request, obj)

@admin.register(UserProfile)
class UserProfileAdmin(admin.ModelAdmin):
    list_display = ('user', 'company_name', 'is_expatriate', 'created_at')
    list_filter = ('is_expatriate', 'gender')
    search_fields = ('user__username', 'user__email', 'company_name')
    raw_id_fields = ('user',)

    # ✅ CORRECTION : actions doit être une liste, pas une méthode
    actions = []


========== users/forms.py ==========
# ~/ebi3/users/forms.py
from django import forms
from django.contrib.auth.forms import UserCreationForm, UserChangeForm
from django.utils.translation import gettext_lazy as _
from .models import User, UserProfile

class CustomUserCreationForm(UserCreationForm):
    """Formulaire pour créer un nouvel utilisateur avec des champs supplémentaires"""

    phone_number = forms.CharField(
        label=_("Numéro de téléphone"),
        required=True,
        help_text=_("Format international : +212612345678 (recommandé) ou 00212612345678"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("+212612345678"),
            'title': _("Entrez votre numéro au format international")
        })
    )

    class Meta:
        model = User
        fields = ('username', 'email', 'role', 'phone_number',
                 'country', 'city', 'preferred_language')
        widgets = {
            'role': forms.Select(attrs={'class': 'form-control'}),
            'preferred_language': forms.Select(attrs={'class': 'form-control'}),
        }

    def clean_phone_number(self):
        """Valide et formate le numéro de téléphone"""
        phone_number = self.cleaned_data.get('phone_number')

        if phone_number:
            try:
                # Nettoyer le numéro : supprimer les espaces, tirets, etc.
                phone_number = phone_number.strip().replace(' ', '').replace('-', '').replace('.', '')

                # Convertir les formats locaux en format international
                if phone_number.startswith('0'):
                    # L'utilisateur a entré un format local (ex: 0612345678)
                    country = self.cleaned_data.get('country')

                    if country:
                        # Mapper les codes pays
                        country_codes = {
                            'MA': '212',  # Maroc
                            'FR': '33',   # France
                            'BE': '32',   # Belgique
                            'TN': '216',  # Tunisie
                            'DZ': '213',  # Algérie
                            'SN': '221',  # Sénégal
                            'CI': '225',  # Côte d'Ivoire
                            'CM': '237',  # Cameroun
                            'US': '1',    # États-Unis
                            'GB': '44',   # Royaume-Uni
                            'DE': '49',   # Allemagne
                            'ES': '34',   # Espagne
                            'IT': '39',   # Italie
                            'PT': '351',  # Portugal
                            # Ajoutez d'autres pays selon vos besoins
                        }

                        code = country_codes.get(country.code, '')
                        if code:
                            # Enlever le 0 initial et ajouter le code pays
                            phone_number = f"+{code}{phone_number[1:]}"
                        else:
                            # Code pays non trouvé, laisser tel quel
                            pass

                # Convertir 00 en + si présent (format 00212...)
                elif phone_number.startswith('00'):
                    phone_number = '+' + phone_number[2:]

                # S'assurer que le numéro commence par +
                if not phone_number.startswith('+'):
                    phone_number = '+' + phone_number

                # Validation de la longueur minimale
                if len(phone_number) < 10:  # +212612345678 = 13 caractères
                    raise forms.ValidationError(
                        _("Numéro de téléphone trop court. Format attendu : +212612345678")
                    )

                # Validation que le numéro ne contient que des chiffres après le +
                if not phone_number[1:].isdigit():
                    raise forms.ValidationError(
                        _("Le numéro de téléphone ne doit contenir que des chiffres après le +")
                    )

                return phone_number

            except Exception as e:
                raise forms.ValidationError(
                    _("Saisissez un numéro de téléphone valide. Format: +212612345678 ou 0612345678")
                )

        return phone_number

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Améliorer les champs existants
        self.fields['username'].widget.attrs.update({
            'class': 'form-control',
            'placeholder': _("Choisissez un nom d'utilisateur")
        })
        self.fields['email'].widget.attrs.update({
            'class': 'form-control',
            'placeholder': _("votre@email.com")
        })
        self.fields['country'].widget.attrs.update({
            'class': 'form-control'
        })
        self.fields['city'].widget.attrs.update({
            'class': 'form-control',
            'placeholder': _("Votre ville")
        })
        self.fields['city'].required = False  # Rendre optionnel

        # Rendre le pays obligatoire pour aider à la validation du téléphone
        self.fields['country'].required = True

        # Ajouter une aide pour le format du téléphone
        self.fields['phone_number'].help_text += _(
            "<br><small class='text-muted'>Exemples: +212612345678 (Maroc), +33612345678 (France), +32456123456 (Belgique)</small>"
        )
class CustomUserChangeForm(UserChangeForm):
    """Formulaire pour modifier un utilisateur existant"""

    class Meta:
        model = User
        fields = ('username', 'email', 'role', 'phone_number',
                 'country', 'city', 'address', 'preferred_language',
                 'is_verified', 'kyc_verified', 'is_active')


class LoginForm(forms.Form):
    """Formulaire de connexion"""
    username = forms.CharField(
        label=_("Nom d'utilisateur ou Email"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Entrez votre nom d'utilisateur ou email")
        })
    )
    password = forms.CharField(
        label=_("Mot de passe"),
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': _("Entrez votre mot de passe")
        })
    )
    remember_me = forms.BooleanField(
        required=False,
        label=_("Se souvenir de moi"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

class UserProfileForm(forms.ModelForm):
    """Formulaire pour le profil utilisateur étendu"""
    class Meta:
        model = UserProfile
        fields = [
            'date_of_birth', 'gender', 'company_name',
            'company_registration', 'tax_id', 'country_of_origin',
            'country_of_residence', 'is_expatriate'
        ]
        widgets = {
            'date_of_birth': forms.DateInput(
                attrs={'type': 'date', 'class': 'form-control'}
            ),
            'gender': forms.Select(attrs={'class': 'form-control'}),
        }

class PasswordResetRequestForm(forms.Form):
    """Formulaire pour demander une réinitialisation de mot de passe"""
    email = forms.EmailField(
        label=_("Email"),
        widget=forms.EmailInput(attrs={
            'class': 'form-control',
            'placeholder': _("Entrez votre email")
        })
    )

class PasswordResetConfirmForm(forms.Form):
    """Formulaire pour confirmer la réinitialisation du mot de passe"""
    new_password1 = forms.CharField(
        label=_("Nouveau mot de passe"),
        widget=forms.PasswordInput(attrs={'class': 'form-control'})
    )
    new_password2 = forms.CharField(
        label=_("Confirmer le nouveau mot de passe"),
        widget=forms.PasswordInput(attrs={'class': 'form-control'})
    )

class KYCVerificationForm(forms.ModelForm):
    """Formulaire pour la vérification KYC"""
    id_document = forms.FileField(
        label=_("Document d'identité"),
        required=True,
        widget=forms.FileInput(attrs={'class': 'form-control'})
    )
    proof_of_address = forms.FileField(
        label=_("Justificatif de domicile"),
        required=True,
        widget=forms.FileInput(attrs={'class': 'form-control'})
    )
    selfie_with_id = forms.FileField(
        label=_("Selfie avec document d'identité"),
        required=False,
        widget=forms.FileInput(attrs={'class': 'form-control'})
    )

    class Meta:
        model = User
        fields = []  # Aucun champ du modèle User, seulement les fichiers

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Logique spécifique pour les transporteurs professionnels
        if self.instance and self.instance.role == User.Role.CARRIER:
            self.fields['company_registration_doc'] = forms.FileField(
                label=_("Document d'immatriculation"),
                required=True,
                widget=forms.FileInput(attrs={'class': 'form-control'})
            )


========== users/__init__.py ==========
# ~/ebi3/users/__init__.py
default_app_config = 'users.apps.UsersConfig'


========== users/apps.py ==========
# ~/ebi3/users/apps.py
from django.apps import AppConfig

class UsersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'users'
    verbose_name = "Utilisateurs"

    def ready(self):
        import users.signals


========== users/urls.py ==========
# ~/ebi3/users/urls.py
from django.urls import path
from django.contrib.auth import views as auth_views
from . import views

app_name = 'users'

urlpatterns = [
    # Inscription et connexion
    path('register/', views.RegisterView.as_view(), name='register'),
    path('login/', views.LoginView.as_view(), name='login'),
    path('logout/', views.logout_view, name='logout'),

    # Profil
    path('profile/<str:username>/', views.ProfileView.as_view(), name='profile'),
    path('profile/<str:username>/edit/', views.ProfileUpdateView.as_view(), name='profile_edit'),
    path('profile/<str:username>/edit-extended/',
         views.UserProfileUpdateView.as_view(), name='profile_edit_extended'),

    # Sécurité
    path('change-password/', views.change_password, name='change_password'),

    # Vérifications
    path('verify/email/<str:token>/', views.EmailVerificationView.as_view(), name='verify_email'),
    path('verify/phone/', views.PhoneVerificationView.as_view(), name='verify_phone'),
    path('verify/kyc/', views.KYCVerificationView.as_view(), name='kyc_verification'),

    # Réinitialisation de mot de passe
    path('password-reset/',
         auth_views.PasswordResetView.as_view(
             template_name='users/password_reset.html',
             email_template_name='users/password_reset_email.html',
             success_url='/users/password-reset/done/'
         ),
         name='password_reset'),

    path('password-reset/done/',
         auth_views.PasswordResetDoneView.as_view(
             template_name='users/password_reset_done.html'
         ),
         name='password_reset_done'),

    path('password-reset-confirm/<uidb64>/<token>/',
         auth_views.PasswordResetConfirmView.as_view(
             template_name='users/password_reset_confirm.html',
             success_url='/users/password-reset-complete/'
         ),
         name='password_reset_confirm'),

    path('password-reset-complete/',
         auth_views.PasswordResetCompleteView.as_view(
             template_name='users/password_reset_complete.html'
         ),
         name='password_reset_complete'),
]


========== users/models.py ==========
# ~/ebi3/users/models.py
from django.contrib.auth.models import AbstractUser
from django.db import models
from django.utils.translation import gettext_lazy as _
from phonenumber_field.modelfields import PhoneNumberField
from django_countries.fields import CountryField

class User(AbstractUser):
    """Modèle utilisateur personnalisé pour la plateforme ebi3"""

    # Rôles disponibles
    class Role(models.TextChoices):
        BUYER = 'BUYER', _('Acheteur')
        SELLER = 'SELLER', _('Vendeur')
        CARRIER = 'CARRIER', _('Transporteur Professionnel')
        CARRIER_PERSONAL = 'CARRIER_PERSONAL', _('Transporteur Particulier')
        ADMIN = 'ADMIN', _('Administrateur')
        MODERATOR = 'MODERATOR', _('Modérateur')

    # Champs supplémentaires
    role = models.CharField(
        max_length=20,
        choices=Role.choices,
        default=Role.BUYER,
        verbose_name=_("Rôle")
    )

    phone_number = PhoneNumberField(
        verbose_name=_("Numéro de téléphone"),
        null=True,
        blank=True
    )

    country = CountryField(
        verbose_name=_("Pays"),
        blank=True,
        null=True
    )

    city = models.CharField(
        max_length=100,
        verbose_name=_("Ville"),
        blank=True
    )

    address = models.TextField(
        verbose_name=_("Adresse"),
        blank=True
    )

    # Vérification et statuts
    is_verified = models.BooleanField(
        default=False,
        verbose_name=_("Compte vérifié")
    )

    kyc_verified = models.BooleanField(
        default=False,
        verbose_name=_("KYC vérifié")
    )

    email_verified = models.BooleanField(
        default=False,
        verbose_name=_("Email vérifié")
    )

    phone_verified = models.BooleanField(
        default=False,
        verbose_name=_("Téléphone vérifié")
    )

    kyc_submitted = models.BooleanField(
        default=False,
        verbose_name=_("KYC soumis")
    )

    # Métadonnées
    created_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name=_("Date de création")
    )

    updated_at = models.DateTimeField(
        auto_now=True,
        verbose_name=_("Date de mise à jour")
    )

    # Préférences
    preferred_language = models.CharField(
        max_length=10,
        default='fr',
        choices=[
            ('ar', 'العربية'),
            ('fr', 'Français'),
            ('en', 'English'),
            ('de', 'Deutsch'),
            ('it', 'Italiano'),
            ('es', 'Español'),
            ('pt', 'Português'),
            ('pl', 'Polski'),
        ],
        verbose_name=_("Langue préférée")
    )

    # Pour transporteurs
    is_available = models.BooleanField(
        default=True,
        verbose_name=_("Disponible pour des missions")
    )

    rating = models.DecimalField(
        max_digits=3,
        decimal_places=2,
        default=0.00,
        verbose_name=_("Note moyenne")
    )

    total_reviews = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Nombre total d'avis")
    )

    class Meta:
        verbose_name = _("Utilisateur")
        verbose_name_plural = _("Utilisateurs")
        ordering = ['-date_joined']

    def __str__(self):
        return f"{self.username} ({self.get_role_display()})"

    def is_carrier(self):
        """Vérifie si l'utilisateur est un transporteur"""
        return self.role in [self.Role.CARRIER, self.Role.CARRIER_PERSONAL]

    def is_seller(self):
        """Vérifie si l'utilisateur est un vendeur"""
        return self.role == self.Role.SELLER

    def is_buyer(self):
        """Vérifie si l'utilisateur est un acheteur"""
        return self.role == self.Role.BUYER

# ~/ebi3/users/models.py (suite)
class UserProfile(models.Model):
    """Profil étendu pour les utilisateurs"""

    user = models.OneToOneField(
        User,
        on_delete=models.CASCADE,
        related_name='profile',
        verbose_name=_("Utilisateur")
    )

    # Informations personnelles
    date_of_birth = models.DateField(
        null=True,
        blank=True,
        verbose_name=_("Date de naissance")
    )

    gender = models.CharField(
        max_length=10,
        choices=[
            ('M', _('Masculin')),
            ('F', _('Féminin')),
            ('O', _('Autre')),
        ],
        blank=True,
        verbose_name=_("Genre")
    )

    # Pour transporteurs professionnels
    company_name = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Nom de l'entreprise")
    )

    company_registration = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Numéro d'immatriculation")
    )

    tax_id = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Numéro fiscal")
    )

    # Documents pour vérification
    id_document = models.FileField(
        upload_to='documents/id/',
        null=True,
        blank=True,
        verbose_name=_("Document d'identité")
    )

    proof_of_address = models.FileField(
        upload_to='documents/address/',
        null=True,
        blank=True,
        verbose_name=_("Justificatif de domicile")
    )

    company_registration_doc = models.FileField(
        upload_to='documents/company/',
        null=True,
        blank=True,
        verbose_name=_("Document d'immatriculation")
    )

    # Pour expatriés
    country_of_origin = CountryField(
        verbose_name=_("Pays d'origine"),
        blank=True,
        null=True
    )

    country_of_residence = CountryField(
        verbose_name=_("Pays de résidence"),
        blank=True,
        null=True
    )

    is_expatriate = models.BooleanField(
        default=False,
        verbose_name=_("Est un expatrié")
    )

    # Statistiques
    total_ads = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Nombre total d'annonces")
    )

    successful_transactions = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Transactions réussies")
    )

    # Métadonnées
    created_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name=_("Date de création")
    )

    updated_at = models.DateTimeField(
        auto_now=True,
        verbose_name=_("Date de mise à jour")
    )

    class Meta:
        verbose_name = _("Profil utilisateur")
        verbose_name_plural = _("Profils utilisateurs")

    def __str__(self):
        return f"Profil de {self.user.username}"




========== users/views.py ==========
# ~/ebi3/users/views.py
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth import login, logout, authenticate, update_session_auth_hash
from django.contrib.auth.decorators import login_required
from django.contrib.auth.forms import PasswordChangeForm
from django.contrib import messages
from django.utils.translation import gettext_lazy as _
from django.urls import reverse_lazy
from django.views.generic import CreateView, UpdateView, DetailView
from django.contrib.auth.mixins import LoginRequiredMixin
from django.views import View
from .forms import (
    CustomUserCreationForm,
    CustomUserChangeForm,
    UserProfileForm,
    LoginForm,
    PasswordResetRequestForm,
    PasswordResetConfirmForm,
    KYCVerificationForm
)
from .models import User, UserProfile

class RegisterView(CreateView):
    """Vue pour l'inscription des utilisateurs"""
    model = User
    form_class = CustomUserCreationForm
    template_name = 'users/register.html'
    success_url = reverse_lazy('users:login')

    def form_valid(self, form):
        response = super().form_valid(form)
        messages.success(
            self.request,
            _("Votre compte a été créé avec succès ! Veuillez vérifier votre email.")
        )
        return response

class LoginView(View):
    """Vue pour la connexion"""
    template_name = 'users/login.html'

    def get(self, request):
        if request.user.is_authenticated:
            return redirect('core:home')
        form = LoginForm()
        return render(request, self.template_name, {'form': form})

    def post(self, request):
        form = LoginForm(request.POST)
        if form.is_valid():
            username = form.cleaned_data['username']
            password = form.cleaned_data['password']
            user = authenticate(username=username, password=password)

            if user is not None:
                if user.is_active:
                    login(request, user)
                    next_url = request.GET.get('next', 'core:home')
                    messages.success(request, _("Connexion réussie !"))
                    return redirect(next_url)
                else:
                    messages.error(request, _("Votre compte est désactivé."))
            else:
                messages.error(request, _("Nom d'utilisateur ou mot de passe incorrect."))

        return render(request, self.template_name, {'form': form})

@login_required
def logout_view(request):
    """Vue pour la déconnexion"""
    logout(request)
    messages.success(request, _("Vous avez été déconnecté avec succès."))
    return redirect('core:home')

class ProfileView(LoginRequiredMixin, DetailView):
    """Vue pour afficher le profil"""
    model = User
    template_name = 'users/profile.html'
    context_object_name = 'user_profile'

    def get_object(self):
        return get_object_or_404(User, username=self.kwargs['username'])

class ProfileUpdateView(LoginRequiredMixin, UpdateView):
    """Vue pour modifier le profil"""
    model = User
    form_class = CustomUserChangeForm
    template_name = 'users/profile_update.html'
    success_url = reverse_lazy('users:profile')

    def get_object(self):
        return self.request.user

    def get_success_url(self):
        messages.success(self.request, _("Votre profil a été mis à jour avec succès."))
        return reverse_lazy('users:profile', kwargs={'username': self.request.user.username})

class UserProfileUpdateView(LoginRequiredMixin, UpdateView):
    """Vue pour modifier le profil étendu"""
    model = UserProfile
    form_class = UserProfileForm
    template_name = 'users/profile_extended_update.html'

    def get_object(self):
        return self.request.user.profile

    def get_success_url(self):
        messages.success(self.request, _("Vos informations supplémentaires ont été mises à jour."))
        return reverse_lazy('users:profile', kwargs={'username': self.request.user.username})

@login_required
def change_password(request):
    """Vue pour changer le mot de passe"""
    if request.method == 'POST':
        form = PasswordChangeForm(request.user, request.POST)
        if form.is_valid():
            user = form.save()
            update_session_auth_hash(request, user)
            messages.success(request, _("Votre mot de passe a été changé avec succès !"))
            return redirect('users:profile', username=request.user.username)
    else:
        form = PasswordChangeForm(request.user)

    return render(request, 'users/change_password.html', {'form': form})

class KYCVerificationView(LoginRequiredMixin, UpdateView):
    """Vue pour soumettre la vérification KYC"""
    model = User
    form_class = KYCVerificationForm
    template_name = 'users/kyc_verification.html'

    def get_object(self):
        return self.request.user

    def form_valid(self, form):
        user = form.save(commit=False)
        user.kyc_submitted = True  # Nous devons ajouter ce champ au modèle
        user.save()
        messages.success(
            self.request,
            _("Votre demande de vérification KYC a été soumise. Nous la traiterons sous 48h.")
        )
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('users:profile', kwargs={'username': self.request.user.username})

class EmailVerificationView(LoginRequiredMixin, View):
    """Vue pour vérifier l'email"""
    template_name = 'users/email_verification.html'

    def get(self, request, token):
        # Logique de vérification du token
        # À implémenter avec des tokens sécurisés
        return render(request, self.template_name)

class PhoneVerificationView(LoginRequiredMixin, View):
    """Vue pour vérifier le numéro de téléphone"""
    template_name = 'users/phone_verification.html'

    def get(self, request):
        return render(request, self.template_name)

    def post(self, request):
        # Logique d'envoi/validation de code SMS
        # À implémenter avec un service SMS
        return redirect('users:profile', username=request.user.username)


