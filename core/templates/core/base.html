{# ~/ebi3/core/templates/core/base.html #}
<!DOCTYPE html>
{% load static i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% get_current_language_bidi as LANGUAGE_BIDI %}
{% get_available_languages as LANGUAGES %}

<html lang="{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{ SITE_DESCRIPTION }}">

    <title>{% block title %}{{ SITE_NAME }}{% endblock %}</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap RTL pour l'arabe -->
    {% if LANGUAGE_CODE == 'ar' %}
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-rtl@3.4.0/dist/css/bootstrap-rtl.min.css" rel="stylesheet">
    {% endif %}

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <!-- RTL custom styles -->
    {% if LANGUAGE_BIDI %}
        <link rel="stylesheet" href="{% static 'css/rtl.css' %}">
    {% endif %}

    {% block extra_css %}{% endblock %}

    <!-- SEO Meta Tags -->
    {% block meta_tags %}
        <meta property="og:title" content="{% block og_title %}{{ SITE_NAME }}{% endblock %}">
        <meta property="og:description" content="{{ SITE_DESCRIPTION }}">
        <meta property="og:url" content="{{ SITE_URL }}">
        <meta property="og:type" content="website">
        <meta property="og:image" content="{% static 'img/og-image.png' %}">

        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="{{ SITE_NAME }}">
        <meta name="twitter:description" content="{{ SITE_DESCRIPTION }}">
    {% endblock %}
</head>
<body class="d-flex flex-column min-vh-100" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Header -->
    <header>
        <!-- Top Bar -->
        <div class="top-bar bg-primary text-white py-2">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-phone me-2"></i>
                            <span>{{ PHONE_NUMBER }}</span>
                            <i class="fas fa-envelope ms-3 me-2"></i>
                            <span>{{ CONTACT_EMAIL }}</span>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="d-flex align-items-center justify-content-end">
                            <!-- Sélecteur de langue -->
                            <form action="{% url 'set_language' %}" method="post" class="me-3">
                                {% csrf_token %}
                                <input name="next" type="hidden" value="{{ request.path }}">
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <select name="language" class="form-select form-select-sm" onchange="this.form.submit()">
                                        {% for lang_code, lang_name in LANGUAGES %}
                                            <option value="{{ lang_code }}"
                                                    {% if lang_code == LANGUAGE_CODE %}selected{% endif %}>
                                                {{ lang_name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </form>

                            <!-- Liens utilisateur -->
                            {% if user.is_authenticated %}
                                <div class="dropdown">
                                    <button class="btn btn-light btn-sm dropdown-toggle" type="button"
                                            data-bs-toggle="dropdown">
                                        <i class="fas fa-user-circle"></i> {{ user.username }}
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" href="{% url 'users:profile' user.username %}">
                                                <i class="fas fa-user"></i> {% trans "Mon profil" %}
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'ads:my_ads' %}">
                                                <i class="fas fa-list"></i> {% trans "Mes annonces" %}
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'colis:my_packages' %}">
                                                <i class="fas fa-box"></i> {% trans "Mes colis" %}
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'ads:favorite_list' %}">
                                                <i class="fas fa-heart"></i> {% trans "Mes favoris" %}
                                            </a>
                                        </li>
                                        <!-- Lien vers le dashboard transporteur si applicable -->
                                        {% if user.carrier_profile %}
                                            <li>
                                                <a class="dropdown-item" href="{% url 'carriers:dashboard' %}">
                                                    <i class="fas fa-tachometer-alt"></i> {% trans "Dashboard Transporteur" %}
                                                </a>
                                            </li>
                                        {% endif %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'users:logout' %}">
                                                <i class="fas fa-sign-out-alt"></i> {% trans "Déconnexion" %}
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            {% else %}
                                <a href="{% url 'users:login' %}" class="btn btn-light btn-sm me-2">
                                    <i class="fas fa-sign-in-alt"></i> {% trans "Connexion" %}
                                </a>
                                <a href="{% url 'users:register' %}" class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-user-plus"></i> {% trans "Inscription" %}
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container">
                <!-- Logo -->
                <a class="navbar-brand" href="{% url 'core:home' %}">
                    <div class="d-flex align-items-center">
                        <div class="logo-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                             style="width: 40px; height: 40px;">
                            <i class="fas fa-box"></i>
                        </div>
                        <span class="fw-bold fs-4" style="color: #667eea;">EBI3</span>
                    </div>
                </a>

                <!-- Mobile Toggle -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarMain">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Menu -->
                <div class="collapse navbar-collapse" id="navbarMain">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}"
                               href="{% url 'core:home' %}">
                                <i class="fas fa-home"></i> {% trans "Accueil" %}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.namespace == 'ads' %}active{% endif %}"
                               href="{% url 'ads:ad_list' %}">
                                <i class="fas fa-list"></i> {% trans "Annonces" %}
                            </a>
                        </li>
                        <!-- Lien vers les colis -->
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.namespace == 'colis' %}active{% endif %}"
                               href="{% url 'colis:package_list' %}">
                                <i class="fas fa-box"></i> {% trans "Colis" %}
                            </a>
                        </li>
                        <!-- Lien vers les transporteurs -->
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.namespace == 'carriers' %}active{% endif %}"
                               href="{% url 'carriers:carrier_list' %}">
                                <i class="fas fa-truck"></i> {% trans "Transporteurs" %}
                            </a>
                        </li>

                        <!-- Pages du menu -->
                        {% for page in MENU_PAGES %}
                            {% if not page.show_in_footer %}
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ page.get_absolute_url }}">
                                        {{ page.title }}
                                    </a>
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>

                    <!-- Search Bar -->
                    <form class="d-flex me-3" action="{% url 'ads:search' %}" method="get">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control"
                                   placeholder="{% trans 'Rechercher...' %}"
                                   value="{{ request.GET.q }}">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>

                    <!-- Boutons d'action -->
                    <div class="d-flex gap-2">
                        <!-- Bouton créer annonce -->
                        {% if user.is_authenticated %}
                            <a href="{% url 'ads:ad_create' %}" class="btn btn-success btn-sm">
                                <i class="fas fa-plus"></i> {% trans "Créer une annonce" %}
                            </a>

                            <!-- Bouton publier colis -->
                            <a href="{% url 'colis:package_create' %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-box"></i> {% trans "Publier un colis" %}
                            </a>
                        {% endif %}

                        <!-- Bouton devenir transporteur - CORRIGÉ -->
                        {% if user.is_authenticated %}
                            {% if not user.carrier_profile %}
                                <!-- Lien direct vers l'inscription transporteur -->
                                <a href="{% url 'users:carrier_register' %}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-truck"></i> {% trans "Devenir transporteur" %}
                                </a>
                            {% else %}
                                <!-- Si déjà transporteur, lien vers le dashboard -->
                                <a href="{% url 'carriers:dashboard' %}" class="btn btn-info btn-sm">
                                    <i class="fas fa-tachometer-alt"></i> {% trans "Dashboard Transport" %}
                                </a>
                            {% endif %}
                        {% else %}
                            <!-- Si non connecté, lien vers connexion avec redirection vers l'inscription transporteur -->
                            <a href="{% url 'users:login' %}?next={% url 'carriers:register' %}" class="btn btn-warning btn-sm">
                                <i class="fas fa-truck"></i> {% trans "Devenir transporteur" %}
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-grow-1">
        <!-- Messages -->
        {% if messages %}
            <div class="container mt-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="text-dark mt-auto" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
        <div class="container py-5">
            <div class="row">
                <!-- Logo et description -->
                <div class="col-lg-4 mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="logo-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                             style="width: 40px; height: 40px;">
                            <i class="fas fa-box"></i>
                        </div>
                        <h4 class="mb-0 fw-bold" style="color: #667eea;">EBI3</h4>
                    </div>
                    <p class="text-muted">
                        {% trans "Plateforme logistique transfrontalière pour les expatriés." %}
                    </p>
                    <div class="social-links mt-4">
                        {% if FACEBOOK_URL %}
                            <a href="{{ FACEBOOK_URL }}" class="text-secondary me-3">
                                <i class="fab fa-facebook fa-lg"></i>
                            </a>
                        {% endif %}
                        {% if TWITTER_URL %}
                            <a href="{{ TWITTER_URL }}" class="text-secondary me-3">
                                <i class="fab fa-twitter fa-lg"></i>
                            </a>
                        {% endif %}
                        {% if INSTAGRAM_URL %}
                            <a href="{{ INSTAGRAM_URL }}" class="text-secondary me-3">
                                <i class="fab fa-instagram fa-lg"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Liens rapides -->
                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3 text-primary">{% trans "Navigation" %}</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="{% url 'core:home' %}" class="text-dark text-decoration-none">
                                <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Accueil" %}
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="{% url 'ads:ad_list' %}" class="text-dark text-decoration-none">
                                <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Annonces" %}
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="{% url 'colis:package_list' %}" class="text-dark text-decoration-none">
                                <i class="fas fa-chevron-right me-1 text-success"></i> {% trans "Colis" %}
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="{% url 'carriers:carrier_list' %}" class="text-dark text-decoration-none">
                                <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Transporteurs" %}
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Liens légaux -->
                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3 text-primary">{% trans "Légal" %}</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="{% url 'core:terms' %}" class="text-dark text-decoration-none">
                                <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Conditions" %}
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="{% url 'core:privacy' %}" class="text-dark text-decoration-none">
                                <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Confidentialité" %}
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="{% url 'core:contact' %}" class="text-dark text-decoration-none">
                                <i class="fas fa-chevron-right me-1 text-primary"></i> {% trans "Contact" %}
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="{% url 'colis:how_it_works' %}" class="text-dark text-decoration-none">
                                <i class="fas fa-chevron-right me-1 text-info"></i> {% trans "Comment ça marche" %}
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Contact -->
                <div class="col-lg-4 mb-4">
                    <h6 class="fw-bold mb-3 text-primary">{% trans "Contact" %}</h6>
                    <ul class="list-unstyled">
                        {% if CONTACT_EMAIL %}
                        <li class="mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-envelope text-primary mt-1 me-2"></i>
                                <div>
                                    <small class="text-muted d-block">{% trans "Email" %}</small>
                                    <a href="mailto:{{ CONTACT_EMAIL }}" class="text-dark">{{ CONTACT_EMAIL }}</a>
                                </div>
                            </div>
                        </li>
                        {% endif %}
                        {% if PHONE_NUMBER %}
                        <li class="mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-phone text-primary mt-1 me-2"></i>
                                <div>
                                    <small class="text-muted d-block">{% trans "Téléphone" %}</small>
                                    <a href="tel:{{ PHONE_NUMBER }}" class="text-dark">{{ PHONE_NUMBER }}</a>
                                </div>
                            </div>
                        </li>
                        {% endif %}
                    </ul>

                    <!-- Newsletter -->
                    <div class="mt-4">
                        <p class="text-muted mb-2">{% trans "Inscrivez-vous à notre newsletter" %}</p>
                        <form class="d-flex">
                            <input type="email" class="form-control form-control-sm me-2 border-primary"
                                   placeholder="Votre email">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Copyright -->
            <div class="row pt-4 border-top">
                <div class="col-md-12 text-center">
                    <p class="mb-0 text-muted">
                        &copy; {% now "Y" %} {{ SITE_NAME }}. {% trans "Tous droits réservés." %}
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Custom JS -->
    <script src="{% static 'js/main.js' %}"></script>

    <!-- Script pour le multilinguisme et la newsletter -->
    <script>
        $(document).ready(function() {
            // Newsletter subscription
            $('#newsletter-form').submit(function(e) {
                e.preventDefault();

                $.ajax({
                    url: '{% url "core:newsletter_subscribe" %}',
                    type: 'POST',
                    data: $(this).serialize(),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            showToast(response.message, 'success');
                            $('#newsletter-form')[0].reset();
                        } else {
                            showToast('{% trans "Une erreur est survenue" %}', 'error');
                        }
                    },
                    error: function(xhr) {
                        if (xhr.status === 400) {
                            const errors = xhr.responseJSON.errors;
                            let errorMsg = '';

                            for (const field in errors) {
                                errorMsg += errors[field][0] + ' ';
                            }

                            showToast(errorMsg, 'error');
                        } else {
                            showToast('{% trans "Une erreur est survenue" %}', 'error');
                        }
                    }
                });
            });

            // RTL adjustments
            {% if LANGUAGE_BIDI %}
                // Adjustments for RTL layout
                $('.carousel-control-prev').addClass('carousel-control-next');
                $('.carousel-control-next').addClass('carousel-control-prev');

                // Fix dropdown alignment
                $('.dropdown-menu-end').removeClass('dropdown-menu-end').addClass('dropdown-menu-start');
            {% endif %}

            // Helper function for toasts
            function showToast(message, type) {
                const toastHtml = `
                    <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                `;

                $('#toast-container').append(toastHtml);
                const toast = new bootstrap.Toast($('.toast').last()[0]);
                toast.show();

                // Remove toast after hiding
                $('.toast').last().on('hidden.bs.toast', function() {
                    $(this).remove();
                });
            }

            // Debug pour le bouton Devenir transporteur
            console.log('=== DEBUG TRANSPORTEUR ===');
            console.log('User authenticated:', {{ user.is_authenticated|yesno:"true,false" }});
            console.log('Has carrier profile:', {% if user.is_authenticated %}{{ user.carrier_profile|yesno:"true,false" }}{% else %}false{% endif %});
            console.log('Register URL:', "{% url 'carriers:register' %}");
            console.log('Dashboard URL:', "{% url 'carriers:dashboard' %}");
            console.log('=== FIN DEBUG ===');
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>