# ~/ebi3/logistics/admin.py

from django.contrib import admin
from django.utils.translation import gettext_lazy as _
from django.utils.html import format_html
from django.urls import reverse
from django.db.models import Count, Sum, Avg
from django.contrib.admin import DateFieldListFilter
from django.utils import timezone

from .models import (
    Reservation, Mission, Route, TransportProposal, TrackingEvent,
    LogisticsSettings, LogisticsOption, ReservationStatus, MissionStatus,
    RouteStatus, TransportProposalStatus
)


class StatusFilter(admin.SimpleListFilter):
    """Filtre personnalisé pour les statuts"""
    title = _('Statut')
    parameter_name = 'status'

    def lookups(self, request, model_admin):
        return model_admin.model.STATUS_CHOICES

    def queryset(self, request, queryset):
        if self.value():
            return queryset.filter(status=self.value())
        return queryset


class CreatedAtFilter(admin.SimpleListFilter):
    """Filtre par date de création"""
    title = _('Date de création')
    parameter_name = 'created_at'

    def lookups(self, request, model_admin):
        return [
            ('today', _('Aujourd\'hui')),
            ('this_week', _('Cette semaine')),
            ('this_month', _('Ce mois')),
            ('last_month', _('Le mois dernier')),
        ]

    def queryset(self, request, queryset):
        today = timezone.now().date()

        if self.value() == 'today':
            return queryset.filter(created_at__date=today)
        elif self.value() == 'this_week':
            week_start = today - timezone.timedelta(days=today.weekday())
            return queryset.filter(created_at__date__gte=week_start)
        elif self.value() == 'this_month':
            return queryset.filter(created_at__year=today.year, created_at__month=today.month)
        elif self.value() == 'last_month':
            last_month = today.replace(day=1) - timezone.timedelta(days=1)
            return queryset.filter(created_at__year=last_month.year, created_at__month=last_month.month)

        return queryset


class CarrierFilter(admin.SimpleListFilter):
    """Filtre par transporteur"""
    title = _('Transporteur')
    parameter_name = 'carrier'

    def lookups(self, request, model_admin):
        from carriers.models import CarrierProfile
        carriers = CarrierProfile.objects.all().select_related('user')
        return [(c.id, str(c)) for c in carriers]

    def queryset(self, request, queryset):
        if self.value():
            return queryset.filter(carrier_id=self.value())
        return queryset


class TrackingEventInline(admin.TabularInline):
    """Inline pour les événements de suivi"""
    model = TrackingEvent
    extra = 0
    readonly_fields = ['created_at', 'created_by']
    fields = ['event_type', 'description', 'location', 'photo', 'created_at', 'created_by']
    can_delete = True
    max_num = 10

    def has_add_permission(self, request, obj=None):
        return request.user.is_superuser

    def has_change_permission(self, request, obj=None):
        return request.user.is_superuser


class ReservationInline(admin.TabularInline):
    """Inline pour les réservations"""
    model = Reservation
    extra = 0
    readonly_fields = ['get_ad_link', 'get_buyer_link', 'total_price', 'created_at']
    fields = ['get_ad_link', 'get_buyer_link', 'status', 'total_price', 'created_at']
    can_delete = False
    max_num = 5

    def get_ad_link(self, obj):
        if obj.ad:
            url = reverse('admin:ads_ad_change', args=[obj.ad.id])
            return format_html('<a href="{}">{}</a>', url, obj.ad.title)
        return '-'
    get_ad_link.short_description = _('Annonce')

    def get_buyer_link(self, obj):
        if obj.buyer:
            url = reverse('admin:users_user_change', args=[obj.buyer.id])
            return format_html('<a href="{}">{}</a>', url, obj.buyer.username)
        return '-'
    get_buyer_link.short_description = _('Acheteur')

    def has_add_permission(self, request, obj=None):
        return False

    def has_change_permission(self, request, obj=None):
        return False


class TransportProposalInline(admin.TabularInline):
    """Inline pour les propositions de transport"""
    model = TransportProposal
    extra = 0
    readonly_fields = ['get_ad_link', 'proposed_price', 'status', 'created_at']
    fields = ['get_ad_link', 'proposed_price', 'status', 'created_at']
    can_delete = False
    max_num = 5

    def get_ad_link(self, obj):
        if obj.ad:
            url = reverse('admin:ads_ad_change', args=[obj.ad.id])
            return format_html('<a href="{}">{}</a>', url, obj.ad.title)
        return '-'
    get_ad_link.short_description = _('Annonce')

    def has_add_permission(self, request, obj=None):
        return False

    def has_change_permission(self, request, obj=None):
        return False


@admin.register(Reservation)
class ReservationAdmin(admin.ModelAdmin):
    """Admin pour les réservations"""
    list_display = [
        'id', 'get_ad_title', 'get_buyer', 'get_seller', 'logistics_option',
        'status', 'total_price', 'created_at', 'is_paid', 'actions'
    ]
    list_filter = [
        StatusFilter, CreatedAtFilter, 'logistics_option', 'is_paid',
        ('created_at', DateFieldListFilter), CarrierFilter
    ]
    search_fields = [
        'id', 'ad__title', 'buyer__username', 'ad__seller__username',
        'tracking_number', 'payment_reference'
    ]
    readonly_fields = [
        'created_at', 'updated_at', 'cancelled_at', 'cancelled_by',
        'payment_date', 'get_ad_link', 'get_buyer_link', 'get_carrier_link'
    ]
    fieldsets = (
        (_('Informations de base'), {
            'fields': (
                'get_ad_link', 'get_buyer_link', 'get_carrier_link',
                'logistics_option', 'status'
            )
        }),
        (_('Détails logistiques'), {
            'fields': (
                'pickup_address', 'delivery_address',
                'pickup_date', 'delivery_date', 'actual_delivery_date',
                'tracking_number'
            )
        }),
        (_('Prix et paiement'), {
            'fields': (
                'price_agreed', 'shipping_cost', 'insurance_cost', 'total_price',
                'is_paid', 'payment_method', 'payment_date', 'payment_reference'
            )
        }),
        (_('Assurance et emballage'), {
            'fields': (
                'requires_insurance', 'insurance_value',
                'requires_packaging', 'packaging_details'
            )
        }),
        (_('Notes'), {
            'fields': ('buyer_notes', 'seller_notes', 'carrier_notes')
        }),
        (_('Annulation'), {
            'fields': ('cancelled_at', 'cancelled_by', 'cancellation_reason'),
            'classes': ('collapse',)
        }),
        (_('Métadonnées'), {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    inlines = [TrackingEventInline]

    actions = ['mark_as_paid', 'mark_as_delivered', 'cancel_reservations', 'export_to_csv']

    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        queryset = queryset.select_related(
            'ad', 'ad__seller', 'buyer', 'carrier', 'carrier__user'
        )
        return queryset

    def get_ad_title(self, obj):
        return obj.ad.title[:50] + '...' if len(obj.ad.title) > 50 else obj.ad.title
    get_ad_title.short_description = _('Annonce')
    get_ad_title.admin_order_field = 'ad__title'

    def get_buyer(self, obj):
        return obj.buyer.username
    get_buyer.short_description = _('Acheteur')
    get_buyer.admin_order_field = 'buyer__username'

    def get_seller(self, obj):
        return obj.ad.seller.username
    get_seller.short_description = _('Vendeur')
    get_seller.admin_order_field = 'ad__seller__username'

    def get_ad_link(self, obj):
        url = reverse('admin:ads_ad_change', args=[obj.ad.id])
        return format_html('<a href="{}">{}</a>', url, obj.ad.title)
    get_ad_link.short_description = _('Annonce')

    def get_buyer_link(self, obj):
        url = reverse('admin:users_user_change', args=[obj.buyer.id])
        return format_html('<a href="{}">{}</a>', url, obj.buyer.username)
    get_buyer_link.short_description = _('Acheteur')

    def get_carrier_link(self, obj):
        if obj.carrier:
            url = reverse('admin:carriers_carrierprofile_change', args=[obj.carrier.id])
            return format_html('<a href="{}">{}</a>', url, str(obj.carrier))
        return '-'
    get_carrier_link.short_description = _('Transporteur')

    def actions(self, obj):
        links = []

        # Lien vers la mission si elle existe
        if hasattr(obj, 'mission'):
            url = reverse('admin:logistics_mission_change', args=[obj.mission.id])
            links.append(format_html(
                '<a href="{}" class="button" style="background-color:#4CAF50;color:white;padding:2px 6px;border-radius:3px;text-decoration:none;">{}</a>',
                url, _('Mission')
            ))

        # Lien pour voir les détails
        url = reverse('admin:logistics_reservation_change', args=[obj.id])
        links.append(format_html(
            '<a href="{}" class="button" style="background-color:#2196F3;color:white;padding:2px 6px;border-radius:3px;text-decoration:none;">{}</a>',
            url, _('Éditer')
        ))

        return format_html(' '.join(links))
    actions.short_description = _('Actions')

    def mark_as_paid(self, request, queryset):
        updated = queryset.filter(status__in=['PENDING', 'CONFIRMED', 'PAYMENT_PENDING']).update(
            status='PAID',
            is_paid=True,
            payment_date=timezone.now()
        )
        self.message_user(request, _('{} réservations marquées comme payées.').format(updated))
    mark_as_paid.short_description = _('Marquer comme payées')

    def mark_as_delivered(self, request, queryset):
        updated = queryset.filter(status='IN_TRANSIT').update(
            status='DELIVERED',
            actual_delivery_date=timezone.now().date()
        )
        self.message_user(request, _('{} réservations marquées comme livrées.').format(updated))
    mark_as_delivered.short_description = _('Marquer comme livrées')

    def cancel_reservations(self, request, queryset):
        updated = queryset.filter(status__in=['PENDING', 'CONFIRMED', 'PAYMENT_PENDING']).update(
            status='CANCELLED',
            cancelled_at=timezone.now(),
            cancelled_by=request.user
        )
        self.message_user(request, _('{} réservations annulées.').format(updated))
    cancel_reservations.short_description = _('Annuler les réservations')

    def export_to_csv(self, request, queryset):
        import csv
        from django.http import HttpResponse

        response = HttpResponse(content_type='text/csv')
        response['Content-Disposition'] = 'attachment; filename="reservations.csv"'

        writer = csv.writer(response)
        writer.writerow([
            _('ID'), _('Annonce'), _('Acheteur'), _('Vendeur'), _('Transporteur'),
            _('Option'), _('Statut'), _('Prix total'), _('Payé'), _('Date création')
        ])

        for obj in queryset.select_related('ad', 'ad__seller', 'buyer', 'carrier'):
            writer.writerow([
                obj.id,
                obj.ad.title,
                obj.buyer.username,
                obj.ad.seller.username,
                str(obj.carrier) if obj.carrier else '',
                obj.get_logistics_option_display(),
                obj.get_status_display(),
                obj.total_price,
                _('Oui') if obj.is_paid else _('Non'),
                obj.created_at.strftime('%d/%m/%Y %H:%M')
            ])

        return response
    export_to_csv.short_description = _('Exporter en CSV')

    class Media:
        css = {
            'all': ('css/admin-logistics.css',)
        }


@admin.register(Mission)
class MissionAdmin(admin.ModelAdmin):
    """Admin pour les missions"""
    list_display = [
        'id', 'get_reservation', 'get_carrier', 'status', 'current_location',
        'estimated_delivery', 'progress_bar', 'created_at'
    ]
    list_filter = [
        StatusFilter, CreatedAtFilter, 'carrier__carrier_type',
        ('estimated_delivery', DateFieldListFilter)
    ]
    search_fields = [
        'id', 'reservation__ad__title', 'carrier__user__username',
        'current_location', 'tracking_number'
    ]
    readonly_fields = [
        'created_at', 'updated_at', 'get_reservation_link', 'get_carrier_link',
        'progress_percentage'
    ]
    fieldsets = (
        (_('Informations de base'), {
            'fields': ('get_reservation_link', 'get_carrier_link', 'status')
        }),
        (_('Suivi'), {
            'fields': (
                'current_location', 'latitude', 'longitude',
                'distance_km'
            )
        }),
        (_('Dates'), {
            'fields': (
                'scheduled_pickup', 'actual_pickup',
                'estimated_delivery', 'actual_delivery'
            )
        }),
        (_('Documents'), {
            'fields': ('pickup_confirmation', 'delivery_confirmation')
        }),
        (_('Notes'), {
            'fields': ('notes', 'delay_reason')
        }),
        (_('Progression'), {
            'fields': ('progress_percentage',),
            'classes': ('wide',)
        }),
        (_('Métadonnées'), {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    inlines = [TrackingEventInline]

    actions = ['mark_as_delivered', 'mark_as_in_transit', 'update_locations']

    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        queryset = queryset.select_related(
            'reservation', 'reservation__ad', 'carrier', 'carrier__user'
        )
        return queryset

    def get_reservation(self, obj):
        return f"Réservation #{obj.reservation.id}"
    get_reservation.short_description = _('Réservation')
    get_reservation.admin_order_field = 'reservation__id'

    def get_carrier(self, obj):
        return obj.carrier.user.username
    get_carrier.short_description = _('Transporteur')
    get_carrier.admin_order_field = 'carrier__user__username'

    def get_reservation_link(self, obj):
        url = reverse('admin:logistics_reservation_change', args=[obj.reservation.id])
        return format_html('<a href="{}">Réservation #{}</a>', url, obj.reservation.id)
    get_reservation_link.short_description = _('Réservation')

    def get_carrier_link(self, obj):
        url = reverse('admin:carriers_carrierprofile_change', args=[obj.carrier.id])
        return format_html('<a href="{}">{}</a>', url, str(obj.carrier))
    get_carrier_link.short_description = _('Transporteur')

    def progress_bar(self, obj):
        percentage = obj.progress_percentage
        color = '#4CAF50'  # Vert
        if percentage < 30:
            color = '#F44336'  # Rouge
        elif percentage < 70:
            color = '#FFC107'  # Orange

        return format_html(
            '''
            <div style="background-color:#f0f0f0;border-radius:3px;height:20px;width:100px;position:relative;">
                <div style="background-color:{};border-radius:3px;height:100%;width:{}%;"></div>
                <div style="position:absolute;top:0;left:0;right:0;text-align:center;font-size:11px;line-height:20px;">
                    {}%
                </div>
            </div>
            ''',
            color, percentage, percentage
        )
    progress_bar.short_description = _('Progression')

    def mark_as_delivered(self, request, queryset):
        updated = queryset.filter(status__in=['OUT_FOR_DELIVERY', 'DELIVERY_PENDING']).update(
            status='DELIVERED',
            actual_delivery=timezone.now()
        )
        self.message_user(request, _('{} missions marquées comme livrées.').format(updated))
    mark_as_delivered.short_description = _('Marquer comme livrées')

    def mark_as_in_transit(self, request, queryset):
        updated = queryset.filter(status__in=['PICKED_UP', 'SCHEDULED']).update(
            status='IN_TRANSIT'
        )
        self.message_user(request, _('{} missions marquées comme en transit.').format(updated))
    mark_as_in_transit.short_description = _('Marquer comme en transit')

    def update_locations(self, request, queryset):
        # Action pour mettre à jour les localisations
        for mission in queryset:
            # Logique de mise à jour...
            pass
        self.message_user(request, _('Localisations mises à jour.'))
    update_locations.short_description = _('Mettre à jour les localisations')


@admin.register(Route)
class RouteAdmin(admin.ModelAdmin):
    """Admin pour les routes"""
    list_display = [
        'id', 'start_city', 'end_city', 'get_carrier', 'departure_date',
        'available_capacity', 'status', 'is_featured', 'created_at'
    ]
    list_filter = [
        StatusFilter, CreatedAtFilter, 'is_featured', 'carrier__carrier_type',
        ('departure_date', DateFieldListFilter), 'start_country', 'end_country'
    ]
    search_fields = [
        'start_city', 'end_city', 'carrier__user__username',
        'carrier__company_name', 'description'
    ]
    readonly_fields = [
        'created_at', 'updated_at', 'view_count', 'get_carrier_link',
        'calculate_utilization'
    ]
    fieldsets = (
        (_('Informations de base'), {
            'fields': (
                'get_carrier_link', 'status', 'is_featured'
            )
        }),
        (_('Itinéraire'), {
            'fields': (
                'start_city', 'start_country', 'start_address',
                'end_city', 'end_country', 'end_address'
            )
        }),
        (_('Dates'), {
            'fields': ('departure_date', 'arrival_date')
        }),
        (_('Capacités'), {
            'fields': (
                'max_weight', 'max_volume',
                'available_weight', 'available_volume'
            )
        }),
        (_('Prix'), {
            'fields': (
                'fixed_price', 'price_per_kg', 'price_per_m3'
            )
        }),
        (_('Services inclus'), {
            'fields': (
                'includes_insurance', 'includes_packaging',
                'includes_loading', 'includes_unloading'
            )
        }),
        (_('Description'), {
            'fields': ('description', 'special_conditions')
        }),
        (_('Statistiques'), {
            'fields': ('view_count', 'calculate_utilization'),
            'classes': ('wide',)
        }),
        (_('Métadonnées'), {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    inlines = [ReservationInline]

    actions = ['mark_as_featured', 'mark_as_active', 'duplicate_routes']

    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        queryset = queryset.select_related('carrier', 'carrier__user', 'start_country', 'end_country')
        return queryset

    def get_carrier(self, obj):
        return obj.carrier.user.username
    get_carrier.short_description = _('Transporteur')
    get_carrier.admin_order_field = 'carrier__user__username'

    def available_capacity(self, obj):
        weight_percent = (obj.available_weight / obj.max_weight * 100) if obj.max_weight > 0 else 0
        volume_percent = (obj.available_volume / obj.max_volume * 100) if obj.max_volume > 0 else 0

        return format_html(
            '<div style="white-space:nowrap;">'
            '<span style="color:#666;">Poids:</span> {}kg ({}%)<br>'
            '<span style="color:#666;">Volume:</span> {}m³ ({}%)'
            '</div>',
            obj.available_weight, round(weight_percent),
            obj.available_volume, round(volume_percent)
        )
    available_capacity.short_description = _('Capacité disponible')

    def get_carrier_link(self, obj):
        url = reverse('admin:carriers_carrierprofile_change', args=[obj.carrier.id])
        return format_html('<a href="{}">{}</a>', url, str(obj.carrier))
    get_carrier_link.short_description = _('Transporteur')

    def calculate_utilization(self, obj):
        weight_utilization = 100 - ((obj.available_weight / obj.max_weight) * 100) if obj.max_weight > 0 else 0
        volume_utilization = 100 - ((obj.available_volume / obj.max_volume) * 100) if obj.max_volume > 0 else 0

        return format_html(
            '''
            <div style="margin:10px 0;">
                <div style="margin-bottom:5px;">
                    <strong>Poids:</strong> {}% utilisé
                    <div style="background-color:#f0f0f0;border-radius:3px;height:10px;width:200px;display:inline-block;margin-left:10px;">
                        <div style="background-color:#4CAF50;border-radius:3px;height:100%;width:{}%;"></div>
                    </div>
                </div>
                <div>
                    <strong>Volume:</strong> {}% utilisé
                    <div style="background-color:#f0f0f0;border-radius:3px;height:10px;width:200px;display:inline-block;margin-left:10px;">
                        <div style="background-color:#2196F3;border-radius:3px;height:100%;width:{}%;"></div>
                    </div>
                </div>
            </div>
            ''',
            round(weight_utilization), weight_utilization,
            round(volume_utilization), volume_utilization
        )
    calculate_utilization.short_description = _('Taux d\'utilisation')

    def mark_as_featured(self, request, queryset):
        updated = queryset.update(is_featured=True)
        self.message_user(request, _('{} routes mises en avant.').format(updated))
    mark_as_featured.short_description = _('Mettre en avant')

    def mark_as_active(self, request, queryset):
        updated = queryset.update(status='ACTIVE')
        self.message_user(request, _('{} routes marquées comme actives.').format(updated))
    mark_as_active.short_description = _('Marquer comme actives')

    def duplicate_routes(self, request, queryset):
        for route in queryset:
            route.pk = None
            route.departure_date = route.departure_date + timezone.timedelta(days=7)
            route.arrival_date = route.arrival_date + timezone.timedelta(days=7)
            route.status = 'ACTIVE'
            route.is_featured = False
            route.save()

        self.message_user(request, _('{} routes dupliquées.').format(queryset.count()))
    duplicate_routes.short_description = _('Dupliquer les routes')


@admin.register(TransportProposal)
class TransportProposalAdmin(admin.ModelAdmin):
    """Admin pour les propositions de transport"""
    list_display = [
        'id', 'get_ad', 'get_carrier', 'proposed_price', 'status',
        'days_until_expiry', 'created_at', 'responded_at'
    ]
    list_filter = [
        StatusFilter, CreatedAtFilter, 'includes_insurance', 'includes_packaging',
        ('expires_at', DateFieldListFilter), 'carrier__carrier_type'
    ]
    search_fields = [
        'id', 'ad__title', 'carrier__user__username', 'message',
        'carrier__company_name'
    ]
    readonly_fields = [
        'created_at', 'responded_at', 'get_ad_link', 'get_carrier_link',
        'is_expired'
    ]
    fieldsets = (
        (_('Informations de base'), {
            'fields': ('get_ad_link', 'get_carrier_link', 'status')
        }),
        (_('Détails de la proposition'), {
            'fields': (
                'proposed_price', 'message',
                'estimated_pickup_date', 'estimated_delivery_date'
            )
        }),
        (_('Services'), {
            'fields': (
                'includes_insurance', 'insurance_value',
                'includes_packaging', 'includes_loading', 'includes_unloading'
            )
        }),
        (_('Expiration'), {
            'fields': ('expires_at', 'is_expired', 'days_until_expiry')
        }),
        (_('Réponse'), {
            'fields': ('responded_at', 'response_message')
        }),
        (_('Métadonnées'), {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )

    actions = ['accept_proposals', 'reject_proposals', 'extend_expiry']

    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        queryset = queryset.select_related('ad', 'carrier', 'carrier__user')
        return queryset

    def get_ad(self, obj):
        return obj.ad.title[:50] + '...' if len(obj.ad.title) > 50 else obj.ad.title
    get_ad.short_description = _('Annonce')
    get_ad.admin_order_field = 'ad__title'

    def get_carrier(self, obj):
        return obj.carrier.user.username
    get_carrier.short_description = _('Transporteur')
    get_carrier.admin_order_field = 'carrier__user__username'

    def days_until_expiry(self, obj):
        days = obj.days_until_expiry
        if days is None:
            return '-'

        if days < 0:
            return format_html('<span style="color:#F44336;">{}</span>', _('Expiré'))
        elif days < 2:
            return format_html('<span style="color:#FF9800;">{}</span>', f"{days} {_('jours')}")
        else:
            return f"{days} {_('jours')}"
    days_until_expiry.short_description = _('Jours avant expiration')

    def get_ad_link(self, obj):
        url = reverse('admin:ads_ad_change', args=[obj.ad.id])
        return format_html('<a href="{}">{}</a>', url, obj.ad.title)
    get_ad_link.short_description = _('Annonce')

    def get_carrier_link(self, obj):
        url = reverse('admin:carriers_carrierprofile_change', args=[obj.carrier.id])
        return format_html('<a href="{}">{}</a>', url, str(obj.carrier))
    get_carrier_link.short_description = _('Transporteur')

    def accept_proposals(self, request, queryset):
        updated = queryset.filter(status='PENDING').update(
            status='ACCEPTED',
            responded_at=timezone.now()
        )
        self.message_user(request, _('{} propositions acceptées.').format(updated))
    accept_proposals.short_description = _('Accepter les propositions')

    def reject_proposals(self, request, queryset):
        updated = queryset.filter(status='PENDING').update(
            status='REJECTED',
            responded_at=timezone.now()
        )
        self.message_user(request, _('{} propositions rejetées.').format(updated))
    reject_proposals.short_description = _('Rejeter les propositions')

    def extend_expiry(self, request, queryset):
        for proposal in queryset:
            proposal.expires_at = proposal.expires_at + timezone.timedelta(days=7)
            proposal.save()

        self.message_user(request, _('{} propositions prolongées de 7 jours.').format(queryset.count()))
    extend_expiry.short_description = _('Prolonger l\'expiration')


@admin.register(TrackingEvent)
class TrackingEventAdmin(admin.ModelAdmin):
    """Admin pour les événements de suivi"""
    list_display = [
        'id', 'get_mission', 'event_type', 'location', 'created_at',
        'get_created_by'
    ]
    list_filter = [
        'event_type', CreatedAtFilter,
        ('created_at', DateFieldListFilter)
    ]
    search_fields = [
        'mission__reservation__ad__title', 'description', 'location',
        'created_by__username'
    ]
    readonly_fields = ['created_at', 'get_mission_link', 'get_created_by_link']
    fieldsets = (
        (_('Informations de base'), {
            'fields': ('get_mission_link', 'event_type')
        }),
        (_('Détails'), {
            'fields': ('description', 'location', 'latitude', 'longitude')
        }),
        (_('Photo'), {
            'fields': ('photo',)
        }),
        (_('Création'), {
            'fields': ('get_created_by_link', 'created_at')
        }),
    )

    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        queryset = queryset.select_related('mission', 'mission__reservation', 'created_by')
        return queryset

    def get_mission(self, obj):
        return f"Mission #{obj.mission.id}"
    get_mission.short_description = _('Mission')
    get_mission.admin_order_field = 'mission__id'

    def get_created_by(self, obj):
        return obj.created_by.username if obj.created_by else '-'
    get_created_by.short_description = _('Créé par')
    get_created_by.admin_order_field = 'created_by__username'

    def get_mission_link(self, obj):
        url = reverse('admin:logistics_mission_change', args=[obj.mission.id])
        return format_html('<a href="{}">Mission #{}</a>', url, obj.mission.id)
    get_mission_link.short_description = _('Mission')

    def get_created_by_link(self, obj):
        if obj.created_by:
            url = reverse('admin:users_user_change', args=[obj.created_by.id])
            return format_html('<a href="{}">{}</a>', url, obj.created_by.username)
        return '-'
    get_created_by_link.short_description = _('Créé par')


@admin.register(LogisticsSettings)
class LogisticsSettingsAdmin(admin.ModelAdmin):
    """Admin pour les paramètres logistiques"""

    def has_add_permission(self, request):
        # Ne permettre qu'une seule instance
        return not LogisticsSettings.objects.exists()

    def has_delete_permission(self, request, obj=None):
        return False


# Panneau d'administration personnalisé
class LogisticsAdminSite(admin.AdminSite):
    """Site d'administration personnalisé pour la logistique"""
    site_header = _('Administration Logistique Ebi3')
    site_title = _('Administration Logistique')
    index_title = _('Tableau de bord Logistique')

    def get_app_list(self, request, app_label=None):
        """
        Réorganiser la liste des apps pour mettre la logistique en premier
        """
        app_list = super().get_app_list(request, app_label)

        # Trouver et réorganiser l'app logistics
        logistics_app = None
        other_apps = []

        for app in app_list:
            if app['app_label'] == 'logistics':
                logistics_app = app
            else:
                other_apps.append(app)

        if logistics_app:
            return [logistics_app] + other_apps

        return app_list


# Enregistrement du panneau d'administration personnalisé
logistics_admin_site = LogisticsAdminSite(name='logistics_admin')

# Enregistrer les modèles avec le site personnalisé
logistics_admin_site.register(Reservation, ReservationAdmin)
logistics_admin_site.register(Mission, MissionAdmin)
logistics_admin_site.register(Route, RouteAdmin)
logistics_admin_site.register(TransportProposal, TransportProposalAdmin)
logistics_admin_site.register(TrackingEvent, TrackingEventAdmin)
logistics_admin_site.register(LogisticsSettings, LogisticsSettingsAdmin)