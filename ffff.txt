=== Fichier: colis/utils/signal_helpers.py ===
# ~/ebi3/colis/utils/signal_helpers.py
import logging
from django.db import transaction

logger = logging.getLogger(__name__)

def create_conversation_for_offer(offer):
    """Crée une conversation pour une offre (gère les imports circulaires)"""
    try:
        from messaging.models import Conversation, Message

        # Votre logique de création de conversation
        conversation, created = Conversation.objects.get_or_create(
            package=offer.package,
            carrier=offer.carrier,
            defaults={
                'subject': f"Offre pour le colis #{offer.package.id}",
                'last_message_at': timezone.now()
            }
        )

        if created:
            # Créer le premier message
            Message.objects.create(
                conversation=conversation,
                sender=offer.carrier.user,
                content=f"Bonjour, je vous propose de transporter votre colis pour {offer.price} {offer.currency}.",
                is_read=False
            )

        return conversation

    except ImportError as e:
        logger.error(f"Could not import messaging models: {e}")
        return None
    except Exception as e:
        logger.error(f"Error creating conversation: {e}")
        return None-e 

=== Fichier: colis/templates/colis/package/package_detail.html ===
{# ~/ebi3/colis/templates/colis/package/package_detail.html #}
{% extends 'colis/base_colis.html' %}
{% load i18n %}

{% block title %}{{ package.title }} - Ebi3{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .package-detail-image {
        height: 400px;
        object-fit: cover;
        border-radius: 10px;
    }
    .map-container {
        height: 300px;
        border-radius: 10px;
        overflow: hidden;
    }
    .route-display {
        border-left: 3px solid #667eea;
        padding-left: 1rem;
        margin: 1rem 0;
    }
    .specs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    .spec-item {
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .spec-label {
        display: block;
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    .spec-value {
        display: block;
        font-size: 1.25rem;
        font-weight: bold;
        color: #212529;
    }
</style>
{% endblock %}

{% block colis_title %}{{ package.title }}{% endblock %}

{% block colis_content %}
<div class="row">
    <!-- Colonne principale -->
    <div class="col-lg-8">
        <!-- Galerie d'images -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                {% include 'colis/partials/image_gallery.html' with images=package.images.all %}
            </div>
        </div>

        <!-- Description détaillée -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> {% trans "Description" %}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <p><strong>{% trans "Catégorie:" %}</strong>
                            <a href="{{ package.category.get_absolute_url }}" class="badge bg-info">
                                {{ package.category.name }}
                            </a>
                        </p>
                        <p><strong>{% trans "Type:" %}</strong>
                            <span class="badge bg-secondary">{{ package.get_package_type_display }}</span>
                        </p>
                        <p><strong>{% trans "Prix:" %}</strong>
                            <span class="h5 text-primary">{{ package.get_price_with_currency }}</span>
                            {% if package.price_type == 'NEGOTIABLE' %}
                                <span class="badge bg-warning">{% trans "Négociable" %}</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{% trans "Statut:" %}</strong>
                            {% include 'colis/partials/status_badge.html' with status=package.status %}
                        </p>
                        <p><strong>{% trans "Publié le:" %}</strong>
                            {{ package.created_at|date:"d/m/Y à H:i" }}
                        </p>
                        <p><strong>{% trans "Vues:" %}</strong>
                            {{ package.view_count }}
                        </p>
                    </div>
                </div>

                <!-- Spécifications -->
                <div class="specs-grid">
                    <div class="spec-item">
                        <span class="spec-label">{% trans "Poids" %}</span>
                        <span class="spec-value">{{ package.weight }} kg</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">{% trans "Dimensions" %}</span>
                        <span class="spec-value">{{ package.length }}×{{ package.width }}×{{ package.height }} cm</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">{% trans "Volume" %}</span>
                        <span class="spec-value">{{ package.volume|floatformat:1 }} L</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">{% trans "Distance estimée" %}</span>
                        <span class="spec-value">{{ package.get_distance_display }}</span>
                    </div>
                </div>

                <!-- Description complète -->
                <h6 class="mt-4">{% trans "Description complète" %}</h6>
                <div class="description-content">
                    {{ package.description|linebreaks }}
                </div>

                <!-- Options -->
                {% if package.is_fragile or package.requires_insurance or package.requires_packaging %}
                    <div class="mt-4">
                        <h6>{% trans "Options spéciales" %}</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% if package.is_fragile %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-exclamation-triangle"></i> {% trans "Fragile" %}
                                </span>
                            {% endif %}
                            {% if package.requires_insurance %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-shield-alt"></i> {% trans "Assurance requise" %}
                                </span>
                            {% endif %}
                            {% if package.requires_packaging %}
                                <span class="badge bg-info">
                                    <i class="fas fa-box"></i> {% trans "Emballage requis" %}
                                </span>
                            {% endif %}
                            {% if package.requires_loading_help %}
                                <span class="badge bg-success">
                                    <i class="fas fa-arrow-up"></i> {% trans "Aide chargement" %}
                                </span>
                            {% endif %}
                            {% if package.requires_unloading_help %}
                                <span class="badge bg-success">
                                    <i class="fas fa-arrow-down"></i> {% trans "Aide déchargement" %}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Trajet et carte -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-route"></i> {% trans "Trajet" %}</h5>
            </div>
            <div class="card-body">
                <div class="route-display">
                    <div class="mb-3">
                        <h6><i class="fas fa-map-marker-alt text-danger"></i> {% trans "Départ" %}</h6>
                        <p class="mb-1">
                            <strong>{{ package.pickup_city }}</strong>, {{ package.pickup_country.name }}
                        </p>
                        {% if package.pickup_address %}
                            <p class="text-muted small mb-0">{{ package.pickup_address }}</p>
                        {% endif %}
                        <p class="text-muted small">
                            <i class="fas fa-calendar"></i> {% trans "Disponible à partir du" %} {{ package.pickup_date|date:"d/m/Y" }}
                        </p>
                    </div>

                    <div class="mb-3">
                        <h6><i class="fas fa-map-marker-alt text-success"></i> {% trans "Destination" %}</h6>
                        <p class="mb-1">
                            <strong>{{ package.delivery_city }}</strong>, {{ package.delivery_country.name }}
                        </p>
                        {% if package.delivery_address %}
                            <p class="text-muted small mb-0">{{ package.delivery_address }}</p>
                        {% endif %}
                        <p class="text-muted small">
                            <i class="fas fa-calendar-check"></i> {% trans "Livraison avant le" %} {{ package.delivery_date|date:"d/m/Y" }}
                        </p>
                    </div>

                    {% if package.flexible_dates %}
                        <div class="alert alert-warning">
                            <i class="fas fa-clock"></i>
                            {% trans "Dates flexibles - L'expéditeur accepte des dates différentes" %}
                        </div>
                    {% endif %}
                </div>

                <!-- Carte -->
                <div class="map-container mt-3" id="routeMap"></div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Actions -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">{% trans "Actions" %}</h5>

                <div class="d-grid gap-2 mb-3">
                    {% if user.is_authenticated %}
                        {% if user == package.sender %}
                            <!-- Propriétaire du colis -->
                            <a href="{% url 'colis:package_edit' package.slug %}" class="btn btn-primary">
                                <i class="fas fa-edit"></i> {% trans "Modifier" %}
                            </a>
                            <a href="{% url 'colis:package_management' package.slug %}" class="btn btn-outline-primary">
                                <i class="fas fa-cog"></i> {% trans "Gérer" %}
                            </a>

                            {% if package.status == 'AVAILABLE' and transport_offers %}
                                <div class="mt-3">
                                    <h6>{% trans "Offres reçues" %}</h6>
                                    <div class="list-group">
                                        {% for offer in transport_offers|slice:":3" %}
                                            <div class="list-group-item">
                                                <div class="d-flex justify-content-between">
                                                    <strong>{{ offer.price }} {{ offer.currency }}</strong>
                                                    <span class="badge bg-{% if offer.status == 'PENDING' %}warning{% else %}secondary{% endif %}">
                                                        {{ offer.get_status_display }}
                                                    </span>
                                                </div>
                                                <small class="text-muted">
                                                    {{ offer.carrier.user.username }}
                                                </small>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    {% if has_pending_offers %}
                                        <a href="{% url 'colis:my_offers' %}" class="btn btn-warning mt-2 w-100">
                                            <i class="fas fa-gavel"></i> {% trans "Voir toutes les offres" %}
                                        </a>
                                    {% endif %}
                                </div>
                            {% endif %}

                        {% elif can_make_offer %}
                            <!-- Transporteur pouvant faire une offre -->
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#makeOfferModal">
                                <i class="fas fa-handshake"></i> {% trans "Faire une offre" %}
                            </button>
                            <a href="{% url 'messaging:new_conversation' package.sender.username %}" class="btn btn-outline-primary">
                                <i class="fas fa-envelope"></i> {% trans "Contacter" %}
                            </a>

                        {% elif user_offer %}
                            <!-- Transporteur ayant déjà fait une offre -->
                            <div class="alert alert-info">
                                <h6>{% trans "Votre offre" %}</h6>
                                <p class="mb-1">
                                    <strong>{{ user_offer.price }} {{ user_offer.currency }}</strong>
                                </p>
                                <p class="mb-0">
                                    <span class="badge bg-{% if user_offer.status == 'PENDING' %}warning{% elif user_offer.status == 'ACCEPTED' %}success{% else %}secondary{% endif %}">
                                        {{ user_offer.get_status_display }}
                                    </span>
                                </p>
                            </div>
                        {% else %}
                            <!-- Autre utilisateur -->
                            <button class="btn btn-outline-primary requires-login" data-bs-toggle="tooltip"
                                    title="{% trans 'Devenez transporteur pour faire des offres' %}">
                                <i class="fas fa-truck"></i> {% trans "Devenir transporteur" %}
                            </button>
                        {% endif %}

                        <!-- Favori -->
                        <button class="btn favorite-btn
                                    {% if is_favorite %}btn-danger{% else %}btn-outline-danger{% endif %}"
                                data-url="{% url 'colis:toggle_favorite' package.slug %}"
                                data-package-slug="{{ package.slug }}">
                            <i class="{% if is_favorite %}fas{% else %}far{% endif %} fa-heart"></i>
                            {% if is_favorite %}
                                {% trans "Retirer des favoris" %}
                            {% else %}
                                {% trans "Ajouter aux favoris" %}
                            {% endif %}
                        </button>

                        <!-- Partage -->
                        <button class="btn btn-outline-secondary" onclick="sharePackage()">
                            <i class="fas fa-share-alt"></i> {% trans "Partager" %}
                        </button>

                        <!-- Signalement -->
                        {% if can_report %}
                            <a href="{% url 'colis:package_report' package.slug %}" class="btn btn-outline-warning">
                                <i class="fas fa-flag"></i> {% trans "Signaler" %}
                            </a>
                        {% endif %}
                    {% else %}
                        <!-- Non connecté -->
                        <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> {% trans "Se connecter" %}
                        </a>
                        <a href="{% url 'users:register' %}" class="btn btn-outline-primary">
                            <i class="fas fa-user-plus"></i> {% trans "S'inscrire" %}
                        </a>
                        <p class="text-muted small text-center mt-2">
                            {% trans "Connectez-vous pour contacter l'expéditeur" %}
                        </p>
                    {% endif %}
                </div>

                <!-- Statistiques -->
                <div class="d-flex justify-content-around text-center border-top pt-3">
                    <div>
                        <div class="h5">{{ package.view_count }}</div>
                        <small class="text-muted">{% trans "Vues" %}</small>
                    </div>
                    <div>
                        <div class="h5">{{ package.offer_count }}</div>
                        <small class="text-muted">{% trans "Offres" %}</small>
                    </div>
                    <div>
                        <div class="h5">{{ package.favorite_count }}</div>
                        <small class="text-muted">{% trans "Favoris" %}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informations expéditeur -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-user"></i> {% trans "Expéditeur" %}</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="avatar-circle bg-primary text-white d-flex align-items-center justify-content-center me-3">
                        <span style="font-size: 1.5rem; font-weight: bold;">
                            {{ package.sender.username|first|upper }}
                        </span>
                    </div>
                    <div>
                        <h5 class="mb-0">
                            <a href="{% url 'users:profile' package.sender.username %}" class="text-decoration-none">
                                {{ package.sender.username }}
                            </a>
                        </h5>
                        <p class="text-muted small mb-0">
                            <i class="fas fa-user-tag"></i> {{ package.sender.get_role_display }}
                        </p>
                        <p class="text-muted small mb-0">
                            <i class="fas fa-calendar-alt"></i> {% trans "Membre depuis" %} {{ package.sender.date_joined|date:"Y" }}
                        </p>
                    </div>
                </div>

                <div class="row text-center">
                    <div class="col-4">
                        <div class="h5">{{ package.sender.sent_packages.count }}</div>
                        <small class="text-muted">{% trans "Colis" %}</small>
                    </div>
                    <div class="col-4">
                        <div class="h5">{{ package.sender.rating|default:"0.0" }}</div>
                        <small class="text-muted">{% trans "Note" %}</small>
                    </div>
                    <div class="col-4">
                        <div class="h5">98%</div>
                        <small class="text-muted">{% trans "Satisfaction" %}</small>
                    </div>
                </div>

                <div class="mt-3">
                    {% if user.is_authenticated and user != package.sender %}
                        <a href="{% url 'messaging:new_conversation' package.sender.username %}"
                           class="btn btn-outline-primary w-100">
                            <i class="fas fa-envelope"></i> {% trans "Contacter" %}
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Colis similaires -->
        {% if similar_packages %}
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-boxes"></i> {% trans "Colis similaires" %}</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for similar in similar_packages %}
                            <a href="{{ similar.get_absolute_url }}" class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between">
                                    <strong>{{ similar.title|truncatechars:30 }}</strong>
                                    <span class="text-primary">{{ similar.asking_price }} €</span>
                                </div>
                                <small class="text-muted">
                                    {{ similar.pickup_city }} → {{ similar.delivery_city }}
                                </small>
                            </a>
                        {% endfor %}
                    </div>
                    <a href="{% url 'colis:search' %}?category={{ package.category.slug }}"
                       class="btn btn-sm btn-outline-secondary w-100 mt-2">
                        {% trans "Voir plus" %}
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal pour faire une offre -->
{% if can_make_offer %}
<div class="modal fade" id="makeOfferModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Faire une offre" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'colis:offer_create' package.slug %}">
                {% csrf_token %}
                <div class="modal-body">
                    {{ transport_offer_form.as_p }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "Annuler" %}
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i> {% trans "Envoyer l'offre" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// Initialisation de la carte
function initMap() {
    const map = L.map('routeMap').setView([46.603354, 1.888334], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Marqueur de départ (simulé)
    const startMarker = L.marker([48.8566, 2.3522]).addTo(map)
        .bindPopup('{% trans "Départ" %}: {{ package.pickup_city }}');

    // Marqueur d'arrivée (simulé)
    const endMarker = L.marker([45.7640, 4.8357]).addTo(map)
        .bindPopup('{% trans "Arrivée" %}: {{ package.delivery_city }}');

    // Ligne entre les deux points
    const polyline = L.polyline([
        [48.8566, 2.3522],
        [45.7640, 4.8357]
    ], {color: 'blue'}).addTo(map);

    // Ajuster la vue pour voir les deux marqueurs
    map.fitBounds([startMarker.getLatLng(), endMarker.getLatLng()]);
}

// Fonction de partage
function sharePackage() {
    const url = window.location.href;
    const title = '{{ package.title }}';

    if (navigator.share) {
        navigator.share({
            title: title,
            text: '{% trans "Regardez ce colis sur Ebi3" %}',
            url: url,
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            alert('{% trans "Lien copié dans le presse-papier !" %}');
        });
    }
}

$(document).ready(function() {
    // Initialiser la carte
    if ($('#routeMap').length) {
        initMap();
    }

    // Gestion des favoris
    $('.favorite-btn').click(function(e) {
        e.preventDefault();
        const btn = $(this);
        const url = btn.data('url');

        if (!{{ user.is_authenticated|yesno:"true,false" }}) {
            $('#loginModal').modal('show');
            return;
        }

        $.ajax({
            url: url,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(data) {
                if (data.status === 'success') {
                    if (data.action === 'added') {
                        btn.removeClass('btn-outline-danger').addClass('btn-danger');
                        btn.find('i').removeClass('far').addClass('fas');
                        btn.html('<i class="fas fa-heart"></i> {% trans "Retirer des favoris" %}');
                    } else {
                        btn.removeClass('btn-danger').addClass('btn-outline-danger');
                        btn.find('i').removeClass('fas').addClass('far');
                        btn.html('<i class="far fa-heart"></i> {% trans "Ajouter aux favoris" %}');
                    }

                    // Afficher notification
                    const toast = new bootstrap.Toast(document.getElementById('actionToast'));
                    document.getElementById('toastMessage').textContent =
                        data.action === 'added' ?
                        '{% trans "Colis ajouté aux favoris" %}' :
                        '{% trans "Colis retiré des favoris" %}';
                    toast.show();
                }
            }
        });
    });
});
</script>

<!-- Toast pour notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="actionToast" class="toast" role="alert">
        <div class="toast-header">
            <strong class="me-auto">Ebi3</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            <span id="toastMessage"></span>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.description-content {
    line-height: 1.8;
    font-size: 1.05rem;
}

.description-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1rem 0;
}
</style>
{% endblock %}-e 

=== Fichier: colis/templates/colis/package/package_list.html ===
{# ~/ebi3/colis/templates/colis/package/package_list.html #}
{% extends 'colis/base_colis.html' %}
{% load i18n %}

{% block title %}{% trans "Colis disponibles" %} - Ebi3{% endblock %}

{% block colis_title %}{% trans "Colis disponibles pour transport" %}{% endblock %}

{% block colis_content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                {% blocktranslate count total_packages=total_packages %}
                    {{ total_packages }} colis disponible
                {% plural %}
                    {{ total_packages }} colis disponibles
                {% endblocktranslate %}
            </h2>
            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-sort"></i> {% trans "Trier par" %}
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="?sort_by=-created_at">{% trans "Plus récent" %}</a></li>
                        <li><a class="dropdown-item" href="?sort_by=pickup_date">{% trans "Départ proche" %}</a></li>
                        <li><a class="dropdown-item" href="?sort_by=asking_price">{% trans "Prix croissant" %}</a></li>
                        <li><a class="dropdown-item" href="?sort_by=-asking_price">{% trans "Prix décroissant" %}</a></li>
                        <li><a class="dropdown-item" href="?sort_by=-view_count">{% trans "Plus populaire" %}</a></li>
                    </ul>
                </div>
                <a href="{% url 'colis:package_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> {% trans "Publier un colis" %}
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filtres rapides -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <select class="form-select" id="quickCategoryFilter">
                            <option value="">{% trans "Toutes catégories" %}</option>
                            {% for category in categories %}
                                <option value="{{ category.slug }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="quickTypeFilter">
                            <option value="">{% trans "Tous types" %}</option>
                            <option value="SMALL_PACKAGE">{% trans "Petit colis" %}</option>
                            <option value="MEDIUM_PACKAGE">{% trans "Colis moyen" %}</option>
                            <option value="LARGE_PACKAGE">{% trans "Gros colis" %}</option>
                            <option value="FURNITURE">{% trans "Meuble" %}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" id="quickMaxWeight"
                               placeholder="{% trans 'Poids max (kg)' %}">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100" id="applyQuickFilters">
                            <i class="fas fa-filter"></i> {% trans "Appliquer" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Liste des colis -->
{% if packages %}
    <div class="row" id="packages-container">
        {% for package in packages %}
            <div class="col-md-6 col-lg-4 mb-4">
                {% include 'colis/partials/package_card.html' with package=package %}
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-5">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {{ num }}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}
{% else %}
    <!-- Aucun résultat -->
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
            <h3>{% trans "Aucun colis trouvé" %}</h3>
            <p class="text-muted">
                {% trans "Essayez de modifier vos critères de recherche ou" %}
                <a href="{% url 'colis:package_list' %}">{% trans "consultez tous les colis" %}</a>.
            </p>
            {% if user.is_authenticated %}
                <a href="{% url 'colis:package_create' %}" class="btn btn-primary mt-3">
                    <i class="fas fa-plus"></i> {% trans "Publier le premier colis" %}
                </a>
            {% else %}
                <a href="{% url 'users:register' %}" class="btn btn-primary mt-3">
                    <i class="fas fa-user-plus"></i> {% trans "Inscrivez-vous pour publier" %}
                </a>
            {% endif %}
        </div>
    </div>
{% endif %}

<!-- Statistiques -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> {% trans "Statistiques" %}</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="stats-number">{{ total_packages }}</div>
                        <small class="text-muted">{% trans "Colis disponibles" %}</small>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-number">{{ avg_price|floatformat:0 }} €</div>
                        <small class="text-muted">{% trans "Prix moyen" %}</small>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-number">{{ total_senders }}</div>
                        <small class="text-muted">{% trans "Expéditeurs actifs" %}</small>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-number">98%</div>
                        <small class="text-muted">{% trans "Taux de satisfaction" %}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Filtres rapides
    $('#applyQuickFilters').click(function() {
        const category = $('#quickCategoryFilter').val();
        const type = $('#quickTypeFilter').val();
        const maxWeight = $('#quickMaxWeight').val();

        let url = '?';
        if (category) url += 'category=' + category + '&';
        if (type) url += 'package_type=' + type + '&';
        if (maxWeight) url += 'max_weight=' + maxWeight + '&';

        window.location.href = url.slice(0, -1); // Remove trailing & or ?
    });

    // Favoris AJAX
    $('.favorite-btn').click(function(e) {
        e.preventDefault();
        const btn = $(this);
        const url = btn.data('url');
        const packageSlug = btn.data('package-slug');

        if (!{{ user.is_authenticated|yesno:"true,false" }}) {
            $('#loginModal').modal('show');
            return;
        }

        $.ajax({
            url: url,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(data) {
                if (data.status === 'success') {
                    if (data.action === 'added') {
                        btn.removeClass('btn-outline-danger').addClass('btn-danger');
                        btn.find('i').removeClass('far').addClass('fas');
                        btn.attr('title', '{% trans "Retirer des favoris" %}');
                    } else {
                        btn.removeClass('btn-danger').addClass('btn-outline-danger');
                        btn.find('i').removeClass('fas').addClass('far');
                        btn.attr('title', '{% trans "Ajouter aux favoris" %}');
                    }

                    // Mettre à jour le compteur
                    const countSpan = $('#favorite-count-' + packageSlug);
                    if (countSpan.length) {
                        countSpan.text(data.favorite_count);
                    }

                    // Afficher un toast
                    showToast(data.action === 'added' ?
                        '{% trans "Colis ajouté aux favoris" %}' :
                        '{% trans "Colis retiré des favoris" %}',
                        'success'
                    );
                }
            },
            error: function() {
                showToast('{% trans "Une erreur est survenue" %}', 'error');
            }
        });
    });

    // Fonction toast
    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        if ($('#toast-container').length === 0) {
            $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
        }

        $('#toast-container').append(toastHtml);
        $('.toast').toast('show');

        $('.toast').on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }
});
</script>

<style>
.stats-number {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
}

.package-card {
    border-radius: 10px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.package-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.pagination .page-link {
    color: #667eea;
    border: 1px solid #dee2e6;
}

.pagination .page-item.active .page-link {
    background-color: #667eea;
    border-color: #667eea;
    color: white;
}
</style>
{% endblock %}-e 

=== Fichier: colis/templates/colis/partials/package_card.html ===
{# ~/ebi3/colis/templates/colis/partials/package_card.html #}
{% load i18n %}
<div class="card package-card h-100">
    <!-- Badge vedette -->
    {% if package.is_featured %}
        <div class="featured-badge">
            <span class="badge bg-warning">
                <i class="fas fa-star"></i> {% trans "En vedette" %}
            </span>
        </div>
    {% endif %}

    <!-- Image principale -->
    <div class="position-relative">
        {% with package.images.first as main_image %}
            {% if main_image %}
                <img src="{{ main_image.thumbnail.url|default:main_image.image.url }}"
                     class="card-img-top package-image"
                     alt="{{ package.title }}"
                     loading="lazy">
            {% else %}
                <div class="card-img-top package-image bg-light d-flex align-items-center justify-content-center">
                    <i class="fas fa-box fa-3x text-muted"></i>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Badge type de colis -->
        <span class="position-absolute top-0 start-0 m-2 package-type-badge badge
                     {% if package.package_type == 'SMALL_PACKAGE' %}bg-success
                     {% elif package.package_type == 'MEDIUM_PACKAGE' %}bg-info
                     {% elif package.package_type == 'LARGE_PACKAGE' %}bg-warning
                     {% elif package.package_type == 'FURNITURE' %}bg-primary
                     {% else %}bg-secondary{% endif %}">
            {{ package.get_package_type_display }}
        </span>

        <!-- Badge fragile -->
        {% if package.is_fragile %}
            <span class="position-absolute top-0 end-0 m-2 fragile-badge badge bg-danger">
                <i class="fas fa-exclamation-triangle"></i> {% trans "Fragile" %}
            </span>
        {% endif %}
    </div>

    <!-- Corps de la carte -->
    <div class="card-body d-flex flex-column">
        <h5 class="card-title">
            <a href="{{ package.get_absolute_url }}" class="text-decoration-none text-dark">
                {{ package.title|truncatechars:60 }}
            </a>
        </h5>

        <!-- Trajet -->
        <div class="package-route mb-2">
            <div class="d-flex align-items-center">
                <div class="route-point start-point">
                    <i class="fas fa-map-marker-alt text-danger"></i>
                    <small>{{ package.pickup_city|truncatechars:20 }}</small>
                </div>
                <div class="route-line flex-grow-1 mx-2">
                    <hr class="my-1">
                </div>
                <div class="route-point end-point">
                    <i class="fas fa-map-marker-alt text-success"></i>
                    <small>{{ package.delivery_city|truncatechars:20 }}</small>
                </div>
            </div>
        </div>

        <!-- Informations -->
        <div class="package-info mb-3">
            <div class="row g-2">
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Poids" %}</small>
                    <strong>{{ package.weight }} kg</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Dimensions" %}</small>
                    <strong>{{ package.length }}×{{ package.width }}×{{ package.height }} cm</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Départ" %}</small>
                    <strong>{{ package.pickup_date|date:"d/m" }}</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">{% trans "Livraison" %}</small>
                    <strong>{{ package.delivery_date|date:"d/m" }}</strong>
                </div>
            </div>
        </div>

        <!-- Description -->
        <p class="card-text small text-muted mb-3">
            {{ package.description|truncatechars:120 }}
        </p>

        <!-- Prix et actions -->
        <div class="mt-auto">
            <div class="d-flex justify-content-between align-items-center">
                <div class="package-price">
                    <span class="h5 text-primary">{{ package.asking_price }} {{ package.get_currency_display }}</span>
                    {% if package.price_type == 'NEGOTIABLE' %}
                        <small class="text-muted d-block">{% trans "(Prix négociable)" %}</small>
                    {% endif %}
                </div>

                <!-- Bouton favori -->
                {% if user.is_authenticated %}
                    <button class="btn btn-sm favorite-btn
                                {% if package in user.package_favorites.all %}btn-danger{% else %}btn-outline-danger{% endif %}"
                            data-url="{% url 'colis:toggle_favorite' package.slug %}"
                            data-package-slug="{{ package.slug }}"
                            data-bs-toggle="tooltip"
                            title="{% if package in user.package_favorites.all %}{% trans 'Retirer des favoris' %}{% else %}{% trans 'Ajouter aux favoris' %}{% endif %}">
                        <i class="{% if package in user.package_favorites.all %}fas{% else %}far{% endif %} fa-heart"></i>
                    </button>
                {% else %}
                    <a href="{% url 'users:login' %}?next={{ request.path }}"
                       class="btn btn-sm btn-outline-danger requires-login"
                       data-bs-toggle="tooltip"
                       title="{% trans 'Connectez-vous pour ajouter aux favoris' %}">
                        <i class="far fa-heart"></i>
                    </a>
                {% endif %}
            </div>

            <!-- Bouton voir détails -->
            <div class="d-grid mt-3">
                <a href="{{ package.get_absolute_url }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-eye"></i> {% trans "Voir détails" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Pied de carte -->
    <div class="card-footer bg-transparent border-top">
        <div class="d-flex justify-content-between align-items-center">
            <div class="small">
                <i class="fas fa-user"></i>
                <a href="{% url 'users:profile' package.sender.username %}" class="text-decoration-none">
                    {{ package.sender.username }}
                </a>
            </div>
            <div class="small text-muted">
                <i class="fas fa-eye"></i> {{ package.view_count }}
                <i class="fas fa-gavel ms-2"></i> {{ package.offer_count }}
                <i class="fas fa-heart ms-2"></i> {{ package.favorite_count }}
            </div>
        </div>
    </div>
</div>

<style>
.package-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
}

.package-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.package-image {
    height: 180px;
    object-fit: cover;
    width: 100%;
}

.featured-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10;
}

.package-type-badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}

.fragile-badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}

.package-route .route-line hr {
    border-top: 2px dashed #dee2e6;
}

.package-price .h5 {
    font-weight: bold;
}

.route-point {
    text-align: center;
    min-width: 60px;
}

.route-point small {
    display: block;
    font-size: 0.75rem;
}
</style>-e 

=== Fichier: colis/templates/colis/partials/search_filters.html ===
{# ~/ebi3/colis/templates/colis/partials/search_filters.html #}
{% load i18n crispy_forms_tags %}
<div class="card shadow-sm">
    <div class="card-body">
        <form method="get" action="{% url 'colis:search' %}" id="search-form">
            <div class="row g-3">
                <!-- Recherche texte -->
                <div class="col-md-12">
                    <div class="input-group">
                        <input type="text"
                               name="q"
                               class="form-control"
                               placeholder="{% trans 'Que cherchez-vous à transporter ?' %}"
                               value="{{ request.GET.q|default:'' }}">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i> {% trans "Rechercher" %}
                        </button>
                    </div>
                </div>

                <!-- Filtres avancés (toggle) -->
                <div class="col-12">
                    <button class="btn btn-outline-secondary btn-sm w-100" type="button"
                            data-bs-toggle="collapse" data-bs-target="#advancedFilters"
                            aria-expanded="false" aria-controls="advancedFilters">
                        <i class="fas fa-filter"></i> {% trans "Filtres avancés" %}
                    </button>
                </div>

                <!-- Filtres avancés (contenu) -->
                <div class="collapse mt-3" id="advancedFilters">
                    <div class="row g-3">
                        <!-- Origine -->
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Départ" %}</label>
                            <input type="text"
                                   name="pickup_city"
                                   class="form-control"
                                   placeholder="{% trans 'Ville de départ' %}"
                                   value="{{ request.GET.pickup_city|default:'' }}">
                        </div>

                        <!-- Destination -->
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Destination" %}</label>
                            <input type="text"
                                   name="delivery_city"
                                   class="form-control"
                                   placeholder="{% trans 'Ville d\'arrivée' %}"
                                   value="{{ request.GET.delivery_city|default:'' }}">
                        </div>

                        <!-- Catégorie -->
                        <div class="col-md-4">
                            <label class="form-label">{% trans "Catégorie" %}</label>
                            <select name="category" class="form-select">
                                <option value="">{% trans "Toutes catégories" %}</option>
                                {% for category in categories %}
                                    <option value="{{ category.slug }}"
                                            {% if request.GET.category == category.slug %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Type de colis -->
                        <div class="col-md-4">
                            <label class="form-label">{% trans "Type" %}</label>
                            <select name="package_type" class="form-select">
                                <option value="">{% trans "Tous types" %}</option>
                                <option value="SMALL_PACKAGE" {% if request.GET.package_type == 'SMALL_PACKAGE' %}selected{% endif %}>
                                    {% trans "Petit colis (< 30kg)" %}
                                </option>
                                <option value="MEDIUM_PACKAGE" {% if request.GET.package_type == 'MEDIUM_PACKAGE' %}selected{% endif %}>
                                    {% trans "Colis moyen (30-100kg)" %}
                                </option>
                                <option value="LARGE_PACKAGE" {% if request.GET.package_type == 'LARGE_PACKAGE' %}selected{% endif %}>
                                    {% trans "Gros colis (100-500kg)" %}
                                </option>
                                <option value="FURNITURE" {% if request.GET.package_type == 'FURNITURE' %}selected{% endif %}>
                                    {% trans "Meuble" %}
                                </option>
                            </select>
                        </div>

                        <!-- Poids max -->
                        <div class="col-md-4">
                            <label class="form-label">{% trans "Poids max (kg)" %}</label>
                            <input type="number"
                                   name="max_weight"
                                   class="form-control"
                                   min="0"
                                   step="0.001"
                                   placeholder="{% trans 'Ex: 50' %}"
                                   value="{{ request.GET.max_weight|default:'' }}">
                        </div>

                        <!-- Dates -->
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Départ à partir du" %}</label>
                            <input type="date"
                                   name="pickup_date_from"
                                   class="form-control"
                                   value="{{ request.GET.pickup_date_from|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">{% trans "Départ jusqu'au" %}</label>
                            <input type="date"
                                   name="pickup_date_to"
                                   class="form-control"
                                   value="{{ request.GET.pickup_date_to|default:'' }}">
                        </div>

                        <!-- Prix -->
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Prix min" %}</label>
                            <div class="input-group">
                                <input type="number"
                                       name="min_price"
                                       class="form-control"
                                       min="0"
                                       step="0.01"
                                       placeholder="{% trans 'Min' %}"
                                       value="{{ request.GET.min_price|default:'' }}">
                                <span class="input-group-text">€</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">{% trans "Prix max" %}</label>
                            <div class="input-group">
                                <input type="number"
                                       name="max_price"
                                       class="form-control"
                                       min="0"
                                       step="0.01"
                                       placeholder="{% trans 'Max' %}"
                                       value="{{ request.GET.max_price|default:'' }}">
                                <span class="input-group-text">€</span>
                            </div>
                        </div>

                        <!-- Options -->
                        <div class="col-md-12">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input"
                                       type="checkbox"
                                       name="flexible_dates"
                                       id="flexibleDates"
                                       {% if request.GET.flexible_dates %}checked{% endif %}>
                                <label class="form-check-label" for="flexibleDates">
                                    {% trans "Dates flexibles" %}
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input"
                                       type="checkbox"
                                       name="is_fragile"
                                       id="fragileOnly"
                                       {% if request.GET.is_fragile %}checked{% endif %}>
                                <label class="form-check-label" for="fragileOnly">
                                    {% trans "Fragile seulement" %}
                                </label>
                            </div>
                        </div>

                        <!-- Boutons -->
                        <div class="col-md-12">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-grow-1">
                                    <i class="fas fa-filter"></i> {% trans "Appliquer les filtres" %}
                                </button>
                                <a href="{% url 'colis:package_list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> {% trans "Effacer" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
$(document).ready(function() {
    // Auto-submit sur changement de certains filtres
    $('select[name="category"], select[name="package_type"]').change(function() {
        $('#search-form').submit();
    });

    // Pré-remplir la date de départ à partir d'aujourd'hui
    if (!$('input[name="pickup_date_from"]').val()) {
        const today = new Date().toISOString().split('T')[0];
        $('input[name="pickup_date_from"]').val(today);
    }
});
</script>-e 

=== Fichier: colis/templates/colis/base_colis.html ===
{# ~/ebi3/colis/templates/colis/base_colis.html #}
{% extends 'core/base.html' %}
{% load i18n static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'colis/css/colis.css' %}">
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'colis/js/colis.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Bannière principale -->
    <div class="colis-banner bg-primary text-white py-5 mb-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold">
                        {% block colis_title %}{% trans "Transportez vos colis en toute confiance" %}{% endblock %}
                    </h1>
                    <p class="lead">
                        {% trans "Des milliers de transporteurs disponibles pour vos envois" %}
                    </p>
                </div>
                <div class="col-lg-4 text-lg-end">
                    {% if user.is_authenticated %}
                        <a href="{% url 'colis:package_create' %}" class="btn btn-light btn-lg">
                            <i class="fas fa-plus-circle"></i> {% trans "Publier un colis" %}
                        </a>
                    {% else %}
                        <a href="{% url 'users:login' %}?next={% url 'colis:package_create' %}" class="btn btn-light btn-lg">
                            <i class="fas fa-user-plus"></i> {% trans "Commencez gratuitement" %}
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Barre de recherche -->
    <div class="container mb-4">
        {% include 'colis/partials/search_filters.html' %}
    </div>

    <!-- Contenu principal -->
    <div class="container">
        <div class="row">
            <!-- Sidebar gauche -->
            <div class="col-lg-3 d-none d-lg-block">
                {% include 'colis/layout/sidebar.html' %}
            </div>

            <!-- Contenu central -->
            <div class="col-lg-9">
                <!-- Messages -->
                {% if messages %}
                    <div class="messages mb-4">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Fil d'Ariane -->
                {% include 'colis/layout/breadcrumb.html' %}

                <!-- Contenu spécifique -->
                {% block colis_content %}{% endblock %}
            </div>
        </div>
    </div>
</div>

<!-- Widget d'aide -->
{% include 'colis/includes/help_widget.html' %}

<!-- Modal de connexion -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Connexion requise" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p>{% trans "Vous devez être connecté pour effectuer cette action." %}</p>
                <div class="d-grid gap-2">
                    <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> {% trans "Se connecter" %}
                    </a>
                    <a href="{% url 'users:register' %}" class="btn btn-outline-primary">
                        <i class="fas fa-user-plus"></i> {% trans "Créer un compte" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_body_js %}
<script>
$(document).ready(function() {
    // Initialisation des tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Gestion des modales de connexion
    $('.requires-login').click(function(e) {
        if (!{{ user.is_authenticated|yesno:"true,false" }}) {
            e.preventDefault();
            $('#loginModal').modal('show');
        }
    });

    // Calcul automatique du volume
    $('.volume-calculator').on('input', function() {
        const length = parseFloat($('#id_length').val()) || 0;
        const width = parseFloat($('#id_width').val()) || 0;
        const height = parseFloat($('#id_height').val()) || 0;

        if (length > 0 && width > 0 && height > 0) {
            const volume = (length * width * height) / 1000;
            $('#volume-preview').text(volume.toFixed(2) + ' L').removeClass('d-none');
        }
    });
});
</script>
{% endblock %}-e 

=== Fichier: colis/sitemaps.py ===
# ~/ebi3/colis/sitemaps.py
"""
Sitemaps XML pour l'application colis
Améliore le SEO en fournissant aux moteurs de recherche
une carte complète du contenu du site
"""

from datetime import datetime, timezone
from django.contrib import sitemaps
from django.urls import reverse
from django.contrib.sites.models import Site
from django.utils.translation import gettext_lazy as _
from django.db.models import F
from .models import Package, PackageCategory


# ============================================================================
# SITEMAPS STATIQUES
# ============================================================================

class StaticSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les pages statiques de l'application colis
    """
    priority = 1.0
    changefreq = 'monthly'
    protocol = 'https'

    def items(self):
        return [
            'colis:package_list',
            'colis:search',
            'colis:how_it_works',
            'colis:pricing',
            'colis:faq',
            'colis:contact',
            'colis:terms',
            'colis:privacy',
            'colis:safety',
            'colis:become_carrier',
            'colis:success_stories',
            'colis:testimonials',
        ]

    def location(self, item):
        return reverse(item)

    def lastmod(self, item):
        """
        Retourne la date de dernière modification des pages statiques
        """
        # Pour les pages statiques, on utilise une date fixe
        # ou la date de déploiement
        return datetime(2024, 1, 1, tzinfo=timezone.utc)


class CategorySitemap(sitemaps.Sitemap):
    """
    Sitemap pour les catégories de colis
    """
    changefreq = 'weekly'
    priority = 0.8
    protocol = 'https'

    def items(self):
        """
        Retourne toutes les catégories actives avec au moins un colis disponible
        """
        return PackageCategory.objects.filter(
            is_active=True,
            packages__status='AVAILABLE'
        ).distinct().order_by('lft')

    def location(self, obj):
        return reverse('colis:category_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        """
        Dernière modification = date du dernier colis ajouté dans cette catégorie
        """
        last_package = obj.packages.filter(status='AVAILABLE').order_by('-created_at').first()
        if last_package:
            return last_package.created_at
        return obj.updated_at

    def priority(self, obj):
        """
        Priorité SEO basée sur le nombre de colis dans la catégorie
        """
        package_count = obj.packages.filter(status='AVAILABLE').count()
        if package_count > 100:
            return 0.9
        elif package_count > 50:
            return 0.8
        elif package_count > 20:
            return 0.7
        else:
            return 0.6


# ============================================================================
# SITEMAPS DYNAMIQUES - PACKAGES
# ============================================================================

class PackageSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les colis individuels
    Optimisé pour les colis disponibles et récents
    """
    changefreq = 'daily'
    protocol = 'https'
    limit = 5000  # Limite Google sitemap

    def items(self):
        """
        Retourne les colis disponibles pour le sitemap
        """
        # Filtrer les colis disponibles et actifs
        return Package.objects.filter(
            status__in=['AVAILABLE', 'RESERVED', 'IN_TRANSIT'],
            is_archived=False
        ).select_related(
            'sender', 'category'
        ).prefetch_related(
            'images'
        ).order_by('-created_at')

    def location(self, obj):
        return reverse('colis:package_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        """
        Dernière modification = max(created_at, updated_at)
        """
        return max(obj.created_at, obj.updated_at) if obj.updated_at else obj.created_at

    def priority(self, obj):
        """
        Priorité SEO basée sur l'âge et le statut du colis
        """
        # Calculer l'âge en jours
        age_days = (datetime.now(timezone.utc) - obj.created_at).days

        # Priorité basée sur l'âge
        if age_days < 7:  # Moins d'une semaine
            return 0.9
        elif age_days < 30:  # Moins d'un mois
            return 0.8
        elif age_days < 90:  # Moins de 3 mois
            return 0.7
        else:
            return 0.6

    def changefreq(self, obj):
        """
        Fréquence de changement basée sur le statut
        """
        if obj.status == 'AVAILABLE':
            return 'daily'  # Les colis disponibles changent souvent
        elif obj.status == 'RESERVED':
            return 'weekly'
        elif obj.status == 'IN_TRANSIT':
            return 'daily'  # Suivi en temps réel
        else:
            return 'monthly'


class PackageIndexSitemap(sitemaps.Sitemap):
    """
    Sitemap d'index pour les pages de liste de colis avec filtres
    """
    changefreq = 'daily'
    priority = 0.7
    protocol = 'https'

    def items(self):
        """
        Génère des URLs de filtrage pour les moteurs de recherche
        """
        items = []

        # 1. Pages principales de filtrage
        items.append(('colis:package_list', {}))

        # 2. Filtres par catégorie
        categories = PackageCategory.objects.filter(
            is_active=True,
            packages__status='AVAILABLE'
        ).distinct()[:50]  # Limiter à 50 catégories

        for category in categories:
            items.append(('colis:category_detail', {'slug': category.slug}))

        # 3. Filtres par pays
        from django_countries import countries
        popular_countries = ['FR', 'MA', 'TN', 'DZ', 'BE', 'CH', 'CA']

        for country_code in popular_countries:
            items.append(('colis:package_list', {'country_to': country_code}))

        # 4. Filtres par prix (plages)
        price_ranges = [
            (0, 100),
            (100, 500),
            (500, 1000),
            (1000, 5000),
        ]

        for min_price, max_price in price_ranges:
            items.append(('colis:search', {
                'min_price': min_price,
                'max_price': max_price
            }))

        return items

    def location(self, item):
        url_name, params = item
        return reverse(url_name, kwargs=params) if params else reverse(url_name)


# ============================================================================
# SITEMAPS DYNAMIQUES - TRANSPORTEURS (OPTIONNEL)
# ============================================================================

class CarrierSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les profils de transporteurs
    """
    changefreq = 'weekly'
    priority = 0.7
    protocol = 'https'
    limit = 2000

    def items(self):
        """
        Transporteurs actifs et vérifiés
        Note: Cette classe est optionnelle, dépend de l'existence du modèle Carrier
        """
        try:
            from carriers.models import Carrier
            return Carrier.objects.filter(
                status='APPROVED',
                is_available=True,
                verification_level__gte=2  # Au moins partiellement vérifié
            ).select_related('user').order_by('-average_rating', '-total_missions')
        except ImportError:
            # Retourner une liste vide si l'application carriers n'est pas disponible
            return []

    def location(self, obj):
        from django.urls import reverse
        return reverse('carriers:carrier_detail', kwargs={'username': obj.user.username})

    def lastmod(self, obj):
        """
        Dernière modification = date de dernière mise à jour du profil
        """
        return max(obj.user.date_joined, obj.updated_at)

    def priority(self, obj):
        """
        Priorité basée sur la réputation du transporteur
        """
        if obj.average_rating >= 4.5 and obj.total_missions > 50:
            return 0.9
        elif obj.average_rating >= 4.0 and obj.total_missions > 20:
            return 0.8
        elif obj.average_rating >= 3.5:
            return 0.7
        else:
            return 0.6


# ============================================================================
# SITEMAPS SPÉCIALISÉS
# ============================================================================

class RecentPackagesSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les colis récemment ajoutés (dernières 24h)
    """
    changefreq = 'hourly'
    priority = 1.0
    protocol = 'https'
    limit = 100

    def items(self):
        from django.utils import timezone
        yesterday = timezone.now() - timezone.timedelta(days=1)

        return Package.objects.filter(
            status='AVAILABLE',
            created_at__gte=yesterday,
            is_archived=False
        ).order_by('-created_at')[:self.limit]

    def location(self, obj):
        return reverse('colis:package_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        return obj.created_at


class PopularPackagesSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les colis populaires (plus de vues/favoris)
    """
    changefreq = 'daily'
    priority = 0.9
    protocol = 'https'
    limit = 100

    def items(self):
        """
        Colis les plus populaires basés sur les vues et favoris
        """
        return Package.objects.filter(
            status='AVAILABLE',
            is_archived=False
        ).annotate(
            popularity_score=(F('view_count') * 1) + (F('favorite_count') * 3)
        ).order_by('-popularity_score', '-created_at')[:self.limit]

    def location(self, obj):
        return reverse('colis:package_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        return max(obj.created_at, obj.updated_at) if obj.updated_at else obj.created_at


class GeoPackageSitemap(sitemaps.Sitemap):
    """
    Sitemap géographique pour les colis par ville/région
    """
    changefreq = 'weekly'
    priority = 0.8
    protocol = 'https'

    def items(self):
        """
        Retourne les combinaisons uniques pays/ville avec au moins 5 colis
        """
        from django.db.models import Count
        from django.db.models.functions import Lower

        return Package.objects.filter(
            status='AVAILABLE'
        ).values(
            'country_to', 'city_to'
        ).annotate(
            package_count=Count('id')
        ).filter(
            package_count__gte=5
        ).order_by('country_to', Lower('city_to'))

    def location(self, obj):
        """
        URL de recherche filtrée par ville
        """
        return reverse('colis:search') + f'?country_to={obj["country_to"]}&city_to={obj["city_to"]}'

    def lastmod(self, obj):
        """
        Dernière modification = date du dernier colis pour cette destination
        """
        last_package = Package.objects.filter(
            country_to=obj['country_to'],
            city_to=obj['city_to'],
            status='AVAILABLE'
        ).order_by('-created_at').first()

        return last_package.created_at if last_package else datetime.now(timezone.utc)


# ============================================================================
# SITEMAPS AVANCÉS POUR SEO TECHNIQUE
# ============================================================================

class XMLIndexSitemap(sitemaps.Sitemap):
    """
    Sitemap d'index qui liste tous les autres sitemaps
    """
    def items(self):
        """
        Liste de tous les sitemaps à inclure dans l'index
        """
        current_site = Site.objects.get_current()
        base_url = f"https://{current_site.domain}/colis/sitemap_"

        sitemaps_list = [
            f"{base_url}static.xml",
            f"{base_url}categories.xml",
            f"{base_url}packages.xml",
        ]

        # Ajouter conditionnellement le sitemap des transporteurs
        try:
            from carriers.models import Carrier
            if Carrier.objects.exists():
                sitemaps_list.append(f"{base_url}carriers.xml")
        except ImportError:
            pass

        # Ajouter d'autres sitemaps conditionnels
        if Package.objects.filter(status='AVAILABLE').count() > 100:
            sitemaps_list.extend([
                f"{base_url}recent.xml",
                f"{base_url}popular.xml",
            ])

        if Package.objects.filter(status='AVAILABLE').count() > 500:
            sitemaps_list.append(f"{base_url}geo.xml")

        return sitemaps_list

    def location(self, item):
        return item

    def lastmod(self, item):
        """
        Tous les sitemaps sont mis à jour quotidiennement
        """
        return datetime.now(timezone.utc).replace(hour=0, minute=0, second=0, microsecond=0)


class MobileSitemap(sitemaps.Sitemap):
    """
    Sitemap spécifique pour les versions mobiles
    """
    changefreq = 'daily'
    priority = 0.9
    protocol = 'https'
    limit = 1000

    def items(self):
        """
        Colis optimisés pour mobile (avec images et descriptions courtes)
        """
        return Package.objects.filter(
            status='AVAILABLE',
            images__isnull=False,  # Au moins une image
            is_archived=False
        ).exclude(
            description__isnull=True
        ).exclude(
            description=''
        ).distinct().order_by('-created_at')[:self.limit]

    def location(self, obj):
        return reverse('colis:package_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        return max(obj.created_at, obj.updated_at) if obj.updated_at else obj.created_at


class ImageSitemap(sitemaps.Sitemap):
    """
    Sitemap pour les images des colis (Google Images SEO)
    """
    changefreq = 'weekly'
    priority = 0.6
    protocol = 'https'
    limit = 1000

    def items(self):
        """
        Retourne les colis avec des images
        """
        return Package.objects.filter(
            images__isnull=False,
            status__in=['AVAILABLE', 'RESERVED', 'IN_TRANSIT'],
            is_archived=False
        ).prefetch_related('images').distinct().order_by('-created_at')[:self.limit]

    def location(self, obj):
        return reverse('colis:package_detail', kwargs={'slug': obj.slug})

    def lastmod(self, obj):
        return max(obj.created_at, obj.updated_at) if obj.updated_at else obj.created_at

    def _get_images(self, obj):
        """
        Retourne les informations des images pour le sitemap
        """
        images = []
        for img in obj.images.all()[:10]:  # Limiter à 10 images par colis
            if img.image:
                images.append({
                    'location': img.image.url,
                    'title': img.caption or f"Image de {obj.title}",
                    'caption': img.caption or f"Photo du colis {obj.title}",
                    'license': 'https://creativecommons.org/licenses/by-nc-sa/4.0/',
                })
        return images


# ============================================================================
# SITEMAP FACTORY ET REGISTRE
# ============================================================================

def get_colis_sitemaps():
    """
    Retourne un dictionnaire de tous les sitemaps pour l'application colis
    """
    sitemaps_dict = {
        'static': StaticSitemap,
        'categories': CategorySitemap,
        'packages': PackageSitemap,
        'index': XMLIndexSitemap,
    }

    # Ajouter conditionnellement le sitemap des transporteurs
    try:
        from carriers.models import Carrier
        if Carrier.objects.exists():
            sitemaps_dict['carriers'] = CarrierSitemap
    except ImportError:
        pass

    # Ajouter des sitemaps supplémentaires
    if Package.objects.filter(status='AVAILABLE').count() > 0:
        sitemaps_dict['recent'] = RecentPackagesSitemap
        sitemaps_dict['popular'] = PopularPackagesSitemap
        sitemaps_dict['mobile'] = MobileSitemap
        sitemaps_dict['images'] = ImageSitemap

    if Package.objects.filter(status='AVAILABLE').count() > 500:
        sitemaps_dict['geo'] = GeoPackageSitemap

    return sitemaps_dict


def get_active_sitemaps():
    """
    Retourne les sitemaps actifs selon le contexte
    """
    sitemaps = {
        'static': StaticSitemap(),
        'categories': CategorySitemap(),
        'packages': PackageSitemap(),
    }

    # Ajouter conditionnellement le sitemap des transporteurs
    try:
        from carriers.models import Carrier
        if Carrier.objects.filter(status='APPROVED').exists():
            sitemaps['carriers'] = CarrierSitemap()
    except (ImportError, ModuleNotFoundError):
        # L'application carriers n'est pas disponible ou pas installée
        pass

    # Ajouter des sitemaps supplémentaires si beaucoup de contenu
    package_count = Package.objects.filter(status='AVAILABLE').count()

    if package_count > 0:
        sitemaps['recent'] = RecentPackagesSitemap()
        sitemaps['popular'] = PopularPackagesSitemap()
        sitemaps['mobile'] = MobileSitemap()
        sitemaps['images'] = ImageSitemap()

    if package_count > 500:
        sitemaps['geo'] = GeoPackageSitemap()

    return sitemaps


# ============================================================================
# UTILITAIRES POUR GÉNÉRATION DE SITEMAP
# ============================================================================

class SitemapGenerator:
    """
    Classe utilitaire pour générer et gérer les sitemaps
    """

    @staticmethod
    def generate_sitemap_index():
        """
        Génère le contenu XML de l'index des sitemaps
        """
        current_site = Site.objects.get_current()
        sitemaps = get_active_sitemaps()

        xml_content = '<?xml version="1.0" encoding="UTF-8"?>\n'
        xml_content += '<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n'

        for name, sitemap in sitemaps.items():
            if name != 'index':  # Exclure l'index lui-même
                url = f"https://{current_site.domain}/colis/sitemap_{name}.xml"
                lastmod = datetime.now(timezone.utc).strftime('%Y-%m-%d')

                xml_content += f'  <sitemap>\n'
                xml_content += f'    <loc>{url}</loc>\n'
                xml_content += f'    <lastmod>{lastmod}</lastmod>\n'
                xml_content += f'  </sitemap>\n'

        xml_content += '</sitemapindex>'
        return xml_content

    @staticmethod
    def get_sitemap_stats():
        """
        Retourne des statistiques sur les sitemaps
        """
        stats = {
            'total_urls': 0,
            'by_type': {},
            'last_generated': datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S'),
        }

        sitemaps = get_active_sitemaps()

        for name, sitemap in sitemaps.items():
            try:
                if hasattr(sitemap, 'items'):
                    items = sitemap.items()
                    if hasattr(items, 'count'):
                        count = items.count()
                    else:
                        count = len(items)
                    stats['by_type'][name] = count
                    stats['total_urls'] += count
                else:
                    stats['by_type'][name] = 0
            except Exception as e:
                stats['by_type'][name] = f"Error: {str(e)[:50]}"

        return stats

    @staticmethod
    def validate_sitemap_urls():
        """
        Valide que toutes les URLs du sitemap sont valides
        """
        from django.urls import resolve, Resolver404

        sitemaps = get_active_sitemaps()
        validation_results = []

        for name, sitemap in sitemaps.items():
            if hasattr(sitemap, 'items'):
                items = sitemap.items()[:5]  # Tester seulement les 5 premiers

                for item in items:
                    try:
                        url = sitemap.location(item)

                        # Tester la résolution de l'URL
                        try:
                            resolve(url)
                            url_valid = True
                        except Resolver404:
                            url_valid = False

                        validation_results.append({
                            'sitemap': name,
                            'url': url,
                            'item': str(item)[:100],
                            'url_valid': url_valid,
                        })
                    except Exception as e:
                        validation_results.append({
                            'sitemap': name,
                            'url': 'ERROR',
                            'item': str(item)[:100],
                            'error': str(e)[:100],
                        })

        return validation_results-e 

=== Fichier: colis/migrations/0002_initial.py ===
# Generated by Django 6.0 on 2025-12-31 08:04

import django.db.models.deletion
import mptt.fields
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("carriers", "0002_initial"),
        ("colis", "0001_initial"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name="package",
            name="sender",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="sent_packages",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Expéditeur",
            ),
        ),
        migrations.AddField(
            model_name="packagecategory",
            name="parent",
            field=mptt.fields.TreeForeignKey(
                blank=True,
                help_text="Sélectionnez une catégorie parente si applicable",
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="children",
                to="colis.packagecategory",
                verbose_name="Catégorie parente",
            ),
        ),
        migrations.AddField(
            model_name="package",
            name="category",
            field=mptt.fields.TreeForeignKey(
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="packages",
                to="colis.packagecategory",
                verbose_name="Catégorie",
            ),
        ),
        migrations.AddField(
            model_name="packagefavorite",
            name="package",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="favorited_by",
                to="colis.package",
                verbose_name="Colis",
            ),
        ),
        migrations.AddField(
            model_name="packagefavorite",
            name="user",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="package_favorites",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="packageimage",
            name="package",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="images",
                to="colis.package",
                verbose_name="Colis",
            ),
        ),
        migrations.AddField(
            model_name="packagereport",
            name="package",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="reports",
                to="colis.package",
                verbose_name="Colis",
            ),
        ),
        migrations.AddField(
            model_name="packagereport",
            name="reporter",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="package_reports",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Signaleur",
            ),
        ),
        migrations.AddField(
            model_name="packagereport",
            name="resolved_by",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="resolved_package_reports",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Résolu par",
            ),
        ),
        migrations.AddField(
            model_name="packageview",
            name="package",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="views_tracking",
                to="colis.package",
                verbose_name="Colis",
            ),
        ),
        migrations.AddField(
            model_name="packageview",
            name="user",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="package_views",
                to=settings.AUTH_USER_MODEL,
                verbose_name="Utilisateur",
            ),
        ),
        migrations.AddField(
            model_name="transportoffer",
            name="carrier",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="transport_offers",
                to="carriers.carrier",
                verbose_name="Transporteur",
            ),
        ),
        migrations.AddField(
            model_name="transportoffer",
            name="package",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="transport_offers",
                to="colis.package",
                verbose_name="Colis",
            ),
        ),
        migrations.AddIndex(
            model_name="packagecategory",
            index=models.Index(
                fields=["slug", "is_active"], name="colis_packa_slug_606730_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="packagecategory",
            index=models.Index(
                fields=["parent", "is_active"], name="colis_packa_parent__f4d408_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="packagecategory",
            index=models.Index(
                fields=["tree_id", "lft"], name="colis_packagecategory_treef25a"
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["status", "created_at"], name="colis_packa_status_6b831c_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["sender", "status"], name="colis_packa_sender__0df8ca_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["pickup_country", "delivery_country"],
                name="colis_packa_pickup__0f1de9_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["pickup_date", "delivery_date"],
                name="colis_packa_pickup__5ccd61_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["package_type", "status"], name="colis_packa_package_18febe_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="package",
            index=models.Index(
                fields=["asking_price", "status"], name="colis_packa_asking__314189_idx"
            ),
        ),
        migrations.AlterUniqueTogether(
            name="packagefavorite",
            unique_together={("user", "package")},
        ),
        migrations.AddConstraint(
            model_name="packageimage",
            constraint=models.UniqueConstraint(
                condition=models.Q(("is_primary", True)),
                fields=("package",),
                name="unique_primary_image_per_package",
            ),
        ),
        migrations.AddIndex(
            model_name="packageview",
            index=models.Index(
                fields=["package", "viewed_at"], name="colis_packa_package_17fa2f_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="packageview",
            index=models.Index(
                fields=["session_key", "package"], name="colis_packa_session_2431f0_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="packageview",
            index=models.Index(
                fields=["user", "viewed_at"], name="colis_packa_user_id_60ad9e_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="transportoffer",
            index=models.Index(
                fields=["package", "status"], name="colis_trans_package_727735_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="transportoffer",
            index=models.Index(
                fields=["carrier", "status"], name="colis_trans_carrier_487e10_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="transportoffer",
            index=models.Index(
                fields=["status", "expires_at"], name="colis_trans_status_3a1514_idx"
            ),
        ),
        migrations.AlterUniqueTogether(
            name="transportoffer",
            unique_together={("package", "carrier")},
        ),
    ]
-e 

=== Fichier: colis/migrations/0001_initial.py ===
# Generated by Django 6.0 on 2025-12-31 08:04

import colis.models
import django.core.validators
import django_countries.fields
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name="PackageStatistics",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
            ],
            options={
                "verbose_name": "Statistiques",
                "verbose_name_plural": "Statistiques",
                "managed": False,
            },
        ),
        migrations.CreateModel(
            name="Package",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "title",
                    models.CharField(
                        db_index=True, max_length=200, verbose_name="Titre du colis"
                    ),
                ),
                (
                    "slug",
                    models.SlugField(max_length=200, unique=True, verbose_name="Slug"),
                ),
                (
                    "description",
                    models.TextField(
                        help_text="Décrivez votre colis en détail",
                        verbose_name="Description détaillée",
                    ),
                ),
                (
                    "package_type",
                    models.CharField(
                        choices=[
                            ("SMALL_PACKAGE", "Petit colis (< 30kg)"),
                            ("MEDIUM_PACKAGE", "Colis moyen (30-100kg)"),
                            ("LARGE_PACKAGE", "Gros colis (100-500kg)"),
                            ("FURNITURE", "Meuble"),
                            ("PALLET", "Palette"),
                            ("VEHICLE_PART", "Pièce auto"),
                            ("OTHER", "Autre"),
                        ],
                        max_length=20,
                        verbose_name="Type de colis",
                    ),
                ),
                (
                    "weight",
                    models.DecimalField(
                        decimal_places=3,
                        help_text="Poids en kilogrammes",
                        max_digits=8,
                        verbose_name="Poids (kg)",
                    ),
                ),
                (
                    "length",
                    models.DecimalField(
                        decimal_places=2, max_digits=8, verbose_name="Longueur (cm)"
                    ),
                ),
                (
                    "width",
                    models.DecimalField(
                        decimal_places=2, max_digits=8, verbose_name="Largeur (cm)"
                    ),
                ),
                (
                    "height",
                    models.DecimalField(
                        decimal_places=2, max_digits=8, verbose_name="Hauteur (cm)"
                    ),
                ),
                (
                    "volume",
                    models.DecimalField(
                        blank=True,
                        decimal_places=3,
                        editable=False,
                        max_digits=10,
                        null=True,
                        verbose_name="Volume (L)",
                    ),
                ),
                (
                    "pickup_country",
                    django_countries.fields.CountryField(
                        help_text="Pays où se trouve le colis",
                        max_length=2,
                        verbose_name="Pays de départ",
                    ),
                ),
                (
                    "pickup_city",
                    models.CharField(max_length=100, verbose_name="Ville de départ"),
                ),
                (
                    "pickup_address",
                    models.TextField(blank=True, verbose_name="Adresse de départ"),
                ),
                (
                    "pickup_postal_code",
                    models.CharField(
                        blank=True, max_length=20, verbose_name="Code postal départ"
                    ),
                ),
                (
                    "pickup_latitude",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Latitude départ",
                    ),
                ),
                (
                    "pickup_longitude",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Longitude départ",
                    ),
                ),
                (
                    "delivery_country",
                    django_countries.fields.CountryField(
                        help_text="Pays où le colis doit être livré",
                        max_length=2,
                        verbose_name="Pays de destination",
                    ),
                ),
                (
                    "delivery_city",
                    models.CharField(
                        max_length=100, verbose_name="Ville de destination"
                    ),
                ),
                (
                    "delivery_address",
                    models.TextField(blank=True, verbose_name="Adresse de destination"),
                ),
                (
                    "delivery_postal_code",
                    models.CharField(
                        blank=True,
                        max_length=20,
                        verbose_name="Code postal destination",
                    ),
                ),
                (
                    "delivery_latitude",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Latitude destination",
                    ),
                ),
                (
                    "delivery_longitude",
                    models.DecimalField(
                        blank=True,
                        decimal_places=6,
                        max_digits=9,
                        null=True,
                        verbose_name="Longitude destination",
                    ),
                ),
                (
                    "pickup_date",
                    models.DateField(
                        help_text="Date à laquelle le colis est disponible",
                        verbose_name="Date de départ souhaitée",
                    ),
                ),
                (
                    "delivery_date",
                    models.DateField(
                        help_text="Date limite de livraison",
                        verbose_name="Date de livraison souhaitée",
                    ),
                ),
                (
                    "flexible_dates",
                    models.BooleanField(
                        default=False,
                        help_text="Accepte des dates différentes de celles demandées",
                        verbose_name="Dates flexibles",
                    ),
                ),
                (
                    "price_type",
                    models.CharField(
                        choices=[
                            ("FIXED", "Prix fixe"),
                            ("NEGOTIABLE", "Prix négociable"),
                            ("AUCTION", "Mise aux enchères"),
                        ],
                        default="NEGOTIABLE",
                        max_length=20,
                        verbose_name="Type de prix",
                    ),
                ),
                (
                    "asking_price",
                    models.DecimalField(
                        decimal_places=2,
                        help_text="Prix en devise de départ",
                        max_digits=10,
                        verbose_name="Prix demandé",
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                        ],
                        default="EUR",
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "estimated_distance",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        verbose_name="Distance estimée (km)",
                    ),
                ),
                (
                    "is_fragile",
                    models.BooleanField(default=False, verbose_name="Fragile"),
                ),
                (
                    "requires_insurance",
                    models.BooleanField(
                        default=False, verbose_name="Requiert assurance"
                    ),
                ),
                (
                    "insurance_value",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        verbose_name="Valeur à assurer",
                    ),
                ),
                (
                    "requires_packaging",
                    models.BooleanField(
                        default=False, verbose_name="Requiert emballage"
                    ),
                ),
                (
                    "requires_loading_help",
                    models.BooleanField(
                        default=False, verbose_name="Requiert aide au chargement"
                    ),
                ),
                (
                    "requires_unloading_help",
                    models.BooleanField(
                        default=False, verbose_name="Requiert aide au déchargement"
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("DRAFT", "Brouillon"),
                            ("AVAILABLE", "Disponible"),
                            ("RESERVED", "Réservé"),
                            ("IN_TRANSIT", "En transit"),
                            ("DELIVERED", "Livré"),
                            ("CANCELLED", "Annulé"),
                            ("EXPIRED", "Expiré"),
                        ],
                        db_index=True,
                        default="DRAFT",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "is_featured",
                    models.BooleanField(default=False, verbose_name="Colis en vedette"),
                ),
                (
                    "featured_until",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="En vedette jusqu'au"
                    ),
                ),
                (
                    "meta_keywords",
                    models.CharField(
                        blank=True, max_length=500, verbose_name="Mots-clés SEO"
                    ),
                ),
                (
                    "meta_description",
                    models.TextField(blank=True, verbose_name="Description SEO"),
                ),
                (
                    "view_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre de vues"
                    ),
                ),
                (
                    "offer_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre d'offres"
                    ),
                ),
                (
                    "favorite_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre de favoris"
                    ),
                ),
                (
                    "free_images_allowed",
                    models.PositiveIntegerField(
                        default=5, verbose_name="Nombre de photos gratuites"
                    ),
                ),
                (
                    "paid_images_used",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Photos payantes utilisées"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True, db_index=True)),
                ("published_at", models.DateTimeField(blank=True, null=True)),
                ("expired_at", models.DateTimeField(blank=True, null=True)),
                ("reserved_at", models.DateTimeField(blank=True, null=True)),
                ("delivered_at", models.DateTimeField(blank=True, null=True)),
            ],
            options={
                "verbose_name": "Colis",
                "verbose_name_plural": "Colis",
                "ordering": ["-created_at"],
                "permissions": [
                    ("can_feature_package", "Peut mettre en vedette un colis"),
                    ("can_moderate_package", "Peut modérer les colis"),
                ],
            },
        ),
        migrations.CreateModel(
            name="PackageCategory",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "name",
                    models.CharField(
                        db_index=True,
                        max_length=200,
                        verbose_name="Nom de la catégorie",
                    ),
                ),
                (
                    "slug",
                    models.SlugField(
                        help_text="Version URL-friendly du nom",
                        max_length=200,
                        unique=True,
                        verbose_name="Slug",
                    ),
                ),
                (
                    "description",
                    models.TextField(
                        blank=True,
                        help_text="Description détaillée de la catégorie",
                        verbose_name="Description",
                    ),
                ),
                (
                    "icon",
                    models.CharField(
                        blank=True,
                        help_text="Exemple: fa-box, fa-couch, fa-tshirt",
                        max_length=100,
                        verbose_name="Icône FontAwesome",
                    ),
                ),
                (
                    "image",
                    models.ImageField(
                        blank=True,
                        null=True,
                        upload_to="colis/categories/",
                        verbose_name="Image de la catégorie",
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(
                        default=True,
                        help_text="Désactiver pour cacher la catégorie",
                        verbose_name="Active",
                    ),
                ),
                (
                    "show_in_menu",
                    models.BooleanField(
                        default=True, verbose_name="Afficher dans le menu"
                    ),
                ),
                (
                    "display_order",
                    models.PositiveIntegerField(
                        default=0,
                        help_text="Plus le nombre est bas, plus c'est prioritaire",
                        verbose_name="Ordre d'affichage",
                    ),
                ),
                (
                    "requires_dimensions",
                    models.BooleanField(
                        default=True,
                        help_text="Les colis de cette catégorie doivent avoir des dimensions",
                        verbose_name="Requiert dimensions",
                    ),
                ),
                (
                    "requires_weight",
                    models.BooleanField(
                        default=True,
                        help_text="Les colis de cette catégorie doivent avoir un poids",
                        verbose_name="Requiert poids",
                    ),
                ),
                (
                    "meta_title",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Titre SEO"
                    ),
                ),
                (
                    "meta_description",
                    models.TextField(blank=True, verbose_name="Description SEO"),
                ),
                (
                    "package_count",
                    models.PositiveIntegerField(
                        default=0, editable=False, verbose_name="Nombre de colis"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("lft", models.PositiveIntegerField(editable=False)),
                ("rght", models.PositiveIntegerField(editable=False)),
                ("tree_id", models.PositiveIntegerField(db_index=True, editable=False)),
                ("level", models.PositiveIntegerField(editable=False)),
            ],
            options={
                "verbose_name": "Catégorie de colis",
                "verbose_name_plural": "Catégories de colis",
                "ordering": ["display_order", "name"],
            },
        ),
        migrations.CreateModel(
            name="PackageFavorite",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Colis favori",
                "verbose_name_plural": "Colis favoris",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="PackageImage",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "image",
                    models.ImageField(
                        upload_to=colis.models.package_image_upload_path,
                        validators=[
                            django.core.validators.FileExtensionValidator(
                                ["jpg", "jpeg", "png", "webp"]
                            ),
                            colis.models.validate_file_size,
                        ],
                        verbose_name="Image",
                    ),
                ),
                (
                    "thumbnail",
                    models.ImageField(
                        blank=True,
                        editable=False,
                        null=True,
                        upload_to="colis/thumbnails/",
                        verbose_name="Miniature",
                    ),
                ),
                (
                    "caption",
                    models.CharField(
                        blank=True, max_length=200, verbose_name="Légende"
                    ),
                ),
                (
                    "is_primary",
                    models.BooleanField(default=False, verbose_name="Image principale"),
                ),
                (
                    "display_order",
                    models.PositiveIntegerField(
                        default=0, verbose_name="Ordre d'affichage"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Image de colis",
                "verbose_name_plural": "Images de colis",
                "ordering": ["is_primary", "display_order", "created_at"],
            },
        ),
        migrations.CreateModel(
            name="PackageReport",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "reason",
                    models.CharField(
                        choices=[
                            ("SPAM", "Spam ou publicité"),
                            ("FRAUD", "Fraude ou arnaque"),
                            ("INAPPROPRIATE", "Contenu inapproprié"),
                            ("WRONG_CATEGORY", "Mauvaise catégorie"),
                            ("PROHIBITED", "Article prohibé"),
                            ("DUPLICATE", "Colis en double"),
                            ("OTHER", "Autre"),
                        ],
                        max_length=20,
                        verbose_name="Raison du signalement",
                    ),
                ),
                (
                    "description",
                    models.TextField(blank=True, verbose_name="Description détaillée"),
                ),
                (
                    "evidence",
                    models.FileField(
                        blank=True,
                        null=True,
                        upload_to="colis/reports/",
                        verbose_name="Preuve",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("IN_REVIEW", "En revue"),
                            ("RESOLVED", "Résolu"),
                            ("DISMISSED", "Rejeté"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "admin_notes",
                    models.TextField(
                        blank=True, verbose_name="Notes de l'administrateur"
                    ),
                ),
                (
                    "resolved_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Résolu le"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Signalement de colis",
                "verbose_name_plural": "Signalements de colis",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="PackageView",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "session_key",
                    models.CharField(
                        db_index=True, max_length=40, verbose_name="Clé de session"
                    ),
                ),
                (
                    "ip_address",
                    models.GenericIPAddressField(
                        blank=True, null=True, verbose_name="Adresse IP"
                    ),
                ),
                ("user_agent", models.TextField(blank=True, verbose_name="User Agent")),
                ("referer", models.URLField(blank=True, verbose_name="Referer")),
                ("viewed_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "verbose_name": "Vue de colis",
                "verbose_name_plural": "Vues de colis",
            },
        ),
        migrations.CreateModel(
            name="TransportOffer",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "price",
                    models.DecimalField(
                        decimal_places=2, max_digits=10, verbose_name="Prix proposé"
                    ),
                ),
                (
                    "currency",
                    models.CharField(
                        choices=[
                            ("EUR", "€"),
                            ("USD", "$"),
                            ("GBP", "£"),
                            ("MAD", "DH"),
                            ("XOF", "CFA"),
                        ],
                        default="EUR",
                        max_length=3,
                        verbose_name="Devise",
                    ),
                ),
                (
                    "proposed_pickup_date",
                    models.DateField(verbose_name="Date de départ proposée"),
                ),
                (
                    "proposed_delivery_date",
                    models.DateField(verbose_name="Date de livraison proposée"),
                ),
                (
                    "message",
                    models.TextField(
                        blank=True,
                        help_text="Expliquez pourquoi vous êtes le bon transporteur",
                        verbose_name="Message au vendeur",
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "En attente"),
                            ("ACCEPTED", "Acceptée"),
                            ("REJECTED", "Rejetée"),
                            ("CANCELLED", "Annulée"),
                            ("EXPIRED", "Expirée"),
                        ],
                        default="PENDING",
                        max_length=20,
                        verbose_name="Statut",
                    ),
                ),
                (
                    "provides_insurance",
                    models.BooleanField(
                        default=False, verbose_name="Fournit assurance"
                    ),
                ),
                (
                    "insurance_coverage",
                    models.DecimalField(
                        blank=True,
                        decimal_places=2,
                        max_digits=10,
                        null=True,
                        verbose_name="Couverture d'assurance",
                    ),
                ),
                (
                    "provides_packaging",
                    models.BooleanField(
                        default=False, verbose_name="Fournit emballage"
                    ),
                ),
                (
                    "provides_loading",
                    models.BooleanField(
                        default=False, verbose_name="Fournit chargement"
                    ),
                ),
                (
                    "provides_unloading",
                    models.BooleanField(
                        default=False, verbose_name="Fournit déchargement"
                    ),
                ),
                (
                    "rejection_reason",
                    models.TextField(blank=True, verbose_name="Raison du refus"),
                ),
                (
                    "accepted_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Accepté le"
                    ),
                ),
                (
                    "expires_at",
                    models.DateTimeField(
                        help_text="Date d'expiration de l'offre",
                        verbose_name="Expire le",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "Offre de transport",
                "verbose_name_plural": "Offres de transport",
                "ordering": ["-created_at"],
            },
        ),
    ]
-e 

=== Fichier: colis/migrations/__init__.py ===
-e 

=== Fichier: colis/tests.py ===
from django.test import TestCase

# Create your tests here.
-e 

=== Fichier: colis/signals.py ===
# ~/ebi3/colis/signals.py
from django.db.models.signals import post_save, pre_save, post_delete, pre_delete, m2m_changed
from django.dispatch import receiver
from django.utils import timezone
from django.core.mail import send_mail
from django.template.loader import render_to_string
from django.conf import settings
from django.db import transaction
from django.utils.translation import gettext_lazy as _
import logging

from .models import (
    Package, PackageCategory, PackageImage,
    TransportOffer, PackageView, PackageFavorite,
    PackageReport
)
from users.models import User
from carriers.models import Carrier, CarrierNotification
from .utils.signal_helpers import create_conversation_for_offer
from messaging.models import Conversation, Message

logger = logging.getLogger(__name__)


@receiver(post_save, sender=Offer)
def handle_offer_save(sender, instance, created, **kwargs):
    """Gère la sauvegarde d'une offre"""
    if created:
        logger.info(f"Nouvelle offre créée: {instance.id}")

        # Créer une conversation en utilisant la fonction utilitaire
        conversation = create_conversation_for_offer(instance)
        if conversation:
            logger.info(f"Conversation créée: {conversation.id}")

# ============================================================================
# SIGNALS PACKAGE (COLIS)
# ============================================================================

@receiver(pre_save, sender=Package)
def update_package_status_dates(sender, instance, **kwargs):
    """
    Met à jour les dates automatiquement lors des changements de statut
    et calcule le volume automatiquement.
    """
    if instance.pk:
        try:
            old_instance = Package.objects.get(pk=instance.pk)

            # Calcul automatique du volume
            if instance.length and instance.width and instance.height:
                instance.volume = (instance.length * instance.width * instance.height) / 1000

            # Mise à jour des dates de statut
            if instance.status != old_instance.status:
                if instance.status == Package.Status.AVAILABLE and not instance.published_at:
                    instance.published_at = timezone.now()
                    logger.info(f"Package {instance.id} marked as AVAILABLE")

                elif instance.status == Package.Status.RESERVED and not instance.reserved_at:
                    instance.reserved_at = timezone.now()
                    logger.info(f"Package {instance.id} marked as RESERVED")

                elif instance.status == Package.Status.IN_TRANSIT and not instance.in_transit_at:
                    instance.in_transit_at = timezone.now()
                    logger.info(f"Package {instance.id} marked as IN_TRANSIT")

                elif instance.status == Package.Status.DELIVERED and not instance.delivered_at:
                    instance.delivered_at = timezone.now()
                    logger.info(f"Package {instance.id} marked as DELIVERED")

                elif instance.status == Package.Status.EXPIRED and not instance.expired_at:
                    instance.expired_at = timezone.now()
                    logger.info(f"Package {instance.id} marked as EXPIRED")

            # Vérification d'expiration automatique
            if (instance.status == Package.Status.AVAILABLE and
                instance.delivery_date and
                instance.delivery_date < timezone.now().date()):
                instance.status = Package.Status.EXPIRED
                instance.expired_at = timezone.now()
                logger.info(f"Package {instance.id} auto-expired")

        except Package.DoesNotExist:
            pass  # Nouvelle instance, pas d'ancienne version


@receiver(post_save, sender=Package)
def update_category_count(sender, instance, created, **kwargs):
    """
    Met à jour le compteur de colis dans la catégorie
    """
    if instance.category:
        try:
            instance.category.update_package_count()
            logger.debug(f"Updated package count for category {instance.category.id}")
        except Exception as e:
            logger.error(f"Error updating category count: {e}")


@receiver(post_save, sender=Package)
def notify_package_status_change(sender, instance, created, **kwargs):
    """
    Envoie des notifications lors des changements de statut d'un colis
    """
    if not created:  # Seulement pour les mises à jour
        try:
            from .tasks import send_package_status_notification
            send_package_status_notification.delay(instance.id)
            logger.info(f"Queued status notification for package {instance.id}")
        except Exception as e:
            logger.error(f"Error queuing status notification: {e}")


@receiver(pre_delete, sender=Package)
def cleanup_package_files(sender, instance, **kwargs):
    """
    Nettoie les fichiers associés à un colis avant suppression
    """
    try:
        # Supprimer les images (géré par django-cleanup)
        for image in instance.images.all():
            image.delete()

        logger.info(f"Cleaned up files for package {instance.id}")
    except Exception as e:
        logger.error(f"Error cleaning package files: {e}")


# ============================================================================
# SIGNALS PACKAGE IMAGE
# ============================================================================

@receiver(pre_save, sender=PackageImage)
def set_primary_image(sender, instance, **kwargs):
    """
    S'assure qu'il y a toujours une image principale
    et qu'il n'y en a qu'une seule
    """
    if not instance.pk:  # Nouvelle image
        # Si c'est la première image du colis, la marquer comme principale
        if not instance.package.images.exists() and not instance.is_primary:
            instance.is_primary = True

    if instance.is_primary:
        # Désactiver les autres images principales du même colis
        PackageImage.objects.filter(
            package=instance.package,
            is_primary=True
        ).exclude(pk=instance.pk).update(is_primary=False)
        logger.debug(f"Set image {instance.id} as primary for package {instance.package.id}")


@receiver(post_save, sender=PackageImage)
def update_package_image_count(sender, instance, created, **kwargs):
    """
    Met à jour le compteur d'images payantes utilisées
    """
    if created and instance.is_paid and instance.payment_status == 'PAID':
        try:
            package = instance.package
            package.paid_images_used = package.images.filter(
                is_paid=True,
                payment_status='PAID'
            ).count()
            package.save(update_fields=['paid_images_used'])
            logger.debug(f"Updated paid images count for package {package.id}")
        except Exception as e:
            logger.error(f"Error updating paid images count: {e}")


# ============================================================================
# SIGNALS TRANSPORT OFFER (OFFRES DE TRANSPORT)
# ============================================================================

@receiver(pre_save, sender=TransportOffer)
def set_offer_expiry(sender, instance, **kwargs):
    """
    Définit la date d'expiration d'une offre si elle n'est pas déjà définie
    """
    if not instance.expires_at:
        # Par défaut, une offre expire dans 72h
        instance.expires_at = timezone.now() + timezone.timedelta(hours=72)
        logger.debug(f"Set expiry date for offer {instance.id}")


@receiver(pre_save, sender=TransportOffer)
def validate_offer_status(sender, instance, **kwargs):
    """
    Valide les transitions de statut d'une offre
    """
    if instance.pk:
        try:
            old_instance = TransportOffer.objects.get(pk=instance.pk)

            # Vérifier que l'offre n'est pas déjà expirée
            if old_instance.is_expired() and instance.status == TransportOffer.Status.PENDING:
                instance.status = TransportOffer.Status.EXPIRED
                logger.warning(f"Offer {instance.id} auto-expired")

            # Marquer la date d'acceptation
            if (instance.status == TransportOffer.Status.ACCEPTED and
                old_instance.status != TransportOffer.Status.ACCEPTED):
                instance.accepted_at = timezone.now()
                logger.info(f"Offer {instance.id} accepted at {instance.accepted_at}")

        except TransportOffer.DoesNotExist:
            pass


@receiver(post_save, sender=TransportOffer)
def handle_accepted_offer(sender, instance, created, **kwargs):
    """
    Gère les actions lorsqu'une offre est acceptée
    """
    if instance.status == TransportOffer.Status.ACCEPTED:
        with transaction.atomic():
            try:
                # Mettre à jour le statut du colis
                package = instance.package
                package.status = Package.Status.RESERVED
                package.reserved_at = timezone.now()
                package.save(update_fields=['status', 'reserved_at'])

                # Rejeter automatiquement les autres offres en attente
                TransportOffer.objects.filter(
                    package=package,
                    status=TransportOffer.Status.PENDING
                ).exclude(pk=instance.pk).update(
                    status=TransportOffer.Status.REJECTED,
                    rejection_reason=_("Une autre offre a été acceptée")
                )

                # Créer une conversation entre les parties
                create_conversation_for_accepted_offer(instance)

                # Envoyer des notifications
                send_offer_accepted_notifications(instance)

                logger.info(f"Offer {instance.id} accepted, package {package.id} reserved")

            except Exception as e:
                logger.error(f"Error handling accepted offer {instance.id}: {e}")


def create_conversation_for_accepted_offer(offer):
    """
    Crée une conversation entre l'expéditeur et le transporteur
    lorsqu'une offre est acceptée
    """
    try:
        conversation, created = Conversation.objects.get_or_create(
            participant_a=offer.package.sender,
            participant_b=offer.carrier.user,
            defaults={
                'subject': f"Colis accepté: {offer.package.title}",
                'last_message_at': timezone.now()
            }
        )

        if created or not conversation.messages.exists():
            Message.objects.create(
                conversation=conversation,
                sender=offer.package.sender,
                content=_(
                    "Bonjour, j'ai accepté votre offre de {price}€ pour le transport de mon colis. "
                    "Nous pouvons maintenant organiser les détails du transport."
                ).format(price=offer.price)
            )

        logger.debug(f"Created conversation for accepted offer {offer.id}")

    except Exception as e:
        logger.error(f"Error creating conversation for offer {offer.id}: {e}")


def send_offer_accepted_notifications(offer):
    """
    Envoie des notifications par email lorsque une offre est acceptée
    """
    try:
        # Notification au transporteur
        subject_to_carrier = _("Votre offre a été acceptée !")
        message_to_carrier = render_to_string('colis/email/offer_accepted_carrier.html', {
            'offer': offer,
            'package': offer.package,
        })

        send_mail(
            subject_to_carrier,
            message_to_carrier,
            settings.DEFAULT_FROM_EMAIL,
            [offer.carrier.user.email],
            html_message=message_to_carrier,
            fail_silently=True
        )

        # Notification à l'expéditeur
        subject_to_sender = _("Vous avez accepté une offre")
        message_to_sender = render_to_string('colis/email/offer_accepted_sender.html', {
            'offer': offer,
            'package': offer.package,
        })

        send_mail(
            subject_to_sender,
            message_to_sender,
            settings.DEFAULT_FROM_EMAIL,
            [offer.package.sender.email],
            html_message=message_to_sender,
            fail_silently=True
        )

        logger.info(f"Sent acceptance notifications for offer {offer.id}")

    except Exception as e:
        logger.error(f"Error sending acceptance notifications: {e}")


@receiver(post_save, sender=TransportOffer)
def notify_new_offer(sender, instance, created, **kwargs):
    """
    Envoie une notification lorsqu'une nouvelle offre est créée
    """
    if created:
        try:
            from .tasks import send_new_offer_notification
            send_new_offer_notification.delay(instance.id)
            logger.info(f"Queued new offer notification for package {instance.package.id}")
        except Exception as e:
            logger.error(f"Error queuing new offer notification: {e}")


@receiver(post_save, sender=TransportOffer)
def update_package_offer_count(sender, instance, created, **kwargs):
    """
    Met à jour le compteur d'offres du colis
    """
    try:
        package = instance.package
        package.offer_count = TransportOffer.objects.filter(package=package).count()
        package.save(update_fields=['offer_count'])
        logger.debug(f"Updated offer count for package {package.id}")
    except Exception as e:
        logger.error(f"Error updating offer count: {e}")


# ============================================================================
# SIGNALS PACKAGE VIEW (VUES)
# ============================================================================

@receiver(post_save, sender=PackageView)
def update_package_view_count(sender, instance, created, **kwargs):
    """
    Met à jour le compteur de vues d'un colis
    """
    if created:
        try:
            package = instance.package
            package.view_count = PackageView.objects.filter(package=package).count()
            package.save(update_fields=['view_count'])
            logger.debug(f"Updated view count for package {package.id}")
        except Exception as e:
            logger.error(f"Error updating view count: {e}")


# ============================================================================
# SIGNALS PACKAGE FAVORITE (FAVORIS)
# ============================================================================

@receiver(post_save, sender=PackageFavorite)
def update_package_favorite_count_on_save(sender, instance, created, **kwargs):
    """
    Met à jour le compteur de favoris d'un colis lors de l'ajout
    """
    if created:
        try:
            package = instance.package
            package.favorite_count = PackageFavorite.objects.filter(package=package).count()
            package.save(update_fields=['favorite_count'])
            logger.debug(f"Updated favorite count for package {package.id} on save")
        except Exception as e:
            logger.error(f"Error updating favorite count on save: {e}")


@receiver(post_delete, sender=PackageFavorite)
def update_package_favorite_count_on_delete(sender, instance, **kwargs):
    """
    Met à jour le compteur de favoris d'un colis lors de la suppression
    """
    try:
        package = instance.package
        package.favorite_count = PackageFavorite.objects.filter(package=package).count()
        package.save(update_fields=['favorite_count'])
        logger.debug(f"Updated favorite count for package {package.id} on delete")
    except Exception as e:
        logger.error(f"Error updating favorite count on delete: {e}")


# ============================================================================
# SIGNALS PACKAGE REPORT (SIGNALEMENTS)
# ============================================================================

@receiver(post_save, sender=PackageReport)
def handle_new_report(sender, instance, created, **kwargs):
    """
    Gère les nouveaux signalements
    """
    if created:
        try:
            # Envoyer une notification à l'admin
            subject = _("Nouveau signalement de colis")
            message = render_to_string('colis/email/new_report.html', {
                'report': instance,
                'package': instance.package,
            })

            send_mail(
                subject,
                message,
                settings.DEFAULT_FROM_EMAIL,
                [settings.ADMIN_EMAIL],
                html_message=message,
                fail_silently=True
            )

            logger.info(f"New report {instance.id} created, notification sent to admin")

            # Créer une notification pour l'équipe de modération
            if hasattr(settings, 'MODERATION_TEAM_EMAILS'):
                for email in settings.MODERATION_TEAM_EMAILS:
                    send_mail(
                        subject,
                        message,
                        settings.DEFAULT_FROM_EMAIL,
                        [email],
                        html_message=message,
                        fail_silently=True
                    )

        except Exception as e:
            logger.error(f"Error handling new report {instance.id}: {e}")


@receiver(pre_save, sender=PackageReport)
def update_report_resolution(sender, instance, **kwargs):
    """
    Met à jour les dates de résolution des signalements
    """
    if instance.pk:
        try:
            old_instance = PackageReport.objects.get(pk=instance.pk)

            # Si le statut passe à résolu ou rejeté
            if (instance.status in ['RESOLVED', 'DISMISSED'] and
                old_instance.status not in ['RESOLVED', 'DISMISSED']):
                instance.resolved_at = timezone.now()
                logger.info(f"Report {instance.id} resolved at {instance.resolved_at}")

        except PackageReport.DoesNotExist:
            pass


# ============================================================================
# SIGNALS PACKAGE CATEGORY (CATÉGORIES)
# ============================================================================

@receiver(pre_save, sender=PackageCategory)
def generate_category_slug(sender, instance, **kwargs):
    """
    Génère automatiquement le slug d'une catégorie si vide
    """
    if not instance.slug and instance.name:
        from django.utils.text import slugify
        instance.slug = slugify(instance.name)
        logger.debug(f"Generated slug for category: {instance.slug}")


@receiver(post_save, sender=PackageCategory)
def invalidate_category_cache(sender, instance, **kwargs):
    """
    Invalide le cache des catégories après modification
    """
    try:
        from django.core.cache import cache
        cache_keys = [
            'package_categories_menu',
            'package_categories_all',
            f'package_category_{instance.slug}'
        ]
        for key in cache_keys:
            cache.delete(key)
        logger.debug(f"Invalidated cache for category {instance.id}")
    except Exception as e:
        logger.error(f"Error invalidating category cache: {e}")


# ============================================================================
# SIGNALS LIÉS AUX UTILISATEURS
# ============================================================================

@receiver(post_save, sender=User)
def create_welcome_package_for_new_user(sender, instance, created, **kwargs):
    """
    Crée un colis d'exemple pour les nouveaux utilisateurs
    (optionnel, pour aider à la découverte)
    """
    if created and settings.CREATE_SAMPLE_PACKAGE_FOR_NEW_USERS:
        try:
            # Attendre un peu pour éviter les problèmes de timing
            import threading
            timer = threading.Timer(
                5.0,  # 5 secondes après la création
                create_sample_package,
                args=[instance]
            )
            timer.start()
            logger.info(f"Scheduled sample package creation for user {instance.id}")

        except Exception as e:
            logger.error(f"Error scheduling sample package: {e}")


def create_sample_package(user):
    """
    Crée un colis d'exemple pour un nouvel utilisateur
    """
    try:
        # Trouver une catégorie par défaut
        from .models import PackageCategory
        default_category = PackageCategory.objects.filter(is_active=True).first()

        if default_category:
            sample_package = Package.objects.create(
                sender=user,
                category=default_category,
                title=_("Exemple de colis - Modèle"),
                description=_(
                    "Ceci est un exemple de colis pour vous montrer comment remplir votre annonce. "
                    "Vous pouvez le modifier ou le supprimer à tout moment.\n\n"
                    "Conseils :\n"
                    "• Donnez un titre clair et descriptif\n"
                    "• Indiquez toutes les dimensions et le poids\n"
                    "• Prenez des photos de bonne qualité\n"
                    "• Soyez précis sur les dates de disponibilité"
                ),
                package_type=Package.PackageType.SMALL_PACKAGE,
                weight=10.5,
                length=40,
                width=30,
                height=20,
                pickup_country='FR',
                pickup_city=_("Paris"),
                delivery_country='FR',
                delivery_city=_("Lyon"),
                pickup_date=timezone.now().date() + timezone.timedelta(days=7),
                delivery_date=timezone.now().date() + timezone.timedelta(days=14),
                price_type=Package.PriceType.NEGOTIABLE,
                asking_price=50.00,
                currency='EUR',
                status=Package.Status.DRAFT,
                is_featured=False
            )

            logger.info(f"Created sample package {sample_package.id} for user {user.id}")

    except Exception as e:
        logger.error(f"Error creating sample package: {e}")


# ============================================================================
# SIGNALS DE NETTOYAGE AUTOMATIQUE
# ============================================================================

@receiver(pre_save, sender=TransportOffer)
def cleanup_expired_offers(sender, instance, **kwargs):
    """
    Nettoie automatiquement les offres expirées
    """
    if instance.is_expired() and instance.status == TransportOffer.Status.PENDING:
        instance.status = TransportOffer.Status.EXPIRED
        logger.info(f"Auto-expired offer {instance.id}")


# ============================================================================
# SIGNALS DE SYNCHRONISATION AVEC L'APP CARRIERS
# ============================================================================

@receiver(post_save, sender=Carrier)
def update_carrier_availability(sender, instance, **kwargs):
    """
    Met à jour la disponibilité des offres lorsqu'un transporteur change de statut
    """
    if instance.status != Carrier.Status.APPROVED or not instance.is_available:
        try:
            # Marquer toutes les offres en attente comme expirées
            expired_count = TransportOffer.objects.filter(
                carrier=instance,
                status=TransportOffer.Status.PENDING
            ).update(status=TransportOffer.Status.EXPIRED)

            if expired_count > 0:
                logger.info(f"Expired {expired_count} offers for carrier {instance.id}")

        except Exception as e:
            logger.error(f"Error updating carrier offers: {e}")


# ============================================================================
# SIGNALS POUR LES STATISTIQUES
# ============================================================================

@receiver(post_save, sender=Package)
@receiver(post_save, sender=TransportOffer)
@receiver(post_save, sender=PackageView)
@receiver(post_save, sender=PackageFavorite)
def invalidate_statistics_cache(sender, instance, **kwargs):
    """
    Invalide le cache des statistiques après modification des données
    """
    try:
        from django.core.cache import cache
        cache.delete_pattern('stats_*')
        cache.delete('dashboard_stats')
        logger.debug("Invalidated statistics cache")
    except Exception as e:
        logger.error(f"Error invalidating statistics cache: {e}")


# ============================================================================
# CONNEXION DES SIGNALS
# ============================================================================

def connect_signals():
    """
    Connecte tous les signaux (appelé dans apps.py)
    """
    # Les signaux sont automatiquement connectés via les décorateurs @receiver
    # Cette fonction est utile pour une connexion explicite si nécessaire
    pass


def disconnect_signals():
    """
    Déconnecte tous les signaux (pour les tests)
    """
    from django.db.models.signals import post_save, pre_save, post_delete, pre_delete

    # Déconnecter tous les signaux liés aux modèles de colis
    models = [Package, PackageImage, TransportOffer, PackageView,
              PackageFavorite, PackageReport, PackageCategory]

    for model in models:
        post_save.disconnect(receiver=None, sender=model)
        pre_save.disconnect(receiver=None, sender=model)
        post_delete.disconnect(receiver=None, sender=model)
        pre_delete.disconnect(receiver=None, sender=model)

    logger.info("Disconnected all colis signals")-e 

=== Fichier: colis/admin.py ===
# ~/ebi3/colis/admin.py
from django.contrib import admin
from django.utils import timezone
from django.utils.html import format_html
from django.utils.translation import gettext_lazy as _
from django.contrib import messages
from django.urls import reverse, path
from django.http import HttpResponseRedirect
from django.db.models import Count, Avg, Sum, Q
from django.db import models
import csv
from django.http import HttpResponse

from .models import (
    Package, PackageCategory, PackageImage,
    TransportOffer, PackageView, PackageFavorite, PackageReport
)


@admin.register(PackageCategory)
class PackageCategoryAdmin(admin.ModelAdmin):
    """Administration des catégories de colis"""

    # ✅ CORRECTION : actions doit être une LISTE de noms de méthodes
    actions = ['activate_categories', 'deactivate_categories', 'show_in_menu_action', 'hide_from_menu_action']

    list_display = ('name', 'parent', 'is_active', 'show_in_menu', 'package_count', 'display_order')
    list_filter = ('is_active', 'show_in_menu', 'created_at')
    search_fields = ('name', 'description', 'slug')
    prepopulated_fields = {'slug': ('name',)}
    readonly_fields = ('created_at', 'updated_at', 'package_count')

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('name', 'slug', 'parent', 'description')
        }),
        (_('Apparence'), {
            'fields': ('icon', 'image', 'display_order')
        }),
        (_('Visibilité'), {
            'fields': ('is_active', 'show_in_menu')
        }),
        (_('Configuration des colis'), {
            'fields': ('requires_dimensions', 'requires_weight')
        }),
        (_('SEO'), {
            'fields': ('meta_title', 'meta_description')
        }),
        (_('Statistiques'), {
            'fields': ('package_count', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ Les méthodes d'action doivent être séparées de la liste 'actions'
    def activate_categories(self, request, queryset):
        """Action pour activer les catégories"""
        updated = queryset.update(is_active=True)
        self.message_user(request, _(f'{updated} catégories ont été activées.'))
    activate_categories.short_description = _('Activer les catégories sélectionnées')

    def deactivate_categories(self, request, queryset):
        """Action pour désactiver les catégories"""
        updated = queryset.update(is_active=False)
        self.message_user(request, _(f'{updated} catégories ont été désactivées.'))
    deactivate_categories.short_description = _('Désactiver les catégories sélectionnées')

    def show_in_menu_action(self, request, queryset):
        """Action pour afficher dans le menu"""
        updated = queryset.update(show_in_menu=True)
        self.message_user(request, _(f'{updated} catégories sont maintenant visibles dans le menu.'))
    show_in_menu_action.short_description = _('Afficher dans le menu')

    def hide_from_menu_action(self, request, queryset):
        """Action pour cacher du menu"""
        updated = queryset.update(show_in_menu=False)
        self.message_user(request, _(f'{updated} catégories sont maintenant cachées du menu.'))
    hide_from_menu_action.short_description = _('Cacher du menu')

    def get_queryset(self, request):
        return super().get_queryset(request).prefetch_related('parent')


class PackageImageInline(admin.TabularInline):
    """Inline pour les images de colis"""
    model = PackageImage
    extra = 1
    fields = ('image', 'thumbnail_preview', 'caption', 'is_primary', 'display_order')
    readonly_fields = ('thumbnail_preview',)

    def thumbnail_preview(self, obj):
        if obj.thumbnail:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.thumbnail.url)
        elif obj.image:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.image.url)
        return _("Pas d'image")
    thumbnail_preview.short_description = _('Aperçu')


@admin.register(Package)
class PackageAdmin(admin.ModelAdmin):
    """Administration des colis"""

    inlines = [PackageImageInline]

    list_display = (
        'title', 'sender', 'category', 'package_type_badge',
        'pickup_to_destination', 'weight_volume_display',
        'asking_price_display', 'status_badge', 'is_featured',
        'view_count', 'offer_count', 'created_at'
    )

    list_filter = (
        'status', 'package_type', 'price_type',
        'is_featured', 'created_at', 'category',
        'pickup_country', 'delivery_country'
    )

    search_fields = (
        'title', 'description', 'sender__username',
        'sender__email', 'pickup_city', 'delivery_city'
    )

    readonly_fields = (
        'slug', 'view_count', 'offer_count', 'favorite_count',
        'created_at', 'updated_at', 'published_at', 'expired_at',
        'reserved_at', 'delivered_at', 'volume',
        'paid_images_used', 'estimated_distance'
    )

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('title', 'slug', 'sender', 'category', 'description', 'package_type')
        }),
        (_('Dimensions et poids'), {
            'fields': ('weight', 'length', 'width', 'height', 'volume')
        }),
        (_('Origine'), {
            'fields': ('pickup_country', 'pickup_city', 'pickup_address', 'pickup_postal_code',
                      'pickup_latitude', 'pickup_longitude')
        }),
        (_('Destination'), {
            'fields': ('delivery_country', 'delivery_city', 'delivery_address', 'delivery_postal_code',
                      'delivery_latitude', 'delivery_longitude')
        }),
        (_('Dates'), {
            'fields': ('pickup_date', 'delivery_date', 'flexible_dates')
        }),
        (_('Prix'), {
            'fields': ('price_type', 'asking_price', 'currency', 'estimated_distance')
        }),
        (_('Options'), {
            'fields': ('is_fragile', 'requires_insurance', 'insurance_value',
                      'requires_packaging', 'requires_loading_help', 'requires_unloading_help')
        }),
        (_('Statut et promotion'), {
            'fields': ('status', 'is_featured', 'featured_until')
        }),
        (_('Multimédia'), {
            'fields': ('free_images_allowed', 'paid_images_used'),
            'classes': ('collapse',)
        }),
        (_('SEO'), {
            'fields': ('meta_keywords', 'meta_description'),
            'classes': ('collapse',)
        }),
        (_('Statistiques'), {
            'fields': ('view_count', 'offer_count', 'favorite_count',
                      'created_at', 'updated_at', 'published_at', 'expired_at',
                      'reserved_at', 'delivered_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION IMPORTANTE: actions doit être une LISTE de noms de méthodes
    actions = [
        'mark_as_available', 'mark_as_reserved', 'mark_as_in_transit',
        'mark_as_delivered', 'mark_as_cancelled', 'feature_packages',
        'unfeature_packages', 'export_to_csv', 'calculate_distances'
    ]

    def package_type_badge(self, obj):
        colors = {
            'SMALL_PACKAGE': 'success',
            'MEDIUM_PACKAGE': 'info',
            'LARGE_PACKAGE': 'warning',
            'FURNITURE': 'primary',
            'PALLET': 'secondary',
            'VEHICLE_PART': 'dark',
            'OTHER': 'light'
        }
        color = colors.get(obj.package_type, 'secondary')
        return format_html(
            '<span class="badge bg-{}">{}</span>',
            color, obj.get_package_type_display()
        )
    package_type_badge.short_description = _('Type')
    package_type_badge.admin_order_field = 'package_type'

    def pickup_to_destination(self, obj):
        return format_html(
            '{} → {}',
            obj.pickup_city,
            obj.delivery_city
        )
    pickup_to_destination.short_description = _('Trajet')
    pickup_to_destination.admin_order_field = 'pickup_city'

    def weight_volume_display(self, obj):
        if obj.volume:
            return f"{obj.weight} kg / {obj.volume:.1f} L"
        return f"{obj.weight} kg"
    weight_volume_display.short_description = _('Poids/Volume')

    def asking_price_display(self, obj):
        return f"{obj.asking_price} {obj.get_currency_display()}"
    asking_price_display.short_description = _('Prix')
    asking_price_display.admin_order_field = 'asking_price'

    def status_badge(self, obj):
        status_colors = {
            'DRAFT': 'secondary',
            'AVAILABLE': 'success',
            'RESERVED': 'info',
            'IN_TRANSIT': 'warning',
            'DELIVERED': 'primary',
            'CANCELLED': 'danger',
            'EXPIRED': 'dark'
        }
        color = status_colors.get(obj.status, 'secondary')
        return format_html(
            '<span class="badge bg-{}">{}</span>',
            color, obj.get_status_display()
        )
    status_badge.short_description = _('Statut')

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('sender', 'category')

    # ✅ Les méthodes d'action doivent être définies séparément
    def mark_as_available(self, request, queryset):
        """Action pour marquer comme disponible"""
        updated = queryset.update(status=Package.Status.AVAILABLE)
        self.message_user(request, _(f'{updated} colis ont été marqués comme disponibles.'))
    mark_as_available.short_description = _('Marquer comme disponible')

    def mark_as_reserved(self, request, queryset):
        """Action pour marquer comme réservé"""
        updated = queryset.update(status=Package.Status.RESERVED, reserved_at=timezone.now())
        self.message_user(request, _(f'{updated} colis ont été marqués comme réservés.'))
    mark_as_reserved.short_description = _('Marquer comme réservé')

    def mark_as_in_transit(self, request, queryset):
        """Action pour marquer comme en transit"""
        updated = queryset.update(status=Package.Status.IN_TRANSIT)
        self.message_user(request, _(f'{updated} colis ont été marqués comme en transit.'))
    mark_as_in_transit.short_description = _('Marquer comme en transit')

    def mark_as_delivered(self, request, queryset):
        """Action pour marquer comme livré"""
        updated = queryset.update(
            status=Package.Status.DELIVERED,
            delivered_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} colis ont été marqués comme livrés.'))
    mark_as_delivered.short_description = _('Marquer comme livré')

    def mark_as_cancelled(self, request, queryset):
        """Action pour marquer comme annulé"""
        updated = queryset.update(status=Package.Status.CANCELLED)
        self.message_user(request, _(f'{updated} colis ont été marqués comme annulés.'))
    mark_as_cancelled.short_description = _('Marquer comme annulé')

    def feature_packages(self, request, queryset):
        """Action pour mettre en vedette"""
        updated = queryset.update(
            is_featured=True,
            featured_until=timezone.now() + timezone.timedelta(days=7)
        )
        self.message_user(request, _(f'{updated} colis ont été mis en vedette.'))
    feature_packages.short_description = _('Mettre en vedette')

    def unfeature_packages(self, request, queryset):
        """Action pour retirer de la vedette"""
        updated = queryset.update(is_featured=False, featured_until=None)
        self.message_user(request, _(f'{updated} colis ne sont plus en vedette.'))
    unfeature_packages.short_description = _('Retirer de la vedette')

    def calculate_distances(self, request, queryset):
        """Action pour calculer les distances (à implémenter avec une API)"""
        count = 0
        for package in queryset:
            if not package.estimated_distance:
                # À implémenter avec Google Maps API ou autre
                # package.estimated_distance = calculate_distance(...)
                # package.save()
                count += 1

        if count > 0:
            self.message_user(request, _(f'Distances calculées pour {count} colis.'))
        else:
            self.message_user(request, _('Tous les colis ont déjà une distance calculée.'))
    calculate_distances.short_description = _('Calculer les distances')

    def export_to_csv(self, request, queryset):
        """Action pour exporter en CSV"""
        response = HttpResponse(content_type='text/csv')
        response['Content-Disposition'] = 'attachment; filename="colis.csv"'

        writer = csv.writer(response)
        writer.writerow([
            'ID', 'Titre', 'Expéditeur', 'Catégorie', 'Type',
            'Prix', 'Devise', 'Statut', 'Départ', 'Destination',
            'Poids', 'Volume', 'Vues', 'Offres', 'Date création'
        ])

        for package in queryset:
            writer.writerow([
                package.id, package.title, package.sender.username,
                package.category.name if package.category else '',
                package.get_package_type_display(),
                package.asking_price, package.currency,
                package.get_status_display(),
                f"{package.pickup_city}, {package.pickup_country.name}",
                f"{package.delivery_city}, {package.delivery_country.name}",
                package.weight, package.volume, package.view_count,
                package.offer_count, package.created_at.strftime('%Y-%m-%d %H:%M')
            ])

        return response
    export_to_csv.short_description = _('Exporter en CSV')

    def save_model(self, request, obj, form, change):
        if not obj.pk:
            obj.sender = request.user

        # Si le statut passe à DISPONIBLE et qu'il n'y a pas de date de publication
        if obj.status == Package.Status.AVAILABLE and not obj.published_at:
            obj.published_at = timezone.now()

        # Si le statut passe à RÉSERVÉ
        if obj.status == Package.Status.RESERVED and not obj.reserved_at:
            obj.reserved_at = timezone.now()

        # Si le statut passe à LIVRÉ
        if obj.status == Package.Status.DELIVERED and not obj.delivered_at:
            obj.delivered_at = timezone.now()

        super().save_model(request, obj, form, change)

    # Vue personnalisée pour les statistiques
    def get_urls(self):
        urls = super().get_urls()
        custom_urls = [
            path('statistics/', self.admin_site.admin_view(self.package_statistics_view),
                 name='colis_package_statistics'),
        ]
        return custom_urls + urls

    def package_statistics_view(self, request):
        """Vue personnalisée pour les statistiques des colis"""
        context = self.admin_site.each_context(request)

        # Statistiques générales
        total_packages = Package.objects.count()
        available_packages = Package.objects.filter(status=Package.Status.AVAILABLE).count()
        reserved_packages = Package.objects.filter(status=Package.Status.RESERVED).count()
        delivered_packages = Package.objects.filter(status=Package.Status.DELIVERED).count()

        # Revenus estimés
        revenue_stats = Package.objects.filter(
            status__in=[Package.Status.RESERVED, Package.Status.IN_TRANSIT, Package.Status.DELIVERED]
        ).aggregate(
            total_revenue=Sum('asking_price'),
            avg_price=Avg('asking_price')
        )

        # Statistiques par type
        type_stats = Package.objects.values('package_type').annotate(
            count=Count('id'),
            avg_price=Avg('asking_price')
        ).order_by('-count')

        # Évolution mensuelle
        monthly_stats = Package.objects.extra(
            select={'month': "strftime('%%Y-%%m', created_at)"}
        ).values('month').annotate(
            count=Count('id'),
            total_views=Sum('view_count'),
            total_offers=Sum('offer_count'),
        ).order_by('month')[:12]

        context.update({
            'title': _('Statistiques des colis'),
            'total_packages': total_packages,
            'available_packages': available_packages,
            'reserved_packages': reserved_packages,
            'delivered_packages': delivered_packages,
            'revenue_stats': revenue_stats,
            'type_stats': type_stats,
            'monthly_stats': monthly_stats,
        })

        return render(request, 'admin/colis/package_statistics.html', context)


@admin.register(PackageImage)
class PackageImageAdmin(admin.ModelAdmin):
    """Administration des images de colis"""

    list_display = ('package', 'thumbnail_preview', 'caption', 'is_primary', 'created_at')
    list_filter = ('is_primary', 'created_at')
    search_fields = ('package__title', 'caption')
    readonly_fields = ('created_at',)

    # ✅ CORRECTION: actions doit être une liste vide si pas d'actions
    actions = []

    def thumbnail_preview(self, obj):
        if obj.thumbnail:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.thumbnail.url)
        elif obj.image:
            return format_html('<img src="{}" style="max-height: 50px; max-width: 50px;" />', obj.image.url)
        return _("Pas d'image")
    thumbnail_preview.short_description = _('Aperçu')

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('package')


@admin.register(TransportOffer)
class TransportOfferAdmin(admin.ModelAdmin):
    """Administration des offres de transport"""

    list_display = (
        'id', 'package_link', 'carrier_link',
        'price_display', 'status_badge',
        'dates_display', 'created_at'
    )

    list_filter = ('status', 'created_at', 'provides_insurance')
    search_fields = (
        'package__title', 'carrier__user__username',
        'carrier__company_name', 'message'
    )

    readonly_fields = (
        'created_at', 'updated_at', 'accepted_at', 'expires_at'
    )

    fieldsets = (
        (_('Informations de base'), {
            'fields': ('package', 'carrier', 'status')
        }),
        (_('Détails de l\'offre'), {
            'fields': ('price', 'currency', 'message',
                      'proposed_pickup_date', 'proposed_delivery_date')
        }),
        (_('Services inclus'), {
            'fields': ('provides_insurance', 'insurance_coverage',
                      'provides_packaging', 'provides_loading', 'provides_unloading')
        }),
        (_('Suivi'), {
            'fields': ('rejection_reason', 'accepted_at', 'expires_at')
        }),
        (_('Métadonnées'), {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION: actions doit être une LISTE de noms de méthodes
    actions = ['accept_offers', 'reject_offers', 'mark_as_expired']

    def package_link(self, obj):
        url = reverse('admin:colis_package_change', args=[obj.package.id])
        return format_html('<a href="{}">{}</a>', url, obj.package.title)
    package_link.short_description = _('Colis')
    package_link.admin_order_field = 'package__title'

    def carrier_link(self, obj):
        url = reverse('admin:carriers_carrier_change', args=[obj.carrier.id])
        carrier_name = obj.carrier.company_name or obj.carrier.user.username
        return format_html('<a href="{}">{}</a>', url, carrier_name)
    carrier_link.short_description = _('Transporteur')
    carrier_link.admin_order_field = 'carrier__user__username'

    def price_display(self, obj):
        return f"{obj.price} {obj.get_currency_display()}"
    price_display.short_description = _('Prix')
    price_display.admin_order_field = 'price'

    def status_badge(self, obj):
        status_colors = {
            'PENDING': 'warning',
            'ACCEPTED': 'success',
            'REJECTED': 'danger',
            'CANCELLED': 'secondary',
            'EXPIRED': 'dark'
        }
        color = status_colors.get(obj.status, 'secondary')
        return format_html(
            '<span class="badge bg-{}">{}</span>',
            color, obj.get_status_display()
        )
    status_badge.short_description = _('Statut')

    def dates_display(self, obj):
        return format_html(
            '{} → {}',
            obj.proposed_pickup_date.strftime('%d/%m/%Y'),
            obj.proposed_delivery_date.strftime('%d/%m/%Y')
        )
    dates_display.short_description = _('Dates proposées')

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('package', 'carrier', 'carrier__user')

    # ✅ Les méthodes d'action doivent être définies séparément
    def accept_offers(self, request, queryset):
        """Action pour accepter les offres"""
        count = 0
        for offer in queryset.filter(status=TransportOffer.Status.PENDING):
            if offer.can_be_accepted():
                offer.status = TransportOffer.Status.ACCEPTED
                offer.accepted_at = timezone.now()
                offer.save()
                count += 1

        self.message_user(request, _(f'{count} offres ont été acceptées.'))
    accept_offers.short_description = _('Accepter les offres sélectionnées')

    def reject_offers(self, request, queryset):
        """Action pour rejeter les offres"""
        updated = queryset.update(status=TransportOffer.Status.REJECTED)
        self.message_user(request, _(f'{updated} offres ont été rejetées.'))
    reject_offers.short_description = _('Rejeter les offres sélectionnées')

    def mark_as_expired(self, request, queryset):
        """Action pour marquer comme expiré"""
        updated = queryset.update(status=TransportOffer.Status.EXPIRED)
        self.message_user(request, _(f'{updated} offres ont été marquées comme expirées.'))
    mark_as_expired.short_description = _('Marquer comme expiré')

    def save_model(self, request, obj, form, change):
        # Si l'offre est acceptée, mettre à jour le colis
        if obj.status == TransportOffer.Status.ACCEPTED and not obj.accepted_at:
            obj.accepted_at = timezone.now()
            obj.package.status = Package.Status.RESERVED
            obj.package.reserved_at = timezone.now()
            obj.package.save()

        super().save_model(request, obj, form, change)


@admin.register(PackageView)
class PackageViewAdmin(admin.ModelAdmin):
    """Administration des vues de colis"""

    list_display = ('package', 'user', 'ip_address', 'viewed_at')
    list_filter = ('viewed_at',)
    search_fields = ('package__title', 'user__username', 'ip_address')
    readonly_fields = ('viewed_at',)

    # ✅ CORRECTION: actions doit être une liste vide si pas d'actions
    actions = []

    def has_add_permission(self, request):
        return False

    def has_change_permission(self, request, obj=None):
        return False

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('package', 'user')


@admin.register(PackageFavorite)
class PackageFavoriteAdmin(admin.ModelAdmin):
    """Administration des favoris de colis"""

    list_display = ('user', 'package', 'created_at')
    list_filter = ('created_at',)
    search_fields = ('user__username', 'package__title')
    readonly_fields = ('created_at',)

    # ✅ CORRECTION: actions doit être une liste vide si pas d'actions
    actions = []

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('user', 'package')


@admin.register(PackageReport)
class PackageReportAdmin(admin.ModelAdmin):
    """Administration des signalements de colis"""

    # ✅ CORRECTION: Ajouter 'status' à list_display
    list_display = ('package', 'reporter', 'reason', 'status', 'status_badge', 'created_at')
    list_filter = ('reason', 'status', 'created_at')
    search_fields = ('package__title', 'reporter__username', 'description')
    list_editable = ('status',)
    readonly_fields = ('created_at',)

    fieldsets = (
        (_('Signalement'), {
            'fields': ('package', 'reporter', 'reason', 'description', 'evidence')
        }),
        (_('Traitement'), {
            'fields': ('status', 'admin_notes', 'resolved_by', 'resolved_at')
        }),
        (_('Métadonnées'), {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )

    # ✅ CORRECTION: actions doit être une liste de noms de méthodes
    actions = ['mark_as_resolved', 'mark_as_dismissed']

    def status_badge(self, obj):
        status_colors = {
            'PENDING': 'warning',
            'IN_REVIEW': 'info',
            'RESOLVED': 'success',
            'DISMISSED': 'secondary'
        }
        color = status_colors.get(obj.status, 'secondary')
        return format_html(
            '<span class="badge bg-{}">{}</span>',
            color, obj.get_status_display()
        )
    status_badge.short_description = _('Badge Statut')

    def status(self, obj):
        """Affiche le statut textuel pour list_display"""
        return obj.get_status_display()
    status.short_description = _('Statut')

    def mark_as_resolved(self, request, queryset):
        """Action pour marquer comme résolu"""
        updated = queryset.update(
            status='RESOLVED',
            resolved_by=request.user,
            resolved_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} signalements ont été résolus.'))
    mark_as_resolved.short_description = _('Marquer comme résolu')

    def mark_as_dismissed(self, request, queryset):
        """Action pour rejeter les signalements"""
        updated = queryset.update(
            status='DISMISSED',
            resolved_by=request.user,
            resolved_at=timezone.now()
        )
        self.message_user(request, _(f'{updated} signalements ont été rejetés.'))
    mark_as_dismissed.short_description = _('Rejeter les signalements')

    def save_model(self, request, obj, form, change):
        if obj.status in ['RESOLVED', 'DISMISSED'] and not obj.resolved_by:
            obj.resolved_by = request.user
            obj.resolved_at = timezone.now()
        super().save_model(request, obj, form, change)

    def get_queryset(self, request):
        return super().get_queryset(request).select_related('package', 'reporter', 'resolved_by')

# ============================================================================
# PANNEAUX D'ADMINISTRATION PERSONNALISÉS
# ============================================================================

class ColisAdminSite(admin.AdminSite):
    """Site d'administration personnalisé pour l'application colis"""

    site_header = _("Administration des colis Ebi3")
    site_title = _("Administration des colis")
    index_title = _("Tableau de bord")

    def get_app_list(self, request):
        """
        Retourne une liste triée des applications.
        """
        app_list = super().get_app_list(request)

        # Réorganiser les applications pour mettre 'colis' en premier
        for app in app_list:
            if app['app_label'] == 'colis':
                app_list.remove(app)
                app_list.insert(0, app)
                break

        return app_list


# ============================================================================
# MODÈLES POUR LE PANNEAU D'ADMINISTRATION
# ============================================================================

class PackageStatistics(models.Model):
    """Modèle virtuel pour les statistiques (admin seulement)"""

    class Meta:
        verbose_name = _("Statistiques")
        verbose_name_plural = _("Statistiques")
        managed = False  # Ne crée pas de table dans la base de données


class PackageStatisticsAdmin(admin.ModelAdmin):
    """Administration des statistiques des colis"""

    # Cette vue n'a pas de modèle réel, donc on désactive les actions normales
    def has_add_permission(self, request):
        return False

    def has_change_permission(self, request, obj=None):
        return False

    def has_delete_permission(self, request, obj=None):
        return False

    def changelist_view(self, request, extra_context=None):
        # Rediriger vers notre vue personnalisée
        from django.urls import reverse
        return HttpResponseRedirect(reverse('admin:colis_package_statistics'))

    def get_urls(self):
        return []


# Enregistrement du modèle virtuel pour les statistiques
admin.site.register(PackageStatistics, PackageStatisticsAdmin)-e 

=== Fichier: colis/forms.py ===
# ~/ebi3/colis/forms.py
from django import forms
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import ValidationError
from django.forms import inlineformset_factory
from django.utils import timezone
from django_countries import countries
from django_countries.widgets import CountrySelectWidget

from .models import Package, PackageCategory, PackageImage, TransportOffer, PackageReport
from users.models import User
from carriers.models import Carrier


class PackageBaseForm(forms.ModelForm):
    """Formulaire de base pour les colis"""

    # Champs supplémentaires pour l'UI
    use_current_location = forms.BooleanField(
        required=False,
        initial=False,
        label=_("Utiliser ma position actuelle"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    class Meta:
        model = Package
        fields = [
            'title', 'category', 'package_type', 'description',
            'weight', 'length', 'width', 'height',
            'pickup_country', 'pickup_city', 'pickup_address', 'pickup_postal_code',
            'delivery_country', 'delivery_city', 'delivery_address', 'delivery_postal_code',
            'pickup_date', 'delivery_date', 'flexible_dates',
            'price_type', 'asking_price', 'currency',
            'is_fragile', 'requires_insurance', 'insurance_value',
            'requires_packaging', 'requires_loading_help', 'requires_unloading_help',
        ]

        widgets = {
            'title': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Ex: Déménagement Paris → Lyon")
            }),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 6,
                'placeholder': _("Décrivez votre colis en détail...\n• Contenu\n• État\n• Instructions spéciales")
            }),
            'category': forms.Select(attrs={'class': 'form-control'}),
            'package_type': forms.Select(attrs={'class': 'form-control'}),
            'weight': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.001',
                'placeholder': _("kg")
            }),
            'length': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.1',
                'placeholder': _("cm")
            }),
            'width': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.1',
                'placeholder': _("cm")
            }),
            'height': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.1',
                'placeholder': _("cm")
            }),
            'pickup_country': CountrySelectWidget(attrs={'class': 'form-control'}),
            'pickup_city': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Ville de départ")
            }),
            'pickup_address': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _("Adresse complète (optionnel)")
            }),
            'pickup_postal_code': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Code postal")
            }),
            'delivery_country': CountrySelectWidget(attrs={'class': 'form-control'}),
            'delivery_city': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Ville de destination")
            }),
            'delivery_address': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': _("Adresse complète (optionnel)")
            }),
            'delivery_postal_code': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Code postal")
            }),
            'pickup_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control',
                'min': timezone.now().date().isoformat()
            }),
            'delivery_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
            'price_type': forms.Select(attrs={'class': 'form-control'}),
            'asking_price': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'placeholder': _("0.00")
            }),
            'currency': forms.Select(attrs={'class': 'form-control'}),
            'insurance_value': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
        }

        labels = {
            'flexible_dates': _("Dates flexibles"),
            'is_fragile': _("Colis fragile"),
            'requires_insurance': _("Assurance requise"),
            'requires_packaging': _("Emballage requis"),
            'requires_loading_help': _("Aide au chargement nécessaire"),
            'requires_unloading_help': _("Aide au déchargement nécessaire"),
        }

        help_texts = {
            'asking_price': _("Prix que vous souhaitez payer pour le transport"),
            'pickup_date': _("Date à partir de laquelle le colis est disponible"),
            'delivery_date': _("Date limite pour la livraison"),
        }

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        # Filtrer les catégories actives
        self.fields['category'].queryset = PackageCategory.objects.filter(is_active=True)

        # Définir les dates par défaut
        if not self.instance.pk:
            self.fields['pickup_date'].initial = timezone.now().date() + timezone.timedelta(days=1)
            self.fields['delivery_date'].initial = timezone.now().date() + timezone.timedelta(days=7)

        # Ajuster les champs selon le type de colis
        if self.instance.package_type:
            self.adjust_fields_for_package_type()

        # Masquer les champs d'assurance si non requis
        self.fields['insurance_value'].widget.attrs['class'] = 'form-control insurance-field'
        if not self.data.get('requires_insurance', False) and not self.instance.requires_insurance:
            self.fields['insurance_value'].widget.attrs['style'] = 'display: none;'

    def adjust_fields_for_package_type(self):
        """Ajuste les champs requis selon le type de colis"""
        package_type = self.instance.package_type or self.data.get('package_type')

        if package_type == Package.PackageType.SMALL_PACKAGE:
            self.fields['requires_loading_help'].required = False
            self.fields['requires_unloading_help'].required = False
        elif package_type == Package.PackageType.FURNITURE:
            self.fields['requires_loading_help'].initial = True
            self.fields['requires_unloading_help'].initial = True

    def clean_delivery_date(self):
        pickup_date = self.cleaned_data.get('pickup_date')
        delivery_date = self.cleaned_data.get('delivery_date')

        if pickup_date and delivery_date:
            if delivery_date < pickup_date:
                raise ValidationError(
                    _("La date de livraison doit être postérieure à la date de départ.")
                )

            # Maximum 90 jours entre départ et livraison
            if (delivery_date - pickup_date).days > 90:
                raise ValidationError(
                    _("L'écart maximum entre départ et livraison est de 90 jours.")
                )

            if delivery_date < timezone.now().date():
                raise ValidationError(
                    _("La date de livraison ne peut pas être dans le passé.")
                )

        return delivery_date

    def clean_pickup_date(self):
        pickup_date = self.cleaned_data.get('pickup_date')

        if pickup_date and pickup_date < timezone.now().date():
            raise ValidationError(
                _("La date de départ ne peut pas être dans le passé.")
            )

        return pickup_date

    def clean_asking_price(self):
        price = self.cleaned_data.get('asking_price')
        price_type = self.cleaned_data.get('price_type')

        if price:
            if price <= 0:
                raise ValidationError(_("Le prix doit être supérieur à 0."))

            if price_type == Package.PriceType.FIXED and price < 5:
                raise ValidationError(_("Le prix fixe minimum est de 5€."))

        return price

    def clean_weight(self):
        weight = self.cleaned_data.get('weight')

        if weight:
            if weight <= 0:
                raise ValidationError(_("Le poids doit être supérieur à 0."))
            if weight > 2000:  # 2 tonnes maximum
                raise ValidationError(_("Le poids maximum autorisé est de 2000 kg."))

        return weight

    def clean_insurance_value(self):
        requires_insurance = self.cleaned_data.get('requires_insurance', False)
        insurance_value = self.cleaned_data.get('insurance_value')

        if requires_insurance and not insurance_value:
            raise ValidationError(
                _("Veuillez spécifier la valeur à assurer.")
            )

        if insurance_value and insurance_value <= 0:
            raise ValidationError(_("La valeur assurée doit être positive."))

        return insurance_value

    def clean(self):
        cleaned_data = super().clean()

        # Calcul automatique du type de colis basé sur le poids
        weight = cleaned_data.get('weight')
        if weight and not cleaned_data.get('package_type'):
            if weight <= 30:
                cleaned_data['package_type'] = Package.PackageType.SMALL_PACKAGE
            elif weight <= 100:
                cleaned_data['package_type'] = Package.PackageType.MEDIUM_PACKAGE
            elif weight <= 500:
                cleaned_data['package_type'] = Package.PackageType.LARGE_PACKAGE
            else:
                cleaned_data['package_type'] = Package.PackageType.PALLET

        return cleaned_data


class PackageCreateForm(PackageBaseForm):
    """Formulaire pour créer un colis"""

    accept_terms = forms.BooleanField(
        required=True,
        label=_("J'accepte les conditions générales"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        error_messages={'required': _("Vous devez accepter les conditions générales.")}
    )

    def save(self, commit=True):
        package = super().save(commit=False)

        if self.user:
            package.sender = self.user

        if commit:
            package.save()

        return package


class PackageUpdateForm(PackageBaseForm):
    """Formulaire pour mettre à jour un colis"""

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        # Empêcher la modification de certains champs si le colis est réservé
        if self.instance.status in [Package.Status.RESERVED, Package.Status.IN_TRANSIT]:
            disabled_fields = ['pickup_date', 'delivery_date', 'pickup_address',
                              'delivery_address', 'asking_price', 'price_type']
            for field in disabled_fields:
                if field in self.fields:
                    self.fields[field].disabled = True
                    self.fields[field].help_text = _("Non modifiable car le colis est réservé.")


class PackageImageForm(forms.ModelForm):
    """Formulaire pour les images de colis"""

    class Meta:
        model = PackageImage
        fields = ['image', 'caption', 'is_primary', 'display_order']

        widgets = {
            'image': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*'
            }),
            'caption': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': _("Description de l'image")
            }),
            'display_order': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': 0
            }),
        }

    def clean_image(self):
        image = self.cleaned_data.get('image')

        if image:
            # Vérifier la taille (déjà fait par le validateur)
            # Vérifier le type MIME
            import imghdr
            image.seek(0)
            file_type = imghdr.what(image)
            if file_type not in ['jpeg', 'png', 'gif', 'webp']:
                raise ValidationError(
                    _("Format d'image non supporté. Utilisez JPEG, PNG, GIF ou WebP.")
                )
            image.seek(0)

        return image


class TransportOfferForm(forms.ModelForm):
    """Formulaire pour proposer une offre de transport"""

    class Meta:
        model = TransportOffer
        fields = [
            'price', 'currency', 'proposed_pickup_date', 'proposed_delivery_date',
            'message', 'provides_insurance', 'insurance_coverage',
            'provides_packaging', 'provides_loading', 'provides_unloading'
        ]

        widgets = {
            'price': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'placeholder': _("0.00")
            }),
            'currency': forms.Select(attrs={'class': 'form-control'}),
            'proposed_pickup_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control',
                'min': timezone.now().date().isoformat()
            }),
            'proposed_delivery_date': forms.DateInput(attrs={
                'type': 'date',
                'class': 'form-control'
            }),
            'message': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _("Présentez-vous et expliquez pourquoi vous êtes le bon transporteur...")
            }),
            'insurance_coverage': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
        }

        labels = {
            'provides_insurance': _("Je fournis une assurance"),
            'provides_packaging': _("Je fournis l'emballage"),
            'provides_loading': _("Je fournis le chargement"),
            'provides_unloading': _("Je fournis le déchargement"),
        }

    def __init__(self, *args, **kwargs):
        self.package = kwargs.pop('package', None)
        self.carrier = kwargs.pop('carrier', None)
        super().__init__(*args, **kwargs)

        # Pré-remplir les dates basées sur le colis
        if self.package and not self.instance.pk:
            self.fields['proposed_pickup_date'].initial = self.package.pickup_date
            self.fields['proposed_delivery_date'].initial = self.package.delivery_date
            self.fields['currency'].initial = self.package.currency

            # Suggérer un prix basé sur le prix demandé
            if self.package.asking_price:
                suggested_price = float(self.package.asking_price) * 0.9  # 10% de moins
                self.fields['price'].initial = round(suggested_price, 2)

        # Masquer le champ de couverture d'assurance si non fournie
        self.fields['insurance_coverage'].widget.attrs['class'] = 'form-control insurance-coverage-field'
        if not self.data.get('provides_insurance', False) and not self.instance.provides_insurance:
            self.fields['insurance_coverage'].widget.attrs['style'] = 'display: none;'

    def clean_proposed_delivery_date(self):
        pickup_date = self.cleaned_data.get('proposed_pickup_date')
        delivery_date = self.cleaned_data.get('proposed_delivery_date')

        if pickup_date and delivery_date and delivery_date < pickup_date:
            raise ValidationError(
                _("La date de livraison proposée doit être postérieure à la date de départ.")
            )

        # Vérifier que la livraison est avant la date limite du colis
        if self.package and delivery_date:
            if delivery_date > self.package.delivery_date and not self.package.flexible_dates:
                raise ValidationError(
                    _("La date de livraison proposée dépasse la date limite du colis.")
                )

        return delivery_date

    def clean_proposed_pickup_date(self):
        pickup_date = self.cleaned_data.get('proposed_pickup_date')

        # Vérifier que le départ est après la date demandée
        if self.package and pickup_date:
            if pickup_date < self.package.pickup_date and not self.package.flexible_dates:
                raise ValidationError(
                    _("La date de départ proposée est antérieure à la date demandée.")
                )

        return pickup_date

    def clean_price(self):
        price = self.cleaned_data.get('price')

        if price:
            if price <= 0:
                raise ValidationError(_("Le prix doit être supérieur à 0."))

            # Vérifier que le prix n'est pas trop bas par rapport au prix demandé
            if self.package and self.package.asking_price:
                min_price = float(self.package.asking_price) * 0.5  # Minimum 50% du prix demandé
                if price < min_price:
                    raise ValidationError(
                        _("Le prix proposé est trop bas. Le minimum suggéré est {:.2f}€.").format(min_price)
                    )

        return price

    def clean_insurance_coverage(self):
        provides_insurance = self.cleaned_data.get('provides_insurance', False)
        insurance_coverage = self.cleaned_data.get('insurance_coverage')

        if provides_insurance and not insurance_coverage:
            raise ValidationError(
                _("Veuillez spécifier le montant de la couverture d'assurance.")
            )

        if insurance_coverage and insurance_coverage <= 0:
            raise ValidationError(_("La couverture d'assurance doit être positive."))

        return insurance_coverage

    def save(self, commit=True):
        offer = super().save(commit=False)

        if self.package:
            offer.package = self.package

        if self.carrier:
            offer.carrier = self.carrier

        if commit:
            offer.save()

        return offer


class PackageSearchForm(forms.Form):
    """Formulaire de recherche de colis"""

    q = forms.CharField(
        required=False,
        label=_("Rechercher"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Que souhaitez-vous transporter ?")
        })
    )

    category = forms.ModelChoiceField(
        required=False,
        queryset=PackageCategory.objects.filter(is_active=True),
        label=_("Catégorie"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    package_type = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous"))] + list(Package.PackageType.choices),
        label=_("Type de colis"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    # Origine
    pickup_country = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous les pays"))] + list(countries),
        label=_("Pays de départ"),
        widget=CountrySelectWidget(attrs={'class': 'form-control'})
    )

    pickup_city = forms.CharField(
        required=False,
        label=_("Ville de départ"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Ex: Paris, Lyon...")
        })
    )

    # Destination
    delivery_country = forms.ChoiceField(
        required=False,
        choices=[('', _("Tous les pays"))] + list(countries),
        label=_("Pays de destination"),
        widget=CountrySelectWidget(attrs={'class': 'form-control'})
    )

    delivery_city = forms.CharField(
        required=False,
        label=_("Ville de destination"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Ex: Marseille, Casablanca...")
        })
    )

    # Dates
    pickup_date_from = forms.DateField(
        required=False,
        label=_("Départ à partir du"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    pickup_date_to = forms.DateField(
        required=False,
        label=_("Départ jusqu'au"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    # Dimensions et poids
    max_weight = forms.DecimalField(
        required=False,
        min_value=0,
        decimal_places=3,
        label=_("Poids maximum (kg)"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Ex: 50")
        })
    )

    max_volume = forms.DecimalField(
        required=False,
        min_value=0,
        decimal_places=3,
        label=_("Volume maximum (L)"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Ex: 100")
        })
    )

    # Prix
    min_price = forms.DecimalField(
        required=False,
        min_value=0,
        decimal_places=2,
        label=_("Prix minimum"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Min")
        })
    )

    max_price = forms.DecimalField(
        required=False,
        min_value=0,
        decimal_places=2,
        label=_("Prix maximum"),
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': _("Max")
        })
    )

    # Options
    flexible_dates = forms.BooleanField(
        required=False,
        label=_("Dates flexibles seulement"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    provides_insurance = forms.BooleanField(
        required=False,
        label=_("Transport avec assurance"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    # Tri
    sort_by = forms.ChoiceField(
        required=False,
        choices=[
            ('-created_at', _("Plus récent")),
            ('pickup_date', _("Départ proche")),
            ('asking_price', _("Prix croissant")),
            ('-asking_price', _("Prix décroissant")),
            ('-view_count', _("Plus populaire")),
        ],
        initial='-created_at',
        label=_("Trier par"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    def clean(self):
        cleaned_data = super().clean()
        pickup_date_from = cleaned_data.get('pickup_date_from')
        pickup_date_to = cleaned_data.get('pickup_date_to')
        min_price = cleaned_data.get('min_price')
        max_price = cleaned_data.get('max_price')

        if pickup_date_from and pickup_date_to:
            if pickup_date_to < pickup_date_from:
                raise ValidationError(
                    _("La date 'jusqu'au' doit être postérieure à la date 'à partir du'.")
                )

        if min_price and max_price:
            if min_price > max_price:
                raise ValidationError(
                    _("Le prix minimum ne peut pas être supérieur au prix maximum.")
                )

        return cleaned_data


class PackageReportForm(forms.ModelForm):
    """Formulaire pour signaler un colis"""

    class Meta:
        model = PackageReport
        fields = ['reason', 'description', 'evidence']

        widgets = {
            'reason': forms.Select(attrs={'class': 'form-control'}),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4,
                'placeholder': _("Décrivez le problème en détail...")
            }),
            'evidence': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*,.pdf,.doc,.docx'
            }),
        }

        labels = {
            'evidence': _("Preuve (capture d'écran, document...)"),
        }


class QuickQuoteForm(forms.Form):
    """Formulaire de devis rapide (pour transporteurs)"""

    pickup_address = forms.CharField(
        label=_("Adresse de départ"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Adresse complète")
        })
    )

    delivery_address = forms.CharField(
        label=_("Adresse de destination"),
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': _("Adresse complète")
        })
    )

    weight = forms.DecimalField(
        label=_("Poids (kg)"),
        min_value=0.001,
        decimal_places=3,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.001'
        })
    )

    length = forms.DecimalField(
        required=False,
        label=_("Longueur (cm)"),
        min_value=0,
        decimal_places=1,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.1'
        })
    )

    width = forms.DecimalField(
        required=False,
        label=_("Largeur (cm)"),
        min_value=0,
        decimal_places=1,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.1'
        })
    )

    height = forms.DecimalField(
        required=False,
        label=_("Hauteur (cm)"),
        min_value=0,
        decimal_places=1,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.1'
        })
    )

    pickup_date = forms.DateField(
        label=_("Date de départ souhaitée"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    delivery_date = forms.DateField(
        label=_("Date de livraison souhaitée"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    is_fragile = forms.BooleanField(
        required=False,
        label=_("Colis fragile"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    requires_insurance = forms.BooleanField(
        required=False,
        label=_("Assurance requise"),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )

    insurance_value = forms.DecimalField(
        required=False,
        label=_("Valeur à assurer"),
        min_value=0,
        decimal_places=2,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'step': '0.01'
        })
    )

    def clean_delivery_date(self):
        pickup_date = self.cleaned_data.get('pickup_date')
        delivery_date = self.cleaned_data.get('delivery_date')

        if pickup_date and delivery_date and delivery_date < pickup_date:
            raise ValidationError(
                _("La date de livraison doit être postérieure à la date de départ.")
            )

        return delivery_date


# Formsets
PackageImageFormSet = inlineformset_factory(
    Package,
    PackageImage,
    form=PackageImageForm,
    extra=5,  # 5 formulaires d'image vides par défaut
    max_num=15,  # Maximum d'images
    can_delete=True,
    validate_max=True,
)


class PackageFilterForm(forms.Form):
    """Formulaire de filtrage pour le dashboard"""

    STATUS_CHOICES = [
        ('', _("Tous les statuts")),
        ('AVAILABLE', _("Disponible")),
        ('RESERVED', _("Réservé")),
        ('IN_TRANSIT', _("En transit")),
        ('DELIVERED', _("Livré")),
        ('CANCELLED', _("Annulé")),
    ]

    status = forms.ChoiceField(
        required=False,
        choices=STATUS_CHOICES,
        label=_("Statut"),
        widget=forms.Select(attrs={'class': 'form-control'})
    )

    date_from = forms.DateField(
        required=False,
        label=_("À partir du"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    date_to = forms.DateField(
        required=False,
        label=_("Jusqu'au"),
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )

    def clean(self):
        cleaned_data = super().clean()
        date_from = cleaned_data.get('date_from')
        date_to = cleaned_data.get('date_to')

        if date_from and date_to and date_to < date_from:
            raise ValidationError(
                _("La date 'jusqu'au' doit être postérieure à la date 'à partir du'.")
            )

        return cleaned_data-e 

=== Fichier: colis/management/commands/generate_sitemaps.py ===
# ~/ebi3/colis/management/commands/generate_sitemaps.py
from django.core.management.base import BaseCommand
from django.contrib.sites.models import Site
from colis.sitemaps import SitemapGenerator
import os
from django.conf import settings

class Command(BaseCommand):
    help = 'Génère les fichiers sitemap XML pour l\'application colis'

    def add_arguments(self, parser):
        parser.add_argument(
            '--output-dir',
            type=str,
            default=os.path.join(settings.BASE_DIR, 'static', 'sitemaps'),
            help='Répertoire de sortie pour les fichiers sitemap'
        )

    def handle(self, *args, **options):
        output_dir = options['output_dir']

        # Créer le répertoire s'il n'existe pas
        os.makedirs(output_dir, exist_ok=True)

        # Générer l'index des sitemaps
        index_content = SitemapGenerator.generate_sitemap_index()
        index_path = os.path.join(output_dir, 'sitemap_index.xml')

        with open(index_path, 'w', encoding='utf-8') as f:
            f.write(index_content)

        self.stdout.write(
            self.style.SUCCESS(f'Index sitemap généré: {index_path}')
        )

        # Afficher les statistiques
        stats = SitemapGenerator.get_sitemap_stats()
        self.stdout.write(f"\nStatistiques des sitemaps:")
        self.stdout.write(f"Total URLs: {stats['total_urls']}")

        for sitemap_name, count in stats['by_type'].items():
            self.stdout.write(f"  {sitemap_name}: {count} URLs")-e 

=== Fichier: colis/__init__.py ===
-e 

=== Fichier: colis/apps.py ===
# ~/ebi3/colis/apps.py
from django.apps import AppConfig

class ColisConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'colis'
    verbose_name = "Colis"

    def ready(self):
        """Connecte les signaux lors du chargement de l'application"""
        # TODO: Décommenter lorsque les signaux seront implémentés
        # import colis.signals
        # colis.signals.connect_signals()

        # Import des tâches Celery (si utilisé)
        try:
            import colis.tasks  # noqa
        except ImportError:
            pass-e 

=== Fichier: colis/tasks.py ===
# ~/ebi3/colis/tasks.py
"""
Tâches asynchrones pour l'application colis
Utilise Celery pour les opérations longues, périodiques ou groupées
"""

import logging
from datetime import timedelta
from decimal import Decimal
from typing import List, Dict, Any
from django.utils import timezone
from django.conf import settings
from django.core.cache import cache
from django.core.mail import send_mail, EmailMultiAlternatives
from django.template.loader import render_to_string
from django.db.models import Count, Q, F, Avg, Sum, Case, When, IntegerField
from django.contrib.gis.geos import Point
from django.contrib.gis.db.models.functions import Distance
from django.contrib.sites.models import Site
from celery import shared_task, group, chain, chord
from celery.utils.log import get_task_logger

from .models import (
    Package, TransportOffer, PackageCategory, PackageImage,
    PackageView, PackageFavorite, PackageReport
)
from users.models import User
from messaging.models import Conversation, Message
from carriers.models import Carrier, CarrierReview

logger = get_task_logger(__name__)


# ============================================================================
# TÂCHES POUR LES PACKAGES
# ============================================================================

@shared_task(name='colis.tasks.update_package_statuses')
def update_package_statuses():
    """
    Tâche périodique pour mettre à jour les statuts des colis
    - Expiration des colis disponibles
    - Passage en transit après date de départ
    - Passage en livré après date d'arrivée
    """
    now = timezone.now()
    updated_count = 0

    # Colis disponibles qui ont expiré
    expired_packages = Package.objects.filter(
        status=Package.Status.AVAILABLE,
        available_until__lt=now.date()
    )

    for package in expired_packages:
        package.status = Package.Status.EXPIRED
        package.expired_at = now
        package.save(update_fields=['status', 'expired_at', 'updated_at'])
        updated_count += 1

        # Notifier l'expéditeur
        send_package_status_notification.delay(
            package_id=package.id,
            old_status='AVAILABLE',
            new_status='EXPIRED'
        )

    # Colis réservés dont la date de départ est passée
    reserved_to_transit = Package.objects.filter(
        status=Package.Status.RESERVED,
        departure_date__lt=now.date()
    )

    for package in reserved_to_transit:
        package.status = Package.Status.IN_TRANSIT
        package.save(update_fields=['status', 'updated_at'])
        updated_count += 1

        send_package_status_notification.delay(
            package_id=package.id,
            old_status='RESERVED',
            new_status='IN_TRANSIT'
        )

    # Colis en transit dont la date d'arrivée est passée
    transit_to_delivered = Package.objects.filter(
        status=Package.Status.IN_TRANSIT,
        arrival_date__lt=now.date()
    )

    for package in transit_to_delivered:
        package.status = Package.Status.DELIVERED
        package.delivered_at = now
        package.save(update_fields=['status', 'delivered_at', 'updated_at'])
        updated_count += 1

        send_package_status_notification.delay(
            package_id=package.id,
            old_status='IN_TRANSIT',
            new_status='DELIVERED'
        )

    logger.info(f"Mise à jour de {updated_count} statuts de colis")
    return updated_count


@shared_task(name='colis.tasks.cleanup_old_packages')
def cleanup_old_packages(days_old: int = 365):
    """
    Nettoie les anciens colis (archivage ou suppression)
    Args:
        days_old: Nombre de jours après lesquels un colis est considéré comme ancien
    """
    cutoff_date = timezone.now() - timedelta(days=days_old)
    old_packages = Package.objects.filter(
        Q(created_at__lt=cutoff_date) &
        Q(status__in=['DELIVERED', 'CANCELLED', 'EXPIRED'])
    )

    # Archive les anciens colis
    archived_count = old_packages.update(
        is_archived=True,
        archived_at=timezone.now()
    )

    # Supprime les colis très anciens (plus de 2 ans)
    very_old_cutoff = timezone.now() - timedelta(days=730)
    very_old_packages = Package.objects.filter(
        created_at__lt=very_old_cutoff,
        is_archived=True
    )

    deleted_count = very_old_packages.count()
    # Note: La suppression est commentée par sécurité
    # very_old_packages.delete()

    logger.info(f"Archivé {archived_count} colis, {deleted_count} supprimables")
    return {'archived': archived_count, 'deletable': deleted_count}


@shared_task(name='colis.tasks.calculate_package_statistics')
def calculate_package_statistics():
    """
    Calcule les statistiques globales des colis et met en cache
    """
    stats = Package.objects.aggregate(
        total_packages=Count('id'),
        available_packages=Count('id', filter=Q(status='AVAILABLE')),
        reserved_packages=Count('id', filter=Q(status='RESERVED')),
        in_transit_packages=Count('id', filter=Q(status='IN_TRANSIT')),
        delivered_packages=Count('id', filter=Q(status='DELIVERED')),
        total_weight=Sum('weight'),
        average_price=Avg('price'),
        total_offers=Sum('offers_count'),
    )

    # Statistiques par catégorie
    category_stats = PackageCategory.objects.annotate(
        package_count=Count('packages', filter=Q(packages__status='AVAILABLE'))
    ).values('id', 'name', 'package_count').order_by('-package_count')[:10]

    # Top destinations
    top_destinations = Package.objects.filter(status='AVAILABLE').values(
        'country_to', 'city_to'
    ).annotate(
        count=Count('id')
    ).order_by('-count')[:10]

    cache_data = {
        'global_stats': stats,
        'category_stats': list(category_stats),
        'top_destinations': list(top_destinations),
        'calculated_at': timezone.now().isoformat(),
    }

    # Mettre en cache pour 1 heure
    cache.set('colis_statistics', cache_data, timeout=3600)
    logger.info("Statistiques des colis calculées et mises en cache")

    return cache_data


# ============================================================================
# TÂCHES POUR LES OFFRES DE TRANSPORT
# ============================================================================

@shared_task(name='colis.tasks.process_expired_offers')
def process_expired_offers():
    """
    Traite les offres de transport expirées
    - Marque les offres comme expirées
    - Notifie les transporteurs
    """
    expired_offers = TransportOffer.objects.filter(
        status=TransportOffer.Status.PENDING,
        expires_at__lt=timezone.now()
    )

    expired_count = expired_offers.count()

    for offer in expired_offers:
        offer.status = TransportOffer.Status.EXPIRED
        offer.save(update_fields=['status', 'updated_at'])

        # Notifier le transporteur
        send_transport_offer_notification.delay(
            offer_id=offer.id,
            notification_type='OFFER_EXPIRED'
        )

        # Notifier l'expéditeur si c'était la seule offre
        package_offers = TransportOffer.objects.filter(
            package=offer.package,
            status=TransportOffer.Status.PENDING
        ).count()

        if package_offers == 0:
            send_package_notification.delay(
                package_id=offer.package.id,
                notification_type='NO_ACTIVE_OFFERS'
            )

    logger.info(f"Traiter {expired_count} offres expirées")
    return expired_count


@shared_task(name='colis.tasks.find_matching_carriers')
def find_matching_carriers(package_id: int):
    """
    Trouve les transporteurs correspondant à un colis
    Args:
        package_id: ID du colis
    """
    try:
        package = Package.objects.get(id=package_id)
    except Package.DoesNotExist:
        logger.error(f"Colis {package_id} non trouvé")
        return 0

    # Critères de correspondance
    matching_carriers = Carrier.objects.filter(
        # Disponibilité
        is_available=True,
        status='APPROVED',
        # Capacités
        max_weight__gte=package.weight or 0,
        max_volume__gte=package.volume or 0,
        # Destination
        routes__end_country=package.country_to,
        routes__end_city__icontains=package.city_to,
        routes__is_active=True,
        routes__departure_date__gte=package.departure_date,
    ).distinct()

    matching_count = matching_carriers.count()
    logger.info(f"Trouvé {matching_count} transporteurs pour le colis {package_id}")

    # Notifier les transporteurs correspondants
    for carrier in matching_carriers:
        send_carrier_match_notification.delay(
            carrier_id=carrier.id,
            package_id=package.id
        )

    return matching_count


@shared_task(name='colis.tasks.create_auto_offer')
def create_auto_offer(package_id: int, carrier_id: int):
    """
    Crée une offre automatique pour un transporteur correspondant
    """
    try:
        package = Package.objects.get(id=package_id)
        carrier = Carrier.objects.get(id=carrier_id)
    except (Package.DoesNotExist, Carrier.DoesNotExist) as e:
        logger.error(f"Erreur création offre auto: {e}")
        return None

    # Calcul du prix automatique (prix du colis + marge transporteur)
    base_price = package.price or Decimal('0.00')
    carrier_margin = carrier.base_price_per_km or Decimal('1.00')

    # Estimation de distance (simplifiée)
    estimated_distance = Decimal('500.00')  # En km
    transport_price = estimated_distance * carrier_margin

    total_price = base_price + transport_price

    # Création de l'offre
    offer = TransportOffer.objects.create(
        package=package,
        carrier=carrier.user,
        price=total_price,
        currency=package.currency,
        notes=f"Offre automatique générée le {timezone.now().strftime('%d/%m/%Y')}",
        expires_at=timezone.now() + timedelta(days=7)
    )

    logger.info(f"Offre automatique {offer.id} créée pour transporteur {carrier_id}")

    # Notifier l'expéditeur
    send_transport_offer_notification.delay(
        offer_id=offer.id,
        notification_type='NEW_AUTO_OFFER'
    )

    return offer.id


# ============================================================================
# TÂCHES DE NOTIFICATION
# ============================================================================

@shared_task(name='colis.tasks.send_package_status_notification')
def send_package_status_notification(package_id: int, old_status: str, new_status: str):
    """
    Envoie une notification de changement de statut
    """
    try:
        package = Package.objects.get(id=package_id)
        sender = package.sender
    except Package.DoesNotExist:
        logger.error(f"Colis {package_id} non trouvé")
        return False

    # Préparer l'email
    subject = f"Colis '{package.title}' - Statut mis à jour"

    context = {
        'package': package,
        'old_status': old_status,
        'new_status': new_status,
        'new_status_display': package.get_status_display(),
        'site': Site.objects.get_current(),
        'user': sender,
    }

    html_content = render_to_string('colis/emails/package_status_change.html', context)
    text_content = render_to_string('colis/emails/package_status_change.txt', context)

    try:
        email = EmailMultiAlternatives(
            subject=subject,
            body=text_content,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[sender.email],
            reply_to=[settings.REPLY_TO_EMAIL]
        )
        email.attach_alternative(html_content, "text/html")
        email.send()

        logger.info(f"Notification de statut envoyée pour le colis {package_id}")
        return True
    except Exception as e:
        logger.error(f"Erreur envoi notification: {e}")
        return False


@shared_task(name='colis.tasks.send_transport_offer_notification')
def send_transport_offer_notification(offer_id: int, notification_type: str):
    """
    Envoie des notifications relatives aux offres de transport
    Types: NEW_OFFER, OFFER_ACCEPTED, OFFER_REJECTED, OFFER_EXPIRED
    """
    try:
        offer = TransportOffer.objects.get(id=offer_id)
        carrier = offer.carrier
        package = offer.package
    except TransportOffer.DoesNotExist:
        logger.error(f"Offre {offer_id} non trouvé")
        return False

    # Déterminer le sujet et le destinataire
    if notification_type in ['NEW_OFFER', 'OFFER_ACCEPTED', 'OFFER_REJECTED']:
        recipient = package.sender
        recipient_type = 'sender'
    elif notification_type in ['OFFER_EXPIRED', 'NEW_AUTO_OFFER']:
        recipient = carrier
        recipient_type = 'carrier'
    else:
        logger.error(f"Type de notification invalide: {notification_type}")
        return False

    # Mapper les types aux sujets
    subject_map = {
        'NEW_OFFER': f"Nouvelle offre pour votre colis '{package.title}'",
        'OFFER_ACCEPTED': f"Votre offre pour le colis '{package.title}' a été acceptée",
        'OFFER_REJECTED': f"Votre offre pour le colis '{package.title}' a été refusée",
        'OFFER_EXPIRED': f"Votre offre pour le colis '{package.title}' a expiré",
        'NEW_AUTO_OFFER': f"Nouvelle opportunité de transport : {package.title}",
    }

    subject = subject_map.get(notification_type, "Mise à jour de votre offre")

    context = {
        'offer': offer,
        'package': package,
        'notification_type': notification_type,
        'recipient_type': recipient_type,
        'site': Site.objects.get_current(),
        'user': recipient,
    }

    template_name = f'colis/emails/transport_offer_{notification_type.lower()}.html'
    txt_template_name = f'colis/emails/transport_offer_{notification_type.lower()}.txt'

    try:
        html_content = render_to_string(template_name, context)
        text_content = render_to_string(txt_template_name, context)

        email = EmailMultiAlternatives(
            subject=subject,
            body=text_content,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[recipient.email],
            reply_to=[settings.REPLY_TO_EMAIL]
        )
        email.attach_alternative(html_content, "text/html")
        email.send()

        logger.info(f"Notification {notification_type} envoyée pour l'offre {offer_id}")
        return True
    except Exception as e:
        logger.error(f"Erreur envoi notification offre: {e}")
        return False


@shared_task(name='colis.tasks.send_carrier_match_notification')
def send_carrier_match_notification(carrier_id: int, package_id: int):
    """
    Notifie un transporteur d'un colis correspondant à ses critères
    """
    try:
        carrier = Carrier.objects.get(id=carrier_id)
        package = Package.objects.get(id=package_id)
    except (Carrier.DoesNotExist, Package.DoesNotExist) as e:
        logger.error(f"Erreur notification match: {e}")
        return False

    subject = f"💼 Nouveau colis correspondant à votre profil"

    context = {
        'carrier': carrier,
        'package': package,
        'site': Site.objects.get_current(),
        'user': carrier.user,
    }

    try:
        html_content = render_to_string('colis/emails/carrier_match_notification.html', context)
        text_content = render_to_string('colis/emails/carrier_match_notification.txt', context)

        email = EmailMultiAlternatives(
            subject=subject,
            body=text_content,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[carrier.user.email],
            reply_to=[settings.REPLY_TO_EMAIL]
        )
        email.attach_alternative(html_content, "text/html")
        email.send()

        logger.info(f"Notification de match envoyée au transporteur {carrier_id}")
        return True
    except Exception as e:
        logger.error(f"Erreur envoi notification match: {e}")
        return False


@shared_task(name='colis.tasks.send_package_notification')
def send_package_notification(package_id: int, notification_type: str):
    """
    Notifications générales sur les colis
    Types: NO_ACTIVE_OFFERS, DELIVERY_REMINDER, REVIEW_REMINDER
    """
    try:
        package = Package.objects.get(id=package_id)
    except Package.DoesNotExist:
        logger.error(f"Colis {package_id} non trouvé")
        return False

    # Déterminer le destinataire
    if notification_type == 'NO_ACTIVE_OFFERS':
        recipient = package.sender
        subject = f"⏰ Aucune offre active pour votre colis '{package.title}'"
    elif notification_type == 'DELIVERY_REMINDER':
        recipient = package.carrier if package.carrier else package.sender
        subject = f"📦 Rappel : Livraison prévue pour '{package.title}'"
    elif notification_type == 'REVIEW_REMINDER':
        recipient = package.sender
        subject = f"⭐ N'oubliez pas d'évaluer le transport de '{package.title}'"
    else:
        logger.error(f"Type de notification invalide: {notification_type}")
        return False

    context = {
        'package': package,
        'notification_type': notification_type,
        'site': Site.objects.get_current(),
        'user': recipient,
    }

    try:
        html_content = render_to_string(f'colis/emails/package_{notification_type.lower()}.html', context)
        text_content = render_to_string(f'colis/emails/package_{notification_type.lower()}.txt', context)

        email = EmailMultiAlternatives(
            subject=subject,
            body=text_content,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[recipient.email],
            reply_to=[settings.REPLY_TO_EMAIL]
        )
        email.attach_alternative(html_content, "text/html")
        email.send()

        logger.info(f"Notification {notification_type} envoyée pour colis {package_id}")
        return True
    except Exception as e:
        logger.error(f"Erreur envoi notification colis: {e}")
        return False


# ============================================================================
# TÂCHES DE RAPPORT ET ANALYSE
# ============================================================================

@shared_task(name='colis.tasks.generate_package_report')
def generate_package_report(user_id: int, report_type: str, start_date=None, end_date=None):
    """
    Génère un rapport personnalisé pour un utilisateur
    Types: MONTHLY, QUARTERLY, YEARLY, CUSTOM
    """
    try:
        user = User.objects.get(id=user_id)
    except User.DoesNotExist:
        logger.error(f"Utilisateur {user_id} non trouvé")
        return None

    # Déterminer la période
    if not end_date:
        end_date = timezone.now()
    if not start_date:
        if report_type == 'MONTHLY':
            start_date = end_date - timedelta(days=30)
        elif report_type == 'QUARTERLY':
            start_date = end_date - timedelta(days=90)
        elif report_type == 'YEARLY':
            start_date = end_date - timedelta(days=365)
        else:
            start_date = end_date - timedelta(days=30)  # Par défaut

    # Récupérer les données
    packages = Package.objects.filter(
        sender=user,
        created_at__range=[start_date, end_date]
    )

    offers = TransportOffer.objects.filter(
        carrier=user,
        created_at__range=[start_date, end_date]
    )

    # Calculer les statistiques
    report_data = {
        'user': user.username,
        'report_type': report_type,
        'period': {'start': start_date, 'end': end_date},
        'package_stats': {
            'total': packages.count(),
            'available': packages.filter(status='AVAILABLE').count(),
            'reserved': packages.filter(status='RESERVED').count(),
            'delivered': packages.filter(status='DELIVERED').count(),
            'total_price': packages.aggregate(Sum('price'))['price__sum'] or 0,
            'average_price': packages.aggregate(Avg('price'))['price__avg'] or 0,
        },
        'offer_stats': {
            'total': offers.count(),
            'accepted': offers.filter(status='ACCEPTED').count(),
            'pending': offers.filter(status='PENDING').count(),
            'rejected': offers.filter(status='REJECTED').count(),
            'total_value': offers.aggregate(Sum('price'))['price__sum'] or 0,
            'acceptance_rate': (offers.filter(status='ACCEPTED').count() / max(offers.count(), 1)) * 100,
        },
        'popular_categories': packages.values('category__name').annotate(
            count=Count('id')
        ).order_by('-count')[:5],
        'top_destinations': packages.values('country_to', 'city_to').annotate(
            count=Count('id')
        ).order_by('-count')[:5],
    }

    logger.info(f"Rapport généré pour l'utilisateur {user_id}")

    # Option: Envoyer le rapport par email
    # send_report_email.delay(user_id, report_data, report_type)

    return report_data


@shared_task(name='colis.tasks.calculate_carrier_performance')
def calculate_carrier_performance(carrier_id: int = None):
    """
    Calcule les performances d'un transporteur ou de tous les transporteurs
    """
    if carrier_id:
        carriers = Carrier.objects.filter(id=carrier_id)
    else:
        carriers = Carrier.objects.filter(status='APPROVED')

    performance_data = []

    for carrier in carriers:
        # Offres du transporteur
        offers = TransportOffer.objects.filter(carrier=carrier.user)

        # Colis transportés
        packages = Package.objects.filter(carrier=carrier.user)

        # Calcul des métriques
        metrics = {
            'carrier_id': carrier.id,
            'carrier_name': carrier.company_name or carrier.user.username,
            'total_offers': offers.count(),
            'accepted_offers': offers.filter(status='ACCEPTED').count(),
            'offer_acceptance_rate': (offers.filter(status='ACCEPTED').count() / max(offers.count(), 1)) * 100,
            'total_packages': packages.count(),
            'delivered_packages': packages.filter(status='DELIVERED').count(),
            'delivery_success_rate': (packages.filter(status='DELIVERED').count() / max(packages.count(), 1)) * 100,
            'average_rating': carrier.average_rating,
            'total_revenue': offers.filter(status='ACCEPTED').aggregate(
                Sum('price')
            )['price__sum'] or Decimal('0.00'),
            'response_time_avg': None,  # À calculer avec les timestamps
            'last_active': carrier.updated_at,
        }

        performance_data.append(metrics)

        # Mettre à jour les statistiques du transporteur
        carrier.total_missions = metrics['total_packages']
        carrier.completed_missions = metrics['delivered_packages']
        carrier.success_rate = metrics['delivery_success_rate']
        carrier.save(update_fields=['total_missions', 'completed_missions', 'success_rate', 'updated_at'])

    logger.info(f"Performances calculées pour {len(performance_data)} transporteurs")
    return performance_data


# ============================================================================
# TÂCHES DE MAINTENANCE
# ============================================================================

@shared_task(name='colis.tasks.cleanup_old_data')
def cleanup_old_data():
    """
    Nettoie les anciennes données pour optimiser la base
    """
    now = timezone.now()
    cleanup_tasks = []

    # 1. Vues de plus de 30 jours
    old_views = PackageView.objects.filter(
        viewed_at__lt=now - timedelta(days=30)
    )
    views_deleted = old_views.count()
    old_views.delete()

    # 2. Images orphelines (sans package)
    orphan_images = PackageImage.objects.filter(package__isnull=True)
    images_deleted = orphan_images.count()
    orphan_images.delete()

    # 3. Signalements résolus de plus de 90 jours
    old_reports = PackageReport.objects.filter(
        status='RESOLVED',
        resolved_at__lt=now - timedelta(days=90)
    )
    reports_deleted = old_reports.count()
    old_reports.delete()

    # 4. Favoris de colis supprimés
    invalid_favorites = PackageFavorite.objects.filter(
        Q(package__isnull=True) | Q(user__isnull=True)
    )
    favorites_deleted = invalid_favorites.count()
    invalid_favorites.delete()

    results = {
        'views_deleted': views_deleted,
        'images_deleted': images_deleted,
        'reports_deleted': reports_deleted,
        'favorites_deleted': favorites_deleted,
        'total_deleted': views_deleted + images_deleted + reports_deleted + favorites_deleted,
    }

    logger.info(f"Données nettoyées: {results}")
    return results


@shared_task(name='colis.tasks.recalculate_all_volumes')
def recalculate_all_volumes():
    """
    Recalcule les volumes de tous les colis (en cas de bug de calcul)
    """
    packages = Package.objects.filter(
        length__isnull=False,
        width__isnull=False,
        height__isnull=False
    )

    updated_count = 0

    for package in packages:
        # Recalculer le volume
        old_volume = package.volume
        new_volume = (package.length * package.width * package.height) / 1000

        if old_volume != new_volume:
            package.volume = new_volume
            package.save(update_fields=['volume', 'updated_at'])
            updated_count += 1

    logger.info(f"Volumes recalculés: {updated_count}/{packages.count()} mis à jour")
    return {'total': packages.count(), 'updated': updated_count}


@shared_task(name='colis.tasks.update_category_counts')
def update_category_counts():
    """
    Met à jour les compteurs de colis par catégorie
    """
    categories = PackageCategory.objects.all()

    for category in categories:
        # Compter les colis actifs
        active_count = category.packages.filter(status='AVAILABLE').count()

        if category.package_count != active_count:
            category.package_count = active_count
            category.save(update_fields=['package_count', 'updated_at'])

    logger.info(f"Compteurs de catégories mis à jour: {categories.count()} catégories")
    return categories.count()


# ============================================================================
# TÂCHES GROUPÉES ET WORKFLOWS COMPLEXES
# ============================================================================

@shared_task(name='colis.tasks.daily_maintenance_workflow')
def daily_maintenance_workflow():
    """
    Workflow de maintenance quotidienne
    S'exécute une fois par jour
    """
    # Créer un groupe de tâches parallèles
    parallel_tasks = group(
        update_package_statuses.s(),
        process_expired_offers.s(),
        cleanup_old_data.s(),
    )

    # Chaîne de tâches séquentielles après les parallèles
    workflow = chain(
        parallel_tasks,
        calculate_package_statistics.s(),
        update_category_counts.s(),
    )

    result = workflow.apply_async()
    logger.info("Workflow de maintenance quotidienne démarré")
    return result.id


@shared_task(name='colis.tasks.weekly_report_workflow')
def weekly_report_workflow():
    """
    Workflow de rapports hebdomadaires
    """
    # 1. Générer les rapports pour les utilisateurs actifs
    active_users = User.objects.filter(
        is_active=True,
        last_login__gte=timezone.now() - timedelta(days=30)
    ).values_list('id', flat=True)

    # 2. Créer des tâches pour chaque utilisateur (limité aux 100 premiers)
    user_tasks = [generate_package_report.s(user_id, 'WEEKLY') for user_id in active_users[:100]]

    # 3. Exécuter en parallèle
    if user_tasks:
        group(user_tasks).apply_async()

    # 4. Générer les rapports admin
    admin_tasks = chain(
        calculate_carrier_performance.s(),
        calculate_package_statistics.s(),
    )

    admin_tasks.apply_async()

    logger.info(f"Workflow de rapports hebdomadaires démarré pour {len(user_tasks)} utilisateurs")
    return len(user_tasks)


# ============================================================================
# TÂCHES D'INTÉGRATION AVEC AUTRES APPLICATIONS
# ============================================================================

@shared_task(name='colis.tasks.sync_with_carriers_app')
def sync_with_carriers_app():
    """
    Synchronise les données avec l'application carriers
    """
    # Mettre à jour les statistiques des transporteurs basées sur les colis
    carrier_stats = Package.objects.filter(
        carrier__isnull=False,
        status='DELIVERED'
    ).values('carrier').annotate(
        delivered_count=Count('id'),
        total_revenue=Sum('price'),
        avg_rating=Avg('carrier_reviews__rating')
    )

    for stat in carrier_stats:
        carrier_id = stat['carrier']
        try:
            carrier = Carrier.objects.get(user_id=carrier_id)
            carrier.completed_missions = stat['delivered_count']
            # Mettre à jour d'autres champs si nécessaire
            carrier.save(update_fields=['completed_missions', 'updated_at'])
        except Carrier.DoesNotExist:
            continue

    logger.info(f"Données synchronisées avec carriers: {len(carrier_stats)} transporteurs")
    return len(carrier_stats)


@shared_task(name='colis.tasks.create_demo_packages')
def create_demo_packages(count: int = 10, user_id: int = None):
    """
    Crée des colis de démonstration pour le développement
    """
    from faker import Faker
    import random

    fake = Faker('fr_FR')

    # Récupérer l'utilisateur ou le premier admin
    if user_id:
        try:
            user = User.objects.get(id=user_id)
        except User.DoesNotExist:
            user = User.objects.filter(is_staff=True).first()
    else:
        user = User.objects.filter(is_staff=True).first()

    if not user:
        logger.error("Aucun utilisateur trouvé pour créer des colis de démonstration")
        return 0

    # Récupérer des catégories existantes
    categories = PackageCategory.objects.all()[:5]
    if not categories:
        logger.error("Aucune catégorie trouvée")
        return 0

    created_count = 0

    for i in range(count):
        category = random.choice(categories)
        weight = random.uniform(1.0, 100.0)
        price = random.uniform(10.0, 500.0)

        package = Package.objects.create(
            title=fake.sentence(nb_words=6),
            description=fake.paragraph(nb_sentences=3),
            sender=user,
            category=category,
            weight=round(weight, 3),
            length=random.uniform(10.0, 200.0),
            width=random.uniform(10.0, 150.0),
            height=random.uniform(5.0, 100.0),
            price=round(price, 2),
            currency='EUR',
            country_from='FR',
            city_from=fake.city(),
            country_to=random.choice(['MA', 'TN', 'DZ']),
            city_to=fake.city(),
            status=Package.Status.AVAILABLE,
            available_from=timezone.now().date(),
            available_until=timezone.now().date() + timedelta(days=30),
        )

        # Créer quelques images de démonstration
        for j in range(random.randint(1, 3)):
            PackageImage.objects.create(
                package=package,
                image=f"demo/package_{i}_image_{j}.jpg",
                caption=fake.sentence(nb_words=4),
                is_primary=(j == 0),
            )

        created_count += 1

    logger.info(f"Créé {created_count} colis de démonstration")
    return created_count-e 

=== Fichier: colis/urls.py ===
# ~/ebi3/colis/urls.py
from django.urls import path, include
from django.views.generic import TemplateView
from django.contrib.auth.decorators import login_required
from django.contrib.sitemaps.views import sitemap
from django.contrib.sitemaps import Sitemap
from . import views

app_name = 'colis'

# Classes de sitemap
class StaticSitemap(Sitemap):
    changefreq = "monthly"
    priority = 0.8

    def items(self):
        return [
            'colis:how_it_works',
            'colis:price_guide',
            'colis:packaging_tips',
            'colis:faq',
            'colis:terms',
        ]

    def location(self, item):
        from django.urls import reverse
        return reverse(item)

class PackageSitemap(Sitemap):
    changefreq = "daily"
    priority = 0.9

    def items(self):
        try:
            from .models import Package
            return Package.objects.filter(status=Package.Status.AVAILABLE).order_by('-created_at')
        except:
            return []

    def lastmod(self, obj):
        return obj.updated_at

class CategorySitemap(Sitemap):
    changefreq = "weekly"
    priority = 0.7

    def items(self):
        try:
            from .models import Category
            return Category.objects.filter(is_active=True)
        except:
            return []

class CarrierSitemap(Sitemap):
    changefreq = "weekly"
    priority = 0.6

    def items(self):
        try:
            from carriers.models import Carrier
            return Carrier.objects.filter(status='APPROVED', is_available=True)
        except:
            return []

class XMLIndexSitemap(Sitemap):
    changefreq = "weekly"
    priority = 0.8

    def items(self):
        return []

    def lastmod(self, obj):
        return None

def get_active_sitemaps():
    return {
        'index': XMLIndexSitemap,
        'static': StaticSitemap,
        'packages': PackageSitemap,
        'categories': CategorySitemap,
        'carriers': CarrierSitemap,
    }

# Vue pour sitemap de nouvelles
class NewsSitemapView(TemplateView):
    template_name = 'colis/sitemaps/news_sitemap.xml'
    content_type = 'application/xml'

urlpatterns = [
    # ============================================================================
    # PAGES PUBLIQUES
    # ============================================================================

    # Accueil des colis
    path('', views.PackageListView.as_view(), name='package_list'),

    # Recherche avancée
    path('recherche/', views.search_packages, name='search'),
    path('resultats/', views.PackageListView.as_view(), name='search_results'),

    # Catégories
    path('categories/', views.CategoryListView.as_view(), name='category_list'),
    path('categories/<slug:slug>/', views.CategoryDetailView.as_view(), name='category_detail'),

    # ============================================================================
    # COLIS SPÉCIFIQUES
    # ============================================================================

    # Détail d'un colis
    path('colis/<slug:slug>/', views.PackageDetailView.as_view(), name='package_detail'),

    # Actions sur un colis (authentification requise)
    path('colis/<slug:slug>/modifier/', views.PackageUpdateView.as_view(), name='package_edit'),
    path('colis/<slug:slug>/supprimer/', views.PackageDeleteView.as_view(), name='package_delete'),
    path('colis/<slug:slug>/signaler/', views.PackageReportView.as_view(), name='package_report'),

    # Favoris
    path('colis/<slug:slug>/favori/', views.toggle_package_favorite, name='toggle_favorite'),

    # ============================================================================
    # GESTION DES COLIS (UTILISATEUR)
    # ============================================================================

    # Création
    path('publier/', views.PackageCreateView.as_view(), name='package_create'),

    # Mes colis
    path('mes-colis/', views.MyPackagesListView.as_view(), name='my_packages'),
    path('mes-favoris/', views.PackageFavoritesListView.as_view(), name='favorite_list'),

    # Gestion avancée
    path('colis/<slug:slug>/gestion/', views.package_management, name='package_management'),
    path('statistiques/', views.PackageStatisticsView.as_view(), name='package_statistics'),

    # ============================================================================
    # OFFRES DE TRANSPORT
    # ============================================================================

    # Faire une offre
    path('colis/<slug:slug>/offre/creer/', views.TransportOfferCreateView.as_view(), name='offer_create'),

    # Mes offres
    path('mes-offres/', views.MyTransportOffersListView.as_view(), name='my_offers'),

    # Actions sur les offres
    path('offres/<int:pk>/accepter/', views.accept_transport_offer, name='accept_offer'),
    path('offres/<int:pk>/rejeter/', views.reject_transport_offer, name='reject_offer'),
    path('offres/<int:pk>/annuler/', views.cancel_transport_offer, name='cancel_offer'),

    # ============================================================================
    # ESPACE TRANSPORTEUR
    # ============================================================================

    # Colis disponibles
    path('transporteur/colis-disponibles/', views.AvailablePackagesView.as_view(), name='available_packages'),

    # Tableau de bord transporteur
    path('transporteur/dashboard/', views.CarrierDashboardView.as_view(), name='carrier_dashboard'),

    # Devis rapide
    path('transporteur/devis-rapide/', views.quick_quote, name='quick_quote'),

    # ============================================================================
    # API ET FONCTIONNALITÉS AJAX
    # ============================================================================

    # Mise à jour de statut
    path('api/colis/<slug:slug>/statut/<str:status>/', views.update_package_status, name='update_status'),

    # Statistiques
    path('api/colis/<slug:slug>/statistiques/', views.package_stats, name='package_stats'),

    # ============================================================================
    # PAGES D'AIDE ET INFORMATION
    # ============================================================================

    # Comment ça marche
    path('comment-ca-marche/', TemplateView.as_view(template_name='colis/how_it_works.html'), name='how_it_works'),

    # Guide des prix
    path('guide-des-prix/', TemplateView.as_view(template_name='colis/price_guide.html'), name='price_guide'),

    # Conseils d'emballage
    path('conseils-emballage/', TemplateView.as_view(template_name='colis/packaging_tips.html'), name='packaging_tips'),

    # FAQ
    path('faq/', TemplateView.as_view(template_name='colis/faq.html'), name='faq'),

    # Conditions générales
    path('conditions-generales/', TemplateView.as_view(template_name='colis/terms.html'), name='terms'),

    # ============================================================================
    # REDIRECTIONS ET URLS ALIAS
    # ============================================================================

    # Alias pour compatibilité
    path('annonces/', views.PackageListView.as_view(), name='ads'),  # Compatibilité avec anciens liens
    path('demandes/', views.PackageListView.as_view(), name='requests'),

    # Redirection transporteur
    path('devenir-transporteur/', TemplateView.as_view(template_name='colis/become_carrier.html'), name='become_carrier'),

    # ============================================================================
    # PAGES SPÉCIALES
    # ============================================================================

    # Succès stories
    path('success-stories/', TemplateView.as_view(template_name='colis/success_stories.html'), name='success_stories'),

    # Témoignages
    path('temoignages/', TemplateView.as_view(template_name='colis/testimonials.html'), name='testimonials'),

    # Blog
    path('blog/', TemplateView.as_view(template_name='colis/blog.html'), name='blog'),
    path('blog/category/<slug:slug>/', TemplateView.as_view(template_name='colis/blog_category.html'), name='blog_category'),
    path('blog/article/<slug:slug>/', TemplateView.as_view(template_name='colis/blog_post.html'), name='blog_post'),

    # ============================================================================
    # SITEMAPS
    # ============================================================================

    path('sitemap.xml', sitemap, {'sitemaps': get_active_sitemaps()},
         name='django.contrib.sitemaps.views.sitemap'),

    # Sitemaps individuels
    path('sitemap_index.xml', sitemap,
         {'sitemaps': {'index': XMLIndexSitemap()}},
         name='colis_sitemap_index'),

    path('sitemap_static.xml', sitemap,
         {'sitemaps': {'static': StaticSitemap()}},
         name='colis_sitemap_static'),

    path('sitemap_packages.xml', sitemap,
         {'sitemaps': {'packages': PackageSitemap()}},
         name='colis_sitemap_packages'),

    path('sitemap_categories.xml', sitemap,
         {'sitemaps': {'categories': CategorySitemap()}},
         name='colis_sitemap_categories'),

    path('sitemap_carriers.xml', sitemap,
         {'sitemaps': {'carriers': CarrierSitemap()}},
         name='colis_sitemap_carriers'),

    # Sitemap pour Google News (si applicable)
    path('news-sitemap.xml', NewsSitemapView.as_view(),
         name='colis_news_sitemap'),
]

# ============================================================================
# URLS API (versionnée)
# ============================================================================

api_urlpatterns = [
    # Version 1 de l'API
    path('v1/', include([
        # Colis
        path('packages/', views.PackageListView.as_view(), name='api_package_list'),
        path('packages/<slug:slug>/', views.PackageDetailView.as_view(), name='api_package_detail'),

        # Offres
        path('offers/', views.MyTransportOffersListView.as_view(), name='api_offer_list'),
        path('offers/create/', views.TransportOfferCreateView.as_view(), name='api_offer_create'),

        # Utilisateur
        path('user/packages/', views.MyPackagesListView.as_view(), name='api_user_packages'),
        path('user/favorites/', views.PackageFavoritesListView.as_view(), name='api_user_favorites'),

        # Transporteur
        path('carrier/available-packages/', views.AvailablePackagesView.as_view(), name='api_available_packages'),
        path('carrier/dashboard/', views.CarrierDashboardView.as_view(), name='api_carrier_dashboard'),

        # Recherche
        path('search/', views.search_packages, name='api_search'),

        # Catégories
        path('categories/', views.CategoryListView.as_view(), name='api_category_list'),
        path('categories/<slug:slug>/', views.CategoryDetailView.as_view(), name='api_category_detail'),
    ])),
]

# Ajouter les URLs API au pattern principal
urlpatterns += [
    path('api/', include(api_urlpatterns)),
]

# ============================================================================
# URLS D'ADMINISTRATION (si besoin de personnalisation)
# ============================================================================

admin_urlpatterns = [
    # Statistiques admin
    path('admin-stats/', login_required(TemplateView.as_view(template_name='colis/admin_stats.html')),
         name='admin_stats'),

    # Export de données
    path('export/csv/', login_required(TemplateView.as_view(template_name='colis/export_csv.html')),
         name='export_csv'),

    # Modération
    path('moderation/reports/', login_required(TemplateView.as_view(template_name='colis/moderation_reports.html')),
         name='moderation_reports'),
]

# Ajouter les URLs admin (protégées par login_required)
urlpatterns += [
    path('admin-tools/', include((admin_urlpatterns, 'admin_tools'))),
]

# ============================================================================
# URLS MOBILES (pour applications natives)
# ============================================================================

mobile_urlpatterns = [
    # Authentification mobile
    path('auth/login/', TemplateView.as_view(template_name='colis/mobile/login.html'), name='mobile_login'),
    path('auth/register/', TemplateView.as_view(template_name='colis/mobile/register.html'), name='mobile_register'),

    # Dashboard mobile
    path('dashboard/', TemplateView.as_view(template_name='colis/mobile/dashboard.html'), name='mobile_dashboard'),

    # Scanner QR code
    path('scanner/', TemplateView.as_view(template_name='colis/mobile/scanner.html'), name='mobile_scanner'),

    # Notifications
    path('notifications/', TemplateView.as_view(template_name='colis/mobile/notifications.html'), name='mobile_notifications'),
]

# Ajouter les URLs mobiles
urlpatterns += [
    path('mobile/', include((mobile_urlpatterns, 'mobile'))),
]

# ============================================================================
# URLS DE TEST ET DÉVELOPPEMENT
# ============================================================================

# Ces URLs ne sont actives qu'en mode DEBUG
from django.conf import settings

if settings.DEBUG:
    debug_urlpatterns = [
        # Pages de test
        path('test/package-card/', TemplateView.as_view(template_name='colis/test/package_card.html'),
             name='test_package_card'),
        path('test/offer-card/', TemplateView.as_view(template_name='colis/test/offer_card.html'),
             name='test_offer_card'),
        path('test/search-filters/', TemplateView.as_view(template_name='colis/test/search_filters.html'),
             name='test_search_filters'),

        # Données de test
        path('test-data/generate/', TemplateView.as_view(template_name='colis/test/generate_data.html'),
             name='test_generate_data'),

        # Composants UI
        path('ui/components/', TemplateView.as_view(template_name='colis/test/ui_components.html'),
             name='ui_components'),
    ]

    urlpatterns += [
        path('test/', include((debug_urlpatterns, 'test'))),
    ]

# ============================================================================
# URLS DE WEBHOOKS ET INTÉGRATIONS EXTERNES
# ============================================================================

webhook_urlpatterns = [
    # Webhook Stripe (paiements)
    path('stripe/', TemplateView.as_view(template_name='colis/webhooks/stripe.html'), name='webhook_stripe'),

    # Webhook Google Maps (géocodage)
    path('google-maps/', TemplateView.as_view(template_name='colis/webhooks/google_maps.html'), name='webhook_google_maps'),

    # Webhook SendGrid (emails)
    path('sendgrid/', TemplateView.as_view(template_name='colis/webhooks/sendgrid.html'), name='webhook_sendgrid'),

    # Webhook Twilio (SMS)
    path('twilio/', TemplateView.as_view(template_name='colis/webhooks/twilio.html'), name='webhook_twilio'),
]

urlpatterns += [
    path('webhooks/', include((webhook_urlpatterns, 'webhooks'))),
]

# ============================================================================
# URLS DE GÉOLOCALISATION
# ============================================================================

geolocation_urlpatterns = [
    # Recherche par localisation
    path('near-me/', TemplateView.as_view(template_name='colis/geolocation/near_me.html'), name='near_me'),

    # Calcul d'itinéraire
    path('route/', TemplateView.as_view(template_name='colis/geolocation/route.html'), name='route_calculation'),

    # Carte interactive
    path('map/', TemplateView.as_view(template_name='colis/geolocation/map.html'), name='interactive_map'),
]

urlpatterns += [
    path('location/', include((geolocation_urlpatterns, 'geolocation'))),
]

# ============================================================================
# URLS DE SUIVI ET TRACKING
# ============================================================================

tracking_urlpatterns = [
    # Suivi de colis
    path('<str:tracking_number>/', TemplateView.as_view(template_name='colis/tracking/tracking.html'),
         name='track_package'),

    # Historique de suivi
    path('<str:tracking_number>/history/',
         TemplateView.as_view(template_name='colis/tracking/history.html'), name='tracking_history'),

    # Notifications de suivi
    path('<str:tracking_number>/notifications/',
         TemplateView.as_view(template_name='colis/tracking/notifications.html'), name='tracking_notifications'),
]

urlpatterns += [
    path('track/', include((tracking_urlpatterns, 'tracking'))),
]

# ============================================================================
# URLS DE COMPATIBILITÉ ET REDIRECTIONS
# ============================================================================

# Redirections pour l'ancienne structure d'URLs
from django.views.generic.base import RedirectView

legacy_redirects = [
    # Anciennes URLs vers nouvelles
    path('ads/', RedirectView.as_view(pattern_name='colis:package_list', permanent=True)),
    path('ads/<slug:slug>/', RedirectView.as_view(pattern_name='colis:package_detail', permanent=True)),
    path('demandes/', RedirectView.as_view(pattern_name='colis:package_list', permanent=True)),
    path('demandes/<slug:slug>/', RedirectView.as_view(pattern_name='colis:package_detail', permanent=True)),

    # URLs raccourcies
    path('p/<slug:slug>/', RedirectView.as_view(pattern_name='colis:package_detail', permanent=True)),
    path('c/<slug:slug>/', RedirectView.as_view(pattern_name='colis:package_detail', permanent=True)),
]

urlpatterns += legacy_redirects

# ============================================================================
# FEEDS RSS
# ============================================================================

from django.contrib.syndication.views import Feed
from .models import Package

class LatestPackagesFeed(Feed):
    title = "Derniers colis disponibles sur Ebi3"
    link = "/colis/"
    description = "Nouveaux colis disponibles pour transport"

    def items(self):
        try:
            return Package.objects.filter(status=Package.Status.AVAILABLE).order_by('-created_at')[:20]
        except:
            return []

    def item_title(self, item):
        return item.title

    def item_description(self, item):
        return f"{item.description[:200]}... - {item.pickup_city} → {item.delivery_city}"

    def item_link(self, item):
        return item.get_absolute_url()

urlpatterns += [
    path('feed/rss/', LatestPackagesFeed(), name='package_feed'),
]

# ============================================================================
# ERROR HANDLERS (si besoin de personnalisation)
# ============================================================================

handler404 = 'colis.views.custom_404'
handler500 = 'colis.views.custom_500'

# ============================================================================
# URLS DE MAINTENANCE
# ============================================================================

maintenance_urlpatterns = [
    # Page de maintenance
    path('maintenance/', TemplateView.as_view(template_name='colis/maintenance.html'), name='maintenance'),

    # Status de l'API
    path('status/', TemplateView.as_view(template_name='colis/status.html'), name='api_status'),

    # Health check
    path('health/', TemplateView.as_view(template_name='colis/health.html'), name='health_check'),
]

urlpatterns += [
    path('system/', include((maintenance_urlpatterns, 'system'))),
]

# ============================================================================
# URLS DE DÉMONSTRATION (pour présentation)
# ============================================================================

demo_urlpatterns = [
    # Démo complète
    path('demo/', TemplateView.as_view(template_name='colis/demo/full_demo.html'), name='full_demo'),

    # Démo expéditeur
    path('demo/sender/', TemplateView.as_view(template_name='colis/demo/sender_demo.html'), name='sender_demo'),

    # Démo transporteur
    path('demo/carrier/', TemplateView.as_view(template_name='colis/demo/carrier_demo.html'), name='carrier_demo'),

    # Démo admin
    path('demo/admin/', TemplateView.as_view(template_name='colis/demo/admin_demo.html'), name='admin_demo'),
]

urlpatterns += [
    path('demo/', include((demo_urlpatterns, 'demo'))),
]

# ============================================================================
# URLS DE DOCUMENTATION
# ============================================================================

docs_urlpatterns = [
    # Documentation API
    path('api/', TemplateView.as_view(template_name='colis/docs/api_docs.html'), name='api_docs'),
    path('api/v1/', TemplateView.as_view(template_name='colis/docs/api_v1.html'), name='api_v1_docs'),

    # Documentation développeur
    path('developer/', TemplateView.as_view(template_name='colis/docs/developer.html'), name='developer_docs'),
    path('developer/integration/', TemplateView.as_view(template_name='colis/docs/integration.html'),
         name='integration_docs'),

    # Documentation transporteur
    path('carrier/', TemplateView.as_view(template_name='colis/docs/carrier.html'), name='carrier_docs'),

    # Documentation expéditeur
    path('sender/', TemplateView.as_view(template_name='colis/docs/sender.html'), name='sender_docs'),
]

urlpatterns += [
    path('docs/', include((docs_urlpatterns, 'docs'))),
]-e 

=== Fichier: colis/models.py ===
# ~/ebi3/colis/models.py
from django.db import models
from django.utils.translation import gettext_lazy as _
from django.core.exceptions import ValidationError
from django.utils.text import slugify
from django.urls import reverse
from django.utils import timezone
from django.core.validators import FileExtensionValidator
import os
import uuid
from mptt.models import MPTTModel, TreeForeignKey
from django_countries.fields import CountryField

# Validateurs personnalisés
def validate_file_size(value):
    """Validateur pour la taille maximale des fichiers (10MB)"""
    filesize = value.size
    max_size = 10 * 1024 * 1024  # 10MB
    if filesize > max_size:
        raise ValidationError(
            _(f'La taille du fichier ne doit pas dépasser {max_size / (1024 * 1024):.0f}MB')
        )

class PackageCategory(MPTTModel):
    """Catégories de colis (hiérarchique)"""
    name = models.CharField(
        max_length=200,
        verbose_name=_("Nom de la catégorie"),
        db_index=True
    )
    slug = models.SlugField(
        max_length=200,
        unique=True,
        verbose_name=_("Slug"),
        help_text=_("Version URL-friendly du nom")
    )
    description = models.TextField(
        blank=True,
        verbose_name=_("Description"),
        help_text=_("Description détaillée de la catégorie")
    )
    parent = TreeForeignKey(
        'self',
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='children',
        verbose_name=_("Catégorie parente"),
        help_text=_("Sélectionnez une catégorie parente si applicable")
    )
    icon = models.CharField(
        max_length=100,
        blank=True,
        verbose_name=_("Icône FontAwesome"),
        help_text=_("Exemple: fa-box, fa-couch, fa-tshirt")
    )
    image = models.ImageField(
        upload_to='colis/categories/',
        null=True,
        blank=True,
        verbose_name=_("Image de la catégorie")
    )
    is_active = models.BooleanField(
        default=True,
        verbose_name=_("Active"),
        help_text=_("Désactiver pour cacher la catégorie")
    )
    show_in_menu = models.BooleanField(
        default=True,
        verbose_name=_("Afficher dans le menu")
    )
    display_order = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Ordre d'affichage"),
        help_text=_("Plus le nombre est bas, plus c'est prioritaire")
    )
    requires_dimensions = models.BooleanField(
        default=True,
        verbose_name=_("Requiert dimensions"),
        help_text=_("Les colis de cette catégorie doivent avoir des dimensions")
    )
    requires_weight = models.BooleanField(
        default=True,
        verbose_name=_("Requiert poids"),
        help_text=_("Les colis de cette catégorie doivent avoir un poids")
    )
    meta_title = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Titre SEO")
    )
    meta_description = models.TextField(
        blank=True,
        verbose_name=_("Description SEO")
    )
    package_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre de colis")
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class MPTTMeta:
        order_insertion_by = ['display_order', 'name']

    class Meta:
        verbose_name = _("Catégorie de colis")
        verbose_name_plural = _("Catégories de colis")
        ordering = ['display_order', 'name']
        indexes = [
            models.Index(fields=['slug', 'is_active']),
            models.Index(fields=['parent', 'is_active']),
        ]

    def __str__(self):
        return self.name

    def get_absolute_url(self):
        return reverse('colis:category_detail', kwargs={'slug': self.slug})

    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(self.name)
        super().save(*args, **kwargs)

    def get_full_path(self):
        ancestors = self.get_ancestors(include_self=True)
        return " > ".join([cat.name for cat in ancestors])

    def update_package_count(self):
        """Met à jour le compteur de colis"""
        count = self.packages.filter(status=Package.Status.AVAILABLE).count()
        PackageCategory.objects.filter(pk=self.pk).update(package_count=count)


class Package(models.Model):
    """Modèle principal pour un colis (équivalent Cocolis)"""

    class Status(models.TextChoices):
        DRAFT = 'DRAFT', _('Brouillon')
        AVAILABLE = 'AVAILABLE', _('Disponible')
        RESERVED = 'RESERVED', _('Réservé')
        IN_TRANSIT = 'IN_TRANSIT', _('En transit')
        DELIVERED = 'DELIVERED', _('Livré')
        CANCELLED = 'CANCELLED', _('Annulé')
        EXPIRED = 'EXPIRED', _('Expiré')

    class PackageType(models.TextChoices):
        SMALL_PACKAGE = 'SMALL_PACKAGE', _('Petit colis (< 30kg)')
        MEDIUM_PACKAGE = 'MEDIUM_PACKAGE', _('Colis moyen (30-100kg)')
        LARGE_PACKAGE = 'LARGE_PACKAGE', _('Gros colis (100-500kg)')
        FURNITURE = 'FURNITURE', _('Meuble')
        PALLET = 'PALLET', _('Palette')
        VEHICLE_PART = 'VEHICLE_PART', _('Pièce auto')
        OTHER = 'OTHER', _('Autre')

    class PriceType(models.TextChoices):
        FIXED = 'FIXED', _('Prix fixe')
        NEGOTIABLE = 'NEGOTIABLE', _('Prix négociable')
        AUCTION = 'AUCTION', _('Mise aux enchères')

    # Informations de base
    sender = models.ForeignKey(
        'users.User',
        on_delete=models.CASCADE,
        related_name='sent_packages',
        verbose_name=_("Expéditeur")
    )
    category = TreeForeignKey(
        PackageCategory,
        on_delete=models.SET_NULL,
        null=True,
        related_name='packages',
        verbose_name=_("Catégorie")
    )
    title = models.CharField(
        max_length=200,
        verbose_name=_("Titre du colis"),
        db_index=True
    )
    slug = models.SlugField(
        max_length=200,
        unique=True,
        db_index=True,
        verbose_name=_("Slug")
    )
    description = models.TextField(
        verbose_name=_("Description détaillée"),
        help_text=_("Décrivez votre colis en détail")
    )
    package_type = models.CharField(
        max_length=20,
        choices=PackageType.choices,
        verbose_name=_("Type de colis")
    )

    # Dimensions et poids
    weight = models.DecimalField(
        max_digits=8,
        decimal_places=3,
        verbose_name=_("Poids (kg)"),
        help_text=_("Poids en kilogrammes")
    )
    length = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        verbose_name=_("Longueur (cm)")
    )
    width = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        verbose_name=_("Largeur (cm)")
    )
    height = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        verbose_name=_("Hauteur (cm)")
    )
    volume = models.DecimalField(
        max_digits=10,
        decimal_places=3,
        null=True,
        blank=True,
        editable=False,
        verbose_name=_("Volume (L)")
    )

    # Origine et destination
    pickup_country = CountryField(
        verbose_name=_("Pays de départ"),
        help_text=_("Pays où se trouve le colis")
    )
    pickup_city = models.CharField(
        max_length=100,
        verbose_name=_("Ville de départ")
    )
    pickup_address = models.TextField(
        blank=True,
        verbose_name=_("Adresse de départ")
    )
    pickup_postal_code = models.CharField(
        max_length=20,
        blank=True,
        verbose_name=_("Code postal départ")
    )
    pickup_latitude = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Latitude départ")
    )
    pickup_longitude = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Longitude départ")
    )

    delivery_country = CountryField(
        verbose_name=_("Pays de destination"),
        help_text=_("Pays où le colis doit être livré")
    )
    delivery_city = models.CharField(
        max_length=100,
        verbose_name=_("Ville de destination")
    )
    delivery_address = models.TextField(
        blank=True,
        verbose_name=_("Adresse de destination")
    )
    delivery_postal_code = models.CharField(
        max_length=20,
        blank=True,
        verbose_name=_("Code postal destination")
    )
    delivery_latitude = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Latitude destination")
    )
    delivery_longitude = models.DecimalField(
        max_digits=9,
        decimal_places=6,
        null=True,
        blank=True,
        verbose_name=_("Longitude destination")
    )

    # Dates
    pickup_date = models.DateField(
        verbose_name=_("Date de départ souhaitée"),
        help_text=_("Date à laquelle le colis est disponible")
    )
    delivery_date = models.DateField(
        verbose_name=_("Date de livraison souhaitée"),
        help_text=_("Date limite de livraison")
    )
    flexible_dates = models.BooleanField(
        default=False,
        verbose_name=_("Dates flexibles"),
        help_text=_("Accepte des dates différentes de celles demandées")
    )

    # Prix
    price_type = models.CharField(
        max_length=20,
        choices=PriceType.choices,
        default=PriceType.NEGOTIABLE,
        verbose_name=_("Type de prix")
    )
    asking_price = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_("Prix demandé"),
        help_text=_("Prix en devise de départ")
    )
    currency = models.CharField(
        max_length=3,
        default='EUR',
        choices=[
            ('EUR', '€'),
            ('USD', '$'),
            ('GBP', '£'),
            ('MAD', 'DH'),
            ('XOF', 'CFA'),
        ],
        verbose_name=_("Devise")
    )
    estimated_distance = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        null=True,
        blank=True,
        verbose_name=_("Distance estimée (km)")
    )

    # Options et caractéristiques
    is_fragile = models.BooleanField(
        default=False,
        verbose_name=_("Fragile")
    )
    requires_insurance = models.BooleanField(
        default=False,
        verbose_name=_("Requiert assurance")
    )
    insurance_value = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        null=True,
        blank=True,
        verbose_name=_("Valeur à assurer")
    )
    requires_packaging = models.BooleanField(
        default=False,
        verbose_name=_("Requiert emballage")
    )
    requires_loading_help = models.BooleanField(
        default=False,
        verbose_name=_("Requiert aide au chargement")
    )
    requires_unloading_help = models.BooleanField(
        default=False,
        verbose_name=_("Requiert aide au déchargement")
    )

    # Statut et métadonnées
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.DRAFT,
        verbose_name=_("Statut"),
        db_index=True
    )
    is_featured = models.BooleanField(
        default=False,
        verbose_name=_("Colis en vedette")
    )
    featured_until = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("En vedette jusqu'au")
    )

    # SEO
    meta_keywords = models.CharField(
        max_length=500,
        blank=True,
        verbose_name=_("Mots-clés SEO")
    )
    meta_description = models.TextField(
        blank=True,
        verbose_name=_("Description SEO")
    )

    # Statistiques
    view_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre de vues")
    )
    offer_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre d'offres")
    )
    favorite_count = models.PositiveIntegerField(
        default=0,
        editable=False,
        verbose_name=_("Nombre de favoris")
    )

    # Limites de publication
    free_images_allowed = models.PositiveIntegerField(
        default=5,
        verbose_name=_("Nombre de photos gratuites")
    )
    paid_images_used = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Photos payantes utilisées")
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True, db_index=True)
    updated_at = models.DateTimeField(auto_now=True, db_index=True)
    published_at = models.DateTimeField(null=True, blank=True)
    expired_at = models.DateTimeField(null=True, blank=True)
    reserved_at = models.DateTimeField(null=True, blank=True)
    delivered_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        verbose_name = _("Colis")
        verbose_name_plural = _("Colis")
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status', 'created_at']),
            models.Index(fields=['sender', 'status']),
            models.Index(fields=['pickup_country', 'delivery_country']),
            models.Index(fields=['pickup_date', 'delivery_date']),
            models.Index(fields=['package_type', 'status']),
            models.Index(fields=['asking_price', 'status']),
        ]
        permissions = [
            ('can_feature_package', 'Peut mettre en vedette un colis'),
            ('can_moderate_package', 'Peut modérer les colis'),
        ]

    def __str__(self):
        return f"{self.title} - {self.sender.username}"

    def save(self, *args, **kwargs):
        # Génération automatique du slug
        if not self.slug:
            base_slug = slugify(self.title)
            self.slug = base_slug
            counter = 1
            while Package.objects.filter(slug=self.slug).exists():
                self.slug = f"{base_slug}-{counter}"
                counter += 1

        # Calcul automatique du volume
        if self.length and self.width and self.height:
            self.volume = (self.length * self.width * self.height) / 1000

        # Mise à jour des dates de statut
        if self.status == self.Status.AVAILABLE and not self.published_at:
            self.published_at = timezone.now()

        if self.status == self.Status.RESERVED and not self.reserved_at:
            self.reserved_at = timezone.now()

        if self.status == self.Status.DELIVERED and not self.delivered_at:
            self.delivered_at = timezone.now()

        # Vérification d'expiration
        if self.delivery_date and self.delivery_date < timezone.now().date():
            if self.status == self.Status.AVAILABLE:
                self.status = self.Status.EXPIRED
                self.expired_at = timezone.now()

        super().save(*args, **kwargs)

        # Mise à jour du compteur de catégorie
        if self.category:
            self.category.update_package_count()

    def get_absolute_url(self):
        return reverse('colis:package_detail', kwargs={'slug': self.slug})

    def get_price_with_currency(self):
        return f"{self.asking_price} {self.get_currency_display()}"

    def calculate_free_images_remaining(self):
        return max(0, self.free_images_allowed - self.images.filter(is_paid=False).count())

    def is_available_for_offers(self):
        return self.status == self.Status.AVAILABLE

    def can_be_reserved(self, user):
        """Vérifie si un utilisateur peut réserver ce colis"""
        if user == self.sender:
            return False
        if self.status != self.Status.AVAILABLE:
            return False
        return True

    def get_estimated_price_range(self):
        """Retourne une fourchette de prix estimée basée sur la distance et le volume"""
        # Logique simplifiée - à améliorer avec des algorithmes réels
        if self.estimated_distance and self.volume:
            base_price_per_km = 0.5  # € par km
            base_price_per_volume = 10  # € par m³

            estimated_price = (
                self.estimated_distance * base_price_per_km +
                float(self.volume) / 1000 * base_price_per_volume
            )

            return {
                'min': round(estimated_price * 0.8, 2),
                'max': round(estimated_price * 1.2, 2),
                'average': round(estimated_price, 2)
            }
        return None

    def get_distance_display(self):
        """Affiche la distance de manière lisible"""
        if self.estimated_distance:
            if self.estimated_distance < 1:
                return f"{self.estimated_distance * 1000:.0f} m"
            return f"{self.estimated_distance:.1f} km"
        return _("Distance non calculée")


def package_image_upload_path(instance, filename):
    """Chemin de sauvegarde pour les images de colis"""
    ext = filename.split('.')[-1]
    filename = f"{uuid.uuid4()}.{ext}"
    return f"colis/{instance.package.sender.username}/{instance.package.slug}/images/{filename}"


class PackageImage(models.Model):
    """Images associées à un colis"""
    package = models.ForeignKey(
        Package,
        on_delete=models.CASCADE,
        related_name='images',
        verbose_name=_("Colis")
    )
    image = models.ImageField(
        upload_to=package_image_upload_path,
        verbose_name=_("Image"),
        validators=[
            FileExtensionValidator(['jpg', 'jpeg', 'png', 'webp']),
            validate_file_size,
        ]
    )
    thumbnail = models.ImageField(
        upload_to='colis/thumbnails/',
        null=True,
        blank=True,
        editable=False,
        verbose_name=_("Miniature")
    )
    caption = models.CharField(
        max_length=200,
        blank=True,
        verbose_name=_("Légende")
    )
    is_primary = models.BooleanField(
        default=False,
        verbose_name=_("Image principale")
    )
    display_order = models.PositiveIntegerField(
        default=0,
        verbose_name=_("Ordre d'affichage")
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Image de colis")
        verbose_name_plural = _("Images de colis")
        ordering = ['is_primary', 'display_order', 'created_at']
        constraints = [
            models.UniqueConstraint(
                fields=['package'],
                condition=models.Q(is_primary=True),
                name='unique_primary_image_per_package'
            )
        ]

    def __str__(self):
        return f"Image pour {self.package.title}"

    def save(self, *args, **kwargs):
        if not self.package.images.exists() and not self.is_primary:
            self.is_primary = True
        if self.is_primary:
            PackageImage.objects.filter(package=self.package, is_primary=True).exclude(pk=self.pk).update(is_primary=False)
        super().save(*args, **kwargs)


class TransportOffer(models.Model):
    """Offre de transport pour un colis (comme Cocolis)"""

    class Status(models.TextChoices):
        PENDING = 'PENDING', _('En attente')
        ACCEPTED = 'ACCEPTED', _('Acceptée')
        REJECTED = 'REJECTED', _('Rejetée')
        CANCELLED = 'CANCELLED', _('Annulée')
        EXPIRED = 'EXPIRED', _('Expirée')

    package = models.ForeignKey(
        Package,
        on_delete=models.CASCADE,
        related_name='transport_offers',
        verbose_name=_("Colis")
    )
    carrier = models.ForeignKey(
        'carriers.Carrier',
        on_delete=models.CASCADE,
        related_name='transport_offers',
        verbose_name=_("Transporteur")
    )
    price = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        verbose_name=_("Prix proposé")
    )
    currency = models.CharField(
        max_length=3,
        default='EUR',
        choices=[
            ('EUR', '€'),
            ('USD', '$'),
            ('GBP', '£'),
            ('MAD', 'DH'),
            ('XOF', 'CFA'),
        ],
        verbose_name=_("Devise")
    )
    proposed_pickup_date = models.DateField(
        verbose_name=_("Date de départ proposée")
    )
    proposed_delivery_date = models.DateField(
        verbose_name=_("Date de livraison proposée")
    )
    message = models.TextField(
        blank=True,
        verbose_name=_("Message au vendeur"),
        help_text=_("Expliquez pourquoi vous êtes le bon transporteur")
    )
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.PENDING,
        verbose_name=_("Statut")
    )

    # Informations supplémentaires
    provides_insurance = models.BooleanField(
        default=False,
        verbose_name=_("Fournit assurance")
    )
    insurance_coverage = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        null=True,
        blank=True,
        verbose_name=_("Couverture d'assurance")
    )
    provides_packaging = models.BooleanField(
        default=False,
        verbose_name=_("Fournit emballage")
    )
    provides_loading = models.BooleanField(
        default=False,
        verbose_name=_("Fournit chargement")
    )
    provides_unloading = models.BooleanField(
        default=False,
        verbose_name=_("Fournit déchargement")
    )

    # Suivi
    rejection_reason = models.TextField(
        blank=True,
        verbose_name=_("Raison du refus")
    )
    accepted_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Accepté le")
    )
    expires_at = models.DateTimeField(
        verbose_name=_("Expire le"),
        help_text=_("Date d'expiration de l'offre")
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = _("Offre de transport")
        verbose_name_plural = _("Offres de transport")
        ordering = ['-created_at']
        unique_together = ['package', 'carrier']
        indexes = [
            models.Index(fields=['package', 'status']),
            models.Index(fields=['carrier', 'status']),
            models.Index(fields=['status', 'expires_at']),
        ]

    def __str__(self):
        return f"Offre #{self.id} pour {self.package.title}"

    def save(self, *args, **kwargs):
        # Définir la date d'expiration par défaut (72h)
        if not self.expires_at:
            self.expires_at = timezone.now() + timezone.timedelta(hours=72)

        # Mettre à jour le compteur d'offres du colis
        if not self.pk:  # Nouvelle offre
            super().save(*args, **kwargs)
            self.package.offer_count = self.package.transport_offers.count()
            self.package.save(update_fields=['offer_count'])
        else:
            super().save(*args, **kwargs)

        # Si l'offre est acceptée, marquer le colis comme réservé
        if self.status == self.Status.ACCEPTED and not self.accepted_at:
            self.accepted_at = timezone.now()
            self.package.status = Package.Status.RESERVED
            self.package.reserved_at = timezone.now()
            self.package.save(update_fields=['status', 'reserved_at'])

            # Rejeter automatiquement les autres offres en attente
            TransportOffer.objects.filter(
                package=self.package,
                status=self.Status.PENDING
            ).exclude(pk=self.pk).update(
                status=self.Status.REJECTED,
                rejection_reason=_("Une autre offre a été acceptée")
            )

    def is_expired(self):
        """Vérifie si l'offre a expiré"""
        return timezone.now() > self.expires_at

    def can_be_accepted(self):
        """Vérifie si l'offre peut être acceptée"""
        return (
            self.status == self.Status.PENDING and
            not self.is_expired() and
            self.package.status == Package.Status.AVAILABLE
        )


class PackageView(models.Model):
    """Suivi des vues de colis pour les statistiques"""
    package = models.ForeignKey(
        Package,
        on_delete=models.CASCADE,
        related_name='views_tracking',
        verbose_name=_("Colis")
    )
    user = models.ForeignKey(
        'users.User',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='package_views',
        verbose_name=_("Utilisateur")
    )
    session_key = models.CharField(
        max_length=40,
        db_index=True,
        verbose_name=_("Clé de session")
    )
    ip_address = models.GenericIPAddressField(
        null=True,
        blank=True,
        verbose_name=_("Adresse IP")
    )
    user_agent = models.TextField(
        blank=True,
        verbose_name=_("User Agent")
    )
    referer = models.URLField(
        blank=True,
        verbose_name=_("Referer")
    )
    viewed_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Vue de colis")
        verbose_name_plural = _("Vues de colis")
        indexes = [
            models.Index(fields=['package', 'viewed_at']),
            models.Index(fields=['session_key', 'package']),
            models.Index(fields=['user', 'viewed_at']),
        ]

    def __str__(self):
        return f"Vue de {self.package.title} à {self.viewed_at}"


class PackageFavorite(models.Model):
    """Favoris des colis"""
    user = models.ForeignKey(
        'users.User',
        on_delete=models.CASCADE,
        related_name='package_favorites',
        verbose_name=_("Utilisateur")
    )
    package = models.ForeignKey(
        Package,
        on_delete=models.CASCADE,
        related_name='favorited_by',
        verbose_name=_("Colis")
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Colis favori")
        verbose_name_plural = _("Colis favoris")
        unique_together = ['user', 'package']
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.user.username} aime {self.package.title}"

    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)
        self.package.favorite_count = self.package.favorited_by.count()
        self.package.save(update_fields=['favorite_count'])

    def delete(self, *args, **kwargs):
        package = self.package
        super().delete(*args, **kwargs)
        package.favorite_count = package.favorited_by.count()
        package.save(update_fields=['favorite_count'])


class PackageReport(models.Model):
    """Signalement de colis inappropriés"""

    class ReportReason(models.TextChoices):
        SPAM = 'SPAM', _('Spam ou publicité')
        FRAUD = 'FRAUD', _('Fraude ou arnaque')
        INAPPROPRIATE = 'INAPPROPRIATE', _('Contenu inapproprié')
        WRONG_CATEGORY = 'WRONG_CATEGORY', _('Mauvaise catégorie')
        PROHIBITED = 'PROHIBITED', _('Article prohibé')
        DUPLICATE = 'DUPLICATE', _('Colis en double')
        OTHER = 'OTHER', _('Autre')

    package = models.ForeignKey(
        Package,
        on_delete=models.CASCADE,
        related_name='reports',
        verbose_name=_("Colis")
    )
    reporter = models.ForeignKey(
        'users.User',
        on_delete=models.SET_NULL,
        null=True,
        related_name='package_reports',
        verbose_name=_("Signaleur")
    )
    reason = models.CharField(
        max_length=20,
        choices=ReportReason.choices,
        verbose_name=_("Raison du signalement")
    )
    description = models.TextField(
        blank=True,
        verbose_name=_("Description détaillée")
    )
    evidence = models.FileField(
        upload_to='colis/reports/',
        null=True,
        blank=True,
        verbose_name=_("Preuve")
    )
    status = models.CharField(
        max_length=20,
        choices=[
            ('PENDING', _('En attente')),
            ('IN_REVIEW', _('En revue')),
            ('RESOLVED', _('Résolu')),
            ('DISMISSED', _('Rejeté')),
        ],
        default='PENDING',
        verbose_name=_("Statut")
    )
    admin_notes = models.TextField(
        blank=True,
        verbose_name=_("Notes de l'administrateur")
    )
    resolved_by = models.ForeignKey(
        'users.User',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='resolved_package_reports',
        verbose_name=_("Résolu par")
    )
    resolved_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name=_("Résolu le")
    )
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _("Signalement de colis")
        verbose_name_plural = _("Signalements de colis")
        ordering = ['-created_at']

    def __str__(self):
        return f"Signalement de {self.package.title}"-e 

=== Fichier: colis/views.py ===
# ~/ebi3/colis/views.py
from django.shortcuts import render, get_object_or_404, redirect
from django.db.models import Q, Count, Avg, Sum, F, ExpressionWrapper, DecimalField
from django.contrib.auth.decorators import login_required
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.views.generic import (
    ListView, DetailView, CreateView,
    UpdateView, DeleteView, TemplateView, FormView
)
from django.utils import timezone
from django.urls import reverse_lazy, reverse
from django.contrib import messages
from django.utils.translation import gettext_lazy as _
from django.core.paginator import Paginator
from django.http import JsonResponse, HttpResponseForbidden, HttpResponseRedirect
from django.views.decorators.http import require_POST, require_GET
from django.views.decorators.csrf import csrf_protect
from django.db import transaction
from django.db.models.functions import Coalesce
from django.core.exceptions import PermissionDenied
from django.contrib.auth import get_user_model

from .models import (
    Package, PackageCategory, PackageImage,
    TransportOffer, PackageView, PackageFavorite, PackageReport
)
from .forms import (
    PackageCreateForm, PackageUpdateForm, PackageImageFormSet,
    TransportOfferForm, PackageSearchForm, PackageReportForm,
    QuickQuoteForm, PackageFilterForm
)
from users.models import User
from carriers.models import Carrier, CarrierReview
from messaging.models import Conversation, Message
from datetime import datetime, timedelta
from django.views.generic import TemplateView
from django.utils import timezone
from .models import Package
from django.http import HttpResponse

User = get_user_model()


# ============================================================================
# VUES PUBLIQUES
# ============================================================================

class CategoryListView(ListView):
    """Liste des catégories de colis"""
    model = PackageCategory
    template_name = 'colis/category_list.html'
    context_object_name = 'categories'

    def get_queryset(self):
        return PackageCategory.objects.filter(
            is_active=True,
            show_in_menu=True
        ).annotate(
            available_packages_count=Count('packages', filter=Q(packages__status=Package.Status.AVAILABLE))
        ).filter(
            available_packages_count__gt=0
        )


class CategoryDetailView(DetailView):
    """Détail d'une catégorie avec ses colis"""
    model = PackageCategory
    template_name = 'colis/category_detail.html'
    context_object_name = 'category'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        category = self.object

        # Récupérer toutes les sous-catégories
        subcategories = category.get_descendants(include_self=False).filter(
            is_active=True
        )

        # Récupérer les colis actifs de cette catégorie et ses sous-catégories
        packages = Package.objects.filter(
            category__in=subcategories.union(PackageCategory.objects.filter(pk=category.pk)),
            status=Package.Status.AVAILABLE
        ).select_related('sender').prefetch_related('images')

        # Appliquer les filtres
        form = PackageSearchForm(self.request.GET)
        if form.is_valid():
            packages = self.apply_search_filters(packages, form.cleaned_data)

        # Pagination
        paginator = Paginator(packages, 20)
        page = self.request.GET.get('page')
        packages_page = paginator.get_page(page)

        context.update({
            'subcategories': subcategories,
            'packages': packages_page,
            'search_form': form,
            'total_packages': packages.count(),
        })
        return context

    def apply_search_filters(self, queryset, cleaned_data):
        """Applique les filtres de recherche"""
        if cleaned_data.get('q'):
            search_term = cleaned_data['q']
            queryset = queryset.filter(
                Q(title__icontains=search_term) |
                Q(description__icontains=search_term)
            )

        if cleaned_data.get('package_type'):
            queryset = queryset.filter(package_type=cleaned_data['package_type'])

        if cleaned_data.get('pickup_country'):
            queryset = queryset.filter(pickup_country=cleaned_data['pickup_country'])

        if cleaned_data.get('delivery_country'):
            queryset = queryset.filter(delivery_country=cleaned_data['delivery_country'])

        if cleaned_data.get('pickup_city'):
            queryset = queryset.filter(pickup_city__icontains=cleaned_data['pickup_city'])

        if cleaned_data.get('delivery_city'):
            queryset = queryset.filter(delivery_city__icontains=cleaned_data['delivery_city'])

        if cleaned_data.get('pickup_date_from'):
            queryset = queryset.filter(pickup_date__gte=cleaned_data['pickup_date_from'])

        if cleaned_data.get('pickup_date_to'):
            queryset = queryset.filter(pickup_date__lte=cleaned_data['pickup_date_to'])

        if cleaned_data.get('max_weight'):
            queryset = queryset.filter(weight__lte=cleaned_data['max_weight'])

        if cleaned_data.get('max_volume'):
            queryset = queryset.filter(volume__lte=cleaned_data['max_volume'])

        if cleaned_data.get('min_price'):
            queryset = queryset.filter(asking_price__gte=cleaned_data['min_price'])

        if cleaned_data.get('max_price'):
            queryset = queryset.filter(asking_price__lte=cleaned_data['max_price'])

        if cleaned_data.get('flexible_dates'):
            queryset = queryset.filter(flexible_dates=True)

        # Tri
        sort_by = cleaned_data.get('sort_by', '-created_at')
        if sort_by in ['pickup_date', '-pickup_date', 'asking_price', '-asking_price', '-created_at', '-view_count']:
            queryset = queryset.order_by(sort_by)

        return queryset


class PackageListView(ListView):
    """Liste de tous les colis disponibles"""
    model = Package
    template_name = 'colis/package_list.html'
    context_object_name = 'packages'
    paginate_by = 20

    def get_queryset(self):
        queryset = Package.objects.filter(
            status=Package.Status.AVAILABLE
        ).select_related('sender', 'category').prefetch_related('images')

        # Appliquer les filtres
        form = PackageSearchForm(self.request.GET)
        if form.is_valid():
            queryset = self.apply_search_filters(queryset, form.cleaned_data)

        return queryset

    def apply_search_filters(self, queryset, cleaned_data):
        """Applique les filtres de recherche"""
        if cleaned_data.get('q'):
            search_term = cleaned_data['q']
            queryset = queryset.filter(
                Q(title__icontains=search_term) |
                Q(description__icontains=search_term)
            )

        if cleaned_data.get('category'):
            category = cleaned_data['category']
            # Inclure les sous-catégories
            subcategories = category.get_descendants(include_self=True)
            queryset = queryset.filter(category__in=subcategories)

        if cleaned_data.get('package_type'):
            queryset = queryset.filter(package_type=cleaned_data['package_type'])

        if cleaned_data.get('pickup_country'):
            queryset = queryset.filter(pickup_country=cleaned_data['pickup_country'])

        if cleaned_data.get('delivery_country'):
            queryset = queryset.filter(delivery_country=cleaned_data['delivery_country'])

        if cleaned_data.get('pickup_city'):
            queryset = queryset.filter(pickup_city__icontains=cleaned_data['pickup_city'])

        if cleaned_data.get('delivery_city'):
            queryset = queryset.filter(delivery_city__icontains=cleaned_data['delivery_city'])

        if cleaned_data.get('pickup_date_from'):
            queryset = queryset.filter(pickup_date__gte=cleaned_data['pickup_date_from'])

        if cleaned_data.get('pickup_date_to'):
            queryset = queryset.filter(pickup_date__lte=cleaned_data['pickup_date_to'])

        if cleaned_data.get('max_weight'):
            queryset = queryset.filter(weight__lte=cleaned_data['max_weight'])

        if cleaned_data.get('max_volume'):
            queryset = queryset.filter(volume__lte=cleaned_data['max_volume'])

        if cleaned_data.get('min_price'):
            queryset = queryset.filter(asking_price__gte=cleaned_data['min_price'])

        if cleaned_data.get('max_price'):
            queryset = queryset.filter(asking_price__lte=cleaned_data['max_price'])

        if cleaned_data.get('flexible_dates'):
            queryset = queryset.filter(flexible_dates=True)

        # Tri
        sort_by = cleaned_data.get('sort_by', '-created_at')
        if sort_by in ['pickup_date', '-pickup_date', 'asking_price', '-asking_price', '-created_at', '-view_count']:
            queryset = queryset.order_by(sort_by)

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['search_form'] = PackageSearchForm(self.request.GET)
        context['total_packages'] = self.get_queryset().count()

        # Catégories populaires
        context['categories'] = PackageCategory.objects.filter(
            is_active=True
        ).annotate(
            package_count=Count('packages', filter=Q(packages__status=Package.Status.AVAILABLE))
        ).order_by('-package_count', 'name')[:10]

        # Stats pour les filtres
        from django.db.models import Min, Max
        context['min_price_range'] = Package.objects.filter(status=Package.Status.AVAILABLE).aggregate(
            Min('asking_price'))['asking_price__min'] or 0
        context['max_price_range'] = Package.objects.filter(status=Package.Status.AVAILABLE).aggregate(
            Max('asking_price'))['asking_price__max'] or 10000

        return context


class PackageDetailView(DetailView):
    """Détail d'un colis"""
    model = Package
    template_name = 'colis/package_detail.html'
    context_object_name = 'package'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        package = self.object

        # Enregistrer la vue
        self.record_package_view(package)

        # Offres de transport (si l'utilisateur est le propriétaire ou un transporteur)
        if self.request.user.is_authenticated:
            if self.request.user == package.sender:
                # Propriétaire : voir toutes les offres
                offers = package.transport_offers.all().select_related('carrier', 'carrier__user')
                context['transport_offers'] = offers
                context['has_pending_offers'] = offers.filter(status=TransportOffer.Status.PENDING).exists()
            elif hasattr(self.request.user, 'carrier_profile'):
                # Transporteur : voir si il a déjà fait une offre
                user_offer = package.transport_offers.filter(
                    carrier=self.request.user.carrier_profile
                ).first()
                context['user_offer'] = user_offer

        # Colis similaires
        similar_packages = Package.objects.filter(
            category=package.category,
            status=Package.Status.AVAILABLE
        ).exclude(pk=package.pk).select_related('sender').prefetch_related('images')[:4]

        # Vérifier si le colis est dans les favoris de l'utilisateur
        is_favorite = False
        if self.request.user.is_authenticated:
            is_favorite = PackageFavorite.objects.filter(
                user=self.request.user,
                package=package
            ).exists()

        # Vérifier les permissions
        context.update({
            'similar_packages': similar_packages,
            'is_favorite': is_favorite,
            'can_edit': self.request.user == package.sender or self.request.user.is_staff,
            'can_report': self.request.user.is_authenticated and self.request.user != package.sender,
            'can_make_offer': self.can_make_offer(package),
            'transport_offer_form': TransportOfferForm() if self.can_make_offer(package) else None,
        })

        return context

    def record_package_view(self, package):
        """Enregistre une vue pour le colis"""
        if self.request.user.is_authenticated:
            PackageView.objects.create(
                package=package,
                user=self.request.user,
                session_key=self.request.session.session_key,
                ip_address=self.request.META.get('REMOTE_ADDR'),
                user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
                referer=self.request.META.get('HTTP_REFERER', '')
            )
        else:
            PackageView.objects.create(
                package=package,
                session_key=self.request.session.session_key,
                ip_address=self.request.META.get('REMOTE_ADDR'),
                user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
                referer=self.request.META.get('HTTP_REFERER', '')
            )

        # Mettre à jour le compteur de vues
        package.view_count = PackageView.objects.filter(package=package).count()
        package.save(update_fields=['view_count'])

    def can_make_offer(self, package):
        """Vérifie si l'utilisateur peut faire une offre"""
        if not self.request.user.is_authenticated:
            return False

        # L'expéditeur ne peut pas faire d'offre sur son propre colis
        if self.request.user == package.sender:
            return False

        # Vérifier si l'utilisateur est un transporteur approuvé
        try:
            carrier_profile = self.request.user.carrier_profile
            if carrier_profile.status != Carrier.Status.APPROVED:
                return False
            if not carrier_profile.is_available:
                return False
        except Carrier.DoesNotExist:
            return False

        # Vérifier si le colis est disponible
        if package.status != Package.Status.AVAILABLE:
            return False

        # Vérifier si une offre existe déjà
        if package.transport_offers.filter(carrier=carrier_profile).exists():
            return False

        return True


# ============================================================================
# VUES UTILISATEUR AUTHENTIFIÉ
# ============================================================================

class PackageCreateView(LoginRequiredMixin, CreateView):
    """Création d'un colis"""
    model = Package
    form_class = PackageCreateForm
    template_name = 'colis/package_create.html'

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['user'] = self.request.user
        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        if self.request.POST:
            context['image_formset'] = PackageImageFormSet(self.request.POST, self.request.FILES)
        else:
            context['image_formset'] = PackageImageFormSet()
        return context

    def form_valid(self, form):
        context = self.get_context_data()
        image_formset = context['image_formset']

        with transaction.atomic():
            form.instance.sender = self.request.user
            form.instance.status = Package.Status.AVAILABLE
            self.object = form.save()

            if image_formset.is_valid():
                images = image_formset.save(commit=False)
                for image in images:
                    image.package = self.object
                    image.save()

                # Vérifier le nombre d'images
                free_images_count = len([img for img in images if not img.is_paid])
                if free_images_count > self.object.free_images_allowed:
                    messages.warning(
                        self.request,
                        _(f"Vous avez téléchargé {free_images_count} images gratuites, "
                          f"mais seulement {self.object.free_images_allowed} sont autorisées gratuitement.")
                    )
            else:
                return self.form_invalid(form)

        messages.success(self.request, _("Votre colis a été publié avec succès !"))
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('colis:package_detail', kwargs={'slug': self.object.slug})


class PackageUpdateView(LoginRequiredMixin, UpdateView):
    """Modification d'un colis"""
    model = Package
    form_class = PackageUpdateForm
    template_name = 'colis/package_edit.html'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'

    def dispatch(self, request, *args, **kwargs):
        package = self.get_object()

        # Vérifier les permissions
        if package.sender != request.user and not request.user.is_staff:
            messages.error(request, _("Vous n'êtes pas autorisé à modifier ce colis."))
            return redirect('colis:package_detail', slug=package.slug)

        # Empêcher la modification si le colis est réservé ou en transit
        if package.status in [Package.Status.RESERVED, Package.Status.IN_TRANSIT]:
            messages.error(request, _("Ce colis ne peut pas être modifié car il est réservé ou en transit."))
            return redirect('colis:package_detail', slug=package.slug)

        return super().dispatch(request, *args, **kwargs)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        if self.request.POST:
            context['image_formset'] = PackageImageFormSet(
                self.request.POST, self.request.FILES,
                instance=self.object
            )
        else:
            context['image_formset'] = PackageImageFormSet(instance=self.object)
        return context

    def form_valid(self, form):
        context = self.get_context_data()
        image_formset = context['image_formset']

        with transaction.atomic():
            self.object = form.save()

            if image_formset.is_valid():
                images = image_formset.save(commit=False)
                for image in images:
                    image.package = self.object
                    image.save()

                # Supprimer les images marquées pour suppression
                for obj in image_formset.deleted_objects:
                    obj.delete()
            else:
                return self.form_invalid(form)

        messages.success(self.request, _("Votre colis a été mis à jour avec succès !"))
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('colis:package_detail', kwargs={'slug': self.object.slug})


class PackageDeleteView(LoginRequiredMixin, DeleteView):
    """Suppression d'un colis"""
    model = Package
    template_name = 'colis/package_delete.html'
    slug_field = 'slug'
    slug_url_kwarg = 'slug'
    success_url = reverse_lazy('colis:package_list')

    def dispatch(self, request, *args, **kwargs):
        package = self.get_object()
        if package.sender != request.user and not request.user.is_staff:
            messages.error(request, _("Vous n'êtes pas autorisé à supprimer ce colis."))
            return redirect('colis:package_detail', slug=package.slug)

        # Empêcher la suppression si le colis est réservé ou en transit
        if package.status in [Package.Status.RESERVED, Package.Status.IN_TRANSIT]:
            messages.error(request, _("Ce colis ne peut pas être supprimé car il est réservé ou en transit."))
            return redirect('colis:package_detail', slug=package.slug)

        return super().dispatch(request, *args, **kwargs)

    def delete(self, request, *args, **kwargs):
        messages.success(request, _("Le colis a été supprimé avec succès."))
        return super().delete(request, *args, **kwargs)


class MyPackagesListView(LoginRequiredMixin, ListView):
    """Liste des colis de l'utilisateur"""
    model = Package
    template_name = 'colis/my_packages.html'
    context_object_name = 'packages'
    paginate_by = 10

    def get_queryset(self):
        queryset = Package.objects.filter(
            sender=self.request.user
        ).select_related('category').prefetch_related('images').order_by('-created_at')

        # Appliquer les filtres
        form = PackageFilterForm(self.request.GET)
        if form.is_valid():
            status = form.cleaned_data.get('status')
            date_from = form.cleaned_data.get('date_from')
            date_to = form.cleaned_data.get('date_to')

            if status:
                queryset = queryset.filter(status=status)
            if date_from:
                queryset = queryset.filter(created_at__date__gte=date_from)
            if date_to:
                queryset = queryset.filter(created_at__date__lte=date_to)

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['filter_form'] = PackageFilterForm(self.request.GET)

        # Statistiques
        stats = Package.objects.filter(sender=self.request.user).aggregate(
            total=Count('id'),
            available=Count('id', filter=Q(status=Package.Status.AVAILABLE)),
            reserved=Count('id', filter=Q(status=Package.Status.RESERVED)),
            in_transit=Count('id', filter=Q(status=Package.Status.IN_TRANSIT)),
            delivered=Count('id', filter=Q(status=Package.Status.DELIVERED)),
            cancelled=Count('id', filter=Q(status=Package.Status.CANCELLED)),
            total_views=Sum('view_count'),
            total_offers=Sum('offer_count'),
            total_favorites=Sum('favorite_count'),
        )

        context.update(stats)
        return context


@login_required
@require_POST
def toggle_package_favorite(request, slug):
    """Ajouter/retirer un colis des favoris"""
    package = get_object_or_404(Package, slug=slug)

    favorite, created = PackageFavorite.objects.get_or_create(
        user=request.user,
        package=package
    )

    if not created:
        favorite.delete()
        action = 'retiré'
    else:
        action = 'ajouté'

    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        return JsonResponse({
            'status': 'success',
            'action': 'added' if created else 'removed',
            'favorite_count': package.favorite_count
        })

    messages.success(request, _(f"Colis {action} aux favoris."))
    return redirect('colis:package_detail', slug=slug)


class PackageFavoritesListView(LoginRequiredMixin, ListView):
    """Liste des colis favoris de l'utilisateur"""
    model = PackageFavorite
    template_name = 'colis/favorite_list.html'
    context_object_name = 'favorites'

    def get_queryset(self):
        return PackageFavorite.objects.filter(
            user=self.request.user
        ).select_related('package', 'package__sender', 'package__category').prefetch_related('package__images')


# ============================================================================
# OFFRES DE TRANSPORT
# ============================================================================

class TransportOfferCreateView(LoginRequiredMixin, CreateView):
    """Créer une offre de transport pour un colis"""
    model = TransportOffer
    form_class = TransportOfferForm
    template_name = 'colis/transport_offer_create.html'

    def dispatch(self, request, *args, **kwargs):
        self.package = get_object_or_404(Package, slug=kwargs['slug'])

        # Vérifications
        if not self.can_make_offer(request.user):
            messages.error(request, _("Vous ne pouvez pas faire d'offre pour ce colis."))
            return redirect('colis:package_detail', slug=self.package.slug)

        return super().dispatch(request, *args, **kwargs)

    def can_make_offer(self, user):
        """Vérifie si l'utilisateur peut faire une offre"""
        # L'expéditeur ne peut pas faire d'offre sur son propre colis
        if user == self.package.sender:
            return False

        # Vérifier si l'utilisateur est un transporteur approuvé
        try:
            carrier_profile = user.carrier_profile
            if carrier_profile.status != Carrier.Status.APPROVED:
                return False
            if not carrier_profile.is_available:
                return False
        except Carrier.DoesNotExist:
            return False

        # Vérifier si le colis est disponible
        if self.package.status != Package.Status.AVAILABLE:
            return False

        # Vérifier si une offre existe déjà
        if self.package.transport_offers.filter(carrier=carrier_profile).exists():
            return False

        return True

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['package'] = self.package
        kwargs['carrier'] = self.request.user.carrier_profile
        return kwargs

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['package'] = self.package

        # Calculer une estimation de prix
        estimated_price = self.calculate_estimated_price()
        context['estimated_price'] = estimated_price

        return context

    def calculate_estimated_price(self):
        """Calcule une estimation de prix basée sur la distance et le volume"""
        # Logique simplifiée - à améliorer avec un service de calcul réel
        if self.package.estimated_distance and self.package.volume:
            base_price_per_km = 0.5  # € par km
            base_price_per_volume = 10  # € par m³

            estimated_price = (
                self.package.estimated_distance * base_price_per_km +
                float(self.package.volume) / 1000 * base_price_per_volume
            )

            # Ajustements
            if self.package.is_fragile:
                estimated_price *= 1.2
            if self.package.requires_insurance:
                estimated_price *= 1.1
            if self.package.requires_packaging:
                estimated_price *= 1.15

            return round(estimated_price, 2)
        return None

    def form_valid(self, form):
        with transaction.atomic():
            self.object = form.save()

            # Créer une conversation entre l'expéditeur et le transporteur
            try:
                conversation = Conversation.objects.get_or_create_conversation(
                    self.package.sender,
                    self.request.user,
                    f"Offre pour colis: {self.package.title}"
                )

                # Ajouter un message initial
                Message.objects.create(
                    conversation=conversation,
                    sender=self.request.user,
                    content=_("Bonjour, je vous propose de transporter votre colis pour {price}€. {message}").format(
                        price=self.object.price,
                        message=self.object.message or ""
                    )
                )
            except Exception as e:
                # Ne pas bloquer l'offre si la conversation échoue
                pass

            # Notifier l'expéditeur (à implémenter avec Celery)
            # send_new_offer_notification.delay(self.object.id)

        messages.success(
            self.request,
            _("Votre offre a été envoyée avec succès ! L'expéditeur a été notifié.")
        )
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('colis:package_detail', kwargs={'slug': self.package.slug})


class MyTransportOffersListView(LoginRequiredMixin, ListView):
    """Liste des offres de transport de l'utilisateur"""
    model = TransportOffer
    template_name = 'colis/my_transport_offers.html'
    context_object_name = 'offers'
    paginate_by = 10

    def get_queryset(self):
        # Si l'utilisateur est un transporteur, voir ses offres
        if hasattr(self.request.user, 'carrier_profile'):
            return TransportOffer.objects.filter(
                carrier=self.request.user.carrier_profile
            ).select_related('package', 'package__sender').order_by('-created_at')

        # Si l'utilisateur est un expéditeur, voir les offres reçues
        return TransportOffer.objects.filter(
            package__sender=self.request.user
        ).select_related('package', 'carrier', 'carrier__user').order_by('-created_at')


@login_required
@require_POST
def accept_transport_offer(request, pk):
    """Accepter une offre de transport"""
    offer = get_object_or_404(TransportOffer, pk=pk)

    # Vérifier les permissions
    if offer.package.sender != request.user:
        raise PermissionDenied(_("Vous n'êtes pas autorisé à accepter cette offre."))

    # Vérifier que l'offre peut être acceptée
    if not offer.can_be_accepted():
        messages.error(request, _("Cette offre ne peut pas être acceptée."))
        return redirect('colis:my_transport_offers')

    with transaction.atomic():
        # Accepter l'offre
        offer.status = TransportOffer.Status.ACCEPTED
        offer.accepted_at = timezone.now()
        offer.save()

        # Mettre à jour le statut du colis
        offer.package.status = Package.Status.RESERVED
        offer.package.reserved_at = timezone.now()
        offer.package.save()

        # Rejeter automatiquement les autres offres en attente
        TransportOffer.objects.filter(
            package=offer.package,
            status=TransportOffer.Status.PENDING
        ).exclude(pk=offer.pk).update(
            status=TransportOffer.Status.REJECTED,
            rejection_reason=_("Une autre offre a été acceptée")
        )

        # Notifier le transporteur (à implémenter avec Celery)
        # send_offer_accepted_notification.delay(offer.id)

        # Mettre à jour la conversation
        try:
            conversation = Conversation.objects.get_or_create_conversation(
                offer.package.sender,
                offer.carrier.user,
                f"Colis accepté: {offer.package.title}"
            )

            Message.objects.create(
                conversation=conversation,
                sender=request.user,
                content=_("Bonjour, j'ai accepté votre offre de {price}€. Merci ! Nous pouvons maintenant organiser les détails du transport.").format(
                    price=offer.price
                )
            )
        except Exception as e:
            pass

    messages.success(request, _("L'offre a été acceptée avec succès !"))
    return redirect('colis:my_transport_offers')


@login_required
@require_POST
def reject_transport_offer(request, pk):
    """Rejeter une offre de transport"""
    offer = get_object_or_404(TransportOffer, pk=pk)

    # Vérifier les permissions
    if offer.package.sender != request.user:
        raise PermissionDenied(_("Vous n'êtes pas autorisé à rejeter cette offre."))

    if offer.status != TransportOffer.Status.PENDING:
        messages.error(request, _("Cette offre ne peut pas être rejetée."))
        return redirect('colis:my_transport_offers')

    reason = request.POST.get('reason', '')

    with transaction.atomic():
        offer.status = TransportOffer.Status.REJECTED
        offer.rejection_reason = reason
        offer.save()

        # Notifier le transporteur
        # send_offer_rejected_notification.delay(offer.id, reason)

        # Mettre à jour la conversation
        try:
            conversation = Conversation.objects.get_or_create_conversation(
                offer.package.sender,
                offer.carrier.user,
                f"Colis: {offer.package.title}"
            )

            Message.objects.create(
                conversation=conversation,
                sender=request.user,
                content=_("Bonjour, je regrette mais je ne peux pas accepter votre offre. {reason}").format(
                    reason=f"Raison: {reason}" if reason else ""
                )
            )
        except Exception as e:
            pass

    messages.success(request, _("L'offre a été rejetée."))
    return redirect('colis:my_transport_offers')


@login_required
@require_POST
def cancel_transport_offer(request, pk):
    """Annuler une offre de transport (transporteur)"""
    offer = get_object_or_404(TransportOffer, pk=pk)

    # Vérifier les permissions
    if offer.carrier.user != request.user:
        raise PermissionDenied(_("Vous n'êtes pas autorisé à annuler cette offre."))

    if offer.status != TransportOffer.Status.PENDING:
        messages.error(request, _("Cette offre ne peut pas être annulée."))
        return redirect('colis:my_transport_offers')

    with transaction.atomic():
        offer.status = TransportOffer.Status.CANCELLED
        offer.save()

        # Notifier l'expéditeur
        # send_offer_cancelled_notification.delay(offer.id)

        # Mettre à jour la conversation
        try:
            conversation = Conversation.objects.get_or_create_conversation(
                offer.package.sender,
                offer.carrier.user,
                f"Colis: {offer.package.title}"
            )

            Message.objects.create(
                conversation=conversation,
                sender=request.user,
                content=_("Je regrette mais je dois annuler mon offre pour votre colis.")
            )
        except Exception as e:
            pass

    messages.success(request, _("Votre offre a été annulée."))
    return redirect('colis:my_transport_offers')


# ============================================================================
# VUES POUR TRANSPORTEURS
# ============================================================================

class AvailablePackagesView(LoginRequiredMixin, ListView):
    """Colis disponibles pour les transporteurs"""
    model = Package
    template_name = 'colis/available_packages.html'
    context_object_name = 'packages'
    paginate_by = 20

    def dispatch(self, request, *args, **kwargs):
        # Vérifier que l'utilisateur est un transporteur approuvé
        if not hasattr(request.user, 'carrier_profile'):
            messages.error(request, _("Vous devez être transporteur pour voir les colis disponibles."))
            return redirect('carriers:apply')

        carrier = request.user.carrier_profile
        if carrier.status != Carrier.Status.APPROVED:
            messages.error(request, _("Votre compte transporteur n'est pas encore approuvé."))
            return redirect('carriers:carrier_detail', username=request.user.username)

        if not carrier.is_available:
            messages.warning(request, _("Vous êtes marqué comme indisponible. Activez votre disponibilité pour voir les colis."))

        return super().dispatch(request, *args, **kwargs)

    def get_queryset(self):
        # Filtrer les colis disponibles
        queryset = Package.objects.filter(
            status=Package.Status.AVAILABLE
        ).select_related('sender', 'category').prefetch_related('images')

        # Filtrer par capacités du transporteur
        carrier = self.request.user.carrier_profile
        queryset = queryset.filter(
            weight__lte=carrier.max_weight,
            volume__lte=carrier.max_volume * 1000  # Convertir m³ en L
        )

        # Exclure les colis pour lesquels le transporteur a déjà fait une offre
        offered_packages = TransportOffer.objects.filter(
            carrier=carrier,
            package__in=queryset
        ).values_list('package_id', flat=True)

        queryset = queryset.exclude(id__in=offered_packages)

        # Appliquer les filtres de recherche
        form = PackageSearchForm(self.request.GET)
        if form.is_valid():
            queryset = self.apply_search_filters(queryset, form.cleaned_data)

        return queryset

    def apply_search_filters(self, queryset, cleaned_data):
        """Applique les filtres de recherche"""
        if cleaned_data.get('q'):
            search_term = cleaned_data['q']
            queryset = queryset.filter(
                Q(title__icontains=search_term) |
                Q(description__icontains=search_term)
            )

        if cleaned_data.get('category'):
            category = cleaned_data['category']
            subcategories = category.get_descendants(include_self=True)
            queryset = queryset.filter(category__in=subcategories)

        if cleaned_data.get('pickup_country'):
            queryset = queryset.filter(pickup_country=cleaned_data['pickup_country'])

        if cleaned_data.get('delivery_country'):
            queryset = queryset.filter(delivery_country=cleaned_data['delivery_country'])

        if cleaned_data.get('pickup_city'):
            queryset = queryset.filter(pickup_city__icontains=cleaned_data['pickup_city'])

        if cleaned_data.get('delivery_city'):
            queryset = queryset.filter(delivery_city__icontains=cleaned_data['delivery_city'])

        if cleaned_data.get('pickup_date_from'):
            queryset = queryset.filter(pickup_date__gte=cleaned_data['pickup_date_from'])

        if cleaned_data.get('pickup_date_to'):
            queryset = queryset.filter(pickup_date__lte=cleaned_data['pickup_date_to'])

        if cleaned_data.get('max_weight'):
            queryset = queryset.filter(weight__lte=cleaned_data['max_weight'])

        if cleaned_data.get('max_volume'):
            queryset = queryset.filter(volume__lte=cleaned_data['max_volume'])

        if cleaned_data.get('min_price'):
            queryset = queryset.filter(asking_price__gte=cleaned_data['min_price'])

        if cleaned_data.get('max_price'):
            queryset = queryset.filter(asking_price__lte=cleaned_data['max_price'])

        if cleaned_data.get('flexible_dates'):
            queryset = queryset.filter(flexible_dates=True)

        # Tri
        sort_by = cleaned_data.get('sort_by', '-created_at')
        if sort_by in ['pickup_date', '-pickup_date', 'asking_price', '-asking_price', '-created_at']:
            queryset = queryset.order_by(sort_by)

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['search_form'] = PackageSearchForm(self.request.GET)
        context['total_packages'] = self.get_queryset().count()

        # Statistiques du transporteur
        carrier = self.request.user.carrier_profile
        context['carrier_stats'] = {
            'max_weight': carrier.max_weight,
            'max_volume': carrier.max_volume,
            'completed_missions': carrier.completed_missions,
            'average_rating': carrier.average_rating,
        }

        return context


class CarrierDashboardView(LoginRequiredMixin, TemplateView):
    """Tableau de bord du transporteur"""
    template_name = 'colis/carrier_dashboard.html'

    def dispatch(self, request, *args, **kwargs):
        # Vérifier que l'utilisateur est un transporteur
        if not hasattr(request.user, 'carrier_profile'):
            messages.error(request, _("Vous devez être transporteur pour accéder au tableau de bord."))
            return redirect('carriers:apply')

        return super().dispatch(request, *args, **kwargs)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        carrier = self.request.user.carrier_profile

        # Statistiques
        offers = TransportOffer.objects.filter(carrier=carrier)

        stats = {
            'total_offers': offers.count(),
            'pending_offers': offers.filter(status=TransportOffer.Status.PENDING).count(),
            'accepted_offers': offers.filter(status=TransportOffer.Status.ACCEPTED).count(),
            'rejected_offers': offers.filter(status=TransportOffer.Status.REJECTED).count(),
            'total_earnings': offers.filter(status=TransportOffer.Status.ACCEPTED).aggregate(
                total=Sum('price')
            )['total'] or 0,
        }

        # Offres récentes
        recent_offers = offers.select_related('package', 'package__sender').order_by('-created_at')[:5]

        # Colis en transit
        packages_in_transit = Package.objects.filter(
            transport_offers__carrier=carrier,
            transport_offers__status=TransportOffer.Status.ACCEPTED,
            status=Package.Status.IN_TRANSIT
        ).select_related('sender')[:5]

        context.update({
            'carrier': carrier,
            'stats': stats,
            'recent_offers': recent_offers,
            'packages_in_transit': packages_in_transit,
        })

        return context


# ============================================================================
# SIGNALEMENT ET MODÉRATION
# ============================================================================

class PackageReportView(LoginRequiredMixin, CreateView):
    """Signaler un colis"""
    model = PackageReport
    form_class = PackageReportForm
    template_name = 'colis/package_report.html'

    def dispatch(self, request, *args, **kwargs):
        self.package = get_object_or_404(Package, slug=kwargs['slug'])

        # Empêcher l'utilisateur de signaler son propre colis
        if request.user == self.package.sender:
            messages.error(request, _("Vous ne pouvez pas signaler votre propre colis."))
            return redirect('colis:package_detail', slug=self.package.slug)

        # Vérifier si l'utilisateur a déjà signalé ce colis
        if PackageReport.objects.filter(package=self.package, reporter=request.user).exists():
            messages.warning(request, _("Vous avez déjà signalé ce colis."))
            return redirect('colis:package_detail', slug=self.package.slug)

        return super().dispatch(request, *args, **kwargs)

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['package'] = self.package
        return context

    def form_valid(self, form):
        form.instance.package = self.package
        form.instance.reporter = self.request.user

        messages.success(
            self.request,
            _("Votre signalement a été soumis. Nous l'examinerons sous 24 heures.")
        )
        return super().form_valid(form)

    def get_success_url(self):
        return reverse_lazy('colis:package_detail', kwargs={'slug': self.package.slug})


# ============================================================================
# RECHERCHE ET FONCTIONNALITÉS
# ============================================================================

def search_packages(request):
    """Recherche avancée de colis"""
    form = PackageSearchForm(request.GET)
    packages = Package.objects.filter(status=Package.Status.AVAILABLE)

    if form.is_valid():
        packages = apply_search_filters(packages, form.cleaned_data)

    # Pagination
    paginator = Paginator(packages, 20)
    page = request.GET.get('page')
    packages_page = paginator.get_page(page)

    context = {
        'packages': packages_page,
        'search_form': form,
        'total_packages': packages.count(),
    }

    return render(request, 'colis/search_results.html', context)


def apply_search_filters(queryset, cleaned_data):
    """Applique les filtres de recherche"""
    if cleaned_data.get('q'):
        search_term = cleaned_data['q']
        queryset = queryset.filter(
            Q(title__icontains=search_term) |
            Q(description__icontains=search_term)
        )

    if cleaned_data.get('category'):
        category = cleaned_data['category']
        subcategories = category.get_descendants(include_self=True)
        queryset = queryset.filter(category__in=subcategories)

    if cleaned_data.get('package_type'):
        queryset = queryset.filter(package_type=cleaned_data['package_type'])

    if cleaned_data.get('pickup_country'):
        queryset = queryset.filter(pickup_country=cleaned_data['pickup_country'])

    if cleaned_data.get('delivery_country'):
        queryset = queryset.filter(delivery_country=cleaned_data['delivery_country'])

    if cleaned_data.get('pickup_city'):
        queryset = queryset.filter(pickup_city__icontains=cleaned_data['pickup_city'])

    if cleaned_data.get('delivery_city'):
        queryset = queryset.filter(delivery_city__icontains=cleaned_data['delivery_city'])

    if cleaned_data.get('pickup_date_from'):
        queryset = queryset.filter(pickup_date__gte=cleaned_data['pickup_date_from'])

    if cleaned_data.get('pickup_date_to'):
        queryset = queryset.filter(pickup_date__lte=cleaned_data['pickup_date_to'])

    if cleaned_data.get('max_weight'):
        queryset = queryset.filter(weight__lte=cleaned_data['max_weight'])

    if cleaned_data.get('max_volume'):
        queryset = queryset.filter(volume__lte=cleaned_data['max_volume'])

    if cleaned_data.get('min_price'):
        queryset = queryset.filter(asking_price__gte=cleaned_data['min_price'])

    if cleaned_data.get('max_price'):
        queryset = queryset.filter(asking_price__lte=cleaned_data['max_price'])

    if cleaned_data.get('flexible_dates'):
        queryset = queryset.filter(flexible_dates=True)

    # Tri
    sort_by = cleaned_data.get('sort_by', '-created_at')
    if sort_by in ['pickup_date', '-pickup_date', 'asking_price', '-asking_price', '-created_at', '-view_count']:
        queryset = queryset.order_by(sort_by)

    return queryset


@login_required
@require_GET
def quick_quote(request):
    """Devis rapide pour transporteurs"""
    form = QuickQuoteForm(request.GET)

    if form.is_valid():
        # Calcul simplifié du prix
        # À remplacer par un service de calcul réel
        weight = form.cleaned_data['weight']
        length = form.cleaned_data.get('length', 0)
        width = form.cleaned_data.get('width', 0)
        height = form.cleaned_data.get('height', 0)

        # Calcul de base
        base_price = float(weight) * 0.5  # 0.5€ par kg

        if length and width and height:
            volume = (float(length) * float(width) * float(height)) / 1000000  # m³
            base_price += volume * 10  # 10€ par m³

        # Majorations
        if form.cleaned_data.get('is_fragile'):
            base_price *= 1.2

        if form.cleaned_data.get('requires_insurance'):
            base_price *= 1.1

        estimated_price = round(base_price, 2)

        return JsonResponse({
            'success': True,
            'estimated_price': estimated_price,
            'currency': 'EUR',
            'message': _("Prix estimé basé sur les informations fournies.")
        })

    return JsonResponse({
        'success': False,
        'errors': form.errors
    })


# ============================================================================
# FONCTIONS AJAX ET API
# ============================================================================

@login_required
@require_POST
def update_package_status(request, slug, status):
    """Changer le statut d'un colis (AJAX)"""
    package = get_object_or_404(Package, slug=slug, sender=request.user)

    if status not in dict(Package.Status.choices):
        return JsonResponse({'success': False, 'error': _("Statut invalide.")})

    # Vérifier les transitions autorisées
    allowed_transitions = {
        Package.Status.AVAILABLE: [Package.Status.CANCELLED],
        Package.Status.RESERVED: [Package.Status.IN_TRANSIT, Package.Status.CANCELLED],
        Package.Status.IN_TRANSIT: [Package.Status.DELIVERED, Package.Status.CANCELLED],
    }

    if package.status in allowed_transitions and status not in allowed_transitions[package.status]:
        return JsonResponse({
            'success': False,
            'error': _("Transition de statut non autorisée.")
        })

    previous_status = package.status
    package.status = status

    # Mettre à jour les dates de statut
    if status == Package.Status.IN_TRANSIT:
        package.in_transit_at = timezone.now()
    elif status == Package.Status.DELIVERED:
        package.delivered_at = timezone.now()

    package.save()

    # Notifier les parties concernées
    # send_package_status_update.delay(package.id, previous_status, status)

    return JsonResponse({
        'success': True,
        'new_status': status,
        'new_status_display': package.get_status_display(),
        'message': _("Statut mis à jour avec succès.")
    })


@login_required
@require_GET
def package_stats(request, slug):
    """Récupérer les statistiques d'un colis (AJAX)"""
    package = get_object_or_404(Package, slug=slug)

    # Vérifier les permissions
    if package.sender != request.user and not request.user.is_staff:
        return JsonResponse({'success': False, 'error': _("Accès non autorisé.")})

    stats = {
        'view_count': package.view_count,
        'offer_count': package.offer_count,
        'favorite_count': package.favorite_count,
        'created_at': package.created_at.isoformat(),
        'published_at': package.published_at.isoformat() if package.published_at else None,
        'status': package.status,
        'status_display': package.get_status_display(),
    }

    return JsonResponse({'success': True, 'stats': stats})


# ============================================================================
# VUES DE GESTION ET ADMIN
# ============================================================================

@login_required
def package_management(request, slug):
    """Gestion complète d'un colis (pour l'expéditeur)"""
    package = get_object_or_404(Package, slug=slug)

    # Vérifier les permissions
    if package.sender != request.user and not request.user.is_staff:
        messages.error(request, _("Accès non autorisé."))
        return redirect('colis:package_detail', slug=slug)

    # Récupérer toutes les offres
    offers = package.transport_offers.all().select_related('carrier', 'carrier__user')

    # Récupérer les conversations liées
    conversations = []
    if hasattr(request, 'messaging'):
        # À adapter selon votre app messaging
        pass

    context = {
        'package': package,
        'offers': offers,
        'conversations': conversations,
        'can_edit': package.status in [Package.Status.AVAILABLE, Package.Status.DRAFT],
        'can_delete': package.status in [Package.Status.AVAILABLE, Package.Status.DRAFT, Package.Status.CANCELLED],
    }

    return render(request, 'colis/package_management.html', context)


class PackageStatisticsView(LoginRequiredMixin, TemplateView):
    """Statistiques des colis de l'utilisateur"""
    template_name = 'colis/package_statistics.html'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        user = self.request.user

        # Statistiques générales
        packages = Package.objects.filter(sender=user)

        stats = packages.aggregate(
            total=Count('id'),
            total_views=Sum('view_count'),
            total_offers=Sum('offer_count'),
            total_favorites=Sum('favorite_count'),
            avg_price=Avg('asking_price'),
            total_value=Sum('asking_price'),
        )

        # Statistiques par statut
        status_stats = []
        for status_code, status_name in Package.Status.choices:
            count = packages.filter(status=status_code).count()
            if count > 0:
                status_stats.append({
                    'status': status_code,
                    'status_display': status_name,
                    'count': count,
                    'percentage': round((count / stats['total']) * 100, 1) if stats['total'] > 0 else 0
                })

        # Évolution mensuelle
        monthly_stats = packages.extra(
            select={'month': "strftime('%%Y-%%m', created_at)"}
        ).values('month').annotate(
            count=Count('id'),
            total_views=Sum('view_count'),
            total_offers=Sum('offer_count'),
        ).order_by('month')

        context.update({
            'stats': stats,
            'status_stats': status_stats,
            'monthly_stats': monthly_stats,
        })

        return context


class NewsSitemapView(TemplateView):
    """
    Vue pour générer un sitemap spécifique Google News
    """
    template_name = 'colis/sitemap_news.xml'
    content_type = 'application/xml'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)

        # Articles publiés dans les dernières 48h
        two_days_ago = timezone.now() - timedelta(days=2)

        news_packages = Package.objects.filter(
            created_at__gte=two_days_ago,
            status='AVAILABLE',
            is_archived=False
        ).order_by('-created_at')[:1000]

        context['news_packages'] = news_packages
        context['publication_date'] = datetime.now().strftime('%Y-%m-%d')
        context['site_name'] = 'Ebi3 Colis'

        return context


def robots_txt(request):
    """
    Vue pour servir le fichier robots.txt
    """
    lines = [
        "User-agent: *",
        "Allow: /",
        "",
        "# Sitemaps",
        f"Sitemap: https://{request.get_host()}/colis/sitemap.xml",
        f"Sitemap: https://{request.get_host()}/colis/sitemap_index.xml",
        f"Sitemap: https://{request.get_host()}/colis/news-sitemap.xml",
        "",
        "# Disallow certaines pages",
        "Disallow: /admin/",
        "Disallow: /dashboard/",
        "Disallow: /api/",
        "Disallow: /search/?q=*",
        "Disallow: /*/edit/",
        "Disallow: /*/delete/",
        "",
        "# Crawl-delay pour éviter de surcharger le serveur",
        "Crawl-delay: 2",
        "",
        "# User-agents spécifiques",
        "User-agent: GPTBot",
        "Disallow: /",
        "",
        "User-agent: ChatGPT-User",
        "Disallow: /",
        "",
        "# Host (facultatif mais recommandé)",
        f"Host: {request.get_host()}",
    ]

    return HttpResponse("\n".join(lines), content_type="text/plain")-e 

